{% extends "layouts/base.html" %}
{% load i18n %}
{% load security_tags %}

{% block title %}Add Product - Products - Eaglestar ERP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/global-wizard.css">
<link rel="stylesheet" href="/static/css/apple-table.css">
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:products:hub' %}"
                            class="text-info text-decoration-none" data-i18n="nav.products">Products</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="products.add_product">Add Product</li>
                </ol>
            </nav>
            <p class="text-white-50 small mb-0 mt-1" data-i18n="ui.text_157">创建新的产品档案并初始化库存记录。</p>
        </div>
        <div>
            <a href="{% url 'web_ui:products:hub' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="products.back_to_hub">返回Products</span>
            </a>
        </div>
    </div>

    <!-- Wizard Container -->
    <div class="glass-card p-4" id="add-product-wizard-container" data-testid="add-product-wizard">

        <!-- Wizard Header -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-plus-circle fa-2x text-primary"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="products.add_wizard_title">Add Product向导</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_158">请按步骤填写、验证并创建新产品。</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar Anchor -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

        <!-- ========================================== -->
        <!-- Step 1: 填写数据 -->
        <!-- ========================================== -->
        <div class="wizard-step-content active" id="step-edit" data-testid="step-edit">
            <!-- 操作说明卡片 -->
            <div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4" data-testid="ops-guide-card">
                <div class="card-header bg-info bg-opacity-10 border-0 d-flex align-items-center">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <span class="text-info fw-bold" data-i18n="common.operation_desc">操作说明</span>
                </div>
                <div class="card-body">
                    <ul class="text-white-50 small mb-0 ps-3">
                        <li class="mb-2" data-i18n="ui.text_160">SKU、Cost、Freight、Weight 为必填项。</li>
                        <li class="mb-2" data-i18n="ui.text_161">初始库存设为 0 时，需在验证步骤确认后才能提交。</li>
                        <li class="mb-2" data-i18n="ui.text_162">点击「添加一行」新增更多产品，支持批量添加。</li>
                        <li data-i18n="ui.text_163">完成填写后点击「验证数据」按钮进入下一步。</li>
                    </ul>
                </div>
            </div>

            <!-- 数据输入区域 -->
            <div id="create-form-container" data-testid="create-form-table">
                <div class="text-center py-5" id="form-loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-white-50 mt-3" data-i18n="common.loading">正在加载表单...</p>
                </div>
                <div id="form-wrapper" class="d-none"></div>
            </div>

            <div id="step1-error" class="text-danger small text-center mb-3"></div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <span class="text-white-50 small" id="row-count-label">
                        <i class="fas fa-list me-1"></i><span data-i18n="ui.icon_3063">待创建:</span><strong id="row-count">0</strong> 行
                    </span>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-primary rounded-pill px-4" id="btn-step1-next">
                        验证数据 <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 2: 验证数据 -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-validate" data-testid="step-validate">
            <!-- 验证结果区域 -->
            <div class="glass-card p-4 mb-4" id="validate-result-card"
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08);">

                <!-- 错误汇总 -->
                <div id="error-summary" class="d-none mb-4">
                    <div class="alert alert-danger bg-danger bg-opacity-10 border-danger">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <strong class="text-danger" data-i18n="modal.password.verify_failed">验证失败</strong>
                        </div>
                        <ul class="mb-0 small" id="error-list"></ul>
                    </div>
                </div>

                <!-- 初始库存为0确认 -->
                <div id="zero-qty-confirm" class="d-none mb-4">
                    <div class="alert alert-warning bg-warning bg-opacity-10 border-warning">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-exclamation-circle text-warning me-2"></i>
                            <strong class="text-warning" data-i18n="ui.text_165">需要确认</strong>
                        </div>
                        <p class="small mb-2" data-i18n="ui.text_166">以下产品的初始库存为 0，请确认是否继续：</p>
                        <ul class="mb-3 small" id="zero-qty-list"></ul>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirm-zero-qty">
                            <label class="form-check-label small text-white" for="confirm-zero-qty" data-i18n="ui.text_167">
                                我确认上述产品的初始库存为 0
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 无有效行提示 -->
                <div id="no-valid-rows-notice" class="d-none text-center py-5">
                    <i class="fas fa-inbox fa-3x text-secondary opacity-50 mb-3"></i>
                    <p class="text-white-50 mb-0" data-i18n="ui.text_168">未填写任何有效的产品数据。</p>
                </div>

                <!-- 待创建表格 -->
                <div id="preview-table-wrapper" class="d-none">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h6 class="text-white mb-0">
                            <i class="fas fa-plus-circle text-primary me-2"></i>
                            <span data-i18n="ui.products_to_create">待创建的产品（</span><span id="preview-row-count">0</span><span data-i18n="ui.count_suffix">个）</span>
                        </h6>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="apple-table" id="preview-table">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>SubCategory</th>
                                    <th>Type</th>
                                    <th>Cost</th>
                                    <th>Freight</th>
                                    <th>Weight</th>
                                    <th>Cog</th>
                                    <th class="text-end" data-i18n="ui.text_2041">初始库存</th>
                                </tr>
                            </thead>
                            <tbody id="preview-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Hidden security inputs -->
            <form id="sku-submit-form" class="d-none">
                {% csrf_token %}
                <input type="hidden" name="sku_data" id="sku-submit-data">
                {% security_inputs "btn_create_skus" %}
            </form>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step2-back">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-primary rounded-pill px-4" id="btn-step2-submit"
                        data-testid="primary-action-btn" data-requires-global-modal="true"
                        data-action-key="btn_create_skus" data-action-display="{% trans 'Create Products' %}" disabled>
                        <i class="fas fa-plus-circle me-2"></i><span data-i18n="ui.icon_3065">创建产品</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 3: 完成 -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-done" data-testid="step-done">
            <div class="glass-card p-4" id="result-panel" data-testid="result-panel">
                <div id="execute-loading" class="text-center py-5 d-none">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="text-white-50 mb-0" data-i18n="common.loading">正在创建产品...</p>
                    <p class="text-muted small" data-i18n="ui.text_169">请勿关闭页面</p>
                </div>

                <!-- 成功结果 -->
                <div id="success-result" class="d-none">
                    <div class="wizard-done-header">
                        <div class="icon"><i class="fas fa-check-circle text-success"></i></div>
                        <h3 data-i18n="ui.text_170">创建成功</h3>
                        <p data-i18n="ui.text_171">产品档案已创建，库存记录已初始化。</p>
                    </div>

                    <div class="wizard-done-summary">
                        <div class="wizard-done-summary-header">
                            <i class="fas fa-chart-bar me-2"></i><span data-i18n="ui.icon_3066">创建统计</span>
                        </div>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="fs-3 fw-bold text-success" id="result-total-rows">0</div>
                                <div class="text-white-50 small">Add Product</div>
                            </div>
                            <div class="col-6">
                                <div class="fs-3 fw-bold text-info" id="result-total-qty">0</div>
                                <div class="text-white-50 small" data-i18n="ui.text_2042">库存合计</div>
                            </div>
                            <!-- 已移除：完成时间区块 -->
                        </div>
                    </div>

                    <div class="wizard-done-details">
                        <div class="wizard-done-details-header">
                            <i class="fas fa-list-ul me-2"></i><span data-i18n="ui.icon_3067">创建明细</span>
                        </div>
                        <div id="create-details-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- 失败结果 -->
                <div id="error-result" class="d-none">
                    <div class="wizard-done-header">
                        <div class="icon"><i class="fas fa-times-circle text-danger"></i></div>
                        <h3 data-i18n="toast.create_failed">创建失败</h3>
                        <p id="error-result-message" data-i18n="ui.text_173">请查看错误信息并重试。</p>
                    </div>
                </div>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-new-round">
                        <i class="fas fa-plus me-2"></i><span data-i18n="ui.icon_3068">继续添加</span>
                    </button>
                    <a href="{% url 'web_ui:products:hub' %}" class="btn btn-primary rounded-pill px-4">
                        <i class="fas fa-home me-2"></i><span data-i18n="ui.icon_3069">返回Products</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ============================================================
        // State Management
        // ============================================================
        let validRows = [];           // 有效行数据
        let validationErrors = [];    // 校验错误
        let zeroQtySkus = [];         // 初始库存为0的SKU
        let zeroQtyConfirmed = false; // 是否已确认初始库存为0

        // ============================================================
        // Initialize Wizard
        // ============================================================
        const wizard = new GlobalWizard({
            containerId: 'add-product-wizard-container',
            steps: [
                { id: 'edit', label: (window.i18n?.t('js.fill_data') || 'Fill Data'), contentSelector: '#step-edit' },
                { id: 'validate', label: (window.i18n?.t('js.validate_data') || 'Validate'), contentSelector: '#step-validate' },
                { id: 'done', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#step-done' }
            ],
            onStepChange: function (from, to) {
                console.log('[AddProductWizard] Step changed:', from, '->', to);
                if (to === 1) {
                    renderValidationStep();
                }
            },
            onBeforeNext: async function (currentStep) {
                if (currentStep.id === 'edit') {
                    return validateStep1();
                }
                if (currentStep.id === 'validate') {
                    if (validationErrors.length > 0) {
                        createAndShowToast(i18n.t('toast.fix_validation_errors'), 'warning');
                        return false;
                    }
                    if (validRows.length === 0) {
                        createAndShowToast(i18n.t('toast.no_valid_data'), 'warning');
                        return false;
                    }
                    if (zeroQtySkus.length > 0 && !zeroQtyConfirmed) {
                        createAndShowToast(i18n.t('toast.confirm_zero_stock'), 'warning');
                        return false;
                    }
                    return await triggerAuthAndSubmit();
                }
                return true;
            },
            onRestart: function () {
                location.reload();
            }
        });

        // ============================================================
        // 全局函数定义（供 onclick 调用）
        // ============================================================
        let rowCounter = 0;

        window.addSkuRow = function () {
            const tbody = document.getElementById('sku-rows');
            if (!tbody) {
                console.error('[addSkuRow] tbody#sku-rows not found');
                return;
            }

            const data = window._createFormData || { categories: [], subcategories: [], types: [] };
            const catOptions = '<option value="" selected data-i18n="option.o9454">-- 不选择 --</option>' + data.categories.map(c => '<option value="' + c + '">' + c + '</option>').join('');
            const subOptions = '<option value="" selected data-i18n="option.o9454">-- 不选择 --</option>' + data.subcategories.map(s => '<option value="' + s + '">' + s + '</option>').join('');
            const typeOptions = '<option value="" selected data-i18n="option.o9454">-- 不选择 --</option>' + data.types.map(t => '<option value="' + t + '">' + t + '</option>').join('');

            const beforeCount = tbody.querySelectorAll('tr').length;

            const tr = document.createElement('tr');
            tr.setAttribute('data-row-id', rowCounter++);

            tr.innerHTML =
                '<td><input type="text" class="form-control form-control-sm bg-dark text-warning border-secondary sku-input" name="sku" data-i18n-placeholder="form.placeholder.enter_sku" placeholder="输入SKU" oninput="this.value=this.value.toUpperCase().trim()" onblur="this.value=this.value.toUpperCase().trim()"></td>' +
                '<td><select class="form-select form-select-sm bg-dark text-white border-secondary" name="category">' + catOptions + '</select></td>' +
                '<td><select class="form-select form-select-sm bg-dark text-white border-secondary" name="subcategory">' + subOptions + '</select></td>' +
                '<td><select class="form-select form-select-sm bg-dark text-white border-secondary" name="type">' + typeOptions + '</select></td>' +
                '<td><input type="number" step="0.01" min="0.01" class="form-control form-control-sm bg-dark text-info border-secondary cost-input" name="cost" placeholder="0.00"></td>' +
                '<td><input type="number" step="0.01" min="0.01" class="form-control form-control-sm bg-dark text-info border-secondary freight-input" name="freight" placeholder="0.00"></td>' +
                '<td><input type="number" step="1" min="0" class="form-control form-control-sm bg-dark text-warning border-secondary weight-input" name="weight" value="0"></td>' +
                '<td class="cog-value text-success fw-bold">0.00</td>' +
                '<td><input type="number" step="1" min="0" class="form-control form-control-sm bg-dark text-primary border-secondary qty-input" name="initial_qty" value="0"></td>' +
                '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove(); updateRowCount();"><i class="fas fa-times"></i></button></td>';

            tbody.appendChild(tr);

            // 绑定 Cog 自动计算
            tr.querySelector('.cost-input').addEventListener('input', function () {
                const cost = parseFloat(tr.querySelector('.cost-input').value) || 0;
                const freight = parseFloat(tr.querySelector('.freight-input').value) || 0;
                tr.querySelector('.cog-value').textContent = (cost + freight).toFixed(2);
            });
            tr.querySelector('.freight-input').addEventListener('input', function () {
                const cost = parseFloat(tr.querySelector('.cost-input').value) || 0;
                const freight = parseFloat(tr.querySelector('.freight-input').value) || 0;
                tr.querySelector('.cog-value').textContent = (cost + freight).toFixed(2);
            });

            const afterCount = tbody.querySelectorAll('tr').length;
            console.log('[addSkuRow] called, rows:', beforeCount, '->', afterCount);
            updateRowCount();
        };

        window.addMultipleRows = function () {
            console.log('[addMultipleRows] adding 5 rows');
            for (let i = 0; i < 5; i++) {
                window.addSkuRow();
            }
        };

        window.updateRowCount = function () {
            const count = document.querySelectorAll('#sku-rows tr').length;
            document.getElementById('row-count').textContent = count;
        };

        // ============================================================
        // Load Form
        // ============================================================
        loadCreateForm();

        function loadCreateForm() {
            fetch('{% url "web_ui:db_admin:cogs_get_form_only" %}')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('form-loading').classList.add('d-none');
                    const wrapper = document.getElementById('form-wrapper');
                    wrapper.innerHTML = html;
                    wrapper.classList.remove('d-none');

                    // 执行 partial 内嵌的 script（设置 _createFormData）
                    const scripts = wrapper.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.body.appendChild(newScript);
                        document.body.removeChild(newScript);
                    });

                    // 初始化 existingSkusSet（强制全大写，确保 SKU 校验大小写不敏感）
                    const existingSkus = window._createFormData?.existingSkus || [];
                    window.existingSkusSet = new Set(existingSkus.map(x => String(x).trim().toUpperCase()));
                    console.log('[CreateFormOnly] existingSkusSet initialized, count:', window.existingSkusSet.size);

                    // 初始化：添加第一行
                    console.log('[CreateFormOnly] init, adding first row');
                    window.addSkuRow();
                })
                .catch(error => {
                    console.error('Load error:', error);
                    const loadingEl = document.getElementById('form-loading');
                    loadingEl.textContent = '';
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.textContent = (window.i18n?.t('js.load_failed_retry') || 'Load failed, please refresh');
                    loadingEl.appendChild(alertDiv);
                });
        }

        // ============================================================
        // Step 1 Validation
        // ============================================================
        function validateStep1() {
            const errorEl = document.getElementById('step1-error');
            errorEl.textContent = '';

            const rows = collectFormData();
            if (rows.length === 0) {
                errorEl.textContent = (window.i18n?.t('js.fill_at_least_one_product') || 'Please fill at least one product');
                return false;
            }
            return true;
        }

        function collectFormData() {
            const rows = [];
            const tableRows = document.querySelectorAll('#sku-rows tr');

            tableRows.forEach(tr => {
                const rawSku = tr.querySelector('.sku-input')?.value?.trim() || '';
                const sku = rawSku.toUpperCase(); // 强制转大写
                if (!sku) return; // 跳过空行

                rows.push({
                    SKU: sku,
                    Category: tr.querySelector('select[name=category]')?.value || '',
                    SubCategory: tr.querySelector('select[name=subcategory]')?.value || '',
                    Type: tr.querySelector('select[name=type]')?.value || '',
                    Cost: parseFloat(tr.querySelector('.cost-input')?.value) || 0,
                    Freight: parseFloat(tr.querySelector('.freight-input')?.value) || 0,
                    Weight: parseInt(tr.querySelector('.weight-input')?.value) || 0,
                    Initial_Qty: parseInt(tr.querySelector('.qty-input')?.value) || 0
                });
            });

            return rows;
        }

        // ============================================================
        // Step 2: Validation & Preview
        // ============================================================
        function renderValidationStep() {
            const totalTableRows = document.querySelectorAll("#sku-rows tr").length;
            validRows = collectFormData();
            console.log("[Validation] totalRows:", totalTableRows, "nonEmptyRows:", validRows.length);
            validationErrors = [];
            zeroQtySkus = [];
            zeroQtyConfirmed = false;

            // Reset UI
            document.getElementById('error-summary').classList.add('d-none');
            document.getElementById('zero-qty-confirm').classList.add('d-none');
            document.getElementById('no-valid-rows-notice').classList.add('d-none');
            document.getElementById('preview-table-wrapper').classList.add('d-none');
            document.getElementById('confirm-zero-qty').checked = false;

            if (validRows.length === 0) {
                document.getElementById('no-valid-rows-notice').classList.remove('d-none');
                document.getElementById('btn-step2-submit').disabled = true;
                return;
            }

            // Validate each row
            validRows.forEach((row, idx) => {
                validateRow(row, idx);
                if (row.Initial_Qty === 0) {
                    zeroQtySkus.push(row.SKU);
                }
            });

            // Render preview table
            renderPreviewTableSafe(validRows);

            // Show error summary
            if (validationErrors.length > 0) {
                renderErrorListSafe(validationErrors);
                document.getElementById('error-summary').classList.remove('d-none');
                document.getElementById('btn-step2-submit').disabled = true;
            } else {
                // Check zero qty confirmation
                if (zeroQtySkus.length > 0) {
                    renderZeroQtyListSafe(zeroQtySkus);
                    document.getElementById('zero-qty-confirm').classList.remove('d-none');
                    document.getElementById('btn-step2-submit').disabled = true;
                } else {
                    document.getElementById('btn-step2-submit').disabled = false;
                }
            }
        }

        function validateRow(row, idx) {
            // SKU: 非空
            if (!row.SKU) {
                validationErrors.push({ row: idx + 1, sku: row.SKU, field: 'SKU', message: (window.i18n?.t('js.cannot_be_empty') || 'Cannot be empty') });
            } else if (window.existingSkusSet && window.existingSkusSet.has(row.SKU)) {
                validationErrors.push({ row: idx + 1, sku: row.SKU, field: 'SKU', message: (window.i18n?.t('js.sku_exists') || 'SKU already exists in system') });
            }

            // Cost: 必须是正数（> 0）且为两位小数格式
            const costValidation = validatePositiveDecimal(row.Cost, 'Cost');
            if (costValidation) {
                validationErrors.push({ row: idx + 1, sku: row.SKU, field: 'Cost', message: costValidation });
            }

            // Freight: 必须是正数（> 0）且为两位小数格式
            const freightValidation = validatePositiveDecimal(row.Freight, 'Freight');
            if (freightValidation) {
                validationErrors.push({ row: idx + 1, sku: row.SKU, field: 'Freight', message: freightValidation });
            }

            // Weight: 0 或正整数（允许 0）
            if (!isNonNegativeInteger(row.Weight)) {
                validationErrors.push({ row: idx + 1, sku: row.SKU, field: 'Weight', message: (window.i18n?.t('js.must_be_zero_or_positive') || 'Must be 0 or positive integer') });
            }

            // Initial_Qty: 整数 >= 0
            if (!isNonNegativeInteger(row.Initial_Qty)) {
                validationErrors.push({ row: idx + 1, sku: row.SKU, field: (window.i18n?.t('js.initial_stock') || 'Initial Stock'), message: (window.i18n?.t('js.must_be_non_negative_int') || 'Must be non-negative integer') });
            }
        }

        // 验证正数且两位小数格式（不允许 0 或负数）
        function validatePositiveDecimal(val, fieldName) {
            if (val === '' || val === null || val === undefined) {
                return (window.i18n?.t('js.cannot_be_empty') || 'Cannot be empty');
            }
            const num = parseFloat(val);
            if (isNaN(num) || !isFinite(num)) {
                return (window.i18n?.t('js.must_be_valid_number') || 'Must be valid number');
            }
            if (num <= 0) {
                return (window.i18n?.t('js.must_be_positive_not_zero') || 'Must be > 0');
            }
            // 检查是否可以规范为两位小数
            const rounded = Math.round(num * 100) / 100;
            if (Math.abs(num - rounded) > 0.00001) {
                return (window.i18n?.t('js.max_2_decimals') || 'Max 2 decimals');
            }
            return null; // 验证通过
        }

        function isNonNegativeInteger(val) {
            if (val === '' || val === null || val === undefined) {
                return false;
            }
            const num = parseInt(val, 10);
            // 确保是整数（无小数部分）
            return !isNaN(num) && num >= 0 && num === parseFloat(val);
        }

        // ============================================================
        // Safe DOM Rendering
        // ============================================================
        function renderErrorListSafe(errors) {
            const errorList = document.getElementById('error-list');
            errorList.textContent = '';

            errors.forEach(e => {
                const li = document.createElement('li');
                const skuPart = e.sku ? ' [' + e.sku + ']' : '';
                li.appendChild(document.createTextNode((window.i18n?.t('js.row_prefix') || 'Row ') + e.row + (window.i18n?.t('js.row_suffix') || ' row') + skuPart + ' - ' + e.field + ': ' + e.message));
                errorList.appendChild(li);
            });
        }

        function renderZeroQtyListSafe(skus) {
            const list = document.getElementById('zero-qty-list');
            list.textContent = '';

            skus.forEach(sku => {
                const li = document.createElement('li');
                li.textContent = sku;
                list.appendChild(li);
            });
        }

        function renderPreviewTableSafe(rows) {
            const tbody = document.getElementById('preview-table-body');
            tbody.textContent = '';

            // 构建错误索引：rowIndex -> Set of fieldNames
            const errorMap = new Map();
            validationErrors.forEach(e => {
                if (!errorMap.has(e.row)) {
                    errorMap.set(e.row, new Set());
                }
                errorMap.get(e.row).add(e.field);
            });

            rows.forEach((row, idx) => {
                const rowNum = idx + 1;
                const tr = document.createElement('tr');
                const rowErrors = errorMap.get(rowNum);
                if (rowErrors) {
                    tr.classList.add('row-invalid');
                    tr.style.background = 'rgba(220, 53, 69, 0.12)';
                }

                const fields = ['SKU', 'Category', 'SubCategory', 'Type', 'Cost', 'Freight', 'Weight'];
                fields.forEach(field => {
                    const td = document.createElement('td');
                    // 格式化 Cost/Freight 为两位小数显示
                    if (field === 'Cost' || field === 'Freight') {
                        const numVal = parseFloat(row[field]);
                        td.textContent = isNaN(numVal) ? row[field] : numVal.toFixed(2);
                    } else {
                        td.textContent = row[field] === '' ? (window.i18n?.t('js.empty') || '(empty)') : row[field];
                    }
                    // 高亮错误单元格
                    if (rowErrors && rowErrors.has(field)) {
                        td.style.background = 'rgba(220, 53, 69, 0.25)';
                        td.style.border = '1px solid rgba(220, 53, 69, 0.6)';
                        td.style.borderRadius = '4px';
                        td.classList.add('text-danger', 'fw-bold');
                    }
                    tr.appendChild(td);
                });

                // Cog (auto-calculated)
                const cogTd = document.createElement('td');
                const costVal = parseFloat(row.Cost) || 0;
                const freightVal = parseFloat(row.Freight) || 0;
                cogTd.textContent = (costVal + freightVal).toFixed(2);
                tr.appendChild(cogTd);

                // Initial Qty
                const qtyTd = document.createElement('td');
                qtyTd.classList.add('text-end');
                if (row.Initial_Qty === 0) {
                    qtyTd.classList.add('text-warning');
                }
                // 高亮初始库存错误
                if (rowErrors && rowErrors.has((window.i18n?.t('js.initial_stock') || 'Initial Stock'))) {
                    qtyTd.style.background = 'rgba(220, 53, 69, 0.25)';
                    qtyTd.style.border = '1px solid rgba(220, 53, 69, 0.6)';
                    qtyTd.style.borderRadius = '4px';
                    qtyTd.classList.add('text-danger', 'fw-bold');
                }
                qtyTd.textContent = row.Initial_Qty;
                tr.appendChild(qtyTd);

                tbody.appendChild(tr);
            });

            document.getElementById('preview-row-count').textContent = rows.length;
            document.getElementById('preview-table-wrapper').classList.remove('d-none');
        }

        function renderSuccessResultSafe() {
            let totalQty = 0;
            validRows.forEach(row => {
                totalQty += row.Initial_Qty;
            });

            document.getElementById('result-total-rows').textContent = validRows.length;
            document.getElementById('result-total-qty').textContent = totalQty;
            // 已移除：完成时间显示

            const detailsList = document.getElementById('create-details-list');
            detailsList.textContent = '';

            validRows.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'mb-2 p-3 rounded';
                rowDiv.style.background = 'rgba(255,255,255,0.03)';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'fw-bold text-white mb-1';
                const icon = document.createElement('i');
                icon.className = 'fas fa-cube me-2 text-primary';
                titleDiv.appendChild(icon);
                titleDiv.appendChild(document.createTextNode(row.SKU));
                rowDiv.appendChild(titleDiv);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'small text-white-50';
                infoDiv.textContent = 'Cost: ' + row.Cost + ' | Freight: ' + row.Freight + ' | Weight: ' + row.Weight + (window.i18n?.t('js.initial_stock_prefix') || ' | Initial Stock: ') + row.Initial_Qty;
                rowDiv.appendChild(infoDiv);

                detailsList.appendChild(rowDiv);
            });

            document.getElementById('success-result').classList.remove('d-none');
            createAndShowToast(i18n.t('toast.product_created'), 'success');
        }

        // ============================================================
        // Zero Qty Confirmation Handler
        // ============================================================
        document.getElementById('confirm-zero-qty').addEventListener('change', function () {
            zeroQtyConfirmed = this.checked;
            if (validationErrors.length === 0 && validRows.length > 0) {
                document.getElementById('btn-step2-submit').disabled = !zeroQtyConfirmed;
            }
        });

        // ============================================================
        // Submit
        // ============================================================
        function triggerAuthAndSubmit() {
            return new Promise((resolve) => {
                requestPasswordVerify(
                    'btn_create_skus',
                    function (passwords) {
                        for (const [slot, code] of Object.entries(passwords)) {
                            const input = document.querySelector('input[name="sec_code_' + slot + '"]');
                            if (input) input.value = code;
                        }
                        wizard.goToStep('done');
                        executeSubmit();
                        resolve(false);
                    },
                    document.getElementById('sku-submit-form'),
                    (window.i18n?.t('js.create_product') || 'Create Product'),
                    function () {
                        console.log('Submit cancelled');
                        resolve(false);
                    }
                );
            });
        }

        function executeSubmit() {
            document.getElementById('execute-loading').classList.remove('d-none');
            document.getElementById('success-result').classList.add('d-none');
            document.getElementById('error-result').classList.add('d-none');

            // Build payload (只包含非空行)
            console.log("[Submit] payloadRows:", validRows.length, "SKUs:", validRows.map(r => r.SKU));
            const submitData = validRows.map(row => ({
                ...row,
                Cog: row.Cost + row.Freight
            }));

            const form = document.getElementById('sku-submit-form');
            const formData = new FormData(form);
            formData.set('sku_data', JSON.stringify(submitData));

            fetch('{% url "web_ui:db_admin:cogs_create_skus" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.text())
                .then(responseText => {
                    document.getElementById('execute-loading').classList.add('d-none');

                    if (responseText.includes('alert-success') || responseText.includes((window.i18n?.t('js.success') || 'Success'))) {
                        renderSuccessResultSafe();
                    } else {
                        const errorMessage = extractTextFromHtml(responseText);
                        showErrorResult(errorMessage || (window.i18n?.t('js.create_failed_retry') || 'Create failed, retry'));
                    }
                })
                .catch(error => {
                    document.getElementById('execute-loading').classList.add('d-none');
                    showErrorResult((window.i18n?.t('js.network_error_check_retry') || 'Network error, check connection'));
                    console.error('Submit error:', error);
                });
        }

        function extractTextFromHtml(htmlString) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');
                return doc.body.textContent?.trim() || '';
            } catch (e) {
                return htmlString;
            }
        }

        function showErrorResult(message) {
            document.getElementById('error-result-message').textContent = typeof message === 'string' ? message : (window.i18n?.t('js.unknown_error') || 'Unknown Error');
            document.getElementById('error-result').classList.remove('d-none');
            createAndShowToast(i18n.t('toast.create_failed'), 'danger');
        }

        // ============================================================
        // Button Bindings
        // ============================================================
        document.getElementById('btn-step1-next').addEventListener('click', function () { wizard.next(); });
        document.getElementById('btn-step2-back').addEventListener('click', function () { wizard.back(); });
        document.getElementById('btn-step2-submit').addEventListener('click', function () { wizard.next(); });
        document.getElementById('btn-new-round').addEventListener('click', function () { wizard.restart(); });
    });
</script>
{% endblock %}