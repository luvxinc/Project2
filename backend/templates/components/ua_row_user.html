<tr id="{{ user.row_id }}" class="fade-me-out align-middle border-bottom border-secondary border-opacity-10">
    {# 1. 用户名与头像 #}
    <td class="ps-4 py-3">
        <div class="d-flex align-items-center">
            <div class="avatar-sm rounded-circle bg-secondary bg-opacity-25 text-white d-flex justify-content-center align-items-center me-3"
                style="width: 36px; height: 36px; font-size: 0.9rem; user-select: none; border: 1px solid rgba(255,255,255,0.1);">
                {{ user.username|first|upper }}
            </div>
            <div>
                <div class="fw-bold text-white tracking-wide">{{ user.username }}</div>
                {% if user.is_locked %}
                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 mt-1"
                    style="font-size: 0.6rem;">
                    <i class="fa-solid fa-lock me-1"></i>LOCKED
                </span>
                {% endif %}
            </div>
        </div>
    </td>

    {# 2. 角色标签 #}
    <td class="py-3">
        <span
            class="{{ user.role_class }} small border border-opacity-25 px-2 py-1 rounded bg-black bg-opacity-25 font-monospace">
            {{ user.role_label }}
        </span>
    </td>

    {# 3. 最近登录 #}
    <td class="py-3 text-white-50 small font-monospace">
        {% if user.last_login == "Never" %}
        <span class="opacity-25">Never Logged In</span>
        {% else %}
        <i class="fa-regular fa-clock me-1 opacity-50"></i>{{ user.last_login }}
        {% endif %}
    </td>

    {# 4. 失败次数 #}
    <td class="py-3 font-monospace text-center small">
        {% if user.failed_attempts > 0 %}
        <span class="text-warning fw-bold bg-warning bg-opacity-10 px-2 rounded">{{ user.failed_attempts }}</span>
        {% else %}
        <span class="text-muted opacity-25">-</span>
        {% endif %}
    </td>

    {# 5. 操作按钮组 #}
    <td class="text-end pe-4 py-3">
        <div class="btn-group btn-group-sm shadow-sm" role="group">

            {# [Restore] 职级变更按钮 #}
            {% if request.user.is_superuser %}
            {% if user.is_protected %}
            {# 受保护用户: 显示灰色禁用箭头 #}
            <button class="btn btn-dark border-secondary text-muted opacity-25" disabled style="cursor: not-allowed;">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
            <button class="btn btn-dark border-secondary text-muted opacity-25" disabled style="cursor: not-allowed;">
                <i class="fa-solid fa-arrow-down"></i>
            </button>
            {% else %}
            {# 普通用户: 显示彩色功能箭头 (Removed problematic disabled logic) #}
            <button type="button" class="btn btn-dark border-secondary text-success hover-text-white" data-i18n-title="user_admin.btn_promote" title="晋升为管理员"
                data-bs-toggle="modal" data-bs-target="#changeRoleModal"
                data-url="{% url 'web_ui:user_change_role' target_username=user.username %}"
                data-row-id="{{ user.row_id }}" data-username="{{ user.username }}" data-direction="up"
                onclick="setupRoleModal(this)">
                <i class="fa-solid fa-arrow-up"></i>
            </button>

            <button type="button" class="btn btn-dark border-secondary text-warning hover-text-white" data-i18n-title="user_admin.btn_demote" title="降级为普通用户"
                data-bs-toggle="modal" data-bs-target="#changeRoleModal"
                data-url="{% url 'web_ui:user_change_role' target_username=user.username %}"
                data-row-id="{{ user.row_id }}" data-username="{{ user.username }}" data-direction="down"
                onclick="setupRoleModal(this)">
                <i class="fa-solid fa-arrow-down"></i>
            </button>
            {% endif %}
            {% endif %}

            {# 权限配置按钮 #}
            {% if user.is_protected %}
            <button type="button" class="btn btn-dark border-secondary text-muted opacity-25" disabled>
                <i class="fa-solid fa-shield-halved"></i>
            </button>
            {% else %}
            <button type="button" class="btn btn-dark border-secondary text-info hover-text-white" data-i18n-title="user_admin.btn_config_perms" title="配置板块权限"
                hx-get="{% url 'web_ui:permission_form' target_username=user.username %}" hx-target="#ua-content-area"
                hx-swap="innerHTML">
                <i class="fa-solid fa-shield-halved"></i>
            </button>
            {% endif %}

            {# 修改密码按钮 #}
            <button type="button" class="btn btn-dark border-secondary text-warning hover-text-white" data-i18n-title="user_admin.btn_reset_pwd" title="修改/重置密码"
                data-bs-toggle="modal" data-bs-target="#resetPasswordModal"
                onclick="setupResetModal('{{ user.username }}')">
                <i class="fa-solid fa-key"></i>
            </button>

            {% if not user.is_protected %}
            {# 锁定/解锁按钮 #}
            {% if user.is_locked %}
            {# [Fix] 解锁按钮现在触发 Modal，以便输入密码 #}
            <button type="button" class="btn btn-dark border-secondary text-success hover-text-white" data-i18n-title="user_admin.btn_unlock" title="解锁账号"
                data-bs-toggle="modal" data-bs-target="#lockUserModal"
                data-manage-url="{% url 'web_ui:user_manage' target_username=user.username %}"
                data-row-id="{{ user.row_id }}" data-username="{{ user.username }}" data-action-type="unlock"
                onclick="setupLockModal(this)">
                <i class="fa-solid fa-lock-open"></i>
            </button>
            {% else %}
            {# 锁定按钮 #}
            <button type="button" class="btn btn-dark border-secondary text-white-50 hover-danger" data-i18n-title="user_admin.btn_lock" title="锁定账号"
                data-bs-toggle="modal" data-bs-target="#lockUserModal"
                data-manage-url="{% url 'web_ui:user_manage' target_username=user.username %}"
                data-row-id="{{ user.row_id }}" data-username="{{ user.username }}" data-action-type="lock"
                onclick="setupLockModal(this)">
                <i class="fa-solid fa-lock"></i>
            </button>
            {% endif %}

            {# 删除按钮 #}
            <button type="button" class="btn btn-dark border-secondary text-danger hover-bg-danger" data-i18n-title="user_admin.btn_delete" title="永久删除"
                data-bs-toggle="modal" data-bs-target="#deleteUserModal"
                onclick="setupDeleteModal('{{ user.username }}')">
                <i class="fa-solid fa-trash"></i>
            </button>
            {% else %}
            {# 受保护用户: 锁定与删除变灰 #}
            <button class="btn btn-dark border-secondary text-muted opacity-25" disabled><i
                    class="fa-solid fa-lock"></i></button>
            <button class="btn btn-dark border-secondary text-muted opacity-25" disabled><i
                    class="fa-solid fa-trash"></i></button>
            {% endif %}
        </div>
    </td>
</tr>