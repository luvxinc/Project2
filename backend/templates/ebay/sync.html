{% extends "layouts/base.html" %}
{% load i18n %}

{% block title %}eBay Data Sync{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'ebay:dashboard' %}">eBay Integration</a></li>
                    <li class="breadcrumb-item active">Data Sync</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="bi bi-arrow-repeat me-2"></i>Data Synchronization
            </h2>
            <p class="text-muted mb-0">Pull orders and financial data from your eBay account</p>
        </div>
    </div>

    <!-- 同步状态 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Sync Status</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <td class="text-muted">Environment</td>
                            <td><span class="badge bg-warning">{{ status.environment|upper }}</span></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Token Status</td>
                            <td>
                                {% if status.has_valid_token %}
                                <span class="text-success"><i class="bi bi-check-circle me-1"></i>Valid</span>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-x-circle me-1"></i>Not authorized</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Last Sync</td>
                            <td>{{ status.last_sync_time|default:"Never" }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Sync In Progress</td>
                            <td>
                                {% if status.sync_in_progress %}
                                <span class="text-warning"><i class="bi bi-hourglass-split me-1"></i>Yes</span>
                                {% else %}
                                <span class="text-muted">No</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- 日期范围选择 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-calendar-range me-2"></i>Date Range</h5>
                </div>
                <div class="card-body">
                    <form id="syncForm">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="start_date">
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="end_date">
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="saveToDb" checked>
                                <label class="form-check-label" for="saveToDb">
                                    Save to database
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步操作 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Sync Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card border h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-box-seam text-primary" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3">Sync Orders</h5>
                                    <p class="text-muted small">Fetch order data from Fulfillment API</p>
                                    <button class="btn btn-primary w-100" onclick="syncOrders()" {% if not status.has_valid_token %}disabled{% endif %}>
                                        <i class="bi bi-download me-2"></i>Sync Orders
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-currency-dollar text-success" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3">Sync Finances</h5>
                                    <p class="text-muted small">Fetch earnings from Finances API</p>
                                    <button class="btn btn-success w-100" onclick="syncFinances()" {% if not status.has_valid_token %}disabled{% endif %}>
                                        <i class="bi bi-download me-2"></i>Sync Finances
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-arrow-repeat text-info" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3">Full Sync</h5>
                                    <p class="text-muted small">Sync both orders and finances</p>
                                    <button class="btn btn-info w-100" onclick="syncAll()" {% if not status.has_valid_token %}disabled{% endif %}>
                                        <i class="bi bi-arrow-clockwise me-2"></i>Sync All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步日志 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Sync Log</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                        <i class="bi bi-trash me-1"></i>Clear
                    </button>
                </div>
                <div class="card-body">
                    <div id="syncLog" class="bg-dark text-light p-3 rounded"
                        style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                        <div class="text-muted">Sync log will appear here...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 设置默认日期 (过去30天)
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date();
        const thirtyDaysAgo = new Date(today - 30 * 24 * 60 * 60 * 1000);

        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    });

    function getFormData() {
        return {
            start_date: document.getElementById('startDate').value || null,
            end_date: document.getElementById('endDate').value || null,
            save_to_db: document.getElementById('saveToDb').checked
        };
    }

    function log(message, type = 'info') {
        const logDiv = document.getElementById('syncLog');
        const time = new Date().toLocaleTimeString();
        const colors = {
            'info': 'text-info',
            'success': 'text-success',
            'error': 'text-danger',
            'warning': 'text-warning'
        };

        logDiv.innerHTML += `<div class="${colors[type] || ''}">[${time}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
        document.getElementById('syncLog').innerHTML = '<div class="text-muted">Log cleared...</div>';
    }

    async function syncOrders() {
        log('Starting order sync...', 'info');

        try {
            const response = await fetch('{% url "ebay:api_sync_orders" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(getFormData())
            });

            const data = await response.json();

            if (data.success) {
                log(`✅ Order sync complete!`, 'success');
                log(`   Orders fetched: ${data.orders_fetched}`, 'success');
                log(`   Transactions generated: ${data.transactions_generated}`, 'success');
                log(`   Saved to DB: ${data.transactions_saved}`, 'success');
            } else {
                log(`❌ Sync failed: ${data.error}`, 'error');
            }
        } catch (e) {
            log(`❌ Error: ${e}`, 'error');
        }
    }

    async function syncFinances() {
        log('Starting financial sync...', 'info');

        try {
            const response = await fetch('{% url "ebay:api_sync_finances" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(getFormData())
            });

            const data = await response.json();

            if (data.success) {
                log(`✅ Financial sync complete!`, 'success');
                log(`   Transactions fetched: ${data.transactions_fetched}`, 'success');
                log(`   Earnings generated: ${data.earnings_generated}`, 'success');
                log(`   Saved to DB: ${data.earnings_saved}`, 'success');
            } else {
                log(`❌ Sync failed: ${data.error}`, 'error');
            }
        } catch (e) {
            log(`❌ Error: ${e}`, 'error');
        }
    }

    async function syncAll() {
        log('Starting full sync...', 'info');

        try {
            const response = await fetch('{% url "ebay:api_sync_all" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(getFormData())
            });

            const data = await response.json();

            if (data.success) {
                log(`✅ Full sync complete!`, 'success');
                log(`--- Orders ---`, 'info');
                log(`   Fetched: ${data.orders.orders_fetched}`, 'success');
                log(`--- Finances ---`, 'info');
                log(`   Fetched: ${data.finances.transactions_fetched}`, 'success');
            } else {
                log(`❌ Sync failed`, 'error');
                if (data.orders && !data.orders.success) {
                    log(`   Orders error: ${data.orders.error}`, 'error');
                }
                if (data.finances && !data.finances.success) {
                    log(`   Finances error: ${data.finances.error}`, 'error');
                }
            }
        } catch (e) {
            log(`❌ Error: ${e}`, 'error');
        }
    }
</script>
{% endblock %}