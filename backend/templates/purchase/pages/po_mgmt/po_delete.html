<!-- 订单删除页面 - GlobalWizard版本 -->
{% load i18n %}
<div class="glass-card p-4 shadow-lg">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
        <div class="d-flex align-items-center">
            <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-3">
                <i class="fas fa-trash-alt fa-2x text-danger"></i>
            </div>
            <div>
                <h5 class="text-white mb-1" data-i18n="purchase.po_delete">删除订单</h5>
                <p class="text-white-50 small mb-0" id="delete-po-num-label" data-i18n="ui.text_627">订单号: -</p>
            </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="showListView()">
            <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
        </button>
    </div>

    <!-- GlobalWizard容器 -->
    <div id="delete-wizard-container" style="display: none;">
        <!-- 步骤条锚点 -->
        <div data-wizard-stepbar-anchor></div>

        <!-- =================== -->
        <!-- 流程1: 订单预览 -->
        <!-- =================== -->
        <div id="delete-step-1" class="wizard-step-content active">
            <div class="text-center mb-4">
                <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-trash-alt fa-2x text-danger"></i>
                </div>
                <h4 class="text-white" data-i18n="ui.text_628">确认删除订单</h4>
                <p class="text-white-50" data-i18n="ui.text_629">请仔细核对以下订单信息，删除后无法恢复</p>
            </div>

            <!-- 警告提示 -->
            <div class="alert alert-danger bg-danger bg-opacity-10 border-danger mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                    <div>
                        <h6 class="mb-1 text-danger" data-i18n="ui.text_630">危险操作警告</h6>
                        <p class="mb-0 small" data-i18n="ui.text_631">此操作将标记整个订单为已删除状态。订单删除后将不会出现在正常订单列表中。</p>
                    </div>
                </div>
            </div>

            <!-- 订单基础信息卡片 -->
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header bg-primary bg-opacity-10 border-secondary">
                    <i class="fas fa-info-circle me-2 text-primary"></i>
                    <span class="text-white" data-i18n="ui.text_632">订单基础信息</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-white-50 small mb-1" data-i18n="purchase.order_num">订单号</div>
                            <div class="text-white fw-bold font-monospace" id="delete-preview-po-num">-</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-white-50 small mb-1" data-i18n="common.supplier">供应商</div>
                            <div class="text-white" id="delete-preview-supplier">-</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-white-50 small mb-1" data-i18n="ui.text_2195">订货日期</div>
                            <div class="text-info" id="delete-preview-date">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 订单策略信息卡片 -->
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header bg-info bg-opacity-10 border-secondary">
                    <i class="fas fa-chess-knight me-2 text-info"></i>
                    <span class="text-white" data-i18n="ui.text_633">订单策略</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="common.currency">货币</div>
                            <div class="text-white" id="delete-preview-currency">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="table.exchange_rate">汇率</div>
                            <div class="text-white" id="delete-preview-rate">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="purchase.price_float">价格浮动</div>
                            <div id="delete-preview-float">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="purchase.deposit_req">定金要求</div>
                            <div id="delete-preview-deposit">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 订单明细卡片 -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-success bg-opacity-10 border-secondary d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-list me-2 text-success"></i>
                        <span class="text-white" data-i18n="ui.text_634">订单明细</span>
                    </div>
                    <span class="badge bg-success" id="delete-preview-items-count" data-i18n="ui.text_635">0 件商品</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="sticky-top bg-dark">
                                <tr class="text-white-50">
                                    <th>#</th>
                                    <th>SKU</th>
                                    <th class="text-center" data-i18n="common.quantity">数量</th>
                                    <th class="text-end" data-i18n="common.unit_price">单价</th>
                                    <th class="text-end" data-i18n="common.subtotal">小计</th>
                                </tr>
                            </thead>
                            <tbody id="delete-preview-items-tbody">
                                <!-- JS动态填充 -->
                            </tbody>
                            <tfoot class="border-top border-secondary">
                                <tr>
                                    <td colspan="4" class="text-end text-white-50 fw-bold" data-i18n="ui.text_2203">总计:</td>
                                    <td class="text-end text-success fw-bold" id="delete-preview-total">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="d-flex justify-content-end gap-3">
                <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="showListView()">
                    <i class="fas fa-times me-2"></i><span data-i18n="common.cancel">取消</span>
                </button>
                <button class="btn btn-danger btn-lg px-4 rounded-pill" id="btn-delete-confirm" onclick="confirmDeleteOrder()">
                    <i class="fas fa-trash-alt me-2"></i><span data-i18n="modal.confirm_delete.title">确认删除</span>
                </button>
            </div>
        </div>

        <!-- =================== -->
        <!-- 流程2: 完成 -->
        <!-- =================== -->
        <div id="delete-step-2" class="wizard-step-content" style="display: none;">
            <div class="text-center py-5">
                <div id="delete-result-icon">
                    <!-- JS动态填充 -->
                </div>
                <h4 class="text-white mb-3" id="delete-result-title" data-i18n="ui.text_229">处理中...</h4>
                <p class="text-white-50 mb-4" id="delete-result-message" data-i18n="ui.text_637">
                    正在删除订单...
                </p>
                <div class="d-flex justify-content-end gap-3">
                    <button class="btn btn-primary btn-lg px-4 rounded-pill" onclick="showListView()">
                        <i class="fas fa-list me-2"></i><span data-i18n="ui.icon_3203">返回订单列表</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载中 -->
    <div id="delete-loading" class="text-center py-5">
        <div class="spinner-border text-danger" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="purchase.loading_orders">正在加载订单数据...</p>
    </div>
</div>

<script>
    // 当前删除的订单号
    let deleteCurrentPoNum = null;
    let deleteOriginalData = null;
    let deleteWizard = null;
    
    // 加载订单数据用于删除
    function loadOrderForDelete(poNum) {
        deleteCurrentPoNum = poNum;
        document.getElementById('delete-po-num-label').textContent = `订单号: ${poNum}`;
        
        // 重置 Wizard 状态：如果已存在，回到第一步（防止上一次删除完成后停留在 step-2）
        if (deleteWizard) {
            showDeleteStep(1);
        }
        
        const loading = document.getElementById('delete-loading');
        const container = document.getElementById('delete-wizard-container');
        loading.style.display = 'block';
        container.style.display = 'none';
        
        // 获取订单详情
        fetch(`{% url 'web_ui:purchase:po_mgmt_detail' %}?po_num=${encodeURIComponent(poNum)}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    alert(data.message || "{% trans '加载订单失败' %}");
                    showListView();
                    return;
                }
                
                deleteOriginalData = data.data;
                
                // 检查订单是否已删除
                if (data.data.is_deleted) {
                    alert("{% trans '此订单已被删除' %}");
                    showListView();
                    return;
                }
                
                container.style.display = 'block';
                
                // 初始化向导
                initDeleteWizard();
                
                // 填充预览数据
                populateDeletePreview(data.data);
            })
            .catch(err => {
                loading.style.display = 'none';
                alert("{% trans '加载订单失败' %}: " + err);
                showListView();
            });
    }
    
    // 初始化GlobalWizard
    function initDeleteWizard() {
        if (deleteWizard) return;
        
        if (typeof GlobalWizard === 'undefined') {
            console.error('[DeleteWizard] GlobalWizard not available');
            return;
        }
        
        deleteWizard = new GlobalWizard({
            containerId: 'delete-wizard-container',  // 使用containerId，不带#
            steps: [
                { id: 'preview', label: (window.i18n?.t('js.order_preview') || 'Order Preview'), type: 'normal', contentSelector: '#delete-step-1' },
                { id: 'done', label: (window.i18n?.t('js.delete_complete') || 'Delete Complete'), type: 'done', contentSelector: '#delete-step-2' }
            ],
            onStepChange: () => {} // 由按钮控制跳转
        });
    }
    
    // 填充删除预览数据
    function populateDeletePreview(data) {
        const { base, strategy, detail } = data;
        
        // 基础信息
        document.getElementById('delete-preview-po-num').textContent = base.po_num || '-';
        document.getElementById('delete-preview-supplier').textContent = base.supplier_code || '-';
        document.getElementById('delete-preview-date').textContent = base.order_date || '-';
        
        // 策略信息
        document.getElementById('delete-preview-currency').textContent = strategy.currency || '-';
        document.getElementById('delete-preview-rate').textContent = strategy.exchange_rate ? strategy.exchange_rate.toFixed(4) : '-';
        
        const floatEl = document.getElementById('delete-preview-float');
        if (strategy.float_enabled) {
            floatEl.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>±${strategy.float_threshold}%</span>`;
        } else {
            floatEl.innerHTML = `<span class="text-white-50">{% trans '未启用' %}</span>`;
        }
        
        const depositEl = document.getElementById('delete-preview-deposit');
        if (strategy.deposit_enabled) {
            depositEl.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>${strategy.deposit_par}%</span>`;
        } else {
            depositEl.innerHTML = `<span class="text-white-50">{% trans '未启用' %}</span>`;
        }
        
        // 明细信息
        const items = detail.items || [];
        document.getElementById('delete-preview-items-count').textContent = `${items.length} {% trans '件商品' %}`;
        
        const tbody = document.getElementById('delete-preview-items-tbody');
        tbody.innerHTML = '';
        
        let total = 0;
        items.forEach((item, idx) => {
            const subtotal = item.qty * item.unit_price;
            total += subtotal;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-white-50">${idx + 1}</td>
                <td class="font-monospace">${item.sku}</td>
                <td class="text-center">${item.qty}</td>
                <td class="text-end">${item.unit_price.toFixed(2)}</td>
                <td class="text-end text-success">${subtotal.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
        
        const currency = strategy.currency || detail.currency || 'RMB';
        document.getElementById('delete-preview-total').textContent = 
            `${currency} ${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    }
    
    // 确认删除订单
    function confirmDeleteOrder() {
        // 使用密码验证
        if (typeof requestPasswordVerify === 'function') {
            requestPasswordVerify(
                'btn_po_delete',         // actionKey
                (passwords) => submitDeleteAsync(passwords),  // onSuccess，接收密码对象
                null,                    // contextEl (无需回填)
                "{% trans '删除订单' %}",              // actionDisplayName
                (reason) => {            // onCancel
                }
            );
        } else {
            // 无密码验证，直接确认
            if (confirm("{% trans '确定要删除此订单吗？此操作不可恢复！' %}")) {
                submitDeleteAsync({});
            }
        }
    }
    
    // 异步提交删除
    function submitDeleteAsync(passwords) {
        return new Promise((resolve, reject) => {
            submitDelete(passwords, resolve, reject);
        });
    }
    
    // 提交删除
    function submitDelete(passwords, onSuccess, onError) {
        // 跳转到完成步骤
        showDeleteStep(2);
        
        // 显示处理中状态
        document.getElementById('delete-result-icon').innerHTML = `
            <div class="spinner-border text-danger mb-3" style="width: 80px; height: 80px;" role="status"></div>
        `;
        document.getElementById('delete-result-title').textContent = "{% trans '正在删除...' %}";
        document.getElementById('delete-result-message').textContent = "{% trans '请稍候，正在处理删除请求...' %}";
        
        // 构建请求体，包含密码
        const requestBody = {
            po_num: deleteCurrentPoNum
        };
        
        // 添加密码到请求（passwords格式为 { user: "密码" }）
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                requestBody[`sec_code_${slot}`] = code;
            }
        }
        
        fetch(`{% url 'web_ui:purchase:po_mgmt_submit_delete' %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(requestBody)
        })
        .then(r => {
            // 检查响应类型，如果不是 JSON 则抛出明确错误
            const contentType = r.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                throw new Error(`服务器返回了非JSON响应 (${r.status})，可能是登录失效或权限问题`);
            }
            return r.json();
        })
        .then(data => {
            if (data.success) {
                // 成功
                document.getElementById('delete-result-icon').innerHTML = `
                    <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-check fa-2x text-success"></i>
                    </div>
                `;
                document.getElementById('delete-result-title').textContent = "{% trans '删除成功' %}";
                document.getElementById('delete-result-title').className = 'text-success mb-3';
                document.getElementById('delete-result-message').textContent = 
                    "{% trans '订单' %} " + deleteCurrentPoNum + " {% trans '已成功删除。' %}";
                
                if (onSuccess) onSuccess();
            } else {
                // 失败
                document.getElementById('delete-result-icon').innerHTML = `
                    <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-times fa-2x text-danger"></i>
                    </div>
                `;
                document.getElementById('delete-result-title').textContent = "{% trans '删除失败' %}";
                document.getElementById('delete-result-title').className = 'text-danger mb-3';
                document.getElementById('delete-result-message').textContent = 
                    data.message || "{% trans '删除订单时发生错误' %}";
                
                if (onError) onError();
            }
        })
        .catch(err => {
            // 错误
            document.getElementById('delete-result-icon').innerHTML = `
                <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                </div>
            `;
            document.getElementById('delete-result-title').textContent = "{% trans '请求失败' %}";
            document.getElementById('delete-result-title').className = 'text-danger mb-3';
            document.getElementById('delete-result-message').textContent = 
                "{% trans "网络错误" %}: " + err;
            
            if (onError) onError();
        });
    }
    
    // 显示指定步骤
    function showDeleteStep(stepNum) {
        // 隐藏所有步骤
        for (let i = 1; i <= 2; i++) {
            const el = document.getElementById(`delete-step-${i}`);
            if (el) el.style.display = 'none';
        }
        // 显示目标步骤
        const target = document.getElementById(`delete-step-${stepNum}`);
        if (target) target.style.display = 'block';
        
        // 更新向导进度条
        if (deleteWizard) {
            deleteWizard.goToStep(stepNum - 1);
        }
    }
</script>