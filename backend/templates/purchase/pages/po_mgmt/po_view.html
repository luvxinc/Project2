{% load i18n %}
<!-- 订单详情查看页面 -->
<div class="glass-card p-4 shadow-lg">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
        <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-25 p-3 rounded-circle me-3">
                <i class="fas fa-file-invoice fa-2x text-primary"></i>
            </div>
            <div>
                <h5 class="text-white mb-1" data-i18n="ui.text_641">查看订单详情</h5>
                <p class="text-white-50 small mb-0" id="view-po-num-label" data-i18n="ui.text_627">订单号: -</p>
            </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="showListView()">
            <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
        </button>
    </div>

    <!-- 加载中 -->
    <div id="view-loading" class="text-center py-5">
        <div class="spinner-border text-info" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="purchase.loading_orders">正在加载订单数据...</p>
    </div>

    <!-- 订单内容 -->
    <div id="view-content" style="display: none;">
        <!-- 删除警告 -->
        <div id="view-deleted-alert" class="alert alert-danger align-items-center mb-4 d-none">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="view-deleted-reason" data-i18n="ui.text_644">此订单已被标记为删除</span>
        </div>

        <!-- 操作按钮 (右对齐，在订单基础信息上方) -->
        <div class="d-flex justify-content-end gap-2 mb-4">
            <button class="btn btn-outline-info rounded-pill px-3" id="btn-view-download" onclick="handleDownload()">
                <i class="fas fa-download me-2"></i><span data-i18n="ui.icon_3205">下载订单</span>
            </button>
            <button class="btn btn-warning rounded-pill px-3" id="btn-view-edit" onclick="handleEdit()">
                <i class="fas fa-pen me-2"></i><span data-i18n="ui.text_559">修改订单</span>
            </button>
            <button class="btn btn-outline-secondary rounded-pill px-3" id="btn-view-history" onclick="handleHistory()">
                <i class="fas fa-history me-2"></i><span data-i18n="common.history">历史记录</span>
            </button>
            <button class="btn btn-outline-danger rounded-pill px-3" id="btn-view-delete" onclick="handleDelete()">
                <i class="fas fa-trash me-2"></i><span data-i18n="purchase.po_delete">删除订单</span>
            </button>
        </div>

        <!-- 框体1: 订单基础信息 -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-primary bg-opacity-10 border-secondary">
                <i class="fas fa-info-circle me-2 text-primary"></i>
                <span class="text-white" data-i18n="ui.text_632">订单基础信息</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="common.supplier">供应商</div>
                        <div class="text-white fw-bold" id="view-supplier-code">-</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2195">订货日期</div>
                        <div class="text-info" id="view-order-date">-</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="purchase.order_num">订单号</div>
                        <div class="text-white font-monospace" id="view-po-num">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 框体2: 订单策略信息 -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-info bg-opacity-10 border-secondary">
                <i class="fas fa-chess-knight me-2 text-info"></i>
                <span class="text-white" data-i18n="ui.text_646">订单策略信息</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2207">最新策略版本</div>
                        <div class="text-info fw-bold" id="view-strategy-seq">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.operator">操作人</div>
                        <div class="text-white" id="view-strategy-by">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2147">修订日期</div>
                        <div class="text-white" id="view-strategy-date">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.remark">备注</div>
                        <div class="text-white-50" id="view-strategy-note">-</div>
                    </div>
                </div>
                <hr class="border-secondary my-3">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.currency">货币</div>
                        <div class="text-white" id="view-currency">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="table.settlement_rate">结算汇率</div>
                        <div class="text-white" id="view-exchange-rate">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="purchase.price_float">价格浮动</div>
                        <div id="view-float-status">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="purchase.deposit_req">定金要求</div>
                        <div id="view-deposit-status">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 框体3: 订单明细信息 -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-success bg-opacity-10 border-secondary">
                <i class="fas fa-list me-2 text-success"></i>
                <span class="text-white" data-i18n="ui.text_647">订单明细信息</span>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-2">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2215">修订版本</div>
                        <div class="text-success fw-bold" id="view-detail-seq">-</div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-white-50 small mb-1" data-i18n="common.operator">操作人</div>
                        <div class="text-white" id="view-detail-by">-</div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2147">修订日期</div>
                        <div class="text-white" id="view-detail-date">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.remark">备注</div>
                        <div class="text-white-50" id="view-detail-note">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2219">总价</div>
                        <div class="text-success fw-bold fs-5" id="view-total-amount">-</div>
                    </div>
                </div>

                <!-- 商品列表 -->
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr class="text-white-50">
                                <th>#</th>
                                <th>SKU</th>
                                <th class="text-center" data-i18n="common.quantity">数量</th>
                                <th class="text-center" data-i18n="common.currency">货币</th>
                                <th class="text-end" data-i18n="common.unit_price">单价</th>
                                <th class="text-end" data-i18n="ui.text_2223">价值</th>
                            </tr>
                        </thead>
                        <tbody id="view-items-tbody">
                            <!-- JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 当前查看的订单号（本地变量）
    let viewCurrentPoNum = null;
    
    // 加载订单详情
    function loadOrderDetail(poNum) {
        viewCurrentPoNum = poNum;  // 保存当前订单号
        
        const loading = document.getElementById('view-loading');
        const content = document.getElementById('view-content');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        document.getElementById('view-po-num-label').textContent = `订单号: ${poNum}`;
        
        fetch(`{% url 'web_ui:purchase:po_mgmt_detail' %}?po_num=${encodeURIComponent(poNum)}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    alert(data.message || '{% trans "加载失败" %}');
                    showListView();
                    return;
                }
                
                content.style.display = 'block';
                const { base, strategy, detail, is_deleted, delete_reason } = data.data;
                
                // 删除警告
                const alertEl = document.getElementById('view-deleted-alert');
                const reasonEl = document.getElementById('view-deleted-reason');
                
                if (is_deleted) {
                    alertEl.classList.remove('d-none');
                    alertEl.classList.add('d-flex');
                    // 根据删除原因显示不同提示
                    if (delete_reason === 'direct_delete') {
                        reasonEl.textContent = (window.i18n?.t('js.order_fully_deleted') || 'Order fully deleted');
                    } else if (delete_reason === 'all_items_deleted') {
                        reasonEl.textContent = (window.i18n?.t('js.order_items_deleted') || 'Order items deleted');
                    } else {
                        reasonEl.textContent = (window.i18n?.t('js.order_marked_deleted') || 'Order marked for deletion');
                    }
                    document.getElementById('btn-view-edit').disabled = true;
                    document.getElementById('btn-view-delete').disabled = true;
                } else {
                    alertEl.classList.add('d-none');
                    alertEl.classList.remove('d-flex');
                    document.getElementById('btn-view-edit').disabled = false;
                    document.getElementById('btn-view-delete').disabled = false;
                }
                
                // 基础信息
                document.getElementById('view-supplier-code').textContent = base.supplier_code;
                document.getElementById('view-order-date').textContent = base.order_date;
                document.getElementById('view-po-num').textContent = base.po_num;
                
                // 策略信息
                document.getElementById('view-strategy-seq').textContent = strategy.seq || '-';
                document.getElementById('view-strategy-by').textContent = strategy.by || '-';
                document.getElementById('view-strategy-date').textContent = strategy.date || '-';
                document.getElementById('view-strategy-note').textContent = strategy.note || '-';
                document.getElementById('view-currency').textContent = strategy.currency || '-';
                document.getElementById('view-exchange-rate').textContent = strategy.exchange_rate ? strategy.exchange_rate.toFixed(4) : '-';
                
                // 浮动状态
                const floatEl = document.getElementById('view-float-status');
                if (strategy.float_enabled) {
                    floatEl.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>${strategy.float_threshold}%</span>`;
                } else {
                    floatEl.innerHTML = `<span class="text-white-50" data-i18n="ui.text_390">未启用</span>`;
                }
                
                // 定金状态
                const depositEl = document.getElementById('view-deposit-status');
                if (strategy.deposit_enabled) {
                    depositEl.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>${strategy.deposit_par}%</span>`;
                } else {
                    depositEl.innerHTML = `<span class="text-white-50" data-i18n="ui.text_390">未启用</span>`;
                }
                
                // 明细信息
                document.getElementById('view-detail-seq').textContent = detail.seq || '-';
                document.getElementById('view-detail-by').textContent = detail.by || '-';
                document.getElementById('view-detail-date').textContent = detail.date || '-';
                document.getElementById('view-detail-note').textContent = detail.note || '-';
                // 总价双货币显示
                document.getElementById('view-total-amount').innerHTML = `
                    <div class="d-flex flex-column">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size: 0.65rem;">RMB</span>
                            <span class="text-success">¥${(detail.total_rmb || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="d-flex align-items-center mt-1">
                            <span class="badge bg-primary bg-opacity-25 text-primary me-1" style="font-size: 0.65rem;">USD</span>
                            <span class="text-info">$${(detail.total_usd || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>
                `;
                
                // 商品列表
                const tbody = document.getElementById('view-items-tbody');
                tbody.innerHTML = '';
                
                (detail.items || []).forEach((item, idx) => {
                    const tr = document.createElement('tr');
                    // 货币标签样式
                    const currencyBadge = item.currency === 'USD' 
                        ? '<span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.7rem;">USD</span>'
                        : '<span class="badge bg-danger bg-opacity-25 text-danger" style="font-size: 0.7rem;">RMB</span>';
                    
                    tr.innerHTML = `
                        <td class="text-white-50">${idx + 1}</td>
                        <td class="font-monospace">${item.sku}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-center">${currencyBadge}</td>
                        <td class="text-end">${item.unit_price.toFixed(2)}</td>
                        <td class="text-end">
                            <div class="d-flex flex-column align-items-end">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size: 0.6rem;">RMB</span>
                                    <span class="text-success">¥${(item.value_rmb || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div class="d-flex align-items-center mt-1">
                                    <span class="badge bg-primary bg-opacity-25 text-primary me-1" style="font-size: 0.6rem;">USD</span>
                                    <span class="text-info small">$${(item.value_usd || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                loading.style.display = 'none';
                alert('{% trans "加载失败: " %}' + err);
                showListView();
            });
    }
    
    // 下载订单Excel
    function downloadOrderExcel() {
        if (!viewCurrentPoNum) {
            alert('{% trans "无法下载：未选择订单" %}');
            return;
        }
        // 直接触发下载
        window.location.href = `{% url 'web_ui:purchase:po_mgmt_download' %}?po_num=${encodeURIComponent(viewCurrentPoNum)}`;
    }
    
    // 按钮处理函数 - 调用主模板中的函数
    function handleDownload() {
        downloadOrderExcel();
    }
    
    function handleEdit() {
        if (viewCurrentPoNum && typeof editOrder === 'function') {
            editOrder(viewCurrentPoNum);
        }
    }
    
    function handleHistory() {
        if (viewCurrentPoNum && typeof viewHistory === 'function') {
            viewHistory(viewCurrentPoNum);
        }
    }
    
    function handleDelete() {
        if (viewCurrentPoNum && typeof deleteOrder === 'function') {
            deleteOrder(viewCurrentPoNum);
        }
    }
</script>