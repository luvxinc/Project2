{% load i18n %}
<!-- 订单修改向导 - 使用GlobalWizard组件 -->
{% load static %}

<div class="glass-card p-4 shadow-lg" id="edit-wizard-container">
    <!-- Header -->
    <div class="wizard-header d-flex flex-column mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="bg-warning bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center"
                    style="width: 56px; height: 56px; flex-shrink: 0;">
                    <i class="fas fa-edit fa-2x text-warning"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_650">修改订单向导</h5>
                    <p class="text-white-50 small mb-0" id="edit-po-num-label" data-i18n="ui.text_627">订单号: -</p>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="showListView()">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
            </button>
        </div>
        <hr class="border-secondary border-opacity-25 my-4 w-100">
    </div>

    <!-- StepBar 锚点 (GlobalWizard必须) -->
    <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

    <!-- 加载中 (不使用wizard-step-content，因为它不是向导步骤) -->
    <div id="edit-loading" class="text-center py-5">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="purchase.loading_orders">正在加载订单数据...</p>
    </div>

    <!-- ===================================== -->
    <!-- 流程1: 修改订单策略信息 -->
    <!-- ===================================== -->
    <div id="edit-step-1" class="wizard-step-content" style="display: none;">
        <!-- 操作须知 -->
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-3 mt-1 text-info"></i>
                <div>
                    <strong class="text-info" data-i18n="common.operation_notes">操作须知</strong>
                    <ul class="mb-0 mt-2 ps-3">
                        <li data-i18n="desc.d131">左侧显示<strong data-i18n="ui.text_654">原策略</strong>信息，右侧可进行修改</li>
                        <li data-i18n="desc.d132">如需修改策略，请填写新值并在下方填写<strong data-i18n="ui.text_655">必填的修改备注</strong>
                        </li>
                        <li data-i18n="desc.d133">若无需修改策略，可点击<strong data-i18n="ui.text_656">「跳过策略修改」</strong>直接进入明细修改
                        </li>
                        <li data-i18n="ui.text_657">策略修改后将生成新版本号（如V02），原版本记录保留</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-secondary mb-4">
            <div
                class="card-header bg-info bg-opacity-10 border-secondary d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-chess-knight me-2 text-info"></i>
                    <span class="text-white" data-i18n="ui.text_658">修改订单策略信息</span>
                    <span class="badge bg-info ms-2" id="edit-current-strategy-seq">-</span>
                </div>
                <small class="text-white-50" data-i18n="ui.text_659">左侧为原策略，右侧可修改</small>
            </div>
            <div class="card-body">
                <!-- 策略显示网格 (50/50 布局) -->
                <div class="row g-3" id="edit-strategy-display-grid">
                    <!-- JS动态生成，格式参考 renderStrategyDisplayWithEdit -->
                </div>

                <!-- 备注区域 (必填) -->
                <div class="mt-4 p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                    <div class="text-white-50 small mb-2"><span data-i18n="common.modify_note">修改备注</span> <span
                            class="text-danger" data-i18n="ui.text_660">*必填</span></div>
                    <div class="row g-0">
                        <div class="col-6 pe-3 border-end border-secondary">
                            <span class="text-white" id="edit-orig-note">-</span>
                            <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                        </div>
                        <div class="col-6 ps-3">
                            <textarea class="form-control form-control-sm bg-dark border-warning text-white"
                                id="edit-new-note" rows="2" data-i18n-placeholder="form.placeholder.generic_8"
                                placeholder="请输入修改原因和备注..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3">
            <button class="btn btn-warning btn-lg px-4 rounded-pill" id="btn-edit-step1-next"
                onclick="editWizardNext(1)">
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.next">下一步</span>
            </button>
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" id="btn-skip-strategy"
                onclick="editWizardSkipStrategy()">
                <i class="fas fa-forward me-2"></i><span data-i18n="ui.icon_3211">跳过策略修改</span>
            </button>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 流程2: 验证策略参数 -->
    <!-- ===================================== -->
    <div id="edit-step-2" class="wizard-step-content" style="display: none;">
        <!-- 策略参数名片式展示 -->
        <div class="card mb-4 state-normal" id="edit-params-validation-card">
            <div class="card-header border-0 d-flex justify-content-between align-items-center">
                <div>
                    <i class="fa-solid fa-shield-halved me-2 text-info" id="edit-params-validation-icon"></i>
                    <span id="edit-params-validation-title" class="text-info" data-i18n="ui.text_661">策略参数验证</span>
                </div>
                <span class="badge bg-warning bg-opacity-25 text-warning" id="edit-strategy-type-badge"
                    data-i18n="ui.text_662">修改策略</span>
            </div>
            <div class="card-body">
                <!-- 参数信息名片式展示 -->
                <div class="row g-3" id="edit-params-summary-content">
                    <!-- 货币 -->
                    <div class="col-6 col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25" id="edit-verify-cell-currency">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="js.settlement_currency">结算货币</span> <i class="fas fa-info-circle ms-1"></i>
                            </div>
                            <div class="text-info fw-bold" id="edit-verify-currency">-</div>
                        </div>
                    </div>
                    <!-- 汇率 -->
                    <div class="col-6 col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25" id="edit-verify-cell-rate">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="table.settlement_rate">结算汇率</span> <i class="fas fa-info-circle ms-1"></i>
                            </div>
                            <div class="text-white" id="edit-verify-rate">-</div>
                        </div>
                    </div>
                    <!-- 价格浮动开关 -->
                    <div class="col-6 col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25" id="edit-verify-cell-float">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="purchase.price_float">价格浮动</span> <i class="fas fa-info-circle ms-1"></i>
                            </div>
                            <span id="edit-verify-float">-</span>
                        </div>
                    </div>
                    <!-- 浮动阈值 -->
                    <div class="col-6 col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25" id="edit-verify-cell-float-threshold">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="js.float_threshold">浮动阈值</span> <i class="fas fa-info-circle ms-1"></i>
                            </div>
                            <div class="text-white" id="edit-verify-float-threshold">-</div>
                        </div>
                    </div>
                    <!-- 定金开关 -->
                    <div class="col-6 col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25" id="edit-verify-cell-deposit">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="purchase.deposit_req">定金要求</span> <i
                                    class="fas fa-info-circle ms-1"></i>
                            </div>
                            <span id="edit-verify-deposit">-</span>
                        </div>
                    </div>
                    <!-- 定金比例 -->
                    <div class="col-6 col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25" id="edit-verify-cell-deposit-par">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="table.deposit_rate">定金比例</span> <i class="fas fa-info-circle ms-1"></i>
                            </div>
                            <div class="text-white" id="edit-verify-deposit-par">-</div>
                        </div>
                    </div>
                    <!-- 修改备注 (特殊高亮) -->
                    <div class="col-12">
                        <div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50"
                            id="edit-verify-cell-note">
                            <div class="text-white-50 small mb-1">
                                <span data-i18n="common.modify_note">修改备注</span> <span class="text-danger"
                                    data-i18n="ui.text_660">*必填</span>
                            </div>
                            <div class="text-warning" id="edit-verify-note">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 错误信息容器 -->
        <div id="edit-params-errors-container" class="mb-4" style="display: none;">
            <div class="card bg-danger bg-opacity-10 border-danger">
                <div class="card-header bg-danger bg-opacity-20 border-0">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                    <span class="text-danger fw-bold" data-i18n="shipping.verify_failed">参数校验未通过</span>
                </div>
                <div class="card-body">
                    <ul id="edit-params-errors-list" class="mb-0 text-white"></ul>
                    <p class="text-white-50 small mt-3 mb-0">
                        <i class="fas fa-arrow-left me-1"></i><span data-i18n="shipping.return_to_fix">请返回上一步修正错误后再继续</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3">
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="editWizardPrev(2)">
                <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
            </button>
            <button class="btn btn-warning btn-lg px-4 rounded-pill" id="btn-edit-step2-next"
                onclick="editWizardNext(2)" disabled>
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="ui.icon_3214">下一步：修改明细</span>
            </button>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 流程3: 修改订单明细信息 -->
    <!-- ===================================== -->
    <div id="edit-step-3" class="wizard-step-content" style="display: none;">
        <!-- 操作须知 -->
        <!-- 操作须知 -->
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-3 mt-1 text-info"></i>
                <div>
                    <strong class="text-info" data-i18n="common.operation_notes">操作须知</strong>
                    <ul class="mb-0 mt-2 ps-3">
                        <li data-i18n="desc.d143">表格显示当前订单的全部商品，可修改<strong data-i18n="common.quantity">数量</strong>和<strong
                                data-i18n="common.unit_price">单价</strong></li>
                        <li data-i18n="desc.d144">点击<strong data-i18n="ui.text_668">「删除」</strong>可将商品标记为删除（不可恢复）</li>
                        <li data-i18n="desc.d145">点击<strong data-i18n="ui.text_669">「新增SKU」</strong>可添加新商品到订单</li>
                        <li data-i18n="desc.d146">若无需修改明细，可点击<strong data-i18n="ui.text_670">「跳过明细修改」</strong>直接预览</li>
                        <li data-i18n="desc.d147">修改备注为<strong data-i18n="ui.text_671">必填项</strong>，将记录到版本历史中</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-primary bg-opacity-10 border-secondary d-flex justify-content-between">
                <div>
                    <i class="fas fa-list me-2 text-primary"></i>
                    <span class="text-white" data-i18n="ui.text_672">修改订单明细</span>
                    <span class="badge bg-primary ms-2" id="edit-current-detail-seq">-</span>
                </div>
                <button class="btn btn-success btn-sm" onclick="editAddNewSku()">
                    <i class="fas fa-plus me-1"></i><span data-i18n="ui.icon_3215">新增SKU</span>
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="edit-items-table">
                        <thead>
                            <tr class="text-white-50">
                                <th>SKU</th>
                                <th class="text-center" data-i18n="ui.text_234">原数量</th>
                                <th class="text-center" data-i18n="ui.text_2226">新数量</th>
                                <th class="text-end"><span data-i18n="desc.d139">原单价</span> <span
                                        class="edit-currency-label text-info"></span></th>
                                <th class="text-end"><span data-i18n="desc.d140">新单价</span> <span
                                        class="edit-currency-label text-info"></span></th>
                                <th class="text-end"><span data-i18n="common.subtotal">小计</span> <span
                                        class="edit-currency-label text-info"></span></th>
                                <th class="text-center" data-i18n="common.operation">操作</th>
                            </tr>
                        </thead>
                        <tbody id="edit-items-tbody">
                            <!-- JS动态生成 -->
                        </tbody>
                        <tfoot>
                            <tr class="text-success fw-bold">
                                <td colspan="5" class="text-end" data-i18n="ui.text_2203">总计:</td>
                                <td class="text-end" id="edit-items-total">0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- 明细修改备注（必填） -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-warning bg-opacity-10 border-secondary">
                <i class="fas fa-edit me-2 text-warning"></i>
                <span class="text-white"><span data-i18n="common.modify_note">修改备注</span> <span
                        class="text-danger">*</span></span>
            </div>
            <div class="card-body">
                <div class="form-floating">
                    <textarea class="form-control bg-dark text-white border-secondary" id="edit-items-note"
                        data-i18n-placeholder="form.placeholder.generic_7" placeholder="请输入修改备注" style="height: 80px;"
                        maxlength="200"></textarea>
                    <label for="edit-items-note" class="text-white-50"
                        data-i18n="ui.text_673">请说明修改原因（必填，不能为"原始订单"）</label>
                </div>
                <div class="form-text text-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <span data-i18n="desc.d142">修改备注将记录到明细版本中，请认真填写</span>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3">
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="editWizardPrev(3)">
                <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.prev">上一步</span>
            </button>
            <button class="btn btn-warning btn-lg px-4 rounded-pill" onclick="editWizardNext(3)">
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.next">下一步</span>
            </button>
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" id="btn-skip-items"
                onclick="editWizardSkipItems()">
                <i class="fas fa-forward me-2"></i><span data-i18n="ui.icon_3218">跳过明细修改</span>
            </button>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 流程4: 验证商品 -->
    <!-- ===================================== -->
    <div id="edit-step-4" class="wizard-step-content" style="display: none;">
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-success bg-opacity-10 border-secondary">
                <i class="fas fa-check-double me-2 text-success"></i>
                <span class="text-white" data-i18n="ui.text_674">验证商品修改</span>
            </div>
            <div class="card-body">
                <div id="edit-items-validation-list">
                    <!-- JS动态生成验证项 -->
                </div>
            </div>
        </div>

        <!-- SKU合并信息容器（橙色提示框） -->
        <div id="edit-items-merge-container" class="mb-4" style="display: none;">
            <div class="card bg-warning bg-opacity-10 border-warning">
                <div class="card-header bg-warning bg-opacity-20 border-0">
                    <i class="fas fa-compress-alt me-2 text-warning"></i>
                    <span class="text-warning fw-bold" data-i18n="ui.text_675">数据一致性自动合并</span>
                </div>
                <div class="card-body">
                    <p class="text-white-50 small mb-2" data-i18n="desc.d148">
                        <i class="fas fa-info-circle me-1"></i>
                        系统已自动将相同SKU且相同单价的同类操作合并，以确保数据一致性
                    </p>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <ul id="edit-items-merge-list" class="mb-0 text-white"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3">
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="editWizardPrev(4)">
                <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.prev">上一步</span>
            </button>
            <button class="btn btn-warning btn-lg px-4 rounded-pill" id="btn-edit-step4-next"
                onclick="editWizardNext(4)" disabled>
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.next">下一步</span>
            </button>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 流程5: 修改预览 -->
    <!-- ===================================== -->
    <div id="edit-step-5" class="wizard-step-content" style="display: none;">
        <!-- 操作须知 -->
        <!-- 操作须知 -->
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-3 mt-1 text-info"></i>
                <div>
                    <strong class="text-info" data-i18n="common.operation_notes">操作须知</strong>
                    <ul class="mb-0 mt-2 ps-3">
                        <li data-i18n="desc.d149">请仔细核对以下修改内容，确认无误后点击<strong data-i18n="ui.text_677">「确认修改」</strong>
                        </li>
                        <li data-i18n="desc.d150">若只修改了策略或明细其中一项，另一项将显示为<strong data-i18n="ui.text_678">「无修改」</strong>
                        </li>
                        <li data-i18n="ui.text_679">确认后将生成新版本号，修改会立即生效</li>
                        <li data-i18n="desc.d151">如需调整，可点击<strong data-i18n="ui.text_680">「上一步」</strong>返回修改</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 策略信息框体 -->
        <div class="card bg-dark border-secondary mb-4" id="edit-preview-strategy-card">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center"
                id="edit-preview-strategy-header">
                <div>
                    <i class="fas fa-chess-knight me-2 text-info"></i>
                    <span class="text-white" data-i18n="ui.text_681">策略信息</span>
                </div>
                <span class="badge" id="edit-preview-strategy-badge">-</span>
            </div>
            <div class="card-body">
                <div id="edit-preview-strategy-content">
                    <!-- JS动态生成 -->
                </div>
            </div>
        </div>

        <!-- 明细信息框体 -->
        <div class="card bg-dark border-secondary mb-4" id="edit-preview-items-card">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center"
                id="edit-preview-items-header">
                <div>
                    <i class="fas fa-list me-2 text-primary"></i>
                    <span class="text-white" data-i18n="ui.text_682">明细信息</span>
                </div>
                <span class="badge" id="edit-preview-items-badge">-</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-sm mb-0" id="edit-preview-items-table">
                        <thead>
                            <tr class="text-white-50">
                                <th style="width: 80px;" data-i18n="common.status">状态</th>
                                <th>SKU</th>
                                <th class="text-center" data-i18n="common.quantity">数量</th>
                                <th class="text-end"><span data-i18n="common.unit_price">单价</span> <span
                                        id="preview-currency-unit-price" class="text-info"></span>
                                </th>
                                <th class="text-end"><span data-i18n="common.subtotal">小计</span> <span
                                        id="preview-currency-subtotal" class="text-info"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="edit-preview-items-tbody">
                            <!-- JS动态生成 -->
                        </tbody>
                        <tfoot id="edit-preview-items-tfoot">
                            <tr class="text-success fw-bold border-top border-secondary">
                                <td colspan="4" class="text-end" data-i18n="js.total_label">合计:</td>
                                <td class="text-end" id="edit-preview-total">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3">
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="editWizardPrev(5)">
                <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.prev">上一步</span>
            </button>
            <button class="btn btn-success btn-lg px-4 rounded-pill" id="btn-edit-confirm"
                onclick="editConfirmModification()">
                <i class="fas fa-check me-2"></i><span data-i18n="modal.change_password.btn_confirm">确认修改</span>
            </button>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 流程6: 完成 -->
    <!-- ===================================== -->
    <div id="edit-step-6" class="wizard-step-content" style="display: none;">
        <div class="text-center py-5">
            <div class="bg-success bg-opacity-25 rounded-circle d-inline-flex p-4 mb-4">
                <i class="fas fa-check-circle fa-4x text-success"></i>
            </div>
            <h4 class="text-white mb-3" data-i18n="ui.text_683">订单修改成功！</h4>
            <p class="text-white-50 mb-4" id="edit-success-message" data-i18n="ui.text_684">
                订单已成功更新。
            </p>
            <div class="d-flex justify-content-end gap-3">
                <button class="btn btn-primary btn-lg px-4 rounded-pill" onclick="reloadAndEditOrder()">
                    <i class="fas fa-eye me-2"></i><span data-i18n="ui.icon_3223">继续查看/编辑</span>
                </button>
                <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="closeEditAndReload()">
                    <i class="fas fa-list me-2"></i><span data-i18n="common.back_list">返回列表</span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* 编辑表格样式 */
    #edit-items-table {
        table-layout: fixed;
    }

    #edit-items-table th:nth-child(1),
    #edit-items-table td:nth-child(1) {
        width: 25%;
    }

    /* SKU */

    #edit-items-table th:nth-child(2),
    #edit-items-table td:nth-child(2) {
        width: 10%;
    }

    /* 原数量 */

    #edit-items-table th:nth-child(3),
    #edit-items-table td:nth-child(3) {
        width: 12%;
    }

    /* 新数量 */

    #edit-items-table th:nth-child(4),
    #edit-items-table td:nth-child(4) {
        width: 12%;
    }

    /* 原单价 */

    #edit-items-table th:nth-child(5),
    #edit-items-table td:nth-child(5) {
        width: 14%;
    }

    /* 新单价 */

    #edit-items-table th:nth-child(6),
    #edit-items-table td:nth-child(6) {
        width: 15%;
    }

    /* 小计 */

    #edit-items-table th:nth-child(7),
    #edit-items-table td:nth-child(7) {
        width: 12%;
    }

    /* 操作 */

    /* [Fix] 输入框对齐优化 */
    #edit-items-table input {
        width: 100%;
        max-width: 100px;
    }

    #edit-items-table .edit-qty-input {
        text-align: center;
        margin: 0 auto;
        display: block;
    }

    #edit-items-table .edit-price-input {
        text-align: right;
        margin-left: auto;
        display: block;
    }

    #edit-items-table .new-row {
        background: rgba(25, 135, 84, 0.1);
    }

    #edit-items-table .deleted-row {
        background: rgba(220, 53, 69, 0.15);
        opacity: 0.8;
    }

    #edit-items-table .deleted-row td {
        color: #888 !important;
    }

    #edit-items-table .deleted-row .sku-text {
        color: #888;
    }

    #edit-items-table .deleted-row .deleted-tag {
        animation: deletedPulse 2s ease-in-out infinite;
    }

    @keyframes deletedPulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }
    }

    #edit-items-table .deleted-row input {
        background: rgba(220, 53, 69, 0.1) !important;
        color: #888 !important;
        border-color: rgba(220, 53, 69, 0.3) !important;
    }

    /* 恢复按钮保持可点击 */
    #edit-items-table .deleted-row button.btn-outline-success {
        opacity: 1;
        pointer-events: auto;
    }

    #edit-items-table .modified-row {
        background: rgba(255, 193, 7, 0.1);
    }

    /* 验证项样式 */
    .validation-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: rgba(0, 0, 0, 0.2);
    }

    .validation-item.valid {
        border-left: 3px solid #198754;
    }

    .validation-item.invalid {
        border-left: 3px solid #dc3545;
    }

    .validation-item .icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }

    .validation-item.valid .icon {
        background: rgba(25, 135, 84, 0.2);
        color: #198754;
    }

    .validation-item.invalid .icon {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    /* 验证卡片状态样式 */
    .state-normal {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(13, 202, 240, 0.25);
    }

    .state-normal .card-header {
        background: rgba(13, 202, 240, 0.1);
    }

    .state-error {
        background: rgba(220, 53, 69, 0.1);
        border: 2px solid var(--bs-danger);
        animation: errorPulse 1.5s ease-in-out infinite;
    }

    .state-error .card-header {
        background: rgba(220, 53, 69, 0.2);
    }

    .state-success {
        background: rgba(25, 135, 84, 0.1);
        border: 2px solid var(--bs-success);
    }

    .state-success .card-header {
        background: rgba(25, 135, 84, 0.2);
    }

    @keyframes errorPulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }

        50% {
            box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3);
        }
    }
</style>

<script>
    // ========================================
    // 编辑向导状态
    // ========================================
    let editPoWizard = null;  // GlobalWizard实例
    let editCurrentPoNum = null;
    let editOriginalData = null;
    let editCurrentStep = 1;
    let editStrategyModified = false;
    let editItemsModified = false;
    let editModifiedItems = [];
    let editSkuList = [];
    let editCollectedStrategy = null;  // 保存流程1收集的策略数据，用于流程2验证

    // 初始化GlobalWizard (仅用于渲染步骤条UI，不自动管理内容显示)
    let _stepUpdateInProgress = false;  // 防止无限递归

    function initEditWizard() {
        if (editPoWizard) {
            editPoWizard.destroy();
        }

        editPoWizard = new GlobalWizard({
            containerId: 'edit-wizard-container',
            steps: [
                { id: 'strategy', label: (window.i18n?.t('js.modify_strategy') || 'Modify Strategy'), contentSelector: '#edit-step-1' },
                { id: 'verify_strategy', label: (window.i18n?.t('js.verify_strategy') || 'Verify Strategy'), contentSelector: '#edit-step-2' },
                { id: 'items', label: (window.i18n?.t('js.modify_details') || 'Modify Details'), contentSelector: '#edit-step-3' },
                { id: 'verify_items', label: (window.i18n?.t('js.verify_products') || 'Verify Products'), contentSelector: '#edit-step-4' },
                { id: 'preview', label: (window.i18n?.t('js.modify_preview') || 'Modify Preview'), contentSelector: '#edit-step-5' },
                { id: 'done', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#edit-step-6' }
            ],
            onStepChange: (from, to) => {
                // 防止无限递归：如果已经在更新中，直接返回
                if (_stepUpdateInProgress) return;

                editCurrentStep = to + 1;
                // 只更新DOM显示，不调用showEditStep（避免循环）
                for (let i = 1; i <= 6; i++) {
                    const el = document.getElementById(`edit-step-${i}`);
                    if (el) el.style.display = 'none';
                }
                const target = document.getElementById(`edit-step-${to + 1}`);
                if (target) target.style.display = 'block';
            },
            onBeforeNext: async (step, index) => {
                return true; // 验证逻辑在按钮点击时处理
            },
            onComplete: (data) => {
            },
            onRestart: () => {
                showEditStep(1);
            }
        });
    }

    // 手动显示指定步骤
    function showEditStep(stepNum) {
        // 隐藏所有步骤
        for (let i = 1; i <= 6; i++) {
            const el = document.getElementById(`edit-step-${i}`);
            if (el) el.style.display = 'none';
        }
        // 显示目标步骤
        const target = document.getElementById(`edit-step-${stepNum}`);
        if (target) target.style.display = 'block';

        editCurrentStep = stepNum;

        // 更新步骤条状态（使用标志位防止无限递归）
        if (editPoWizard) {
            _stepUpdateInProgress = true;
            editPoWizard.goToStep(stepNum - 1);
            _stepUpdateInProgress = false;
        }
    }

    // 加载订单数据进行编辑
    function loadOrderForEdit(poNum) {
        editCurrentPoNum = poNum;
        editCurrentStep = 1;
        editStrategyModified = false;
        editItemsModified = false;
        editModifiedItems = [];

        // 重置跳过状态
        skipStrategyUsed = false;
        skipItemsUsed = false;
        updateSkipButtonsState();

        document.getElementById('edit-po-num-label').textContent = `订单号: ${poNum}`;
        document.getElementById('edit-loading').style.display = 'block';

        // 隐藏所有步骤
        document.querySelectorAll('.wizard-step-content').forEach(el => {
            el.style.display = 'none';
        });
        document.getElementById('edit-loading').style.display = 'block';

        // 并行加载订单数据和SKU列表
        Promise.all([
            fetch(`{% url 'web_ui:purchase:po_mgmt_edit_data' %}?po_num=${encodeURIComponent(poNum)}`).then(r => r.json()),
            fetch(`{% url 'web_ui:purchase:po_mgmt_sku_list' %}`).then(r => r.json())
        ]).then(([orderRes, skuRes]) => {
            document.getElementById('edit-loading').style.display = 'none';

            if (!orderRes.success) {
                alert(orderRes.message || '{% trans "加载订单数据失败" %}');
                showListView();
                return;
            }

            editOriginalData = orderRes.data;
            editSkuList = skuRes.success ? skuRes.data : [];
            // 初始化GlobalWizard
            initEditWizard();

            // 填充策略数据 (使用50/50布局)
            renderStrategyWithEdit(editOriginalData.strategy);

            // 填充商品列表
            populateItemsTable(editOriginalData.items);

            // 显示当前版本
            document.getElementById('edit-current-strategy-seq').textContent = editOriginalData.current_strategy_seq || 'V01';
            document.getElementById('edit-current-detail-seq').textContent = editOriginalData.current_detail_seq || 'L01';

            // [Fix] 更新流程3表头的货币标签
            const currencyLabel = editOriginalData.strategy?.currency || 'RMB';
            document.querySelectorAll('.edit-currency-label').forEach(el => {
                el.textContent = currencyLabel;
            });

            // 显示第一步
            document.getElementById('edit-step-1').style.display = 'block';
        }).catch(err => {
            document.getElementById('edit-loading').style.display = 'none';
            alert('{% trans "加载失败: " %}' + err);
            showListView();
        });
    }

    // 渲染策略显示 (50/50布局，左侧原值，右侧可编辑)
    function renderStrategyWithEdit(s) {
        if (!s) s = {};

        const grid = document.getElementById('edit-strategy-display-grid');
        const rate = s.exchange_rate || '-';

        // 50/50 分栏的名片布局
        grid.innerHTML = `
            <!-- 结算货币 -->
            <div class="col-6"><div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                <div class="text-white-50 small mb-2" data-i18n="js.settlement_currency">结算货币</div>
                <div class="row g-0">
                    <div class="col-6 pe-2 border-end border-secondary">
                        <span class="text-info fw-bold">${s.currency || 'RMB'}</span>
                        <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                    </div>
                    <div class="col-6 ps-2">
                        <div class="btn-group btn-group-sm w-100" role="group">
                            <input type="radio" class="btn-check" name="edit_currency" id="edit_curr_rmb" value="RMB" ${s.currency === 'RMB' ? 'checked' : ''}>
                            <label class="btn btn-outline-warning btn-sm py-0" for="edit_curr_rmb">RMB</label>
                            <input type="radio" class="btn-check" name="edit_currency" id="edit_curr_usd" value="USD" ${s.currency === 'USD' ? 'checked' : ''}>
                            <label class="btn btn-outline-warning btn-sm py-0" for="edit_curr_usd">USD</label>
                        </div>
                    </div>
                </div>
            </div></div>
            
            <!-- 结算汇率 (使用 GlobalExchangeRate 组件) -->
            <div class="col-6"><div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                <div class="text-white-50 small mb-2" data-i18n="table.settlement_rate">结算汇率</div>
                <div class="row g-0">
                    <div class="col-6 pe-2 border-end border-secondary">
                        <span class="text-white fw-bold">${rate}</span>
                        <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                    </div>
                    <div class="col-6 ps-2">
                        <div id="edit-mgmt-exchange-rate-container"></div>
                        <input type="hidden" id="edit_exchange_rate" value="${s.exchange_rate || ''}">
                        <input type="hidden" id="edit_exchange_rate_mode" value="M">
                    </div>
                </div>
            </div></div>
            
            <!-- 价格浮动 -->
            <div class="col-6"><div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                <div class="text-white-50 small mb-2" data-i18n="purchase.price_float">价格浮动</div>
                <div class="row g-0">
                    <div class="col-6 pe-2 border-end border-secondary">
                        <span class="${s.float_enabled ? 'text-success' : 'text-secondary'}" data-i18n="ui.text_685">${s.float_enabled ? (window.i18n?.t('js.yes') || 'Yes') : (window.i18n?.t('js.no') || 'No')}</span>
                        <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                    </div>
                    <div class="col-6 ps-2">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="edit_float_enabled" ${s.float_enabled ? 'checked' : ''}>
                            <label class="form-check-label text-warning small" for="edit_float_enabled" data-i18n="ui.text_686">启用</label>
                        </div>
                    </div>
                </div>
            </div></div>
            
            <!-- 浮动阈值 -->
            <div class="col-6"><div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                <div class="text-white-50 small mb-2" data-i18n="js.float_threshold">浮动阈值</div>
                <div class="row g-0">
                    <div class="col-6 pe-2 border-end border-secondary">
                        <span class="text-white fw-bold">${s.float_threshold || 0}%</span>
                        <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                    </div>
                    <div class="col-6 ps-2">
                        <div class="d-flex align-items-center gap-1">
                            <input type="range" class="form-range flex-grow-1" min="0" max="10" step="0.1" style="width: 60%;"
                                   id="edit_float_range" value="${s.float_threshold || 0}" ${!s.float_enabled ? 'disabled' : ''}>
                            <span class="text-warning small" id="edit_float_display">${s.float_threshold || 0}%</span>
                        </div>
                    </div>
                </div>
            </div></div>
            
            <!-- 定金要求 -->
            <div class="col-6"><div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                <div class="text-white-50 small mb-2" data-i18n="purchase.deposit_req">定金要求</div>
                <div class="row g-0">
                    <div class="col-6 pe-2 border-end border-secondary">
                        <span class="${s.deposit_enabled ? 'text-success' : 'text-secondary'}" data-i18n="ui.text_687">${s.deposit_enabled ? (window.i18n?.t('js.yes') || 'Yes') : (window.i18n?.t('js.no') || 'No')}</span>
                        <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                    </div>
                    <div class="col-6 ps-2">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="edit_deposit_enabled" ${s.deposit_enabled ? 'checked' : ''}>
                            <label class="form-check-label text-warning small" for="edit_deposit_enabled" data-i18n="ui.text_686">启用</label>
                        </div>
                    </div>
                </div>
            </div></div>
            
            <!-- 定金比例 -->
            <div class="col-6"><div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
                <div class="text-white-50 small mb-2" data-i18n="table.deposit_rate">定金比例</div>
                <div class="row g-0">
                    <div class="col-6 pe-2 border-end border-secondary">
                        <span class="text-white fw-bold">${s.deposit_par || 0}%</span>
                        <div class="text-white-50" style="font-size: 0.6rem;" data-i18n="ui.text_654">原策略</div>
                    </div>
                    <div class="col-6 ps-2">
                        <div class="d-flex align-items-center gap-1">
                            <input type="range" class="form-range flex-grow-1" min="0" max="100" step="1" style="width: 60%;"
                                   id="edit_deposit_range" value="${s.deposit_par || 0}" ${!s.deposit_enabled ? 'disabled' : ''}>
                            <span class="text-warning small" id="edit_deposit_display">${s.deposit_par || 0}%</span>
                        </div>
                    </div>
                </div>
            </div></div>
        `;

        // 设置原备注（仅显示），输入框保持为空
        document.getElementById('edit-orig-note').textContent = s.note || '-';
        document.getElementById('edit-new-note').value = '';  // 输入框留空，用户必须输入新的备注

        // 绑定编辑事件
        bindStrategyEditControls();

        // 初始化汇率组件
        initEditMgmtExchangeRateComponent(s.exchange_rate);
    }

    // 绑定策略编辑控件事件
    function bindStrategyEditControls() {
        // 浮动阈值滑块
        const floatRange = document.getElementById('edit_float_range');
        const floatDisplay = document.getElementById('edit_float_display');
        floatRange?.addEventListener('input', () => {
            floatDisplay.textContent = floatRange.value + '%';
        });

        // 定金比例滑块
        const depositRange = document.getElementById('edit_deposit_range');
        const depositDisplay = document.getElementById('edit_deposit_display');
        depositRange?.addEventListener('input', () => {
            depositDisplay.textContent = depositRange.value + '%';
        });

        // 浮动开关
        const floatToggle = document.getElementById('edit_float_enabled');
        floatToggle?.addEventListener('change', () => {
            floatRange.disabled = !floatToggle.checked;
        });

        // 定金开关
        const depositToggle = document.getElementById('edit_deposit_enabled');
        depositToggle?.addEventListener('change', () => {
            depositRange.disabled = !depositToggle.checked;
        });
    }

    // 编辑汇率组件实例
    let editMgmtRateComponent = null;

    // 初始化订单管理编辑汇率组件
    function initEditMgmtExchangeRateComponent(initialRate) {
        const container = document.getElementById('edit-mgmt-exchange-rate-container');
        if (!container || typeof GlobalExchangeRate === 'undefined') {
            console.warn('[PO Edit] GlobalExchangeRate not available or container not found');
            return;
        }

        // 销毁旧实例
        if (editMgmtRateComponent) {
            editMgmtRateComponent.destroy && editMgmtRateComponent.destroy();
            editMgmtRateComponent = null;
        }

        // 获取订单日期
        const getPoDate = () => {
            return editOriginalData?.order_date || new Date().toISOString().split('T')[0];
        };

        // 初始化组件
        editMgmtRateComponent = new GlobalExchangeRate({
            inputId: 'edit-mgmt-rate-input',
            container: '#edit-mgmt-exchange-rate-container',
            apiUrl: '/dashboard/purchase/api/po/exchange-rate/',
            defaultRate: initialRate || 7.25,
            placeholder: (window.i18n?.t('js.new_value') || 'New Value'),
            showStatusText: false,
            getDateFn: getPoDate,
            onChange: (rate, source) => {
                const hiddenRate = document.getElementById('edit_exchange_rate');
                const hiddenMode = document.getElementById('edit_exchange_rate_mode');
                if (hiddenRate) hiddenRate.value = rate || '';
                if (hiddenMode) hiddenMode.value = source === 'A' ? 'A' : 'M';
            }
        });
    }

    // 获取编辑汇率值
    function getEditMgmtExchangeRate() {
        if (editMgmtRateComponent) {
            return editMgmtRateComponent.getRate() || 0;  // 使用 getRate()
        }
        return parseFloat(document.getElementById('edit_exchange_rate')?.value) || 0;
    }

    // 获取编辑汇率模式
    function getEditMgmtExchangeRateMode() {
        if (editMgmtRateComponent) {
            return editMgmtRateComponent.getSource() || 'M';  // 使用 getSource()
        }
        return document.getElementById('edit_exchange_rate_mode')?.value || 'M';
    }

    // 填充商品列表
    function populateItemsTable(items) {
        const tbody = document.getElementById('edit-items-tbody');
        tbody.innerHTML = '';

        (items || []).forEach((item, idx) => {
            const subtotal = item.qty * item.unit_price;
            const tr = document.createElement('tr');
            tr.dataset.sku = item.sku;
            tr.dataset.originalQty = item.original_qty || item.qty;
            tr.dataset.originalPrice = item.original_price || item.unit_price;
            tr.dataset.isNew = 'false';
            tr.dataset.wasDeleted = item.is_deleted ? 'true' : 'false';  // 标记是否已被删除

            // 如果商品已被删除，使用不同的样式
            if (item.is_deleted) {
                tr.classList.add('deleted-row');
                tr.innerHTML = `
                    <td class="font-monospace sku-cell">
                        <span class="sku-text text-decoration-line-through text-white-50">${item.sku}</span>
                        <span class="badge bg-secondary ms-2" data-i18n="ui.text_689">历史删除</span>
                    </td>
                    <td class="text-center text-white-50">${item.original_qty || item.qty}</td>
                    <td class="text-center text-white-50">${item.qty}</td>
                    <td class="text-end text-white-50">${(item.original_price || item.unit_price).toFixed(2)}</td>
                    <td class="text-end text-white-50">${item.unit_price.toFixed(2)}</td>
                    <td class="text-end text-white-50">-</td>
                    <td class="text-center">
                        <button class="btn btn-outline-success btn-sm" onclick="editRestoreItem(this)" data-i18n-title="tooltip.t6291" title="Restore Item">
                            <i class="fas fa-undo"></i>
                        </button>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td class="font-monospace sku-cell">
                        <span class="sku-text">${item.sku}</span>
                        <span class="badge bg-danger ms-2 deleted-tag" style="display: none;" data-i18n="common.deleted">已删除</span>
                    </td>
                    <td class="text-center text-white-50">${item.original_qty || item.qty}</td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white text-center edit-qty-input" 
                               value="${item.qty}" min="1" onchange="onItemChange(this)">
                    </td>
                    <td class="text-end text-white-50">${(item.original_price || item.unit_price).toFixed(2)}</td>
                    <td class="text-end">
                        <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white text-end edit-price-input" 
                               value="${item.unit_price}" step="0.01" min="0.01" onchange="onItemChange(this)">
                    </td>
                    <td class="text-end text-success item-subtotal">${subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="editDeleteItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            }

            tbody.appendChild(tr);
        });

        updateItemsTotal();
    }

    // 商品变更处理
    function onItemChange(input) {
        const tr = input.closest('tr');
        const qtyInput = tr.querySelector('.edit-qty-input');
        const priceInput = tr.querySelector('.edit-price-input');
        const subtotalCell = tr.querySelector('.item-subtotal');

        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const subtotal = qty * price;

        subtotalCell.textContent = subtotal.toFixed(2);

        // 检查是否有修改
        const origQty = parseFloat(tr.dataset.originalQty);
        const origPrice = parseFloat(tr.dataset.originalPrice);

        if (qty !== origQty || price !== origPrice) {
            tr.classList.add('modified-row');
        } else {
            tr.classList.remove('modified-row');
        }

        updateItemsTotal();
    }

    // 更新总计
    function updateItemsTotal() {
        const tbody = document.getElementById('edit-items-tbody');
        const rows = tbody.querySelectorAll('tr:not(.deleted-row)');
        let total = 0;

        rows.forEach(tr => {
            const subtotalCell = tr.querySelector('.item-subtotal');
            if (subtotalCell) {
                // 提取纯数字部分（可能带货币前缀）
                const text = subtotalCell.textContent.replace(/[^0-9.-]/g, '');
                total += parseFloat(text) || 0;
            }
        });

        // [Fix] 显示带货币前缀的总计
        const currency = editOriginalData?.strategy?.currency || 'RMB';
        document.getElementById('edit-items-total').textContent = `${currency} ${total.toFixed(2)}`;
    }

    // 新增SKU
    function editAddNewSku() {
        const tbody = document.getElementById('edit-items-tbody');
        const tr = document.createElement('tr');
        tr.classList.add('new-row');
        tr.dataset.isNew = 'true';

        // 生成SKU下拉选项
        const skuOptions = editSkuList.map(sku => `<option value="${sku}">${sku}</option>`).join('');

        tr.innerHTML = `
            <td>
                <select class="form-select form-select-sm bg-dark border-secondary text-white edit-sku-select">
                    <option value="" data-i18n="option.o5261">选择SKU...</option>
                    ${skuOptions}
                </select>
            </td>
            <td class="text-center text-white-50">-</td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white text-center edit-qty-input" 
                       value="1" min="1" onchange="onItemChange(this)">
            </td>
            <td class="text-end text-white-50">-</td>
            <td class="text-end">
                <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white text-end edit-price-input" 
                       value="0" step="0.01" min="0.01" onchange="onItemChange(this)">
            </td>
            <td class="text-end text-success item-subtotal">0.00</td>
            <td class="text-center">
                <button class="btn btn-outline-danger btn-sm" onclick="editDeleteItem(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    // 删除商品
    function editDeleteItem(btn) {
        const tr = btn.closest('tr');
        const isNew = tr.dataset.isNew === 'true';
        const sku = tr.dataset.sku;
        if (isNew) {
            // 新增的行直接删除
            tr.remove();
            updateItemsTotal();
            return;
        }

        // 定义删除操作
        const doDelete = () => {
            // 添加删除样式
            tr.classList.add('deleted-row');
            tr.querySelectorAll('input').forEach(i => i.disabled = true);

            // 更新SKU单元格，显示删除标签
            const skuCell = tr.querySelector('td:first-child');
            skuCell.innerHTML = `
                <span class="sku-text text-muted">${sku}</span>
                <span class="badge bg-danger ms-2" data-i18n="common.deleted">已删除</span>
            `;

            // 更新按钮为恢复按钮
            btn.innerHTML = '<i class="fas fa-undo"></i>';
            btn.className = 'btn btn-outline-success btn-sm';
            btn.setAttribute('onclick', '');
            btn.onclick = function () { editRestoreItem(this); };

            updateItemsTotal();
        };

        // 使用GlobalModal.showCustom实现确认对话框
        const confirmHtml = `
            <div class="modal-header border-0">
                <h5 class="modal-title text-white">
                    <i class="fas fa-question-circle me-2 text-danger"></i>
                    确认删除
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-trash-alt fa-3x text-danger"></i>
                </div>
                <p class="text-white mb-0">${(window.i18n?.t('desc.d174') || 'Are you sure you want to delete product')} <strong>${sku}</strong>${(window.i18n?.t('desc.d175') || '?')}</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary px-4" id="modal-btn-cancel">
                    <i class="fas fa-times me-2"></i>取消
                </button>
                <button type="button" class="btn btn-danger px-4" id="modal-btn-confirm-delete">
                    <i class="fas fa-trash me-2"></i>删除
                </button>
            </div>
        `;

        GlobalModal.showCustom({
            html: confirmHtml,
            borderColor: '#dc3545',
            glowEffect: 'none'
        });

        // 绑定确认删除按钮
        setTimeout(() => {
            const confirmBtn = document.getElementById('modal-btn-confirm-delete');
            const cancelBtn = document.getElementById('modal-btn-cancel');

            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    GlobalModal.hide();
                    doDelete();
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    GlobalModal.hide();
                });
            }
        }, 100);
    }

    // 恢复删除的商品
    function editRestoreItem(btn) {
        const tr = btn.closest('tr');
        const sku = tr.dataset.sku;
        const wasDeleted = tr.dataset.wasDeleted === 'true';  // 是否是加载时就是删除状态的

        // 移除删除样式
        tr.classList.remove('deleted-row');

        // 如果是历史删除的行，需要重建完整的输入控件
        if (wasDeleted) {
            const originalQty = parseFloat(tr.dataset.originalQty) || 1;
            const originalPrice = parseFloat(tr.dataset.originalPrice) || 0;

            tr.innerHTML = `
                <td class="font-monospace sku-cell">
                    <span class="sku-text">${sku}</span>
                    <span class="badge bg-success ms-2" data-i18n="ui.text_692">已恢复</span>
                </td>
                <td class="text-center text-white-50">${originalQty}</td>
                <td class="text-center">
                    <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white text-center edit-qty-input" 
                           value="${originalQty}" min="1" onchange="onItemChange(this)">
                </td>
                <td class="text-end text-white-50">${originalPrice.toFixed(2)}</td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white text-end edit-price-input" 
                           value="${originalPrice}" step="0.01" min="0.01" onchange="onItemChange(this)">
                </td>
                <td class="text-end text-success item-subtotal">${(originalQty * originalPrice).toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-outline-danger btn-sm" onclick="editDeleteItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tr.dataset.wasDeleted = 'false';  // 标记为已恢复
        } else {
            // 原有逻辑：只是取消本次编辑中的删除标记
            tr.querySelectorAll('input').forEach(i => i.disabled = false);

            // 恢复SKU单元格，移除删除标签
            const skuCell = tr.querySelector('td:first-child');
            skuCell.innerHTML = `
                <span class="sku-text">${sku}</span>
                <span class="badge bg-danger ms-2 deleted-tag" style="display: none;" data-i18n="common.deleted">已删除</span>
            `;

            // 更新按钮为删除按钮
            btn.innerHTML = '<i class="fas fa-trash"></i>';
            btn.className = 'btn btn-outline-danger btn-sm';
            btn.setAttribute('onclick', '');  // 清除旧的onclick
            btn.onclick = function () { editDeleteItem(this); };
        }

        updateItemsTotal();
    }


    // 向导导航函数
    function editWizardNext(currentStep) {
        if (currentStep === 1) {
            // 关键：在步骤1可见时收集数据并填充验证页面
            // 此时edit-step-1还是display:block，DOM元素可访问
            collectAndRenderVerifyStep();
            editStrategyModified = checkStrategyModifiedFromCollected();
            showEditStep(2);
            // 验证逻辑现在在collectAndRenderVerifyStep中执行
        } else if (currentStep === 2) {
            showEditStep(3);
        } else if (currentStep === 3) {
            // 关键：在步骤3可见时收集数据并填充验证页面
            collectAndRenderItemsVerifyStep();
            showEditStep(4);
            // 验证逻辑现在在collectAndRenderItemsVerifyStep中执行
        } else if (currentStep === 4) {
            showEditStep(5);
            updatePreview();
        }
    }

    // 收集数据并渲染验证步骤（模仿po_wizard.js的renderVerifyParamsStep）
    function collectAndRenderVerifyStep() {
        // 1. 收集流程1的输入值（此时流程1还可见）
        const currencyEl = document.querySelector('input[name="edit_currency"]:checked');
        const floatEnabledEl = document.getElementById('edit_float_enabled');
        const floatRangeEl = document.getElementById('edit_float_range');
        const depositEnabledEl = document.getElementById('edit_deposit_enabled');
        const depositRangeEl = document.getElementById('edit_deposit_range');
        const noteEl = document.getElementById('edit-new-note');
        editCollectedStrategy = {
            currency: currencyEl?.value || 'RMB',
            exchange_rate: getEditMgmtExchangeRate() || 0,  // 使用组件函数获取汇率
            cur_mode: getEditMgmtExchangeRateMode(),  // 汇率获取方式
            float_enabled: floatEnabledEl?.checked || false,
            float_threshold: parseFloat(floatRangeEl?.value) || 0,
            deposit_enabled: depositEnabledEl?.checked || false,
            deposit_par: parseFloat(depositRangeEl?.value) || 0,
            note: (noteEl?.value || '').trim()
        };
        // 2. 填充验证页面的名片
        const orig = editOriginalData?.strategy || {};
        const origNote = (orig.note || '').trim();
        const collected = editCollectedStrategy;

        document.getElementById('edit-verify-currency').textContent = collected.currency;
        document.getElementById('edit-verify-rate').textContent = collected.exchange_rate > 0 ? collected.exchange_rate.toFixed(4) : '-';
        document.getElementById('edit-verify-float').innerHTML = collected.float_enabled
            ? '<span class="text-success" data-i18n="ui.text_694">是</span>'
            : '<span class="text-secondary" data-i18n="ui.text_695">否</span>';
        document.getElementById('edit-verify-float-threshold').textContent = collected.float_threshold + '%';
        document.getElementById('edit-verify-deposit').innerHTML = collected.deposit_enabled
            ? '<span class="text-success" data-i18n="ui.text_696">是</span>'
            : '<span class="text-secondary" data-i18n="ui.text_697">否</span>';
        document.getElementById('edit-verify-deposit-par').textContent = collected.deposit_par + '%';
        document.getElementById('edit-verify-note').textContent = collected.note || (window.i18n?.t('js.not_filled') || '(Not filled)');

        // 3. 检查是否有实际修改（除备注外）
        const hasStrategyChange = (
            collected.currency !== (orig.currency || 'RMB') ||
            Math.abs((collected.exchange_rate || 0) - (orig.exchange_rate || 0)) > 0.0001 ||
            collected.float_enabled !== (orig.float_enabled || false) ||
            Math.abs((collected.float_threshold || 0) - (orig.float_threshold || 0)) > 0.01 ||
            collected.deposit_enabled !== (orig.deposit_enabled || false) ||
            Math.abs((collected.deposit_par || 0) - (orig.deposit_par || 0)) > 0.1
        );
        // 4. 执行验证逻辑
        const errors = [];

        // 首先检查是否有修改
        if (!hasStrategyChange) {
            errors.push('除备注外，策略参数没有任何修改。如无需修改策略，请点击"跳过策略修改"');
        }

        // 汇率验证
        const rateCell = document.getElementById('edit-verify-cell-rate');
        if (collected.exchange_rate <= 0) {
            errors.push((window.i18n?.t('js.rate_must_positive') || 'Rate must be > 0'));
            rateCell?.classList.add('border', 'border-danger');
        } else {
            rateCell?.classList.remove('border', 'border-danger');
        }

        // 浮动阈值验证
        const floatCell = document.getElementById('edit-verify-cell-float-threshold');
        if (collected.float_enabled && collected.float_threshold <= 0) {
            errors.push((window.i18n?.t('js.float_threshold_required') || 'Float enabled, threshold required'));
            floatCell?.classList.add('border', 'border-danger');
        } else {
            floatCell?.classList.remove('border', 'border-danger');
        }

        // 定金比例验证
        const depositCell = document.getElementById('edit-verify-cell-deposit-par');
        if (collected.deposit_enabled && (collected.deposit_par <= 0 || collected.deposit_par > 100)) {
            errors.push((window.i18n?.t('js.deposit_ratio_range') || 'Deposit enabled, ratio 1-100'));
            depositCell?.classList.add('border', 'border-danger');
        } else {
            depositCell?.classList.remove('border', 'border-danger');
        }

        // 备注验证（必填，且不能与原备注相同）
        const noteCell = document.getElementById('edit-verify-cell-note');
        const noteDisplay = document.getElementById('edit-verify-note');
        if (collected.note.length === 0) {
            errors.push((window.i18n?.t('js.edit_notes_required') || 'Edit notes required'));
            noteCell?.classList.remove('border-warning', 'border-opacity-50');
            noteCell?.classList.add('border', 'border-danger');
            noteDisplay?.classList.remove('text-warning');
            noteDisplay?.classList.add('text-danger');
        } else if (collected.note === origNote) {
            errors.push((window.i18n?.t('js.edit_notes_different') || 'Edit notes must differ'));
            noteCell?.classList.remove('border-warning', 'border-opacity-50');
            noteCell?.classList.add('border', 'border-danger');
            noteDisplay?.classList.remove('text-warning');
            noteDisplay?.classList.add('text-danger');
        } else {
            noteCell?.classList.remove('border-danger');
            noteCell?.classList.add('border', 'border-warning', 'border-opacity-50');
            noteDisplay?.classList.remove('text-danger');
            noteDisplay?.classList.add('text-warning');
        }

        // 4. 更新错误容器和卡片状态
        const errorsContainer = document.getElementById('edit-params-errors-container');
        const errorsList = document.getElementById('edit-params-errors-list');
        const card = document.getElementById('edit-params-validation-card');
        const icon = document.getElementById('edit-params-validation-icon');
        const title = document.getElementById('edit-params-validation-title');

        if (errors.length > 0) {
            errorsContainer.style.display = 'block';
            errorsList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
            card?.classList.remove('state-normal', 'state-success');
            card?.classList.add('state-error');
            icon.className = 'fa-solid fa-times-circle me-2 text-danger';
            title.className = 'text-danger';
            title.textContent = (window.i18n?.t('js.strategy_validation_failed') || 'Strategy validation failed');
            document.getElementById('btn-edit-step2-next').disabled = true;
        } else {
            errorsContainer.style.display = 'none';
            errorsList.innerHTML = '';
            card?.classList.remove('state-normal', 'state-error');
            card?.classList.add('state-success');
            icon.className = 'fa-solid fa-check-circle me-2 text-success';
            title.className = 'text-success';
            title.textContent = (window.i18n?.t('js.strategy_validation_passed') || 'Strategy validation passed');
            document.getElementById('btn-edit-step2-next').disabled = false;
        }
    }

    // 保存明细修改备注
    let editItemsNote = '';

    // 保存合并详情（用于在流程4/5显示）
    let editMergeDetails = [];

    // 收集商品数据并渲染验证步骤（模仿流程2的方式）
    function collectAndRenderItemsVerifyStep() {
        // 1. 收集流程3的商品修改（此时流程3还可见）
        editModifiedItems = collectModifiedItems();
        editItemsModified = editModifiedItems.length > 0;

        // 2. 收集备注
        editItemsNote = (document.getElementById('edit-items-note')?.value || '').trim();
        // =============================================
        // 对所有操作(add/adjust/delete)进行SKU+单价去重合并
        // =============================================
        editMergeDetails = [];

        // 按action分组处理
        const actionGroups = { add: [], adjust: [], delete: [] };
        editModifiedItems.forEach(item => {
            if (actionGroups[item.action]) {
                actionGroups[item.action].push(item);
            }
        });

        const mergedItems = [];

        // 对每种action分别进行合并
        ['add', 'adjust', 'delete'].forEach(actionType => {
            const items = actionGroups[actionType];
            if (items.length === 0) return;

            const mergeMap = new Map(); // key: "SKU|unit_price" => merged item

            items.forEach(item => {
                const key = `${item.sku}|${item.unit_price}`;
                if (mergeMap.has(key)) {
                    const existing = mergeMap.get(key);
                    existing.rows.push({ qty: item.qty });
                    existing.qty += item.qty;
                } else {
                    mergeMap.set(key, {
                        sku: item.sku,
                        qty: item.qty,
                        unit_price: item.unit_price,
                        action: actionType,
                        original_qty: item.original_qty,  // 保留原始数据（用于adjust/delete）
                        original_price: item.original_price,
                        rows: [{ qty: item.qty }]
                    });
                }
            });

            // 收集合并结果
            mergeMap.forEach(value => {
                mergedItems.push({
                    sku: value.sku,
                    qty: value.qty,
                    unit_price: value.unit_price,
                    action: value.action,
                    original_qty: value.original_qty,
                    original_price: value.original_price
                });

                // 如果有多行被合并，记录详情
                if (value.rows.length > 1) {
                    editMergeDetails.push({
                        sku: value.sku,
                        unit_price: value.unit_price,
                        action: actionType,
                        rows: value.rows,
                        totalQty: value.qty
                    });
                }
            });
        });

        editModifiedItems = mergedItems;

        if (editMergeDetails.length > 0) {
        }
        // 3. 填充验证页面
        const container = document.getElementById('edit-items-validation-list');
        container.innerHTML = '';

        let allValid = true;
        let errors = [];

        // 验证备注
        if (!editItemsNote) {
            allValid = false;
            errors.push((window.i18n?.t('js.edit_notes_required') || 'Edit notes required'));
        } else if (editItemsNote === (window.i18n?.t('js.original_order') || 'Original Order')) {
            allValid = false;
            errors.push((window.i18n?.t('desc.d180') || 'Notes cannot be "Original Order"'));
        }

        // 显示备注验证结果
        if (editItemsNote) {
            const noteValid = editItemsNote !== (window.i18n?.t('js.original_order') || 'Original Order');
            if (!noteValid) allValid = false;

            container.innerHTML += `
                <div class="validation-item ${noteValid ? 'valid' : 'invalid'}">
                    <div class="icon"><i class="fas fa-${noteValid ? 'check' : 'times'}"></i></div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <span class="text-white" data-i18n="common.modify_note">修改备注</span>
                            <span class="badge bg-info" data-i18n="common.required">必填</span>
                        </div>
                        <div class="text-white-50 small">${noteValid ? editItemsNote : (window.i18n?.t('desc.d180') || 'Notes cannot be "Original Order"')}</div>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML += `
                <div class="validation-item invalid">
                    <div class="icon"><i class="fas fa-times"></i></div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <span class="text-white" data-i18n="common.modify_note">修改备注</span>
                            <span class="badge bg-danger" data-i18n="ui.text_701">缺失</span>
                        </div>
                        <div class="text-danger small" data-i18n="ui.text_2244">请返回填写修改备注</div>
                    </div>
                </div>
            `;
        }

        // 验证每个商品
        editModifiedItems.forEach(item => {
            let valid = true;
            let message = '';

            if (item.action === 'delete') {
                message = (window.i18n?.t('js.will_be_deleted') || 'Will be deleted');
            } else {
                if (!item.sku) {
                    valid = false;
                    message = (window.i18n?.t('js.sku_required') || 'SKU required');
                } else if (item.qty <= 0) {
                    valid = false;
                    message = (window.i18n?.t('js.qty_must_positive') || 'Qty must be > 0');
                } else if (item.unit_price <= 0) {
                    valid = false;
                    message = (window.i18n?.t('js.price_must_positive') || 'Price must be > 0');
                } else {
                    message = `数量: ${item.qty}, 单价: ${item.unit_price.toFixed(2)} `;
                }
            }

            if (!valid) allValid = false;

            const actionLabel = { add: (window.i18n?.t('js.create') || 'Create'), adjust: (window.i18n?.t('js.modify') || 'Modify'), delete: (window.i18n?.t('js.delete') || 'Delete') }[item.action];
            const actionColor = { add: 'success', adjust: 'warning', delete: 'danger' }[item.action];

            container.innerHTML += `
                <div class="validation-item ${valid ? 'valid' : 'invalid'}">
                    <div class="icon"><i class="fas fa-${valid ? 'check' : 'times'}"></i></div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <span class="text-white">${item.sku || (window.i18n?.t('js.not_selected') || '(Not selected)')}</span>
                            <span class="badge bg-${actionColor}">${actionLabel}</span>
                        </div>
                        <div class="text-white-50 small">${message}</div>
                    </div>
                </div>
            `;
        });

        // 检查是否有修改
        if (editModifiedItems.length === 0) {
            container.innerHTML += `
                <div class="alert alert-warning bg-warning bg-opacity-10 border-warning text-warning mb-0 mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    没有任何商品修改。如无需修改商品明细，请点击跳过明细修改
                </div>
            `;
            allValid = false;  // 无修改时禁止下一步
        }

        // 显示SKU合并信息
        const mergeContainer = document.getElementById('edit-items-merge-container');
        const mergeList = document.getElementById('edit-items-merge-list');

        if (editMergeDetails.length > 0 && mergeContainer && mergeList) {
            const actionLabels = { add: (window.i18n?.t('js.create') || 'Create'), adjust: (window.i18n?.t('js.modify') || 'Modify'), delete: (window.i18n?.t('js.delete') || 'Delete') };
            let mergeHtml = editMergeDetails.map(detail => {
                const actionLabel = actionLabels[detail.action] || detail.action;
                const rowsList = detail.rows.map(r => `${r.qty} 件`).join(' + ');
                return `<li class="mb-2">
                    <span class="badge bg-${detail.action === 'add' ? 'success' : (detail.action === 'delete' ? 'danger' : 'warning')} me-2">${actionLabel}</span>
                    <strong class="text-warning">${detail.sku}</strong> 
                    <span class="text-white-50" data-i18n="ui.text_703">(单价 ${detail.unit_price})</span>
                    <br><small class="ps-5">
                        <i class="fas fa-arrow-right me-1 text-warning"></i>
                        ${rowsList} → 合并后 <strong class="text-success">${detail.totalQty}</strong> 件
                    </small>
                </li>`;
            }).join('');

            mergeList.innerHTML = mergeHtml;
            mergeContainer.style.display = 'block';
        } else if (mergeContainer) {
            mergeContainer.style.display = 'none';
        }

        document.getElementById('btn-edit-step4-next').disabled = !allValid;
    }

    function editWizardPrev(currentStep) {
        // 特殊处理：跳过验证步骤直接返回编辑步骤
        if (currentStep === 3) {
            // 流程3（明细修改）返回流程1（策略修改）
            showEditStep(1);
        } else if (currentStep === 5) {
            // 流程5（预览）返回流程3（明细修改）
            showEditStep(3);
        } else if (currentStep > 1) {
            showEditStep(currentStep - 1);
        }
    }

    // 跳过状态标记
    let skipStrategyUsed = false;
    let skipItemsUsed = false;

    // 更新跳过按钮状态
    function updateSkipButtonsState() {
        const btnSkipStrategy = document.getElementById('btn-skip-strategy');
        const btnSkipItems = document.getElementById('btn-skip-items');

        if (btnSkipStrategy) {
            if (skipItemsUsed) {
                btnSkipStrategy.disabled = true;
                btnSkipStrategy.title = (window.i18n?.t('js.cannot_skip_strategy') || 'Cannot skip strategy if detail skipped');
            } else {
                btnSkipStrategy.disabled = false;
                btnSkipStrategy.title = '';
            }
        }

        if (btnSkipItems) {
            if (skipStrategyUsed) {
                btnSkipItems.disabled = true;
                btnSkipItems.title = (window.i18n?.t('js.cannot_skip_detail') || 'Cannot skip detail if strategy skipped');
            } else {
                btnSkipItems.disabled = false;
                btnSkipItems.title = '';
            }
        }
    }

    // 跳过策略修改
    function editWizardSkipStrategy() {
        // 检查是否已经跳过了明细
        if (skipItemsUsed) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.cannot_skip') || 'Cannot Skip'),
                message: (window.i18n?.t('js.cannot_skip_both_detail') || 'Cannot skip strategy if detail is skipped'),
                errorDetail: (window.i18n?.t('js.must_modify_strategy_or_detail') || 'Must modify strategy or detail')
            });
            return;
        }

        skipStrategyUsed = true;
        editStrategyModified = false;
        editCollectedStrategy = null;
        showEditStep(3);  // 直接跳到修改明细
        updateSkipButtonsState();
    }

    // 跳过明细修改
    function editWizardSkipItems() {
        // 检查是否已经跳过了策略
        if (skipStrategyUsed) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.cannot_skip') || 'Cannot Skip'),
                message: (window.i18n?.t('js.cannot_skip_both_strategy') || 'Cannot skip detail if strategy is skipped'),
                errorDetail: (window.i18n?.t('js.must_modify_strategy_or_detail') || 'Must modify strategy or detail')
            });
            return;
        }

        skipItemsUsed = true;
        editItemsModified = false;
        editModifiedItems = [];
        showEditStep(5);  // 直接跳到预览
        updatePreview();
        updateSkipButtonsState();
    }

    // 检查策略是否修改（从收集的数据对象读取，只检查备注以外的字段）
    function checkStrategyModifiedFromCollected() {
        const orig = editOriginalData?.strategy || {};
        const collected = editCollectedStrategy || {};
        // 只检查备注以外的字段是否有修改
        return (
            collected.currency !== (orig.currency || 'RMB') ||
            Math.abs((collected.exchange_rate || 0) - (orig.exchange_rate || 0)) > 0.0001 ||
            collected.float_enabled !== (orig.float_enabled || false) ||
            Math.abs((collected.float_threshold || 0) - (orig.float_threshold || 0)) > 0.01 ||
            collected.deposit_enabled !== (orig.deposit_enabled || false) ||
            Math.abs((collected.deposit_par || 0) - (orig.deposit_par || 0)) > 0.1
        );
    }



    // 收集修改的商品
    function collectModifiedItems() {
        const items = [];
        const tbody = document.getElementById('edit-items-tbody');

        tbody.querySelectorAll('tr').forEach(tr => {
            const isNew = tr.dataset.isNew === 'true';
            const isDeleted = tr.classList.contains('deleted-row');
            const wasDeleted = tr.dataset.wasDeleted === 'true';  // 原本是删除状态

            if (isNew && !isDeleted) {
                // 新增的商品
                const skuSelect = tr.querySelector('.edit-sku-select');
                const sku = skuSelect ? skuSelect.value : '';
                if (sku) {
                    items.push({
                        sku: sku,
                        qty: parseInt(tr.querySelector('.edit-qty-input').value) || 0,
                        unit_price: parseFloat(tr.querySelector('.edit-price-input').value) || 0,
                        action: 'add'
                    });
                }
            } else if (isDeleted && !wasDeleted) {
                // 本次编辑中删除的商品（原来不是删除状态）
                const origQty = parseFloat(tr.dataset.originalQty) || 0;
                const origPrice = parseFloat(tr.dataset.originalPrice) || 0;
                items.push({
                    sku: tr.dataset.sku,
                    qty: 0,
                    unit_price: 0,
                    original_qty: origQty,
                    original_price: origPrice,
                    action: 'delete'
                });
            } else if (isDeleted && wasDeleted) {
                // 原本就是删除状态，且仍是删除状态 -> 无需操作
                // 不需要添加到items
            } else if (!isDeleted && wasDeleted) {
                // 原本是删除状态，但现在被恢复了 -> 使用add action
                const qtyInput = tr.querySelector('.edit-qty-input');
                const priceInput = tr.querySelector('.edit-price-input');
                if (qtyInput && priceInput) {
                    items.push({
                        sku: tr.dataset.sku,
                        qty: parseInt(qtyInput.value) || 0,
                        unit_price: parseFloat(priceInput.value) || 0,
                        action: 'add'  // 恢复删除的商品使用add
                    });
                }
            } else {
                // 正常的商品，检查是否有修改
                const origQty = parseFloat(tr.dataset.originalQty);
                const origPrice = parseFloat(tr.dataset.originalPrice);
                const qtyInput = tr.querySelector('.edit-qty-input');
                const priceInput = tr.querySelector('.edit-price-input');

                if (qtyInput && priceInput) {
                    const newQty = parseInt(qtyInput.value) || 0;
                    const newPrice = parseFloat(priceInput.value) || 0;

                    if (newQty !== origQty || Math.abs(newPrice - origPrice) > 0.001) {
                        items.push({
                            sku: tr.dataset.sku,
                            qty: newQty,
                            unit_price: newPrice,
                            original_qty: origQty,
                            original_price: origPrice,
                            action: 'adjust'
                        });
                    }
                }
            }
        });

        return items;
    }

    // 更新预览
    function updatePreview() {
        // ========================================
        // 1. 策略信息框体
        // ========================================
        const strategyCard = document.getElementById('edit-preview-strategy-card');
        const strategyHeader = document.getElementById('edit-preview-strategy-header');
        const strategyBadge = document.getElementById('edit-preview-strategy-badge');
        const strategyContent = document.getElementById('edit-preview-strategy-content');

        // 安全检查
        if (!strategyCard || !strategyHeader || !strategyBadge || !strategyContent) {
            console.error('[EditWizard] Strategy DOM elements not found!');
            return;
        }

        // 策略数据来源
        const strategyData = editStrategyModified ? editCollectedStrategy : editOriginalData?.strategy;
        const orig = editOriginalData?.strategy || {};
        if (editStrategyModified) {
            // 有修改：显示已修改标签，亮色边框
            strategyHeader.classList.remove('bg-secondary', 'bg-opacity-25');
            strategyHeader.classList.add('bg-warning', 'bg-opacity-10');
            strategyBadge.className = 'badge bg-warning';
            strategyBadge.textContent = (window.i18n?.t('js.modified') || 'Modified');
            strategyCard.classList.remove('border-secondary');
            strategyCard.classList.add('border-warning');
        } else {
            // 无修改：显示原始数据标签，灰色边框
            strategyHeader.classList.remove('bg-warning', 'bg-opacity-10');
            strategyHeader.classList.add('bg-secondary', 'bg-opacity-25');
            strategyBadge.className = 'badge bg-secondary';
            strategyBadge.textContent = (window.i18n?.t('js.not_modified') || 'Not Modified');
            strategyCard.classList.remove('border-warning');
            strategyCard.classList.add('border-secondary');
        }

        // 渲染策略内容（采用4行布局，和新建订单一致）
        const currency = strategyData?.currency || 'RMB';
        const rate = strategyData?.exchange_rate || 0;
        const floatEnabled = strategyData?.float_enabled || false;
        const floatThreshold = strategyData?.float_threshold || 0;
        const depositEnabled = strategyData?.deposit_enabled || false;
        const depositPar = strategyData?.deposit_par || 0;
        const note = editStrategyModified ? (strategyData?.note || '') : (orig.note || '');

        // [Fix] 更新流程5预览表格表头的货币标签
        const previewUnitPriceLabel = document.getElementById('preview-currency-unit-price');
        const previewSubtotalLabel = document.getElementById('preview-currency-subtotal');
        if (previewUnitPriceLabel) previewUnitPriceLabel.textContent = currency;
        if (previewSubtotalLabel) previewSubtotalLabel.textContent = currency;

        strategyContent.innerHTML = `
            <div class="row g-3">
                <!--第一行：货币、汇率-->
                <div class="col-md-6">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="js.settlement_currency">结算货币</div>
                        <div class="text-white fw-medium">${currency}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="table.settlement_rate">结算汇率</div>
                        <div class="text-white fw-medium">${rate > 0 ? rate.toFixed(4) : '-'}</div>
                    </div>
                </div>
                <!--第二行：浮动开关、阈值-->
                <div class="col-md-6">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="purchase.price_float">价格浮动</div>
                        <div class="${floatEnabled ? 'text-success' : 'text-secondary'} fw-medium">${floatEnabled ? (window.i18n?.t('js.enabled') || 'Enabled') : (window.i18n?.t('js.disabled') || 'Disabled')}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="js.float_threshold">浮动阈值</div>
                        <div class="text-white fw-medium">${floatThreshold}%</div>
                    </div>
                </div>
                <!--第三行：定金开关、比例-->
                <div class="col-md-6">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="ui.text_2249">定金需求</div>
                        <div class="${depositEnabled ? 'text-success' : 'text-secondary'} fw-medium">${depositEnabled ? (window.i18n?.t('js.need') || 'Need') : (window.i18n?.t('js.no_need') || 'No Need')}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="table.deposit_rate">定金比例</div>
                        <div class="text-white fw-medium">${depositPar}%</div>
                    </div>
                </div>
                <!--第四行：备注-->
                <div class="col-12">
                    <div class="param-item bg-black bg-opacity-25 p-2 rounded">
                        <div class="text-white-50 small" data-i18n="common.modify_note">修改备注</div>
                        <div class="${editStrategyModified ? 'text-warning' : 'text-white-50'} fw-medium">${note || (window.i18n?.t('js.none') || '(None)')}</div>
                    </div>
                </div>
            </div>
        `;

        // ========================================
        // 2. 明细信息框体
        // ========================================
        const itemsCard = document.getElementById('edit-preview-items-card');
        const itemsHeader = document.getElementById('edit-preview-items-header');
        const itemsBadge = document.getElementById('edit-preview-items-badge');
        const itemsTbody = document.getElementById('edit-preview-items-tbody');
        const itemsTotal = document.getElementById('edit-preview-total');

        if (editItemsModified && editModifiedItems.length > 0) {
            // 有修改：显示已修改标签
            itemsHeader.classList.remove('bg-secondary', 'bg-opacity-25');
            itemsHeader.classList.add('bg-warning', 'bg-opacity-10');
            itemsBadge.className = 'badge bg-warning';
            itemsBadge.textContent = `${editModifiedItems.length} 项修改`;
            itemsCard.classList.remove('border-secondary');
            itemsCard.classList.add('border-warning');

            // 渲染修改的明细
            let html = '';
            let total = 0;

            editModifiedItems.forEach(item => {
                const actionLabel = { add: (window.i18n?.t('js.create') || 'Create'), adjust: (window.i18n?.t('js.modify') || 'Modify'), delete: (window.i18n?.t('js.delete') || 'Delete') }[item.action];
                const actionColor = { add: 'success', adjust: 'warning', delete: 'danger' }[item.action];
                const subtotal = item.action === 'delete' ? 0 : (item.qty * item.unit_price);
                total += subtotal;

                html += `
                    <tr class="${item.action === 'delete' ? 'text-danger text-decoration-line-through opacity-50' : ''}">
                        <td><span class="badge bg-${actionColor}">${actionLabel}</span></td>
                        <td class="font-monospace text-warning">${item.sku}</td>
                        <td class="text-center text-info">${item.action === 'delete' ? '-' : item.qty}</td>
                        <td class="text-end text-white-50">${item.action === 'delete' ? '-' : item.unit_price.toFixed(2)}</td>
                        <td class="text-end text-success">${item.action === 'delete' ? '-' : subtotal.toFixed(2)}</td>
                    </tr>
                `;
            });

            itemsTbody.innerHTML = html;
            itemsTotal.textContent = `${currency} ${total.toFixed(2)} `;

        } else {
            // 无修改：显示原始明细
            itemsHeader.classList.remove('bg-warning', 'bg-opacity-10');
            itemsHeader.classList.add('bg-secondary', 'bg-opacity-25');
            itemsBadge.className = 'badge bg-secondary';
            itemsBadge.textContent = (window.i18n?.t('js.not_modified') || 'Not Modified');
            itemsCard.classList.remove('border-warning');
            itemsCard.classList.add('border-secondary');

            // 渲染原始明细
            const origItems = editOriginalData?.items || [];
            let html = '';
            let total = 0;

            origItems.forEach(item => {
                const subtotal = item.qty * item.unit_price;
                total += subtotal;

                html += `
                    <tr>
                        <td><span class="badge bg-secondary" data-i18n="ui.text_704">原始</span></td>
                        <td class="font-monospace text-white-50">${item.sku}</td>
                        <td class="text-center text-white-50">${item.qty}</td>
                        <td class="text-end text-white-50">${item.unit_price.toFixed(2)}</td>
                        <td class="text-end text-white-50">${subtotal.toFixed(2)}</td>
                    </tr>
                `;
            });

            itemsTbody.innerHTML = html || '<tr><td colspan="5" class="text-center text-white-50 py-3" data-i18n="ui.text_2252">暂无明细</td></tr>';
            itemsTotal.textContent = `${currency} ${total.toFixed(2)} `;
        }

        // ========================================
        // 3. 确认按钮状态
        // ========================================
        const hasModification = editStrategyModified || (editItemsModified && editModifiedItems.length > 0);
        document.getElementById('btn-edit-confirm').disabled = !hasModification;
    }

    // 确认修改
    function editConfirmModification() {
        if (typeof requestPasswordVerify === 'function') {
            requestPasswordVerify(
                'btn_po_modify',
                function (passwords) { submitModification(passwords); },
                document.getElementById('btn-edit-confirm'),
                (window.i18n?.t('js.edit_order') || 'Edit Order'),
                function () { /* 用户取消 */ }
            );
        } else {
            if (confirm('{% trans "确定要提交修改吗？" %}')) {
                submitModification({});
            }
        }
    }

    // 异步提交（用于GlobalWizard）
    async function submitModificationAsync(passwords) {
        return new Promise((resolve, reject) => {
            submitModification(passwords, resolve, reject);
        });
    }

    // 提交修改
    function submitModification(passwords, onSuccess, onError) {
        const payload = {
            po_num: editCurrentPoNum,
            strategy_modified: editStrategyModified,
            items_modified: editItemsModified
        };

        // 添加密码到请求
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                payload[`sec_code_${slot}`] = code;
            }
        }

        // 策略修改
        if (editStrategyModified) {
            payload.strategy = {
                currency: document.querySelector('input[name="edit_currency"]:checked')?.value || 'RMB',
                exchange_rate: getEditMgmtExchangeRate() || 0,  // 使用组件函数获取
                cur_mode: getEditMgmtExchangeRateMode(),  // 汇率获取方式: A=自动, M=手动
                float_enabled: document.getElementById('edit_float_enabled').checked,
                float_threshold: parseFloat(document.getElementById('edit_float_range').value) || 0,
                deposit_enabled: document.getElementById('edit_deposit_enabled').checked,
                deposit_par: parseFloat(document.getElementById('edit_deposit_range').value) || 0,
                note: document.getElementById('edit-new-note').value
            };
        }

        // 明细修改 - 直接包含数据（与策略相同方式）
        if (editModifiedItems && editModifiedItems.length > 0) {
            payload.items_modified = true;  // 强制设置为true
            payload.items = editModifiedItems;
            payload.items_note = editItemsNote;
        }
        fetch(`{% url 'web_ui:purchase:po_mgmt_submit_modify' %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    let msg = (window.i18n?.t('js.order_edit_success') || 'Order Edit Success!');
                    if (data.data.new_strategy_seq) {
                        msg += ` 新策略版本: ${data.data.new_strategy_seq} `;
                    }
                    if (data.data.new_detail_seq) {
                        msg += ` 新明细版本: ${data.data.new_detail_seq}`;
                    }
                    document.getElementById('edit-success-message').textContent = msg;

                    // 显示完成步骤并更新进度条
                    showEditStep(6);

                    if (onSuccess) onSuccess();
                } else {
                    alert('{% trans "提交失败: " %}' + data.message);
                    if (onError) onError();
                }
            })
            .catch(err => {
                alert('{% trans "提交失败: " %}' + err);
                if (onError) onError();
            });
    }

    // 重新加载并编辑订单（刷新数据）
    function reloadAndEditOrder() {
        if (editCurrentPoNum) {
            // 隐藏向导容器
            document.getElementById('edit-wizard-container').style.display = 'none';
            // 重新加载订单数据
            loadOrderForEdit(editCurrentPoNum);
            // 重新显示向导容器
            document.getElementById('edit-wizard-container').style.display = 'block';
        }
    }

    // 关闭编辑并返回列表
    function closeEditAndReload() {
        // 隐藏向导容器
        document.getElementById('edit-wizard-container').style.display = 'none';
        // 显示列表视图
        showListView();
        // 刷新列表数据
        loadOrderTable();
    }
</script>