{% extends "layouts/base.html" %}
{% load static %}
{% load security_tags %}
{% load i18n %}

{% block title %}Goods Receiving - Procurement - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'web_ui:purchase:hub' %}" class="text-info text-decoration-none" data-i18n="purchase.title">Procurement</a>
                    </li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="purchase.receive_create">Goods Receiving</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'web_ui:purchase:hub' %}" 
               class="btn btn-outline-secondary btn-sm" 
               data-bs-toggle="tooltip" 
               data-i18n-title="tooltip.t1444" title="返回采购模块主页">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="purchase.back_to_hub">返回Procurement</span>
            </a>
        </div>
    </div>

    <!-- 向导容器 -->
    <div id="receive-wizard-container" class="glass-card p-4 shadow-lg">
        <!-- 向导Header -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; flex-shrink: 0;">
                    <i class="fas fa-warehouse fa-2x text-info"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_551">Goods Receiving向导</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_552">请按步骤完成Goods Receiving操作，系统将自动校验并记录入库信息。</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>
        
        <!-- StepBar 锚点 -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

        <!-- 各步骤内容 (通过 include 引入) -->
        {% include "purchase/pages/receive_steps/step1_date.html" %}
        {% include "purchase/pages/receive_steps/step2_select.html" %}
        {% include "purchase/pages/receive_steps/step3_confirm.html" %}
        {% include "purchase/pages/receive_steps/step5_finish.html" %}
        
        <!-- 安全验证隐藏表单 -->
        <div id="policy-check-receive" class="d-none">
            {% security_inputs 'btn_receive_confirm' %}
        </div>
    </div>
</div>

<style>
    /* 步骤内容显示控制 - GlobalWizard 通过 active 类控制 */
    .wizard-step-content {
        display: none;
    }
    .wizard-step-content.active {
        display: block;
    }
    
    /* 导航按钮布局 - 返回左对齐，下一步右对齐 */
    .wizard-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* 验证卡片状态样式 */
    .state-normal {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(13, 202, 240, 0.25);
    }
    .state-normal .card-header {
        background: rgba(13, 202, 240, 0.1);
    }
    
    .state-loading {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 193, 7, 0.5);
    }
    .state-loading .card-header {
        background: rgba(255, 193, 7, 0.1);
    }
    
    .state-error {
        background: rgba(220, 53, 69, 0.1);
        border: 2px solid var(--bs-danger);
        animation: errorPulse 1.5s ease-in-out infinite;
    }
    .state-error .card-header {
        background: rgba(220, 53, 69, 0.2);
    }
    
    .state-success {
        background: rgba(25, 135, 84, 0.1);
        border: 2px solid var(--bs-success);
    }
    .state-success .card-header {
        background: rgba(25, 135, 84, 0.2);
    }
    
    @keyframes errorPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3); }
    }
    
    /* 参数表单样式 */
    .param-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
    }
    
    .param-row {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .param-row:last-child {
        border-bottom: none;
    }
    
    .param-label {
        width: 180px;
        flex-shrink: 0;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }
    
    .param-value {
        flex: 1;
    }
    
    .param-value input,
    .param-value select {
        background: rgba(0, 0, 0, 0.5) !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
    }
</style>

<!-- Goods Receiving向导 JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // === 状态管理 ===
    const receiveState = {
        receiveDate: null,      // Step 1 选择的入库日期
        shipments: [],          // Step 2 发货单列表 [{logistic_num, sent_date, date_eta, pallets, sent_seq}, ...]
        selectedLogistic: null, // 当前选中的发货单号
        currentItems: [],       // 当前发货单的货物明细 [{po_sku, sent_quantity}, ...]
        receiveData: {}         // 已确认的入库数据 {logistic_num: [{po_sku, sent_quantity, receive_quantity}, ...], ...}
    };
    
    // 暴露到全局供调试
    window.receiveState = receiveState;
    
    // === DOM 元素 ===
    const receiveDateInput = document.getElementById('receive_date');
    const btnNext1 = document.getElementById('btn-receive-next-1');
    const btnNext2 = document.getElementById('btn-receive-next-2');
    
    // === Step 1: 日期选择逻辑 ===
    function updateStep1ButtonState() {
        const dateValue = receiveDateInput?.value;
        if (btnNext1) {
            btnNext1.disabled = !dateValue;
        }
    }
    
    // 监听日期变化
    if (receiveDateInput) {
        receiveDateInput.addEventListener('change', function() {
            receiveState.receiveDate = this.value;
            updateStep1ButtonState();
            console.log('[ReceiveWizard] Date selected:', receiveState.receiveDate);
        });
    }
    
    // 初始化按钮状态
    updateStep1ButtonState();
    
    // 初始化向导
    const wizard = new GlobalWizard({
        containerId: 'receive-wizard-container',
        steps: [
            { id: 'date', label: (window.i18n?.t('form.placeholder.generic_10') || 'Select Date'), contentSelector: '#receive-step-date' },
            { id: 'select', label: (window.i18n?.t('js.receiving_select') || 'Receiving Selection'), contentSelector: '#receive-step-select' },
            { id: 'confirm', label: (window.i18n?.t('js.confirm_receiving') || 'Confirm Receiving'), contentSelector: '#receive-step-confirm' },
            { id: 'finish', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#receive-step-finish' }
        ],
        onStepChange: (fromStep, toStep) => {
            console.log('[ReceiveWizard] Step changed:', fromStep, '->', toStep);
            
            // 进入 Step 2 时，加载发货单数据
            if (toStep === 1) {
                onEnterStep2();
            }
            
            // 进入 Step 3 时，渲染确认数据
            if (toStep === 2) {
                onEnterStep3();
            }
            
            // 进入 Step 4 (完成) 时，填充摘要
            if (toStep === 3) {
                onEnterStep4();
            }
        },
        onBeforeNext: async (currentStep, currentIndex) => {
            console.log('[ReceiveWizard] onBeforeNext:', currentStep.id);
            
            // Step 1: 验证日期已选择
            if (currentStep.id === 'date') {
                if (!receiveState.receiveDate) {
                    alert('{% trans "请选择入库日期" %}');
                    return false;
                }
            }
            
            // Step 2: 验证至少有一个发货单被确认入库
            if (currentStep.id === 'select') {
                if (Object.keys(receiveState.receiveData).length === 0) {
                    alert('{% trans "请至少确认一个发货单的入库数据" %}');
                    return false;
                }
            }
            
            // Step 3: 确认入库需要密码验证
            if (currentStep.id === 'confirm') {
                // 返回 false 阻止自动前进，密码验证通过后手动跳转
                return submitReceiveWithAuth();
            }
            
            return true;
        },
        onComplete: (data) => {
            console.log('[ReceiveWizard] Complete:', data);
        },
        onRestart: () => {
            console.log('[ReceiveWizard] Restart');
            // 重置状态
            receiveState.receiveDate = null;
            receiveState.shipments = [];
            receiveState.selectedLogistic = null;
            receiveState.currentItems = [];
            receiveState.receiveData = {};
            if (receiveDateInput) receiveDateInput.value = '';
            updateStep1ButtonState();
        }
    });
    
    // 暴露到全局供调试
    window.receiveWizard = wizard;
    
    // === Step 2: 入库选择逻辑 ===
    
    async function onEnterStep2() {
        console.log('[ReceiveWizard] Entering Step 2 with date:', receiveState.receiveDate);
        
        // 显示入库日期
        const dateDisplay = document.getElementById('receive-date-display');
        if (dateDisplay) dateDisplay.textContent = receiveState.receiveDate;
        
        // 加载发货单列表
        await loadPendingShipments();
    }
    
    async function loadPendingShipments() {
        const loadingEl = document.getElementById('receive-shipment-loading');
        const listEl = document.getElementById('receive-shipment-list');
        const emptyEl = document.getElementById('receive-shipment-empty');
        
        if (loadingEl) loadingEl.classList.remove('d-none');
        
        try {
            const response = await fetch(`/dashboard/purchase/api/receive/pending_shipments/?receive_date=${receiveState.receiveDate}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || (window.i18n?.t('js.load_failed') || 'Load Failed'));
            }
            
            receiveState.shipments = data.shipments || [];
            renderShipmentCards();
            
        } catch (error) {
            console.error('[ReceiveWizard] Load shipments error:', error);
            if (emptyEl) {
                emptyEl.innerHTML = `<i class="fas fa-exclamation-triangle fa-2x text-danger opacity-50 mb-2 d-block"></i>加载失败: ${error.message}`;
            }
        } finally {
            if (loadingEl) loadingEl.classList.add('d-none');
        }
    }
    
    function renderShipmentCards() {
        const listEl = document.getElementById('receive-shipment-list');
        if (!listEl) return;
        
        if (receiveState.shipments.length === 0) {
            listEl.innerHTML = `
                <div class="col-12 text-center py-4 text-white-50">
                    <i class="fas fa-inbox fa-2x opacity-50 mb-2 d-block"></i>
                    该日期前没有待入库的发货单
                </div>
            `;
            return;
        }
        
        let html = '';
        receiveState.shipments.forEach((ship, index) => {
            const statusTag = getShipmentStatusTag(ship.logistic_num);
            const isActive = receiveState.selectedLogistic === ship.logistic_num;
            
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="shipment-card ${isActive ? 'active' : ''}" 
                         data-logistic="${ship.logistic_num}" 
                         onclick="selectShipment('${ship.logistic_num}')">
                        <span class="shipment-status-tag ${statusTag.class}">${statusTag.text}</span>
                        <div class="shipment-info">
                            <div class="shipment-info-item">
                                <div class="shipment-info-label" data-i18n="finance.send_no">发货单号</div>
                                <div class="shipment-info-value text-info">${ship.logistic_num}</div>
                            </div>
                            <div class="shipment-info-item">
                                <div class="shipment-info-label" data-i18n="ui.text_2174">发货时间</div>
                                <div class="shipment-info-value">${ship.sent_date}</div>
                            </div>
                            <div class="shipment-info-item">
                                <div class="shipment-info-label" data-i18n="js.eta_date">预计到达</div>
                                <div class="shipment-info-value">${ship.date_eta || '-'}</div>
                            </div>
                            <div class="shipment-info-item">
                                <div class="shipment-info-label" data-i18n="ui.text_2176">货板数</div>
                                <div class="shipment-info-value">${ship.pallets || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        listEl.innerHTML = html;
    }
    
    function getShipmentStatusTag(logisticNum) {
        const receiveItems = receiveState.receiveData[logisticNum];
        
        if (!receiveItems || receiveItems.length === 0) {
            return { class: 'status-pending', text: (window.i18n?.t('js.shipping') || 'Shipping') };
        }
        
        // 计算入库比例
        let totalSent = 0;
        let totalReceive = 0;
        receiveItems.forEach(item => {
            totalSent += item.sent_quantity;
            totalReceive += item.receive_quantity;
        });
        
        if (totalReceive >= totalSent) {
            return { class: 'status-complete', text: (window.i18n?.t('js.receive_all') || 'Receive All') };
        } else if (totalReceive > 0) {
            return { class: 'status-partial', text: (window.i18n?.t('js.receive_partial') || 'Receive Partial') };
        } else {
            return { class: 'status-pending', text: (window.i18n?.t('js.shipping') || 'Shipping') };
        }
    }
    
    // 选择发货单 - 暴露到全局
    window.selectShipment = async function(logisticNum) {
        console.log('[ReceiveWizard] Select shipment:', logisticNum);
        receiveState.selectedLogistic = logisticNum;
        
        // 更新卡片选中状态
        document.querySelectorAll('.shipment-card').forEach(card => {
            card.classList.remove('active');
            if (card.dataset.logistic === logisticNum) {
                card.classList.add('active');
            }
        });
        
        // 显示货物明细卡片
        const itemsCard = document.getElementById('receive-items-card');
        if (itemsCard) itemsCard.classList.remove('d-none');
        
        // 更新标题
        const currentLogisticEl = document.getElementById('receive-current-logistic');
        if (currentLogisticEl) currentLogisticEl.textContent = logisticNum;
        
        // 加载货物明细
        await loadShipmentItems(logisticNum);
    };
    
    async function loadShipmentItems(logisticNum) {
        const tbody = document.getElementById('receive-items-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-3 text-white-50">
                    <span class="spinner-border spinner-border-sm me-2"></span>加载中...
                </td>
            </tr>
        `;
        
        try {
            const response = await fetch(`/dashboard/purchase/api/receive/shipment_items/?logistic_num=${encodeURIComponent(logisticNum)}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || (window.i18n?.t('js.load_failed') || 'Load Failed'));
            }
            
            receiveState.currentItems = data.items || [];
            renderItemsTable(logisticNum);
            
        } catch (error) {
            console.error('[ReceiveWizard] Load items error:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-3 text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>加载失败: ${error.message}
                    </td>
                </tr>
            `;
        }
    }
    
    function renderItemsTable(logisticNum) {
        const tbody = document.getElementById('receive-items-tbody');
        if (!tbody) return;
        
        // 检查是否有已保存的入库数据
        const savedItems = receiveState.receiveData[logisticNum] || [];
        const savedMap = {};
        savedItems.forEach(item => {
            // 使用 po_num + po_sku 作为组合 key
            const itemKey = `${item.po_num}|${item.po_sku}`;
            savedMap[itemKey] = item.receive_quantity;
        });
        
        let html = '';
        receiveState.currentItems.forEach((item, index) => {
            // 使用 po_num + po_sku 作为组合 key
            const itemKey = `${item.po_num}|${item.po_sku}`;
            const savedQty = savedMap[itemKey];
            const inputValue = savedQty !== undefined ? savedQty : '';
            
            html += `
                <tr data-key="${itemKey}">
                    <td class="text-white">${item.po_sku}</td>
                    <td class="text-white-50">${item.po_num}</td>
                    <td class="text-center text-info">${item.sent_quantity}</td>
                    <td class="text-center">
                        <input type="number" 
                               class="form-control receive-qty-input" 
                               data-key="${itemKey}"
                               data-po-num="${item.po_num}"
                               data-sku="${item.po_sku}"
                               data-sent="${item.sent_quantity}"
                               value="${inputValue}"
                               min="0"
                               placeholder="0">
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="4" class="text-center py-3 text-white-50" data-i18n="ui.text_2177">该发货单无货物明细</td>
            </tr>
        `;
    }
    
    // 全选按钮 - 填入发货数量
    const btnFillAll = document.getElementById('btn-receive-fill-all');
    if (btnFillAll) {
        btnFillAll.addEventListener('click', function() {
            document.querySelectorAll('.receive-qty-input').forEach(input => {
                const sentQty = parseInt(input.dataset.sent) || 0;
                input.value = sentQty;
            });
        });
    }
    
    // 确认按钮 - 保存到内存
    const btnConfirmItems = document.getElementById('btn-receive-confirm-items');
    if (btnConfirmItems) {
        btnConfirmItems.addEventListener('click', function() {
            const logisticNum = receiveState.selectedLogistic;
            if (!logisticNum) return;
            
            const items = [];
            let hasError = false;
            let totalReceiveQty = 0;
            
            document.querySelectorAll('.receive-qty-input').forEach(input => {
                const poNum = input.dataset.poNum;
                const sku = input.dataset.sku;
                const sentQty = parseInt(input.dataset.sent) || 0;
                const receiveQty = parseInt(input.value) || 0;
                
                // 验证：不能为负数
                if (receiveQty < 0) {
                    input.classList.add('is-invalid');
                    hasError = true;
                } else {
                    input.classList.remove('is-invalid');
                }
                
                totalReceiveQty += receiveQty;
                
                items.push({
                    po_num: poNum,
                    po_sku: sku,
                    sent_quantity: sentQty,
                    receive_quantity: receiveQty
                });
            });
            
            if (hasError) {
                alert('{% trans "入库数量不能为负数" %}');
                return;
            }
            
            // 验证：不能全部为0
            if (totalReceiveQty === 0) {
                GlobalModal.showWarning({
                    title: (window.i18n?.t('js.no_actual_receive') || 'No Actual Receive'),
                    message: '所有Goods Receiving数量均为0，无法确认。<br><small class="text-muted" data-i18n="ui.text_553">如确实未收到任何货物，请取消本次入库操作。</small>'
                });
                return;
            }
            
            // 保存到内存（只保存一个发货单）
            receiveState.receiveData = {};  // 清空之前的数据
            receiveState.receiveData[logisticNum] = items;
            console.log('[ReceiveWizard] Saved receive data for', logisticNum, items);
            
            // 禁用其他发货单卡片（只能选一个）
            document.querySelectorAll('.shipment-card').forEach(card => {
                if (card.dataset.logistic !== logisticNum) {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.5';
                }
            });
            
            // 更新卡片状态标签
            renderShipmentCards();
            
            // 更新 Step 2 下一步按钮状态
            updateStep2ButtonState();
            
            // 提示保存成功
            const currentLogisticEl = document.getElementById('receive-current-logistic');
            if (currentLogisticEl) {
                const originalText = currentLogisticEl.textContent;
                currentLogisticEl.innerHTML = `${originalText} <span class="badge bg-success ms-2" data-i18n="toast.saved">已保存</span>`;
                setTimeout(() => {
                    currentLogisticEl.textContent = originalText;
                }, 2000);
            }
        });
    }
    
    function updateStep2ButtonState() {
        if (btnNext2) {
            const hasData = Object.keys(receiveState.receiveData).length > 0;
            btnNext2.disabled = !hasData;
        }
    }
    
    // === Step 3: 收货确认 - 渲染确认表格 ===
    
    // 入库文件上传器实例
    let receiveFileUploader = null;
    
    function onEnterStep3() {
        console.log('[ReceiveWizard] Entering Step 3');
        renderConfirmTable();
        initReceiveFileUpload();
    }
    
    function initReceiveFileUpload() {
        // 初始化入库文件上传组件
        if (typeof GlobalFileUpload !== 'undefined') {
            receiveFileUploader = new GlobalFileUpload({
                containerId: 'receive-file-upload-container',
                inputName: 'receive_file',
                title: (window.i18n?.t('js.upload_receiving_file') || 'Upload Receiving File'),
                accept: '.pdf,.jpg,.jpeg,.png,.gif,.heic,.heif,.xls,.xlsx,.doc,.docx,.csv',
                maxSizeMB: 10,
                required: false,
                onFileSelect: (file) => {
                    console.log('[ReceiveWizard] Receive file selected:', file.name);
                },
                onFileRemove: () => {
                    console.log('[ReceiveWizard] Receive file removed');
                },
                onError: (message) => {
                    console.error('[ReceiveWizard] File upload error:', message);
                }
            });
            console.log('[ReceiveWizard] Receive file uploader initialized');
        } else {
            console.warn('[ReceiveWizard] GlobalFileUpload not available');
        }
    }
    
    // 上传入库文件（在提交成功后调用）
    async function uploadReceiveFile() {
        if (!receiveFileUploader) return;
        
        const file = receiveFileUploader.getFile();
        if (!file) return;  // 没有选择文件，跳过
        
        // 获取入库的物流单号（当前只支持单个）
        const logisticNums = Object.keys(receiveState.receiveData);
        if (logisticNums.length === 0) return;
        
        const logisticNum = logisticNums[0];
        const receiveDate = receiveState.receiveDate;
        
        console.log('[ReceiveWizard] Uploading receive file for:', logisticNum, receiveDate);
        
        const formData = new FormData();
        formData.append('logistic_num', logisticNum);
        formData.append('receive_date', receiveDate);
        formData.append('receive_file', file);
        
        try {
            const response = await fetch('/dashboard/purchase/api/receive_mgmt/upload_file/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('[ReceiveWizard] File uploaded successfully:', result.filename);
            } else {
                console.error('[ReceiveWizard] File upload failed:', result.message);
            }
        } catch (error) {
            console.error('[ReceiveWizard] File upload error:', error);
        }
    }
    
    function renderConfirmTable() {
        const tbody = document.getElementById('confirm-tbody');
        if (!tbody) return;
        
        // 构建发货单信息映射
        const shipmentMap = {};
        receiveState.shipments.forEach(ship => {
            shipmentMap[ship.logistic_num] = {
                sent_date: ship.sent_date,
                date_eta: ship.date_eta || '-'
            };
        });
        
        // 统计数据
        let totalSkuSet = new Set();
        let totalReceiveQty = 0;
        let shipmentCount = 0;
        
        let html = '';
        
        // 遍历所有已确认的入库数据
        Object.keys(receiveState.receiveData).forEach(logisticNum => {
            const items = receiveState.receiveData[logisticNum];
            const shipInfo = shipmentMap[logisticNum] || { sent_date: '-', date_eta: '-' };
            
            // 过滤掉入库数量为0的项
            const validItems = items.filter(item => item.receive_quantity > 0);
            if (validItems.length === 0) return; // 跳过全部为0的发货单
            
            shipmentCount++;
            
            // 按 SKU 合并不同订单的数量
            const skuMerged = {};
            validItems.forEach(item => {
                if (!skuMerged[item.po_sku]) {
                    skuMerged[item.po_sku] = {
                        po_sku: item.po_sku,
                        sent_quantity: 0,
                        receive_quantity: 0
                    };
                }
                skuMerged[item.po_sku].sent_quantity += item.sent_quantity;
                skuMerged[item.po_sku].receive_quantity += item.receive_quantity;
            });
            
            const mergedItems = Object.values(skuMerged);
            
            mergedItems.forEach((item, index) => {
                totalSkuSet.add(item.po_sku);
                totalReceiveQty += item.receive_quantity;
                
                const isFirst = index === 0;
                const rowClass = isFirst ? 'confirm-row-first' : 'confirm-row-grouped';
                
                // 计算误差
                const diff = item.sent_quantity - item.receive_quantity;
                let diffCell = '';
                if (diff > 0) {
                    diffCell = `<td class="text-center"><span class="diff-tag diff-under" data-i18n="ui.text_555">收货不足 -${diff}</span></td>`;
                } else if (diff < 0) {
                    diffCell = `<td class="text-center"><span class="diff-tag diff-over" data-i18n="ui.text_556">超出发货 +${Math.abs(diff)}</span></td>`;
                } else {
                    diffCell = `<td class="text-center"><span class="diff-tag diff-ok" data-i18n="ui.text_557">无误差</span></td>`;
                }
                
                html += `
                    <tr class="${rowClass}">
                        <td class="text-info">${isFirst ? logisticNum : ''}</td>
                        <td class="text-center">${isFirst ? shipInfo.sent_date : ''}</td>
                        <td class="text-center">${isFirst ? shipInfo.date_eta : ''}</td>
                        <td class="text-center text-warning">${isFirst ? receiveState.receiveDate : ''}</td>
                        <td class="text-white">${item.po_sku}</td>
                        <td class="text-center text-white-50">${item.sent_quantity}</td>
                        <td class="text-center ${item.receive_quantity > 0 ? 'qty-highlight' : 'qty-zero'}">${item.receive_quantity}</td>
                        ${diffCell}
                    </tr>
                `;
            });
        });
        
        if (!html) {
            html = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-white-50">
                        <i class="fas fa-inbox me-2"></i>没有需要入库的数据
                    </td>
                </tr>
            `;
        }
        
        tbody.innerHTML = html;
        
        // 更新汇总信息
        const dateEl = document.getElementById('confirm-receive-date');
        const shipCountEl = document.getElementById('confirm-shipment-count');
        const skuCountEl = document.getElementById('confirm-sku-count');
        
        if (dateEl) dateEl.textContent = receiveState.receiveDate;
        if (shipCountEl) shipCountEl.textContent = shipmentCount;
        if (skuCountEl) skuCountEl.textContent = totalSkuSet.size;
    }
    
    // === Step 4: 完成页 ===
    
    function onEnterStep4() {
        console.log('[ReceiveWizard] onEnterStep4');
        
        // 入库日期（用户流程1选择的日期）
        const dateEl = document.getElementById('finish-receive-date');
        if (dateEl) {
            dateEl.textContent = receiveState.receiveDate || '-';
        }
        
        // 操作时间（今天日期）
        const timeEl = document.getElementById('finish-receive-time');
        if (timeEl) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            timeEl.textContent = `${year}-${month}-${day}`;
        }
    }
    
    // === Step 3: 确认入库 - 密码验证与提交 ===
    
    function submitReceiveWithAuth() {
        // 返回 Promise，用于 onBeforeNext 的异步控制
        return new Promise((resolve) => {
            if (typeof requestPasswordVerify === 'function') {
                requestPasswordVerify(
                    'btn_receive_confirm',  // action key
                    async (passwords) => {
                        // 密码验证通过，执行提交逻辑
                        console.log('[ReceiveWizard] Security verified, submitting...');
                        await doReceiveSubmit(passwords);
                        // 手动跳转到完成页
                        wizard.goToStep('finish');
                        resolve(false);  // 返回 false 阻止 wizard.next() 再次前进
                    },
                    document.getElementById('receive-wizard-container'),  // 容器元素
                    (window.i18n?.t('js.confirm_receiving') || 'Confirm Receiving'),  // 显示名称
                    () => {
                        // 用户取消密码验证，保持在 Step 3
                        console.log('[ReceiveWizard] User cancelled security verification');
                        resolve(false);  // 返回 false 阻止前进
                    }
                );
            } else {
                // requestPasswordVerify 不可用时的后备处理
                console.warn('[ReceiveWizard] requestPasswordVerify not available, proceeding without auth');
                doReceiveSubmit({}).then(() => {
                    wizard.goToStep('finish');
                    resolve(false);
                });
            }
        });
    }
    
    async function doReceiveSubmit(passwords) {
        console.log('[ReceiveWizard] Submitting receive data:', receiveState.receiveData);
        
        // 构建提交数据：展开所有发货单的所有项
        const items = [];
        Object.keys(receiveState.receiveData).forEach(logisticNum => {
            const shipmentItems = receiveState.receiveData[logisticNum];
            shipmentItems.forEach(item => {
                items.push({
                    logistic_num: logisticNum,
                    po_num: item.po_num,
                    po_sku: item.po_sku,
                    sent_quantity: item.sent_quantity,
                    receive_quantity: item.receive_quantity
                });
            });
        });
        
        const submitData = {
            receive_date: receiveState.receiveDate,
            items: items
        };
        
        // 添加密码到请求
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                submitData[`sec_code_${slot}`] = code;
            }
        }
        
        try {
            const response = await fetch('/dashboard/purchase/api/receive/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(submitData)
            });
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || (window.i18n?.t('js.submit_failed') || 'Submit Failed'));
            }
            
            console.log('[ReceiveWizard] Submit success:', result.data);
            
            // 保存结果用于完成页显示
            receiveState.submitResult = result.data;
            
            // 上传入库文件（如果有）
            await uploadReceiveFile();
            
            return result;
        } catch (error) {
            console.error('[ReceiveWizard] Submit error:', error);
            alert('{% trans "入库失败: " %}' + error.message);
            throw error;
        }
    }
    
    function getCsrfToken() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }
    
    // === 按钮绑定 ===
    
    // Step 1: 选择日期 -> 下一步
    if (btnNext1) {
        btnNext1.addEventListener('click', () => wizard.next());
    }
    
    // Step 2: 入库选择 -> 下一步/返回
    const btnBack2 = document.getElementById('btn-receive-back-2');
    if (btnNext2) btnNext2.addEventListener('click', () => wizard.next());
    if (btnBack2) btnBack2.addEventListener('click', () => wizard.back());
    
    // Step 3: 收货确认 -> 下一步/返回
    const btnNext3 = document.getElementById('btn-receive-next-3');
    const btnBack3 = document.getElementById('btn-receive-back-3');
    if (btnNext3) btnNext3.addEventListener('click', () => wizard.next());
    if (btnBack3) btnBack3.addEventListener('click', () => wizard.back());
    
    // Step 4 已删除
    
    // Step 5: 完成 -> 再创一单/返回列表
    const btnRestart = document.getElementById('btn-receive-restart');
    if (btnRestart) btnRestart.addEventListener('click', () => wizard.restart());
    
    console.log('[ReceiveWizard] Initialized');
});
</script>
{% endblock %}