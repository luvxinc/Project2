{% load i18n %}
<!-- 发货单删除页面 - GlobalWizard版本 -->
<div class="glass-card p-4 shadow-lg">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
        <div class="d-flex align-items-center">
            <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-3">
                <i class="fas fa-trash-alt fa-2x text-danger"></i>
            </div>
            <div>
                <h5 class="text-white mb-1" data-i18n="ui.text_1036">删除发货单</h5>
                <p class="text-white-50 small mb-0" id="delete-logistic-num-label" data-i18n="ui.text_418">物流单号: -</p>
            </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="showListView()">
            <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
        </button>
    </div>

    <!-- GlobalWizard容器 -->
    <div id="delete-wizard-container" style="display: none;">
        <!-- 步骤条锚点 -->
        <div data-wizard-stepbar-anchor></div>

        <!-- =================== -->
        <!-- 流程1: 发货单预览 -->
        <!-- =================== -->
        <div id="delete-step-1" class="wizard-step-content active">
            <div class="text-center mb-4">
                <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-trash-alt fa-2x text-danger"></i>
                </div>
                <h4 class="text-white" data-i18n="ui.text_1038">确认删除发货单</h4>
                <p class="text-white-50" data-i18n="ui.text_1039">请仔细核对以下发货单信息，删除后可通过"恢复"功能找回</p>
            </div>

            <!-- 警告提示 -->
            <div class="alert alert-danger bg-danger bg-opacity-10 border-danger mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                    <div>
                        <h6 class="mb-1 text-danger" data-i18n="ui.text_630">危险操作警告</h6>
                        <p class="mb-0 small" data-i18n="ui.text_1041">此操作将标记整个发货单为已删除状态。发货单删除后将不会出现在正常列表中，但可以通过"恢复"功能找回。</p>
                    </div>
                </div>
            </div>

            <!-- 发货单基本信息卡片 -->
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header bg-primary bg-opacity-10 border-secondary">
                    <i class="fas fa-info-circle me-2 text-primary"></i>
                    <span class="text-white" data-i18n="ui.text_1042">发货单基本信息</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="text-white-50 small mb-1" data-i18n="table.logistics_no">物流单号</div>
                            <div class="text-white fw-bold font-monospace" id="delete-preview-logistic-num">-</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-white-50 small mb-1" data-i18n="purchase.shipping_date">发货日期</div>
                            <div class="text-info" id="delete-preview-date-sent">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 物流单详细信息卡片 -->
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header bg-info bg-opacity-10 border-secondary">
                    <i class="fas fa-truck me-2 text-info"></i>
                    <span class="text-white" data-i18n="ui.text_1043">物流单详细信息</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="abnormal.expected_arrival">预计到货日期</div>
                            <div class="text-white" id="delete-preview-date-eta">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="js.pallets">托盘数</div>
                            <div class="text-white" id="delete-preview-pallets">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="ui.text_2361">发货总重量</div>
                            <div class="text-white" id="delete-preview-weight">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="js.logistics_unit_price">物流单价</div>
                            <div class="text-white" id="delete-preview-price-kg">-</div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="ui.text_2363">物流总价</div>
                            <div class="text-warning fw-bold" id="delete-preview-total-price">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="table.settlement_rate">结算汇率</div>
                            <div class="text-white" id="delete-preview-usd-rmb">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="ui.text_2365">版本号</div>
                            <div class="text-white-50" id="delete-preview-seq">-</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white-50 small mb-1" data-i18n="common.operator">操作人</div>
                            <div class="text-white-50" id="delete-preview-by">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 物流单货物信息卡片 -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-success bg-opacity-10 border-secondary d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-box me-2 text-success"></i>
                        <span class="text-white" data-i18n="ui.text_1044">物流单货物信息</span>
                    </div>
                    <span class="badge bg-success" id="delete-preview-items-count" data-i18n="ui.text_839">0 件货物</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="sticky-top bg-dark">
                                <tr class="text-white-50">
                                    <th>#</th>
                                    <th data-i18n="purchase.order_num">订单号</th>
                                    <th>SKU</th>
                                    <th class="text-center" data-i18n="table.shipped_qty">发货数量</th>
                                    <th class="text-end" data-i18n="common.unit_price">单价</th>
                                    <th class="text-end" data-i18n="common.subtotal">小计</th>
                                </tr>
                            </thead>
                            <tbody id="delete-preview-items-tbody">
                                <!-- JS动态填充 -->
                            </tbody>
                            <tfoot class="border-top border-secondary">
                                <tr>
                                    <td colspan="5" class="text-end text-white-50 fw-bold" data-i18n="ui.text_2371">货物价值:</td>
                                    <td class="text-end text-success fw-bold" id="delete-preview-cargo-value">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 删除备注（必填） -->
            <div class="card bg-dark border-warning mb-4">
                <div class="card-header bg-warning bg-opacity-10 border-warning">
                    <i class="fas fa-comment-alt me-2 text-warning"></i>
                    <span class="text-white" data-i18n="ui.text_840">删除备注</span>
                    <span class="badge bg-danger ms-2" data-i18n="common.required">必填</span>
                </div>
                <div class="card-body">
                    <textarea 
                        id="delete-note-input" 
                        class="form-control bg-dark text-white border-secondary" 
                        rows="3" 
                        data-i18n-placeholder="form.placeholder.generic_12" placeholder="请填写删除原因..."
                        oninput="validateDeleteNote()"
                    ></textarea>
                    <div class="form-text text-white-50 mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        请填写删除原因，此信息将记录在操作日志中
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="d-flex justify-content-end gap-3">
                <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="showListView()">
                    <i class="fas fa-times me-2"></i><span data-i18n="common.cancel">取消</span>
                </button>
                <button class="btn btn-danger btn-lg px-4 rounded-pill" id="btn-delete-confirm" onclick="confirmDeleteSend()" disabled>
                    <i class="fas fa-trash-alt me-2"></i><span data-i18n="modal.confirm_delete.title">确认删除</span>
                </button>
            </div>
        </div>

        <!-- =================== -->
        <!-- 流程2: 完成 -->
        <!-- =================== -->
        <div id="delete-step-2" class="wizard-step-content" style="display: none;">
            <div class="text-center py-5">
                <div id="delete-result-icon">
                    <!-- JS动态填充 -->
                </div>
                <h4 class="text-white mb-3" id="delete-result-title" data-i18n="ui.text_229">处理中...</h4>
                <p class="text-white-50 mb-4" id="delete-result-message" data-i18n="ui.text_1049">
                    正在删除发货单...
                </p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-primary btn-lg px-4 rounded-pill" onclick="showListView()">
                        <i class="fas fa-list me-2"></i><span data-i18n="ui.icon_3334">返回发货单列表</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载中 -->
    <div id="delete-loading" class="text-center py-5">
        <div class="spinner-border text-danger" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="ui.text_1050">正在加载发货单数据...</p>
    </div>
</div>

<script>
    // 当前删除的物流单号
    let deleteCurrentLogisticNum = null;
    let deleteOriginalData = null;
    let deleteWizard = null;
    
    // 加载发货单数据用于删除
    function loadSendForDelete(logisticNum) {
        deleteCurrentLogisticNum = logisticNum;
        document.getElementById('delete-logistic-num-label').textContent = `物流单号: ${logisticNum}`;
        
        const loading = document.getElementById('delete-loading');
        const container = document.getElementById('delete-wizard-container');
        
        loading.style.display = 'block';
        container.style.display = 'none';
        
        // 获取发货单详情
        fetch(`{% url 'web_ui:purchase:send_mgmt_detail' %}?logistic_num=${encodeURIComponent(logisticNum)}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    alert(data.message || '{% trans "加载发货单失败" %}');
                    showListView();
                    return;
                }
                
                deleteOriginalData = data.data;
                
                container.style.display = 'block';
                
                // 初始化向导
                initDeleteWizard();
                
                // 填充预览数据
                populateDeletePreview(data.data);
            })
            .catch(err => {
                loading.style.display = 'none';
                alert('{% trans "加载发货单失败" %}: ' + err);
                showListView();
            });
    }
    
    // 初始化GlobalWizard
    function initDeleteWizard() {
        if (deleteWizard) return;
        
        if (typeof GlobalWizard === 'undefined') {
            console.error('[DeleteWizard] GlobalWizard not available');
            return;
        }
        
        deleteWizard = new GlobalWizard({
            containerId: 'delete-wizard-container',
            steps: [
                { id: 'preview', label: (window.i18n?.t('js.shipment_preview') || 'Shipment Preview'), type: 'normal', contentSelector: '#delete-step-1' },
                { id: 'done', label: (window.i18n?.t('js.delete_complete') || 'Delete Complete'), type: 'done', contentSelector: '#delete-step-2' }
            ],
            onStepChange: () => {}
        });
    }
    
    // 填充删除预览数据
    function populateDeletePreview(data) {
        const { base, logistics, detail } = data;
        
        // 基础信息
        document.getElementById('delete-preview-logistic-num').textContent = base.logistic_num || '-';
        document.getElementById('delete-preview-date-sent').textContent = base.date_sent || '-';
        
        // 物流详细信息
        document.getElementById('delete-preview-date-eta').textContent = logistics.date_eta || '-';
        document.getElementById('delete-preview-pallets').textContent = logistics.pallets || 0;
        document.getElementById('delete-preview-weight').textContent = 
            logistics.total_weight ? `${logistics.total_weight.toFixed(2)} KG` : '-';
        document.getElementById('delete-preview-price-kg').textContent = 
            logistics.price_kg ? `¥${logistics.price_kg.toFixed(4)}` : '-';
        document.getElementById('delete-preview-total-price').textContent = 
            logistics.total_price ? `¥${logistics.total_price.toFixed(2)}` : '-';
        document.getElementById('delete-preview-usd-rmb').textContent = 
            logistics.usd_rmb ? `${logistics.usd_rmb.toFixed(4)} RMB/USD` : '-';
        document.getElementById('delete-preview-seq').textContent = logistics.seq || '-';
        document.getElementById('delete-preview-by').textContent = logistics.by || '-';
        
        // 货物明细信息
        const items = detail.items || [];
        document.getElementById('delete-preview-items-count').textContent = `${items.length} 件货物`;
        
        const tbody = document.getElementById('delete-preview-items-tbody');
        tbody.innerHTML = '';
        
        let total = 0;
        items.forEach((item, idx) => {
            const subtotal = item.quantity * item.unit_price;
            total += subtotal;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-white-50">${idx + 1}</td>
                <td class="font-monospace small">${item.po_num}</td>
                <td class="font-monospace">${item.sku}</td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-end">$${item.unit_price.toFixed(2)}</td>
                <td class="text-end text-success">$${subtotal.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('delete-preview-cargo-value').textContent = 
            `$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    }
    
    // 验证删除备注是否填写
    function validateDeleteNote() {
        const noteInput = document.getElementById('delete-note-input');
        const confirmBtn = document.getElementById('btn-delete-confirm');
        const note = noteInput.value.trim();
        
        if (note.length > 0) {
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('btn-secondary');
            confirmBtn.classList.add('btn-danger');
        } else {
            confirmBtn.disabled = true;
            confirmBtn.classList.remove('btn-danger');
            confirmBtn.classList.add('btn-secondary');
        }
    }
    
    // 确认删除发货单
    function confirmDeleteSend() {
        // 再次检查备注
        const note = document.getElementById('delete-note-input').value.trim();
        if (!note) {
            if (typeof createAndShowToast === 'function') {
                createAndShowToast('{% trans "请填写删除备注" %}', 'warning');
            }
            return;
        }
        
        // 使用密码验证
        if (typeof requestPasswordVerify === 'function') {
            requestPasswordVerify(
                'btn_send_delete',         // actionKey
                (passwords) => submitDeleteAsync(passwords),  // onSuccess，接收密码对象
                null,                      // contextEl (无需回填)
                (window.i18n?.t('js.delete_shipment') || 'Delete Shipment'),              // actionDisplayName
                (reason) => {              // onCancel
                }
            );
        } else {
            // 无密码验证，直接确认
            if (confirm('{% trans "确定要删除此发货单吗？" %}')) {
                submitDeleteAsync({});
            }
        }
    }
    
    // 异步提交删除
    function submitDeleteAsync(passwords) {
        return new Promise((resolve, reject) => {
            submitDelete(passwords, resolve, reject);
        });
    }
    
    // 提交删除
    function submitDelete(passwords, onSuccess, onError) {
        // 获取删除备注
        const deleteNote = document.getElementById('delete-note-input').value.trim();
        
        // 跳转到完成步骤
        showDeleteStep(2);
        
        // 显示处理中状态
        document.getElementById('delete-result-icon').innerHTML = `
            <div class="spinner-border text-danger mb-3" style="width: 80px; height: 80px;" role="status"></div>
        `;
        document.getElementById('delete-result-title').textContent = '{% trans "正在删除..." %}';
        document.getElementById('delete-result-message').textContent = '{% trans "请稍候，正在处理删除请求..." %}';
        
        // 构建请求体，包含密码
        const requestBody = {
            logistic_num: deleteCurrentLogisticNum,
            note: deleteNote
        };
        
        // 添加密码到请求
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                requestBody[`sec_code_${slot}`] = code;
            }
        }
        
        fetch(`{% url 'web_ui:purchase:send_mgmt_submit_delete' %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(requestBody)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // 成功
                document.getElementById('delete-result-icon').innerHTML = `
                    <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-check fa-2x text-success"></i>
                    </div>
                `;
                document.getElementById('delete-result-title').textContent = '{% trans "删除成功" %}';
                document.getElementById('delete-result-title').className = 'text-success mb-3';
                document.getElementById('delete-result-message').textContent = 
                    '{% trans "发货单" %} ' + deleteCurrentLogisticNum + ' {% trans "已成功删除。" %}';
                
                if (onSuccess) onSuccess();
            } else {
                // 失败
                document.getElementById('delete-result-icon').innerHTML = `
                    <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-times fa-2x text-danger"></i>
                    </div>
                `;
                document.getElementById('delete-result-title').textContent = '{% trans "删除失败" %}';
                document.getElementById('delete-result-title').className = 'text-danger mb-3';
                document.getElementById('delete-result-message').textContent = 
                    data.message || '{% trans "删除发货单时发生错误" %}';
                
                if (onError) onError();
            }
        })
        .catch(err => {
            // 错误
            document.getElementById('delete-result-icon').innerHTML = `
                <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-25 rounded-circle mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                </div>
            `;
            document.getElementById('delete-result-title').textContent = '{% trans "请求失败" %}';
            document.getElementById('delete-result-title').className = 'text-danger mb-3';
            document.getElementById('delete-result-message').textContent = 
                '{% trans "网络错误" %}: ' + err;
            
            if (onError) onError();
        });
    }
    
    // 显示指定步骤
    function showDeleteStep(stepNum) {
        // 隐藏所有步骤
        for (let i = 1; i <= 2; i++) {
            const el = document.getElementById(`delete-step-${i}`);
            if (el) el.style.display = 'none';
        }
        // 显示目标步骤
        const target = document.getElementById(`delete-step-${stepNum}`);
        if (target) target.style.display = 'block';
        
        // 更新向导进度条
        if (deleteWizard) {
            deleteWizard.goToStep(stepNum - 1);
        }
    }
</script>