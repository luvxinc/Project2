{% load security_tags %}
<!-- 流程5: 修改预览 -->
<div id="edit-step-5" class="wizard-step-content" style="display: none;">
    <!-- 物流参数修改预览 -->
    <div class="card bg-dark border-info border-opacity-25 mb-4" id="preview-logistics-card">
        <div class="card-header bg-info bg-opacity-10 border-0 d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-shipping-fast me-2 text-info"></i>
                <span class="text-info fw-bold" data-i18n="wizard.send_logistics">物流参数</span>
            </div>
            <span class="badge bg-info bg-opacity-25 text-info" id="preview-logistics-status" data-i18n="ui.text_1089">待确认</span>
        </div>
        <div class="card-body" id="preview-logistics-container">
            <!-- 物流参数将由JS动态填充 -->
        </div>
    </div>

    <!-- 货物明细修改预览 -->
    <div class="card bg-dark border-success border-opacity-25 mb-4" id="preview-items-card">
        <div class="card-header bg-success bg-opacity-10 border-0 d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-box me-2 text-success"></i>
                <span class="text-success fw-bold" data-i18n="ui.text_1124">货物明细修改</span>
            </div>
            <span class="badge bg-success bg-opacity-25 text-success" id="preview-items-status" data-i18n="ui.text_1089">待确认</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-dark table-sm table-hover mb-0">
                    <thead class="sticky-top" style="background: linear-gradient(135deg, rgba(25, 135, 84, 0.2), rgba(13, 202, 240, 0.1));">
                        <tr class="text-success small fw-bold">
                            <th style="width: 80px; border-bottom: 2px solid rgba(25, 135, 84, 0.5);" class="ps-3" data-i18n="ui.text_2436">变更</th>
                            <th style="border-bottom: 2px solid rgba(25, 135, 84, 0.5);" data-i18n="table.order_date">订单日期</th>
                            <th style="border-bottom: 2px solid rgba(25, 135, 84, 0.5);">SKU</th>
                            <th style="width: 60px; border-bottom: 2px solid rgba(25, 135, 84, 0.5);" class="text-center" data-i18n="common.currency">货币</th>
                            <th style="width: 80px; border-bottom: 2px solid rgba(25, 135, 84, 0.5);" class="text-end" data-i18n="common.unit_price">单价</th>
                            <th style="width: 100px; border-bottom: 2px solid rgba(25, 135, 84, 0.5);" class="text-center" data-i18n="js.ship_qty">发货量</th>
                            <th style="width: 80px; border-bottom: 2px solid rgba(25, 135, 84, 0.5);" class="text-center" data-i18n="js.round">规整</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items-tbody">
                        <!-- 货物明细将由JS动态填充 -->
                    </tbody>
                </table>
            </div>
            <div class="border-top border-secondary px-4 py-3 d-flex justify-content-between align-items-center">
                <span class="text-white-50" data-i18n="common.modify_note">修改备注</span>
                <span class="text-warning" id="preview-note">-</span>
            </div>
        </div>
    </div>

    <!-- 安全验证表单 (隐藏) -->
    <form id="edit-submit-form" class="d-none">
        {% csrf_token %}
        {% security_inputs "btn_send_modify" %}
    </form>

    <!-- 导航按钮 -->
    <div class="d-flex justify-content-between gap-3">
        <button type="button" 
                class="btn btn-outline-secondary btn-lg px-4 rounded-pill" 
                id="btn-edit-step5-back"
                onclick="goBackFromPreview()">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
        </button>
        <button type="button" 
                class="btn btn-success btn-lg px-4 rounded-pill shadow" 
                id="btn-edit-step5-confirm"
                onclick="confirmModificationWithPassword()">
            <i class="fas fa-check-circle me-2"></i><span data-i18n="modal.change_password.btn_confirm">确认修改</span>
        </button>
    </div>
</div>

<style>
    #edit-step-5 .param-item {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 10px 14px;
        transition: all 0.2s ease;
    }
    #edit-step-5 .param-item:hover {
        background: rgba(255,255,255,0.06);
    }
    #edit-step-5 .param-label {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 2px;
    }
    #edit-step-5 .param-value {
        font-size: 0.95rem;
        color: #fff;
        font-weight: 500;
    }
    #edit-step-5 .param-value.text-modified {
        color: #ffc107;
    }
    #edit-step-5 .param-value.text-original {
        color: rgba(255,255,255,0.5);
        text-decoration: line-through;
        margin-right: 8px;
    }
    #edit-step-5 .change-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
    }
    #edit-step-5 .change-add { background: rgba(25, 135, 84, 0.3); color: #198754; }
    #edit-step-5 .change-del { background: rgba(220, 53, 69, 0.3); color: #dc3545; }
    #edit-step-5 .change-mod { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
    #edit-step-5 .row-deleted { opacity: 0.5; text-decoration: line-through; }
    #edit-step-5 .row-added { background: rgba(25, 135, 84, 0.1); }
    #edit-step-5 .row-modified { background: rgba(255, 193, 7, 0.1); }
</style>

<script>
    // ========================================
    // Step5: 修改预览
    // ========================================
    
    // 渲染预览页面
    function renderPreviewStep() {
        renderPreviewLogistics();
        renderPreviewItems();
    }
    
    // 渲染物流参数预览
    function renderPreviewLogistics() {
        const container = document.getElementById('preview-logistics-container');
        const statusBadge = document.getElementById('preview-logistics-status');
        
        // 获取原始数据
        const orig = editOriginalData?.logistics || {};
        
        // 定义显示字段
        const fields = [
            { key: 'date_eta', label: (window.i18n?.t('js.expected_arrival') || 'Expected Arrival'), format: v => v || '-' },
            { key: 'pallets', label: (window.i18n?.t('js.pallet_count') || 'Pallet Count'), format: v => v || 0 },
            { key: 'price_kg', label: (window.i18n?.t('js.logistics_price') || 'Logistics Price (RMB/KG)'), format: v => '¥' + formatPreviewNumber(v, 4) },
            { key: 'total_weight', label: (window.i18n?.t('js.total_weight') || 'Total Weight'), format: v => formatPreviewNumber(v, 2) + ' KG' },
            { key: 'total_price', label: (window.i18n?.t('js.logistics_total') || 'Logistics Total'), format: v => '¥' + formatPreviewNumber(v, 2) },
            { key: 'usd_rmb', label: (window.i18n?.t('table.settlement_rate') || 'Settlement Rate'), format: v => formatPreviewNumber(v, 4) + ' RMB/USD' }
        ];
        
        if (editSkippedLogistics) {
            // 跳过了物流修改 - 显示原有数据
            let html = '<div class="row g-3">';
            
            fields.forEach(f => {
                html += `
                    <div class="col-md-4">
                        <div class="param-item">
                            <div class="param-label">${f.label}</div>
                            <div class="param-value text-white-50">${f.format(orig[f.key])}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            statusBadge.textContent = (window.i18n?.t('js.not_modified') || 'Not Modified');
            statusBadge.className = 'badge bg-secondary bg-opacity-50 text-white';
            return;
        }
        
        // 收集物流参数变更
        if (typeof collectLogisticsData === 'function') {
            const logisticsData = collectLogisticsData();
            
            let hasChanges = false;
            let html = '<div class="row g-3">';
            
            fields.forEach(f => {
                const origVal = orig[f.key];
                const newVal = logisticsData[f.key];
                let isChanged = false;
                
                if (f.key === 'date_eta') {
                    isChanged = newVal !== (origVal || '');
                } else if (f.key === 'pallets') {
                    isChanged = newVal !== (origVal || 0);
                } else {
                    isChanged = Math.abs((newVal || 0) - (origVal || 0)) > 0.0001;
                }
                
                if (isChanged) hasChanges = true;
                
                if (isChanged) {
                    // 有修改 - 显示修改前/修改后标签
                    html += `
                        <div class="col-md-4">
                            <div class="param-item param-modified">
                                <div class="param-label">${f.label} <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;" data-i18n="ui.text_1127">已修改</span></div>
                                <div class="d-flex flex-column gap-1">
                                    <div class="text-white-50 small">
                                        <span class="badge bg-secondary me-1" style="font-size: 0.6rem;" data-i18n="ui.text_1097">修改前</span>
                                        <span class="text-decoration-line-through">${f.format(origVal)}</span>
                                    </div>
                                    <div class="text-warning">
                                        <span class="badge bg-warning text-dark me-1" style="font-size: 0.6rem;" data-i18n="ui.text_1098">修改后</span>
                                        <strong>${f.format(newVal)}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // 无修改 - 显示原值
                    html += `
                        <div class="col-md-4">
                            <div class="param-item">
                                <div class="param-label">${f.label}</div>
                                <div class="param-value">${f.format(newVal)}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            if (hasChanges) {
                statusBadge.textContent = (window.i18n?.t('js.modified') || 'Modified');
                statusBadge.className = 'badge bg-warning bg-opacity-25 text-warning';
            } else {
                statusBadge.textContent = (window.i18n?.t('js.no_changes') || 'No Changes');
                statusBadge.className = 'badge bg-secondary bg-opacity-25 text-white-50';
            }
        }
    }
    
    // 渲染货物明细预览
    function renderPreviewItems() {
        const tbody = document.getElementById('preview-items-tbody');
        const statusBadge = document.getElementById('preview-items-status');
        const noteEl = document.getElementById('preview-note');
        
        // 显示备注
        const note = document.getElementById('edit-items-note')?.value?.trim() || '-';
        noteEl.textContent = note;
        
        if (editSkippedItems) {
            // 跳过了明细修改 - 显示原有数据
            if (step3OriginalItems && step3OriginalItems.length > 0) {
                let html = '';
                step3OriginalItems.forEach(item => {
                    html += `
                        <tr>
                            <td class="ps-3"><span class="change-badge" style="background: rgba(108, 117, 125, 0.3); color: #6c757d;" data-i18n="ui.text_1130">原有</span></td>
                            <td class="small text-white-50">${item.po_date || '-'}</td>
                            <td class="font-monospace small text-white-50">${item.po_sku || '-'}</td>
                            <td class="text-center">${getCurrencyBadge(item.currency)}</td>
                            <td class="text-end small text-white-50">${formatPreviewNumber(item.po_price, 2)}</td>
                            <td class="text-center text-white-50">${item.sent_qty || 0}</td>
                            <td class="text-center text-white-50">${item.is_adjusted ? '<i class="fas fa-check"></i>' : '-'}</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="text-center py-4 text-white-50">
                        <i class="fas fa-inbox me-2"></i>无货物明细
                    </td></tr>
                `;
            }
            statusBadge.textContent = (window.i18n?.t('js.not_modified') || 'Not Modified');
            statusBadge.className = 'badge bg-secondary bg-opacity-50 text-white';
            return;
        }
        
        // 收集变更的行
        const changedRows = [];
        
        // 检查新增的行
        step3Items.filter(i => i.is_new && !i.is_deleted).forEach(item => {
            changedRows.push({ type: 'add', item: item });
        });
        
        // 检查删除的原始行
        step3Items.filter(i => i.is_deleted && !i.is_new).forEach(item => {
            changedRows.push({ type: 'del', item: item });
        });
        
        // 检查修改的行
        step3Items.filter(i => !i.is_new && !i.is_deleted).forEach(item => {
            if (step3OriginalItems && step3OriginalItems.length > 0) {
                const orig = step3OriginalItems.find(o => 
                    o.po_num === item.po_num && 
                    o.po_sku === item.po_sku && 
                    Math.abs((o.po_price || 0) - (item.po_price || 0)) < 0.001
                );
                if (orig) {
                    if (orig.sent_qty !== item.sent_qty || orig.is_adjusted !== item.is_adjusted) {
                        changedRows.push({ type: 'mod', item: item, orig: orig });
                    }
                }
            }
        });
        
        if (changedRows.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="7" class="text-center py-4 text-white-50">
                    <i class="fas fa-info-circle me-2"></i>无货物明细修改
                </td></tr>
            `;
            statusBadge.textContent = (window.i18n?.t('js.no_changes') || 'No Changes');
            statusBadge.className = 'badge bg-secondary bg-opacity-25 text-white-50';
            return;
        }
        
        let html = '';
        changedRows.forEach(row => {
            const item = row.item;
            let changeLabel = '';
            let rowClass = '';
            
            if (row.type === 'add') {
                changeLabel = '<span class="change-badge change-add" data-i18n="ui.text_722">新增</span>';
                rowClass = 'row-added';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="ps-3">${changeLabel}</td>
                        <td class="small">${item.po_date || '-'}</td>
                        <td class="font-monospace small">${item.po_sku || '-'}</td>
                        <td class="text-center">${getCurrencyBadge(item.currency)}</td>
                        <td class="text-end small">${formatPreviewNumber(item.po_price, 2)}</td>
                        <td class="text-center">${item.sent_qty || 0}</td>
                        <td class="text-center">${item.is_adjusted ? '<i class="fas fa-check text-success"></i>' : '-'}</td>
                    </tr>
                `;
            } else if (row.type === 'del') {
                changeLabel = '<span class="change-badge change-del" data-i18n="common.delete">删除</span>';
                rowClass = 'row-deleted';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="ps-3">${changeLabel}</td>
                        <td class="small">${item.po_date || '-'}</td>
                        <td class="font-monospace small">${item.po_sku || '-'}</td>
                        <td class="text-center">${getCurrencyBadge(item.currency)}</td>
                        <td class="text-end small">${formatPreviewNumber(item.po_price, 2)}</td>
                        <td class="text-center">${item.sent_qty || 0}</td>
                        <td class="text-center">${item.is_adjusted ? '<i class="fas fa-check"></i>' : '-'}</td>
                    </tr>
                `;
            } else {
                // 修改类型 - 显示修改前/修改后两行
                changeLabel = '<span class="change-badge change-mod" data-i18n="ui.text_1133">修改</span>';
                rowClass = 'row-modified';
                
                const orig = row.orig;
                const qtyChanged = orig.sent_qty !== item.sent_qty;
                const adjustedChanged = orig.is_adjusted !== item.is_adjusted;
                
                // 修改前行
                html += `
                    <tr class="row-modified-before">
                        <td class="ps-3" rowspan="2">
                            ${changeLabel}
                        </td>
                        <td class="small text-white-50" rowspan="2">${item.po_date || '-'}</td>
                        <td class="font-monospace small text-white-50" rowspan="2">${item.po_sku || '-'}</td>
                        <td class="text-center" rowspan="2">${getCurrencyBadge(item.currency)}</td>
                        <td class="text-end small text-white-50" rowspan="2">${formatPreviewNumber(item.po_price, 2)}</td>
                        <td class="text-center">
                            <span class="badge bg-secondary me-1" style="font-size: 0.6rem;" data-i18n="ui.text_1097">修改前</span>
                            <span class="text-decoration-line-through text-white-50">${orig.sent_qty || 0}</span>
                        </td>
                        <td class="text-center">
                            ${adjustedChanged ? `<span class="badge bg-secondary me-1" style="font-size: 0.6rem;" data-i18n="ui.text_1097">修改前</span>
                            <span class="text-decoration-line-through text-white-50">${orig.is_adjusted ? '<i class="fas fa-check"></i>' : '-'}</span>` : 
                            (item.is_adjusted ? '<i class="fas fa-check text-success"></i>' : '-')}
                        </td>
                    </tr>
                    <tr class="row-modified-after">
                        <td class="text-center">
                            <span class="badge bg-warning text-dark me-1" style="font-size: 0.6rem;" data-i18n="ui.text_1098">修改后</span>
                            <strong class="text-warning">${item.sent_qty || 0}</strong>
                        </td>
                        <td class="text-center">
                            ${adjustedChanged ? `<span class="badge bg-warning text-dark me-1" style="font-size: 0.6rem;" data-i18n="ui.text_1098">修改后</span>
                            <strong class="text-warning">${item.is_adjusted ? '<i class="fas fa-check"></i>' : '-'}</strong>` : ''}
                        </td>
                    </tr>
                `;
            }
        });
        
        tbody.innerHTML = html;
        statusBadge.textContent = `${changedRows.length} 项变更`;
        statusBadge.className = 'badge bg-warning bg-opacity-25 text-warning';
    }
    
    // 格式化数字
    function formatPreviewNumber(num, decimals = 2) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return parseFloat(parseFloat(num).toFixed(decimals)).toString();
    }
    
    // 生成货币标签
    function getCurrencyBadge(currency) {
        if (currency === 'USD') {
            return '<span class="badge bg-success bg-opacity-50 text-success">USD</span>';
        } else {
            return '<span class="badge bg-warning bg-opacity-50 text-warning">RMB</span>';
        }
    }
    
    // 返回修改
    function goBackFromPreview() {
        if (editSkippedLogistics) {
            // 跳过了物流，返回明细
            showEditStep(3);
        } else if (editSkippedItems) {
            // 跳过了明细，返回物流验证
            showEditStep(2);
        } else {
            // 两者都有可能修改，返回验证步骤
            showEditStep(4);
        }
    }
    
    // 存储验证通过的密码（用于Step6提交）
    let sendEditVerifiedPasswords = null;
    
    // 确认修改（带密码验证）
    function confirmModificationWithPassword() {
        const btn = document.getElementById('btn-edit-step5-confirm');
        
        if (typeof requestPasswordVerify === 'function') {
            requestPasswordVerify(
                'btn_send_modify',      // action key
                function(passwords) {
                    // 密码验证成功，存储密码并跳转到Step6执行提交
                    sendEditVerifiedPasswords = passwords;
                    showEditStep(6);
                },
                btn,                     // 按钮元素
                (window.i18n?.t('js.edit_shipment') || 'Edit Shipment'),             // 操作描述
                function() {
                    // 用户取消，不做任何操作
                }
            );
        } else {
            // 如果密码验证函数不可用，显示警告
            GlobalModal.showError({
                title: (window.i18n?.t('js.security_not_available') || 'Security not available'),
                message: (window.i18n?.t('js.cannot_verify_password') || 'Cannot verify password, refresh.')
            });
        }
    }
</script>