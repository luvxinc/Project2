<!-- 流程3: 修改物流单货物明细 -->
<div id="edit-step-3" class="wizard-step-content" style="display: none;">
    <!-- 操作须知 -->
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-start">
            <i class="fas fa-info-circle me-3 mt-1 text-info"></i>
            <div>
                <strong class="text-info" data-i18n="common.operation_notes">操作须知</strong>
                <ul class="mb-0 mt-2 ps-3">
                    <li data-i18n="desc.d156">此处可修改每个货物的<strong data-i18n="table.shipped_qty">发货数量</strong>，并选择是否<strong
                            data-i18n="ui.text_1103">规整订单</strong>（将订单未发量调整为0）</li>
                    <li data-i18n="desc.d157">点击<strong data-i18n="common.delete">删除</strong>按钮可移除发货行（数量设为0），点击<strong
                            data-i18n="ui.text_1105">恢复</strong>可撤销删除</li>
                    <li data-i18n="desc.d158">点击<strong data-i18n="ui.text_1106">「新增发货」</strong>可从已有订单中添加新的发货货物</li>
                    <li data-i18n="desc.d159"><strong class="text-warning"
                            data-i18n="ui.text_1107">未发量为负数</strong>时会显示橙色高亮提示，表示发货量超过订单剩余量</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary mb-4">
        <div
            class="card-header bg-success bg-opacity-10 border-secondary d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-boxes me-2 text-success"></i>
                <span class="text-white" data-i18n="ui.text_1108">修改物流单货物明细</span>
                <span class="badge bg-success ms-2" id="edit-items-current-seq">-</span>
            </div>
            <button class="btn btn-outline-success btn-sm" onclick="addNewShippingRow()">
                <i class="fas fa-plus me-1"></i><span data-i18n="ui.icon_3348">新增发货</span>
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-dark table-hover mb-0" id="edit-items-table">
                    <thead class="sticky-top" style="background: rgba(40, 45, 55, 1);">
                        <tr class="text-white-50 small">
                            <th style="width: 100px;" data-i18n="table.order_date">订单日期</th>
                            <th>SKU</th>
                            <th class="text-center" style="width: 60px;" data-i18n="common.currency">货币</th>
                            <th class="text-end" style="width: 80px;" data-i18n="common.unit_price">单价</th>
                            <th class="text-center" style="width: 70px;" data-i18n="ui.text_2271">订货量</th>
                            <th class="text-center" style="width: 70px;" data-i18n="ui.text_2423">已发量</th>
                            <th class="text-center" style="width: 100px;" data-i18n="ui.text_2424">新发货量</th>
                            <th class="text-center" style="width: 80px;" data-i18n="js.remaining_qty">未发量</th>
                            <th class="text-center" style="width: 100px;" data-i18n="ui.text_1103">规整订单</th>
                            <th class="text-center" style="width: 80px;" data-i18n="common.operation">操作</th>
                        </tr>
                    </thead>
                    <tbody id="edit-items-tbody">
                        <!-- JS动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 备注区域 -->
    <div class="mb-4 p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50">
        <div class="text-white-50 small mb-2"><span data-i18n="common.modify_note">修改备注</span> <span class="text-danger"
                data-i18n="ui.text_660">*必填</span></div>
        <textarea class="form-control form-control-sm bg-dark border-warning text-white" id="edit-items-note" rows="2"
            data-i18n-placeholder="form.placeholder.generic_8" placeholder="请输入修改原因和备注..."></textarea>
    </div>

    <div class="d-flex justify-content-between gap-3">
        <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="showEditStep(1)">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="ui.icon_3349">返回修改物流</span>
        </button>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-warning btn-lg px-4 rounded-pill" onclick="editItemsSkip()">
                <i class="fas fa-forward me-2"></i><span data-i18n="ui.icon_3218">跳过明细修改</span>
            </button>
            <button class="btn btn-success btn-lg px-4 rounded-pill" id="btn-edit-step3-next"
                onclick="goToStep4Verify()">
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.next">下一步</span>
            </button>
        </div>
    </div>
</div>

<style>
    /* 货物明细编辑样式 */
    #edit-items-table input[type="number"] {
        width: 80px;
        text-align: center;
    }

    #edit-items-table .deleted-row {
        opacity: 0.5;
        text-decoration: line-through;
    }

    #edit-items-table .deleted-row td {
        color: rgba(255, 255, 255, 0.4) !important;
    }

    #edit-items-table .unshipped-negative {
        color: #ff9800 !important;
        font-weight: bold;
        animation: orangePulse 1.5s ease-in-out infinite;
    }

    @keyframes orangePulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4);
        }

        50% {
            box-shadow: 0 0 10px 3px rgba(255, 152, 0, 0.3);
        }
    }

    .new-row-select {
        min-width: 120px;
    }

    /* UI Toggle 开关样式 */
    .ui-toggle {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
        margin: 0;
    }

    .ui-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .ui-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(108, 117, 125, 0.5);
        transition: .3s;
        border-radius: 20px;
    }

    .ui-toggle-slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .3s;
        border-radius: 50%;
    }

    .ui-toggle input:checked+.ui-toggle-slider {
        background-color: #198754;
    }

    .ui-toggle input:checked+.ui-toggle-slider:before {
        transform: translateX(20px);
    }

    .ui-toggle input:disabled+.ui-toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<script>
    // ========================================
    // Step3: 货物明细编辑状态
    // ========================================
    let step3Items = [];            // 当前货物列表
    let step3OriginalItems = [];    // 原始货物列表（用于Step4对比）
    let step3NewRowId = 1000;       // 新增行的ID起始值

    // 加载货物明细
    function loadItemsForEdit(logisticNum) {
        const tbody = document.getElementById('edit-items-tbody');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</td></tr>';

        fetch(`{% url 'web_ui:purchase:send_mgmt_items_for_edit' %}?logistic_num=${encodeURIComponent(logisticNum)}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-danger">${data.message}</td></tr>`;
                    return;
                }

                document.getElementById('edit-items-current-seq').textContent = data.data.current_seq || 'S01';
                step3Items = data.data.items || [];
                // 深拷贝保存原始数据
                step3OriginalItems = JSON.parse(JSON.stringify(step3Items));
                renderItemsTable();
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-danger">${(window.i18n?.t('ui.text_2491') || 'Load Failed')}: ${err}</td></tr>`;
            });
    }

    // 渲染货物表格
    function renderItemsTable() {
        const tbody = document.getElementById('edit-items-tbody');

        if (step3Items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-white-50"><i class="fas fa-inbox me-2"></i>暂无货物记录</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        step3Items.forEach((item, idx) => {
            const tr = createItemRow(item, idx);
            tbody.appendChild(tr);
        });
    }

    // 创建表格行
    function createItemRow(item, idx) {
        const tr = document.createElement('tr');
        tr.dataset.rowId = item.row_id;

        if (item.is_deleted) {
            tr.classList.add('deleted-row');
        }

        // 计算未发量
        const unshippedQty = item.ordered_qty - item.already_sent - (item.sent_qty || 0);
        const isNegative = unshippedQty < 0;

        // 是否为新增行（需要选择器）
        const isNewRow = item.is_new || false;

        if (isNewRow) {
            tr.innerHTML = createNewRowHtml(item, idx);
        } else {
            // 货币标签样式
            const currencyBadge = item.currency === 'USD'
                ? '<span class="badge bg-success bg-opacity-50 text-success">USD</span>'
                : '<span class="badge bg-warning bg-opacity-50 text-warning">RMB</span>';

            tr.innerHTML = `
                <td class="small">${item.po_date || '-'}</td>
                <td class="font-monospace small">${item.po_sku || '-'}</td>
                <td class="text-center">${currencyBadge}</td>
                <td class="text-end small">${formatNumber(item.po_price, 2)}</td>
                <td class="text-center">${item.ordered_qty || 0}</td>
                <td class="text-center">${item.already_sent || 0}</td>
                <td class="text-center">
                    <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white" 
                           value="${item.sent_qty || 0}" min="1" step="1"
                           onchange="updateItemSentQty(${item.row_id}, this.value)"
                           ${item.is_deleted ? 'disabled' : ''}>
                </td>
                <td class="text-center ${isNegative ? 'unshipped-negative' : ''}" id="unshipped-${item.row_id}">
                    ${unshippedQty}
                </td>
                <td class="text-center">
                    <label class="ui-toggle" data-i18n-title="tooltip.t9120" title="${(item.sent_qty || 0) === 0 ? (window.i18n?.t('js.cannot_regularize_zero') || 'Cannot regularize when qty is 0') : ''}">
                        <input type="checkbox" ${item.is_adjusted ? 'checked' : ''} 
                               onchange="updateItemAdjusted(${item.row_id}, this.checked)"
                               ${item.is_deleted || (item.sent_qty || 0) === 0 ? 'disabled' : ''}>
                        <span class="ui-toggle-slider"></span>
                    </label>
                </td>
                <td class="text-center">
                    ${item.is_deleted
                    ? `<button class="btn btn-outline-success btn-sm" onclick="restoreItem(${item.row_id})" data-i18n-title="tooltip.t1329" title="Restore"><i class="fas fa-undo"></i></button>`
                    : `<button class="btn btn-outline-danger btn-sm" onclick="deleteItem(${item.row_id})" data-i18n-title="js.delete" title="Delete"><i class="fas fa-trash"></i></button>`
                }
                </td>
            `;
        }

        return tr;
    }

    // 创建新增行HTML
    function createNewRowHtml(item, idx) {
        // 货币标签样式（新增行时可能还没有货币信息）
        let currencyBadge = '<span class="badge bg-secondary bg-opacity-50 text-white-50">-</span>';
        if (item.currency) {
            currencyBadge = item.currency === 'USD'
                ? '<span class="badge bg-success bg-opacity-50 text-success">USD</span>'
                : '<span class="badge bg-warning bg-opacity-50 text-warning">RMB</span>';
        }

        return `
            <td class="small">
                ${item.po_date ? item.po_date : '<span class="text-white-50">-</span>'}
            </td>
            <td class="font-monospace small">
                ${item.po_sku
                ? item.po_sku
                : `<select class="form-select form-select-sm bg-dark border-secondary text-white new-row-select" 
                              id="sku-select-${item.row_id}" onchange="onSkuSelected(${item.row_id}, this.value)" disabled>
                         <option value="" data-i18n="option.o3348">选择SKU</option>
                       </select>`
            }
            </td>
            <td class="text-center" id="currency-${item.row_id}">${currencyBadge}</td>
            <td class="text-end small">
                ${item.po_price !== undefined && item.po_price !== null
                ? formatNumber(item.po_price, 2)
                : `<select class="form-select form-select-sm bg-dark border-secondary text-white new-row-select" 
                              id="price-select-${item.row_id}" onchange="onPriceSelected(${item.row_id}, this.value)" disabled>
                         <option value="" data-i18n="option.o4483">选择价格</option>
                       </select>`
            }
            </td>
            <td class="text-center">${item.ordered_qty || '-'}</td>
            <td class="text-center">${item.already_sent !== undefined ? item.already_sent : '-'}</td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm bg-dark border-secondary text-white" 
                       id="sent-input-${item.row_id}" value="${item.sent_qty || ''}" min="1" step="1"
                       onchange="updateItemSentQty(${item.row_id}, this.value)"
                       ${!item.po_price ? 'disabled' : ''}>
            </td>
            <td class="text-center" id="unshipped-${item.row_id}">-</td>
            <td class="text-center">
                <label class="ui-toggle" data-i18n-title="tooltip.t9120" title="${(item.sent_qty || 0) === 0 ? (window.i18n?.t('js.cannot_regularize_zero') || 'Cannot regularize when qty is 0') : ''}">
                    <input type="checkbox" id="adjusted-${item.row_id}" 
                           ${item.is_adjusted ? 'checked' : ''} 
                           onchange="updateItemAdjusted(${item.row_id}, this.checked)"
                           ${!item.po_price || (item.sent_qty || 0) === 0 ? 'disabled' : ''}>
                    <span class="ui-toggle-slider"></span>
                </label>
            </td>
            <td class="text-center">
                <button class="btn btn-outline-danger btn-sm" onclick="removeNewRow(${item.row_id})" data-i18n-title="tooltip.t1108" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
    }

    // 更新发货量
    function updateItemSentQty(rowId, value) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (!item) return;

        const qty = parseInt(value) || 0;
        if (qty <= 0) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.input_error') || 'Input Error'),
                message: (window.i18n?.t('js.qty_positive_int') || 'Qty must be positive integer')
            });
            return;
        }

        item.sent_qty = qty;

        // 更新未发量显示
        const unshipped = item.ordered_qty - item.already_sent - qty;
        const cell = document.getElementById(`unshipped-${rowId}`);
        if (cell) {
            cell.textContent = unshipped;
            cell.classList.toggle('unshipped-negative', unshipped < 0);
        }

        // 发货量为0时自动取消规整
        if (qty === 0 && item.is_adjusted) {
            item.is_adjusted = false;
        }

        // 重新渲染以更新checkbox状态
        renderItemsTable();
        refreshAvailablePOs();
    }

    // 更新规整状态
    function updateItemAdjusted(rowId, checked) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (item) {
            // 发货量为0时不允许规整
            if (checked && (item.sent_qty || 0) === 0) {
                GlobalModal.showError({
                    title: (window.i18n?.t('js.cannot_regularize') || 'Cannot Regularize'),
                    message: (window.i18n?.t('js.zero_qty_no_regularize') || 'Zero qty cannot be regularized.')
                });
                return;
            }
            item.is_adjusted = checked;
            refreshAvailablePOs();
        }
    }

    // 删除行 - 使用GlobalModal确认
    function deleteItem(rowId) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (!item) return;

        GlobalModal.showConfirm({
            title: (window.i18n?.t('js.confirm_delete') || 'Confirm Delete'),
            message: `确定要删除此发货行吗？<br><small class="text-muted" data-i18n="ui.text_1110">SKU: ${item.po_sku || '-'}, 发货量: ${item.sent_qty || 0}</small>`,
            confirmLabel: (window.i18n?.t('js.confirm_delete') || 'Confirm Delete'),
            confirmClass: 'btn-danger',
            onConfirm: function () {
                item.is_deleted = true;
                renderItemsTable();
                refreshAvailablePOs();
            }
        });
    }

    // 恢复行
    function restoreItem(rowId) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (item) {
            item.is_deleted = false;
            renderItemsTable();
            refreshAvailablePOs();
        }
    }

    // 移除新增行
    function removeNewRow(rowId) {
        step3Items = step3Items.filter(i => i.row_id !== rowId);
        renderItemsTable();
        refreshAvailablePOs();
    }

    // 新增发货行
    function addNewShippingRow() {
        // 检查是否有未完成的新增行
        const incompleteRow = step3Items.find(i => i.is_new && (!i.po_num || !i.po_sku || !i.po_price || !i.sent_qty));
        if (incompleteRow) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.operation_hint') || 'Operation Hint'),
                message: (window.i18n?.t('js.complete_new_row') || 'Complete current new row first')
            });
            return;
        }

        const newItem = {
            row_id: step3NewRowId++,
            is_new: true,
            po_num: null,
            po_date: null,
            po_sku: null,
            po_price: null,
            ordered_qty: null,
            already_sent: null,
            sent_qty: null,
            is_adjusted: false,
            is_deleted: false
        };

        step3Items.push(newItem);
        renderItemsTable();

        // 加载订单下拉菜单
        loadAvailablePOs(newItem.row_id);
    }

    // 获取排除记录（用于动态过滤）
    function getExcludedRecords() {
        return step3Items
            .filter(i => !i.is_deleted && !i.is_new)
            .filter(i => {
                const unshipped = i.ordered_qty - i.already_sent - (i.sent_qty || 0);
                return unshipped === 0 || i.is_adjusted;
            })
            .map(i => ({
                po_num: i.po_num,
                po_sku: i.po_sku,
                po_price: i.po_price,
                unshipped_qty: i.ordered_qty - i.already_sent - (i.sent_qty || 0),
                is_adjusted: i.is_adjusted
            }));
    }

    // 加载可用订单列表
    function loadAvailablePOs(rowId) {
        const excluded = JSON.stringify(getExcludedRecords());

        // 创建订单选择器
        const item = step3Items.find(i => i.row_id === rowId);
        if (!item) return;

        // 找到该行的第一个td，插入选择器
        renderItemsTable();

        // 延迟加载订单数据（等DOM渲染完成）
        setTimeout(() => {
            const firstTd = document.querySelector(`tr[data-row-id="${rowId}"] td:first-child`);
            if (firstTd) {
                firstTd.innerHTML = `
                    <select class="form-select form-select-sm bg-dark border-warning text-white new-row-select"
                            id="po-select-${rowId}" onchange="onPoSelected(${rowId}, this.value)">
                        <option value="" data-i18n="common.loading">加载中...</option>
                    </select>
                `;

                fetch(`{% url 'web_ui:purchase:send_mgmt_available_po_list' %}?excluded_records=${encodeURIComponent(excluded)}`)
                    .then(r => r.json())
                    .then(data => {
                        const select = document.getElementById(`po-select-${rowId}`);
                        if (!select) return;

                        if (!data.success || !data.data.length) {
                            select.innerHTML = '<option value="" data-i18n="option.o1335">无可用订单</option>';
                            return;
                        }

                        select.innerHTML = '<option value="" data-i18n="option.o397">选择订单</option>' +
                            data.data.map(po => `<option value="${po.po_num}" data-date="${po.po_date}" data-currency="${po.currency || 'RMB'}">${po.po_num}</option>`).join('');
                    });
            }
        }, 50);
    }

    // 选择订单后
    function onPoSelected(rowId, poNum) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (!item || !poNum) return;

        item.po_num = poNum;

        // 获取日期和货币
        const select = document.getElementById(`po-select-${rowId}`);
        const option = select?.querySelector(`option[value="${poNum}"]`);
        item.po_date = option?.dataset.date || '';
        item.currency = option?.dataset.currency || 'RMB';

        // 更新货币tag显示
        const currencyCell = document.getElementById(`currency-${rowId}`);
        if (currencyCell) {
            const currencyBadge = item.currency === 'USD'
                ? '<span class="badge bg-success bg-opacity-50 text-success">USD</span>'
                : '<span class="badge bg-warning bg-opacity-50 text-warning">RMB</span>';
            currencyCell.innerHTML = currencyBadge;
        }

        // 加载SKU列表
        loadAvailableSKUs(rowId, poNum);
    }

    // 加载SKU列表
    function loadAvailableSKUs(rowId, poNum) {
        const excluded = JSON.stringify(getExcludedRecords());
        const skuSelect = document.getElementById(`sku-select-${rowId}`);

        if (!skuSelect) {
            // 刷新渲染
            renderItemsTable();
            setTimeout(() => loadAvailableSKUs(rowId, poNum), 50);
            return;
        }

        skuSelect.disabled = false;
        skuSelect.innerHTML = '<option value="" data-i18n="common.loading">加载中...</option>';

        fetch(`{% url 'web_ui:purchase:send_mgmt_available_sku_list' %}?po_num=${encodeURIComponent(poNum)}&excluded_records=${encodeURIComponent(excluded)}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success || !data.data.length) {
                    skuSelect.innerHTML = '<option value="" data-i18n="option.o9291">无可用SKU</option>';
                    return;
                }

                skuSelect.innerHTML = '<option value="" data-i18n="option.o3348">选择SKU</option>' +
                    data.data.map(sku => `<option value="${sku}">${sku}</option>`).join('');
            });
    }

    // 选择SKU后
    function onSkuSelected(rowId, sku) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (!item || !sku) return;

        item.po_sku = sku;

        // 加载价格列表
        loadAvailablePrices(rowId, item.po_num, sku);
    }

    // 加载价格列表
    function loadAvailablePrices(rowId, poNum, sku) {
        const excluded = JSON.stringify(getExcludedRecords());

        fetch(`{% url 'web_ui:purchase:send_mgmt_available_price_list' %}?po_num=${encodeURIComponent(poNum)}&po_sku=${encodeURIComponent(sku)}&excluded_records=${encodeURIComponent(excluded)}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;

                const item = step3Items.find(i => i.row_id === rowId);
                if (!item) return;

                if (data.data.is_single && data.data.single_price) {
                    // 只有一个价格，自动填充
                    const priceData = data.data.single_price;
                    item.po_price = priceData.price;
                    item.ordered_qty = priceData.ordered_qty;
                    item.already_sent = priceData.sent_qty;
                    renderItemsTable();

                    // 启用发货量输入
                    setTimeout(() => {
                        const input = document.getElementById(`sent-input-${rowId}`);
                        if (input) input.disabled = false;
                        const adjInput = document.getElementById(`adjusted-${rowId}`);
                        if (adjInput) adjInput.disabled = false;
                    }, 50);
                } else {
                    // 多个价格，显示选择器
                    renderItemsTable();
                    setTimeout(() => {
                        const priceSelect = document.getElementById(`price-select-${rowId}`);
                        if (priceSelect && data.data.prices.length) {
                            priceSelect.disabled = false;
                            priceSelect.innerHTML = '<option value="" data-i18n="option.o4483">选择价格</option>' +
                                data.data.prices.map(p => `<option value="${p.price}" data-ordered="${p.ordered_qty}" data-sent="${p.sent_qty}">${formatNumber(p.price, 2)}</option>`).join('');
                        }
                    }, 50);
                }
            });
    }

    // 选择价格后
    function onPriceSelected(rowId, price) {
        const item = step3Items.find(i => i.row_id === rowId);
        if (!item || !price) return;

        const select = document.getElementById(`price-select-${rowId}`);
        const option = select?.querySelector(`option[value="${price}"]`);

        item.po_price = parseFloat(price);
        item.ordered_qty = parseInt(option?.dataset.ordered) || 0;
        item.already_sent = parseInt(option?.dataset.sent) || 0;

        renderItemsTable();

        // 启用发货量输入
        setTimeout(() => {
            const input = document.getElementById(`sent-input-${rowId}`);
            if (input) input.disabled = false;
            const adjInput = document.getElementById(`adjusted-${rowId}`);
            if (adjInput) adjInput.disabled = false;
        }, 50);
    }

    // 刷新可用PO列表（动态更新）
    function refreshAvailablePOs() {
        // 如果有新增行需要刷新其选项
        // 暂时简化处理，不做实时刷新
    }

    // 跳过明细修改 -> 跳转到预览页面
    function editItemsSkip() {
        // 检查是否已跳过物流修改
        if (editSkippedLogistics) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.cannot_skip') || 'Cannot Skip'),
                message: '您已跳过了物流修改，不能同时跳过货物明细修改。<br><small class="text-muted" data-i18n="ui.text_1054">至少需要修改物流参数或货物明细中的一项。</small>'
            });
            return;
        }

        editSkippedItems = true;
        showEditStep(5);
    }

    // 前往Step4验证步骤
    function goToStep4Verify() {
        const note = document.getElementById('edit-items-note')?.value?.trim();

        // 前端简单验证
        if (!note) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.fill_required') || 'Fill Required'),
                message: (window.i18n?.t('js.fill_edit_notes') || 'Fill Edit Notes')
            });
            return;
        }

        if (note === (window.i18n?.t('js.original_shipment') || 'Original Shipment')) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.notes_error') || 'Notes Error'),
                message: '修改备注不能为(window.i18n?.t('js.original_shipment') || 'Original Shipment')'
            });
            return;
        }

        // 过滤有效记录
        const validItems = step3Items
            .filter(i => !i.is_deleted)
            .filter(i => i.po_num && i.po_sku && i.po_price !== null && i.sent_qty > 0);

        if (validItems.length === 0) {
            GlobalModal.showError({
                title: (window.i18n?.t('js.data_error') || 'Data Error'),
                message: (window.i18n?.t('js.need_one_valid_shipment') || 'Need at least one valid shipment')
            });
            return;
        }

        // 跳转到Step4验证
        showEditStep(4);
    }

    // 格式化数字
    function formatNumber(num, decimals = 2) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return parseFloat(parseFloat(num).toFixed(decimals)).toString();
    }
</script>