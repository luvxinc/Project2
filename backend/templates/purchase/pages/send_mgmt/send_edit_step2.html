<!-- 流程2: 验证物流参数 -->
<div id="edit-step-2" class="wizard-step-content" style="display: none;">
    <!-- 物流参数名片式展示 -->
    <div class="card mb-4 state-normal" id="edit-params-validation-card">
        <div class="card-header border-0 d-flex justify-content-between align-items-center">
            <div>
                <i class="fa-solid fa-shield-halved me-2 text-info" id="edit-params-validation-icon"></i>
                <span id="edit-params-validation-title" class="text-info" data-i18n="ui.text_1091">物流参数验证</span>
            </div>
            <span class="badge bg-warning bg-opacity-25 text-warning" id="edit-strategy-type-badge" data-i18n="ui.text_1092">修改物流</span>
        </div>
        <div class="card-body">
            <!-- 参数信息名片式展示 -->
            <div class="row g-3" id="edit-params-summary-content">
                <!-- 预计到货日期 -->
                <div class="col-6 col-md-4">
                    <div class="p-3 rounded bg-black bg-opacity-25 verify-param-cell" id="edit-verify-cell-date-eta">
                        <div class="text-white-50 small mb-1">
                            预计到货日期 <i class="fas fa-info-circle ms-1"></i>
                        </div>
                        <div class="text-info fw-bold" id="edit-verify-date-eta">-</div>
                    </div>
                </div>
                <!-- 托盘数 -->
                <div class="col-6 col-md-4">
                    <div class="p-3 rounded bg-black bg-opacity-25 verify-param-cell" id="edit-verify-cell-pallets">
                        <div class="text-white-50 small mb-1">
                            托盘数 <i class="fas fa-info-circle ms-1"></i>
                        </div>
                        <div class="text-white" id="edit-verify-pallets">-</div>
                    </div>
                </div>
                <!-- 物流单价 -->
                <div class="col-6 col-md-4">
                    <div class="p-3 rounded bg-black bg-opacity-25 verify-param-cell" id="edit-verify-cell-price-kg">
                        <div class="text-white-50 small mb-1">
                            物流单价(RMB/KG) <i class="fas fa-info-circle ms-1"></i>
                        </div>
                        <div class="text-white" id="edit-verify-price-kg">-</div>
                    </div>
                </div>
                <!-- 发货总重量 -->
                <div class="col-6 col-md-4">
                    <div class="p-3 rounded bg-black bg-opacity-25 verify-param-cell" id="edit-verify-cell-total-weight">
                        <div class="text-white-50 small mb-1">
                            发货总重量(KG) <i class="fas fa-info-circle ms-1"></i>
                        </div>
                        <div class="text-white" id="edit-verify-total-weight">-</div>
                    </div>
                </div>
                <!-- 物流总价 -->
                <div class="col-6 col-md-4">
                    <div class="p-3 rounded bg-black bg-opacity-25 verify-param-cell" id="edit-verify-cell-total-price">
                        <div class="text-white-50 small mb-1">
                            物流总价(RMB) <i class="fas fa-info-circle ms-1"></i>
                        </div>
                        <div class="text-warning fw-bold" id="edit-verify-total-price">-</div>
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <div class="p-3 rounded bg-black bg-opacity-25 verify-param-cell" id="edit-verify-cell-usd-rmb">
                        <div class="text-white-50 small mb-1">
                            结算汇率(RMB/USD) <i class="fas fa-info-circle ms-1"></i>
                        </div>
                        <div id="edit-verify-usd-rmb">-</div>
                    </div>
                </div>
                <!-- 修改备注 (特殊高亮) -->
                <div class="col-12">
                    <div class="p-3 rounded bg-black bg-opacity-25 border border-warning border-opacity-50" id="edit-verify-cell-note">
                        <div class="text-white-50 small mb-1">
                            修改备注 <span class="text-danger" data-i18n="ui.text_660">*必填</span>
                        </div>
                        <div class="text-warning" id="edit-verify-note">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 错误信息容器 -->
    <div id="edit-params-errors-container" class="mb-4" style="display: none;">
        <div class="card bg-danger bg-opacity-10 border-danger">
            <div class="card-header bg-danger bg-opacity-20 border-0">
                <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                <span class="text-danger fw-bold" data-i18n="shipping.verify_failed">参数校验未通过</span>
            </div>
            <div class="card-body">
                <ul id="edit-params-errors-list" class="mb-0 text-white"></ul>
                <p class="text-white-50 small mt-3 mb-0">
                    <i class="fas fa-arrow-left me-1"></i><span data-i18n="shipping.return_to_fix">请返回上一步修正错误后再继续</span>
                </p>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-end gap-3">
        <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="editWizardPrev(2)">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
        </button>
        <button class="btn btn-success btn-lg px-4 rounded-pill" id="btn-edit-step2-next" onclick="goToStep3()" disabled>
            <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.next">下一步</span>
        </button>
    </div>
</div>

<style>
    /* 验证卡片状态样式 */
    .state-normal {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(13, 202, 240, 0.25);
    }
    .state-normal .card-header {
        background: rgba(13, 202, 240, 0.1);
    }
    
    .state-error {
        background: rgba(220, 53, 69, 0.1);
        border: 2px solid var(--bs-danger);
        animation: errorPulse 1.5s ease-in-out infinite;
    }
    .state-error .card-header {
        background: rgba(220, 53, 69, 0.2);
    }
    
    .state-success {
        background: rgba(25, 135, 84, 0.1);
        border: 2px solid var(--bs-success);
    }
    .state-success .card-header {
        background: rgba(25, 135, 84, 0.2);
    }
    
    @keyframes errorPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3); }
    }
    
    /* 参数框等高 - 使用flex让同行高度一致 */
    #edit-params-summary-content {
        display: flex;
        flex-wrap: wrap;
    }
    #edit-params-summary-content > .col-6,
    #edit-params-summary-content > .col-md-4 {
        display: flex;
    }
    #edit-params-summary-content .verify-param-cell {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    /* 汇率来源tag */
    .rate-source-tag {
        font-size: 0.55rem;
        padding: 1px 4px;
        border-radius: 3px;
        margin-left: 4px;
        vertical-align: middle;
    }
    .rate-source-tag.auto {
        background: rgba(13, 202, 240, 0.3);
        color: #0dcaf0;
    }
    .rate-source-tag.manual {
        background: rgba(255, 193, 7, 0.3);
        color: #ffc107;
    }
</style>

<script>
    // ========================================
    // Step2: 验证物流参数
    // ========================================
    
    // 验证物流参数
    function validateLogistics(data) {
        const errors = [];
        
        // 预计到货日期
        if (!data.date_eta) {
            errors.push({ field: 'date_eta', message: (window.i18n?.t('js.eta_required') || 'ETA required') });
        } else if (editDateSent && data.date_eta < editDateSent) {
            errors.push({ field: 'date_eta', message: (window.i18n?.t('js.eta_after_ship') || 'ETA cannot be before ship date') });
        }
        
        // 托盘数
        if (data.pallets < 0 || !Number.isInteger(data.pallets)) {
            errors.push({ field: 'pallets', message: (window.i18n?.t('js.pallet_non_negative') || 'Pallet must be 0 or positive') });
        }
        
        // 物流单价
        if (data.price_kg <= 0) {
            errors.push({ field: 'price_kg', message: (window.i18n?.t('js.logistics_price_positive') || 'Logistics price must be > 0') });
        }
        
        // 发货总重量
        if (data.total_weight <= 0) {
            errors.push({ field: 'total_weight', message: (window.i18n?.t('js.weight_positive') || 'Weight must be > 0') });
        }
        
        // 物流总价
        if (data.total_price <= 0) {
            errors.push({ field: 'total_price', message: (window.i18n?.t('js.logistics_total_positive') || 'Logistics total must be > 0') });
        }
        
        // 结算汇率
        if (data.usd_rmb <= 0) {
            errors.push({ field: 'usd_rmb', message: (window.i18n?.t('js.rate_must_positive') || 'Rate must be > 0') });
        }
        
        // 修改备注
        if (!data.note) {
            errors.push({ field: 'note', message: (window.i18n?.t('js.notes_required_for_edit') || 'Notes required for edit') });
        } else if (data.note === (window.i18n?.t('js.original_shipment') || 'Original Shipment')) {
            errors.push({ field: 'note', message: '修改备注不能为(window.i18n?.t('js.original_shipment') || 'Original Shipment')' });
        }
        
        // 检查除备注外是否有修改（与原数据对比）
        if (editOriginalData && editOriginalData.logistics) {
            const orig = editOriginalData.logistics;
            const hasChanges = (
                data.date_eta !== (orig.date_eta || '') ||
                data.pallets !== (orig.pallets || 0) ||
                Math.abs(data.price_kg - (orig.price_kg || 0)) > 0.0001 ||
                Math.abs(data.total_weight - (orig.total_weight || 0)) > 0.01 ||
                Math.abs(data.usd_rmb - (orig.usd_rmb || 0)) > 0.0001
            );
            
            if (!hasChanges) {
                errors.push({ field: 'general', message: '除修改备注外，至少需要修改一项内容，否则请点击"跳过物流修改"' });
            }
        }
        
        return errors;
    }
    
    // 显示验证结果
    function displayValidationResult(data, errors) {
        const card = document.getElementById('edit-params-validation-card');
        const errorsContainer = document.getElementById('edit-params-errors-container');
        const errorsList = document.getElementById('edit-params-errors-list');
        const confirmBtn = document.getElementById('btn-edit-step2-next');
        
        // 获取原始数据
        const orig = editOriginalData?.logistics || {};
        
        // 原始汇率来源：从orig.mode判断（A=自动获取, M=手动填写）
        const isOrigRateManual = orig.mode !== 'A';
        
        // 新汇率来源：从window.editRateIsManual获取
        const isNewRateManual = window.editRateIsManual !== false;
        
        // 生成汇率来源tag
        function getRateTag(isManual) {
            if (isManual) {
                return '<span class="rate-source-tag manual" data-i18n="js.mode_manual">手动输入</span>';
            } else {
                return '<span class="rate-source-tag auto" data-i18n="js.auto_fetch">自动获取</span>';
            }
        }
        
        // 字段配置（不包括汇率，汇率单独处理）
        const fieldsConfig = [
            { key: 'date_eta', elId: 'edit-verify-date-eta', format: v => v || '-', compare: (n, o) => n !== (o || '') },
            { key: 'pallets', elId: 'edit-verify-pallets', format: v => v, compare: (n, o) => n !== (o || 0) },
            { key: 'price_kg', elId: 'edit-verify-price-kg', format: v => '¥' + formatNumberStep2(v, 4), compare: (n, o) => Math.abs(n - (o || 0)) > 0.0001 },
            { key: 'total_weight', elId: 'edit-verify-total-weight', format: v => formatNumberStep2(v, 2) + ' KG', compare: (n, o) => Math.abs(n - (o || 0)) > 0.01 },
            { key: 'total_price', elId: 'edit-verify-total-price', format: v => '¥' + formatNumberStep2(v, 2), compare: (n, o) => Math.abs(n - (o || 0)) > 0.01 }
        ];
        
        // 渲染普通字段
        fieldsConfig.forEach(field => {
            const el = document.getElementById(field.elId);
            if (!el) return;
            
            const newVal = data[field.key];
            const origVal = orig[field.key];
            const isChanged = field.compare(newVal, origVal);
            
            if (isChanged) {
                el.innerHTML = `
                    <div class="d-flex flex-column gap-1">
                        <div class="text-white-50 small">
                            <span class="badge bg-secondary me-1" style="font-size: 0.55rem;" data-i18n="ui.text_1097">修改前</span>
                            <span class="text-decoration-line-through">${field.format(origVal)}</span>
                        </div>
                        <div class="text-warning">
                            <span class="badge bg-warning text-dark me-1" style="font-size: 0.55rem;" data-i18n="ui.text_1098">修改后</span>
                            <strong>${field.format(newVal)}</strong>
                        </div>
                    </div>
                `;
            } else {
                el.innerHTML = `<span class="text-white-50">${field.format(newVal)}</span>`;
            }
        });
        
        // 结算汇率单独处理（需要显示来源tag）
        const rateEl = document.getElementById('edit-verify-usd-rmb');
        if (rateEl) {
            const newRate = data.usd_rmb;
            const origRate = orig.usd_rmb || 0;
            const isRateChanged = Math.abs(newRate - origRate) > 0.0001;
            
            if (isRateChanged) {
                rateEl.innerHTML = `
                    <div class="d-flex flex-column gap-1">
                        <div class="text-white-50 small">
                            <span class="badge bg-secondary me-1" style="font-size: 0.55rem;" data-i18n="ui.text_1097">修改前</span>
                            <span class="text-decoration-line-through">${formatNumberStep2(origRate, 4)} RMB/USD</span>
                            ${getRateTag(isOrigRateManual)}
                        </div>
                        <div class="text-warning">
                            <span class="badge bg-warning text-dark me-1" style="font-size: 0.55rem;" data-i18n="ui.text_1098">修改后</span>
                            <strong>${formatNumberStep2(newRate, 4)} RMB/USD</strong>
                            ${getRateTag(isNewRateManual)}
                        </div>
                    </div>
                `;
            } else {
                rateEl.innerHTML = `
                    <span class="text-white-50">${formatNumberStep2(newRate, 4)} RMB/USD</span>
                    ${getRateTag(isNewRateManual)}
                `;
            }
        }
        
        // 修改备注单独处理
        const noteEl = document.getElementById('edit-verify-note');
        if (noteEl) {
            noteEl.textContent = data.note || '-';
        }
        
        // 高亮错误字段
        const fieldMapping = {
            'date_eta': 'edit-verify-cell-date-eta',
            'pallets': 'edit-verify-cell-pallets',
            'price_kg': 'edit-verify-cell-price-kg',
            'total_weight': 'edit-verify-cell-total-weight',
            'total_price': 'edit-verify-cell-total-price',
            'usd_rmb': 'edit-verify-cell-usd-rmb',
            'note': 'edit-verify-cell-note'
        };
        
        // 字段中文名称映射
        const fieldLabels = {
            'date_eta': (window.i18n?.t('js.expected_arrival') || 'Expected Arrival'),
            'pallets': (window.i18n?.t('js.pallet_count') || 'Pallet Count'),
            'price_kg': (window.i18n?.t('js.logistics_price') || 'Logistics Price (RMB/KG)'),
            'total_weight': (window.i18n?.t('js.total_weight_kg') || 'Total Weight(KG)'),
            'total_price': (window.i18n?.t('js.logistics_total_rmb') || 'Logistics Total(RMB)'),
            'usd_rmb': (window.i18n?.t('table.settlement_rate') || 'Settlement Rate'),
            'note': (window.i18n?.t('js.edit_notes') || 'Edit Notes'),
            'general': (window.i18n?.t('js.overall_check') || 'Overall Check')
        };
        
        // 重置所有字段边框
        Object.values(fieldMapping).forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('border', 'border-danger');
            }
        });
        
        if (errors.length > 0) {
            // 有错误
            card.className = 'card mb-4 state-error';
            errorsContainer.style.display = 'block';
            errorsList.innerHTML = errors.map(e => `<li><strong>${fieldLabels[e.field] || e.field}</strong>: ${e.message}</li>`).join('');
            confirmBtn.disabled = true;
            
            // 高亮错误字段
            errors.forEach(e => {
                const cellId = fieldMapping[e.field];
                if (cellId) {
                    const el = document.getElementById(cellId);
                    if (el) {
                        el.classList.add('border', 'border-danger');
                    }
                }
            });
        } else {
            // 验证通过
            card.className = 'card mb-4 state-success';
            errorsContainer.style.display = 'none';
            confirmBtn.disabled = false;
        }
    }
    
    // 进入Step3 - 只跳转，不提交数据到数据库
    // 数据将在Step3确认修改时统一提交
    function goToStep3() {
        showEditStep(3);
    }
    
    // 格式化数字（Step2专用）
    function formatNumberStep2(num, maxDecimals = 4) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return parseFloat(num.toFixed(maxDecimals)).toString();
    }
</script>