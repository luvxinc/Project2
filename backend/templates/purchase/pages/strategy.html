{% extends "layouts/base.html" %}
{% load static %}
{% load security_tags %}

{% block title %}Supplier Management - Procurement - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:purchase:hub' %}"
                            class="text-info text-decoration-none" data-i18n="purchase.title">Procurement</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page"
                        data-i18n="purchase.supplier">Supplier Management</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'web_ui:purchase:hub' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="purchase.back_to_hub">返回Procurement</span>
            </a>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 策略列表视图 -->
    <!-- ===================================== -->
    <div id="strategy-list-view">
        <div class="glass-card p-4 shadow-lg">
            <!-- Header -->
            <div
                class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
                <div class="d-flex align-items-center">
                    <div class="bg-info bg-opacity-25 p-3 rounded-circle me-3">
                        <i class="fas fa-chess-knight fa-2x text-info"></i>
                    </div>
                    <div>
                        <h5 class="text-white mb-1">Supplier Management</h5>
                        <p class="text-white-50 small mb-0" data-i18n="ui.text_425">查看现有供应商列表及最新生效策略，点击编辑进行修改。</p>
                    </div>
                </div>
                <button class="btn btn-outline-light btn-sm rounded-pill" onclick="loadStrategyTable()">
                    <i class="fas fa-sync-alt me-1"></i> <span data-i18n="common.refresh">刷新列表</span>
                </button>
            </div>

            <!-- Apple风格表格 -->
            <div class="strategy-table-container">
                <table class="strategy-table" id="strategy-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="supplier_code"><span data-i18n="purchase.code">代号</span> <i
                                    class="fas fa-sort ms-1"></i></th>
                            <th data-i18n="purchase.name">名称</th>
                            <th class="sortable" data-sort="category"><span data-i18n="purchase.category">类别</span> <i
                                    class="fas fa-sort ms-1"></i></th>
                            <th class="sortable" data-sort="type"><span data-i18n="purchase.type">种类</span> <i
                                    class="fas fa-sort ms-1"></i></th>
                            <th class="sortable" data-sort="currency"><span data-i18n="common.currency">货币</span> <i
                                    class="fas fa-sort ms-1"></i></th>
                            <th data-i18n="purchase.price_float">价格浮动</th>
                            <th data-i18n="purchase.deposit_req">定金要求</th>
                            <th data-i18n="common.status">状态</th>
                            <th data-i18n="purchase.effective_date">生效日期</th>
                            <th data-i18n="common.operation">操作</th>
                        </tr>
                    </thead>
                    <tbody id="strategy-table-body">
                        <!-- JS动态加载 -->
                    </tbody>
                </table>

                <!-- Loading State -->
                <div id="strategy-loading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-info" role="status"></div>
                    <p class="text-white-50 mt-3 mb-0" data-i18n="common.loading">正在加载策略数据...</p>
                </div>

                <!-- Empty State -->
                <div id="strategy-empty" class="text-center py-5" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-white-50 opacity-50 mb-3"></i>
                    <p class="text-white-50 mb-0" data-i18n="purchase.no_supplier_data">暂无供应商策略数据</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================== -->
    <!-- 修改策略 Wizard 视图 (默认隐藏) -->
    <!-- ===================================== -->
    <div id="strategy-wizard-view" style="display: none;">
        <div id="strategy-wizard-container" class="glass-card p-4 shadow-lg">
            <!-- Header (GlobalWizard 锚点：步骤条将插入到此节点之后) -->
            <div class="wizard-header d-flex flex-column mb-4">
                <div class="d-flex align-items-center">
                    <div class="bg-warning bg-opacity-25 p-3 rounded-circle me-3">
                        <i class="fas fa-edit fa-2x text-warning"></i>
                    </div>
                    <div>
                        <h5 class="text-white mb-1" data-i18n="ui.text_426">修改供应商策略</h5>
                        <p class="text-white-50 small mb-0" data-i18n="ui.text_427">修改策略将作为新生效记录保存，请仔细核对后提交。</p>
                    </div>
                </div>
                <hr class="border-secondary border-opacity-25 my-4 w-100">
            </div>

            <!-- StepBar 锚点：GlobalWizard 会将步骤条注入到此 div 内 -->
            <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

            <!-- Step 1: 填写信息 -->
            <div id="strategy-step-input" class="wizard-step-content">
                <!-- 操作须知 (与PO修改向导一致风格) -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-3 mt-1 text-info"></i>
                        <div>
                            <strong class="text-info" data-i18n="common.operation_notes">操作须知</strong>
                            <ul class="mb-0 mt-2 ps-3">
                                <li data-i18n="desc.d116">修改后将生成<strong data-i18n="ui.text_429">新版本策略</strong>，原策略记录保留
                                </li>
                                <li data-i18n="desc.d117">请根据业务需要调整<strong data-i18n="purchase.category">类别</strong>、<strong
                                        data-i18n="purchase.type">种类</strong>、<strong
                                        data-i18n="common.currency">货币</strong>等参数</li>
                                <li data-i18n="desc.d118">若仅更新策略信息，请填写新的<strong data-i18n="purchase.effective_date">生效日期</strong>
                                </li>
                                <li data-i18n="desc.d119">若需<strong data-i18n="ui.text_434">覆盖同日期</strong>现有策略，系统会提示确认
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form id="form-modify-strategy" autocomplete="off" onkeydown="return event.key != 'Enter';">
                    {% csrf_token %}
                    <input type="hidden" name="supplier_code" id="wiz_supplier_code_hidden">
                    <div id="policy-check-modify-strategy" class="d-none">
                        {% security_inputs 'btn_modify_strategy' %}
                    </div>

                    <!-- 供应商标识（只读） -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t6927" title="供应商唯一标识，不可修改">
                                <span data-i18n="ui.text_2126">供应商代号</span> <i class="fas fa-lock ms-1 text-secondary"></i>
                            </label>
                            <input type="text" class="form-control bg-dark border-secondary text-white-50"
                                id="wiz_supplier_code_disp" disabled>
                        </div>
                        <div class="col-md-9">
                            <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t1810" title="请输入供应商的中文名称">
                                <span data-i18n="ui.text_2127">供应商名称</span> <i class="fas fa-info-circle ms-1"></i>
                            </label>
                            <input type="text" class="form-control bg-dark border-secondary text-white"
                                name="supplier_name" id="wiz_supplier_name" required>
                        </div>
                    </div>

                    <!-- 合作状态 -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t9276" title="设置该供应商是否为当前合作方">
                                <span data-i18n="ui.text_2128">合作状态</span> <i class="fas fa-info-circle ms-1"></i>
                            </label>
                            <div class="d-flex align-items-center gap-3 mt-2">
                                <label class="ui-toggle ui-toggle-primary ui-toggle-lg" for="wiz_status">
                                    <input type="checkbox" id="wiz_status" name="status" checked>
                                    <span class="ui-toggle-track"></span>
                                </label>
                                <span class="text-white" id="wiz_status_label" data-i18n="ui.text_435">合作方</span>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t7393" title="新策略的生效日期">
                                <span data-i18n="desc.d123">策略生效日期</span> <i class="fas fa-info-circle ms-1"></i>
                            </label>
                            <input type="date" class="form-control bg-dark border-secondary text-white"
                                name="effective_date" id="wiz_effective_date" required>
                        </div>
                    </div>

                    <!-- 可编辑字段组 -->
                    <fieldset id="wiz_fieldset">
                        <div class="row g-4 mb-4">
                            <div class="col-md-4">
                                <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                    data-i18n-title="tooltip.t4004" title="请根据业务种类选择供应商类别">
                                    <span data-i18n="desc.d124">供应商类别</span> <span class="text-danger">*</span> <i
                                        class="fas fa-info-circle ms-1"></i>
                                </label>
                                <div class="btn-group w-100 mt-2" role="group">
                                    <input type="radio" class="btn-check" name="category" id="wiz_cat_e" value="E"
                                        required>
                                    <label class="btn btn-outline-secondary" for="wiz_cat_e" data-i18n="ui.text_436">汽配
                                        (E)</label>
                                    <input type="radio" class="btn-check" name="category" id="wiz_cat_a" value="A">
                                    <label class="btn btn-outline-secondary" for="wiz_cat_a" data-i18n="ui.text_437">亚马逊
                                        (A)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                    data-i18n-title="tooltip.t2503"
                                    title="A类: 电商货物供应商&#10;B类: 货物依赖品供应商&#10;C类: 耗材和其他供应商">
                                    <span data-i18n="desc.d125">供应商种类</span> <span class="text-danger">*</span> <i
                                        class="fas fa-info-circle ms-1"></i>
                                </label>
                                <div class="btn-group w-100 mt-2" role="group">
                                    <input type="radio" class="btn-check" name="type" id="wiz_type_a" value="A"
                                        required>
                                    <label class="btn btn-outline-secondary" for="wiz_type_a" data-bs-toggle="tooltip"
                                        data-i18n-title="tooltip.t1667" title="电商货物供应商">A类</label>
                                    <input type="radio" class="btn-check" name="type" id="wiz_type_b" value="B">
                                    <label class="btn btn-outline-secondary" for="wiz_type_b" data-bs-toggle="tooltip"
                                        data-i18n-title="tooltip.t5705" title="货物依赖品供应商">B类</label>
                                    <input type="radio" class="btn-check" name="type" id="wiz_type_c" value="C">
                                    <label class="btn btn-outline-secondary" for="wiz_type_c" data-bs-toggle="tooltip"
                                        data-i18n-title="tooltip.t9251" title="耗材和其他供应商">C类</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                    data-i18n-title="tooltip.t1845" title="请根据供应商选择结算货币种类">
                                    <span data-i18n="desc.d126">使用货币</span> <span class="text-danger">*</span> <i
                                        class="fas fa-info-circle ms-1"></i>
                                </label>
                                <div class="btn-group w-100 mt-2" role="group">
                                    <input type="radio" class="btn-check" name="currency" id="wiz_curr_rmb" value="RMB"
                                        required>
                                    <label class="btn btn-outline-secondary" for="wiz_curr_rmb">RMB</label>
                                    <input type="radio" class="btn-check" name="currency" id="wiz_curr_usd" value="USD">
                                    <label class="btn btn-outline-secondary" for="wiz_curr_usd">USD</label>
                                </div>
                            </div>
                        </div>

                        <hr class="border-secondary border-opacity-25 my-4">

                        <!-- 价格浮动 -->
                        <div class="row g-4 mb-4 align-items-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-3">
                                    <label class="ui-toggle ui-toggle-primary" for="wiz_float_currency">
                                        <input type="checkbox" id="wiz_float_currency" name="float_currency">
                                        <span class="ui-toggle-track"></span>
                                    </label>
                                    <label class="form-check-label text-white" for="wiz_float_currency"
                                        data-bs-toggle="tooltip" data-i18n-title="tooltip.t2343"
                                        title="订单价格是否随汇率浮动阈值控制">
                                        <span data-i18n="purchase.price_float">价格浮动</span> <i class="fas fa-info-circle ms-1"></i>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label text-white-50 small" data-i18n="ui.text_438">浮动阈值 (%)</label>
                                <div class="d-flex align-items-center gap-3">
                                    <input type="range" class="form-range flex-grow-1" min="0" max="10" step="0.1"
                                        id="wiz_float_range" disabled>
                                    <input type="number"
                                        class="form-control bg-dark border-secondary text-white text-center"
                                        style="width: 80px;" id="wiz_float_input" name="float_threshold" min="0"
                                        max="10" step="0.1" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-4 align-items-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-3">
                                    <label class="ui-toggle ui-toggle-primary" for="wiz_depository">
                                        <input type="checkbox" id="wiz_depository" name="depository">
                                        <span class="ui-toggle-track"></span>
                                    </label>
                                    <label class="form-check-label text-white" for="wiz_depository"
                                        data-bs-toggle="tooltip" data-i18n-title="tooltip.t7901" title="该供应商订单是否需要定金">
                                        <span data-i18n="desc.d128">要求定金</span> <i class="fas fa-info-circle ms-1"></i>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label text-white-50 small" data-i18n="ui.text_439">定金比例 (%)</label>
                                <div class="d-flex align-items-center gap-3">
                                    <input type="range" class="form-range flex-grow-1" min="0" max="100" step="1"
                                        id="wiz_depo_range" disabled>
                                    <input type="number"
                                        class="form-control bg-dark border-secondary text-white text-center"
                                        style="width: 80px;" id="wiz_depo_input" name="deposit_par" min="0" max="100"
                                        step="1" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- 备注 & 合同 -->
                        <div class="mb-4">
                            <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t7620" title="可填写关于该策略的备注说明">
                                <span data-i18n="desc.d129">备注 (可选)</span> <i class="fas fa-info-circle ms-1"></i>
                            </label>
                            <textarea class="form-control bg-dark border-secondary text-white" name="note" id="wiz_note"
                                rows="2" data-i18n-placeholder="form.placeholder.generic_4"
                                placeholder="输入备注..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-white-50 small" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t9865" title="如需更新合同文件请选择">
                                <span data-i18n="desc.d130">更新合同文件 (可选)</span> <i class="fas fa-info-circle ms-1"></i>
                            </label>
                            <!-- GlobalFileUpload 组件容器 -->
                            <div id="contract-upload-container"></div>
                        </div>
                    </fieldset>
                </form>

                <!-- Step 1 Actions -->
                <div class="wizard-actions">
                    <div class="wizard-actions-left">
                        <button type="button" class="btn btn-outline-secondary btn-lg px-4 rounded-pill"
                            id="btn-strat-cancel">
                            <i class="fas fa-times me-2"></i><span data-i18n="common.cancel">取消</span>
                        </button>
                    </div>
                    <div class="wizard-actions-right">
                        <button type="button" class="btn btn-primary btn-lg px-5 shadow rounded-pill"
                            id="btn-strat-next-1">
                            <i class="fas fa-arrow-right me-2"></i><span data-i18n="ui.icon_3018">下一步：验证数据</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: 验证数据 -->
            <div id="strategy-step-confirm" class="wizard-step-content">
                <div class="card mb-4" id="strat-validation-card">
                    <div class="card-header border-0" id="strat-validation-header">
                        <i class="fa-solid fa-shield-halved me-2" id="strat-validation-icon"></i>
                        <span id="strat-validation-title" data-i18n="ui.text_440">请验证以下策略修改</span>
                    </div>
                    <div class="card-body">
                        <div id="strategy-summary-content" class="row g-3 text-white">
                            <!-- 动态填充 -->
                        </div>
                    </div>
                </div>

                <!-- 错误列表 -->
                <div id="strat-errors-container" class="mb-4" style="display: none;">
                    <div class="card bg-danger bg-opacity-10 border-danger">
                        <div class="card-header bg-danger bg-opacity-20 border-0">
                            <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                            <span class="text-danger fw-bold" data-i18n="ui.text_56">校验未通过</span>
                        </div>
                        <div class="card-body">
                            <ul id="strat-errors-list" class="mb-0 text-white"></ul>
                        </div>
                    </div>
                </div>

                <!-- 覆盖确认区块（校验通过后存在同日期策略时显示） -->
                <div id="strat-override-container" class="mb-4" style="display: none;">
                    <div class="card border-warning"
                        style="background: rgba(255, 193, 7, 0.1); backdrop-filter: blur(10px);">
                        <div class="card-header bg-warning bg-opacity-15 border-0">
                            <i class="fas fa-exclamation-circle me-2 text-warning"></i>
                            <span class="text-warning fw-bold" data-i18n="ui.text_442">检测到策略冲突</span>
                        </div>
                        <div class="card-body">
                            <p class="text-white mb-3" id="strat-override-msg" data-i18n="ui.text_443">
                                该供应商在同一生效日期已存在策略记录，是否覆盖现有策略？
                            </p>
                            <div class="d-flex gap-3">
                                <button type="button" class="btn btn-warning px-4" id="btn-override-yes">
                                    <i class="fas fa-check me-2"></i><span data-i18n="ui.icon_3166">覆盖现有策略</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary px-4" id="btn-override-no">
                                    <i class="fas fa-times me-2"></i><span data-i18n="ui.icon_3167">取消（修改日期）</span>
                                </button>
                            </div>
                            <div id="strat-override-selected" class="mt-3" style="display: none;">
                                <span class="badge bg-warning text-dark px-3 py-2">
                                    <i class="fas fa-check-circle me-1"></i><span
                                        data-i18n="ui.icon_3168">已选择：覆盖现有策略</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2 Actions -->
                <div class="wizard-actions">
                    <div class="wizard-actions-left">
                        <button type="button" class="btn btn-outline-secondary btn-lg px-4 rounded-pill"
                            id="btn-strat-back-2">
                            <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
                        </button>
                    </div>
                    <div class="wizard-actions-right">
                        <button type="button" class="btn btn-warning btn-lg px-5 shadow rounded-pill"
                            id="btn-strat-confirm" disabled>
                            <i class="fas fa-check-circle me-2"></i><span data-i18n="modal.change_password.btn_confirm">确认修改</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: 完成状态 -->
            <div id="strategy-step-finish" class="wizard-step-content">
                <div class="card bg-dark border-opacity-50" id="strat-finish-card">
                    <div class="card-body py-5">
                        <div class="text-center mb-4" id="strat-finish-header"></div>
                        <div id="strat-finish-panel" class="mb-4"></div>
                        <div class="d-flex justify-content-center gap-3">
                            <button type="button" class="btn btn-outline-secondary btn-lg px-4 rounded-pill"
                                id="btn-strat-back-list">
                                <i class="fas fa-list me-2"></i><span data-i18n="common.back_list">返回列表</span>
                            </button>
                            <button type="button" class="btn btn-primary btn-lg px-5 shadow rounded-pill"
                                id="btn-strat-restart">
                                <i class="fas fa-rotate me-2"></i><span data-i18n="ui.icon_3172">继续修改策略</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contract Viewer Modal -->
    <div class="modal fade" id="contractViewerModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content glass-card border border-secondary shadow-lg" style="height: 80vh;">
                <div class="modal-header border-secondary border-opacity-25">
                    <h5 class="modal-title text-white"><i class="fas fa-file-contract me-2"></i><span
                            data-i18n="ui.icon_3173">合同文件预览</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 bg-dark">
                    <iframe id="contract-frame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ========================================
       Apple风格策略表格
       ======================================== */
    .strategy-table-container {
        border-radius: 16px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .strategy-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    /* 表头 - 明显区分 */
    .strategy-table thead {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .strategy-table thead th {
        padding: 16px 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        border-bottom: 2px solid rgba(13, 202, 240, 0.3);
        white-space: nowrap;
    }

    .strategy-table thead th.sortable {
        cursor: pointer;
        user-select: none;
        transition: color 0.2s ease;
    }

    .strategy-table thead th.sortable:hover {
        color: rgba(13, 202, 240, 0.9);
    }

    .strategy-table thead th.sortable i {
        margin-left: 4px;
        font-size: 10px;
        opacity: 0.6;
    }

    .strategy-table thead th.sortable:hover i {
        opacity: 1;
    }

    /* 数据行 */
    .strategy-table tbody tr {
        background: rgba(25, 28, 35, 0.6);
        transition: all 0.2s ease;
    }

    .strategy-table tbody tr:hover {
        background: rgba(40, 45, 55, 0.8);
    }

    .strategy-table tbody tr:not(:last-child) td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .strategy-table tbody td {
        padding: 14px 12px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        vertical-align: middle;
    }

    /* 代号列加粗 */
    .strategy-table tbody td.cell-code {
        font-weight: 700;
        color: #fff;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }

    /* 名称列左对齐 */
    .strategy-table tbody td.cell-name {
        text-align: left;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* 状态Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
    }

    .status-badge.active {
        background: rgba(40, 167, 69, 0.2);
        color: #5cb85c;
        border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .status-badge.inactive {
        background: rgba(108, 117, 125, 0.2);
        color: #adb5bd;
        border: 1px solid rgba(108, 117, 125, 0.3);
    }

    /* 弱化文案 */
    .cell-muted {
        color: rgba(255, 255, 255, 0.35) !important;
        font-style: italic;
        font-size: 11px;
    }

    /* 功能值显示 */
    .feature-value {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .feature-value .icon {
        font-size: 10px;
    }

    .feature-value.enabled {
        color: #5cb85c;
    }

    .feature-value.enabled .icon {
        color: #5cb85c;
    }

    /* 编辑按钮 */
    .btn-edit {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: rgba(255, 193, 7, 0.15);
        border: 1px solid rgba(255, 193, 7, 0.3);
        color: #ffc107;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-edit:hover {
        background: rgba(255, 193, 7, 0.3);
        border-color: rgba(255, 193, 7, 0.5);
        transform: scale(1.05);
    }

    /* ========================================
       Wizard 验证卡片状态
       ======================================== */
    #strat-validation-card {
        transition: all 0.3s ease;
    }

    #strat-validation-card.state-normal {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 193, 7, 0.25);
    }

    #strat-validation-card.state-normal #strat-validation-header {
        background: rgba(255, 193, 7, 0.1);
    }

    #strat-validation-card.state-normal #strat-validation-icon,
    #strat-validation-card.state-normal #strat-validation-title {
        color: var(--bs-warning);
    }

    #strat-validation-card.state-loading {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 193, 7, 0.5);
    }

    #strat-validation-card.state-loading #strat-validation-header {
        background: rgba(255, 193, 7, 0.1);
    }

    #strat-validation-card.state-loading #strat-validation-icon,
    #strat-validation-card.state-loading #strat-validation-title {
        color: var(--bs-warning);
    }

    #strat-validation-card.state-error {
        background: rgba(220, 53, 69, 0.1);
        border: 2px solid var(--bs-danger);
        animation: errorPulse 1.5s ease-in-out infinite;
    }

    #strat-validation-card.state-error #strat-validation-header {
        background: rgba(220, 53, 69, 0.2);
    }

    #strat-validation-card.state-error #strat-validation-icon,
    #strat-validation-card.state-error #strat-validation-title {
        color: var(--bs-danger);
    }

    #strat-validation-card.state-success {
        background: rgba(25, 135, 84, 0.1);
        border: 2px solid var(--bs-success);
    }

    #strat-validation-card.state-success #strat-validation-header {
        background: rgba(25, 135, 84, 0.2);
    }

    #strat-validation-card.state-success #strat-validation-icon,
    #strat-validation-card.state-success #strat-validation-title {
        color: var(--bs-success);
    }

    @keyframes errorPulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }

        50% {
            box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3);
        }
    }

    #btn-strat-confirm:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        cursor: not-allowed;
        opacity: 0.65;
    }
</style>

<script>
    // ========================================
    // 全局状态
    // ========================================
    let strategyWizard = null;
    let currentEditingItem = null;
    let step2StratValidationPassed = false;
    let contractUploader = null;  // 合同上传组件实例
    let hasDateConflict = false;   // 是否存在同日期策略冲突
    let overrideConfirmed = false; // 用户是否已确认覆盖

    document.addEventListener('DOMContentLoaded', function () {
        loadStrategyTable();
        initStrategyWizard();
        setupWizardToggles();
        initContractUploader();
        bindOverrideButtons();
    });

    // ========================================
    // 合同文件上传组件初始化
    // ========================================
    function initContractUploader() {
        contractUploader = new GlobalFileUpload({
            containerId: 'contract-upload-container',
            inputName: 'contract_file',
            title: (window.i18n?.t('js.upload_contract') || 'Upload Contract'),
            accept: '.pdf,.jpg,.jpeg,.png,.gif,.heic,.heif,.xls,.xlsx,.doc,.docx,.csv',
            maxSizeMB: 10,
            required: false,
            onFileSelect: (file) => {
            },
            onFileRemove: () => {
            },
            onError: (msg) => {
            }
        });
    }

    // ========================================
    // 策略列表加载
    // ========================================
    let strategyData = [];  // 缓存数据用于排序
    let currentSort = { field: 'supplier_code', asc: true };

    function loadStrategyTable() {
        const tbody = document.getElementById('strategy-table-body');
        const loading = document.getElementById('strategy-loading');
        const empty = document.getElementById('strategy-empty');
        const table = document.getElementById('strategy-table');

        tbody.innerHTML = '';
        loading.style.display = 'block';
        empty.style.display = 'none';
        table.style.display = 'none';

        fetch("{% url 'web_ui:purchase:supplier_list' %}")
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';

                if (!data.success) {
                    empty.innerHTML = `<i class="fas fa-exclamation-circle fa-3x text-danger opacity-50 mb-3"></i><p class="text-danger mb-0">${data.message}</p>`;
                    empty.style.display = 'block';
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                strategyData = data.data;
                table.style.display = 'table';
                renderStrategyRows(strategyData);
                initSortableHeaders();
            })
            .catch(err => {
                loading.style.display = 'none';
                empty.innerHTML = `<i class="fas fa-exclamation-circle fa-3x text-danger opacity-50 mb-3"></i><p class="text-danger mb-0" data-i18n="ui.text_421">加载失败: ${err}</p>`;
                empty.style.display = 'block';
            });
    }

    function renderStrategyRows(items) {
        const tbody = document.getElementById('strategy-table-body');
        tbody.innerHTML = '';

        const typeLabels = { 'A': (window.i18n?.t('js.type_a_label') || 'Type A'), 'B': (window.i18n?.t('js.type_b_label') || 'Type B'), 'C': (window.i18n?.t('js.type_c_label') || 'Type C') };

        items.forEach(item => {
            const tr = document.createElement('tr');
            tr.dataset.item = JSON.stringify(item);

            // 状态Badge
            const statusBadge = item.status_bool
                ? '<span class="status-badge active"><i class="fas fa-circle me-1" style="font-size:6px"></i>合作方</span>'
                : '<span class="status-badge inactive"><i class="fas fa-circle me-1" style="font-size:6px"></i>非合作方</span>';

            // 价格浮动显示
            let floatDisplay;
            if (item.float_currency) {
                floatDisplay = `<span class="feature-value enabled"><i class="fas fa-check icon"></i>${item.float_threshold}%</span>`;
            } else {
                floatDisplay = '<span class="cell-muted" data-i18n="ui.text_390">未启用</span>';
            }

            // 定金显示
            let depoDisplay;
            if (item.depository) {
                depoDisplay = `<span class="feature-value enabled"><i class="fas fa-check icon"></i>${item.deposit_par}%</span>`;
            } else {
                depoDisplay = '<span class="cell-muted" data-i18n="ui.text_390">未启用</span>';
            }

            // 种类显示
            const typeDisplay = item.type ? typeLabels[item.type] || item.type : '<span class="cell-muted">-</span>';

            tr.innerHTML = `
                <td class="cell-code">${item.supplier_code}</td>
                <td class="cell-name">${item.supplier_name}</td>
                <td>${item.category === 'E' ? (window.i18n?.t('js.auto_parts') || 'Auto Parts') : item.category === 'A' ? (window.i18n?.t('js.amazon') || 'Amazon') : item.category}</td>
                <td>${typeDisplay}</td>
                <td>${item.currency}</td>
                <td>${floatDisplay}</td>
                <td>${depoDisplay}</td>
                <td>${statusBadge}</td>
                <td style="color: rgba(13,202,240,0.8)">${item.effective_date || '-'}</td>
                <td>
                    <button class="btn-edit" onclick="openStrategyWizard(this)" data-i18n-title="tooltip.t252" title="Edit Strategy">
                        <i class="fas fa-pen"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function initSortableHeaders() {
        document.querySelectorAll('.strategy-table th.sortable').forEach(th => {
            th.style.cursor = 'pointer';
            th.onclick = () => {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.asc = !currentSort.asc;
                } else {
                    currentSort.field = field;
                    currentSort.asc = true;
                }

                // 更新图标
                document.querySelectorAll('.strategy-table th.sortable i').forEach(icon => {
                    icon.className = 'fas fa-sort';
                });
                th.querySelector('i').className = currentSort.asc ? 'fas fa-sort-up' : 'fas fa-sort-down';

                // 排序
                const sorted = [...strategyData].sort((a, b) => {
                    let valA = a[field] || '';
                    let valB = b[field] || '';
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return currentSort.asc ? -1 : 1;
                    if (valA > valB) return currentSort.asc ? 1 : -1;
                    return 0;
                });
                renderStrategyRows(sorted);
            };
        });
    }

    // ========================================
    // Wizard 初始化
    // ========================================
    function initStrategyWizard() {
        if (strategyWizard) return;

        strategyWizard = new GlobalWizard({
            containerId: 'strategy-wizard-container',
            steps: [
                { id: 'input', label: (window.i18n?.t('js.fill_info') || 'Fill Information'), contentSelector: '#strategy-step-input' },
                { id: 'confirm', label: (window.i18n?.t('js.validate_data') || 'Validate'), contentSelector: '#strategy-step-confirm' },
                { id: 'finish', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#strategy-step-finish' }
            ],

            onStepChange: async (fromStep, toStep) => {
                if (strategyWizard.steps[toStep].id === 'confirm') {
                    populateStrategySummary();
                    await runStrategyValidation();
                }
            },

            onBeforeNext: async (currentStep) => {
                if (currentStep.id === 'input') {
                    return validateStrategyForm();
                }
                if (currentStep.id === 'confirm') {
                    if (!step2StratValidationPassed) return false;
                    return await submitStrategyWithAuth();
                }
                return true;
            },

            onComplete: () => { },
            onRestart: () => {
                // Restart回到列表视图
                showListView();
            }
        });

        bindWizardButtons();
    }

    function setupWizardToggles() {
        // 状态切换
        document.getElementById('wiz_status')?.addEventListener('change', () => {
            const isOn = document.getElementById('wiz_status').checked;
            document.getElementById('wiz_status_label').textContent = isOn ? '合作方' : (window.i18n?.t('js.non_partner') || 'Non-Partner');
            document.getElementById('wiz_fieldset').disabled = !isOn;
        });

        // 价格浮动
        document.getElementById('wiz_float_currency')?.addEventListener('change', () => {
            const on = document.getElementById('wiz_float_currency').checked;
            document.getElementById('wiz_float_range').disabled = !on;
            document.getElementById('wiz_float_input').disabled = !on;
            if (!on) { document.getElementById('wiz_float_range').value = 0; document.getElementById('wiz_float_input').value = 0; }
        });

        // 定金
        document.getElementById('wiz_depository')?.addEventListener('change', () => {
            const on = document.getElementById('wiz_depository').checked;
            document.getElementById('wiz_depo_range').disabled = !on;
            document.getElementById('wiz_depo_input').disabled = !on;
            if (!on) { document.getElementById('wiz_depo_range').value = 0; document.getElementById('wiz_depo_input').value = 0; }
        });

        // Range同步
        setupSync('wiz_float_range', 'wiz_float_input');
        setupSync('wiz_depo_range', 'wiz_depo_input');
    }

    function setupSync(rangeId, inputId) {
        const range = document.getElementById(rangeId);
        const input = document.getElementById(inputId);
        if (range && input) {
            range.addEventListener('input', () => input.value = range.value);
            input.addEventListener('input', () => range.value = input.value);
        }
    }

    function bindWizardButtons() {
        document.getElementById('btn-strat-cancel')?.addEventListener('click', showListView);
        document.getElementById('btn-strat-next-1')?.addEventListener('click', () => strategyWizard.next());
        document.getElementById('btn-strat-back-2')?.addEventListener('click', () => strategyWizard.back());
        document.getElementById('btn-strat-confirm')?.addEventListener('click', () => {
            if (step2StratValidationPassed) strategyWizard.next();
        });
        document.getElementById('btn-strat-back-list')?.addEventListener('click', showListView);
        document.getElementById('btn-strat-restart')?.addEventListener('click', () => {
            strategyWizard.restart();
            showListView();
        });
    }

    // ========================================
    // 视图切换
    // ========================================
    function openStrategyWizard(btn) {
        const tr = btn.closest('tr');
        if (!tr) return;

        currentEditingItem = JSON.parse(tr.dataset.item);
        populateWizardForm(currentEditingItem);

        // 重置合同上传组件
        if (contractUploader) {
            contractUploader.reset();
        }

        document.getElementById('strategy-list-view').style.display = 'none';
        document.getElementById('strategy-wizard-view').style.display = 'block';

        strategyWizard.goToStep(0);
        step2StratValidationPassed = false;
    }

    function showListView() {
        document.getElementById('strategy-wizard-view').style.display = 'none';
        document.getElementById('strategy-list-view').style.display = 'block';
        loadStrategyTable();
        currentEditingItem = null;
    }

    function populateWizardForm(item) {
        document.getElementById('wiz_supplier_code_hidden').value = item.supplier_code;
        document.getElementById('wiz_supplier_code_disp').value = item.supplier_code;
        document.getElementById('wiz_supplier_name').value = item.supplier_name;
        document.getElementById('wiz_effective_date').value = item.effective_date !== '-' ? item.effective_date : new Date().toISOString().split('T')[0];

        document.getElementById('wiz_status').checked = item.status_bool !== false;
        document.getElementById('wiz_status_label').textContent = item.status_bool !== false ? '合作方' : (window.i18n?.t('js.non_partner') || 'Non-Partner');
        document.getElementById('wiz_fieldset').disabled = item.status_bool === false;

        if (item.category === 'A') document.getElementById('wiz_cat_a').checked = true;
        else document.getElementById('wiz_cat_e').checked = true;

        // 加载种类
        if (item.type === 'A') document.getElementById('wiz_type_a').checked = true;
        else if (item.type === 'B') document.getElementById('wiz_type_b').checked = true;
        else if (item.type === 'C') document.getElementById('wiz_type_c').checked = true;
        else {
            // 清除所有选中状态
            document.getElementById('wiz_type_a').checked = false;
            document.getElementById('wiz_type_b').checked = false;
            document.getElementById('wiz_type_c').checked = false;
        }

        if (item.currency === 'USD') document.getElementById('wiz_curr_usd').checked = true;
        else document.getElementById('wiz_curr_rmb').checked = true;

        const fOn = item.float_currency;
        document.getElementById('wiz_float_currency').checked = fOn;
        document.getElementById('wiz_float_range').disabled = !fOn;
        document.getElementById('wiz_float_input').disabled = !fOn;
        document.getElementById('wiz_float_range').value = fOn && item.float_threshold !== '-' ? parseFloat(item.float_threshold) : 0;
        document.getElementById('wiz_float_input').value = fOn && item.float_threshold !== '-' ? parseFloat(item.float_threshold) : 0;

        const dOn = item.depository;
        document.getElementById('wiz_depository').checked = dOn;
        document.getElementById('wiz_depo_range').disabled = !dOn;
        document.getElementById('wiz_depo_input').disabled = !dOn;
        document.getElementById('wiz_depo_range').value = dOn && item.deposit_par !== '-' ? parseFloat(item.deposit_par) : 0;
        document.getElementById('wiz_depo_input').value = dOn && item.deposit_par !== '-' ? parseFloat(item.deposit_par) : 0;

        document.getElementById('wiz_note').value = item.note || '';
    }

    // ========================================
    // Step 1 验证
    // ========================================
    function validateStrategyForm() {
        const form = document.getElementById('form-modify-strategy');
        const hiddenInputs = form.querySelectorAll('#policy-check-modify-strategy input[required]');
        hiddenInputs.forEach(i => { i.dataset.wasReq = 'true'; i.removeAttribute('required'); });

        const valid = form.checkValidity();
        if (!valid) {
            form.reportValidity();
            hiddenInputs.forEach(i => { if (i.dataset.wasReq) { i.setAttribute('required', ''); delete i.dataset.wasReq; } });
            return false;
        }

        hiddenInputs.forEach(i => { if (i.dataset.wasReq) { i.setAttribute('required', ''); delete i.dataset.wasReq; } });
        return true;
    }

    // ========================================
    // Step 2 摘要 & 验证
    // ========================================
    function populateStrategySummary() {
        const code = document.getElementById('wiz_supplier_code_disp').value;
        const name = document.getElementById('wiz_supplier_name').value;
        const status = document.getElementById('wiz_status').checked ? '合作方' : (window.i18n?.t('js.non_partner') || 'Non-Partner');
        const date = document.getElementById('wiz_effective_date').value;
        const category = document.querySelector('input[name="category"]:checked')?.value === 'A' ? (window.i18n?.t('js.amazon') || 'Amazon') : (window.i18n?.t('js.auto_parts') || 'Auto Parts');
        const typeVal = document.querySelector('input[name="type"]:checked')?.value || '';
        const typeLabels = { 'A': (window.i18n?.t('js.type_a') || 'Type A (E-commerce)'), 'B': (window.i18n?.t('js.type_b') || 'Type B (Accessories)'), 'C': (window.i18n?.t('js.type_c') || 'Type C (Supplies)') };
        const typeDisplay = typeLabels[typeVal] || '<span class="text-muted" data-i18n="ui.text_447">未选择</span>';
        const currency = document.querySelector('input[name="currency"]:checked')?.value || '-';
        const floatOn = document.getElementById('wiz_float_currency').checked;
        const floatVal = document.getElementById('wiz_float_input').value || '0';
        const depoOn = document.getElementById('wiz_depository').checked;
        const depoVal = document.getElementById('wiz_depo_input').value || '0';

        const html = `
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="ui.text_2126">供应商代号</div>
                    <div class="text-warning fs-5 fw-bold">${code}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="ui.text_2127">供应商名称</div>
                    <div class="text-white fw-bold">${name}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="ui.text_2128">合作状态</div>
                    <div class="text-white">${status}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="purchase.effective_date">生效日期</div>
                    <div class="text-info">${date}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="purchase.category">类别</div>
                    <div class="text-white">${category}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="purchase.type">种类</div>
                    <div class="text-white">${typeDisplay}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="common.currency">货币</div>
                    <div class="text-white">${currency}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="purchase.price_float">价格浮动</div>
                    <div class="text-white">${floatOn ? '<i class="fas fa-check text-success me-1"></i>启用 (' + floatVal + '%)' : '<span class="text-muted" data-i18n="ui.text_390">未启用</span>'}</div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="purchase.deposit_req">定金要求</div>
                    <div class="text-white">${depoOn ? '<i class="fas fa-check text-success me-1"></i>启用 (' + depoVal + '%)' : '<span class="text-muted" data-i18n="ui.text_390">未启用</span>'}</div>
                </div>
            </div>
        `;
        document.getElementById('strategy-summary-content').innerHTML = html;
    }

    async function runStrategyValidation() {
        const errors = [];
        const card = document.getElementById('strat-validation-card');
        const icon = document.getElementById('strat-validation-icon');
        const title = document.getElementById('strat-validation-title');
        const confirmBtn = document.getElementById('btn-strat-confirm');
        const errorsContainer = document.getElementById('strat-errors-container');
        const errorsList = document.getElementById('strat-errors-list');
        const overrideContainer = document.getElementById('strat-override-container');

        // 重置状态
        card.className = 'card mb-4 state-loading';
        icon.className = 'fa-solid fa-spinner fa-spin me-2';
        title.textContent = (window.i18n?.t('js.validating_data') || 'Validating data...');
        confirmBtn.disabled = true;
        errorsContainer.style.display = 'none';
        overrideContainer.style.display = 'none';
        step2StratValidationPassed = false;
        hasDateConflict = false;
        overrideConfirmed = false;

        // 验证规则
        const floatOn = document.getElementById('wiz_float_currency').checked;
        const floatVal = parseFloat(document.getElementById('wiz_float_input').value) || 0;
        if (floatOn && floatVal === 0) {
            errors.push({ field: (window.i18n?.t('purchase.price_float') || 'Price Float'), message: (window.i18n?.t('js.price_float_threshold_error') || 'Threshold cannot be 0% when price float is enabled'), current: `启用，阈值=${floatVal}%` });
        }

        const depoOn = document.getElementById('wiz_depository').checked;
        const depoVal = parseFloat(document.getElementById('wiz_depo_input').value) || 0;
        if (depoOn && depoVal === 0) {
            errors.push({ field: (window.i18n?.t('purchase.deposit_req') || 'Deposit Required'), message: (window.i18n?.t('js.deposit_ratio_error') || 'Ratio cannot be 0% when deposit is required'), current: `启用，比例=${depoVal}%` });
        }

        // 如果有校验错误，直接显示错误，不检查日期冲突
        if (errors.length > 0) {
            card.className = 'card mb-4 state-error';
            icon.className = 'fa-solid fa-circle-xmark me-2';
            title.textContent = (window.i18n?.t('js.data_validation_failed') || 'Data validation failed');
            confirmBtn.disabled = true;
            step2StratValidationPassed = false;

            errorsList.innerHTML = errors.map(e => `
                <li class="mb-2">
                    <strong class="text-danger">${e.field}：</strong>
                    <span>${e.message}</span>
                    <span class="text-white-50 small ms-2" data-i18n="ui.text_450">(当前值: ${e.current})</span>
                </li>
            `).join('');
            errorsContainer.style.display = 'block';
            return;
        }

        // 校验通过后，检查日期冲突
        const code = document.getElementById('wiz_supplier_code_disp').value;
        const date = document.getElementById('wiz_effective_date').value;

        try {
            const res = await fetch(`{% url 'web_ui:purchase:strategy_date_conflict_check' %}?code=${encodeURIComponent(code)}&date=${encodeURIComponent(date)}`);
            const data = await res.json();

            if (data.conflict) {
                // 存在日期冲突，显示覆盖确认
                hasDateConflict = true;
                card.className = 'card mb-4 state-success';
                icon.className = 'fa-solid fa-circle-check me-2';
                title.textContent = (window.i18n?.t('js.validation_passed_conflict') || 'Validation passed (conflicts need confirm)');

                document.getElementById('strat-override-msg').textContent =
                    `该供应商在 ${date} 已存在策略记录，是否覆盖现有策略？`;
                overrideContainer.style.display = 'block';
                document.getElementById('strat-override-selected').style.display = 'none';

                // 未确认覆盖前，按钮禁用
                confirmBtn.disabled = true;
                step2StratValidationPassed = false;
            } else {
                // 无冲突，直接通过
                card.className = 'card mb-4 state-success';
                icon.className = 'fa-solid fa-circle-check me-2';
                title.textContent = (window.i18n?.t('js.data_validation_passed') || 'Data Validation Passed');
                confirmBtn.disabled = false;
                step2StratValidationPassed = true;
            }
        } catch (err) {
            // 网络错误时仍允许提交（后端会再次检查）
            card.className = 'card mb-4 state-success';
            icon.className = 'fa-solid fa-circle-check me-2';
            title.textContent = (window.i18n?.t('js.data_validation_passed') || 'Data Validation Passed');
            confirmBtn.disabled = false;
            step2StratValidationPassed = true;
        }
    }

    // ========================================
    // 覆盖确认按钮绑定
    // ========================================
    function bindOverrideButtons() {
        document.getElementById('btn-override-yes')?.addEventListener('click', () => {
            overrideConfirmed = true;
            document.getElementById('strat-override-selected').style.display = 'block';
            document.getElementById('btn-strat-confirm').disabled = false;
            step2StratValidationPassed = true;
        });

        document.getElementById('btn-override-no')?.addEventListener('click', () => {
            // 用户选择不覆盖，返回Step1修改日期
            strategyWizard.back();
        });
    }

    // ========================================
    // Step 2 提交（含密码验证）
    // ========================================
    function submitStrategyWithAuth() {
        return new Promise((resolve) => {
            requestPasswordVerify(
                'btn_modify_strategy',
                async (passwords) => {
                    await doSubmitStrategy(passwords);
                    strategyWizard.goToStep('finish');
                    resolve(false);
                },
                document.getElementById('form-modify-strategy'),
                (window.i18n?.t('js.modify_strategy') || 'Modify Strategy'),
                () => {
                    resolve(false);
                }
            );
        });
    }

    async function doSubmitStrategy(passwords) {
        const form = document.getElementById('form-modify-strategy');
        const formData = new FormData(form);

        // 添加密码到请求
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                formData.append(`sec_code_${slot}`, code);
            }
        }

        // 从GlobalFileUpload组件获取合同文件并添加到FormData
        if (contractUploader && contractUploader.getFile()) {
            formData.append('contract_file', contractUploader.getFile());
        }

        // 如果用户已确认覆盖，添加override标记
        if (hasDateConflict && overrideConfirmed) {
            formData.append('override', 'true');
        }

        try {
            const res = await fetch("{% url 'web_ui:purchase:supplier_strategy_modify' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCsrfToken() }
            });
            const data = await res.json();

            if (data.success) {
                renderStratFinish(true, null, data.contract_uploaded);
            } else {
                renderStratFinish(false, data.message || (window.i18n?.t('js.check_input_retry') || 'Please check input and retry'));
            }
        } catch (err) {
            console.error('[StrategyWizard] Submit error:', err);
            renderStratFinish(false, (window.i18n?.t('js.network_check_retry') || 'Network error, please check and retry'));
        }
    }

    function renderStratFinish(isSuccess, errorMessage, contractUploaded = false) {
        const header = document.getElementById('strat-finish-header');
        const panel = document.getElementById('strat-finish-panel');
        const card = document.getElementById('strat-finish-card');

        if (isSuccess) {
            card.classList.remove('border-danger');
            card.classList.add('border-success');

            const code = document.getElementById('wiz_supplier_code_disp').value;
            const name = document.getElementById('wiz_supplier_name').value;
            const contractNote = contractUploaded
                ? '<span class="badge bg-success ms-2"><i class="fas fa-file-contract me-1"></i>合同已上传</span>'
                : '';

            header.innerHTML = `
                <div class="display-1 text-success mb-4"><i class="fa-solid fa-circle-check"></i></div>
                <h3 class="text-white mb-3" data-i18n="ui.text_451">策略修改成功${contractNote}</h3>
                <p class=\"text-muted mb-0\">${(window.i18n?.t('ui.supplier') || 'Supplier')} <strong class=\"text-warning\">${code}</strong> - ${name} ${(window.i18n?.t('desc.d173') || "'s policy has been updated")}</p>
            `;
            panel.innerHTML = '';
        } else {
            card.classList.remove('border-success');
            card.classList.add('border-danger');

            header.innerHTML = `
                <div class="display-1 text-danger mb-4"><i class="fa-solid fa-circle-xmark"></i></div>
                <h3 class="text-white mb-3" data-i18n="ui.text_452">策略修改失败</h3>
                <p class="text-muted mb-0" data-i18n="ui.text_453">请检查后重试</p>
            `;
            panel.innerHTML = `
                <div class="card bg-black bg-opacity-50 border-danger border-opacity-25 mx-auto" style="max-width: 500px;">
                    <div class="card-header bg-danger bg-opacity-10 border-0">
                        <i class="fa-solid fa-triangle-exclamation me-2 text-danger"></i>
                        <span class="text-danger" data-i18n="ui.text_63">错误信息</span>
                    </div>
                    <div class="card-body"><p class="text-white mb-0">${errorMessage}</p></div>
                </div>
            `;
        }
    }

    // ========================================
    // 工具函数
    // ========================================
    function viewContract(url) {
        document.getElementById('contract-frame').src = url;
        bootstrap.Modal.getOrCreateInstance(document.getElementById('contractViewerModal')).show();
    }

    function getCsrfToken() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }
</script>
{% endblock %}