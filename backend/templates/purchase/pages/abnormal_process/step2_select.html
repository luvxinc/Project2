<!-- 异常处理向导 - 步骤2: 选取方式 (按订单分组) -->
<div id="process-step-2" class="wizard-step-content" style="display: none;">

    <!-- 操作须知 -->
    <div class="alert alert-info bg-info bg-opacity-10 border-info mb-4">
        <div class="d-flex align-items-start">
            <i class="fas fa-info-circle text-info me-3 mt-1"></i>
            <div>
                <h6 class="text-info mb-2" data-i18n="common.operation_notes">操作须知</h6>
                <ol class="text-white-50 small mb-0 ps-3">
                    <li class="mb-1"><strong class="text-white" data-i18n="ui.text_727">仅修正发货单</strong>：<span
                            data-i18n="instructions.desc_95">根据实际收货数量修正发货数量使差异为0，不修正订单。</span><span class="text-success"
                            data-i18n="ui.text_728">发货数≤订货数时无影响</span>；<span class="text-danger"
                            data-i18n="ui.text_729">发货数>订货数时差异顺延至下次订货，可能导致计价混乱</span></li>
                    <li class="mb-1"><strong class="text-white" data-i18n="ui.text_730">同步修正发货单与订单</strong>：<span
                            data-i18n="instructions.desc_41">根据实际收货数量同时修改发货数量和订单数量，使三者匹配，不产生误差</span></li>
                    <li class="mb-1"><strong class="text-white" data-i18n="abnormal.delayed_shipment">新建延迟入库发货单</strong>：<span
                            data-i18n="instructions.desc_47">将差异数量的货物新建发货单延迟入库，使当前差异为0</span></li>
                    <li><strong class="text-white" data-i18n="ui.text_732">差异算作厂商错误</strong>：<span
                            data-i18n="instructions.desc_34">入库数大于发货数时，多收货物以成本0入库；入库数小于发货数时，差异按价格入库后立即出库算作耗损</span></li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 策略关系流程图 -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header bg-secondary bg-opacity-25 border-secondary py-2">
            <i class="fas fa-project-diagram me-2 text-white-50"></i>
            <span class="text-white" data-i18n="ui.text_733">策略关系图</span>
            <span class="badge bg-secondary ms-2" data-i18n="ui.text_734">点击展开</span>
            <button class="btn btn-sm btn-link text-white-50 float-end p-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#strategy-diagram-collapse">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="collapse" id="strategy-diagram-collapse">
            <div class="card-body">
                <!-- 正常流程 -->
                <div class="text-center mb-4">
                    <div class="text-white-50 small mb-2" data-i18n="ui.text_2261">正常流程（理想状态）</div>
                    <div class="d-flex justify-content-center align-items-center">
                        <div class="flow-box bg-primary bg-opacity-25 border-primary">
                            <i class="fas fa-file-invoice text-primary"></i>
                            <div class="small text-white" data-i18n="ui.text_2262">订货</div>
                            <div class="text-primary fw-bold">100</div>
                        </div>
                        <i class="fas fa-arrow-right text-white-50 mx-3"></i>
                        <div class="flow-box bg-info bg-opacity-25 border-info">
                            <i class="fas fa-shipping-fast text-info"></i>
                            <div class="small text-white" data-i18n="ui.text_2154">发货</div>
                            <div class="text-info fw-bold">100</div>
                        </div>
                        <i class="fas fa-arrow-right text-white-50 mx-3"></i>
                        <div class="flow-box bg-success bg-opacity-25 border-success">
                            <i class="fas fa-warehouse text-success"></i>
                            <div class="small text-white" data-i18n="ui.text_2005">入库</div>
                            <div class="text-success fw-bold">100</div>
                        </div>
                        <i class="fas fa-check-circle text-success ms-3 fa-lg"></i>
                    </div>
                </div>

                <hr class="border-secondary">

                <!-- 异常情况说明 -->
                <div class="row g-3 mb-4">
                    <!-- 少收情况 (diff > 0) -->
                    <div class="col-md-6">
                        <div class="p-3 rounded bg-warning bg-opacity-10 border border-warning border-opacity-25 h-100">
                            <div class="text-warning fw-bold mb-2"><i class="fas fa-minus-circle me-1"></i><span
                                    data-i18n="ui.icon_3226">少收情况 (入库</span>
                                < 发货)</div>
                                    <div class="d-flex justify-content-center align-items-center mb-2">
                                        <div class="flow-box-sm bg-info bg-opacity-25 border-info">
                                            <div class="small" data-i18n="ui.text_2154">发货</div>
                                            <div class="fw-bold text-info">100</div>
                                        </div>
                                        <i class="fas fa-arrow-right text-white-50 mx-2"></i>
                                        <div class="flow-box-sm bg-warning bg-opacity-25 border-warning">
                                            <div class="small" data-i18n="ui.text_2005">入库</div>
                                            <div class="fw-bold text-warning">90</div>
                                        </div>
                                        <span class="badge bg-warning text-dark ms-2">-10</span>
                                    </div>
                                    <div class="small text-white-50">
                                        <div class="mb-1"><span class="badge bg-primary me-1">1</span>发货量 → 90</div>
                                        <div class="mb-1"><span class="badge bg-success me-1">2</span>发货+订货 → 90</div>
                                        <div class="mb-1"><span class="badge bg-warning me-1">3</span>差异10件延迟入库</div>
                                        <div><span class="badge bg-danger me-1">4</span>缺少10件按原价出库耗损</div>
                                    </div>
                            </div>
                        </div>
                        <!-- 多收情况 (diff < 0) -->
                        <div class="col-md-6">
                            <div
                                class="p-3 rounded bg-success bg-opacity-10 border border-success border-opacity-25 h-100">
                                <div class="text-success fw-bold mb-2"><i class="fas fa-plus-circle me-1"></i><span
                                        data-i18n="ui.icon_3227">多收情况 (入库 > 发货)</span></div>
                                <div class="d-flex justify-content-center align-items-center mb-2">
                                    <div class="flow-box-sm bg-info bg-opacity-25 border-info">
                                        <div class="small" data-i18n="ui.text_2154">发货</div>
                                        <div class="fw-bold text-info">100</div>
                                    </div>
                                    <i class="fas fa-arrow-right text-white-50 mx-2"></i>
                                    <div class="flow-box-sm bg-success bg-opacity-25 border-success">
                                        <div class="small" data-i18n="ui.text_2005">入库</div>
                                        <div class="fw-bold text-success">110</div>
                                    </div>
                                    <span class="badge bg-success ms-2">+10</span>
                                </div>
                                <div class="small text-white-50">
                                    <div class="mb-1"><span class="badge bg-primary me-1">1</span>发货量 → 110</div>
                                    <div class="mb-1"><span class="badge bg-success me-1">2</span>发货+订货 → 110</div>
                                    <div><span class="badge bg-danger me-1">4</span>多出10件以0成本入库</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 策略修复示意图 -->
                    <div class="text-white-50 small mb-2" data-i18n="ui.text_2269">各策略修复效果示意</div>
                    <table class="table table-sm table-dark table-bordered mb-0">
                        <thead>
                            <tr class="text-center small">
                                <th class="bg-secondary bg-opacity-25" data-i18n="ui.text_2270">策略</th>
                                <th class="bg-primary bg-opacity-25" data-i18n="ui.text_2271">订货量</th>
                                <th class="bg-info bg-opacity-25" data-i18n="js.ship_qty">发货量</th>
                                <th class="bg-success bg-opacity-25" data-i18n="ui.text_2273">入库量</th>
                                <th class="bg-secondary bg-opacity-25" data-i18n="common.remark">备注</th>
                            </tr>
                        </thead>
                        <tbody class="small">
                            <tr class="text-white-50">
                                <td colspan="5" class="bg-secondary bg-opacity-10 text-center" data-i18n="ui.text_2275">
                                    原始数据：订货100, 发货100, 入库90 (少收10)</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-primary">1</span> 仅修正发货单</td>
                                <td class="text-center text-white-50">100 <span class="text-white-50"
                                        data-i18n="ui.text_735">(不变)</span></td>
                                <td class="text-center">100 <i class="fas fa-arrow-right text-warning mx-1"></i> <span
                                        class="text-success">90</span></td>
                                <td class="text-center text-success">90</td>
                                <td class="text-warning small" data-i18n="desc.d178">发货&lt;订货，差额留待下次</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-success">2</span> 同步修正订单</td>
                                <td class="text-center">100 <i class="fas fa-arrow-right text-warning mx-1"></i> <span
                                        class="text-success">90</span></td>
                                <td class="text-center">100 <i class="fas fa-arrow-right text-warning mx-1"></i> <span
                                        class="text-success">90</span></td>
                                <td class="text-center text-success">90</td>
                                <td class="text-success small" data-i18n="ui.text_2276">三者匹配，无差异</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-warning">3</span> 延迟入库</td>
                                <td class="text-center text-white-50">100 <span class="text-white-50"
                                        data-i18n="ui.text_735">(不变)</span></td>
                                <td class="text-center text-white-50">100 <span class="text-white-50"
                                        data-i18n="ui.text_735">(不变)</span></td>
                                <td class="text-center text-white-50">90 <span class="text-white-50"
                                        data-i18n="ui.text_735">(不变)</span></td>
                                <td class="text-warning small" data-i18n="ui.text_2277">新建发货单：入库10</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-danger">4</span> 厂商错误</td>
                                <td class="text-center text-white-50">100 <span class="text-white-50"
                                        data-i18n="ui.text_735">(不变)</span></td>
                                <td class="text-center text-white-50">100 <span class="text-white-50"
                                        data-i18n="ui.text_735">(不变)</span></td>
                                <td class="text-center">90 <i class="fas fa-arrow-right text-warning mx-1"></i> <span
                                        class="text-info">100</span></td>
                                <td class="text-danger small" data-i18n="ui.text_2278">新增-10件出库耗损</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <style>
            .flow-box {
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 80px;
                height: 80px;
                border-radius: 8px;
                border: 1px solid;
            }

            .flow-box-sm {
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 60px;
                height: 50px;
                border-radius: 6px;
                border: 1px solid;
            }
        </style>

        <!-- 选择进度提示 -->
        <div class="alert alert-secondary bg-secondary bg-opacity-10 border-secondary mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-tasks me-2 text-white-50"></i>
                    <span class="text-white" data-i18n="ui.text_741">选择进度：</span>
                    <span class="text-info fw-bold" id="process-selection-progress">0 / 0</span>
                    <span class="text-white-50 ms-2" data-i18n="ui.text_742">个订单已选择策略</span>
                </div>
                <span class="badge bg-warning" id="process-items-count" data-i18n="ui.text_743">0 条记录</span>
            </div>
        </div>

        <!-- 按订单分组的板块容器 -->
        <div id="process-po-groups-container">
            <!-- JS动态生成订单板块 -->
        </div>

        <!-- 延迟入库日期（当有订单选择策略3时显示） -->
        <div class="card bg-dark border-warning mb-4" id="delay-date-card" style="display: none;">
            <div class="card-header bg-warning bg-opacity-10 border-warning">
                <i class="fas fa-calendar-alt me-2 text-warning"></i>
                <span class="text-white" data-i18n="ui.text_744">延迟入库日期</span>
                <span class="badge bg-warning text-dark ms-2" data-i18n="common.required">必填</span>
            </div>
            <div class="card-body">
                <p class="text-white-50 small mb-3" data-i18n="ui.text_746">您选择了"延迟入库"策略，请设置所有延迟货物的预计到货日期：</p>
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <input type="date" id="process-delay-date"
                            class="form-control bg-dark text-white border-warning"
                            data-i18n-placeholder="form.placeholder.generic_10" placeholder="选择日期">
                    </div>
                    <div class="col-md-8">
                        <span class="text-white-50 small">
                            <i class="fas fa-info-circle me-1"></i>
                            此日期将应用于所有选择"延迟入库"策略的订单
                        </span>
                        <div class="text-warning small mt-1">
                            <i class="fas fa-clock me-1"></i>
                            可选日期：<span id="delay-date-min-display">-</span> 之后
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 处理备注 -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-secondary bg-opacity-25 border-secondary">
                <i class="fas fa-comment-alt me-2 text-white-50"></i>
                <span class="text-white" data-i18n="abnormal.process_note">处理备注</span>
                <span class="badge bg-secondary ms-2" data-i18n="common.optional">可选</span>
            </div>
            <div class="card-body">
                <textarea id="process-note-input" class="form-control bg-dark text-white border-secondary" rows="2"
                    data-i18n-placeholder="form.placeholder.generic_9" placeholder="请填写处理备注（可选）..."></textarea>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="d-flex justify-content-between">
            <button class="btn btn-outline-secondary btn-lg px-4 rounded-pill" onclick="goToProcessStep(1)">
                <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.prev">上一步</span>
            </button>
            <button class="btn btn-primary btn-lg px-4 rounded-pill" id="btn-goto-verify" onclick="goToProcessStep(3)"
                disabled>
                <i class="fas fa-shield-alt me-2"></i><span data-i18n="ui.icon_3229">验证修改</span>
            </button>
        </div>
    </div>

    <style>
        /* 订单板块样式 */
        .po-group-card {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .po-group-card.method-selected {
            border-left-color: #0d6efd;
        }

        .po-group-card .method-btn {
            transition: all 0.15s ease;
        }

        .po-group-card .method-btn:hover:not(.active):not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .po-group-card .method-btn.active {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
    </style>