<!-- 入库单修改向导 - 使用GlobalWizard组件 -->
{% load static %}
{% load security_tags %}

<div class="glass-card p-4 shadow-lg" id="receive-edit-wizard-container">
    <!-- Header -->
    <div class="wizard-header d-flex flex-column mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="bg-warning bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; flex-shrink: 0;">
                    <i class="fas fa-edit fa-2x text-warning"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_819">修改入库单向导</h5>
                    <p class="text-white-50 small mb-0" id="receive-edit-logistic-num-label" data-i18n="ui.text_418">物流单号: -</p>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="showListView()">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
            </button>
        </div>
        <hr class="border-secondary border-opacity-25 my-4 w-100">
    </div>
    
    <!-- StepBar 锚点 (GlobalWizard必须) -->
    <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

    <!-- 加载中 -->
    <div id="receive-edit-loading" class="text-center py-5">
        <div class="spinner-border text-warning" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="ui.text_493">正在加载入库单数据...</p>
    </div>

    <!-- ===================================== -->
    <!-- 流程1: 修改入库数据 -->
    <!-- ===================================== -->
    {% include "purchase/pages/receive_mgmt/receive_edit_step1.html" %}

    <!-- ===================================== -->
    <!-- 流程2: 修改预览 -->
    <!-- ===================================== -->
    {% include "purchase/pages/receive_mgmt/receive_edit_step2.html" %}

    <!-- ===================================== -->
    <!-- 流程3: 完成 -->
    <!-- ===================================== -->
    {% include "purchase/pages/receive_mgmt/receive_edit_step3.html" %}
    
    <!-- 安全验证隐藏表单 -->
    <div id="policy-check-receive-edit" class="d-none">
        {% security_inputs 'btn_receive_mgmt_edit' %}
    </div>
</div>

<script>
    // ========================================
    // 修改入库单向导 - 公共状态和函数
    // ========================================
    let receiveEditWizard = null;  // GlobalWizard实例
    let receiveEditCurrentLogisticNum = null;
    let receiveEditOriginalData = null;
    let receiveEditCurrentStep = 1;
    
    // 修改后的数据
    let receiveEditModifiedItems = [];  // [{po_num, po_sku, receive_quantity}, ...]
    
    // 格式化数字
    function receiveEditFormatNumber(num, maxDecimals = 4) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return parseFloat(num.toFixed(maxDecimals)).toString();
    }
    
    // 初始化GlobalWizard
    let _receiveEditStepUpdateInProgress = false;
    
    function initReceiveEditWizard() {
        if (receiveEditWizard) {
            receiveEditWizard.destroy();
        }
        
        receiveEditWizard = new GlobalWizard({
            containerId: 'receive-edit-wizard-container',
            steps: [
                { id: 'edit_items', label: (window.i18n?.t('js.modify_receiving_data') || 'Modify Receiving Data'), contentSelector: '#receive-edit-step-1' },
                { id: 'preview', label: (window.i18n?.t('js.modify_preview') || 'Modify Preview'), contentSelector: '#receive-edit-step-2' },
                { id: 'done', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#receive-edit-step-3' }
            ],
            onStepChange: (from, to) => {
                if (_receiveEditStepUpdateInProgress) return;
                receiveEditCurrentStep = to + 1;
                for (let i = 1; i <= 3; i++) {
                    const el = document.getElementById(`receive-edit-step-${i}`);
                    if (el) el.style.display = 'none';
                }
                const target = document.getElementById(`receive-edit-step-${to + 1}`);
                if (target) target.style.display = 'block';
            },
            onBeforeNext: async (step, index) => {
                return true;
            },
            onComplete: (data) => {
            },
            onRestart: () => {
                showReceiveEditStep(1);
            }
        });
    }
    
    // 手动显示指定步骤
    function showReceiveEditStep(stepNum) {
        for (let i = 1; i <= 3; i++) {
            const el = document.getElementById(`receive-edit-step-${i}`);
            if (el) el.style.display = 'none';
        }
        const target = document.getElementById(`receive-edit-step-${stepNum}`);
        if (target) target.style.display = 'block';
        
        receiveEditCurrentStep = stepNum;
        
        if (receiveEditWizard) {
            _receiveEditStepUpdateInProgress = true;
            receiveEditWizard.goToStep(stepNum - 1);
            _receiveEditStepUpdateInProgress = false;
        }
        
        // 如果进入Step2，渲染预览
        if (stepNum === 2) {
            if (typeof renderReceiveEditPreview === 'function') {
                renderReceiveEditPreview();
            }
        }
        
        // 如果进入Step3，执行提交
        if (stepNum === 3) {
            if (typeof runReceiveEditSubmit === 'function') {
                runReceiveEditSubmit();
            }
        }
    }
    
    // 加载入库单数据进行编辑
    function loadReceiveForEdit(logisticNum) {
        receiveEditCurrentLogisticNum = logisticNum;
        receiveEditCurrentStep = 1;
        receiveEditModifiedItems = [];
        
        document.getElementById('receive-edit-logistic-num-label').textContent = `物流单号: ${logisticNum}`;
        document.getElementById('receive-edit-loading').style.display = 'block';
        
        // 隐藏所有步骤
        for (let i = 1; i <= 3; i++) {
            const el = document.getElementById(`receive-edit-step-${i}`);
            if (el) el.style.display = 'none';
        }
        
        fetch(`{% url 'web_ui:purchase:receive_mgmt_detail' %}?logistic_num=${encodeURIComponent(logisticNum)}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('receive-edit-loading').style.display = 'none';
                
                if (!data.success) {
                    GlobalModal.showError({
                        title: (window.i18n?.t('js.load_failed') || 'Load Failed'),
                        message: data.message || (window.i18n?.t('js.load_receive_failed') || 'Load receiving failed'),
                        onConfirmOverride: function() { GlobalModal.hide(); showListView(); }
                    });
                    return;
                }
                
                receiveEditOriginalData = data.data;
                
                // 初始化GlobalWizard
                initReceiveEditWizard();
                
                // 加载Step1的数据
                if (typeof loadReceiveEditStep1Data === 'function') {
                    loadReceiveEditStep1Data(receiveEditOriginalData);
                }
                
                // 显示第一步
                document.getElementById('receive-edit-step-1').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('receive-edit-loading').style.display = 'none';
                GlobalModal.showError({
                    title: (window.i18n?.t('js.load_failed') || 'Load Failed'),
                    message: (window.i18n?.t('js.load_receive_failed_colon') || 'Load receiving failed: ') + err,
                    onConfirmOverride: function() { GlobalModal.hide(); showListView(); }
                });
            });
    }
    
    // 获取CSRF Token
    function getReceiveEditCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
    }
    
    // 确认入库 - 带密码验证
    function receiveEditConfirmWithAuth() {
        // 验证备注必填
        const noteEl = document.getElementById('receive-edit-note');
        const note = noteEl.value.trim();
        
        if (!note) {
            noteEl.classList.add('border-danger');
            GlobalModal.showWarning({
                title: (window.i18n?.t('js.notes_required') || 'Notes required'),
                message: (window.i18n?.t('js.enter_edit_reason') || 'Enter edit reason.')
            });
            noteEl.focus();
            return;
        }
        
        if (note === (window.i18n?.t('js.original_receive') || 'Original Receiving')) {
            noteEl.classList.add('border-danger');
            GlobalModal.showWarning({
                title: (window.i18n?.t('js.notes_invalid') || 'Notes invalid'),
                message: (window.i18n?.t('js.note_cannot_be_original_receive') || '备注不能为"原始收货"，请输入具体的修改原因。')
            });
            noteEl.focus();
            return;
        }
        
        noteEl.classList.remove('border-danger');
        
        if (typeof requestPasswordVerify === 'function') {
            requestPasswordVerify(
                'btn_receive_mgmt_edit',  // action key
                (passwords) => {
                    // 密码验证通过，存储密码并进入Step 3执行提交
                    console.log('[ReceiveEditWizard] Security verified, proceeding to submit...');
                    receiveEditVerifiedPasswords = passwords;
                    showReceiveEditStep(3);
                },
                document.getElementById('receive-edit-wizard-container'),  // 容器元素
                (window.i18n?.t('js.confirm_receiving') || 'Confirm Receiving'),  // 显示名称
                () => {
                    // 用户取消密码验证，保持在 Step 2
                    console.log('[ReceiveEditWizard] User cancelled security verification');
                }
            );
        } else {
            // requestPasswordVerify 不可用时的后备处理
            console.warn('[ReceiveEditWizard] requestPasswordVerify not available, proceeding without auth');
            receiveEditVerifiedPasswords = {};
            showReceiveEditStep(3);
        }
    }

    // 存储验证通过的密码（用于Step3提交）
    let receiveEditVerifiedPasswords = null;

</script>