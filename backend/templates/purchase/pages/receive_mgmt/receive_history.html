<!-- 入库单历史修订记录页面 -->
<div class="glass-card p-4 shadow-lg">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
        <div class="d-flex align-items-center">
            <div class="bg-info bg-opacity-25 p-3 rounded-circle me-3">
                <i class="fas fa-history fa-2x text-info"></i>
            </div>
            <div>
                <h5 class="text-white mb-1" data-i18n="ui.text_794">入库单历史修订记录</h5>
                <p class="text-white-50 small mb-0" id="receive-history-logistic-num-label" data-i18n="ui.text_418">物流单号: -</p>
            </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="showListView()">
            <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
        </button>
    </div>

    <!-- 加载中 -->
    <div id="receive-history-loading" class="text-center py-5">
        <div class="spinner-border text-info" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="ui.text_707">正在加载历史记录...</p>
    </div>

    <!-- 双栏布局 -->
    <div id="receive-history-content" class="row g-4" style="display: none;">
        <!-- 左栏：入库修订记录 -->
        <div class="col-md-6">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header bg-primary bg-opacity-10 border-secondary">
                    <i class="fas fa-clipboard-check me-2 text-primary"></i>
                    <span class="text-white fw-bold" data-i18n="ui.text_797">入库修订记录</span>
                    <span class="badge bg-primary ms-2" id="receive-version-count">0</span>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    <div id="receive-versions-container" class="p-3">
                        <!-- JS动态填充 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 右栏：差异修订记录 -->
        <div class="col-md-6">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header bg-warning bg-opacity-10 border-secondary">
                    <i class="fas fa-balance-scale me-2 text-warning"></i>
                    <span class="text-white fw-bold" data-i18n="ui.text_798">入库差异修订记录</span>
                    <span class="badge bg-warning ms-2" id="diff-version-count">0</span>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    <div id="diff-versions-container" class="p-3">
                        <!-- JS动态填充 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .receive-version-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(108, 117, 125, 0.3);
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .receive-version-header {
        background: rgba(255, 255, 255, 0.05);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(108, 117, 125, 0.2);
    }
    
    .receive-version-header.initial {
        background: linear-gradient(90deg, rgba(13, 110, 253, 0.2), transparent);
        border-left: 3px solid #0d6efd;
    }
    
    .receive-version-header.adjust {
        background: linear-gradient(90deg, rgba(255, 193, 7, 0.2), transparent);
        border-left: 3px solid #ffc107;
    }
    
    .receive-version-seq {
        font-family: 'SF Mono', monospace;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .receive-version-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .receive-version-meta i {
        margin-right: 0.3rem;
    }
    
    .receive-version-body {
        padding: 1rem;
    }
    
    .receive-change-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        font-size: 0.85rem;
    }
    
    .receive-change-item.adjust {
        border-left: 3px solid #ffc107;
    }
    
    .receive-change-old {
        color: #dc3545;
        text-decoration: line-through;
    }
    
    .receive-change-new {
        color: #198754;
    }
    
    .receive-items-table {
        width: 100%;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .receive-items-table th {
        color: rgba(255, 255, 255, 0.5);
        font-weight: normal;
        padding: 0.3rem 0.5rem;
        border-bottom: 1px solid rgba(108, 117, 125, 0.2);
    }
    
    .receive-items-table td {
        color: #fff;
        padding: 0.3rem 0.5rem;
    }
    
    .receive-empty-state {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.4);
    }
</style>

<script>
    let receiveHistoryLogisticNum = null;
    
    function loadReceiveHistory(logisticNum) {
        receiveHistoryLogisticNum = logisticNum;
        document.getElementById('receive-history-logistic-num-label').textContent = `物流单号: ${logisticNum}`;
        
        const loading = document.getElementById('receive-history-loading');
        const content = document.getElementById('receive-history-content');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        fetch(`{% url 'web_ui:purchase:receive_mgmt_history' %}?logistic_num=${encodeURIComponent(logisticNum)}`)
            .then(r => r.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    document.getElementById('receive-versions-container').innerHTML = 
                        `<div class="receive-empty-state"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><p data-i18n="ui.text_710">${data.message || (window.i18n?.t('js.load_failed') || 'Load Failed')}</p></div>`;
                    document.getElementById('diff-versions-container').innerHTML = '';
                    content.style.display = 'flex';
                    return;
                }
                
                content.style.display = 'flex';
                renderReceiveVersions(data.data.receive_versions);
                renderDiffVersions(data.data.diff_versions);
            })
            .catch(err => {
                loading.style.display = 'none';
                content.style.display = 'flex';
                document.getElementById('receive-versions-container').innerHTML = 
                    `<div class="receive-empty-state"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p data-i18n="ui.text_490">网络错误: ${err}</p></div>`;
            });
    }
    
    // 渲染入库修订版本
    function renderReceiveVersions(versions) {
        const container = document.getElementById('receive-versions-container');
        document.getElementById('receive-version-count').textContent = versions.length;
        
        if (!versions || versions.length === 0) {
            container.innerHTML = '<div class="receive-empty-state"><i class="fas fa-inbox fa-2x mb-2"></i><p data-i18n="purchase.no_receive_data">暂无入库记录</p></div>';
            return;
        }
        
        let html = '';
        versions.forEach(v => {
            const headerClass = v.is_initial ? 'initial' : 'adjust';
            
            html += `
                <div class="receive-version-card">
                    <div class="receive-version-header ${headerClass}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="receive-version-seq text-info">${v.seq}</span>
                            ${v.is_initial ? '<span class="badge bg-primary" data-i18n="ui.text_802">初始入库</span>' : '<span class="badge bg-warning text-dark" data-i18n="ui.text_714">修订</span>'}
                        </div>
                        <div class="receive-version-meta">
                            <span><i class="fas fa-calendar"></i>${v.receive_date}</span>
                            <span><i class="fas fa-user"></i>${v.by || '-'}</span>
                        </div>
                        ${v.note ? `<div class="text-white-50 small mt-2"><i class="fas fa-comment me-1"></i>${v.note}</div>` : ''}
                    </div>
                    <div class="receive-version-body">
            `;
            
            if (v.is_initial && v.items && v.items.length > 0) {
                // 初始版本显示货物表格
                html += `
                    <table class="receive-items-table">
                        <thead>
                            <tr>
                                <th data-i18n="purchase.order_num">订单号</th>
                                <th>SKU</th>
                                <th class="text-end" data-i18n="table.shipped_qty">发货数量</th>
                                <th class="text-end" data-i18n="table.received_qty">入库数量</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                v.items.forEach(item => {
                    const diffClass = item.sent_qty !== item.receive_qty ? 'text-warning' : '';
                    html += `
                        <tr>
                            <td class="font-monospace text-info" style="font-size: 0.7rem;">${item.po_num || '-'}</td>
                            <td class="font-monospace">${item.po_sku}</td>
                            <td class="text-end">${item.sent_qty}</td>
                            <td class="text-end ${diffClass}">${item.receive_qty}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
            } else if (v.changes && v.changes.length > 0) {
                // 修订版本显示变更
                v.changes.forEach(c => {
                    if (c.type === 'adjust' && c.fields) {
                        let fieldsHtml = c.fields.map(f => 
                            `${f.field}: <span class="receive-change-old">${f.old}</span> <i class="fas fa-arrow-right text-muted mx-1"></i> <span class="receive-change-new">${f.new}</span>`
                        ).join(', ');
                        html += `
                            <div class="receive-change-item adjust">
                                <span class="badge bg-warning text-dark me-2" data-i18n="ui.text_725">调整</span>
                                <span class="font-monospace">${c.po_sku}</span>
                                <span class="ms-2">${fieldsHtml}</span>
                            </div>
                        `;
                    }
                });
            } else {
                html += '<div class="text-white-50 small" data-i18n="common.no_change">无变更</div>';
            }
            
            html += '</div></div>';
        });
        
        container.innerHTML = html;
    }
    
    // 渲染差异修订版本
    function renderDiffVersions(versions) {
        const container = document.getElementById('diff-versions-container');
        document.getElementById('diff-version-count').textContent = versions.length;
        
        if (!versions || versions.length === 0) {
            container.innerHTML = '<div class="receive-empty-state"><i class="fas fa-check-circle fa-2x mb-2 text-success"></i><p>没有入库差异记录<br><small class="text-white-50" data-i18n="ui.text_805">全部货物正常入库</small></p></div>';
            return;
        }
        
        let html = '';
        versions.forEach(v => {
            const headerClass = v.is_initial ? 'initial' : 'adjust';
            
            html += `
                <div class="receive-version-card">
                    <div class="receive-version-header ${headerClass}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="receive-version-seq text-warning">${v.seq}</span>
                            ${v.is_initial ? '<span class="badge bg-danger" data-i18n="ui.text_806">初始差异</span>' : '<span class="badge bg-warning text-dark" data-i18n="ui.text_807">差异调整</span>'}
                        </div>
                        <div class="receive-version-meta">
                            <span><i class="fas fa-calendar"></i>${v.receive_date}</span>
                            <span><i class="fas fa-user"></i>${v.by || '-'}</span>
                        </div>
                        ${v.note ? `<div class="text-white-50 small mt-2"><i class="fas fa-comment me-1"></i>${v.note}</div>` : ''}
                    </div>
                    <div class="receive-version-body">
            `;
            
            if (v.is_initial && v.items && v.items.length > 0) {
                // 初始差异显示表格
                html += `
                    <table class="receive-items-table">
                        <thead>
                            <tr>
                                <th data-i18n="purchase.order_num">订单号</th>
                                <th>SKU</th>
                                <th class="text-end" data-i18n="ui.text_2154">发货</th>
                                <th class="text-end" data-i18n="ui.text_2005">入库</th>
                                <th class="text-end" data-i18n="table.variance">差异</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                v.items.forEach(item => {
                    const diffClass = item.diff_qty > 0 ? 'text-danger' : (item.diff_qty < 0 ? 'text-success' : '');
                    const diffText = item.diff_qty > 0 ? `+${item.diff_qty}` : item.diff_qty;
                    html += `
                        <tr>
                            <td class="font-monospace text-info" style="font-size: 0.7rem;">${item.po_num || '-'}</td>
                            <td class="font-monospace">${item.po_sku}</td>
                            <td class="text-end">${item.sent_qty}</td>
                            <td class="text-end">${item.receive_qty}</td>
                            <td class="text-end ${diffClass} fw-bold">${diffText}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
            } else if (v.changes && v.changes.length > 0) {
                // 差异调整记录
                v.changes.forEach(c => {
                    if (c.type === 'adjust' && c.fields) {
                        let fieldsHtml = c.fields.map(f => 
                            `${f.field}: <span class="receive-change-old">${f.old}</span> <i class="fas fa-arrow-right text-muted mx-1"></i> <span class="receive-change-new">${f.new}</span>`
                        ).join(', ');
                        html += `
                            <div class="receive-change-item adjust">
                                <span class="badge bg-warning text-dark me-2" data-i18n="ui.text_725">调整</span>
                                <span class="font-monospace">${c.po_sku}</span>
                                <span class="ms-2">${fieldsHtml}</span>
                            </div>
                        `;
                    }
                });
            } else {
                html += '<div class="text-white-50 small" data-i18n="common.no_change">无变更</div>';
            }
            
            html += '</div></div>';
        });
        
        container.innerHTML = html;
    }
</script>