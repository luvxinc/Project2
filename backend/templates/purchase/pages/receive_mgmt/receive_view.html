{% load i18n %}
<!-- 入库单详情查看页面 -->
<div class="glass-card p-4 shadow-lg">
    <!-- Header -->
    <div
        class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
        <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center"
                style="width: 56px; height: 56px;">
                <i class="fas fa-clipboard-check fa-2x text-primary"></i>
            </div>
            <div>
                <h5 class="text-white mb-1" data-i18n="ui.text_491">查看入库单详情</h5>
                <p class="text-white-50 small mb-0" id="receive-view-logistic-num-label" data-i18n="ui.text_418">物流单号: -
                </p>
            </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="showListView()">
            <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
        </button>
    </div>

    <!-- 加载中 -->
    <div id="receive-view-loading" class="text-center py-5">
        <div class="spinner-border text-info" role="status"></div>
        <p class="text-white-50 mt-3 mb-0" data-i18n="ui.text_493">正在加载入库单数据...</p>
    </div>

    <!-- 入库单内容 -->
    <div id="receive-view-content" style="display: none;">
        <!-- 操作按钮 (右对齐，在物流信息上方) -->
        <div class="d-flex justify-content-end gap-2 mb-4 flex-wrap">
            <button class="btn btn-warning rounded-pill px-3" id="btn-receive-view-edit" onclick="handleReceiveEdit()">
                <i class="fas fa-pen me-2"></i><span data-i18n="ui.text_461">修改入库单</span>
            </button>
            <button class="btn btn-outline-secondary rounded-pill px-3" id="btn-receive-view-history"
                onclick="handleReceiveHistory()">
                <i class="fas fa-history me-2"></i><span data-i18n="common.history">历史记录</span>
            </button>
            <button class="btn btn-outline-danger rounded-pill px-3" id="btn-receive-view-delete"
                onclick="handleReceiveDelete()">
                <i class="fas fa-trash me-2"></i><span data-i18n="ui.icon_3249">删除入库单</span>
            </button>
        </div>

        <!-- 框体1: 物流信息 -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-primary bg-opacity-10 border-secondary">
                <i class="fas fa-info-circle me-2 text-primary"></i>
                <span class="text-white" data-i18n="ui.text_494">物流信息</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="table.logistics_no">物流单号</div>
                        <div class="text-white fw-bold font-monospace" id="receive-view-logistic-num">-</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="purchase.shipping_date">发货日期</div>
                        <div class="text-info" id="receive-view-receive-date">-</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="abnormal.expected_arrival">预计到货日期</div>
                        <div class="text-info" id="receive-view-eta-date">-</div>
                    </div>
                </div>
                <hr class="border-secondary my-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="js.pallets">托盘数</div>
                        <div class="text-white fw-bold" id="receive-view-pallets">-</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="table.receive_date">入库日期</div>
                        <div class="text-info" id="receive-view-date">-</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_465">入库状态</div>
                        <div id="receive-view-status">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 框体2: 入库货物明细 -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header bg-success bg-opacity-10 border-secondary">
                <i class="fas fa-boxes me-2 text-success"></i>
                <span class="text-white" data-i18n="ui.text_495">入库货物明细</span>
            </div>
            <div class="card-body">
                <!-- 版本信息 -->
                <div class="row g-3 mb-3">
                    <!-- 物流单明细版本 -->
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2145">物流单明细版本</div>
                        <div class="text-info fw-bold" id="receive-view-send-seq">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.operator">操作人</div>
                        <div class="text-white" id="receive-view-send-by">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2147">修订日期</div>
                        <div class="text-white" id="receive-view-send-date">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.remark">备注</div>
                        <div class="text-white-50" id="receive-view-send-note">-</div>
                    </div>
                </div>
                <hr class="border-secondary my-3">
                <div class="row g-3 mb-3">
                    <!-- 入库明细版本 -->
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2149">入库明细版本</div>
                        <div class="text-success fw-bold" id="receive-view-receive-seq">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.operator">操作人</div>
                        <div class="text-white" id="receive-view-receive-by">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="ui.text_2147">修订日期</div>
                        <div class="text-white" id="receive-view-receive-update-date">-</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-white-50 small mb-1" data-i18n="common.remark">备注</div>
                        <div class="text-white-50" id="receive-view-receive-note">-</div>
                    </div>
                </div>

                <!-- 货物列表 - 按订单号分组 -->
                <div id="receive-view-items-container">
                    <!-- JS动态填充，按订单号创建子框体 -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 当前查看的物流单号（本地变量）
    let receiveViewCurrentLogisticNum = null;

    // 获取入库状态 tag HTML
    function getReceiveStatusTagView(status) {
        if (!status) return '-';

        let cssClass = '';
        let icon = '';

        switch (status) {
            case (window.i18n?.t('js.goods_in_transit') || 'Goods in transit'):
                cssClass = 'status-in-transit';
                icon = '<i class="fas fa-truck me-1"></i>';
                break;
            case (window.i18n?.t('js.all_received') || 'All received'):
                cssClass = 'status-all-received';
                icon = '<i class="fas fa-check-circle me-1"></i>';
                break;
            case (window.i18n?.t('js.diff_resolved') || 'Diff: Resolved'):
                cssClass = 'status-diff-resolved';
                icon = '<i class="fas fa-check me-1"></i>';
                break;
            case (window.i18n?.t('js.diff_unresolved') || 'Diff: Unresolved'):
                cssClass = 'status-diff-pending';
                icon = '<i class="fas fa-exclamation-triangle me-1"></i>';
                break;
            default:
                return status;
        }

        return `<span class="receive-status-tag ${cssClass}">${icon}${status}</span>`;
    }

    // 获取货物状态 tag
    function getItemStatusTag(status, diff) {
        if (status === 'normal') {
            return '<span class="badge bg-success bg-opacity-25 text-success" data-i18n="ui.text_496">正常</span>';
        } else if (status === 'deficit') {
            return `<span class="badge bg-warning bg-opacity-25 text-warning"><i class="fas fa-arrow-down me-1"></i>少收 ${Math.abs(diff)}</span>`;
        } else if (status === 'excess') {
            return `<span class="badge bg-info bg-opacity-25 text-info"><i class="fas fa-arrow-up me-1"></i>超收 ${Math.abs(diff)}</span>`;
        }
        return '-';
    }

    // 加载入库单详情
    function loadReceiveDetail(logisticNum) {
        receiveViewCurrentLogisticNum = logisticNum;

        const loading = document.getElementById('receive-view-loading');
        const content = document.getElementById('receive-view-content');

        loading.style.display = 'block';
        content.style.display = 'none';

        document.getElementById('receive-view-logistic-num-label').textContent = `物流单号: ${logisticNum}`;

        fetch(`{% url 'web_ui:purchase:receive_mgmt_detail' %}?logistic_num=${encodeURIComponent(logisticNum)}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';

                if (!data.success) {
                    alert(data.message || '{% trans "加载失败" %}');
                    showListView();
                    return;
                }

                content.style.display = 'block';
                const { logistics, detail } = data.data;

                // 物流信息
                document.getElementById('receive-view-logistic-num').textContent = logistics.logistic_num || '-';
                document.getElementById('receive-view-receive-date').textContent = logistics.receive_date || '-';
                document.getElementById('receive-view-eta-date').textContent = logistics.eta_date_final || '-';
                document.getElementById('receive-view-pallets').textContent = logistics.pallets || '0';
                document.getElementById('receive-view-date').textContent = logistics.receive_date || '-';
                document.getElementById('receive-view-status').innerHTML = getReceiveStatusTagView(logistics.receive_status);

                // 物流单明细版本信息
                document.getElementById('receive-view-send-seq').textContent = detail.send_seq || '-';
                document.getElementById('receive-view-send-by').textContent = detail.send_by || '-';
                document.getElementById('receive-view-send-date').textContent = detail.send_update_date || '-';
                document.getElementById('receive-view-send-note').textContent = detail.send_note || '-';

                // 入库明细版本信息
                document.getElementById('receive-view-receive-seq').textContent = detail.receive_seq || '-';
                document.getElementById('receive-view-receive-by').textContent = detail.receive_by || '-';
                document.getElementById('receive-view-receive-update-date').textContent = detail.receive_update_date || '-';
                document.getElementById('receive-view-receive-note').textContent = detail.receive_note || '-';

                // 货物列表 - 按 SKU 分组
                const container = document.getElementById('receive-view-items-container');
                container.innerHTML = '';

                const items = detail.items || [];

                // 按 SKU 分组
                const groupedBySku = {};
                items.forEach(item => {
                    if (!groupedBySku[item.po_sku]) {
                        groupedBySku[item.po_sku] = [];
                    }
                    groupedBySku[item.po_sku].push(item);
                });

                // 为每个 SKU 创建可折叠子框体
                Object.keys(groupedBySku).forEach((sku, skuIdx) => {
                    const skuItems = groupedBySku[sku];

                    // 计算该 SKU 所有订单的总计
                    let totalSent = 0;
                    let totalReceive = 0;
                    skuItems.forEach(item => {
                        totalSent += item.sent_quantity;
                        totalReceive += item.receive_quantity;
                    });
                    const totalDiff = totalSent - totalReceive;
                    let totalStatus = 'normal';
                    if (totalDiff > 0) totalStatus = 'deficit';
                    else if (totalDiff < 0) totalStatus = 'excess';

                    const collapseId = `sku-collapse-${skuIdx}`;

                    // 根据状态设置边框
                    let borderStyle = '';
                    if (totalStatus === 'deficit') {
                        borderStyle = 'border-left: 3px solid #fbbf24;';
                    } else if (totalStatus === 'excess') {
                        borderStyle = 'border-left: 3px solid #38bdf8;';
                    }

                    const subCard = document.createElement('div');
                    subCard.className = 'card bg-dark border-secondary border-opacity-50 mb-2';
                    subCard.style.cssText = 'background: rgba(30, 35, 45, 0.6); ' + borderStyle;

                    subCard.innerHTML = `
                        <div class="card-header py-2 px-3" style="background: rgba(60, 65, 80, 0.5); cursor: pointer;"
                             data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <div class="d-flex align-items-center">
                                <div class="d-flex align-items-center" style="flex: 1; min-width: 0;">
                                    <i class="fas fa-chevron-right me-2 text-white-50 collapse-icon" style="transition: transform 0.2s; font-size: 10px; width: 12px;"></i>
                                    <i class="fas fa-box me-2 text-success"></i>
                                    <span class="text-white fw-bold font-monospace text-truncate" style="font-size: 13px;">${sku}</span>
                                </div>
                                <div class="d-flex align-items-center" style="flex-shrink: 0;">
                                    <span class="badge bg-secondary bg-opacity-50 text-white-50 small" style="width: 60px; text-align: center;" data-i18n="ui.text_497">${skuItems.length} 订单</span>
                                    <span class="text-white-50 small ms-3" style="width: 80px;">${(window.i18n?.t('ui.text_2154') || 'Sent')}: <span class="fw-bold" style="color: #7dd3fc;">${totalSent}</span></span>
                                    <span class="text-white-50 small ms-2" style="width: 80px;">${(window.i18n?.t('ui.text_2005') || 'Received')}: <span class="fw-bold" style="color: #86efac;">${totalReceive}</span></span>
                                    <span class="ms-2" style="width: 100px; text-align: right;">${getItemStatusTag(totalStatus, totalDiff)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="collapse" id="${collapseId}">
                            <div class="card-body p-0" style="border-top: 1px solid rgba(255,255,255,0.1);">
                                <div class="table-responsive">
                                    <table class="table table-dark table-hover mb-0" style="font-size: 12px;">
                                        <thead>
                                            <tr class="text-white-50">
                                                <th style="width: 35px; padding: 8px 12px;">#</th>
                                                <th style="padding: 8px 12px;" data-i18n="purchase.order_num">订单号</th>
                                                <th class="text-center" style="width: 80px; padding: 8px;" data-i18n="ui.text_2154">发货</th>
                                                <th class="text-center" style="width: 80px; padding: 8px;" data-i18n="ui.text_2005">入库</th>
                                                <th class="text-center" style="width: 100px; padding: 8px;" data-i18n="common.status">状态</th>
                                            </tr>
                                        </thead>
                                        <tbody id="receive-view-sku-${skuIdx}">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;

                    container.appendChild(subCard);

                    // 绑定折叠图标旋转
                    const collapseEl = document.getElementById(collapseId);
                    const iconEl = subCard.querySelector('.collapse-icon');
                    collapseEl.addEventListener('show.bs.collapse', () => {
                        iconEl.style.transform = 'rotate(90deg)';
                    });
                    collapseEl.addEventListener('hide.bs.collapse', () => {
                        iconEl.style.transform = 'rotate(0deg)';
                    });

                    // 填充该 SKU 的各订单数据
                    const tbody = document.getElementById(`receive-view-sku-${skuIdx}`);
                    skuItems.forEach((item, idx) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="text-white-50" style="padding: 6px 12px;">${idx + 1}</td>
                            <td class="font-monospace" style="padding: 6px 12px;">${item.po_num}</td>
                            <td class="text-center" style="padding: 6px 8px;">${item.sent_quantity}</td>
                            <td class="text-center" style="padding: 6px 8px;">${item.receive_quantity}</td>
                            <td class="text-center" style="padding: 6px 8px;">${getItemStatusTag(item.status, item.diff)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                });

                // 如果没有货物
                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-white-50 py-4">
                            <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                            <p class="mb-0" data-i18n="ui.text_498">暂无货物记录</p>
                        </div>
                    `;
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                alert('{% trans "加载失败: " %}' + err);
                showListView();
            });
    }

    // 按钮处理函数
    function handleReceiveEdit() {
        if (receiveViewCurrentLogisticNum && typeof editReceive === 'function') {
            editReceive(receiveViewCurrentLogisticNum);
        }
    }

    function handleReceiveHistory() {
        if (receiveViewCurrentLogisticNum && typeof viewHistory === 'function') {
            viewHistory(receiveViewCurrentLogisticNum);
        }
    }

    function handleReceiveDelete() {
        if (receiveViewCurrentLogisticNum && typeof deleteReceive === 'function') {
            deleteReceive(receiveViewCurrentLogisticNum, false);
        }
    }
</script>