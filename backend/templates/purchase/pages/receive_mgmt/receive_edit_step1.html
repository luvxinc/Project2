<!-- 入库单修改向导 - Step1: 修改入库数据 -->
<div id="receive-edit-step-1" class="wizard-step-content" style="display: none;">
    <!-- 操作须知 -->
    <div class="card bg-dark border-info border-opacity-25 mb-4">
        <div class="card-header bg-info bg-opacity-10 border-0 py-2">
            <i class="fas fa-info-circle me-2 text-info"></i>
            <span class="text-info fw-bold small" data-i18n="common.operation_notes">操作须知</span>
        </div>
        <div class="card-body py-2">
            <div class="row">
                <div class="col-md-6">
                    <ul class="text-white-50 small mb-0">
                        <li class="mb-1">
                            <strong class="text-info" data-i18n="ui.text_810">修改范围</strong>：<span data-i18n="instructions.desc_70">仅可修改当前入库单的入库数量</span>
                        </li>
                        <li class="mb-1">
                            <strong class="text-info" data-i18n="ui.text_811">全部规整</strong>：<span data-i18n="instructions.desc_90">将所有入库数量设为发货数量</span>
                        </li>
                        <li>
                            <strong class="text-info" data-i18n="ui.text_812">原入库列</strong>：<span data-i18n="instructions.desc_69">显示修改前的入库数量供参照</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="text-white-50 small mb-0">
                        <li class="mb-1">
                            <strong class="text-warning" data-i18n="ui.text_813">版本记录</strong>：<span data-i18n="instructions.desc_81">每次修改将创建新版本，原记录保留</span>
                        </li>
                        <li class="mb-1">
                            <strong class="text-warning" data-i18n="ui.text_814">必须修改</strong>：<span data-i18n="instructions.desc_78">需至少修改一项才可进入下一步</span>
                        </li>
                        <li>
                            <strong class="text-danger" data-i18n="ui.text_815">密码验证</strong>：<span data-i18n="instructions.desc_64">确认入库时需要输入安全密码</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 当前版本信息 -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header bg-secondary bg-opacity-10 border-secondary py-2">
            <i class="fas fa-history me-2 text-secondary"></i>
            <span class="text-white small" data-i18n="ui.text_816">当前版本信息</span>
        </div>
        <div class="card-body py-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="text-white-50 small" data-i18n="ui.text_2149">入库明细版本</div>
                    <div class="text-success fw-bold" id="receive-edit-current-seq">-</div>
                </div>
                <div class="col-md-4">
                    <div class="text-white-50 small" data-i18n="common.operator">操作人</div>
                    <div class="text-white" id="receive-edit-current-by">-</div>
                </div>
                <div class="col-md-4">
                    <div class="text-white-50 small" data-i18n="ui.text_2304">更新日期</div>
                    <div class="text-white" id="receive-edit-current-date">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 货物列表 -->
    <div class="card bg-dark border-warning border-opacity-25 mb-4">
        <div class="card-header bg-warning bg-opacity-10 border-0 d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-boxes me-2 text-warning"></i>
                <span class="text-warning fw-bold" data-i18n="ui.text_817">货物列表</span>
            </div>
            <div>
                <button type="button" class="btn btn-outline-info btn-sm" id="receive-edit-btn-fill-all" onclick="receiveEditFillAll()" disabled>
                    <i class="fas fa-check-double me-1"></i><span data-i18n="ui.text_811">全部规整</span>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0" style="font-size: 13px;">
                    <thead>
                        <tr class="text-white-50">
                            <th style="padding: 10px 12px;" data-i18n="purchase.order_num">订单号</th>
                            <th style="padding: 10px 12px;">SKU</th>
                            <th class="text-center" style="width: 90px; padding: 10px;" data-i18n="table.shipped_qty">发货数量</th>
                            <th class="text-center" style="width: 90px; padding: 10px;" data-i18n="ui.text_2290">原入库</th>
                            <th class="text-center" style="width: 130px; padding: 10px;" data-i18n="ui.text_2308">新入库数量</th>
                        </tr>
                    </thead>
                    <tbody id="receive-edit-items-tbody">
                        <!-- JS动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="d-flex justify-content-between">
        <button class="btn btn-outline-secondary" onclick="showListView()">
            <i class="fas fa-times me-1"></i><span data-i18n="common.cancel">取消</span>
        </button>
        <button class="btn btn-warning" id="receive-edit-btn-next" onclick="receiveEditGoToStep2()" disabled>
            下一步 <i class="fas fa-arrow-right ms-1"></i>
        </button>
    </div>
</div>

<script>
    // Step1: 加载数据
    function loadReceiveEditStep1Data(data) {
        const detail = data.detail;
        
        // 显示版本信息
        document.getElementById('receive-edit-current-seq').textContent = detail.receive_seq || '-';
        document.getElementById('receive-edit-current-by').textContent = detail.receive_by || '-';
        document.getElementById('receive-edit-current-date').textContent = detail.receive_update_date || '-';
        
        // 构建货物列表
        const tbody = document.getElementById('receive-edit-items-tbody');
        tbody.innerHTML = '';
        
        const items = detail.items || [];
        receiveEditModifiedItems = [];
        
        items.forEach((item, idx) => {
            const inputId = `receive-edit-qty-${idx}`;
            
            // 保存初始数据用于后续对比
            receiveEditModifiedItems.push({
                po_num: item.po_num,
                po_sku: item.po_sku,
                sent_quantity: item.sent_quantity,
                original_receive_quantity: item.receive_quantity,
                receive_quantity: item.receive_quantity
            });
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="font-monospace" style="padding: 8px 12px;">${item.po_num}</td>
                <td class="font-monospace" style="padding: 8px 12px;">${item.po_sku}</td>
                <td class="text-center" style="padding: 8px;">
                    <span style="color: #7dd3fc;">${item.sent_quantity}</span>
                </td>
                <td class="text-center text-white-50" style="padding: 8px;">
                    ${item.receive_quantity}
                </td>
                <td class="text-center" style="padding: 8px;">
                    <input type="number" 
                           id="${inputId}"
                           class="form-control form-control-sm bg-dark text-white border-secondary text-center"
                           style="width: 90px; margin: 0 auto;"
                           value="${item.receive_quantity}"
                           min="0"
                           onchange="onReceiveEditQtyChange(${idx}, this.value)">
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // 如果没有数据
        if (items.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-white-50 py-4">
                        <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0" data-i18n="ui.text_498">暂无货物记录</p>
                    </td>
                </tr>
            `;
            // 禁用按钮
            document.getElementById('receive-edit-btn-fill-all').disabled = true;
            document.getElementById('receive-edit-btn-next').disabled = true;
        } else {
            // 启用全选按钮
            document.getElementById('receive-edit-btn-fill-all').disabled = false;
            // 确认和下一步按钮初始禁用，等有修改才启用
            updateReceiveEditNextBtnState();
        }
    }
    
    // 检查是否有修改，更新按钮状态
    function updateReceiveEditNextBtnState() {
        let hasChange = false;
        receiveEditModifiedItems.forEach(item => {
            if (item.receive_quantity !== item.original_receive_quantity) {
                hasChange = true;
            }
        });
        
        document.getElementById('receive-edit-btn-next').disabled = !hasChange;
    }
    
    // 数量变化回调
    function onReceiveEditQtyChange(itemIndex, value) {
        const qty = parseInt(value) || 0;
        receiveEditModifiedItems[itemIndex].receive_quantity = qty;
        updateReceiveEditNextBtnState();
    }
    
    // 全选：将所有入库数量设为发货数量
    function receiveEditFillAll() {
        receiveEditModifiedItems.forEach((item, idx) => {
            item.receive_quantity = item.sent_quantity;
            const input = document.getElementById(`receive-edit-qty-${idx}`);
            if (input) {
                input.value = item.sent_quantity;
            }
        });
        updateReceiveEditNextBtnState();
    }
    
    // 进入Step2
    function receiveEditGoToStep2() {
        // 检查是否有修改
        let hasChange = false;
        receiveEditModifiedItems.forEach(item => {
            if (item.receive_quantity !== item.original_receive_quantity) {
                hasChange = true;
            }
        });
        
        if (!hasChange) {
            GlobalModal.showWarning({
                title: (window.i18n?.t('js.no_changes_detected') || 'No changes detected'),
                message: (window.i18n?.t('js.no_receive_change') || 'No receiving change, modify first.')
            });
            return;
        }
        
        showReceiveEditStep(2);
    }
</script>