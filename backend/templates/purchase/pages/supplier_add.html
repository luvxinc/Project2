{% extends "layouts/base.html" %}
{% load static %}
{% load security_tags %}

{% block title %}Add Supplier - Procurement - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:purchase:hub' %}"
                            class="text-info text-decoration-none" data-i18n="purchase.title">Procurement</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="purchase.supplier_create">Add Supplier</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'web_ui:purchase:hub' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="purchase.back_to_hub">返回Procurement</span>
            </a>
        </div>
    </div>

    <!-- 向导容器 -->
    <div id="supplier-add-wizard-container" class="glass-card p-4 shadow-lg">
        <!-- Header (GlobalWizard 锚点：步骤条将插入到此节点之后) -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-id-card fa-2x text-primary"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_499">Add Supplier向导</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_500">请按步骤填写新供应商资料，确认后提交。</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar 锚点：GlobalWizard 会将步骤条注入到此 div 内 -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

        <!-- Step 1: 填写信息 -->
        <div id="supplier-step-input" class="wizard-step-content">
            <!-- 操作须知 -->
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-start">
                    <i class="fas fa-info-circle me-3 mt-1 text-info"></i>
                    <div>
                        <strong class="text-info" data-i18n="common.operation_notes">操作须知</strong>
                        <ul class="mb-0 mt-2 ps-3">
                            <li data-i18n="common.operation_notes">供应商代号为<strong data-i18n="ui.text_502">两位大写字母</strong>，创建后不可修改</li>
                            <li data-i18n="ui.text_521">请根据业务需要选择正确的<strong data-i18n="purchase.category">类别</strong>和<strong data-i18n="purchase.type">种类</strong></li>
                            <li data-i18n="ui.text_522">货币、价格浮动、定金要求等策略可在创建后通过<strong>Supplier Management</strong>修改</li>
                            <li data-i18n="ui.text_505">所有字段确认无误后，进入下一步进行数据校验</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <form id="form-add-supplier" autocomplete="off" onkeydown="return event.key != 'Enter';">
                {% csrf_token %}
                <div id="policy-check-add-supplier" class="d-none">
                    {% security_inputs 'btn_add_supplier' %}
                </div>

                <!-- 1. Basic Info -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t3204" title="请输入供货商名字代号(两个字母)">
                            供应商代号 <i class="fas fa-info-circle ms-1"></i>
                        </label>
                        <input type="text" class="form-control bg-dark border-secondary text-white" name="supplier_code"
                            id="id_supplier_code" maxlength="2" data-i18n-placeholder="form.placeholder.generic_6" placeholder="例如: AA"
                            oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '')" required>
                        <div class="form-text text-white-50 small" data-i18n="ui.text_2157">只接受两个英文字母</div>
                    </div>
                    <div class="col-md-9">
                        <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t2359" title="请输入厂商中文名">
                            供应商名称 <i class="fas fa-info-circle ms-1"></i>
                        </label>
                        <input type="text" class="form-control bg-dark border-secondary text-white" name="supplier_name"
                            id="id_supplier_name" data-i18n-placeholder="form.placeholder.generic_5" placeholder="请输入供货商名字" required>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <!-- 供应商类别 -->
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t8203" title="请根据业务种类为供应商选择类别">
                            供应商类别 <span class="text-danger">*</span> <i class="fas fa-info-circle ms-1"></i>
                        </label>
                        <div class="btn-group w-100 mt-2" role="group">
                            <input type="radio" class="btn-check" name="category" id="cat_e" value="E" required>
                            <label class="btn btn-outline-secondary" for="cat_e" data-i18n="ui.text_436">汽配 (E)</label>
                            <input type="radio" class="btn-check" name="category" id="cat_a" value="A">
                            <label class="btn btn-outline-secondary" for="cat_a" data-i18n="ui.text_437">亚马逊 (A)</label>
                        </div>
                    </div>
                    
                    <!-- 供应商种类 -->
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small" data-bs-toggle="tooltip" 
                            data-i18n-title="tooltip.t2503" title="A类: 电商货物供应商&#10;B类: 货物依赖品供应商&#10;C类: 耗材和其他供应商">
                            供应商种类 <span class="text-danger">*</span> <i class="fas fa-info-circle ms-1"></i>
                        </label>
                        <div class="btn-group w-100 mt-2" role="group">
                            <input type="radio" class="btn-check" name="type" id="type_a" value="A" required>
                            <label class="btn btn-outline-secondary" for="type_a" data-bs-toggle="tooltip" data-i18n-title="tooltip.t1667" title="电商货物供应商">A类</label>
                            <input type="radio" class="btn-check" name="type" id="type_b" value="B">
                            <label class="btn btn-outline-secondary" for="type_b" data-bs-toggle="tooltip" data-i18n-title="tooltip.t5705" title="货物依赖品供应商">B类</label>
                            <input type="radio" class="btn-check" name="type" id="type_c" value="C">
                            <label class="btn btn-outline-secondary" for="type_c" data-bs-toggle="tooltip" data-i18n-title="tooltip.t9251" title="耗材和其他供应商">C类</label>
                        </div>
                    </div>
                </div>

                <!-- 2. Currency -->
                <div class="mb-4">
                    <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t1845" title="请根据供应商选择结算货币种类">
                        使用货币 <i class="fas fa-info-circle ms-1"></i>
                    </label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="currency" id="curr_rmb" value="RMB" required>
                        <label class="btn btn-outline-secondary" for="curr_rmb">RMB</label>
                        <input type="radio" class="btn-check" name="currency" id="curr_usd" value="USD">
                        <label class="btn btn-outline-secondary" for="curr_usd">USD</label>
                    </div>
                </div>

                <hr class="border-secondary border-opacity-25 my-4">

                <div class="row g-4 mb-4 align-items-center">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center gap-3">
                            <label class="ui-toggle ui-toggle-primary" for="id_float_currency">
                                <input type="checkbox" id="id_float_currency" name="float_currency">
                                <span class="ui-toggle-track"></span>
                            </label>
                            <label class="form-check-label text-white" for="id_float_currency" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t9327" title="请根据供应商合同选择该供应商订单价格是否随汇率浮动阈值控制">
                                价格浮动 <i class="fas fa-info-circle ms-1"></i>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label text-white-50 small" data-i18n="ui.text_508">价格浮动阈值 (%)</label>
                        <div class="d-flex align-items-center gap-3">
                            <input type="range" class="form-range flex-grow-1" min="0" max="10" step="0.1"
                                id="id_float_threshold_range" disabled>
                            <input type="number" class="form-control bg-dark border-secondary text-white text-center"
                                style="width: 80px;" id="id_float_threshold" name="float_threshold" min="0" max="10"
                                step="0.1" disabled>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4 align-items-center">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center gap-3">
                            <label class="ui-toggle ui-toggle-primary" for="id_depository">
                                <input type="checkbox" id="id_depository" name="depository">
                                <span class="ui-toggle-track"></span>
                            </label>
                            <label class="form-check-label text-white" for="id_depository" data-bs-toggle="tooltip"
                                data-i18n-title="tooltip.t495" title="请根据供应商合同选择该供应商订单是否需要定金">
                                要求定金 <i class="fas fa-info-circle ms-1"></i>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label text-white-50 small" data-i18n="ui.text_509">定金百分比 (%)</label>
                        <div class="d-flex align-items-center gap-3">
                            <input type="range" class="form-range flex-grow-1" min="0" max="100" step="1"
                                id="id_deposit_par_range" disabled>
                            <input type="number" class="form-control bg-dark border-secondary text-white text-center"
                                style="width: 80px;" id="id_deposit_par" name="deposit_par" min="0" max="100" step="1"
                                disabled>
                        </div>
                    </div>
                </div>
            </form>

            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-primary btn-lg px-5 shadow rounded-pill"
                        id="btn-wizard-next-1">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="ui.icon_3018">下一步：验证数据</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: 验证数据（校验门禁） -->
        <div id="supplier-step-confirm" class="wizard-step-content">
            <!-- 验证结果卡片 -->
            <div class="card mb-4" id="validation-card">
                <div class="card-header border-0" id="validation-card-header">
                    <i class="fa-solid fa-shield-halved me-2" id="validation-icon"></i>
                    <span id="validation-title" data-i18n="ui.text_510">请验证以下供应商信息</span>
                </div>
                <div class="card-body" id="validation-card-body">
                    <!-- 数据摘要展示区 -->
                    <div id="supplier-summary-content" class="row g-3 text-white">
                        <!-- 动态填充 -->
                    </div>
                </div>
            </div>

            <!-- 错误列表（校验失败时显示） -->
            <div id="validation-errors-container" class="mb-4" style="display: none;">
                <div class="card bg-danger bg-opacity-10 border-danger">
                    <div class="card-header bg-danger bg-opacity-20 border-0">
                        <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                        <span class="text-danger fw-bold" data-i18n="ui.text_56">校验未通过</span>
                    </div>
                    <div class="card-body">
                        <ul id="validation-errors-list" class="mb-0 text-white">
                            <!-- 动态填充错误列表 -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Step 2 Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4 rounded-pill"
                        id="btn-wizard-back-2">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-danger btn-lg px-5 shadow rounded-pill" id="btn-wizard-confirm"
                        disabled>
                        <i class="fas fa-check-circle me-2"></i><span data-i18n="wizard.confirm_submit">确认提交</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: 完成状态页 -->
        <div id="supplier-step-finish" class="wizard-step-content">
            <div class="card bg-dark border-opacity-50" id="finish-status-card">
                <div class="card-body py-5">
                    <div class="text-center mb-4" id="finish-status-header"></div>
                    <div id="finish-info-panel" class="mb-4"></div>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'web_ui:purchase:hub' %}"
                            class="btn btn-outline-secondary btn-lg px-4 rounded-pill">
                            <i class="fas fa-home me-2"></i><span data-i18n="ui.icon_3183">返回Procurement</span>
                        </a>
                        <button type="button" class="btn btn-primary btn-lg px-5 shadow rounded-pill"
                            id="btn-wizard-restart">
                            <i class="fas fa-rotate me-2"></i><span data-i18n="ui.icon_3184">继续Add Supplier</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Step2 验证卡片状态样式 */
    #validation-card {
        transition: all 0.3s ease;
    }

    /* 正常态 */
    #validation-card.state-normal {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(13, 202, 240, 0.25);
    }

    #validation-card.state-normal #validation-card-header {
        background: rgba(13, 202, 240, 0.1);
    }

    #validation-card.state-normal #validation-icon,
    #validation-card.state-normal #validation-title {
        color: var(--bs-info);
    }

    /* 校验中 */
    #validation-card.state-loading {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 193, 7, 0.5);
    }

    #validation-card.state-loading #validation-card-header {
        background: rgba(255, 193, 7, 0.1);
    }

    #validation-card.state-loading #validation-icon,
    #validation-card.state-loading #validation-title {
        color: var(--bs-warning);
    }

    /* 错误态 */
    #validation-card.state-error {
        background: rgba(220, 53, 69, 0.1);
        border: 2px solid var(--bs-danger);
        animation: errorPulse 1.5s ease-in-out infinite;
    }

    #validation-card.state-error #validation-card-header {
        background: rgba(220, 53, 69, 0.2);
    }

    #validation-card.state-error #validation-icon,
    #validation-card.state-error #validation-title {
        color: var(--bs-danger);
    }

    /* 通过态 */
    #validation-card.state-success {
        background: rgba(25, 135, 84, 0.1);
        border: 2px solid var(--bs-success);
    }

    #validation-card.state-success #validation-card-header {
        background: rgba(25, 135, 84, 0.2);
    }

    #validation-card.state-success #validation-icon,
    #validation-card.state-success #validation-title {
        color: var(--bs-success);
    }

    @keyframes errorPulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }

        50% {
            box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3);
        }
    }

    /* 按钮禁用态 */
    #btn-wizard-confirm:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        cursor: not-allowed;
        opacity: 0.65;
    }

    #btn-wizard-confirm:disabled:hover {
        transform: none;
        box-shadow: none;
    }
</style>

<script>
    let supplierWizard = null;
    let lastSubmittedSupplier = null;
    let step2ValidationPassed = false;

    document.addEventListener('DOMContentLoaded', function () {
        initSupplierWizard();
        setupToggleFields();
    });

    function setupToggleFields() {
        setupToggle('id_float_currency', ['id_float_threshold_range', 'id_float_threshold']);
        setupToggle('id_depository', ['id_deposit_par_range', 'id_deposit_par']);
        setupSync('id_float_threshold_range', 'id_float_threshold');
        setupSync('id_deposit_par_range', 'id_deposit_par');
    }

    function setupToggle(switchId, targetIds) {
        const sw = document.getElementById(switchId);
        if (!sw) return;
        sw.addEventListener('change', () => {
            const on = sw.checked;
            targetIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.disabled = !on; if (!on) el.value = 0; }
            });
        });
    }

    function setupSync(rangeId, inputId) {
        const range = document.getElementById(rangeId);
        const input = document.getElementById(inputId);
        if (range && input) {
            range.addEventListener('input', () => input.value = range.value);
            input.addEventListener('input', () => range.value = input.value);
        }
    }

    function initSupplierWizard() {
        if (supplierWizard) return;

        supplierWizard = new GlobalWizard({
            containerId: 'supplier-add-wizard-container',
            steps: [
                { id: 'input', label: (window.i18n?.t('js.fill_info') || 'Fill Information'), contentSelector: '#supplier-step-input' },
                { id: 'confirm', label: (window.i18n?.t('js.validate_data') || 'Validate'), contentSelector: '#supplier-step-confirm' },
                { id: 'finish', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#supplier-step-finish' }
            ],

            onStepChange: async (fromStep, toStep) => {
                if (supplierWizard.steps[toStep].id === 'confirm') {
                    populateStep2Summary();
                    await runStep2Validation();
                }
            },

            onBeforeNext: async (currentStep) => {
                if (currentStep.id === 'input') {
                    return validateStep1Form();
                }
                if (currentStep.id === 'confirm') {
                    if (!step2ValidationPassed) {
                        return false;
                    }
                    return await submitSupplierWithAuth();
                }
                return true;
            },

            onComplete: () => {},
            onRestart: () => resetSupplierForm()
        });

        bindWizardButtons();
    }

    function bindWizardButtons() {
        document.getElementById('btn-wizard-next-1')?.addEventListener('click', () => supplierWizard.next());
        document.getElementById('btn-wizard-back-2')?.addEventListener('click', () => supplierWizard.back());
        document.getElementById('btn-wizard-confirm')?.addEventListener('click', () => {
            if (step2ValidationPassed) supplierWizard.next();
        });
        document.getElementById('btn-wizard-restart')?.addEventListener('click', () => supplierWizard.restart());
    }

    // ========================================
    // Step 1: 表单验证
    // ========================================
    function validateStep1Form() {
        const form = document.getElementById('form-add-supplier');
        const hiddenPwdInputs = form.querySelectorAll('#policy-check-add-supplier input[required]');
        hiddenPwdInputs.forEach(input => { input.dataset.wasRequired = 'true'; input.removeAttribute('required'); });

        const isValid = form.checkValidity();
        if (!isValid) {
            form.reportValidity();
            hiddenPwdInputs.forEach(input => { if (input.dataset.wasRequired) { input.setAttribute('required', ''); delete input.dataset.wasRequired; } });
            return false;
        }

        hiddenPwdInputs.forEach(input => { if (input.dataset.wasRequired) { input.setAttribute('required', ''); delete input.dataset.wasRequired; } });
        return true;
    }

    // ========================================
    // Step 2: 数据摘要填充 + 校验门禁
    // ========================================
    function populateStep2Summary() {
        const code = document.getElementById('id_supplier_code').value || '-';
        const name = document.getElementById('id_supplier_name').value || '-';
        const category = document.querySelector('input[name="category"]:checked')?.value || '-';
        const categoryLabel = category === 'E' ? (window.i18n?.t('js.auto_parts_e') || 'Auto Parts (E)') : category === 'A' ? (window.i18n?.t('js.amazon_a') || 'Amazon (A)') : '-';
        const supplierType = document.querySelector('input[name="type"]:checked')?.value || '-';
        const typeLabels = { 'A': (window.i18n?.t('js.type_a') || 'Type A (E-commerce)'), 'B': (window.i18n?.t('js.type_b') || 'Type B (Accessories)'), 'C': (window.i18n?.t('js.type_c') || 'Type C (Supplies)') };
        const typeLabel = typeLabels[supplierType] || '-';
        const currency = document.querySelector('input[name="currency"]:checked')?.value || '-';
        const floatOn = document.getElementById('id_float_currency').checked;
        const floatVal = document.getElementById('id_float_threshold').value || '0';
        const depoOn = document.getElementById('id_depository').checked;
        const depoVal = document.getElementById('id_deposit_par').value || '0';

        const html = `
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t3204" title="Enter supplier code (2 letters)">供应商代号 <i class="fas fa-info-circle"></i></div>
                    <div class="text-primary fs-5 fw-bold">${code}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t2359" title="Enter supplier name">供应商名称 <i class="fas fa-info-circle"></i></div>
                    <div class="text-white fw-bold">${name}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t8203" title="Select supplier category">类别 <i class="fas fa-info-circle"></i></div>
                    <div class="text-white">${categoryLabel}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t5457" title="Supplier Type A/B/C">种类 <i class="fas fa-info-circle"></i></div>
                    <div class="text-white">${typeLabel}</div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t1845" title="Select currency">货币 <i class="fas fa-info-circle"></i></div>
                    <div class="text-info fw-bold">${currency}</div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t9327" title="Select if supplier order price floats with exchange rate">价格浮动 <i class="fas fa-info-circle"></i></div>
                    <div class="text-white">${floatOn ? '<i class="fas fa-check text-success me-1"></i>启用 (阈值: ' + floatVal + '%)' : '<i class="fas fa-times text-secondary me-1"></i>未启用'}</div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="p-3 rounded bg-dark border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-bs-toggle="tooltip" data-i18n-title="tooltip.t495" title="Select if supplier order requires deposit">定金要求 <i class="fas fa-info-circle"></i></div>
                    <div class="text-white">${depoOn ? '<i class="fas fa-check text-success me-1"></i>启用 (比例: ' + depoVal + '%)' : '<i class="fas fa-times text-secondary me-1"></i>未启用'}</div>
                </div>
            </div>
        `;
        document.getElementById('supplier-summary-content').innerHTML = html;
        lastSubmittedSupplier = { code, name, category: categoryLabel, type: typeLabel, currency, floatOn, floatVal, depoOn, depoVal };
    }

    async function runStep2Validation() {
        const errors = [];
        const card = document.getElementById('validation-card');
        const icon = document.getElementById('validation-icon');
        const title = document.getElementById('validation-title');
        const confirmBtn = document.getElementById('btn-wizard-confirm');
        const errorsContainer = document.getElementById('validation-errors-container');
        const errorsList = document.getElementById('validation-errors-list');

        // 设置加载态
        card.className = 'card mb-4 state-loading';
        icon.className = 'fa-solid fa-spinner fa-spin me-2';
        title.textContent = (window.i18n?.t('js.validating_data') || 'Validating data...');
        confirmBtn.disabled = true;
        errorsContainer.style.display = 'none';
        step2ValidationPassed = false;

        // 1. 供应商代号格式校验
        const code = document.getElementById('id_supplier_code').value.trim().toUpperCase();
        const codeRegex = /^[A-Z]{2}$/;
        if (!codeRegex.test(code)) {
            errors.push({
                field: (window.i18n?.t('js.supplier_code') || 'Supplier Code'),
                message: (window.i18n?.t('js.supplier_code_format') || 'Supplier code must be 2 letters (e.g. AB)'),
                current: code || (window.i18n?.t('js.empty') || '(empty)')
            });
        } else {
            // 2. 供应商代号唯一性校验（调用后端API）
            try {
                const res = await fetch(`{% url 'web_ui:purchase:supplier_code_check' %}?code=${encodeURIComponent(code)}`);
                const data = await res.json();
                if (data.exists) {
                    errors.push({
                        field: (window.i18n?.t('js.supplier_code') || 'Supplier Code'),
                        message: (window.i18n?.t('js.supplier_code_exists') || 'Supplier code exists, please change'),
                        current: code
                    });
                }
            } catch (err) {
                console.error('[Validation] API error:', err);
                errors.push({
                    field: (window.i18n?.t('js.supplier_code') || 'Supplier Code'),
                    message: (window.i18n?.t('js.cannot_verify_supplier') || 'Cannot verify supplier code, retry later'),
                    current: code
                });
            }
        }

        // 3. 价格浮动校验
        const floatOn = document.getElementById('id_float_currency').checked;
        const floatVal = parseFloat(document.getElementById('id_float_threshold').value) || 0;
        if (floatOn && floatVal === 0) {
            errors.push({
                field: (window.i18n?.t('purchase.price_float') || 'Price Float'),
                message: (window.i18n?.t('js.price_float_threshold_error') || 'Threshold cannot be 0% when price float is enabled'),
                current: `启用，阈值=${floatVal}%`
            });
        }

        // 4. 定金要求校验
        const depoOn = document.getElementById('id_depository').checked;
        const depoVal = parseFloat(document.getElementById('id_deposit_par').value) || 0;
        if (depoOn && depoVal === 0) {
            errors.push({
                field: (window.i18n?.t('purchase.deposit_req') || 'Deposit Required'),
                message: (window.i18n?.t('js.deposit_ratio_error') || 'Ratio cannot be 0% when deposit is required'),
                current: `启用，比例=${depoVal}%`
            });
        }

        // 渲染结果
        if (errors.length > 0) {
            // 错误态
            card.className = 'card mb-4 state-error';
            icon.className = 'fa-solid fa-circle-xmark me-2';
            title.textContent = (window.i18n?.t('js.data_validation_failed') || 'Data validation failed');
            confirmBtn.disabled = true;
            step2ValidationPassed = false;

            // 显示错误列表
            errorsList.innerHTML = errors.map(e => `
                <li class="mb-2">
                    <strong class="text-danger">${e.field}：</strong>
                    <span>${e.message}</span>
                    <span class="text-white-50 small ms-2" data-i18n="ui.text_450">(当前值: ${e.current})</span>
                </li>
            `).join('');
            errorsContainer.style.display = 'block';
        } else {
            // 通过态
            card.className = 'card mb-4 state-success';
            icon.className = 'fa-solid fa-circle-check me-2';
            title.textContent = (window.i18n?.t('js.data_validation_passed') || 'Data Validation Passed');
            confirmBtn.disabled = false;
            step2ValidationPassed = true;
            errorsContainer.style.display = 'none';
        }
    }

    // ========================================
    // Step 2 -> 提交（需密码验证）
    // ========================================
    function submitSupplierWithAuth() {
        // [FIX] 这个函数返回false以阻止wizard自动前进
        // 密码验证成功后，由doAddSupplierAsync手动调用goToStep前进
        return new Promise((resolve) => {
            requestPasswordVerify(
                'btn_add_supplier',
                async (passwords) => {
                    // 密码验证通过，执行提交
                    await doAddSupplierAsync(passwords);
                    // 提交完成后，手动前进到Step3
                    supplierWizard.goToStep('finish');
                    resolve(false);  // 返回false防止wizard的next()再次前进
                },
                document.getElementById('form-add-supplier'),
                'Add Supplier',
                () => {
                    // 用户取消密码验证，保持在Step2
                    resolve(false);  // 返回false阻止wizard前进
                }
            );
        });
    }

    async function doAddSupplierAsync(passwords) {
        const form = document.getElementById('form-add-supplier');
        const formData = new FormData(form);

        // 添加密码到请求
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                formData.append(`sec_code_${slot}`, code);
            }
        }

        try {
            const res = await fetch("{% url 'web_ui:purchase:supplier_add' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCsrfToken() }
            });
            const data = await res.json();

            if (data.success) {
                renderFinishPage(true, null);
            } else {
                renderFinishPage(false, data.message || (window.i18n?.t('js.check_input_retry') || 'Please check input and retry'));
            }
        } catch (err) {
            console.error('[SupplierWizard] Submit error:', err);
            renderFinishPage(false, (window.i18n?.t('js.network_check_retry') || 'Network error, please check and retry'));
        }
    }

    function renderFinishPage(isSuccess, errorMessage) {
        const statusHeader = document.getElementById('finish-status-header');
        const infoPanel = document.getElementById('finish-info-panel');
        const statusCard = document.getElementById('finish-status-card');

        if (isSuccess) {
            statusCard.classList.remove('border-danger');
            statusCard.classList.add('border-success');
            const s = lastSubmittedSupplier || {};
            statusHeader.innerHTML = `
                <div class="display-1 text-success mb-4"><i class="fa-solid fa-circle-check"></i></div>
                <h3 class="text-white mb-3" data-i18n="modal.success.title">操作成功</h3>
                <p class="text-muted mb-0" data-i18n="ui.text_514">新供应商已成功添加到系统中</p>
            `;
            infoPanel.innerHTML = `
                <div class="card bg-black bg-opacity-50 border-success border-opacity-25">
                    <div class="card-header bg-success bg-opacity-10 border-0">
                        <i class="fa-solid fa-clipboard-check me-2 text-success"></i>
                        <span class="text-success" data-i18n="ui.text_515">本次Add Supplier数据明细</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 text-white">
                            <div class="col-6 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="ui.text_2126">供应商代号</div><div class="text-primary fs-5 fw-bold">${s.code || '-'}</div></div></div>
                            <div class="col-6 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="ui.text_2127">供应商名称</div><div class="text-white fw-bold">${s.name || '-'}</div></div></div>
                            <div class="col-6 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="purchase.category">类别</div><div class="text-white">${s.category || '-'}</div></div></div>
                            <div class="col-6 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="purchase.type">种类</div><div class="text-white">${s.type || '-'}</div></div></div>
                            <div class="col-6 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="common.currency">货币</div><div class="text-info fw-bold">${s.currency || '-'}</div></div></div>
                            <div class="col-6 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="purchase.price_float">价格浮动</div><div class="text-white">${s.floatOn ? (window.i18n?.t('js.enabled_prefix') || 'Enabled (') + s.floatVal + '%)' : (window.i18n?.t('js.not_enabled') || 'Not Enabled')}</div></div></div>
                            <div class="col-12 col-md-4"><div class="p-3 rounded bg-dark border border-secondary border-opacity-25"><div class="text-white-50 small mb-1" data-i18n="purchase.deposit_req">定金要求</div><div class="text-white">${s.depoOn ? (window.i18n?.t('js.enabled_prefix') || 'Enabled (') + s.depoVal + '%)' : (window.i18n?.t('js.not_enabled') || 'Not Enabled')}</div></div></div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            statusCard.classList.remove('border-success');
            statusCard.classList.add('border-danger');
            statusHeader.innerHTML = `
                <div class="display-1 text-danger mb-4"><i class="fa-solid fa-circle-xmark"></i></div>
                <h3 class="text-white mb-3" data-i18n="modal.error.title">操作失败</h3>
                <p class="text-muted mb-0" data-i18n="ui.text_517">供应商创建未成功，请检查后重试</p>
            `;
            infoPanel.innerHTML = `
                <div class="card bg-black bg-opacity-50 border-danger border-opacity-25">
                    <div class="card-header bg-danger bg-opacity-10 border-0">
                        <i class="fa-solid fa-triangle-exclamation me-2 text-danger"></i>
                        <span class="text-danger" data-i18n="ui.text_63">错误信息</span>
                    </div>
                    <div class="card-body"><p class="text-white mb-0" data-i18n="ui.text_519">${errorMessage || (window.i18n?.t('js.unknown_error') || 'Unknown Error')}</p></div>
                </div>
            `;
        }
    }

    function resetSupplierForm() {
        const form = document.getElementById('form-add-supplier');
        if (form) form.reset();

        ['id_float_threshold_range', 'id_float_threshold', 'id_deposit_par_range', 'id_deposit_par'].forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.disabled = true; el.value = 0; }
        });

        document.getElementById('supplier-summary-content').innerHTML = '';
        document.getElementById('finish-status-header').innerHTML = '';
        document.getElementById('finish-info-panel').innerHTML = '';
        document.getElementById('finish-status-card').classList.remove('border-success', 'border-danger');
        document.getElementById('validation-errors-container').style.display = 'none';
        document.getElementById('validation-card').className = 'card mb-4 state-normal';
        document.getElementById('btn-wizard-confirm').disabled = true;

        lastSubmittedSupplier = null;
        step2ValidationPassed = false;
    }

    function getCsrfToken() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : '';
    }
</script>
{% endblock %}