{% extends "layouts/base.html" %}
{% load i18n security_tags %}

{% block title %}{% trans "Image Viewer" %} - {{ filename }} - Eaglestar ERP{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4" data-testid="viewer-header">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:sales:hub' %}"
                            class="text-info text-decoration-none">{% trans "销售板块" %}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:sales:report_center' %}"
                            class="text-info text-decoration-none">{% trans "报表中心" %}</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page">{% trans "Image Viewer" %}</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center mt-2">
                <div class="bg-primary bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-image fa-2x text-primary"></i>
                </div>
                <div>
                    <h4 class="text-white fw-bold mb-1" data-testid="viewer-title">{{ filename }}</h4>
                    <p class="text-white-50 small mb-0">
                        {% trans "大小" %}: {{ file_info.size_display }} | {% trans "修改时间" %}: {{ file_info.modified }}
                    </p>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ image_url }}" class="btn btn-success rounded-pill px-4" data-testid="btn-download">
                <i class="fas fa-download me-2"></i>{% trans "下载" %}
            </a>
            <a href="{% url 'web_ui:sales:report_center' %}" class="btn btn-outline-secondary rounded-pill px-4"
                data-testid="btn-back-list">
                <i class="fas fa-arrow-left me-2"></i>{% trans "返回文件列表" %}
            </a>
        </div>
    </div>

    <!-- 图片工具栏 -->
    <div class="glass-card p-3 mb-4" data-testid="image-toolbar">
        <div class="row align-items-center g-3">
            <!-- 缩放 -->
            <div class="col-md-6">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-white-50 small">{% trans "缩放" %}:</span>
                    <button type="button" class="btn btn-sm btn-outline-light" id="btn-zoom-out"
                        data-testid="btn-zoom-out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="text-white small" id="zoom-level" data-testid="zoom-level">100%</span>
                    <button type="button" class="btn btn-sm btn-outline-light" id="btn-zoom-in"
                        data-testid="btn-zoom-in">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-zoom-fit"
                        data-testid="btn-zoom-fit" data-i18n-title="tooltip.t4381" title="{% trans '适应窗口' %}">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-zoom-actual"
                        data-testid="btn-zoom-actual" data-i18n-title="tooltip.t2814" title="{% trans '实际大小' %}">
                        <i class="fas fa-search"></i> 1:1
                    </button>
                </div>
            </div>

            <!-- 旋转 -->
            <div class="col-md-6 text-end">
                <button type="button" class="btn btn-sm btn-outline-light" id="btn-rotate-left"
                    data-testid="btn-rotate-left" data-i18n-title="tooltip.t8296" title="{% trans '向左旋转' %}">
                    <i class="fas fa-undo"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="btn-rotate-right"
                    data-testid="btn-rotate-right" data-i18n-title="tooltip.t4718" title="{% trans '向右旋转' %}">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 图片内容区 -->
    <div class="glass-card p-4" data-testid="image-content">
        <div id="image-container"
            style="width: 100%; min-height: 500px; overflow: auto; text-align: center; cursor: grab;">
            <img id="view-image" src="{{ image_url }}" alt="{{ filename }}"
                style="max-width: 100%; transition: transform 0.2s;" data-testid="view-image"
                onerror="document.getElementById('image-error').style.display='block'; this.style.display='none';">

            <!-- 错误状态 -->
            <div id="image-error" class="text-center py-5" style="display: none;">
                <i class="fas fa-image fa-4x text-warning mb-3 opacity-50"></i>
                <h5 class="text-white-50">{% trans "无法加载图片" %}</h5>
                <p class="text-muted">{% trans "请尝试下载后查看" %}</p>
            </div>
        </div>
    </div>
</div>

<style>
    #view-image {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        border-radius: 8px;
    }

    #image-container.dragging {
        cursor: grabbing;
    }
</style>

<script>
    (function () {
        const ImageViewer = {
            scale: 1.0,
            rotation: 0,
            img: null,

            init: function () {
                this.img = document.getElementById('view-image');
                this.bindControls();
            },

            bindControls: function () {
                const self = this;

                document.getElementById('btn-zoom-in').addEventListener('click', () => {
                    if (self.scale < 5) {
                        self.scale += 0.25;
                        self.updateTransform();
                    }
                });

                document.getElementById('btn-zoom-out').addEventListener('click', () => {
                    if (self.scale > 0.25) {
                        self.scale -= 0.25;
                        self.updateTransform();
                    }
                });

                document.getElementById('btn-zoom-fit').addEventListener('click', () => {
                    self.scale = 1.0;
                    self.rotation = 0;
                    self.updateTransform();
                });

                document.getElementById('btn-zoom-actual').addEventListener('click', () => {
                    self.scale = 1.0;
                    self.img.style.maxWidth = 'none';
                    self.updateTransform();
                });

                document.getElementById('btn-rotate-left').addEventListener('click', () => {
                    self.rotation -= 90;
                    self.updateTransform();
                });

                document.getElementById('btn-rotate-right').addEventListener('click', () => {
                    self.rotation += 90;
                    self.updateTransform();
                });

                // 鼠标滚轮缩放
                document.getElementById('image-container').addEventListener('wheel', (e) => {
                    e.preventDefault();
                    if (e.deltaY < 0 && self.scale < 5) {
                        self.scale += 0.1;
                    } else if (e.deltaY > 0 && self.scale > 0.25) {
                        self.scale -= 0.1;
                    }
                    self.updateTransform();
                });
            },

            updateTransform: function () {
                this.img.style.transform = `scale(${this.scale}) rotate(${this.rotation}deg)`;
                document.getElementById('zoom-level').textContent = Math.round(this.scale * 100) + '%';
            }
        };

        if (document.readyState !== 'loading') {
            ImageViewer.init();
        } else {
            document.addEventListener('DOMContentLoaded', () => ImageViewer.init());
        }
    })();
</script>
{% endblock %}