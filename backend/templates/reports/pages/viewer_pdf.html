{% extends "layouts/base.html" %}
{% load i18n security_tags %}

{% block title %}{% trans "PDF Viewer" %} - {{ filename }} - Eaglestar ERP{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4" data-testid="viewer-header">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:sales:hub' %}"
                            class="text-info text-decoration-none">{% trans "销售板块" %}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:sales:report_center' %}"
                            class="text-info text-decoration-none">{% trans "报表中心" %}</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page">{% trans "PDF Viewer" %}</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center mt-2">
                <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-file-pdf fa-2x text-danger"></i>
                </div>
                <div>
                    <h4 class="text-white fw-bold mb-1" data-testid="viewer-title">{{ filename }}</h4>
                    <p class="text-white-50 small mb-0">
                        {% trans "大小" %}: {{ file_info.size_display }} | {% trans "修改时间" %}: {{ file_info.modified }}
                    </p>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ pdf_url }}" class="btn btn-success rounded-pill px-4" data-testid="btn-download">
                <i class="fas fa-download me-2"></i>{% trans "下载" %}
            </a>
            <a href="{% url 'web_ui:sales:report_center' %}" class="btn btn-outline-secondary rounded-pill px-4"
                data-testid="btn-back-list">
                <i class="fas fa-arrow-left me-2"></i>{% trans "返回文件列表" %}
            </a>
        </div>
    </div>

    <!-- PDF 工具栏 -->
    <div class="glass-card p-3 mb-4" data-testid="pdf-toolbar">
        <div class="row align-items-center g-3">
            <!-- 缩放 -->
            <div class="col-md-4">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-white-50 small">{% trans "缩放" %}:</span>
                    <button type="button" class="btn btn-sm btn-outline-light" id="btn-zoom-out"
                        data-testid="btn-zoom-out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="text-white small" id="zoom-level" data-testid="zoom-level">100%</span>
                    <button type="button" class="btn btn-sm btn-outline-light" id="btn-zoom-in"
                        data-testid="btn-zoom-in">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-zoom-fit"
                        data-testid="btn-zoom-fit" data-i18n-title="tooltip.t7626" title="{% trans '适应宽度' %}">
                        <i class="fas fa-arrows-alt-h"></i>
                    </button>
                </div>
            </div>

            <!-- 搜索 -->
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-white-50">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="pdf-search" class="form-control bg-dark text-white border-secondary"
                        data-i18n-placeholder="form.placeholder.generic_34" placeholder="{% trans '搜索关键字...' %}" data-testid="search-input">
                    <button type="button" class="btn btn-outline-info" id="btn-search-prev"
                        data-testid="btn-search-prev">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info" id="btn-search-next"
                        data-testid="btn-search-next">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <small class="text-white-50" id="search-result-count" data-testid="search-result-count"></small>
            </div>

            <!-- 页码 -->
            <div class="col-md-3 text-end">
                <span class="text-white-50 small">{% trans "页码" %}:</span>
                <span class="text-white" id="page-info" data-testid="page-info">1 / 1</span>
            </div>
        </div>
    </div>

    <!-- PDF 内容区 -->
    <div class="glass-card p-4" data-testid="pdf-content">
        <div id="pdf-container" style="width: 100%; min-height: 600px; overflow: auto; text-align: center;">
            <!-- PDF.js 渲染区域 -->
            <div id="pdf-viewer" style="display: inline-block;"></div>

            <!-- 加载中状态 -->
            <div id="pdf-loading" class="text-center py-5">
                <div class="spinner-border text-danger" role="status"></div>
                <p class="text-white-50 mt-3">{% trans "正在加载 PDF..." %}</p>
            </div>

            <!-- 错误状态 -->
            <div id="pdf-error" class="text-center py-5" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                <h5 class="text-white-50">{% trans "无法加载 PDF" %}</h5>
                <p class="text-muted">{% trans "请尝试下载后查看" %}</p>
            </div>
        </div>
    </div>
</div>

<style>
    #pdf-viewer canvas {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        margin: 10px auto;
    }

    .pdf-page {
        margin-bottom: 20px;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    (function () {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const PDFViewer = {
            pdf: null,
            currentPage: 1,
            totalPages: 0,
            scale: 1.0,

            init: async function () {
                const loadingEl = document.getElementById('pdf-loading');
                const errorEl = document.getElementById('pdf-error');
                const viewerEl = document.getElementById('pdf-viewer');

                try {
                    this.pdf = await pdfjsLib.getDocument('{{ pdf_url }}').promise;
                    this.totalPages = this.pdf.numPages;
                    document.getElementById('page-info').textContent = `1 / ${this.totalPages}`;

                    loadingEl.style.display = 'none';
                    await this.renderAllPages();
                    this.bindControls();
                } catch (e) {
                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'block';
                }
            },

            renderAllPages: async function () {
                const viewerEl = document.getElementById('pdf-viewer');
                viewerEl.innerHTML = '';

                for (let i = 1; i <= this.totalPages; i++) {
                    const page = await this.pdf.getPage(i);
                    const viewport = page.getViewport({ scale: this.scale });

                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page';
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    viewerEl.appendChild(canvas);
                }
            },

            bindControls: function () {
                document.getElementById('btn-zoom-in').addEventListener('click', () => {
                    if (this.scale < 3) {
                        this.scale += 0.25;
                        this.updateZoom();
                    }
                });

                document.getElementById('btn-zoom-out').addEventListener('click', () => {
                    if (this.scale > 0.5) {
                        this.scale -= 0.25;
                        this.updateZoom();
                    }
                });

                document.getElementById('btn-zoom-fit').addEventListener('click', () => {
                    this.scale = 1.0;
                    this.updateZoom();
                });
            },

            updateZoom: function () {
                document.getElementById('zoom-level').textContent = Math.round(this.scale * 100) + '%';
                this.renderAllPages();
            }
        };

        if (document.readyState !== 'loading') {
            PDFViewer.init();
        } else {
            document.addEventListener('DOMContentLoaded', () => PDFViewer.init());
        }
    })();
</script>
{% endblock %}