{% extends "layouts/base.html" %}
{% load security_tags %}
{% block title %}全景审计 - 安全审计 - ERP系统{% endblock %}
{% block content %}
{% if is_god_mode %}
<div class="god-mode-border"></div>
<div class="god-mode-badge"><i class="fa-solid fa-eye me-2"></i>GOD MODE (UNMASKED)</div>
{% endif %}
<div class="fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:dashboard' %}"
                            class="text-info text-decoration-none">系统管理</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:audit_dashboard' %}"
                            class="text-info text-decoration-none">安全审计日志</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page">全景审计</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center mt-2">
                <div class="bg-warning bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fa-solid fa-layer-group fa-2x text-warning"></i>
                </div>
                <div>
                    <h4 class="text-white fw-bold mb-1">全景审计 (Unified Events)</h4>
                    <p class="text-white-50 small mb-0">综合审计视图：点击任意一行查看完整事件详情，返回后自动保留筛选状态</p>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if is_superuser %}
            {% if is_god_mode %}
            <a href="{% url 'web_ui:audit_lock' %}" class="btn btn-danger rounded-pill px-4"><i
                    class="fa-solid fa-lock me-2"></i>立即上锁</a>
            {% else %}
            <button type="button" class="btn btn-outline-warning rounded-pill px-4" onclick="showGodModeModal()"><i
                    class="fa-solid fa-eye me-2"></i>解锁上帝模式</button>
            {% endif %}
            {% endif %}
            <a href="{% url 'web_ui:audit_dashboard' %}" class="btn btn-outline-secondary rounded-pill px-4"><i
                    class="fas fa-arrow-left me-2"></i>返回审计中心</a>
        </div>
    </div>

    <!-- Filters: 后端筛选 (days/status/page_size) + 前端筛选 (action/target/source/keyword) -->
    <div class="glass-card mb-4 p-3">
        <!-- 后端筛选表单 -->
        <form method="GET" id="backendFilterForm" class="row g-2 align-items-end mb-2">
            <div class="col-auto">
                <label class="form-label text-white-50 small mb-1">近N天</label>
                <select name="days" class="form-select form-select-sm bg-dark text-white border-secondary rounded-3"
                    style="width:80px">
                    <option value="1" {% if filters.days == '1' %}selected{% endif %}>1天</option>
                    <option value="3" {% if filters.days == '3' %}selected{% endif %}>3天</option>
                    <option value="7" {% if filters.days == '7' %}selected{% endif %}>7天</option>
                    <option value="14" {% if filters.days == '14' %}selected{% endif %}>14天</option>
                    <option value="30" {% if filters.days == '30' %}selected{% endif %}>30天</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label text-white-50 small mb-1">状态</label>
                <select name="status" class="form-select form-select-sm bg-dark text-white border-secondary rounded-3"
                    style="width:90px">
                    <option value="ALL" {% if filters.status == 'ALL' %}selected{% endif %}>全部</option>
                    <option value="Success" {% if filters.status == 'Success' %}selected{% endif %}>成功</option>
                    <option value="Failed" {% if filters.status == 'Failed' %}selected{% endif %}>失败</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label text-white-50 small mb-1">每页</label>
                <select name="page_size"
                    class="form-select form-select-sm bg-dark text-white border-secondary rounded-3" style="width:70px">
                    <option value="10" {% if pagination.page_size == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if pagination.page_size == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if pagination.page_size == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if pagination.page_size == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-warning rounded-pill px-3"><i
                        class="fas fa-sync-alt me-1"></i>加载</button>
            </div>
            <div class="col-auto ms-auto">
                <span class="badge bg-warning bg-opacity-25 text-warning px-3 py-2">共 {{ pagination.total_count }} 事件 /
                    第 {{ pagination.page }}/{{ pagination.total_pages }} 页</span>
            </div>
        </form>
        <!-- 前端实时筛选（贴合表格列） -->
        <div class="row g-2 align-items-end border-top border-secondary border-opacity-25 pt-2 mt-1">
            <div class="col-auto">
                <label class="form-label text-info small mb-1"><i class="fas fa-filter me-1"></i>本页筛选</label>
            </div>
            <div class="col-auto">
                <select id="filterAction" class="form-select form-select-sm bg-dark text-white border-info rounded-3"
                    style="width:140px">
                    <option value="">动作 (全部)</option>
                </select>
            </div>
            <div class="col-auto">
                <select id="filterTarget" class="form-select form-select-sm bg-dark text-white border-info rounded-3"
                    style="width:140px">
                    <option value="">目标 (全部)</option>
                </select>
            </div>
            <div class="col-auto">
                <select id="filterSource" class="form-select form-select-sm bg-dark text-white border-info rounded-3"
                    style="width:120px">
                    <option value="">来源 (全部)</option>
                    <option value="app">app</option>
                    <option value="audit">audit</option>
                    <option value="error">error</option>
                    <option value="db">db</option>
                </select>
            </div>
            <div class="col-auto">
                <input type="text" id="filterKeyword"
                    class="form-control form-control-sm bg-dark text-white border-info rounded-3" placeholder="关键词..."
                    style="width:120px">
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-outline-info rounded-pill px-3"
                    onclick="resetFrontendFilters()"><i class="fas fa-times me-1"></i>清除</button>
            </div>
            <div class="col-auto">
                <span id="filterResultCount" class="text-white-50 small"></span>
            </div>
        </div>
    </div>

    <!-- Events List -->
    <div class="glass-card overflow-hidden shadow-lg">
        <div class="table-responsive">
            <table class="table mb-0 align-middle audit-table">
                <thead>
                    <tr>
                        <th style="width:30px"></th>
                        <th class="ps-3" style="width:140px">时间</th>
                        <th style="width:80px">用户</th>
                        <th style="width:100px">来源IP</th>
                        <th>功能路径</th>
                        <th style="width:140px">动作</th>
                        <th style="width:120px">目标</th>
                        <th style="width:80px">状态</th>
                        <th style="width:120px">日志来源</th>
                        <th class="text-end pe-3" style="width:80px">条目数</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr class="event-row clickable" data-event-id="{{ event.event_key }}"
                        data-detail-href="/dashboard/audit/events/{{ event.event_key|urlencode }}/?return={{ request.get_full_path|urlencode }}"
                        data-action="{{ event.action }}" data-target="{{ event.target }}"
                        data-status="{{ event.status }}" data-root-cause="{{ event.root_cause|default:'-' }}"
                        data-user="{{ event.user }}" data-ip="{{ event.ip }}" data-page="{{ event.page }}"
                        data-last-time="{{ event.last_time }}" data-counts='{{ event.counts_by_source|safe }}'
                        data-entries='[{% for e in event.entries %}{"time":"{{ e.time|escapejs }}","source":"{{ e.source|escapejs }}","reference":"{{ e.reference|default:'-'|escapejs }}","user":"{{ e.user|default:'-'|escapejs }}","ip":"{{ e.ip|default:'-'|escapejs }}","page":"{{ e.page|default:'-'|escapejs }}","action":"{{ e.action|escapejs }}","target":"{{ e.target|default:'-'|escapejs }}","status":"{{ e.status|escapejs }}","root_cause":"{{ e.root_cause|default:'-'|escapejs }}","details":"{{ e.details|default:'-'|escapejs }}","note":"{{ e.note|default:'-'|escapejs }}","meta":"{{ e.meta|default:'-'|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]' style="cursor:pointer;" tabindex="0">
                        <td class="text-center" onclick="event.stopPropagation();">
                            <button class="btn btn-sm btn-link text-info p-0 toggle-detail"
                                onclick="toggleEntries('{{ forloop.counter }}')">
                                <i class="fas fa-chevron-right" id="icon-{{ forloop.counter }}"></i>
                            </button>
                        </td>
                        <td class="ps-3 font-monospace small text-white-50">{{ event.last_time }}</td>
                        <td class="text-white">{{ event.user }}</td>
                        <td class="font-monospace small text-muted">{{ event.ip }}</td>
                        <td class="text-info text-truncate" style="max-width:180px" title="{{ event.page }}">{{
                            event.page }}</td>
                        <td><span class="badge bg-secondary bg-opacity-50 font-monospace">{{ event.action }}</span></td>
                        <td class="text-truncate small" style="max-width:120px" title="{{ event.target }}">{{
                            event.target }}</td>
                        <td>{% if 'Failed' in event.status %}<span class="badge bg-danger">{{ event.status }}</span>{%
                            else %}<span class="badge bg-success">{{ event.status }}</span>{% endif %}</td>
                        <td class="small">
                            {% if event.counts_by_source.app > 0 %}<span class="badge bg-primary me-1">app:{{
                                event.counts_by_source.app }}</span>{% endif %}
                            {% if event.counts_by_source.audit > 0 %}<span class="badge bg-info me-1">audit:{{
                                event.counts_by_source.audit }}</span>{% endif %}
                            {% if event.counts_by_source.error > 0 %}<span class="badge bg-danger me-1">error:{{
                                event.counts_by_source.error }}</span>{% endif %}
                            {% if event.counts_by_source.db > 0 %}<span class="badge bg-warning text-dark">db:{{
                                event.counts_by_source.db }}</span>{% endif %}
                        </td>
                        <td class="text-end pe-3"><span class="badge bg-secondary">{{ event.entry_count }}</span></td>
                    </tr>
                    <!-- Entries Detail Row -->
                    <tr class="entries-row d-none" id="entries-{{ forloop.counter }}">
                        <td colspan="10" class="bg-dark bg-opacity-50 p-3">
                            <div class="small">
                                <div class="text-white-50 mb-2"><i class="fas fa-list me-2"></i>事件详情 ({{
                                    event.entry_count }} 条日志)</div>
                                <table class="table table-sm table-dark mb-0">
                                    <thead>
                                        <tr class="text-white-50">
                                            <th>时间</th>
                                            <th>来源</th>
                                            <th>页面</th>
                                            <th>动作</th>
                                            <th>目标</th>
                                            <th>状态</th>
                                            <th>失败原因</th>
                                            <th>详情</th>
                                        </tr>
                                    </thead>
                                    <tbody class="entries-body" id="entries-body-{{ forloop.counter }}">
                                        {% for entry in event.entries %}
                                        <tr
                                            class="{% if forloop.counter > 10 %}entry-hidden-{{ forloop.parentloop.counter }} d-none{% endif %}">
                                            <td class="font-monospace">{{ entry.time }}</td>
                                            <td><span
                                                    class="badge {% if entry.source == 'app' %}bg-primary{% elif entry.source == 'audit' %}bg-info{% elif entry.source == 'db' %}bg-warning text-dark{% else %}bg-danger{% endif %}">{{
                                                    entry.source }}</span></td>
                                            <td class="text-truncate" style="max-width:150px" title="{{ entry.page }}">
                                                {{ entry.page }}</td>
                                            <td>{{ entry.action }}</td>
                                            <td>{{ entry.target }}</td>
                                            <td>{% if 'Failed' in entry.status %}<span class="text-danger">{{
                                                    entry.status }}</span>{% else %}{{ entry.status }}{% endif %}</td>
                                            <td class="text-warning">{{ entry.root_cause }}</td>
                                            <td class="text-truncate" style="max-width:200px"
                                                title="{{ entry.details }}">{{ entry.details }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if event.entry_count > 10 %}
                                <button class="btn btn-sm btn-outline-info mt-2 show-all-btn"
                                    id="show-all-{{ forloop.counter }}"
                                    onclick="showAllEntries('{{ forloop.counter }}')">
                                    <i class="fas fa-expand me-1"></i>显示全部（共 {{ event.entry_count }} 条）
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-secondary opacity-50 mb-3"></i>
                            <p class="text-white-50 mb-0">暂无事件记录</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0">
                <!-- 上一页 -->
                {% if pagination.has_previous %}
                <li class="page-item">
                    <a class="page-link bg-dark text-white border-secondary"
                        href="?page={{ pagination.page|add:'-1' }}&page_size={{ pagination.page_size }}&days={{ filters.days }}&status={{ filters.status }}">
                        <i class="fas fa-chevron-left"></i> 上一页
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link bg-dark text-secondary border-secondary"><i class="fas fa-chevron-left"></i>
                        上一页</span>
                </li>
                {% endif %}

                <!-- 页码 -->
                {% for p in pagination.page_range %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <a class="page-link {% if p == pagination.page %}bg-warning text-dark border-warning{% else %}bg-dark text-white border-secondary{% endif %}"
                        href="?page={{ p }}&page_size={{ pagination.page_size }}&days={{ filters.days }}&status={{ filters.status }}">{{
                        p }}</a>
                </li>
                {% endfor %}

                <!-- 下一页 -->
                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link bg-dark text-white border-secondary"
                        href="?page={{ pagination.page|add:'1' }}&page_size={{ pagination.page_size }}&days={{ filters.days }}&status={{ filters.status }}">
                        下一页 <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link bg-dark text-secondary border-secondary">下一页 <i
                            class="fas fa-chevron-right"></i></span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<style>
    .audit-table {
        background: transparent;
        border-collapse: separate;
        border-spacing: 0;
    }

    .audit-table thead tr {
        background: rgba(255, 255, 255, 0.03);
    }

    .audit-table thead th {
        padding: 14px 16px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        white-space: nowrap;
    }

    .audit-table tbody tr {
        transition: all 0.15s ease;
    }

    .audit-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.04);
    }

    .audit-table tbody td {
        padding: 14px 16px;
        color: rgba(255, 255, 255, 0.85);
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        vertical-align: middle;
    }

    .event-row {
        cursor: pointer;
    }

    .entries-row td {
        padding: 0 !important;
    }

    .toggle-detail i {
        transition: transform 0.2s;
    }

    .toggle-detail.expanded i {
        transform: rotate(90deg);
    }

    .god-mode-border {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 4px solid rgba(220, 53, 69, 0.6);
        pointer-events: none;
        z-index: 0;
        animation: pulse-border 2s infinite;
    }

    .god-mode-badge {
        position: fixed;
        top: 10px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.8rem;
        z-index: 9999;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.8);
    }

    @keyframes pulse-border {
        0% {
            border-color: rgba(220, 53, 69, 0.3);
        }

        50% {
            border-color: rgba(220, 53, 69, 0.8);
        }

        100% {
            border-color: rgba(220, 53, 69, 0.3);
        }
    }

    .pagination .page-link {
        padding: 0.5rem 0.75rem;
    }

    /* Event Detail Modal Styles */
    .event-row.clickable {
        cursor: pointer;
    }

    .event-row.clickable:hover {
        background: rgba(255, 255, 255, 0.06) !important;
    }

    .event-detail-modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    .event-summary-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }

    .entry-card {
        background: rgba(30, 32, 40, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .entry-card:last-child {
        margin-bottom: 0;
    }

    .entry-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .entry-kv-row {
        display: flex;
        margin-bottom: 0.25rem;
    }

    .entry-kv-label {
        width: 80px;
        flex-shrink: 0;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.8rem;
    }

    .entry-kv-value {
        flex: 1;
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.85rem;
        word-break: break-all;
    }

    .entry-long-text {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        max-height: 60px;
        overflow: hidden;
        position: relative;
        transition: max-height 0.3s ease;
    }

    .entry-long-text.expanded {
        max-height: none;
    }

    .entry-long-text-toggle {
        cursor: pointer;
        color: #0dcaf0;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        display: inline-block;
    }

    .entry-long-text-toggle:hover {
        text-decoration: underline;
    }

    .source-badge-app {
        background-color: #0d6efd;
    }

    .source-badge-audit {
        background-color: #0dcaf0;
    }

    .source-badge-error {
        background-color: #dc3545;
    }

    .source-badge-db {
        background-color: #ffc107;
        color: #000;
    }
</style>

<script>
    // ========================================
    // [Phase 3.4] Events Page - Complete JS
    // ========================================

    // --- 基础工具函数 ---
    function escapeHtml(text) {
        if (text === null || text === undefined) return '-';
        const str = String(text);
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // --- 展开/收起 entries 表格 ---
    function toggleEntries(idx) {
        const row = document.getElementById('entries-' + idx);
        const icon = document.getElementById('icon-' + idx);
        if (!row || !icon) return;
        const btn = icon.closest('.toggle-detail');
        if (row.classList.contains('d-none')) {
            row.classList.remove('d-none');
            if (btn) btn.classList.add('expanded');
        } else {
            row.classList.add('d-none');
            if (btn) btn.classList.remove('expanded');
        }
    }

    function showAllEntries(idx) {
        const hiddenRows = document.querySelectorAll('.entry-hidden-' + idx);
        hiddenRows.forEach(row => row.classList.remove('d-none'));
        const btn = document.getElementById('show-all-' + idx);
        if (btn) btn.style.display = 'none';
    }

    // --- 长文本展开/收起 ---
    function toggleLongText(id, toggle) {
        const el = document.getElementById(id);
        if (!el) return;
        const isExpanded = el.classList.toggle('expanded');
        toggle.textContent = isExpanded ? '收起 ▲' : '展开 ▼';
    }

    // ========================================
    // [Task 1] Event Detail Modal - 事件委托
    // ========================================
    let savedScrollY = 0;

    function showEventDetailModal(rowEl) {
        const eventId = rowEl.dataset.eventId || 'unknown';
        console.log('[GlobalModal] open', eventId);

        // 保存滚动位置
        savedScrollY = window.scrollY;

        // 读取 data 属性
        const action = rowEl.dataset.action || '-';
        const target = rowEl.dataset.target || '-';
        const status = rowEl.dataset.status || '-';
        const rootCause = rowEl.dataset.rootCause || '-';
        const user = rowEl.dataset.user || '-';
        const ip = rowEl.dataset.ip || '-';
        const page = rowEl.dataset.page || '-';
        const lastTime = rowEl.dataset.lastTime || '-';

        let counts = {};
        try { counts = JSON.parse(rowEl.dataset.counts || '{}'); } catch (e) { counts = {}; }

        let entries = [];
        let entriesParseError = null;
        try {
            entries = JSON.parse(rowEl.dataset.entries || '[]');
        } catch (e) {
            entriesParseError = e.message;
            entries = [];
        }

        // 时间范围
        let timeRange = lastTime;
        if (entries.length > 1) {
            const times = entries.map(e => e.time).filter(t => t && t !== '-').sort();
            if (times.length > 1) {
                timeRange = times[0] + ' ~ ' + times[times.length - 1];
            }
        }

        // 状态 badge
        const statusClass = (status || '').includes('Failed') ? 'bg-danger' : 'bg-success';

        // counts badges
        let countsBadges = '';
        if (counts.app > 0) countsBadges += `<span class="badge source-badge-app me-1">app: ${counts.app}</span>`;
        if (counts.audit > 0) countsBadges += `<span class="badge source-badge-audit me-1">audit: ${counts.audit}</span>`;
        if (counts.error > 0) countsBadges += `<span class="badge source-badge-error me-1">error: ${counts.error}</span>`;
        if (counts.db > 0) countsBadges += `<span class="badge source-badge-db">db: ${counts.db}</span>`;

        // Summary Card
        const summaryHtml = `
            <div class="event-summary-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="text-white mb-1">${escapeHtml(action)}</h5>
                        <p class="text-white-50 mb-0 small">${escapeHtml(target)}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge ${statusClass} mb-1">${escapeHtml(status)}</span>
                        <div class="small mt-1">${countsBadges}</div>
                    </div>
                </div>
                <div class="row small text-white-50">
                    <div class="col-md-6 mb-2"><i class="fas fa-user me-2"></i><strong>用户:</strong> ${escapeHtml(user)}</div>
                    <div class="col-md-6 mb-2"><i class="fas fa-network-wired me-2"></i><strong>IP:</strong> ${escapeHtml(ip)}</div>
                    <div class="col-md-6 mb-2"><i class="fas fa-sitemap me-2"></i><strong>页面:</strong> ${escapeHtml(page)}</div>
                    <div class="col-md-6 mb-2"><i class="fas fa-clock me-2"></i><strong>时间:</strong> ${escapeHtml(timeRange)}</div>
                    ${rootCause !== '-' ? `<div class="col-12"><i class="fas fa-exclamation-triangle me-2 text-warning"></i><strong>失败原因:</strong> <span class="text-warning">${escapeHtml(rootCause)}</span></div>` : ''}
                </div>
            </div>
        `;

        // Entries Cards
        let entriesHtml = '';
        if (entriesParseError) {
            // 解析失败兜底
            const rawPreview = (rowEl.dataset.entries || '').substring(0, 200);
            entriesHtml = `
                <div class="alert alert-warning small">
                    <i class="fas fa-exclamation-triangle me-2"></i>数据解析失败: ${escapeHtml(entriesParseError)}
                    <div class="mt-2 text-muted" style="word-break:break-all;">${escapeHtml(rawPreview)}...</div>
                </div>
            `;
        } else {
            entriesHtml = '<div class="text-white-50 small mb-2"><i class="fas fa-list me-2"></i>日志条目 (' + entries.length + ' 条)</div>';
            entries.forEach((entry, idx) => {
                const srcClass = entry.source === 'app' ? 'source-badge-app' :
                    entry.source === 'audit' ? 'source-badge-audit' :
                        entry.source === 'db' ? 'source-badge-db' : 'source-badge-error';
                const entryStatus = (entry.status || '-').toString();
                const entryStatusClass = entryStatus.includes('Failed') ? 'text-danger' : '';
                const longTextId = 'lt-' + idx;
                const hasDetails = entry.details && entry.details !== '-';
                const hasMeta = entry.meta && entry.meta !== '-';
                const hasNote = entry.note && entry.note !== '-';

                entriesHtml += `
                    <div class="entry-card">
                        <div class="entry-card-header">
                            <span class="badge ${srcClass}">${escapeHtml(entry.source || '-')}</span>
                            <span class="text-white-50 small font-monospace">${escapeHtml(entry.time || '-')}</span>
                        </div>
                        <div class="entry-kv-row"><span class="entry-kv-label">Reference</span><span class="entry-kv-value font-monospace">${escapeHtml(entry.reference || '-')}</span></div>
                        <div class="entry-kv-row"><span class="entry-kv-label">用户</span><span class="entry-kv-value">${escapeHtml(entry.user || '-')}</span></div>
                        <div class="entry-kv-row"><span class="entry-kv-label">IP</span><span class="entry-kv-value font-monospace">${escapeHtml(entry.ip || '-')}</span></div>
                        <div class="entry-kv-row"><span class="entry-kv-label">页面</span><span class="entry-kv-value">${escapeHtml(entry.page || '-')}</span></div>
                        <div class="entry-kv-row"><span class="entry-kv-label">动作</span><span class="entry-kv-value">${escapeHtml(entry.action || '-')}</span></div>
                        <div class="entry-kv-row"><span class="entry-kv-label">目标</span><span class="entry-kv-value">${escapeHtml(entry.target || '-')}</span></div>
                        <div class="entry-kv-row"><span class="entry-kv-label">状态</span><span class="entry-kv-value ${entryStatusClass}">${escapeHtml(entryStatus)}</span></div>
                        ${(entry.root_cause && entry.root_cause !== '-') ? `<div class="entry-kv-row"><span class="entry-kv-label">原因</span><span class="entry-kv-value text-warning">${escapeHtml(entry.root_cause)}</span></div>` : ''}
                        ${hasDetails ? `
                            <div class="entry-long-text" id="${longTextId}-details">${escapeHtml(entry.details)}</div>
                            <span class="entry-long-text-toggle" onclick="toggleLongText('${longTextId}-details', this)">展开详情 ▼</span>
                        ` : ''}
                        ${hasMeta ? `
                            <div class="entry-long-text" id="${longTextId}-meta">${escapeHtml(entry.meta)}</div>
                            <span class="entry-long-text-toggle" onclick="toggleLongText('${longTextId}-meta', this)">展开 Meta ▼</span>
                        ` : ''}
                        ${hasNote ? `
                            <div class="entry-long-text" id="${longTextId}-note">${escapeHtml(entry.note)}</div>
                            <span class="entry-long-text-toggle" onclick="toggleLongText('${longTextId}-note', this)">展开备注 ▼</span>
                        ` : ''}
                    </div>
                `;
            });
        }

        // Full Modal HTML
        const modalHtml = `
            <div class="modal-header border-0">
                <h5 class="modal-title text-white"><i class="fas fa-layer-group me-2 text-warning"></i>事件详情</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body event-detail-modal-body">
                ${summaryHtml}
                ${entriesHtml}
            </div>
            <div class="modal-footer border-0 justify-content-end">
                <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>关闭
                </button>
            </div>
        `;

        // 使用 GlobalModal.showCustom
        if (typeof GlobalModal !== 'undefined' && GlobalModal.showCustom) {
            GlobalModal.showCustom({
                html: modalHtml,
                borderColor: '#ffc107',
                glowEffect: 'none',
                overrideDefault: true,
                backMode: 'none',
                clearMode: 'none'
            });
            console.log('[GlobalModal] shown');
        } else {
            // Fallback: 直接使用 Bootstrap Modal
            const modalEl = document.getElementById('globalModal');
            if (modalEl) {
                const content = modalEl.querySelector('.modal-content');
                if (content) content.innerHTML = modalHtml;
                const bsModal = new bootstrap.Modal(modalEl);
                bsModal.show();
                console.log('[GlobalModal] shown (bootstrap fallback)');
            } else {
                alert('Modal 容器不存在');
            }
        }
    }

    // ========================================
    // [Phase 3.5] 点击行跳转到详情页（替代 Modal）
    // ========================================
    function navigateToEventDetail(row) {
        const eventKey = row.dataset.eventId;
        if (!eventKey) {
            console.warn('[Events] No event key found');
            return;
        }

        // 构建返回 URL（当前页面完整 URL）
        const currentUrl = window.location.href;
        const returnUrl = encodeURIComponent(currentUrl);

        // 构建详情页 URL
        const detailUrl = `/dashboard/audit/events/${encodeURIComponent(eventKey)}/?return=${returnUrl}`;

        console.log('[Events] Navigating to:', detailUrl);
        window.location.href = detailUrl;
    }

    // 事件委托：监听整个 document 的点击事件
    document.addEventListener('click', function (e) {
        console.log('[Events] click captured', e.target);

        // 检查是否点击了展开按钮区域（td.text-center 或 .toggle-detail）
        if (e.target.closest('.toggle-detail') || e.target.closest('td.text-center')) {
            console.log('[Events] ignored - toggle area');
            return; // 不处理展开按钮区域的点击
        }

        // 检查是否点击了 event-row
        const row = e.target.closest('tr.event-row');
        if (row) {
            console.log('[Events] row found, navigating to detail page');
            navigateToEventDetail(row);
        }
    });

    // 键盘支持：Enter/Space 跳转到详情页
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
            const row = e.target.closest('tr.event-row');
            if (row) {
                e.preventDefault();
                navigateToEventDetail(row);
            }
        }
    });

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function () {
        console.log('[Events] JS loaded', new Date().toISOString());
    });

    // ========================================
    // [Task 2] Frontend Filters - 动态生成选项
    // ========================================
    function initFrontendFilters() {
        const rows = document.querySelectorAll('tr.event-row');
        const actionSet = new Set();
        const targetSet = new Set();

        rows.forEach(row => {
            const action = row.dataset.action || '';
            const target = row.dataset.target || '';
            if (action && action !== '-') actionSet.add(action);
            if (target && target !== '-') targetSet.add(target);
        });

        // 填充 Action 下拉
        const actionSelect = document.getElementById('filterAction');
        if (actionSelect) {
            actionSelect.innerHTML = '<option value="">动作 (全部)</option>';
            [...actionSet].sort().forEach(a => {
                actionSelect.innerHTML += `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`;
            });
        }

        // 填充 Target 下拉
        const targetSelect = document.getElementById('filterTarget');
        if (targetSelect) {
            targetSelect.innerHTML = '<option value="">目标 (全部)</option>';
            [...targetSet].sort().forEach(t => {
                targetSelect.innerHTML += `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`;
            });
        }

        console.log('[Filters] Initialized - actions:', actionSet.size, 'targets:', targetSet.size);
    }

    function applyFrontendFilters() {
        const filterAction = (document.getElementById('filterAction')?.value || '').toLowerCase();
        const filterTarget = (document.getElementById('filterTarget')?.value || '').toLowerCase();
        const filterSource = (document.getElementById('filterSource')?.value || '').toLowerCase();
        const filterKeyword = (document.getElementById('filterKeyword')?.value || '').toLowerCase();

        const rows = document.querySelectorAll('tr.event-row');
        let visible = 0;
        let hidden = 0;

        rows.forEach(row => {
            const action = (row.dataset.action || '').toLowerCase();
            const target = (row.dataset.target || '').toLowerCase();
            const status = (row.dataset.status || '').toLowerCase();
            const rootCause = (row.dataset.rootCause || '').toLowerCase();
            const user = (row.dataset.user || '').toLowerCase();
            const page = (row.dataset.page || '').toLowerCase();

            // counts_by_source 判断来源
            let counts = {};
            try { counts = JSON.parse(row.dataset.counts || '{}'); } catch (e) { }
            const hasSource = (src) => (counts[src] || 0) > 0;

            let match = true;

            // Action 过滤
            if (filterAction && action !== filterAction) match = false;

            // Target 过滤
            if (filterTarget && target !== filterTarget) match = false;

            // Source 过滤
            if (filterSource && !hasSource(filterSource)) match = false;

            // Keyword 过滤
            if (filterKeyword) {
                const searchable = action + ' ' + target + ' ' + status + ' ' + rootCause + ' ' + user + ' ' + page;
                if (!searchable.includes(filterKeyword)) match = false;
            }

            // 显示/隐藏行
            if (match) {
                row.style.display = '';
                // 同时显示对应的 entries-row (如果展开的话保持原样)
                visible++;
            } else {
                row.style.display = 'none';
                // 隐藏对应的 entries-row
                const idx = Array.from(rows).indexOf(row) + 1;
                const entriesRow = document.getElementById('entries-' + idx);
                if (entriesRow) entriesRow.classList.add('d-none');
                hidden++;
            }
        });

        // 更新结果计数
        const countEl = document.getElementById('filterResultCount');
        if (countEl) {
            if (filterAction || filterTarget || filterSource || filterKeyword) {
                countEl.textContent = `显示 ${visible} / ${visible + hidden} 条`;
                countEl.className = visible === 0 ? 'text-warning small' : 'text-info small';
            } else {
                countEl.textContent = '';
            }
        }
    }

    function resetFrontendFilters() {
        const actionSel = document.getElementById('filterAction');
        const targetSel = document.getElementById('filterTarget');
        const sourceSel = document.getElementById('filterSource');
        const keywordInput = document.getElementById('filterKeyword');
        if (actionSel) actionSel.value = '';
        if (targetSel) targetSel.value = '';
        if (sourceSel) sourceSel.value = '';
        if (keywordInput) keywordInput.value = '';
        applyFrontendFilters();
    }

    // 绑定前端筛选控件事件
    document.addEventListener('DOMContentLoaded', function () {
        initFrontendFilters();

        const filterAction = document.getElementById('filterAction');
        const filterTarget = document.getElementById('filterTarget');
        const filterSource = document.getElementById('filterSource');
        const filterKeyword = document.getElementById('filterKeyword');

        if (filterAction) filterAction.addEventListener('change', applyFrontendFilters);
        if (filterTarget) filterTarget.addEventListener('change', applyFrontendFilters);
        if (filterSource) filterSource.addEventListener('change', applyFrontendFilters);
        if (filterKeyword) filterKeyword.addEventListener('input', applyFrontendFilters);
    });

    // ========================================
    // God Mode Modal
    // ========================================
    function showGodModeModal() {
        GlobalModal.showCustom({
            html: `
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger fw-bold"><i class="fa-solid fa-triangle-exclamation me-2"></i>身份核验 (Security Check)</h5>
            </div>
            <div class="modal-body pt-3">
                <p class="text-white-50 small mb-3">查看日志全部隐藏内容</p>
                <form id="godModeForm" action="{% url 'web_ui:audit_unlock' %}" method="POST">
                    {% csrf_token %}
                    {% security_inputs "btn_unlock_view" %}
                    <div class="d-flex justify-content-end gap-3 mt-4">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" onclick="GlobalModal.hide()">取消</button>
                        <button type="submit" class="btn btn-danger rounded-pill px-4 fw-bold"><i class="fa-solid fa-unlock me-2"></i>确认解锁</button>
                    </div>
                </form>
            </div>
        `,
            borderColor: '#dc3545',
            glowEffect: 'blink'
        });
    }
</script>
{% endblock %}