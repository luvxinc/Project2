{% extends "layouts/base.html" %}
{% load security_tags %}
{% block title %}日志详情 - 安全审计 - ERP系统{% endblock %}
{% block content %}
{% if is_god_mode %}
<div class="god-mode-border"></div>
<div class="god-mode-badge"><i class="fa-solid fa-eye me-2"></i>GOD MODE (UNMASKED)</div>
{% endif %}
<div class="fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:dashboard' %}"
                            class="text-info text-decoration-none">系统管理</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:audit_dashboard' %}"
                            class="text-info text-decoration-none">安全审计日志</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page">日志详情</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center mt-2">
                <div class="bg-info bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fa-solid fa-id-card fa-2x text-info"></i>
                </div>
                <div>
                    <h4 class="text-white fw-bold mb-1">日志详情 (Log Detail)</h4>
                    <p class="text-white-50 small mb-0">单条审计日志的完整信息名片视图</p>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if is_superuser %}
            {% if is_god_mode %}
            <a href="{% url 'web_ui:audit_lock' %}" class="btn btn-danger rounded-pill px-4"><i
                    class="fa-solid fa-lock me-2"></i>立即上锁</a>
            {% else %}
            <button type="button" class="btn btn-outline-warning rounded-pill px-4" onclick="showGodModeModal()"><i
                    class="fa-solid fa-eye me-2"></i>解锁上帝模式</button>
            {% endif %}
            {% endif %}
            <a href="{{ return_url }}" class="btn btn-outline-info rounded-pill px-4" id="backBtn"
                data-return="{{ return_url }}"><i class="fas fa-arrow-left me-2"></i>返回列表</a>
        </div>
    </div>

    {% if error %}
    <!-- Error State -->
    <div class="glass-card p-5 text-center">
        <i class="fas fa-exclamation-triangle fa-4x text-warning mb-4"></i>
        <h5 class="text-white mb-3">{{ error }}</h5>
        <a href="{{ return_url }}" class="btn btn-warning rounded-pill px-4 mt-3">
            <i class="fas fa-arrow-left me-2"></i>返回列表
        </a>
    </div>
    {% else %}
    <!-- Card 1: Summary -->
    <div class="glass-card mb-4 p-4" data-testid="detail-card">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-bolt text-warning me-2"></i>
            <h6 class="text-white mb-0 fw-bold">日志摘要 (Summary)</h6>
        </div>
        <div class="row">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-secondary bg-opacity-50 font-monospace fs-6 me-3">{{ main_log.action|default:'-' }}</span>
                    <span class="text-white-50">→</span>
                    <span class="text-info ms-3">{{ main_log.target|default:'-' }}</span>
                </div>
                <div class="row small text-white-50">
                    <div class="col-md-6 mb-2">
                        <i class="fas fa-clock me-2"></i><strong>时间:</strong>
                        <span class="font-monospace text-white">{{ main_log.time|default:'-' }}</span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <i class="fas fa-user me-2"></i><strong>用户:</strong>
                        <span class="text-white">{{ main_log.user|default:'-' }}</span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <i class="fas fa-network-wired me-2"></i><strong>IP:</strong>
                        <span class="font-monospace text-white">{{ main_log.ip|default:'-' }}</span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <i class="fas fa-sitemap me-2"></i><strong>页面:</strong>
                        <span class="text-white">{{ main_log.page|default:'-' }}</span>
                    </div>
                    {% if main_log.root_cause and main_log.root_cause != '-' %}
                    <div class="col-12 mt-2">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i><strong>失败原因:</strong>
                        <span class="text-warning">{{ main_log.root_cause }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="mb-3">
                    {% if 'Failed' in main_log.status %}
                    <span class="badge bg-danger fs-6 px-3 py-2">{{ main_log.status }}</span>
                    {% else %}
                    <span class="badge bg-success fs-6 px-3 py-2">{{ main_log.status|default:'Success' }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Card 2: Main Fields -->
    <div class="glass-card mb-4 p-4">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-list-alt text-info me-2"></i>
            <h6 class="text-white mb-0 fw-bold">关键信息 (Main Fields)</h6>
        </div>
        <div class="row small">
            <div class="col-md-6 mb-3">
                <div class="detail-field">
                    <span class="detail-label">Reference ID</span>
                    <span class="detail-value font-monospace">{{ ref_id|default:'-' }}</span>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-field">
                    <span class="detail-label">Event ID</span>
                    <span class="detail-value font-monospace">{{ main_log.event_id|default:'-' }}</span>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-field">
                    <span class="detail-label">Category</span>
                    <span class="detail-value">{{ main_log.category|default:'-' }}</span>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="detail-field">
                    <span class="detail-label">Application</span>
                    <span class="detail-value">{{ main_log.application|default:'-' }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 3: Details -->
    {% if details_obj %}
    <div class="glass-card mb-4 p-4">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-info-circle text-warning me-2"></i>
            <h6 class="text-white mb-0 fw-bold">变更详情 (Changes)</h6>
        </div>
        <div class="detail-json-container">
            <pre class="mb-0">{{ details_obj|safe }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- Card 4: Related Logs -->
    {% if infra_logs or system_logs %}
    <div class="glass-card p-4">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-link text-info me-2"></i>
            <h6 class="text-white mb-0 fw-bold">关联日志 (Related Logs)</h6>
        </div>

        {% if infra_logs %}
        <div class="mb-4">
            <h6 class="text-info small mb-2"><i class="fas fa-database me-2"></i>数据层日志 ({{ infra_logs|length }})</h6>
            {% for log in infra_logs %}
            <div class="related-log-card">
                <div class="d-flex justify-content-between align-items-start">
                    <span class="font-monospace small text-white-50">{{ log.time }}</span>
                    <span class="badge bg-info">infra</span>
                </div>
                <div class="small text-white mt-1">{{ log.action }} → {{ log.target }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if system_logs %}
        <div>
            <h6 class="text-danger small mb-2"><i class="fas fa-exclamation-circle me-2"></i>系统日志 ({{ system_logs|length
                }})</h6>
            {% for log in system_logs %}
            <div class="related-log-card border-danger">
                <div class="d-flex justify-content-between align-items-start">
                    <span class="font-monospace small text-white-50">{{ log.time }}</span>
                    <span class="badge bg-danger">error</span>
                </div>
                <div class="small text-warning mt-1">{{ log.root_cause|default:log.action }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% endif %}
</div>

<style>
    .glass-card {
        background: rgba(30, 32, 40, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
    }

    .detail-field {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 12px 16px;
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .detail-label {
        display: block;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .detail-value {
        display: block;
        color: rgba(255, 255, 255, 0.9);
        word-break: break-all;
    }

    .detail-json-container pre {
        background: rgba(0, 0, 0, 0.2);
        padding: 16px;
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 400px;
    }

    .related-log-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
    }

    .related-log-card.border-danger {
        border-color: rgba(220, 53, 69, 0.3);
    }

    .god-mode-border {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 4px solid rgba(220, 53, 69, 0.6);
        pointer-events: none;
        z-index: 0;
        animation: pulse-border 2s infinite;
    }

    .god-mode-badge {
        position: fixed;
        top: 10px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.8rem;
        z-index: 9999;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.8);
    }

    @keyframes pulse-border {
        0% {
            border-color: rgba(220, 53, 69, 0.3);
        }

        50% {
            border-color: rgba(220, 53, 69, 0.8);
        }

        100% {
            border-color: rgba(220, 53, 69, 0.3);
        }
    }
</style>

<script>
    function showGodModeModal() {
        GlobalModal.showCustom({
            html: `
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger fw-bold"><i class="fa-solid fa-triangle-exclamation me-2"></i>身份核验 (Security Check)</h5>
            </div>
            <div class="modal-body pt-3">
                <p class="text-white-50 small mb-3">查看日志全部隐藏内容</p>
                <form id="godModeForm" action="{% url 'web_ui:audit_unlock' %}" method="POST">
                    {% csrf_token %}
                    {% security_inputs "btn_unlock_view" %}
                    <div class="d-flex justify-content-end gap-3 mt-4">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" onclick="GlobalModal.hide()">取消</button>
                        <button type="submit" class="btn btn-danger rounded-pill px-4 fw-bold"><i class="fa-solid fa-unlock me-2"></i>确认解锁</button>
                    </div>
                </form>
            </div>
        `,
            borderColor: '#dc3545',
            glowEffect: 'blink'
        });
    }
</script>
{% endblock %}