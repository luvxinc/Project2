{% extends "layouts/base.html" %}
{% load security_tags %}

{% block title %}清空日志 - 安全审计 - ERP系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/global-wizard.css">
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:audit_dashboard' %}"
                            class="text-info text-decoration-none">安全审计日志</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page">清空日志</li>
                </ol>
            </nav>
            <p class="text-white-50 small mb-0 mt-1">物理擦除指定日期范围内的审计日志。</p>
        </div>
        <div>
            <a href="{% url 'web_ui:audit_dashboard' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left me-1"></i>返回审计中心
            </a>
        </div>
    </div>

    <!-- High Risk Warning Banner -->
    <div class="alert alert-danger bg-danger bg-opacity-10 border-danger d-flex align-items-center mb-4 shadow-sm"
        style="border-radius: 12px;">
        <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-4">
            <i class="fas fa-biohazard fa-2x text-danger"></i>
        </div>
        <div>
            <h5 class="text-danger fw-bold mb-1">
                <i class="fas fa-exclamation-triangle me-2"></i>高危操作区域
            </h5>
            <p class="text-white-50 mb-0">
                此操作将物理删除审计日志。<strong class="text-success">Permanent</strong> 标记的记录和 <strong
                    class="text-success">Patched</strong> 的系统故障将被保留。
            </p>
        </div>
    </div>

    <!-- Wizard Container -->
    <div class="glass-card p-4" id="purge-wizard-container" data-testid="ops-guide-card">

        <!-- Wizard Header (GlobalWizard 锚点：步骤条将插入到此节点之后) -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-trash-can fa-2x text-danger"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1">清空日志向导</h5>
                    <p class="text-white-50 small mb-0">请按步骤安全地清理审计日志。</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar 锚点：GlobalWizard 会将步骤条注入到此 div 内 -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>


        <!-- Step 1: Date Range Input -->
        <!-- ========================================== -->
        <div class="wizard-step-content active" id="step-date-range" data-testid="step-date-range">
            <!-- 操作说明卡片 -->
            <div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4" data-testid="ops-guide-card">
                <div class="card-header bg-info bg-opacity-10 border-0 d-flex align-items-center">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <span class="text-info fw-bold">操作说明</span>
                </div>
                <div class="card-body">
                    <ul class="text-white-50 small mb-0 ps-3">
                        <li class="mb-2">选择要清空的日志类型和日期范围。</li>
                        <li class="mb-2">仅统计可清理的记录数量，不展示明细内容。</li>
                        <li class="mb-2">若验证结果显示"无数据"，执行按钮将自动置灰不可用。</li>
                        <li class="mb-2">清空操作本身将被永久记录，用于追溯（不包含敏感明细）。</li>
                        <li><strong class="text-success">Permanent</strong> 标记的记录和 <strong
                                class="text-success">Patched</strong> 的故障日志不会被删除。</li>
                    </ul>
                </div>
            </div>

            <form id="purge-form">
                {% csrf_token %}

                <!-- 日志类型选择 -->
                <div class="mb-4">
                    <label class="form-label text-white-50 small text-uppercase fw-bold">选择日志类型</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="log_types" value="business"
                                id="chk_biz" checked>
                            <label class="form-check-label text-white" for="chk_biz">业务操作</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="log_types" value="infra"
                                id="chk_infra">
                            <label class="form-check-label text-white" for="chk_infra">底层数据</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="log_types" value="system"
                                id="chk_sys">
                            <label class="form-check-label text-white" for="chk_sys">系统故障</label>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small text-uppercase fw-bold">开始日期</label>
                        <input type="date" name="start_date" id="start-date"
                            class="form-control bg-dark text-white border-secondary form-control-lg" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small text-uppercase fw-bold">结束日期</label>
                        <input type="date" name="end_date" id="end-date"
                            class="form-control bg-dark text-white border-secondary form-control-lg" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label text-white-50 small text-uppercase fw-bold">清空理由 (必填)</label>
                    <textarea name="reason" id="purge-reason" class="form-control bg-dark text-white border-secondary"
                        rows="2" placeholder="例如：合规要求 - 数据保留期满" required></textarea>
                </div>

                <!-- Hidden security inputs -->
                <div class="d-none">
                    {% security_inputs 'btn_purge_logs' %}
                </div>
            </form>

            <div id="step1-error" class="text-danger small text-center mb-3"></div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <a href="{% url 'web_ui:audit_dashboard' %}" class="btn btn-outline-secondary rounded-pill">
                        <i class="fas fa-times me-2"></i>取消
                    </a>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-primary rounded-pill px-4" id="btn-step1-next">
                        验证数据 <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 2: Verify Data -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-verify-data" data-testid="step-verify-data">
            <!-- Verify Metrics Card -->
            <div class="glass-card p-4 mb-4" data-testid="verify-metrics-card" id="verify-metrics-card"
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08);">

                <div id="verify-loading" class="text-center py-4">
                    <div class="spinner-border text-warning mb-3" role="status"></div>
                    <p class="text-white-50 mb-0">正在统计日志数量...</p>
                </div>

                <div id="verify-result" class="d-none">
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(255,193,7,0.1);">
                                <div class="text-warning fw-bold fs-3" id="business-count">0</div>
                                <div class="text-white-50 small">业务操作</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(13,202,240,0.1);">
                                <div class="text-info fw-bold fs-3" id="infra-count">0</div>
                                <div class="text-white-50 small">底层数据</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(220,53,69,0.1);">
                                <div class="text-danger fw-bold fs-3" id="total-count">0</div>
                                <div class="text-white-50 small">合计</div>
                            </div>
                        </div>
                    </div>
                    <p class="text-white-50 small text-center mt-3 mb-0" id="verify-message">
                        <i class="fas fa-info-circle me-1"></i>仅统计记录数量，不展示明细
                    </p>
                </div>

                <div id="verify-empty" class="d-none text-center py-4">
                    <i class="fas fa-inbox fa-3x text-secondary opacity-50 mb-3"></i>
                    <p class="text-white-50 mb-0">该时间区间内无可清理日志</p>
                </div>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step2-back">
                        <i class="fas fa-arrow-left me-2"></i>返回修改
                    </button>
                    <button type="button" class="btn btn-outline-warning rounded-pill" id="btn-re-verify">
                        <i class="fas fa-sync-alt me-2"></i>重新验证
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-danger rounded-pill px-4" id="btn-step2-next"
                        data-testid="primary-action-card" data-requires-global-modal="true"
                        data-action-key="btn_purge_logs" data-action-display="清空日志">
                        <i class="fas fa-radiation me-2"></i>确认清空日志
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 3: Execute Purge -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-execute-clean" data-testid="step-execute-clean">
            <!-- Execute Status Panel -->
            <div class="glass-card p-4" data-testid="result-panel" id="result-panel">
                <div data-testid="execute-status-panel" id="execute-status-panel">
                    <div id="execute-loading" class="text-center py-5 d-none">
                        <div class="spinner-border text-danger mb-3" role="status"></div>
                        <p class="text-white-50 mb-0">正在清空日志...</p>
                        <p class="text-muted small">请勿关闭页面</p>
                    </div>

                    <div id="execute-result"></div>
                </div>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-new-round">
                        <i class="fas fa-redo me-2"></i>开始新一轮清理
                    </button>
                    <a href="{% url 'web_ui:audit_dashboard' %}" class="btn btn-primary rounded-pill px-4">
                        <i class="fas fa-home me-2"></i>返回审计中心
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 权限检查
        if (!document.getElementById('purge-wizard-container')) return;

        // State
        let verifyData = { has_data: false };

        // Initialize Wizard
        const wizard = new GlobalWizard({
            containerId: 'purge-wizard-container',
            steps: [
                { id: 'date-range', label: '选择范围', contentSelector: '#step-date-range' },
                { id: 'verify', label: '验证数据', contentSelector: '#step-verify-data' },
                { id: 'execute', label: '完成清理', type: 'done', contentSelector: '#step-execute-clean' }
            ],
            onStepChange: function (from, to) {
                console.log('[PurgeWizard] Step changed:', from, '->', to);
                if (to === 1) {
                    // Entering Step 2: trigger verify
                    runVerify();
                }
            },
            onBeforeNext: async function (currentStep) {
                if (currentStep.id === 'date-range') {
                    return validateStep1();
                }
                if (currentStep.id === 'verify') {
                    if (!verifyData.has_data) {
                        createAndShowToast('无可清理日志，无需执行', 'warning');
                        return false;
                    }
                    // Trigger GlobalModal verification
                    return await triggerAuthAndExecute();
                }
                return true;
            },
            onRestart: function () {
                // Reset form
                document.getElementById('purge-form').reset();
                document.getElementById('step1-error').textContent = '';
                verifyData = { has_data: false };
            }
        });

        // Step 1: Validate
        function validateStep1() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const reason = document.getElementById('purge-reason').value.trim();
            const logTypes = document.querySelectorAll('input[name="log_types"]:checked');
            const errorEl = document.getElementById('step1-error');

            errorEl.textContent = '';

            if (logTypes.length === 0) {
                errorEl.textContent = '请选择至少一种日志类型';
                return false;
            }
            if (!startDate) {
                errorEl.textContent = '请选择开始日期';
                return false;
            }
            if (!endDate) {
                errorEl.textContent = '请选择结束日期';
                return false;
            }
            if (startDate > endDate) {
                errorEl.textContent = '开始日期不能晚于结束日期';
                return false;
            }
            if (!reason) {
                errorEl.textContent = '请填写清空理由';
                return false;
            }
            return true;
        }

        // Step 2: Run Verify
        function runVerify() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // Show loading
            document.getElementById('verify-loading').classList.remove('d-none');
            document.getElementById('verify-result').classList.add('d-none');
            document.getElementById('verify-empty').classList.add('d-none');
            document.getElementById('btn-step2-next').disabled = true;

            const formData = new FormData(document.getElementById('purge-form'));

            fetch('{% url "web_ui:purge_verify" %}', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('verify-loading').classList.add('d-none');

                    verifyData = data;

                    if (data.has_data) {
                        document.getElementById('verify-result').classList.remove('d-none');
                        document.getElementById('business-count').textContent = data.business_count;
                        document.getElementById('infra-count').textContent = data.infra_count;
                        document.getElementById('total-count').textContent = data.total;
                        document.getElementById('verify-message').innerHTML = '<i class="fas fa-info-circle me-1"></i>' + data.message;
                        document.getElementById('btn-step2-next').disabled = false;
                        document.getElementById('btn-step2-next').removeAttribute('aria-disabled');
                    } else {
                        document.getElementById('verify-empty').classList.remove('d-none');
                        document.getElementById('btn-step2-next').disabled = true;
                        document.getElementById('btn-step2-next').setAttribute('aria-disabled', 'true');
                    }
                })
                .catch(error => {
                    document.getElementById('verify-loading').classList.add('d-none');
                    document.getElementById('verify-empty').classList.remove('d-none');
                    console.error('Verify error:', error);
                    createAndShowToast('验证失败，请重试', 'danger');
                });
        }

        // Step 2 -> 3: Auth and Execute
        function triggerAuthAndExecute() {
            return new Promise((resolve) => {
                requestPasswordVerify(
                    'btn_purge_logs',
                    function (passwords) {
                        // Fill security inputs
                        for (const [slot, code] of Object.entries(passwords)) {
                            const input = document.querySelector(`input[name="sec_code_${slot}"]`);
                            if (input) input.value = code;
                        }
                        // Go to step 3 and execute
                        wizard.goToStep('execute');
                        executePurge();
                        resolve(false); // Don't auto-advance, we manually went to execute
                    },
                    document.getElementById('purge-form'),
                    '清空日志',
                    function () {
                        console.log('Purge cancelled');
                        resolve(false);
                    }
                );
            });
        }

        // Execute Purge (调用旧版 endpoint，参数不变)
        function executePurge() {
            const form = document.getElementById('purge-form');
            const formData = new FormData(form);

            document.getElementById('execute-loading').classList.remove('d-none');
            document.getElementById('execute-result').innerHTML = '';

            // POST to 旧版 endpoint (参数: log_types, start_date, end_date, reason + security)
            fetch('{% url "web_ui:audit_purge" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    // audit_purge returns redirect, so we check if it's a redirect or handle text
                    if (response.redirected) {
                        // Success - show success message
                        document.getElementById('execute-loading').classList.add('d-none');
                        document.getElementById('execute-result').innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                                <h5 class="text-white mb-2">清空完成</h5>
                                <p class="text-white-50 mb-0">安全审计日志已成功清空。</p>
                                <div class="mt-3 small text-white-50">
                                    <div>日志类型: ${getSelectedLogTypes()}</div>
                                    <div>日期范围: ${document.getElementById('start-date').value} ~ ${document.getElementById('end-date').value}</div>
                                    <div>清空数量: ${verifyData.total} 条</div>
                                    <div class="text-success mt-2"><i class="fas fa-shield-alt me-1"></i>审计记录已写入</div>
                                </div>
                            </div>
                        `;
                        createAndShowToast('日志清空完成', 'success');
                        return;
                    }
                    return response.text();
                })
                .then(html => {
                    if (!html) return; // Already handled redirect

                    document.getElementById('execute-loading').classList.add('d-none');

                    // Check if response contains success indicator
                    if (html && (html.includes('成功') || html.includes('Success'))) {
                        document.getElementById('execute-result').innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                                <h5 class="text-white mb-2">清空完成</h5>
                                <p class="text-white-50 mb-0">安全审计日志已成功清空。</p>
                                <div class="mt-3 small text-white-50">
                                    <div>日志类型: ${getSelectedLogTypes()}</div>
                                    <div>日期范围: ${document.getElementById('start-date').value} ~ ${document.getElementById('end-date').value}</div>
                                    <div>清空数量: ${verifyData.total} 条</div>
                                    <div class="text-success mt-2"><i class="fas fa-shield-alt me-1"></i>审计记录已写入</div>
                                </div>
                            </div>
                        `;
                        createAndShowToast('日志清空完成', 'success');
                    } else {
                        // Show error
                        document.getElementById('execute-result').innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-times-circle fa-4x text-danger mb-3"></i>
                                <h5 class="text-danger mb-2">执行失败</h5>
                                <div class="alert alert-danger mt-3">${html || '未知错误'}</div>
                            </div>
                        `;
                        createAndShowToast('清空失败，请查看详情', 'danger');
                    }
                })
                .catch(error => {
                    document.getElementById('execute-loading').classList.add('d-none');
                    document.getElementById('execute-result').innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-times-circle fa-4x text-danger mb-3"></i>
                            <h5 class="text-danger mb-2">执行失败</h5>
                            <p class="text-white-50">操作执行失败，请检查网络连接后重试。</p>
                        </div>
                    `;
                    console.error('Purge error:', error);
                    createAndShowToast('操作失败', 'danger');
                });
        }

        function getSelectedLogTypes() {
            const types = [];
            document.querySelectorAll('input[name="log_types"]:checked').forEach(cb => {
                if (cb.value === 'business') types.push('业务操作');
                if (cb.value === 'infra') types.push('底层数据');
                if (cb.value === 'system') types.push('系统故障');
            });
            return types.join('、') || '-';
        }

        // Button Bindings
        document.getElementById('btn-step1-next').addEventListener('click', () => wizard.next());
        document.getElementById('btn-step2-back').addEventListener('click', () => wizard.back());
        document.getElementById('btn-step2-next').addEventListener('click', () => wizard.next());
        document.getElementById('btn-re-verify').addEventListener('click', runVerify);
        document.getElementById('btn-new-round').addEventListener('click', () => wizard.restart());
    });
</script>
{% endblock %}