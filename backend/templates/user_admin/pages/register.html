{% extends "layouts/base.html" %}
{% load static security_tags %}

{% block title %}Register New User - System Admin - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:dashboard' %}"
                            class="text-info text-decoration-none" data-i18n="nav.system_admin">System Admin</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="user_admin.add_user">Register New User</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'web_ui:dashboard' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back">返回System Admin</span>
            </a>
        </div>
    </div>

    <!-- 向导容器 -->
    <div id="register-wizard-container" class="glass-card p-4 shadow-lg">
        <!-- Header (GlobalWizard 锚点：步骤条将插入到此节点之后) -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-user-plus fa-2x text-primary"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_52">Register New User向导</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_53">请按步骤填写新用户信息，确认后提交创建。</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar 锚点：GlobalWizard 会将步骤条注入到此 div 内 -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

        <!-- ========================================== -->
        <!-- Step 1: 填写信息 -->
        <!-- ========================================== -->
        <div id="register-step-input" class="wizard-step-content active">
            <form id="form-register-user" autocomplete="off" onkeydown="return event.key != 'Enter';">
                {% csrf_token %}
                <div id="policy-check-create-user" class="d-none">
                    {% security_inputs 'btn_create_user' %}
                </div>

                <!-- 用户名 -->
                <div class="mb-4">
                    <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t809" title="用于登录系统的唯一标识，不可重复">
                        用户名 <span class="text-danger">*</span> <i class="fas fa-info-circle ms-1"></i>
                    </label>
                    <input type="text" class="form-control bg-dark border-secondary text-white" name="username"
                        id="id_username" data-i18n-placeholder="form.placeholder.username_alphanumeric" placeholder="请输入用户名（英文字母或数字）" required pattern="^[a-zA-Z0-9_]+$" minlength="2"
                        maxlength="32">
                    <div class="form-text text-white-50 small" data-i18n="ui.text_2016">只允许英文字母、数字和下划线，长度2-32字符</div>
                </div>

                <!-- 密码 -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t5095" title="初始登录密码，建议使用强密码">
                            初始密码 <span class="text-danger">*</span> <i class="fas fa-info-circle ms-1"></i>
                        </label>
                        <input type="password" class="form-control bg-dark border-secondary text-white"
                            name="password_1" id="id_password_1" data-i18n-placeholder="form.placeholder.password_min5" placeholder="请输入密码（至少5位）" required minlength="5">
                        <div class="form-text text-white-50 small" data-i18n="ui.text_2017">至少5个字符</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small" data-bs-toggle="tooltip" data-i18n-title="tooltip.t6" title="请再次输入密码以确认">
                            确认密码 <span class="text-danger">*</span> <i class="fas fa-info-circle ms-1"></i>
                        </label>
                        <input type="password" class="form-control bg-dark border-secondary text-white"
                            name="password_2" id="id_password_2" data-i18n-placeholder="form.placeholder.password_confirm" placeholder="请再次输入密码" required minlength="5">
                    </div>
                </div>

                <!-- 角色说明（只读，固定为user） -->
                <div class="mb-4">
                    <label class="form-label text-white-50 small" data-i18n="ui.text_54">用户角色</label>
                    <div
                        class="alert alert-secondary bg-secondary bg-opacity-10 border-secondary border-opacity-25 mb-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user me-3 text-white-50 fa-lg"></i>
                            <div>
                                <div class="text-white fw-bold" data-i18n="ui.text_2018">普通用户 (Standard User)</div>
                                <div class="text-white-50 small" data-i18n="ui.text_2019">新用户默认为普通用户角色，仅可访问已授权的模块。如需提升权限，请在User List中操作。</div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="role" value="user">
                </div>
            </form>

            <!-- Step 1 Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-primary btn-lg px-5 shadow rounded-pill"
                        id="btn-wizard-next-1">
                        <i class="fas fa-arrow-right me-2"></i><span data-i18n="ui.icon_3018">下一步：验证数据</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 2: 验证数据 -->
        <!-- ========================================== -->
        <div id="register-step-confirm" class="wizard-step-content">
            <!-- 验证结果卡片 -->
            <div class="card mb-4" id="validation-card">
                <div class="card-header border-0" id="validation-card-header">
                    <i class="fa-solid fa-shield-halved me-2" id="validation-icon"></i>
                    <span id="validation-title" data-i18n="ui.text_55">请验证以下用户信息</span>
                </div>
                <div class="card-body" id="validation-card-body">
                    <!-- 数据摘要展示区 -->
                    <div id="user-summary-content" class="row g-3 text-white">
                        <!-- 动态填充 -->
                    </div>
                </div>
            </div>

            <!-- 错误列表（校验失败时显示） -->
            <div id="validation-errors-container" class="mb-4" style="display: none;">
                <div class="card bg-danger bg-opacity-10 border-danger">
                    <div class="card-header bg-danger bg-opacity-20 border-0">
                        <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                        <span class="text-danger fw-bold" data-i18n="ui.text_56">校验未通过</span>
                    </div>
                    <div class="card-body">
                        <ul id="validation-errors-list" class="mb-0 text-white">
                            <!-- 动态填充错误列表 -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Step 2 Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4 rounded-pill"
                        id="btn-wizard-back-2">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success btn-lg px-5 shadow rounded-pill"
                        id="btn-wizard-confirm" disabled>
                        <i class="fas fa-check-circle me-2"></i><span data-i18n="user_admin.confirm_create">确认创建</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 3: 完成状态页 -->
        <!-- ========================================== -->
        <div id="register-step-finish" class="wizard-step-content">
            <div class="card bg-dark border-opacity-50" id="finish-status-card">
                <div class="card-body py-5">
                    <div class="text-center mb-4" id="finish-status-header"></div>
                    <div id="finish-info-panel" class="mb-4"></div>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'web_ui:dashboard' %}"
                            class="btn btn-outline-secondary btn-lg px-4 rounded-pill">
                            <i class="fas fa-home me-2"></i><span data-i18n="ui.icon_3021">返回System Admin</span>
                        </a>
                        <button type="button" class="btn btn-primary btn-lg px-5 shadow rounded-pill"
                            id="btn-wizard-restart">
                            <i class="fas fa-rotate me-2"></i><span data-i18n="ui.icon_3022">开始新一轮</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Step2 验证卡片状态样式 */
    #validation-card {
        transition: all 0.3s ease;
    }

    /* 正常态 */
    #validation-card.state-normal {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(13, 202, 240, 0.25);
    }

    #validation-card.state-normal #validation-card-header {
        background: rgba(13, 202, 240, 0.1);
    }

    #validation-card.state-normal #validation-icon,
    #validation-card.state-normal #validation-title {
        color: var(--bs-info);
    }

    /* 校验中 */
    #validation-card.state-loading {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 193, 7, 0.5);
    }

    #validation-card.state-loading #validation-card-header {
        background: rgba(255, 193, 7, 0.1);
    }

    #validation-card.state-loading #validation-icon,
    #validation-card.state-loading #validation-title {
        color: var(--bs-warning);
    }

    /* 错误态 */
    #validation-card.state-error {
        background: rgba(220, 53, 69, 0.1);
        border: 2px solid var(--bs-danger);
        animation: errorPulse 1.5s ease-in-out infinite;
    }

    #validation-card.state-error #validation-card-header {
        background: rgba(220, 53, 69, 0.2);
    }

    #validation-card.state-error #validation-icon,
    #validation-card.state-error #validation-title {
        color: var(--bs-danger);
    }

    /* 通过态 */
    #validation-card.state-success {
        background: rgba(25, 135, 84, 0.1);
        border: 2px solid var(--bs-success);
    }

    #validation-card.state-success #validation-card-header {
        background: rgba(25, 135, 84, 0.2);
    }

    #validation-card.state-success #validation-icon,
    #validation-card.state-success #validation-title {
        color: var(--bs-success);
    }

    @keyframes errorPulse {

        0%,
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }

        50% {
            box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3);
        }
    }

    /* 按钮禁用态 */
    #btn-wizard-confirm:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        cursor: not-allowed;
        opacity: 0.65;
    }

    #btn-wizard-confirm:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    /* 向导按钮区域 */
    .wizard-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 2rem;
    }
</style>

<script>
    // ========================================
    // 全局状态变量
    // ========================================
    let registerWizard = null;
    let step2ValidationPassed = false;
    let lastCreatedUser = null;

    // ========================================
    // 初始化
    // ========================================
    document.addEventListener('DOMContentLoaded', function () {
        initRegisterWizard();

        // 初始化 Tooltip
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    });

    function initRegisterWizard() {
        if (registerWizard) return;

        // 使用 GlobalWizard 初始化，自动渲染步骤进度条
        registerWizard = new GlobalWizard({
            containerId: 'register-wizard-container',
            steps: [
                { id: 'input', label: (window.i18n?.t('js.fill_info') || 'Fill Information'), contentSelector: '#register-step-input' },
                { id: 'confirm', label: (window.i18n?.t('js.validate_data') || 'Validate'), contentSelector: '#register-step-confirm' },
                { id: 'finish', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#register-step-finish' }
            ],

            onStepChange: async (fromStep, toStep) => {
                console.log('[RegisterWizard] Step changed:', fromStep, '->', toStep);
                if (registerWizard.steps[toStep].id === 'confirm') {
                    const username = document.getElementById('id_username').value.trim();
                    const password1 = document.getElementById('id_password_1').value;
                    const password2 = document.getElementById('id_password_2').value;
                    renderUserSummary(username);
                    await runValidation(username, password1, password2);
                }
            },

            onBeforeNext: async (currentStep) => {
                console.log('[RegisterWizard] beforeNext step=', currentStep.id);
                try {
                    if (currentStep.id === 'input') {
                        // Step1 -> Step2: 只验证表单完整性
                        return validateStep1Form();
                    }
                    if (currentStep.id === 'confirm') {
                        // Step2 -> Step3: 不在这里触发，由"确认创建"按钮单独处理
                        // 这里只检查校验是否通过，不执行提交
                        if (!step2ValidationPassed) {
                            console.log('[RegisterWizard] Step2 validation not passed, blocking');
                            return false;
                        }
                        // 如果校验通过但用户直接调用next，阻止（必须点确认创建）
                        console.log('[RegisterWizard] Step2 validated, but submit via confirm button only');
                        return false;
                    }
                    return true;
                } catch (err) {
                    console.error('[RegisterWizard] beforeNext error', err);
                    return false;
                }
            },

            onComplete: () => console.log('[RegisterWizard] Wizard completed'),
            onRestart: () => resetRegisterForm()
        });

        bindWizardButtons();
    }

    function validateStep1Form() {
        const username = document.getElementById('id_username').value.trim();
        const password1 = document.getElementById('id_password_1').value;
        const password2 = document.getElementById('id_password_2').value;

        if (!username || !password1 || !password2) {
            showErrorNotice((window.i18n?.t('js.fill_all_required') || 'Fill all required fields'));
            return false;
        }
        return true;
    }

    function bindWizardButtons() {
        // ========================================
        // Step 1: 下一步按钮 -> wizard.next()
        // ========================================
        const btnNext1 = document.getElementById('btn-wizard-next-1');
        btnNext1?.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('[RegisterWizard] Next clicked');
            registerWizard.next();
        });

        // ========================================
        // Step 2: 返回按钮 -> wizard.back()
        // ========================================
        const btnBack2 = document.getElementById('btn-wizard-back-2');
        btnBack2?.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('[RegisterWizard] Back clicked');
            registerWizard.back();
        });

        // ========================================
        // Step 2: 确认创建按钮 -> Password Modal
        // ========================================
        const btnConfirm = document.getElementById('btn-wizard-confirm');
        btnConfirm?.addEventListener('click', handleConfirmClick);

        // ========================================
        // Step 3: 开始新一轮按钮 -> wizard.restart()
        // ========================================
        const btnRestart = document.getElementById('btn-wizard-restart');
        btnRestart?.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('[RegisterWizard] Restart clicked');
            resetRegisterForm();
            registerWizard.restart();
        });
    }

    function resetRegisterForm() {
        document.getElementById('form-register-user').reset();
        step2ValidationPassed = false;
        lastCreatedUser = null;

        // 重置验证卡片状态
        const card = document.getElementById('validation-card');
        card.className = 'card mb-4 state-normal';
        document.getElementById('validation-icon').className = 'fa-solid fa-shield-halved me-2';
        document.getElementById('validation-title').textContent = (window.i18n?.t('js.verify_user_info') || 'Please verify user information');

        // 隐藏错误列表
        document.getElementById('validation-errors-container').style.display = 'none';
        document.getElementById('validation-errors-list').innerHTML = '';

        // 禁用确认按钮
        document.getElementById('btn-wizard-confirm').disabled = true;

        // 清空摘要
        document.getElementById('user-summary-content').innerHTML = '';

        // 清空完成状态
        document.getElementById('finish-status-header').innerHTML = '';
        document.getElementById('finish-info-panel').innerHTML = '';
        const finishCard = document.getElementById('finish-status-card');
        finishCard.classList.remove('border-success', 'border-danger');
    }

    // ========================================
    // Step 3 跳转（供 doCreateUser 调用）
    // ========================================
    function goToStep3(isSuccess, message = '') {
        console.log('[RegisterWizard] goToStep3 called, success=', isSuccess, 'message=', message);

        // 先渲染内容（确保内容存在）
        renderFinishStatus(isSuccess, message);

        // 然后使用 GlobalWizard 跳转到 finish 步骤
        if (registerWizard) {
            registerWizard.goToStep(2);  // finish 是第3步（index=2）
            if (isSuccess) {
                registerWizard.setStepState('finish', 'completed');
            } else {
                registerWizard.setStepState('finish', 'failed');
            }
        }
    }

    // ========================================
    // submitUserWithAuth - 供 GlobalWizard.onBeforeNext 调用
    // ========================================
    async function submitUserWithAuth() {
        return new Promise((resolve) => {
            requestPasswordVerify(
                'btn_create_user',
                async () => {
                    // 验证通过后执行创建
                    const success = await doCreateUser();
                    resolve(success);
                },
                document.getElementById('form-register-user'),
                'Register New User',
                () => {
                    // 取消 - 阻止跳转
                    resolve(false);
                }
            );
        });
    }

    // ========================================
    // Step 2: 数据摘要展示
    // ========================================
    function renderUserSummary(username) {
        const container = document.getElementById('user-summary-content');
        container.innerHTML = `
            <div class="col-md-6">
                <div class="bg-black bg-opacity-25 p-3 rounded border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="user.username">用户名</div>
                    <div class="text-white fw-bold">${escapeHtml(username)}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="bg-black bg-opacity-25 p-3 rounded border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="ui.text_54">用户角色</div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">User</span>
                        <span class="text-white" data-i18n="user_admin.role_user">普通用户</span>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="bg-black bg-opacity-25 p-3 rounded border border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-1" data-i18n="modal.password.password">密码</div>
                    <div class="text-white">••••••••<span data-i18n="ui.already_filled">（已填写）</span></div>
                </div>
            </div>
        `;
    }

    // ========================================
    // Step 2: 验证逻辑
    // ========================================
    async function runValidation(username, password1, password2) {
        const card = document.getElementById('validation-card');
        const confirmBtn = document.getElementById('btn-wizard-confirm');
        const errorsContainer = document.getElementById('validation-errors-container');
        const errorsList = document.getElementById('validation-errors-list');
        const icon = document.getElementById('validation-icon');
        const title = document.getElementById('validation-title');

        // 重置状态
        step2ValidationPassed = false;
        confirmBtn.disabled = true;
        errorsContainer.style.display = 'none';
        errorsList.innerHTML = '';

        // 显示校验中状态
        card.className = 'card mb-4 state-loading';
        icon.className = 'fas fa-spinner fa-spin me-2';
        title.textContent = (window.i18n?.t('js.validating_ellipsis') || 'Validating...');

        let errors = [];

        // 1. 密码一致性验证
        if (password1 !== password2) {
            errors.push({
                error: (window.i18n?.t('js.password_mismatch') || 'Passwords do not match'),
                correct: (window.i18n?.t('js.ensure_password_match') || 'Ensure passwords match')
            });
        }

        // 2. 密码长度验证
        if (password1.length < 5) {
            errors.push({
                error: (window.i18n?.t('js.password_too_short') || 'Password too short'),
                correct: (window.i18n?.t('js.password_min_5') || 'Password min 5 chars')
            });
        }

        // 3. 用户名格式验证
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            errors.push({
                error: (window.i18n?.t('js.username_format_error') || 'Username format error'),
                correct: (window.i18n?.t('js.username_allowed_chars') || 'Username: letters, numbers, underscore')
            });
        }

        // 4. 用户名重名验证（后端查询）
        try {
            const response = await fetch(`/dashboard/user_admin/api/check-username/?username=${encodeURIComponent(username)}`);
            const data = await response.json();

            if (data.exists) {
                errors.push({
                    error: `用户名 "${username}" 已存在`,
                    correct: (window.i18n?.t('js.use_unique_username') || 'Use a unique username')
                });
            }
        } catch (e) {
            console.error('用户名检查失败:', e);
            errors.push({
                error: (window.i18n?.t('js.cannot_verify_username') || 'Cannot verify username'),
                correct: (window.i18n?.t('js.check_network_retry') || 'Check network and retry')
            });
        }

        // 渲染验证结果
        if (errors.length > 0) {
            // 校验失败
            card.className = 'card mb-4 state-error';
            icon.className = 'fas fa-times-circle me-2';
            title.textContent = (window.i18n?.t('js.validation_not_passed') || 'Validation Failed');

            // 显示错误列表
            errorsContainer.style.display = 'block';
            errorsList.innerHTML = errors.map(err => `
                <li class="mb-2">
                    <div class="text-danger fw-bold"><i class="fas fa-times me-1"></i>${escapeHtml(err.error)}</div>
                    <div class="text-white-50 small"><i class="fas fa-check me-1 text-success"></i>${escapeHtml(err.correct)}</div>
                </li>
            `).join('');

            confirmBtn.disabled = true;
            step2ValidationPassed = false;
        } else {
            // 校验通过
            card.className = 'card mb-4 state-success';
            icon.className = 'fas fa-check-circle me-2';
            title.textContent = (window.i18n?.t('js.data_validated') || 'Data Validated');

            errorsContainer.style.display = 'none';
            confirmBtn.disabled = false;
            step2ValidationPassed = true;
        }
    }

    // ========================================
    // Step 2: 确认按钮 -> Password Modal
    // ========================================
    function handleConfirmClick() {
        if (!step2ValidationPassed) {
            showErrorNotice((window.i18n?.t('js.complete_verification_first') || 'Complete verification first'));
            return;
        }

        // 调用全局 Password Modal
        requestPasswordVerify(
            'btn_create_user',           // actionKey (不显示给用户)
            async () => {
                // 验证通过后执行创建
                await doCreateUser();
            },
            document.getElementById('form-register-user'),   // contextEl
            'Register New User',                 // displayName (显示给用户)
            () => {
                // 取消回调 - 保留当前状态，不做任何操作
                console.log('[Register] Password verification cancelled');
            }
        );
    }

    // ========================================
    // 执行创建用户请求（使用纯JSON API）
    // ========================================
    async function doCreateUser() {
        console.log('[RegisterWizard] doCreateUser called');
        const username = document.getElementById('id_username').value.trim();
        const password = document.getElementById('id_password_1').value;

        // 收集表单数据
        const formData = new FormData(document.getElementById('form-register-user'));
        formData.set('password', password);  // 使用password_1作为密码

        try {
            // 使用纯JSON API
            const response = await fetch('/dashboard/user_admin/api/register/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            // 解析JSON响应
            let data;
            try {
                data = await response.json();
            } catch (parseError) {
                console.error('[RegisterWizard] JSON parse error:', parseError);
                // 解析失败时进行回退检查
                const actuallyCreated = await checkIfUserCreated(username);
                if (actuallyCreated) {
                    console.log('[RegisterWizard] User actually created despite parse error');
                    lastCreatedUser = { username: username, role: (window.i18n?.t('js.normal_user') || 'Normal User') };
                    goToStep3(true);
                } else {
                    goToStep3(false, (window.i18n?.t('js.server_error_retry') || 'Server error, retry later'));
                }
                return;
            }

            console.log('[RegisterWizard] API response:', data);

            if (data.success === true) {
                // 明确成功
                lastCreatedUser = {
                    username: data.username || username,
                    role: (window.i18n?.t('js.normal_user') || 'Normal User')
                };
                goToStep3(true);
            } else {
                // 明确失败
                const errorMsg = data.message || (window.i18n?.t('js.create_user_failed') || 'Create user failed');
                goToStep3(false, errorMsg);
            }

        } catch (networkError) {
            console.error('[RegisterWizard] Network error:', networkError);

            // 网络异常时进行回退检查：用户可能已经创建成功
            const actuallyCreated = await checkIfUserCreated(username);
            if (actuallyCreated) {
                console.log('[RegisterWizard] User actually created despite network error');
                lastCreatedUser = { username: username, role: (window.i18n?.t('js.normal_user') || 'Normal User') };
                goToStep3(true);
            } else {
                goToStep3(false, (window.i18n?.t('js.network_request_failed') || 'Network request failed'));
            }
        }
    }

    // ========================================
    // 回退检查：确认用户是否实际已创建
    // ========================================
    async function checkIfUserCreated(username) {
        try {
            const response = await fetch(`/dashboard/user_admin/api/check-username/?username=${encodeURIComponent(username)}`);
            const data = await response.json();
            return data.exists === true;
        } catch (e) {
            console.error('[RegisterWizard] Fallback check failed:', e);
            return false;  // 无法确认时假定未创建
        }
    }

    // ========================================
    // Step 3: 完成状态渲染
    // ========================================
    function renderFinishStatus(isSuccess, errorMessage = '') {
        const card = document.getElementById('finish-status-card');
        const header = document.getElementById('finish-status-header');
        const panel = document.getElementById('finish-info-panel');

        if (isSuccess) {
            card.classList.remove('border-danger');
            card.classList.add('border-success');

            header.innerHTML = `
                <div class="display-1 text-success mb-4"><i class="fa-solid fa-circle-check"></i></div>
                <h3 class="text-white mb-3" data-i18n="ui.text_58">用户创建成功</h3>
                <p class="text-muted mb-0" data-i18n="ui.text_59">新用户已成功注册并可立即登录系统</p>
            `;

            panel.innerHTML = `
                <div class="card bg-black bg-opacity-50 border-success border-opacity-25 mx-auto" style="max-width: 400px;">
                    <div class="card-header bg-success bg-opacity-10 border-0">
                        <i class="fa-solid fa-user me-2 text-success"></i>
                        <span class="text-success" data-i18n="ui.text_60">用户信息</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-4 text-white-50" data-i18n="user.username">用户名</div>
                            <div class="col-8 text-white fw-bold">${escapeHtml(lastCreatedUser?.username || '')}</div>
                            <div class="col-4 text-white-50" data-i18n="user.role">角色</div>
                            <div class="col-8"><span class="badge bg-secondary">User</span> <span data-i18n="user_admin.role_user">普通用户</span></div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            card.classList.remove('border-success');
            card.classList.add('border-danger');

            header.innerHTML = `
                <div class="display-1 text-danger mb-4"><i class="fa-solid fa-circle-xmark"></i></div>
                <h3 class="text-white mb-3" data-i18n="ui.text_61">用户创建失败</h3>
                <p class="text-muted mb-0" data-i18n="ui.text_62">请检查错误信息后重试</p>
            `;

            panel.innerHTML = `
                <div class="card bg-black bg-opacity-50 border-danger border-opacity-25 mx-auto" style="max-width: 500px;">
                    <div class="card-header bg-danger bg-opacity-10 border-0">
                        <i class="fa-solid fa-triangle-exclamation me-2 text-danger"></i>
                        <span class="text-danger" data-i18n="ui.text_63">错误信息</span>
                    </div>
                    <div class="card-body"><p class="text-white mb-0">${escapeHtml(errorMessage)}</p></div>
                </div>
            `;
        }
    }

    // restartWizard 已被 resetRegisterForm + registerWizard.restart() 替代

    // ========================================
    // 工具函数
    // ========================================
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
</script>
{% endblock %}