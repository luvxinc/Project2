{% extends "layouts/base.html" %}
{% load static security_tags %}

{% block title %}User List - System Admin - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header (Container for OOB Swap) -->
    <div id="ua-page-header">
        {% include "user_admin/components/headers/header_users.html" %}
    </div>

    <!-- 主内容区 -->
    <div id="ua-content-area">
        {% include "user_admin/components/users/user_list_content.html" %}
    </div>
</div>

<!-- 复用原dashboard.html中的所有Modal（操作需要 - Add/Edit User） -->
{% comment %} {% include "user_admin/components/users/user_form_modal.html" %} {% endcomment %}

<!-- ========================================== -->
<!-- Templates for Global Modal Content         -->
<!-- ========================================== -->

<!-- Lock/Unlock User Template -->
<template id="tpl-lock-user">
    <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="lock-modal-title">
            <!-- Icon will be inserted here -->
            <span id="lock-title-text" data-i18n="user_admin.modal.lock_user">锁定用户</span>
        </h5>
    </div>
    <div class="modal-body pt-3">
        <p class="text-white-50 mb-4"><span data-i18n="ui.confirm_user_action">确认要对用户</span> <span id="lock-user-display" class="fw-bold text-white"></span> <span data-i18n="ui.execute">执行</span>
            <span id="lock-action-display" class="fw-bold text-warning"></span> <span data-i18n="ui.operation_question">操作？</span>
        </p>
        <form id="lockUserForm" hx-post="" hx-trigger="submit" hx-swap="outerHTML">
            {% csrf_token %}
            <input type="hidden" name="action" id="lock-action-input">
            <div class="mb-3">
                {% security_inputs 'btn_toggle_user_lock' %}
            </div>
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                    onclick="GlobalModal.hide()" data-i18n="common.cancel">取消</button>
                <button type="submit" class="btn btn-warning text-dark rounded-pill px-4 fw-bold"
                    onclick="GlobalModal.hide()">
                    <i class="fa-solid fa-check me-2"></i><span data-i18n="common.confirm">确认</span>
                </button>
            </div>
        </form>
    </div>
</template>

<!-- Delete User Template -->
<template id="tpl-delete-user">
    <div class="modal-header border-0 pb-0">
        <h5 class="modal-title text-danger fw-bold">
            <i class="fa-solid fa-triangle-exclamation me-2"></i><span data-i18n="user_admin.modal.delete_user">删除用户</span>
        </h5>
    </div>
    <div class="modal-body pt-3">
        <p class="text-white-50"><span data-i18n="ui.confirm_delete_user">确认要永久删除用户</span> <span id="delete-user-display" class="fw-bold text-white"></span>？</p>
        <div class="alert alert-danger bg-danger bg-opacity-10 border-danger text-danger small rounded-3 mb-4">
            <i class="fa-solid fa-circle-info me-2"></i><span data-i18n="ui.icon_3023">此操作不可逆。所有权限和关联日志将被归档。</span>
        </div>
        <form id="deleteUserForm" hx-post="" hx-trigger="submit" hx-swap="outerHTML">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label text-white-50 small" data-i18n="ui.text_64">删除原因 (必填)</label>
                <textarea name="reason" class="form-control bg-dark text-white border-secondary rounded-3" rows="2"
                    required data-i18n-placeholder="form.placeholder.delete_reason" placeholder="请输入删除原因..."></textarea>
            </div>
            <div class="mb-3">
                {% security_inputs 'btn_delete_user' %}
            </div>
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                    onclick="GlobalModal.hide()" data-i18n="common.cancel">取消</button>
                <button type="submit" class="btn btn-danger rounded-pill px-4 fw-bold" onclick="GlobalModal.hide()">
                    <i class="fa-solid fa-trash me-2"></i><span data-i18n="user_admin.btn_delete">永久删除</span>
                </button>
            </div>
        </form>
    </div>
</template>

<!-- Reset Password Template -->
<template id="tpl-reset-pwd">
    <div class="modal-header border-0 pb-0">
        <h5 class="modal-title text-info fw-bold">
            <i class="fa-solid fa-key me-2"></i><span data-i18n="user_admin.modal.reset_password">重置用户密码</span>
        </h5>
    </div>
    <div class="modal-body pt-3">
        <div class="alert alert-info bg-info bg-opacity-10 border-info text-info small rounded-3 mb-4">
            <i class="fa-solid fa-user me-2"></i><span data-i18n="ui.icon_3024">正在重置:</span><span id="reset-user-display" class="fw-bold"></span>
        </div>
        <form id="resetUserForm" hx-post="{% url 'web_ui:user_reset_pwd_api' %}" hx-trigger="submit" hx-swap="none">
            {% csrf_token %}
            <input type="hidden" name="username" id="reset-user-input">
            <div class="mb-3">
                <label class="form-label text-white-50 small" data-i18n="modal.change_password.new_password">新密码</label>
                <input type="password" name="new_password"
                    class="form-control bg-dark text-white border-secondary rounded-3" required minlength="5"
                    data-i18n-placeholder="form.placeholder.new_password_min5" placeholder="输入新密码 (至少5位)">
            </div>
            <div class="mb-3">
                <label class="form-label text-white-50 small" data-i18n="modal.change_password.confirm_password">确认新密码</label>
                <input type="password" name="confirm_password"
                    class="form-control bg-dark text-white border-secondary rounded-3" required minlength="5"
                    data-i18n-placeholder="form.placeholder.confirm_new_password" placeholder="再次输入新密码">
            </div>
            <div class="mb-3">
                {% security_inputs 'btn_reset_pwd' %}
            </div>
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                    onclick="GlobalModal.hide()" data-i18n="common.cancel">取消</button>
                <button type="submit" class="btn btn-info text-dark rounded-pill px-4 fw-bold"
                    onclick="GlobalModal.hide()">
                    <i class="fa-solid fa-check me-2"></i><span data-i18n="user_admin.confirm_reset">确认重置</span>
                </button>
            </div>
        </form>
    </div>
</template>

<!-- Change Role Template -->
<template id="tpl-change-role">
    <div class="modal-header border-0 pb-0">
        <h5 class="modal-title text-warning fw-bold">
            <i class="fa-solid fa-user-tag me-2"></i><span data-i18n="user_admin.modal.change_role">角色变更</span>
        </h5>
    </div>
    <div class="modal-body pt-3">
        <p class="text-white-50 mb-3"><span data-i18n="ui.confirm_user_action">确认要对用户</span> <span id="role-user-display" class="fw-bold text-white"></span> <span data-i18n="ui.role_change_question">进行角色变更？</span></p>
        <div
            class="text-center py-3 px-4 mb-4 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-25">
            <span class="text-warning fw-bold fs-5" id="role-action-display"></span>
        </div>
        <form id="changeRoleForm" hx-post="" hx-trigger="submit" hx-swap="outerHTML" hx-on::response-error="
                // Handle error locally to prevent global navigation
                GlobalModal.showError({
                    title: (window.i18n?.t('js.operation_failed') || 'Operation Failed'),
                    message: '无法变更角色：' + (event.detail.xhr.responseText || '权限不足或系统错误'),
                    onConfirmOverride: function() { GlobalModal.hide(); }
                });
                event.stopPropagation();
             ">
            {% csrf_token %}
            <input type="hidden" name="direction" id="role-direction-input">
            <div class="mb-3">
                {% security_inputs 'btn_change_user_role' %}
            </div>
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                    onclick="GlobalModal.hide()" data-i18n="common.cancel">取消</button>
                <button type="submit" class="btn btn-warning text-dark rounded-pill px-4 fw-bold"
                    onclick="GlobalModal.hide()">
                    <i class="fa-solid fa-arrows-rotate me-2"></i><span data-i18n="js.verify_changes">确认变更</span>
                </button>
            </div>
        </form>
    </div>
</template>

<!-- Self Reset Template -->
<template id="tpl-reset-self">
    <div class="modal-header border-0 pb-0">
        <h5 class="modal-title text-info fw-bold">
            <i class="fa-solid fa-key me-2"></i><span data-i18n="modal.change_password.title">修改我的密码</span>
        </h5>
    </div>
    <div class="modal-body pt-3">
        <form id="resetSelfForm" hx-post="{% url 'web_ui:user_reset_pwd_self' %}" hx-trigger="submit" hx-swap="none">
            {% csrf_token %}
            <input type="hidden" name="username" id="reset-self-user-input">
            <div class="mb-3">
                <label class="form-label text-muted small" data-i18n="modal.change_password.current_password">当前密码</label>
                <input type="password" name="old_password"
                    class="form-control bg-dark text-white border-secondary rounded-3" required data-i18n-placeholder="form.placeholder.current_password" placeholder="输入当前密码...">
            </div>
            <div class="mb-3">
                <label class="form-label text-muted small" data-i18n="modal.change_password.new_password">新密码</label>
                <input type="password" name="new_password"
                    class="form-control bg-dark text-white border-secondary rounded-3" required minlength="5"
                    data-i18n-placeholder="form.placeholder.new_password" placeholder="输入新密码 (至少5位)...">
            </div>
            <div class="mb-3">
                <label class="form-label text-muted small" data-i18n="modal.change_password.confirm_password">确认新密码</label>
                <input type="password" name="confirm_password"
                    class="form-control bg-dark text-white border-secondary rounded-3" required minlength="5"
                    data-i18n-placeholder="form.placeholder.confirm_password" placeholder="再次输入新密码...">
            </div>
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                    onclick="GlobalModal.hide()" data-i18n="common.cancel">取消</button>
                <button type="submit" class="btn btn-info text-dark rounded-pill px-4 fw-bold"
                    onclick="GlobalModal.hide()">
                    <i class="fa-solid fa-check me-2"></i><span data-i18n="modal.change_password.btn_confirm">确认修改</span>
                </button>
            </div>
        </form>
    </div>
</template>

<script>
    // ========================================
    // Users Page - Local Modal Integration Functions
    // ========================================

    // ========================================
    // 1. 密码验证文案映射（集中管理）
    // ========================================
    const UA_SECURITY_DESC_MAP = {
        'lock': (window.i18n?.t('js.lock_user_auth') || 'Lock user requires auth'),
        'unlock': (window.i18n?.t('js.unlock_user_auth') || 'Unlock user requires auth'),
        'promote': (window.i18n?.t('js.promote_user_auth') || 'Promote user requires auth'),
        'demote': (window.i18n?.t('js.demote_user_auth') || 'Demote user requires auth'),
        'delete': (window.i18n?.t('js.delete_user_auth') || 'Delete user requires auth'),
        'reset_pwd': (window.i18n?.t('js.reset_password_auth') || 'Reset password requires auth'),
        'reset_self': (window.i18n?.t('js.change_password_auth') || 'Change password requires auth'),
        'save_perms': (window.i18n?.t('js.save_perms_auth') || 'Save permissions requires auth')
    };

    // ========================================
    // 2. 操作受限 Modal（仅关闭，不回退）
    // ========================================
    function showActionBlockedModal(actionName, reason) {
        // 使用 GlobalModal.showCustom 构建单按钮 modal
        const html = `
            <div class="modal-header border-0">
                <h5 class="modal-title text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>${actionName} - 操作受限
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-ban fa-3x text-warning opacity-75"></i>
                </div>
                <p class="text-white mb-0">${reason}</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="GlobalModal.hide()">
                    <i class="fas fa-check me-2"></i>了解
                </button>
            </div>
        `;

        GlobalModal.showCustom({
            html: html,
            borderColor: '#ffc107',
            glowEffect: 'none'
        });
    }

    // ========================================
    // 3. 密码错误 Modal（单按钮："了解"=仅关闭modal，停留当前页）
    // ========================================
    function showPasswordErrorModal(errorMessage) {
        const html = `
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-times-circle me-2"></i>授权失败
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-shield-xmark fa-3x text-danger opacity-75"></i>
                </div>
                <p class="text-white mb-2" data-i18n="perms.password_failed">密码验证失败</p>
                <p class="text-white-50 small mb-0" data-i18n="ui.text_75">${errorMessage || (window.i18n?.t('js.check_password_retry') || 'Check password and retry')}</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary px-4" onclick="GlobalModal.hide()">
                    <i class="fas fa-check me-2"></i>了解
                </button>
            </div>
        `;

        GlobalModal.showCustom({
            html: html,
            borderColor: '#dc3545',
            glowEffect: 'blink'
        });
    }

    // ========================================
    // Helper: Load template content into GlobalModal
    // ========================================
    function loadTemplateToGlobalModal(templateId, config) {
        const tpl = document.getElementById(templateId);
        if (!tpl) {
            console.error('Template not found:', templateId);
            return null;
        }
        // Clone the content
        const content = tpl.content.cloneNode(true);
        const container = document.createElement('div');
        container.appendChild(content);

        // Show in Global Modal
        GlobalModal.showCustom({
            html: container.innerHTML,
            borderColor: config.borderColor || '#6c757d',
            glowEffect: config.glowEffect || 'none'
        });

        // Return the modal content DOM element for further modification
        return document.querySelector('#globalModal .modal-content');
    }

    // ========================================
    // 1. Reset Password (Others)
    // ========================================
    function setupResetModal(username) {
        const modalContent = loadTemplateToGlobalModal('tpl-reset-pwd', {
            borderColor: '#0dcaf0',
            glowEffect: 'none'
        });
        if (!modalContent) return;

        // Fill data
        modalContent.querySelector('#reset-user-display').innerText = username;
        modalContent.querySelector('#reset-user-input').value = username;

        // Initialize HTMX
        htmx.process(modalContent);
    }

    // ========================================
    // 2. Delete User
    // ========================================
    function setupDeleteModal(username) {
        const modalContent = loadTemplateToGlobalModal('tpl-delete-user', {
            borderColor: '#dc3545',
            glowEffect: 'blink' // Danger implies attention
        });
        if (!modalContent) return;

        modalContent.querySelector('#delete-user-display').innerText = username;

        const form = modalContent.querySelector('#deleteUserForm');
        form.setAttribute('hx-post', "/dashboard/user_admin/actions/delete_user/" + username + "/");
        form.setAttribute('hx-target', "#user_row_" + username);

        htmx.process(modalContent);
    }

    // ========================================
    // 3. Lock/Unlock User
    // ========================================
    function setupLockModal(btn) {
        const username = btn.dataset.username;
        const manageUrl = btn.dataset.manageUrl;
        const rowId = btn.dataset.rowId;
        const actionType = btn.dataset.actionType || "lock";

        const isUnlock = actionType === 'unlock';
        const color = isUnlock ? '#28a745' : '#dc3545'; // Green for unlock, Red for lock

        const modalContent = loadTemplateToGlobalModal('tpl-lock-user', {
            borderColor: color,
            glowEffect: 'marquee'
        });
        if (!modalContent) return;

        // Update UI
        modalContent.querySelector('#lock-user-display').innerText = username;
        const actionText = isUnlock ? (window.i18n?.t('js.unlock_btn') || 'Unlock') : (window.i18n?.t('js.lock_btn') || 'Lock');
        const actionSpan = modalContent.querySelector('#lock-action-display');
        actionSpan.innerText = actionText;
        actionSpan.className = isUnlock ? "fw-bold text-success" : "fw-bold text-danger";

        const titleEl = modalContent.querySelector('#lock-modal-title');
        titleEl.innerHTML = isUnlock ?
            '<i class="fa-solid fa-lock-open me-2 text-success"></i><span class="text-success" data-i18n="ui.text_76">解除锁定</span>' :
            '<i class="fa-solid fa-lock me-2 text-warning"></i><span class="text-warning" data-i18n="user_admin.modal.lock_user">锁定用户</span>';

        modalContent.querySelector('#lock-action-input').value = actionType;

        // Form attributes
        const form = modalContent.querySelector('#lockUserForm');
        form.setAttribute('hx-post', manageUrl);
        form.setAttribute('hx-target', "#" + rowId);

        htmx.process(modalContent);
    }

    // ========================================
    // 4. Change Role
    // ========================================
    function setupRoleModal(btn) {
        const username = btn.dataset.username;
        const url = btn.dataset.url;
        const rowId = btn.dataset.rowId;
        const direction = btn.dataset.direction;

        const modalContent = loadTemplateToGlobalModal('tpl-change-role', {
            borderColor: '#ffc107',
            glowEffect: 'marquee'
        });
        if (!modalContent) return;

        modalContent.querySelector('#role-user-display').innerText = username;
        const actionText = direction === "up" ? (window.i18n?.t('js.promote_to_admin') || 'Promote to Admin') : (window.i18n?.t('js.demote_to_user') || 'Demote to User');
        modalContent.querySelector('#role-action-display').innerText = actionText;
        modalContent.querySelector('#role-direction-input').value = direction;

        const form = modalContent.querySelector('#changeRoleForm');
        form.setAttribute('hx-post', url);
        form.setAttribute('hx-target', "#" + rowId);

        htmx.process(modalContent);
    }

    // ========================================
    // 5. Reset Self
    // ========================================
    function setupResetSelfModal(username) {
        const modalContent = loadTemplateToGlobalModal('tpl-reset-self', {
            borderColor: '#0dcaf0',
            glowEffect: 'none'
        });
        if (!modalContent) return;

        modalContent.querySelector('#reset-self-user-input').value = username;
        htmx.process(modalContent);
    }

    // ========================================
    // Event Listeners
    // ========================================

    // Refresh User List
    document.body.addEventListener("refreshUserList", function () {
        htmx.ajax('GET', '{% url "web_ui:panel_user_list" %}', {
            target: '#ua-content-area',
            swap: 'innerHTML'
        });
    });

    // Refresh User List on Permission Update (Toast Handling)
    document.body.addEventListener("showToast", function (evt) {
        if (evt.detail && evt.detail.value && evt.detail.value.indexOf((window.i18n?.t('js.perms_updated') || 'Permissions Updated')) !== -1) {
            setTimeout(function () {
                htmx.ajax('GET', '{% url "web_ui:panel_user_list" %}', {
                    target: '#ua-content-area',
                    swap: 'innerHTML'
                });
            }, 800);
        }

        // 捕获密码错误事件并显示错误 modal
        if (evt.detail && evt.detail.value) {
            const msg = evt.detail.value;
            if (msg.indexOf((window.i18n?.t('js.wrong_password') || 'Wrong Password')) !== -1 ||
                msg.indexOf((window.i18n?.t('js.auth_failed') || 'Auth Failed')) !== -1 ||
                msg.indexOf((window.i18n?.t('modal.password.verify_failed') || 'Verification Failed')) !== -1 ||
                msg.indexOf('Password incorrect') !== -1) {
                // 延迟显示，确保 toast 先关闭
                setTimeout(function () {
                    showPasswordErrorModal(msg);
                }, 300);
            }
        }
    });
</script>
{% endblock %}