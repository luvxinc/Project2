{% extends "layouts/base.html" %}
{% load security_tags %}

{% block title %}Data Cleanup - Database Admin - ERP System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/global-wizard.css">
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard/db_admin/"
                            class="text-info text-decoration-none" data-i18n="nav.db_admin">Database Admin</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="db_admin.clean">Data Cleanup</li>
                </ol>
            </nav>
            <p class="text-white-50 small mb-0 mt-1" data-i18n="ui.text_1670">物理擦除指定日期范围内的业务数据。</p>
        </div>
        <div>
            <a href="/dashboard/db_admin/" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="db_admin.back_to_hub">返回Database Admin</span>
            </a>
        </div>
    </div>

    <!-- High Risk Warning Banner -->
    <div class="alert alert-danger bg-danger bg-opacity-10 border-danger d-flex align-items-center mb-4 shadow-sm"
        style="border-radius: 12px;">
        <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-4">
            <i class="fas fa-biohazard fa-2x text-danger"></i>
        </div>
        <div>
            <h5 class="text-danger fw-bold mb-1">
                <i class="fas fa-exclamation-triangle me-2"></i><span data-i18n="ui.icon_3459">高危操作区域</span>
            </h5>
            <p class="text-white-50 mb-0">
                此操作将绕过所有软删除机制。删除的数据在没有备份的情况下<strong class="text-danger" data-i18n="ui.text_1671">无法恢复</strong>。
            </p>
        </div>
    </div>

    {% if is_superuser %}
    <!-- Wizard Container -->
    <div class="glass-card p-4" id="clean-wizard-container" data-testid="ops-guide-card">

        <!-- Wizard Header (GlobalWizard 锚点：步骤条将插入到此节点之后) -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-danger bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-broom fa-2x text-danger"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="db_admin.clean_wizard_title">Data Cleanup向导</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_1672">请按步骤安全地清理业务数据。</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar 锚点：GlobalWizard 会将步骤条注入到此 div 内 -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>


        <!-- Step 1: Date Range Input -->
        <!-- ========================================== -->
        <div class="wizard-step-content active" id="step-date-range" data-testid="step-date-range">
            <!-- 操作说明卡片 -->
            <div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4" data-testid="ops-guide-card">
                <div class="card-header bg-info bg-opacity-10 border-0 d-flex align-items-center">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <span class="text-info fw-bold" data-i18n="common.operation_desc">操作说明</span>
                </div>
                <div class="card-body">
                    <ul class="text-white-50 small mb-0 ps-3">
                        <li class="mb-2" data-i18n="ui.text_1674">建议先完成Data Backup，再执行清理。</li>
                        <li class="mb-2" data-i18n="ui.text_1675">仅清理所选日期范围内的记录数量，不展示明细内容。</li>
                        <li class="mb-2" data-i18n="ui.text_1676">若验证结果显示"无数据"，执行按钮将自动置灰不可用。</li>
                        <li class="mb-2" data-i18n="ui.text_1677">清理完成后会写入审计记录，用于追溯操作（不包含敏感明细）。</li>
                        <li data-i18n="ui.text_1678">如执行异常，请停止重复操作并联系管理员处理。</li>
                    </ul>
                </div>
            </div>

            <form id="clean-form">
                {% csrf_token %}
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small text-uppercase fw-bold" data-i18n="reports_gen.start_date">开始日期</label>
                        <input type="date" name="start_date" id="start-date"
                            class="form-control bg-dark text-white border-secondary form-control-lg" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small text-uppercase fw-bold" data-i18n="reports_gen.end_date">结束日期</label>
                        <input type="date" name="end_date" id="end-date"
                            class="form-control bg-dark text-white border-secondary form-control-lg" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label text-white-50 small text-uppercase fw-bold" data-i18n="ui.text_20">审计原因 (必填)</label>
                    <textarea name="reason" id="clean-reason" class="form-control bg-dark text-white border-secondary"
                        rows="2" data-i18n-placeholder="form.placeholder.generic_26" placeholder="例如：合规要求 - 数据保留期满" required></textarea>
                </div>

                <!-- Hidden security inputs -->
                <div class="d-none">
                    {% security_inputs 'btn_clean_data' %}
                </div>
            </form>

            <div id="step1-error" class="text-danger small text-center mb-3"></div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <a href="/dashboard/db_admin/backup/" class="btn btn-outline-success rounded-pill">
                        <i class="fas fa-shield-alt me-2"></i><span data-i18n="ui.icon_3460">先去备份</span>
                    </a>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-primary rounded-pill px-4" id="btn-step1-next">
                        验证数据 <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 2: Verify Data -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-verify-data" data-testid="step-verify-data">
            <!-- Verify Metrics Card -->
            <div class="glass-card p-4 mb-4" data-testid="verify-metrics-card" id="verify-metrics-card"
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08);">

                <div id="verify-loading" class="text-center py-4">
                    <div class="spinner-border text-warning mb-3" role="status"></div>
                    <p class="text-white-50 mb-0" data-i18n="common.loading">正在查询数据量...</p>
                </div>

                <div id="verify-result" class="d-none">
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(255,193,7,0.1);">
                                <div class="text-warning fw-bold fs-3" id="sales-count">0</div>
                                <div class="text-white-50 small" data-i18n="ui.text_242">销售数据</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(13,202,240,0.1);">
                                <div class="text-info fw-bold fs-3" id="inventory-count">0</div>
                                <div class="text-white-50 small" data-i18n="ui.text_2756">盘存数据</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 rounded-3" style="background: rgba(220,53,69,0.1);">
                                <div class="text-danger fw-bold fs-3" id="total-count">0</div>
                                <div class="text-white-50 small" data-i18n="ui.text_2757">合计</div>
                            </div>
                        </div>
                    </div>
                    <p class="text-white-50 small text-center mt-3 mb-0" id="verify-message">
                        <i class="fas fa-info-circle me-1"></i><span data-i18n="ui.icon_3461">仅统计记录数量，不展示明细</span>
                    </p>
                </div>

                <div id="verify-empty" class="d-none text-center py-4">
                    <i class="fas fa-inbox fa-3x text-secondary opacity-50 mb-3"></i>
                    <p class="text-white-50 mb-0" data-i18n="ui.text_1682">该时间区间内无可清理数据</p>
                </div>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step2-back">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_modify">返回修改</span>
                    </button>
                    <button type="button" class="btn btn-outline-warning rounded-pill" id="btn-re-verify">
                        <i class="fas fa-sync-alt me-2"></i><span data-i18n="ui.icon_3463">重新验证</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-danger rounded-pill px-4" id="btn-step2-next"
                        data-testid="primary-action-card" data-requires-global-modal="true"
                        data-action-key="btn_clean_data" data-action-display="Data Cleanup">
                        <i class="fas fa-radiation me-2"></i><span data-i18n="db_admin.execute_cleanup">执行清理</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 3: Execute Clean -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-execute-clean" data-testid="step-execute-clean">
            <!-- Execute Status Panel -->
            <div class="glass-card p-4" data-testid="result-panel" id="result-panel">
                <div data-testid="execute-status-panel" id="execute-status-panel">
                    <div id="execute-loading" class="text-center py-5 d-none">
                        <div class="spinner-border text-danger mb-3" role="status"></div>
                        <p class="text-white-50 mb-0" data-i18n="db_admin.executing_cleanup">正在执行Data Cleanup...</p>
                        <p class="text-muted small" data-i18n="ui.text_169">请勿关闭页面</p>
                    </div>

                    <div id="execute-result"></div>
                </div>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-new-round">
                        <i class="fas fa-redo me-2"></i><span data-i18n="ui.icon_3465">开始新一轮清理</span>
                    </button>
                    <a href="/dashboard/db_admin/" class="btn btn-primary rounded-pill px-4">
                        <i class="fas fa-home me-2"></i><span data-i18n="ui.icon_3466">返回Home</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Access Denied -->
    <div class="glass-card p-5 text-center" data-testid="ops-guide-card">
        <div class="wizard-step-content active" data-testid="step-date-range">
            <i class="fas fa-user-shield fa-4x text-secondary opacity-50 mb-4"></i>
            <h5 class="text-white-50 mb-2" data-i18n="api.forbidden">权限不足</h5>
            <p class="text-muted mb-0">
                Data Cleanup功能仅限<span class="text-warning" data-i18n="ui.text_1685">超级管理员</span>使用。
            </p>
        </div>
        <div class="d-none" data-testid="step-verify-data"></div>
        <div class="d-none" data-testid="step-execute-clean"></div>
        <div class="d-none" data-testid="verify-metrics-card"></div>
        <div class="d-none" data-testid="execute-status-panel"></div>
        <div class="d-none" data-testid="result-panel"></div>
        <div class="d-none" data-testid="primary-action-card"></div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 权限检查
        if (!document.getElementById('clean-wizard-container')) return;

        // State
        let verifyData = { has_data: false };

        // Initialize Wizard
        const wizard = new GlobalWizard({
            containerId: 'clean-wizard-container',
            steps: [
                { id: 'date-range', label: (window.i18n?.t('js.input_date') || 'Input Date'), contentSelector: '#step-date-range' },
                { id: 'verify', label: (window.i18n?.t('js.validate_data') || 'Validate'), contentSelector: '#step-verify-data' },
                { id: 'execute', label: (window.i18n?.t('js.cleanup_done') || 'Cleanup Done'), type: 'done', contentSelector: '#step-execute-clean' }
            ],
            onStepChange: function (from, to) {
                console.log('[CleanWizard] Step changed:', from, '->', to);
                if (to === 1) {
                    // Entering Step 2: trigger verify
                    runVerify();
                }
            },
            onBeforeNext: async function (currentStep) {
                if (currentStep.id === 'date-range') {
                    return validateStep1();
                }
                if (currentStep.id === 'verify') {
                    if (!verifyData.has_data) {
                        createAndShowToast((window.i18n?.t('js.no_data_to_clean') || 'No data to clean'), 'warning');
                        return false;
                    }
                    // Trigger GlobalModal verification
                    return await triggerAuthAndExecute();
                }
                return true;
            },
            onRestart: function () {
                // Reset form
                document.getElementById('clean-form').reset();
                document.getElementById('step1-error').textContent = '';
                verifyData = { has_data: false };
            }
        });

        // Step 1: Validate
        function validateStep1() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const reason = document.getElementById('clean-reason').value.trim();
            const errorEl = document.getElementById('step1-error');

            errorEl.textContent = '';

            if (!startDate) {
                errorEl.textContent = (window.i18n?.t('js.select_start_date') || 'Select Start Date');
                return false;
            }
            if (!endDate) {
                errorEl.textContent = (window.i18n?.t('js.select_end_date') || 'Select End Date');
                return false;
            }
            if (startDate > endDate) {
                errorEl.textContent = (window.i18n?.t('js.start_after_end') || 'Start cannot be after end');
                return false;
            }
            if (!reason) {
                errorEl.textContent = (window.i18n?.t('js.fill_audit_reason') || 'Fill audit reason');
                return false;
            }
            return true;
        }

        // Step 2: Run Verify
        function runVerify() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // Update label
            document.getElementById('verify-date-label').textContent = `日期范围: ${startDate} ~ ${endDate}`;

            // Show loading
            document.getElementById('verify-loading').classList.remove('d-none');
            document.getElementById('verify-result').classList.add('d-none');
            document.getElementById('verify-empty').classList.add('d-none');
            document.getElementById('btn-step2-next').disabled = true;

            const formData = new FormData();
            formData.append('start_date', startDate);
            formData.append('end_date', endDate);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('/dashboard/db_admin/action/clean_verify/', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('verify-loading').classList.add('d-none');

                    verifyData = data;

                    if (data.has_data) {
                        document.getElementById('verify-result').classList.remove('d-none');
                        document.getElementById('sales-count').textContent = data.sales_count;
                        document.getElementById('inventory-count').textContent = data.inventory_count;
                        document.getElementById('total-count').textContent = data.total;
                        document.getElementById('verify-message').innerHTML =
                            '<i class="fas fa-info-circle me-1"></i>' + data.message;
                        document.getElementById('btn-step2-next').disabled = false;
                    } else {
                        document.getElementById('verify-empty').classList.remove('d-none');
                        document.getElementById('btn-step2-next').disabled = true;
                        document.getElementById('btn-step2-next').setAttribute('aria-disabled', 'true');
                    }
                })
                .catch(error => {
                    document.getElementById('verify-loading').classList.add('d-none');
                    document.getElementById('verify-empty').classList.remove('d-none');
                    console.error('Verify error:', error);
                    createAndShowToast((window.i18n?.t('js.verify_failed_retry') || 'Verification failed, please retry'), 'danger');
                });
        }

        // Step 2 -> 3: Auth and Execute
        function triggerAuthAndExecute() {
            return new Promise((resolve) => {
                requestPasswordVerify(
                    'btn_clean_data',
                    function (passwords) {
                        // Fill security inputs
                        for (const [slot, code] of Object.entries(passwords)) {
                            const input = document.querySelector(`input[name="sec_code_${slot}"]`);
                            if (input) input.value = code;
                        }
                        // Go to step 3 and execute
                        wizard.goToStep('execute');
                        executeClean();
                        resolve(false); // Don't auto-advance, we manually went to execute
                    },
                    document.getElementById('clean-form'),
                    'Data Cleanup',
                    function () {
                        console.log('Clean cancelled');
                        resolve(false);
                    }
                );
            });
        }

        // Execute Clean (旧版逻辑，参数不变)
        function executeClean() {
            const form = document.getElementById('clean-form');
            const formData = new FormData(form);

            document.getElementById('execute-loading').classList.remove('d-none');
            document.getElementById('execute-result').innerHTML = '';

            // POST to 旧版 endpoint (参数: start_date, end_date, reason + security)
            fetch('/dashboard/db_admin/action/clean_data/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.text())
                .then(html => {
                    document.getElementById('execute-loading').classList.add('d-none');
                    document.getElementById('execute-result').innerHTML = html;

                    if (html.includes('alert-success')) {
                        createAndShowToast((window.i18n?.t('js.data_cleanup_done') || 'Data Cleanup Done'), 'success');
                        document.getElementById('step3-icon').innerHTML =
                            '<i class="fas fa-check-circle fa-2x text-success"></i>';
                        document.getElementById('step3-title').textContent = (window.i18n?.t('js.cleanup_complete') || 'Cleanup Complete');
                        document.getElementById('step3-subtitle').textContent = (window.i18n?.t('js.data_cleaned_logged') || 'Data cleaned and logged');
                    } else {
                        createAndShowToast((window.i18n?.t('js.cleanup_failed_details') || 'Cleanup failed, see details'), 'danger');
                        document.getElementById('step3-icon').innerHTML =
                            '<i class="fas fa-times-circle fa-2x text-danger"></i>';
                        document.getElementById('step3-title').textContent = (window.i18n?.t('js.execute_failed') || 'Execute Failed');
                        document.getElementById('step3-subtitle').textContent = (window.i18n?.t('js.see_error_below') || 'See error below');
                    }
                })
                .catch(error => {
                    document.getElementById('execute-loading').classList.add('d-none');
                    document.getElementById('execute-result').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    操作执行失败，请检查网络连接后重试。如问题持续，请联系管理员。
                </div>
            `;
                    console.error('Clean error:', error);
                    createAndShowToast((window.i18n?.t('js.operation_failed') || 'Operation Failed'), 'danger');
                });
        }

        // Button Bindings
        document.getElementById('btn-step1-next').addEventListener('click', () => wizard.next());
        document.getElementById('btn-step2-back').addEventListener('click', () => wizard.back());
        document.getElementById('btn-step2-next').addEventListener('click', () => wizard.next());
        document.getElementById('btn-re-verify').addEventListener('click', runVerify);
        document.getElementById('btn-new-round').addEventListener('click', () => wizard.restart());
    });
</script>
{% endblock %}