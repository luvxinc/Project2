{% extends "layouts/base.html" %}
{% load i18n %}
{% load security_tags %}

{% block title %}Data Restore - Database Admin - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard/db_admin/"
                            class="text-info text-decoration-none" data-i18n="nav.db_admin">Database Admin</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="db_admin.restore">Data Restore</li>
                </ol>
            </nav>
            <p class="text-white-50 small mb-0 mt-1" data-i18n="ui.text_1725">从历史快照恢复数据库状态。</p>
        </div>
        <div>
            <a href="/dashboard/db_admin/" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="db_admin.back_to_hub">返回Database Admin</span>
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Operations Guide -->
        <div class="col-lg-5">
            <!-- Warning Card -->
            <div class="glass-card p-4 mb-4 border border-warning border-opacity-50" data-testid="ops-guide-card">
                <div class="mb-3">
                    <h6 class="text-warning fw-bold mb-1">
                        <i class="fas fa-triangle-exclamation text-warning me-2"></i><span data-i18n="common.operation_notes">操作须知</span>
                    </h6>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_1726">恢复操作风险提示</p>
                </div>
                <ul class="text-white-50 small mb-0 ps-3">
                    <li class="mb-2"><span class="text-warning fw-bold" data-i18n="ui.text_1727">此操作不可逆</span>，当前所有数据将被覆盖。</li>
                    <li class="mb-2" data-i18n="ui.text_1728">系统会在恢复前自动创建回滚备份点。</li>
                    <li class="mb-2" data-i18n="ui.text_1729">恢复期间请勿进行其他数据库操作。</li>
                    <li class="mb-2" data-i18n="ui.text_1700">建议在业务低峰期<span data-i18n="ui.execute">执行</span>恢复操作。</li>
                    <li data-i18n="ui.text_1731">恢复完成后请验证关键业务数据的完整性。</li>
                </ul>
            </div>

            <!-- Status Card -->
            <div class="glass-card p-4" data-testid="result-panel" id="result-panel">
                <div class="mb-3">
                    <h6 class="text-white fw-bold mb-0">
                        <i class="fas fa-circle-info text-info me-2"></i><span data-i18n="ui.icon_3475">当前状态</span>
                    </h6>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_1732">系统备份概览</p>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <div class="p-3 rounded-3 text-center" style="background: rgba(255,255,255,0.03);">
                            <div class="text-info fw-bold fs-4">{{ backups|length }}</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2761">可用快照</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 rounded-3 text-center" style="background: rgba(255,255,255,0.03);">
                            <div class="text-success fw-bold">
                                {% if backups %}正常{% else %}--{% endif %}
                            </div>
                            <div class="text-white-50 small" data-i18n="pages.system_status">系统状态</div>
                        </div>
                    </div>
                </div>

                <div id="restore-result" class="mt-3"></div>
            </div>
        </div>

        <!-- Right Column: Primary Action -->
        <div class="col-lg-7">
            <div class="glass-card p-4" data-testid="primary-action-card">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-warning bg-opacity-25 p-3 rounded-circle me-3">
                        <i class="fas fa-undo-alt fa-lg text-warning"></i>
                    </div>
                    <div>
                        <h5 class="text-warning mb-1 fw-bold" data-i18n="ui.text_1733">恢复数据库</h5>
                        <p class="text-white-50 small mb-0" data-i18n="ui.text_1734">选择快照并恢复到该时间点</p>
                    </div>
                </div>

                {% if backups %}
                <form id="restore-form">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="form-label text-white-50 small text-uppercase fw-bold" data-i18n="ui.text_1735">选择恢复点</label>
                        <select name="filename" id="restore-select"
                            class="form-select bg-dark text-white border-secondary form-select-lg">
                            {% for b in backups %}
                            <option value="{{ b.filename }}">{{ b.display }} ({{ b.size_kb }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Preview Card -->
                    <div class="mb-4 p-3 rounded-3"
                        style="background: rgba(255,193,7,0.08); border: 1px solid rgba(255,193,7,0.2);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-archive text-warning me-3 fa-lg"></i>
                            <div>
                                <div class="text-white fw-bold" id="selected-backup-display">
                                    {% if backups %}{{ backups.0.display }}{% endif %}
                                </div>
                                <div class="text-white-50 small" data-i18n="ui.text_2763">将恢复到此快照的状态</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden security inputs -->
                    <div class="d-none">
                        {% security_inputs 'btn_restore_db' %}
                    </div>

                    <div class="d-grid">
                        {% if perms.can_restore %}
                        <button type="button" class="btn btn-warning btn-lg rounded-pill text-dark fw-bold"
                            id="btn-restore" data-requires-global-modal="true" data-action-key="btn_restore_db"
                            data-action-display="{% trans 'Restore Database' %}">
                            <i class="fas fa-exclamation-triangle me-2"></i><span data-i18n="ui.icon_3476">确认恢复</span>
                        </button>
                        {% else %}
                        <div class="alert alert-dark border-secondary d-flex align-items-center mb-0">
                            <i class="fas fa-lock text-warning me-3"></i>
                            <span class="text-white-50" data-i18n="ui.text_1736">需要更高权限才能<span data-i18n="ui.execute">执行</span>恢复操作。</span>
                        </div>
                        {% endif %}
                    </div>
                </form>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-secondary opacity-25 mb-4"></i>
                    <h5 class="text-white-50 mb-2" data-i18n="ui.text_1737">无可用备份</h5>
                    <p class="text-muted small mb-3" data-i18n="ui.text_1738">请先创建备份后再使用恢复功能</p>
                    <a href="/dashboard/db_admin/backup/" class="btn btn-outline-primary rounded-pill">
                        <i class="fas fa-plus me-2"></i><span data-i18n="db_admin.backup_create_title">创建备份</span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Update preview when selection changes
        const select = document.getElementById('restore-select');
        const display = document.getElementById('selected-backup-display');

        if (select && display) {
            select.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                display.textContent = selectedOption.text;
            });
        }

        // Restore button handler
        const restoreBtn = document.getElementById('btn-restore');
        if (!restoreBtn) return;

        restoreBtn.addEventListener('click', function () {
            // Use GlobalModal for verification
            requestPasswordVerify(
                'btn_restore_db',
                function (passwords) {
                    fillSecurityInputs(passwords);
                    executeRestore();
                },
                document.getElementById('restore-form'),
                (window.i18n?.t('js.restore_database') || 'Restore Database'),
                function () {
                    console.log('Restore cancelled');
                }
            );
        });
    });

    function fillSecurityInputs(passwords) {
        for (const [slot, code] of Object.entries(passwords)) {
            const input = document.querySelector(`input[name="sec_code_${slot}"]`);
            if (input) input.value = code;
        }
    }

    function executeRestore() {
        const form = document.getElementById('restore-form');
        const formData = new FormData(form);
        const resultDiv = document.getElementById('restore-result');
        const btn = document.getElementById('btn-restore');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>恢复中...';

        fetch('/dashboard/db_admin/action/restore/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => response.text())
            .then(html => {
                resultDiv.innerHTML = html;
                if (html.includes('alert-success')) {
                    createAndShowToast((window.i18n?.t('js.db_restore_success') || 'Database Restore Success'), 'success');
                } else {
                    createAndShowToast((window.i18n?.t('js.restore_failed_details') || 'Restore failed, see details'), 'danger');
                }
            })
            .catch(error => {
                createAndShowToast((window.i18n?.t('js.operation_failed_retry') || 'Operation failed, retry'), 'danger');
                console.error('Restore error:', error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>确认恢复';
            });
    }
</script>
{% endblock %}