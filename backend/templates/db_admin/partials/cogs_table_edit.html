{% load security_tags %}

<!-- COGS Data Table with Editable Grid -->
<div class="fade-in">
    <div class="alert alert-info bg-opacity-10 border-info border-opacity-25 d-flex align-items-center mb-4">
        <i class="fas fa-info-circle text-info me-3"></i>
        <div>
            <strong data-i18n="ui.text_1739">操作说明：</strong> 直接编辑表格中的 Cost/Freight 数值，Cog 会自动计算。
            <span class="text-warning" data-i18n="ui.text_1755">Cost/Freight: 正数最多2位小数，Weight: 大于0的正整数。</span>
            完成编辑后点击「保存更改」按钮。
        </div>
    </div>

    {% if records %}
    <div class="table-responsive mb-4" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-dark table-hover align-middle" id="cogs-table">
            <thead class="sticky-top bg-dark">
                <tr>
                    <th class="text-white-50 text-nowrap" style="min-width: 250px;">SKU</th>
                    <th class="text-white-50">Category</th>
                    <th class="text-white-50">SubCategory</th>
                    <th class="text-white-50" style="width: 100px;">Type</th>
                    <th class="text-info" style="width: 100px;">Cost</th>
                    <th class="text-info" style="width: 100px;">Freight</th>
                    <th class="text-warning" style="width: 80px;">Weight</th>
                    <th class="text-success" style="width: 100px;">Cog (Auto)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in records %}
                <tr data-sku="{{ row.SKU }}">
                    <td class="font-monospace text-white text-nowrap">{{ row.SKU }}</td>
                    <td>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" name="category">
                            {% for cat in categories %}
                            <option value="{{ cat }}" {% if cat == row.Category %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary"
                            name="subcategory">
                            {% for sub in subcategories %}
                            <option value="{{ sub }}" {% if sub == row.SubCategory %}selected{% endif %}>{{ sub }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" name="type">
                            {% for t in types %}
                            <option value="{{ t }}" {% if t == row.Type %}selected{% endif %}>{{ t }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="number" step="0.01" min="0"
                            class="form-control form-control-sm bg-dark text-info border-secondary cost-input"
                            name="cost" value="{{ row.Cost|default_if_none:0 }}" onchange="updateCogRow(this)">
                    </td>
                    <td>
                        <input type="number" step="0.01" min="0"
                            class="form-control form-control-sm bg-dark text-info border-secondary freight-input"
                            name="freight" value="{{ row.Freight|default_if_none:0 }}" onchange="updateCogRow(this)">
                    </td>
                    <td>
                        <input type="number" step="1" min="1"
                            class="form-control form-control-sm bg-dark text-warning border-secondary weight-input"
                            name="weight" value="{{ row.Weight|default_if_none:0 }}">
                    </td>
                    <td class="cog-value text-success fw-bold">
                        {{ row.Cog|default_if_none:0|floatformat:2 }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Security Inputs & Submit -->
    <form id="cogs-update-form" hx-post="{% url request.resolver_match.namespace|add:':cogs_batch_update' %}"
        hx-target="#cogs-result">
        {% csrf_token %}
        <input type="hidden" name="cogs_data" id="cogs-data-field">

        <!-- Security Inputs (L3 Gate) -->
        <div class="alert alert-secondary bg-opacity-10 border-secondary border-opacity-25 mb-4">
            <div class="d-flex align-items-center mb-2">
                <i class="fas fa-key text-info me-2"></i>
                <span class="text-white-50 small" data-i18n="user_admin.security_verify">安全验证</span>
            </div>
            {% security_inputs "btn_batch_update_cogs" %}
        </div>

        <div class="d-flex gap-3">
            <button type="button" class="btn btn-success btn-lg" onclick="submitCogsUpdate()">
                <i class="fas fa-save me-2"></i><span data-i18n="ui.icon_3005">保存更改</span>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-redo me-2"></i><span data-i18n="db_admin.clean">重新加载</span>
            </button>
        </div>
    </form>

    <div id="cogs-result" class="mt-3"></div>

    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i><span data-i18n="ui.icon_3007">未找到产品数据。</span>
    </div>
    {% endif %}
</div>

<script>
    function updateCogRow(input) {
        const row = input.closest(tr);
        const cost = parseFloat(row.querySelector(".cost-input").value) || 0;
        const freight = parseFloat(row.querySelector(".freight-input").value) || 0;
        const cog = (cost + freight).toFixed(2);
        row.querySelector(".cog-value").textContent = cog;
    }

    function submitCogsUpdate() {
        const table = document.getElementById("cogs-table");
        const rows = table.querySelectorAll("tbody tr");
        const data = [];
        const errors = [];

        // 辅助函数: 检查是否为正数且最多2位小数
        function isValidDecimal(val) {
            if (val === "" || val === null) return false;
            const num = parseFloat(val);
            if (isNaN(num) || num < 0) return false;
            const parts = String(val).split(".");
            if (parts.length > 1 && parts[1].length > 2) return false;
            return true;
        }

        // 辅助函数: 检查是否为正整数 (> 0)
        function isPositiveInteger(val) {
            if (val === "" || val === null) return false;
            const num = parseInt(val, 10);
            return !isNaN(num) && num > 0 && String(num) === String(val).trim();
        }

        rows.forEach(row => {
            const sku = row.getAttribute("data-sku");
            const category = row.querySelector("select[name=category]").value;
            const subcategory = row.querySelector("select[name=subcategory]").value;
            const type = row.querySelector("select[name=type]").value;
            const costRaw = row.querySelector(".cost-input").value;
            const freightRaw = row.querySelector(".freight-input").value;
            const weightRaw = row.querySelector(".weight-input").value;

            // 验证
            if (!isValidDecimal(costRaw)) {
                errors.push(`SKU ${sku}: Cost 必须为正数，最多2位小数`);
            }
            if (!isValidDecimal(freightRaw)) {
                errors.push(`SKU ${sku}: Freight 必须为正数，最多2位小数`);
            }
            if (!isPositiveInteger(weightRaw)) {
                errors.push(`SKU ${sku}: Weight 必须为大于0的正整数`);
            }

            const cost = parseFloat(costRaw) || 0;
            const freight = parseFloat(freightRaw) || 0;
            const weight = parseInt(weightRaw) || 0;
            const cog = cost + freight;

            data.push({
                SKU: sku,
                Category: category,
                SubCategory: subcategory,
                Type: type,
                Cost: cost,
                Freight: freight,
                Weight: weight,
                Cog: cog
            });
        });

        // 有验证错误时用 alert 提示
        if (errors.length > 0) {
            alert(i18n.t('validation.data_validation_failed') + ":\n\n" + errors.join("\n"));
            return;
        }

        document.getElementById("cogs-data-field").value = JSON.stringify(data);
        htmx.trigger("#cogs-update-form", "submit");
    }
</script>