{% load security_tags %}

<!-- SKU Creation Form -->
<div class="fade-in">
    <div class="alert alert-info bg-opacity-10 border-info border-opacity-25 d-flex align-items-center mb-4">
        <i class="fas fa-info-circle text-info me-3"></i>
        <div>
            <strong data-i18n="ui.text_1739">操作说明：</strong> 填写新 SKU 的信息。SKU、Cost、Freight、Weight 为必填项。
            Initial_Qty 将作为最新月份的初始库存值。
        </div>
    </div>

    <div class="table-responsive mb-4">
        <table class="table table-dark table-hover align-middle" id="sku-create-table">
            <thead>
                <tr>
                    <th class="text-warning">SKU <span class="text-danger">*</span></th>
                    <th class="text-white-50">Category</th>
                    <th class="text-white-50">SubCategory</th>
                    <th class="text-white-50">Type</th>
                    <th class="text-info">Cost <span class="text-danger">*</span></th>
                    <th class="text-info">Freight <span class="text-danger">*</span></th>
                    <th class="text-warning">Weight <span class="text-danger">*</span></th>
                    <th class="text-success">Cog (Auto)</th>
                    <th class="text-primary">Initial Qty</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="sku-rows">
                <!-- Dynamic rows will be added here -->
            </tbody>
        </table>
    </div>

    <div class="mb-4">
        <button type="button" class="btn btn-outline-primary" onclick="addSkuRow()">
            <i class="fas fa-plus me-2"></i><span data-i18n="ui.icon_3001">添加一行</span>
        </button>
        <button type="button" class="btn btn-outline-secondary ms-2" onclick="addMultipleRows()">
            <i class="fas fa-layer-group me-2"></i><span data-i18n="ui.icon_3071">批量添加 (5行)</span>
        </button>
    </div>

    <!-- Security Inputs & Submit -->
    <form id="sku-create-form" hx-post="{% url request.resolver_match.namespace|add:':cogs_create_skus' %}"
        hx-target="#create-result"
        hx-on::after-request="this.querySelectorAll('input[type=password]').forEach(i => i.value = '')">
        {% csrf_token %}
        <input type="hidden" name="sku_data" id="sku-data-field">

        <!-- Security Inputs (L3 Gate) -->
        {% security_inputs "btn_create_skus" %}

        <div class="d-flex gap-3">
            <button type="button" class="btn btn-primary btn-lg" onclick="submitSkuCreate()">
                <i class="fas fa-plus-circle me-2"></i><span data-i18n="ui.icon_3480">创建 SKU</span>
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="clearAllRows()">
                <i class="fas fa-eraser me-2"></i><span data-i18n="ui.icon_3481">清空表格</span>
            </button>
        </div>
    </form>


    <div id="create-result" class="mt-3"></div>
</div>

<!-- Success Modal (moved to body via JS) -->
<div class="modal fade" id="skuSuccessModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-success border-4" id="success-modal-box">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-check-circle fa-5x text-success"></i>
                </div>
                <h4 class="text-success mb-3" data-i18n="ui.text_1740">创建成功！</h4>
                <p class="text-white mb-4" id="success-message" data-i18n="ui.text_1741">SKU 已成功创建。</p>
                <button type="button" class="btn btn-success btn-lg px-5" onclick="confirmSuccessAndReset()">
                    <i class="fas fa-check me-2"></i><span data-i18n="modal.btn.confirm">确定</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="skuErrorModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content glass-card border-danger border-4" id="error-modal-box">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-exclamation-triangle fa-5x text-danger"></i>
                </div>
                <h4 class="text-danger mb-3" id="error-title" data-i18n="modal.error.title">操作失败</h4>
                <div class="text-white mb-4 text-start" id="error-message-container">
                    <ul id="error-list" class="list-unstyled mb-0"></ul>
                </div>
                <button type="button" class="btn btn-danger btn-lg px-5" onclick="closeErrorModal()">
                    <i class="fas fa-times me-2"></i><span data-i18n="common.close">关闭</span>
                </button>
            </div>
        </div>
    </div>
</div>


<style>
    /* Success modal green glow animation */
    #success-modal-box {
        animation: pulseGlowGreen 1.5s ease-in-out infinite;
    }

    @keyframes pulseGlowGreen {

        0%,
        100% {
            box-shadow: 0 0 20px rgba(25, 135, 84, 0.4),
                0 0 40px rgba(25, 135, 84, 0.2);
        }

        50% {
            box-shadow: 0 0 30px rgba(25, 135, 84, 0.7),
                0 0 60px rgba(25, 135, 84, 0.4),
                0 0 90px rgba(25, 135, 84, 0.2);
        }
    }

    /* Error modal red flash animation */
    #error-modal-box {
        animation: pulseGlowRed 1s ease-in-out infinite;
    }

    @keyframes pulseGlowRed {

        0%,
        100% {
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.4),
                0 0 40px rgba(220, 53, 69, 0.2);
        }

        50% {
            box-shadow: 0 0 35px rgba(220, 53, 69, 0.8),
                0 0 70px rgba(220, 53, 69, 0.5),
                0 0 100px rgba(220, 53, 69, 0.3);
        }
    }
</style>

<script>
    // Category options from server
    const categoryOptions = JSON.parse('{{ categories_json|escapejs }}');
    const subcategoryOptions = JSON.parse('{{ subcategories_json|escapejs }}');
    const typeOptions = JSON.parse('{{ types_json|escapejs }}');

    // Existing SKUs for duplicate check (all uppercase for case-insensitive comparison)
    // 使用 let 以便成功创建后可以添加新 SKU
    let existingSkus = new Set(JSON.parse('{{ existing_skus_json|escapejs }}').map(s => s.toUpperCase()));

    // 待创建的 SKU 列表 (用于成功后更新 existingSkus)
    let pendingSkus = [];

    let rowCounter = 0;
    let successModal = null;
    let errorModal = null;

    // 立即初始化 Modal (因为此模板通过 HTMX 动态加载，DOMContentLoaded 已触发)
    (function initModals() {
        const successEl = document.getElementById('skuSuccessModal');
        const errorEl = document.getElementById('skuErrorModal');
        if (successEl) successModal = new bootstrap.Modal(successEl);
        if (errorEl) errorModal = new bootstrap.Modal(errorEl);
    })();


    function createSelectOptions(options, name) {
        let html = `<select class="form-select form-select-sm bg-dark text-white border-secondary" name="${name}">`;
        html += '<option value="">--</option>';
        if (options && Array.isArray(options)) {
            options.forEach(opt => {
                html += `<option value="${opt}">${opt}</option>`;
            });
        }
        html += '</select>';
        return html;
    }

    function addSkuRow() {
        rowCounter++;
        const tbody = document.getElementById('sku-rows');
        const tr = document.createElement('tr');
        tr.id = `sku-row-${rowCounter}`;
        tr.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm bg-dark text-warning border-secondary font-monospace"
                   name="sku" data-i18n-placeholder="form.placeholder.generic_31" placeholder=(window.i18n?.t('js.example_sku') || 'e.g. ABC-123') required>
        </td>
        <td>${createSelectOptions(categoryOptions, 'category')}</td>
        <td>${createSelectOptions(subcategoryOptions, 'subcategory')}</td>
        <td>${createSelectOptions(typeOptions, 'type')}</td>
        <td>
            <input type="number" step="0.01" min="0" class="form-control form-control-sm bg-dark text-info border-secondary cost-input"
                   name="cost" value="" data-i18n-placeholder="form.placeholder.generic_30" placeholder=(window.i18n?.t('js.required') || 'Required') onchange="updateNewSkuCog(this)" required>
        </td>
        <td>
            <input type="number" step="0.01" min="0" class="form-control form-control-sm bg-dark text-info border-secondary freight-input"
                   name="freight" value="" data-i18n-placeholder="form.placeholder.generic_29" placeholder=(window.i18n?.t('js.required') || 'Required') onchange="updateNewSkuCog(this)" required>
        </td>

        <td>
            <input type="number" step="1" min="1" class="form-control form-control-sm bg-dark text-warning border-secondary weight-input"
                   name="weight" value="" data-i18n-placeholder="form.placeholder.generic_28" placeholder=(window.i18n?.t('js.required') || 'Required') required>
        </td>
        <td class="cog-value text-success fw-bold">--</td>
        <td>
            <input type="number" min="0" class="form-control form-control-sm bg-dark text-primary border-secondary"
                   name="initial_qty" value="0">
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSkuRow(${rowCounter})">
                <i class="fas fa-times"></i>
            </button>
        </td>
    `;
        tbody.appendChild(tr);
    }

    function removeSkuRow(id) {
        const row = document.getElementById(`sku-row-${id}`);
        if (row) row.remove();
    }

    function addMultipleRows() {
        for (let i = 0; i < 5; i++) addSkuRow();
    }

    function clearAllRows() {
        document.getElementById('sku-rows').innerHTML = '';
        rowCounter = 0;
        addSkuRow(); // Add one empty row
    }

    function updateNewSkuCog(input) {
        const row = input.closest('tr');
        const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
        const freight = parseFloat(row.querySelector('.freight-input').value) || 0;
        const cog = (cost + freight).toFixed(2);
        row.querySelector('.cog-value').textContent = cog;
    }

    function showErrorModal(title, errors) {
        // Move modal to body if not already (fixes z-index issues with HTMX)
        const modal = document.getElementById('skuErrorModal');
        if (modal && modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }

        document.getElementById('error-title').textContent = title;

        // Build error list HTML
        const errorList = document.getElementById('error-list');
        if (errorList) {
            if (Array.isArray(errors)) {
                errorList.innerHTML = errors.map(e =>
                    `<li class="mb-2"><i class="fas fa-times-circle text-danger me-2"></i>${e}</li>`
                ).join('');
            } else {
                errorList.innerHTML = `<li><i class="fas fa-times-circle text-danger me-2"></i>${errors}</li>`;
            }
        }

        if (errorModal) {
            errorModal.show();
        } else {
            // Fallback if modal not initialized
            const msg = Array.isArray(errors) ? errors.join('\n') : errors;
            alert(title + '\n\n' + msg);
        }
    }

    function closeErrorModal() {
        if (errorModal) {
            errorModal.hide();
        }
        // 强制刷新页面，清空所有填入信息
        window.location.reload();
    }

    function showSuccessModal(message) {
        // Move modal to body if not already
        const modal = document.getElementById('skuSuccessModal');
        if (modal && modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }

        document.getElementById('success-message').textContent = message;
        if (successModal) {
            successModal.show();
        } else {
            // Fallback if modal not initialized
            alert(message);
            clearAllRows();
        }
    }

    function confirmSuccessAndReset() {
        if (successModal) successModal.hide();

        // 将刚创建的 SKU 添加到 existingSkus 以防止重复创建
        pendingSkus.forEach(sku => existingSkus.add(sku.toUpperCase()));
        pendingSkus = [];

        clearAllRows();
    }



    function submitSkuCreate() {
        const rows = document.querySelectorAll('#sku-rows tr');
        const data = [];
        const missingFields = [];
        const duplicateSkus = [];
        const newSkusInBatch = new Set();

        rows.forEach((row, index) => {
            const skuInput = row.querySelector('input[name="sku"]');
            if (!skuInput) return;

            const sku = skuInput.value.trim().toUpperCase();
            if (!sku) return; // Skip empty SKU rows

            const costInput = row.querySelector('.cost-input');
            const freightInput = row.querySelector('.freight-input');
            const weightInput = row.querySelector('.weight-input');
            const qtyInput = row.querySelector('input[name="initial_qty"]');

            const costRaw = costInput.value.trim();
            const freightRaw = freightInput.value.trim();
            const weightRaw = weightInput.value.trim();
            const qtyRaw = qtyInput.value.trim();

            const rowNum = index + 1;

            // 辅助函数: 检查是否为正数且最多2位小数
            function isValidDecimal(val) {
                if (val === '' || val === null) return false;
                const num = parseFloat(val);
                if (isNaN(num) || num < 0) return false;
                // 检查小数位数
                const parts = val.split('.');
                if (parts.length > 1 && parts[1].length > 2) return false;
                return true;
            }

            // 辅助函数: 检查是否为正整数 (> 0)
            function isPositiveInteger(val) {
                if (val === '' || val === null) return false;
                const num = parseInt(val, 10);
                return !isNaN(num) && num > 0 && String(num) === val;
            }

            // 辅助函数: 检查是否为非负整数 (>= 0)
            function isNonNegativeInteger(val) {
                if (val === '' || val === null) return { valid: false, isDefault: true };
                const num = parseInt(val, 10);
                return { valid: !isNaN(num) && num >= 0 && String(num) === val, isDefault: false };
            }

            // Cost 验证: 正数，最多2位小数
            if (!isValidDecimal(costRaw)) {
                missingFields.push(`第 ${rowNum} 行 (${sku}): Cost 必须为正数，最多2位小数`);
            }

            // Freight 验证: 正数，最多2位小数
            if (!isValidDecimal(freightRaw)) {
                missingFields.push(`第 ${rowNum} 行 (${sku}): Freight 必须为正数，最多2位小数`);
            }

            // Weight 验证: 大于0的正整数
            if (!isPositiveInteger(weightRaw)) {
                missingFields.push(`第 ${rowNum} 行 (${sku}): Weight 必须为大于0的正整数`);
            }

            // Initial Qty 验证: 大于等于0的整数 (可留空，默认0)
            const qtyCheck = isNonNegativeInteger(qtyRaw);
            if (!qtyCheck.isDefault && !qtyCheck.valid) {
                missingFields.push(`第 ${rowNum} 行 (${sku}): Initial Qty 必须为大于等于0的整数`);
            }

            // Duplicate check against existing SKUs
            if (existingSkus.has(sku)) {
                duplicateSkus.push(sku);
            }

            // Duplicate check within current batch
            if (newSkusInBatch.has(sku)) {
                duplicateSkus.push(`${sku} (批次内重复)`);
            }
            newSkusInBatch.add(sku);

            const cost = parseFloat(costRaw) || 0;
            const freight = parseFloat(freightRaw) || 0;
            const weight = parseInt(weightRaw, 10) || 0;
            const initial_qty = parseInt(qtyRaw, 10) || 0;

            const category = row.querySelector('select[name="category"]').value;
            const subcategory = row.querySelector('select[name="subcategory"]').value;
            const type = row.querySelector('select[name="type"]').value;
            const cog = cost + freight;

            data.push({
                SKU: sku,
                Category: category,
                SubCategory: subcategory,
                Type: type,
                Cost: cost,
                Freight: freight,
                Weight: weight,
                Cog: cog,
                Initial_Qty: initial_qty
            });
        });

        // Show error modal for missing fields
        if (missingFields.length > 0) {
            showErrorModal((window.i18n?.t('js.missing_required') || 'Missing required'), missingFields);
            return;
        }

        // Show error modal for duplicates
        if (duplicateSkus.length > 0) {
            showErrorModal('SKU 重复', duplicateSkus.map(s => `SKU "${s}" 已存在于数据库中`));
            return;
        }

        if (data.length === 0) {
            showErrorModal((window.i18n?.t('js.data_empty') || 'Data empty'), [(window.i18n?.t('js.add_at_least_one_sku') || 'Add at least one valid SKU')]);
            return;
        }


        document.getElementById('sku-data-field').value = JSON.stringify(data);

        // 保存待创建的 SKU 列表 (成功后添加到 existingSkus)
        pendingSkus = data.map(d => d.SKU);

        // Use HTMX to submit
        htmx.trigger('#sku-create-form', 'submit');

    }

    // Listen for HTMX response to show success/error modal
    document.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target.id === 'create-result') {
            const resultHtml = evt.detail.target.innerHTML;

            if (resultHtml.includes('alert-success')) {
                // Extract message from alert
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = resultHtml;
                const alertText = tempDiv.textContent.trim();
                showSuccessModal(alertText || (window.i18n?.t('js.sku_created') || 'SKU Created!'));
                // Clear the inline result
                evt.detail.target.innerHTML = '';
            } else if (resultHtml.includes('alert-danger') || resultHtml.includes('alert-warning')) {
                // Show error modal
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = resultHtml;
                const alertText = tempDiv.textContent.trim();
                showErrorModal((window.i18n?.t('js.create_failed') || 'Create Failed'), alertText || (window.i18n?.t('js.error_retry') || 'Error, retry'));
                evt.detail.target.innerHTML = '';
            }
        }
    });

    // Initialize with one empty row on load
    addSkuRow();
</script>