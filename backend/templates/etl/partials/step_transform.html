{% load i18n %}
{% load security_tags %}

<!-- æ“ä½œé¡»çŸ¥ -->
<div class="glass-card p-4 mb-4 border border-info border-opacity-25" data-testid="ops-note-transform">
    <div class="d-flex align-items-start">
        <div class="bg-info bg-opacity-25 p-2 rounded-circle me-3 flex-shrink-0">
            <i class="fas fa-info-circle fa-lg text-info"></i>
        </div>
        <div>
            <h6 class="text-info fw-bold mb-2" data-i18n="ui.text_274">æ“ä½œé¡»çŸ¥ - ç¡®è®¤å…¥åº“</h6>
            <div class="text-white-50 small">
                <p class="mb-2">
                    <strong data-i18n="ui.text_207">åŠŸèƒ½è¯´æ˜ï¼š</strong>
                    å°†æ¸…æ´—åçš„æ•°æ®å†™å…¥é”€å”®æ•°æ®åº“ï¼Œæ­¤æ“ä½œä¼šä¿®æ”¹æ•°æ®åº“è®°å½•ã€‚
                </p>
                <p class="mb-2">
                    <strong data-i18n="ui.text_276">å®‰å…¨éªŒè¯ï¼š</strong>
                    éœ€è¦é€šè¿‡å¯†ç éªŒè¯æ‰èƒ½<span data-i18n="ui.execute">æ‰§è¡Œ</span>å…¥åº“æ“ä½œï¼Œç¡®ä¿æ“ä½œå®‰å…¨å¯è¿½æº¯ã€‚
                </p>
                <p class="mb-0">
                    <strong data-i18n="ui.text_277">æ³¨æ„äº‹é¡¹ï¼š</strong>
                    å…¥åº“åæ•°æ®å°†ä¸ç°æœ‰æ•°æ®åˆå¹¶ï¼Œé‡å¤è®°å½•ä¼šè¢«è‡ªåŠ¨è¯†åˆ«å¤„ç†ã€‚
                </p>
            </div>
        </div>
    </div>
</div>

<!-- å…¥åº“ç¡®è®¤å¡ç‰‡ -->
<div class="glass-card p-4 border border-primary border-opacity-25" data-testid="transform-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h6 class="text-uppercase text-muted small fw-bold mb-0">
            <i class="fas fa-database text-primary me-2"></i>Step 5: ç¡®è®¤å…¥åº“
        </h6>
        <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill"
            hx-post="{% url 'web_ui:sales:transactions:cancel' %}" hx-target="#etl-tab-content"
            hx-confirm="{% trans 'Are you sure you want to cancel? All unsaved data will be lost.' %}" data-testid="btn-cancel">
            <i class="fa-solid fa-times me-1"></i><span data-i18n="common.cancel">å–æ¶ˆ</span>
        </button>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div class="text-center mb-4">
        <i class="fa-solid fa-database fa-3x text-primary mb-3"></i>
        <h5 class="text-white" data-i18n="ui.text_278">æ•°æ®å·²å‡†å¤‡å°±ç»ª</h5>
        <p class="text-muted" data-i18n="ui.text_279">è¯·ç¡®è®¤ä»¥ä¸‹ä¿¡æ¯æ— è¯¯åï¼Œç‚¹å‡»ã€Œç¡®è®¤å…¥åº“ã€æŒ‰é’®ã€‚</p>
    </div>

    <!-- Preview Stats -->
    <div class="row g-3 mb-4">
        <!-- Parse Stats -->
        <div class="col-md-6">
            <div class="card bg-black bg-opacity-50 border-info border-opacity-25 h-100">
                <div class="card-header bg-info bg-opacity-10 border-0">
                    <i class="fa-solid fa-wrench me-2 text-info"></i>
                    <span class="text-info" data-i18n="ui.text_243">ä¿®å¤ç»Ÿè®¡</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-around text-center">
                        <div>
                            <div class="text-danger fs-4 fw-bold">{{ parse_stats.error_count|default:0 }}</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2056">æœ‰è¯¯æ•°æ®</div>
                        </div>
                        <div>
                            <div class="text-warning fs-4 fw-bold">{{ parse_stats.auto_fixed|default:0 }}</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2057">è‡ªåŠ¨ä¿®å¤</div>
                        </div>
                        <div>
                            <div class="fs-4 fw-bold" style="color: #fd7e14;">{{ parse_stats.manual_fixed }}</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2058">äººå·¥ä¿®æ­£</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB Stats Before -->
        <div class="col-md-6">
            <div class="card bg-black bg-opacity-50 border-secondary border-opacity-25 h-100">
                <div class="card-header bg-secondary bg-opacity-10 border-0">
                    <i class="fa-solid fa-database me-2 text-secondary"></i>
                    <span class="text-secondary" data-i18n="ui.text_281">å½“å‰æ•°æ®åº“çŠ¶æ€</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-around text-center">
                        <div>
                            <div class="text-white fs-4 fw-bold">{{ db_stats_before.count|default:0 }}</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2073">ç°æœ‰è®°å½•</div>
                        </div>
                        <div>
                            <div class="text-white small">
                                {{ db_stats_before.min_date|default:'N/A' }}
                                <i class="fa-solid fa-arrow-right mx-1 text-info"></i>
                                {{ db_stats_before.max_date|default:'N/A' }}
                            </div>
                            <div class="text-white-50 small" data-i18n="ui.text_2063">æ•°æ®èŒƒå›´</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Form -->
    <form id="transform-form" hx-post="{% url 'web_ui:sales:transactions:confirm' %}" hx-target="#etl-tab-content"
        hx-indicator="#confirm-spinner" hx-timeout="300s" data-testid="transform-form">
        {% csrf_token %}

        <!-- Hidden Security Inputs (ä¾› GlobalModal å¡«å……) -->
        <div id="security-inputs-container" style="display: none;">
            {% security_inputs 'btn_run_transform' %}
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                hx-get="{% url 'web_ui:sales:transactions:tab_transaction' %}?stage=clean" hx-target="#etl-tab-content"
                data-testid="btn-back-clean">
                <i class="fa-solid fa-arrow-left me-2"></i><span data-i18n="ui.icon_3114">è¿”å›æ¸…æ´—</span>
            </button>

            <div class="d-flex align-items-center gap-3">
                <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
                <div id="confirm-spinner" class="htmx-indicator">
                    <div class="d-flex flex-column align-items-center" style="min-width: 300px;">
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                            <span id="progress-stage" class="text-success fw-bold">æ­£åœ¨å…¥åº“...</span>
                        </div>
                        <div class="progress w-100" style="height: 8px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-1">é¢„è®¡éœ€è¦ 1-3 åˆ†é’Ÿï¼Œè¯·å‹¿å…³é—­é¡µé¢</small>
                    </div>
                </div>


                <button type="button" class="btn btn-success btn-lg rounded-pill px-5" id="btn-confirm"
                    data-requires-global-modal="true" data-action-key="btn_run_transform" data-action-display="{% trans 'Confirm Receiving' %}"
                    data-testid="btn-confirm">
                    <i class="fa-solid fa-check me-2"></i><span data-i18n="js.confirm_receiving">ç¡®è®¤å…¥åº“</span>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    (function () {
        var confirmBtn = document.getElementById('btn-confirm');
        var form = document.getElementById('transform-form');
        var progressBar = document.getElementById('progress-bar');
        var progressStage = document.getElementById('progress-stage');
        var progressInterval = null;

        // Transformer çš„é˜¶æ®µå®šä¹‰ (åŸºäºåç«¯ transformer.py çš„ report è°ƒç”¨)
        var stages = [
            { pct: 5, msg: 'ğŸš€ å¯åŠ¨è½¬æ¢å¼•æ“...' },
            { pct: 15, msg: 'ğŸ§¹ æ‰§è¡Œæ•°å€¼æ¸…æ´—...' },
            { pct: 30, msg: 'ğŸ§  è®¡ç®—ä¸šåŠ¡è§„åˆ™...' },
            { pct: 50, msg: 'ğŸšš æå–éšæ€§ç‰©æµæˆæœ¬...' },
            { pct: 70, msg: 'ğŸ§® è®¢å•çº§è´¹ç”¨åˆ†æ‘Š...' },
            { pct: 90, msg: 'ğŸ’¾ å››ç»´å»é‡å¹¶åŒæ­¥...' },
            { pct: 95, msg: 'ğŸ“¦ åŒæ­¥ FIFO åº“å­˜...' },
            { pct: 100, msg: 'âœ… å®Œæˆ!' }
        ];
        var currentStageIndex = 0;

        function startProgress() {
            currentStageIndex = 0;
            if (progressBar) progressBar.style.width = '0%';
            if (progressStage) progressStage.textContent = stages[0].msg;

            // æ¯ 2 ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦ (æ¨¡æ‹Ÿåç«¯å¤„ç†)
            progressInterval = setInterval(function() {
                if (currentStageIndex < stages.length - 1) {
                    currentStageIndex++;
                    var stage = stages[currentStageIndex];
                    if (progressBar) progressBar.style.width = stage.pct + '%';
                    if (progressStage) progressStage.textContent = stage.msg;
                }
            }, 8000); // æ¯ 8 ç§’æ›´æ–°ä¸€ä¸ªé˜¶æ®µï¼Œæ€»å…±çº¦ 1 åˆ†é’Ÿ
        }

        function stopProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        if (confirmBtn && form) {
            confirmBtn.addEventListener('click', function () {
                requestPasswordVerify(
                    'btn_run_transform',
                    function (passwords) {
                        // å¡«å…… security inputs
                        for (var slot in passwords) {
                            var input = document.querySelector('input[name="sec_code_' + slot + '"]');
                            if (input) input.value = passwords[slot];
                        }
                        // å¯åŠ¨è¿›åº¦åŠ¨ç”»
                        startProgress();
                        // æäº¤è¡¨å•
                        htmx.trigger(form, 'submit');
                    },
                    form,
                    (window.i18n?.t('js.confirm_receiving') || 'Confirm Receiving'),
                    function () {
                        // å–æ¶ˆå›è°ƒï¼šåœç•™åœ¨å½“å‰é¡µé¢
                    }
                );
            });

            // HTMX å®Œæˆååœæ­¢è¿›åº¦åŠ¨ç”»
            form.addEventListener('htmx:afterRequest', function() {
                stopProgress();
            });
        }
    })();
</script>