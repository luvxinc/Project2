{% load i18n %}
{% load security_tags %}

{% if valid %}
<!-- Validation Passed -->
<div class="card bg-dark border-success border-opacity-25 mb-4">
    <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
        <div>
            <i class="fa-solid fa-check-circle me-2 text-success"></i>
            <span class="text-white" data-i18n="ui.text_218">校验通过</span>
            <span class="badge bg-success ms-2">{{ row_count }} 条有效数据</span>
        </div>
        {% if corrections_applied %}
        <div>
            <span class="badge bg-info">已修正 {{ corrections_applied }} 个 SKU</span>
            {% if skipped_count %}
            <span class="badge bg-warning text-dark ms-1">跳过 {{ skipped_count }} 个</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        <!-- Full Data Preview -->
        <p class="text-muted small mb-3">
            <i class="fa-solid fa-table me-1"></i>
            数据预览 (全部 {{ row_count }} 行，可滚动查看):
        </p>
        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm table-dark table-bordered table-hover mb-0">
                <thead class="sticky-top" style="background: #1a1a1a;">
                    <tr>
                        <th class="text-white-50" style="width: 50px;">#</th>
                        <th class="text-white-50">SKU</th>
                        <th class="text-white-50">Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in preview_rows %}
                    <tr>
                        <td class="text-muted">{{ forloop.counter }}</td>
                        <td><code>{{ row.SKU }}</code></td>
                        <td>{{ row.Quantity }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sync Form -->
<form hx-post="{% url 'web_ui:inventory:stocktake_etl:inv_sync' %}" hx-target="#inv-process-area"
    hx-indicator="#sync-spinner">
    {% csrf_token %}
    <input type="hidden" name="target_date" value="{{ target_date }}">
    <input type="hidden" name="session_key" value="{{ session_key }}">

    {% security_inputs 'btn_sync_inventory' %}

    <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
            <i class="fa-solid fa-calendar me-1"></i>
            目标日期列: <code>{{ target_date }}</code>
        </div>

        <div class="d-flex gap-3 align-items-center">
            <div id="sync-spinner" class="htmx-indicator">
                <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                <span class="text-success ms-2" data-i18n="ui.text_222">正在同步...</span>
            </div>

            <button type="button" class="btn btn-outline-secondary"
                hx-get="{% url 'web_ui:inventory:stocktake_etl:tab_inventory' %}" hx-target="#inv-process-area" data-i18n="common.cancel">
                取消
            </button>
            <button type="submit" class="btn btn-success px-4">
                <i class="fa-solid fa-database me-2"></i><span data-i18n="js.confirm_receiving">确认入库</span>
            </button>
        </div>
    </div>
</form>

<script>
    // Update progress indicator: 上传 complete, 校验 complete, 修正 complete
    (function () {
        const steps = document.querySelectorAll('.stage-step');
        const connectors = document.querySelectorAll('.stage-connector');

        // Mark 上传 (index 0), 校验 (index 1), 修正 (index 2) as completed
        if (steps.length >= 3) {
            steps[0].classList.remove('active');
            steps[0].classList.add('completed');
            steps[0].querySelector('.step-box').innerHTML = '<i class="fa-solid fa-check"></i>';

            steps[1].classList.remove('active');
            steps[1].classList.add('completed');
            steps[1].querySelector('.step-box').innerHTML = '<i class="fa-solid fa-check"></i>';

            steps[2].classList.remove('active');
            steps[2].classList.add('completed');
            steps[2].querySelector('.step-box').innerHTML = '<i class="fa-solid fa-check"></i>';
        }

        // Mark first 3 connectors as completed
        if (connectors.length >= 3) {
            connectors[0].classList.add('completed');
            connectors[1].classList.add('completed');
            connectors[2].classList.add('completed');
        }
    })();
</script>

{% elif error_type == 'sku' %}
<!-- SKU Validation Failed - One at a time correction -->
<div class="sku-error-container">
    <!-- Error Card with Glowing Border -->
    <div class="card bg-dark sku-error-card mb-4">
        <div class="card-header bg-danger bg-opacity-10 d-flex justify-content-between align-items-center">
            <div>
                <i class="fa-solid fa-exclamation-triangle me-2 text-danger"></i>
                <span class="text-white" data-i18n="ui.text_224">SKU 校验失败</span>
                <span class="badge bg-danger ms-2">{{ unknown_skus|length }} 个未知 SKU</span>
            </div>
            <div class="text-white-50">
                <span id="current-fix-index">1</span> / <span id="total-fix-count">{{ sku_corrections|length }}</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Warning Box: Add SKU in Data Center -->
            <div class="warning-box mb-4">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>
                <span>如需新增 SKU，请前往 <strong data-i18n="ui.text_226">数据修改中心</strong> 添加后再回来上传。</span>
            </div>

            <!-- SKU Correction Form -->
            <form id="sku-correction-form" hx-post="{% url 'web_ui:inventory:stocktake_etl:inv_apply_corrections' %}"
                hx-target="#inv-process-area" hx-indicator="#apply-spinner">
                {% csrf_token %}
                <input type="hidden" name="session_key" value="{{ session_key }}">
                <input type="hidden" name="target_date" value="{{ target_date }}">

                <!-- SKU Correction - One at a time -->
                <div class="sku-correction-wizard">
                    {% for item in sku_corrections %}
                    <div class="sku-correction-step {% if forloop.first %}active{% else %}d-none{% endif %}"
                        data-index="{{ forloop.counter }}" data-bad-sku="{{ item.bad_sku }}">

                        <p class="text-white mb-3">
                            <span class="text-muted" data-i18n="ui.text_227">错误的 SKU:</span>
                            <code class="text-danger fs-5 ms-2">{{ item.bad_sku }}</code>
                            <!-- Skip button (red X) -->
                            <button type="button" class="btn btn-sm btn-outline-danger ms-3 skip-sku-btn"
                                data-bad-sku="{{ item.bad_sku }}" data-i18n-title="tooltip.t3176" title="跳过此 SKU（上传时忽略或置为 0）">
                                <i class="fa-solid fa-xmark"></i><span data-i18n="ui.icon_3092">跳过</span>
                            </button>
                        </p>

                        <div class="mb-3">
                            <label class="form-label text-white-50" data-i18n="ui.text_228">选择正确的 SKU:</label>
                            <select class="form-select bg-dark text-white border-secondary sku-select"
                                data-bad-sku="{{ item.bad_sku }}" size="8" style="max-height: 240px; overflow-y: auto;">
                                <option value="" data-i18n="option.o8658">-- 请选择 --</option>
                                {% if item.suggestions %}
                                <optgroup label="Recommended Match" data-i18n-label="ui.recommended_match">
                                    {% for suggestion in item.suggestions %}
                                    <option value="{{ suggestion }}" class="text-info">{{ suggestion }}</option>
                                    {% endfor %}
                                </optgroup>
                                {% endif %}
                                <optgroup label="All SKU" data-i18n-label="ui.all_sku">
                                    {% for sku in all_skus %}
                                    <option value="{{ sku }}">{{ sku }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Hidden inputs to store corrections (populated by JS) -->
                    <div id="correction-data"></div>
                </div>
            </form>
        </div>
        <div class="card-footer bg-transparent border-0 d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary"
                hx-get="{% url 'web_ui:inventory:stocktake_etl:tab_inventory' %}" hx-target="#inv-process-area">
                <i class="fa-solid fa-arrow-left me-2"></i><span data-i18n="ui.icon_3093">取消并返回</span>
            </button>
            <div class="d-flex gap-2 align-items-center">
                <div id="apply-spinner" class="htmx-indicator">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <span class="text-success ms-2" data-i18n="ui.text_229">处理中...</span>
                </div>
                <button type="button" class="btn btn-outline-secondary" id="btn-prev-sku" disabled>
                    <i class="fa-solid fa-chevron-left me-1"></i><span data-i18n="ui.icon_3094">上一个</span>
                </button>
                <button type="button" class="btn btn-primary" id="btn-next-sku">
                    下一个<i class="fa-solid fa-chevron-right ms-1"></i>
                </button>
                <button type="button" class="btn btn-success d-none" id="btn-apply-all">
                    <i class="fa-solid fa-check me-2"></i><span data-i18n="ui.icon_3095">确定修复</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Update progress indicator: 上传 complete, 校验 complete, 修正 active
    (function () {
        const steps = document.querySelectorAll('.stage-step');
        const connectors = document.querySelectorAll('.stage-connector');

        if (steps.length >= 3) {
            // 上传 (index 0) - completed
            steps[0].classList.remove('active');
            steps[0].classList.add('completed');
            steps[0].querySelector('.step-box').innerHTML = '<i class="fa-solid fa-check"></i>';

            // 校验 (index 1) - completed
            steps[1].classList.remove('active');
            steps[1].classList.add('completed');
            steps[1].querySelector('.step-box').innerHTML = '<i class="fa-solid fa-check"></i>';

            // 修正 (index 2) - active (currently fixing)
            steps[2].classList.remove('completed');
            steps[2].classList.add('active');
            steps[2].querySelector('.step-box').innerHTML = '3';
        }

        // Mark first 2 connectors as completed
        if (connectors.length >= 2) {
            connectors[0].classList.add('completed');
            connectors[1].classList.add('completed');
        }
    })();
</script>

<style>
    .sku-error-card {
        border: 2px solid #dc3545;
        animation: pulseGlowRed 1.5s ease-in-out infinite;
    }

    @keyframes pulseGlowRed {

        0%,
        100% {
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.4),
                0 0 20px rgba(220, 53, 69, 0.2);
        }

        50% {
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.7),
                0 0 40px rgba(220, 53, 69, 0.4),
                0 0 60px rgba(220, 53, 69, 0.2);
        }
    }

    .warning-box {
        background: rgba(253, 126, 20, 0.15);
        border: 2px solid #fd7e14;
        border-radius: 8px;
        padding: 15px 20px;
        color: #fd7e14;
        animation: pulseGlowOrange 2s ease-in-out infinite;
    }

    @keyframes pulseGlowOrange {

        0%,
        100% {
            box-shadow: 0 0 8px rgba(253, 126, 20, 0.3),
                0 0 16px rgba(253, 126, 20, 0.15);
        }

        50% {
            box-shadow: 0 0 15px rgba(253, 126, 20, 0.6),
                0 0 30px rgba(253, 126, 20, 0.3),
                0 0 45px rgba(253, 126, 20, 0.15);
        }
    }

    .sku-select {
        width: 100%;
        max-width: 400px;
    }

    .sku-select option.text-info {
        color: #0dcaf0 !important;
        font-weight: bold;
    }

    .sku-select optgroup {
        color: #6c757d;
        font-style: italic;
    }

    .skip-sku-btn:hover {
        background: #dc3545;
        color: #fff;
    }
</style>

<script>
    (function () {
        const steps = document.querySelectorAll('.sku-correction-step');
        const totalCount = steps.length;
        const currentIndexEl = document.getElementById('current-fix-index');
        const btnPrev = document.getElementById('btn-prev-sku');
        const btnNext = document.getElementById('btn-next-sku');
        const btnApply = document.getElementById('btn-apply-all');
        const correctionData = document.getElementById('correction-data');

        let currentIndex = 0;
        const corrections = {}; // { badSku: newSku or 'SKIP' }

        function showStep(index) {
            steps.forEach((step, i) => {
                if (i === index) {
                    step.classList.remove('d-none');
                    step.classList.add('active');
                } else {
                    step.classList.add('d-none');
                    step.classList.remove('active');
                }
            });
            currentIndexEl.textContent = index + 1;

            // Update button states
            btnPrev.disabled = index === 0;

            if (index === totalCount - 1) {
                btnNext.classList.add('d-none');
                btnApply.classList.remove('d-none');
            } else {
                btnNext.classList.remove('d-none');
                btnApply.classList.add('d-none');
            }
        }

        function validateCurrentStep() {
            const currentStep = steps[currentIndex];
            const badSku = currentStep.dataset.badSku;
            return corrections[badSku] !== undefined;
        }

        // Handle select change
        document.querySelectorAll('.sku-select').forEach(select => {
            select.addEventListener('change', function () {
                const badSku = this.dataset.badSku;
                if (this.value) {
                    corrections[badSku] = this.value;
                } else {
                    delete corrections[badSku];
                }
            });
        });

        // Handle skip button
        document.querySelectorAll('.skip-sku-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const badSku = this.dataset.badSku;
                corrections[badSku] = 'SKIP';
                // Visual feedback
                this.classList.remove('btn-outline-danger');
                this.classList.add('btn-danger');
                this.innerHTML = '<i class="fa-solid fa-check"></i> ' + (window.i18n?.t('js.skipped') || 'Skipped');
                // Auto advance
                if (currentIndex < totalCount - 1) {
                    currentIndex++;
                    showStep(currentIndex);
                } else {
                    btnNext.classList.add('d-none');
                    btnApply.classList.remove('d-none');
                }
            });
        });

        btnNext.addEventListener('click', function () {
            if (!validateCurrentStep()) {
                alert('{% trans "请选择正确的 SKU 或点击跳过" %}');
                return;
            }
            if (currentIndex < totalCount - 1) {
                currentIndex++;
                showStep(currentIndex);
            }
        });

        btnPrev.addEventListener('click', function () {
            if (currentIndex > 0) {
                currentIndex--;
                showStep(currentIndex);
            }
        });

        btnApply.addEventListener('click', function () {
            if (!validateCurrentStep()) {
                alert('{% trans "请选择正确的 SKU 或点击跳过" %}');
                return;
            }
            // Store corrections in hidden inputs
            correctionData.innerHTML = '';
            for (const [badSku, newSku] of Object.entries(corrections)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'sku_correction_' + badSku;
                input.value = newSku;
                correctionData.appendChild(input);
            }
            // Submit the form via HTMX
            const form = document.getElementById('sku-correction-form');
            htmx.trigger(form, 'submit');
        });

        // Initialize
        showStep(0);
    })();
</script>

{% else %}
<!-- Other Validation Failed (format error) -->
<div class="card bg-dark border-danger border-opacity-25">
    <div class="card-header bg-danger bg-opacity-10">
        <i class="fa-solid fa-exclamation-triangle me-2 text-danger"></i>
        <span class="text-white" data-i18n="ui.text_230">校验失败</span>
    </div>
    <div class="card-body">
        <p class="text-danger">{{ error_message }}</p>

        <button type="button" class="btn btn-outline-secondary mt-3"
            hx-get="{% url 'web_ui:inventory:stocktake_etl:tab_inventory' %}" hx-target="#inv-process-area">
            <i class="fa-solid fa-arrow-left me-2"></i><span data-i18n="ui.icon_3096">返回重新上传</span>
        </button>
    </div>
</div>
{% endif %}