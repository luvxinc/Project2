<!-- ETL Processing Stage - 异步处理中 -->
<div class="text-center py-5">
    <!-- 进度动画 -->
    <div class="processing-animation mb-4">
        <div class="spinner-border text-info" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">处理中...</span>
        </div>
    </div>
    
    <h4 class="text-info mb-3" data-i18n="ui.processing">正在处理数据...</h4>
    <p class="text-muted mb-4">
        系统正在后台执行数据转换和 FIFO 同步，请稍候...<br>
        <small>此过程可能需要 1-2 分钟</small>
    </p>
    
    <!-- 进度条 -->
    <div class="progress mb-4" style="height: 8px; max-width: 400px; margin: 0 auto;">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
             role="progressbar" 
             style="width: 0%"
             id="etl-progress-bar"></div>
    </div>
    
    <p class="text-muted small" id="etl-status-text">正在初始化...</p>
</div>

<script>
(function() {
    const taskId = '{{ task_id }}';
    const statusUrl = '{% url "web_ui:sales:transactions:task_status" %}';
    let pollCount = 0;
    
    const progressBar = document.getElementById('etl-progress-bar');
    const statusText = document.getElementById('etl-status-text');
    
    // 轮询任务状态
    function pollStatus() {
        fetch(statusUrl + '?task_id=' + taskId)
            .then(r => r.json())
            .then(data => {
                pollCount++;
                
                if (data.status === 'done') {
                    // 任务完成
                    progressBar.style.width = '100%';
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                    statusText.textContent = '处理完成！正在加载结果...';
                    
                    // 使用 HTMX 重新加载 tab 内容
                    setTimeout(() => {
                        htmx.ajax('GET', '{% url "web_ui:sales:transactions:tab_transaction" %}', {target: '#etl-tab-content', swap: 'innerHTML'});
                    }, 500);
                    
                } else if (data.status === 'error') {
                    // 任务失败
                    progressBar.classList.remove('progress-bar-animated', 'bg-info');
                    progressBar.classList.add('bg-danger');
                    progressBar.style.width = '100%';
                    statusText.innerHTML = '<span class="text-danger">处理失败: ' + data.error + '</span>';
                    
                } else if (data.status === 'running') {
                    // 更新真实进度
                    const progress = data.progress || 0;
                    const stage = data.stage || '处理中...';
                    progressBar.style.width = progress + '%';
                    statusText.textContent = stage + ' (' + progress + '%)';
                    setTimeout(pollStatus, 2000);  // 每 2 秒轮询一次
                    
                } else {
                    // 未找到任务
                    statusText.textContent = '任务状态未知，请刷新页面';
                }
            })
            .catch(err => {
                statusText.innerHTML = '<span class="text-warning">网络错误，正在重试...</span>';
                setTimeout(pollStatus, 3000);
            });
    }
    
    // 开始轮询
    setTimeout(pollStatus, 1000);
})();
</script>

<style>
.processing-animation {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
</style>
