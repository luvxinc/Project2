{% extends "layouts/base.html" %}
{% load security_tags %}

{% block title %}数据上传 - Eaglestar ERP{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <p class="text-white-50 mb-0 small">
                上传交易数据和库存盘点文件，系统将自动处理并更新数据库。
            </p>
        </div>
        <div>
            <span class="badge bg-white bg-opacity-10 text-white border border-white border-opacity-25 backdrop-blur">
                <i class="fas fa-shield-alt me-1"></i> 安全模块
            </span>
        </div>
    </div>

    <!-- Module Hub Menu -->
    {% with hub_id="etl-hub" hub_items=hub_items module_icon="fas fa-cloud-arrow-up" module_title="数据上传" %}
    {% include "components/module_hub.html" %}
    {% endwith %}

    <!-- Content Area for Tab Pages (Initially Hidden) -->
    <div id="etl-content-area" style="display: none;">
        <div id="etl-tab-content"></div>
    </div>
</div>

<script>
    // Override enterTab for ETL Module (HTMX Loading)
    (function () {
        const originalEnterTab = window.enterTab;

        window.enterTab = function (tabId, tabName, tabIcon) {
            // 1. Hide Hub Grid
            const hubGrid = document.getElementById('etl-hub');
            if (hubGrid) hubGrid.style.display = 'none';

            // 2. Show Header & Populate Data
            const header = document.getElementById('hub-content-header');
            if (header) {
                header.style.display = 'block';
                const iconSpan = document.getElementById('hub-active-tab-icon-display');
                const nameSpan = document.getElementById('hub-active-tab-name-display');
                if (iconSpan) iconSpan.className = tabIcon + ' me-2 text-info';
                if (nameSpan) nameSpan.textContent = tabName;
            }

            // 3. Show ETL Content Area
            const etlContent = document.getElementById('etl-content-area');
            if (etlContent) etlContent.style.display = 'block';

            // 4. Load Tab Content via HTMX
            const targetDiv = document.getElementById('etl-tab-content');
            if (targetDiv) {
                let loadUrl = '';
                if (tabId === 'trans') {
                    loadUrl = '{% url "web_ui:etl:tab_transaction" %}';
                } else if (tabId === 'inv') {
                    loadUrl = '{% url "web_ui:etl:tab_inventory" %}';
                }

                if (loadUrl) {
                    targetDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="text-muted mt-3">加载中...</p></div>';
                    htmx.ajax('GET', loadUrl, { target: '#etl-tab-content', swap: 'innerHTML' });
                }
            }

            // 5. Show Back Button
            const backBtn = document.getElementById('hub-back-btn');
            if (backBtn) backBtn.style.display = 'block';

            // 6. Apply Body Class
            document.body.classList.add('tab-active');
        };

        // Override exitTab to handle ETL
        const originalExitTab = window.exitTab;
        window.exitTab = function () {
            // 1. Show Hub Grid
            const hubGrid = document.getElementById('etl-hub');
            if (hubGrid) {
                hubGrid.style.display = 'block';
                hubGrid.classList.add('fade-in');
            }

            // 2. Hide Header
            const header = document.getElementById('hub-content-header');
            if (header) header.style.display = 'none';

            // 3. Hide ETL Content
            const etlContent = document.getElementById('etl-content-area');
            if (etlContent) etlContent.style.display = 'none';

            // Also hide other module content if exists
            const dbContent = document.getElementById('dbTabsContent');
            if (dbContent) dbContent.style.display = 'none';
            const uaContent = document.getElementById('ua-content-area');
            if (uaContent) uaContent.style.display = 'none';
            const auditContent = document.getElementById('audit-content-area');
            if (auditContent) auditContent.style.display = 'none';

            // 4. Hide Back Button
            const backBtn = document.getElementById('hub-back-btn');
            if (backBtn) backBtn.style.display = 'none';

            // 5. Remove Body Class
            document.body.classList.remove('tab-active');

            // Clear hash
            history.pushState("", document.title, window.location.pathname + window.location.search);
        };
    })();

    // Auto-init: Hide content on load
    document.addEventListener("DOMContentLoaded", function () {
        const etlContent = document.getElementById('etl-content-area');
        if (etlContent) etlContent.style.display = 'none';
    });
</script>
{% endblock %}