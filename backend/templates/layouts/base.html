{% load static %}
<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Eaglestar ERP{% endblock %}</title>

    <link href="{% static 'vendor/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/loading-border.css' %}">
    <link rel="stylesheet" href="{% static 'css/global-modal.css' %}">
    <link rel="stylesheet" href="{% static 'css/global-wizard.css' %}">
    <link rel="stylesheet" href="{% static 'css/global-file-upload.css' %}">
    <link rel="stylesheet" href="{% static 'css/ui-toggle.css' %}">

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="{% static 'js/loading-border.js' %}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        /* --- 全局样式定义 --- */
        html,
        body {
            height: 100%;
            margin: 0;
            background: transparent !important;
            overflow-x: hidden;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* 背景视频层 */
        #bg-video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -100;
            overflow: hidden;
        }

        #bg-video {
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
        }

        #bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            z-index: -99;
            pointer-events: none;
        }

        /* 侧边栏 (Glass UI) */
        .sidebar {
            width: 260px;
            height: 100vh;
            background: rgba(15, 20, 30, 0.45) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(16px);
            z-index: 1000;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 侧边栏收起状态 */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* 主内容区 */
        .main-content {
            margin-left: 260px;
            padding: 30px;
            transition: margin-left 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 100vh;
        }

        /* 侧边栏收起时主内容全宽 */
        .sidebar.collapsed+.main-content,
        .main-content.expanded {
            margin-left: 0;
        }

        /* 侧边栏切换按钮 */
        .sidebar-toggle {
            position: fixed;
            top: 12px;
            left: 260px;
            z-index: 1001;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-toggle:hover {
            color: #0dcaf0;
        }

        /* 收起时按钮移动到左上角 */
        .sidebar-toggle.collapsed {
            left: 12px;
        }

        /* 导航项悬停高亮效果 */
        .nav-link {
            border: 1px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-link:hover:not(.active) {
            border-color: rgba(13, 202, 240, 0.5);
            background: rgba(13, 202, 240, 0.1);
            color: #fff !important;
        }

        .nav-link.active {
            border-color: rgba(13, 110, 253, 0.5);
        }

        /* 通用玻璃卡片 */
        .glass-card {
            background: rgba(30, 32, 40, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(4px);
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>

    {# [Page-Specific] 页面自定义样式 #}
    {% block extra_css %}{% endblock %}
</head>

<body class="text-white">

    <div id="bg-video-container">
        <video autoplay muted loop id="bg-video">
            <source src="{% static 'assets/background.mp4' %}" type="video/mp4">
        </video>
    </div>
    <div id="bg-overlay"></div>

    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        {% if messages %}
        {% for message in messages %}
        <div class="toast align-items-center text-white bg-{{ message.tags|default:'info' }} border-0 show mb-2"
            role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i
                        class="fa-solid {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-circle-xmark{% else %}fa-info-circle{% endif %} me-2"></i>
                    {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    {# 侧边栏切换按钮 #}
    <button id="sidebar-toggle" class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-angles-left" id="toggle-icon"></i>
    </button>

    <nav id="sidebar" class="sidebar fixed-top bottom-0 start-0 d-flex flex-column p-3">
        <div class="d-flex align-items-center justify-content-center mb-4 px-2 mt-2">
            <img src="{% static 'assets/logo.png' %}" alt="Logo" style="height: 40px; width: auto;">
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            {% for item in sidebar_menu %}
            <li class="nav-item mb-1">
                {% if item.has_access %}
                <a href="{{ item.url }}"
                    class="nav-link d-flex align-items-center py-3 px-3 {% if request.path == item.url %}active bg-primary bg-opacity-25 border-start border-3 border-primary text-white fw-bold{% else %}text-white-50{% endif %}">
                    <i class="fa-solid {{ item.icon }} fa-fw me-3"></i>
                    <span>{{ item.name }}</span>
                </a>
                {% else %}
                <a href="#" onclick="showNoPermissionModal('{{ item.name }}'); return false;"
                    class="nav-link d-flex align-items-center py-3 px-3 text-white-50 opacity-50"
                    style="cursor: not-allowed;">
                    <i class="fa-solid {{ item.icon }} fa-fw me-3"></i>
                    <span>{{ item.name }}</span>
                    <i class="fa-solid fa-lock ms-auto small text-danger"></i>
                </a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        <hr class="border-secondary opacity-25">

        <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle px-2"
                data-bs-toggle="dropdown">
                <div class="rounded-circle bg-primary bg-opacity-25 d-flex justify-content-center align-items-center me-2"
                    style="width: 36px; height: 36px; border: 1px solid rgba(255,255,255,0.1);">
                    <span class="fw-bold">{{ request.user.username|first|upper }}</span>
                </div>
                <div class="small">
                    <div class="fw-bold">{{ request.user.username }}</div>
                    <div class="{% if request.user.is_superuser %}text-warning{% elif request.user.is_staff %}text-info{% else %}text-white-50{% endif %}"
                        style="font-size: 0.75rem;">{{ current_user_role|default:'User' }}</div>
                </div>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#globalResetSelfModal">
                        <i class="fa-solid fa-key me-2 text-info"></i><span data-i18n="nav.change_password">修改密码</span>
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item text-danger" href="{% url 'web_ui:logout' %}"
                        data-i18n="nav.logout">退出登录</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        {# [Global] 全局状态栏 - 锁死在 base.html，不允许页面覆盖 #}
        {# [Global] 全局状态栏 - 100% Width Glass #}
        <div id="global-status-container"
            class="sticky-top d-flex justify-content-end align-items-center px-4 py-2 mb-4">
            <div id="global-status-bar" class="d-flex gap-4">
                <div class="status-item" id="status-sync" class="d-none">
                    <i class="fas fa-sync fa-spin status-syncing text-warning"></i>
                    <span data-i18n="status_bar.sync" class="ms-2 small">同步中</span>
                </div>
                <div class="status-item" id="status-network">
                    <i class="fas fa-wifi status-online text-success"></i>
                    <span data-i18n="status_bar.online" class="ms-2 small">在线</span>
                </div>
                <!-- Time -->
                <div class="status-item text-white-50 small" id="status-time">
                    <i class="fa-regular fa-clock me-2"></i>
                    <span>Loading...</span>
                </div>
                <!-- Language Switcher (Icon Only) -->
                <div class="status-item lang-switch" id="status-lang" role="button" aria-label="Switch Language">
                    <i class="fa-solid fa-globe fa-lg text-white hover-glow"></i>
                </div>
            </div>
        </div>

        <style>
            /* Global Status Bar Styles */
            #global-status-container {
                margin: -30px -30px 30px -30px;
                /* Negative margin to counteract main-content padding */
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                z-index: 1020;
            }

            .hover-glow:hover {
                color: #0dcaf0 !important;
                text-shadow: 0 0 8px rgba(13, 202, 240, 0.6);
                transform: scale(1.1);
                transition: all 0.2s ease;
            }
        </style>

        {% block content %}{% endblock %}
    </main>

    {# [Global] 修改自己密码 Modal #}
    {# [Global] 修改自己密码 Modal (Apple Style) #}
    <div class="modal fade" id="globalResetSelfModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-card border border-primary border-opacity-50 shadow-lg"
                style="backdrop-filter: blur(20px); background: rgba(30,32,40,0.75);">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white"><i class="fa-solid fa-key me-2 text-primary"></i><span
                            data-i18n="modal.change_password.title">修改我的密码</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="globalResetSelfForm" hx-post="{% url 'web_ui:user_reset_pwd_self' %}" hx-trigger="submit"
                        hx-swap="none">
                        {% csrf_token %}
                        <input type="hidden" name="username" value="{{ request.user.username }}">

                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold ls-1"
                                data-i18n="modal.change_password.current_password">当前密码</label>
                            <input type="password" name="old_password"
                                class="form-control bg-dark border-secondary text-white rounded-pill px-3" required
                                data-i18n-placeholder="modal.change_password.placeholder_current" placeholder="验证当前密码">
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold ls-1"
                                data-i18n="modal.change_password.new_password">新密码</label>
                            <input type="password" name="new_password"
                                class="form-control bg-dark border-secondary text-white rounded-pill px-3" required
                                minlength="5" data-i18n-placeholder="modal.change_password.placeholder_new"
                                placeholder="设置新密码 (至少5位)">
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold ls-1"
                                data-i18n="modal.change_password.confirm_password">确认新密码</label>
                            <input type="password" name="confirm_password"
                                class="form-control bg-dark border-secondary text-white rounded-pill px-3" required
                                minlength="5" data-i18n-placeholder="modal.change_password.placeholder_confirm"
                                placeholder="再次输入确认">
                        </div>

                        <div class="d-flex justify-content-center gap-3 mt-4">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                                data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                            <button type="submit" class="btn btn-primary rounded-pill px-5 shadow"
                                data-bs-dismiss="modal">
                                <i class="fas fa-check-circle me-2"></i><span
                                    data-i18n="modal.change_password.btn_confirm">确认修改</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# [New] Global Modal Container - HTMX Target #}
    <div class="modal fade" id="globalModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content glass-card border-0" id="global-modal-content">
                <div class="p-5 text-center text-white-50">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p data-i18n="common.loading">加载详情中...</p>
                </div>
            </div>
        </div>
    </div>

    {# [Global] 全局遮罩层 - 用于页面加载状态 #}
    <div id="global-overlay">
        <div class="overlay-content">
            <div class="spinner-border overlay-spinner text-primary" role="status"></div>
            <p data-i18n="common.loading">加载中...</p>
        </div>
    </div>

    {# [New] No Permission Modal - Red Glow Style #}
    <style>
        @keyframes border-glow-red {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(220, 53, 69, 0.5), 0 0 15px rgba(220, 53, 69, 0.3);
            }

            50% {
                box-shadow: 0 0 10px rgba(220, 53, 69, 0.8), 0 0 25px rgba(220, 53, 69, 0.5);
            }
        }

        #noPermissionModal .modal-content {
            border: 2px solid var(--bs-danger) !important;
            animation: border-glow-red 1.5s ease-in-out infinite;
        }
    </style>
    <div class="modal fade" id="noPermissionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content glass-card">
                <div class="modal-header border-bottom border-danger border-opacity-50">
                    <h5 class="modal-title text-danger"><i class="fa-solid fa-triangle-exclamation me-2"></i><span
                            data-i18n="modal.no_permission.title">访问被拒绝</span></h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fa-solid fa-ban fa-3x text-danger"></i>
                    </div>
                    <p class="text-white mb-1"><span data-i18n="modal.no_permission.message">您没有访问</span> <span
                            id="noPermModuleName" class="text-warning fw-bold"></span>
                        <span data-i18n="modal.no_permission.message_suffix">的权限</span>
                    </p>
                    <p class="text-white-50 small" data-i18n="modal.no_permission.contact_admin">请联系管理员申请开通此功能</p>
                </div>
                <div class="modal-footer border-top border-danger border-opacity-25 justify-content-center">
                    <button type="button" class="btn btn-danger px-4" onclick="noPermConfirm()">
                        <i class="fa-solid fa-check me-2"></i><span data-i18n="common.confirm">确认</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'vendor/bootstrap.bundle.min.js' %}"></script>
    {# [New] Table Resizer JS #}
    <script src="{% static 'js/table_resizer.js' %}"></script>
    {# [Global] i18n 国际化 #}
    <script src="{% static 'js/i18n.js' %}?v=3.2.3"></script>
    {# [Global] Modal 管理器 #}
    <script src="{% static 'js/global-modal.js' %}"></script>
    {# [New] Security Adapter #}
    <script src="{% static 'js/security-verify.js' %}"></script>
    {# [Global] 状态栏管理器 #}
    <script src="{% static 'js/global-status.js' %}"></script>
    {# [Global] 公有处理向导 #}
    <script src="{% static 'js/global-wizard.js' %}?v=WIZARD_ANCHOR_V2_20251222_1"></script>
    {# [Global] 公有文件上传组件 #}
    <script src="{% static 'js/global-file-upload.js' %}"></script>
    {# [Global] 公有文件查看器组件 #}
    <script src="{% static 'js/global_file_viewer.js' %}?v=2.1.3"></script>
    {# [Global] 公共汇率输入组件 #}
    <script src="{% static 'js/global-exchange-rate.js' %}?v=1.0.4"></script>

    {# [Page-Specific] 页面自定义脚本 #}
    {% block extra_js %}{% endblock %}

    <script>
        // [HTMX] 注入 CSRF Token
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });

        // [New] 显示无权限弹窗
        function showNoPermissionModal(moduleName) {
            document.getElementById('noPermModuleName').textContent = moduleName;
            var el = document.getElementById('noPermissionModal');
            var modal = bootstrap.Modal.getOrCreateInstance(el);
            modal.show();
        }

        // [New] 无权限确认 - 统一返回首页
        function noPermConfirm() {
            var modalEl = document.getElementById('noPermissionModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            // 统一返回系统首页
            window.location.href = '/dashboard/';
        }

        // [HTMX] 监听后端无权限触发器
        document.body.addEventListener('showNoAccessModal', function (evt) {
            var moduleName = evt.detail.value || evt.detail || (window.i18n?.t('js.this_feature') || 'This feature');
            showNoPermissionModal(moduleName);
        });

        // [Sidebar] 切换侧边栏折叠状态
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const toggleIcon = document.getElementById('toggle-icon');

            const isCollapsed = sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded', isCollapsed);
            toggleBtn.classList.toggle('collapsed', isCollapsed);

            // 切换图标方向
            if (isCollapsed) {
                toggleIcon.classList.remove('fa-angles-left');
                toggleIcon.classList.add('fa-angles-right');
            } else {
                toggleIcon.classList.remove('fa-angles-right');
                toggleIcon.classList.add('fa-angles-left');
            }

            // 保存状态到 localStorage
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }

        // [Sidebar] 页面加载时恢复侧边栏状态
        document.addEventListener('DOMContentLoaded', function () {
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleBtn = document.getElementById('sidebar-toggle');
                const toggleIcon = document.getElementById('toggle-icon');

                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                toggleBtn.classList.add('collapsed');
                toggleIcon.classList.remove('fa-angles-left');
                toggleIcon.classList.add('fa-angles-right');
            }
        });

        // [Toast] 初始化函数 (用于页面加载时和HTMX刷新后)
        function initToasts() {
            // 只初始化还没被显示过的 toast (避免重复显示)
            var toastElList = [].slice.call(document.querySelectorAll('.toast:not([data-bs-shown])'));
            toastElList.forEach(function (toastEl) {
                toastEl.setAttribute('data-bs-shown', 'true');
                var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
                toast.show();
                // Toast 隐藏后自动从 DOM 移除
                toastEl.addEventListener('hidden.bs.toast', function () {
                    toastEl.remove();
                });
            });
        }

        // [Toast] 页面加载时初始化 (针对 Django Messages)
        document.addEventListener("DOMContentLoaded", initToasts);

        // [Toast] HTMX 请求后初始化 (针对局部刷新带回的消息)
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            initToasts();
        });

        // [Security] 每次 HTMX 请求完成后清空所有密码输入框 (无论成功或失败)
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            document.querySelectorAll('.security-gate-zone input[type="password"]').forEach(function (input) {
                input.value = '';
            });
            // 同时清空 Modal 内的密码输入框
            document.querySelectorAll('.modal input[type="password"]').forEach(function (input) {
                input.value = '';
            });
        });

        // [Feature] 监听后端自定义事件 'showToast' (成功)
        document.body.addEventListener("showToast", function (evt) {
            const message = evt.detail.value;
            createAndShowToast(message, 'success');
            // 成功时: 关闭所有打开的 modal
            document.querySelectorAll('.modal.show').forEach(function (modal) {
                var bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            });
            // 清空所有密码输入框
            clearAllPasswordInputs();
        });


        // [Feature] 监听后端自定义事件 'showError' (失败)
        document.body.addEventListener("showError", function (evt) {
            const message = evt.detail.value;
            createAndShowToast(message, 'danger');
            // 失败时: 清除密码输入框内容，但保持 modal 打开
            clearAllPasswordInputs();
        });


        // 动态创建并显示 Toast (支持 success/danger/info/warning)
        function createAndShowToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            // 根据类型选择图标
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'danger') icon = 'fa-times-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';

            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-shown="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fa-solid ${icon} me-2"></i> ${msg}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', toastHtml);
            const newToastEl = container.lastElementChild;
            var toast = new bootstrap.Toast(newToastEl, { delay: 2000 });
            toast.show();
            // Toast 隐藏后自动从 DOM 移除
            newToastEl.addEventListener('hidden.bs.toast', function () {
                newToastEl.remove();
            });
        }

        // [Security] 清空所有密码输入框
        function clearAllPasswordInputs() {
            document.querySelectorAll('input[type="password"]').forEach(function (input) {
                input.value = '';
            });
        }

        // [Clock] 时钟现由 GlobalStatus.js 管理，此处保留向后兼容包装
        // 如页面直接调用 updateClock，则委托给 GlobalStatus

        // [Bootstrap] Tooltip 初始化 (包装在try-catch中防止错误阻断其他脚本)
        try {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                try {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                } catch (e) {
                    console.warn('Tooltip init failed for element:', tooltipTriggerEl, e);
                    return null;
                }
            }).filter(Boolean);
        } catch (e) {
            console.warn('Tooltip initialization error:', e);
        }
    </script>
    <script>
        // [System Faults Logger] 全局错误捕获与上报

        // 1. 捕获 HTMX 请求错误 (4xx, 5xx, Network Error)
        document.body.addEventListener('htmx:responseError', function (evt) {
            const xhr = evt.detail.xhr;
            const errorInfo = {
                type: 'HTMX Error',
                status: xhr.status,
                statusText: xhr.statusText,
                url: xhr.responseURL,
                response: xhr.responseText.substring(0, 200) // 截取前200字符
            };
            reportSystemFault(errorInfo);
        });

        document.body.addEventListener('htmx:sendError', function (evt) {
            reportSystemFault({
                type: 'Network Error',
                message: 'Failed to send request (Network down?)',
                url: evt.detail.elt.getAttribute('hx-post') || evt.detail.elt.getAttribute('hx-get')
            });
        });

        // 2. 捕获 JavaScript 运行时错误
        window.onerror = function (msg, url, line, col, error) {
            reportSystemFault({
                type: 'JS Runtime Error',
                message: msg,
                location: `${url}:${line}:${col}`,
                stack: error ? error.stack : 'No stack trace'
            });
            return false; // 继续抛出，不吞掉错误
        };

        // 上报函数
        function reportSystemFault(data) {
            // 使用 fetch 发送，不依赖 HTMX，防止循环错误
            fetch('/api/sys/log_error/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            }).catch(e => console.error("Failed to report error:", e));
        }
    </script>
    <script>
        // ===========================================
        // [Security] Real-time Role Update Detection
        // ===========================================
        (function () {
            let currentRoleVersion = null;
            const checkInterval = 10000; // Check every 10 seconds

            async function checkRoleVersion() {
                try {
                    // Only check if user is logged in
                    if (document.cookie.indexOf('sessionid') === -1) return;

                    const response = await fetch('/dashboard/user_admin/api/check_role_version/', {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const newVersion = data.role_version;

                        if (currentRoleVersion === null) {
                            // Initialize baseline
                            currentRoleVersion = newVersion;
                        } else if (newVersion > currentRoleVersion) {
                            // Role updated! Force refresh immediately
                            console.log("Role updated! Refreshing...");
                            window.location.reload();
                        }
                    }
                } catch (e) {
                    console.error("Role check failed", e);
                }
            }

            // Initial check
            checkRoleVersion();

            // Start polling
            setInterval(checkRoleVersion, checkInterval);
        })();
    </script>
</body>

</html>