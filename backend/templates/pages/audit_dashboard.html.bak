{% extends "layouts/base.html" %}
{% load security_tags %}
{% block title %}安全审计 - Eaglestar ERP{% endblock %}

{% block content %}
{# 上帝模式视觉特效 #}
{% if is_god_mode %}
<div class="god-mode-border"></div>
<div class="god-mode-badge">
    <i class="fa-solid fa-eye me-2"></i>GOD MODE (UNMASKED)
</div>
{% endif %}

<div class="container-fluid p-0 h-100 d-flex flex-column position-relative" style="z-index: 1;">

    {# 消息提示区 #}
    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-0" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# 顶部标题与工具栏 (Wrapped in module-header to hide when tab active) #}
    <div class="d-flex justify-content-between align-items-center mb-4 module-header">
        <div>
            <h4 class="text-white fw-bold mb-1">
                <i class="fa-solid fa-shield-halved me-2 text-warning"></i>安全审计日志 (Security Audit)
            </h4>
            <div class="text-muted small">
                ISO 27001 Traceability & Risk Control Center
            </div>
        </div>

        <div class="d-flex gap-2">
            {# Only show Lock button here if God Mode is Active, otherwise Unlock is in Hub #}
            {% if is_god_mode %}
            <a href="{% url 'web_ui:audit_lock' %}" class="btn btn-danger btn-sm shadow-lg fw-bold">
                <i class="fa-solid fa-lock me-2"></i>立即上锁 (Lock)
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Module Hub Menu -->
    {% with hub_id="audit-hub" hub_items=hub_items module_icon="fa-solid fa-shield-halved" module_title="安全审计日志
    (Security Audit)" %}
    {% include "components/module_hub.html" %}
    {% endwith %}

    {# Hidden Tab 导航 (Hidden by default, triggered by Hub) #}
    <ul class="nav nav-pills mb-3 border-bottom border-secondary border-opacity-25 d-none" id="auditTabs">
        {# Tab 1: 业务操作 #}
        <li class="nav-item">
            <a class="nav-link active cursor-pointer" id="tab-business"
                hx-get="{% url 'web_ui:audit_tab_content' tab_name='business' %}" hx-target="#audit-content-area"
                onclick="setActiveTab(this)" data-hub-target="business">
                业务操作
            </a>
        </li>
        {# Tab 2: 底层数据 #}
        <li class="nav-item">
            <a class="nav-link cursor-pointer" id="tab-infra"
                hx-get="{% url 'web_ui:audit_tab_content' tab_name='infra' %}" hx-target="#audit-content-area"
                onclick="setActiveTab(this)" data-hub-target="infra">
                底层数据
            </a>
        </li>
        {# Tab 3: 系统故障 #}
        <li class="nav-item">
            <a class="nav-link cursor-pointer" id="tab-system"
                hx-get="{% url 'web_ui:audit_tab_content' tab_name='system' %}" hx-target="#audit-content-area"
                onclick="setActiveTab(this)" data-hub-target="system">
                系统故障
            </a>
        </li>
    </ul>

    {# 内容加载区 (HTMX Target) #}
    <div id="audit-content-area" class="flex-grow-1 position-relative">
        <div class="htmx-indicator position-absolute top-50 start-50 translate-middle text-center">
            <div class="spinner-border text-warning mb-2" role="status"></div>
            <div class="text-muted small">Loading Audit Logs...</div>
        </div>
    </div>

</div>

{# ================= Modal 区域 ================= #}

{# 1. God Mode Unlock Modal #}
<div class="modal fade" id="godModeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-danger">
            <div class="modal-header border-bottom border-danger border-opacity-25 bg-danger bg-opacity-10">
                <h5 class="modal-title text-danger fw-bold">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>身份核验 (Security Check)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form action="{% url 'web_ui:audit_unlock' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <p class="text-white-50 small mb-3">
                        您正在请求查看系统的 <strong class="text-white">原始敏感数据 (Unmasked Data)</strong>。<br>
                        此操作将被永久记录在审计日志中。请输入 <span class="text-danger fw-bold">L4 密码 (L4 Code)</span> 以继续。
                    </p>
                    {# 动态渲染密码框 #}
                    {% security_inputs 'btn_unlock_view' %}
                </div>
                <div class="modal-footer border-top border-danger border-opacity-25">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-sm btn-danger px-4">确认解锁</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# 2. Purge Log Modal #}
<div class="modal fade" id="purgeLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-card border-danger">
            <div class="modal-header border-bottom border-danger border-opacity-25 bg-danger bg-opacity-10">
                <h5 class="modal-title text-danger fw-bold"><i class="fa-solid fa-fire me-2"></i>清空日志 (Purge)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'web_ui:audit_purge' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="alert alert-danger bg-opacity-10 border-danger text-danger small mb-3">
                        <strong>⚠️ 不可逆操作警告：</strong><br>
                        您正在请求物理删除审计日志。Permanent(永久)记录和 Patched(已修复)的系统故障将被系统强制保留，其他记录将被永久擦除。
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white-50 small fw-bold">1. 选择日志类型</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="log_types" value="business"
                                    id="chk_biz" checked>
                                <label class="form-check-label text-white" for="chk_biz">业务操作</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="log_types" value="infra"
                                    id="chk_infra">
                                <label class="form-check-label text-white" for="chk_infra">底层数据</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="log_types" value="system"
                                    id="chk_sys">
                                <label class="form-check-label text-white" for="chk_sys">系统故障</label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label text-white-50 small fw-bold">2. 开始日期</label>
                            <input type="date" name="start_date"
                                class="form-control bg-dark text-white border-secondary" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-white-50 small fw-bold">3. 结束日期</label>
                            <input type="date" name="end_date" class="form-control bg-dark text-white border-secondary"
                                required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white-50 small fw-bold">4. 清空理由 (Reason)</label>
                        <input type="text" name="reason" class="form-control bg-dark text-white border-secondary"
                            placeholder="例如：年度数据归档清洗..." required>
                    </div>

                    {# 动态渲染密码框 #}
                    {% security_inputs 'btn_purge_logs' %}
                </div>
                <div class="modal-footer border-top border-danger border-opacity-25">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-sm btn-danger px-4 fw-bold">确认清空</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function setActiveTab(element) {
        document.querySelectorAll('#auditTabs .nav-link').forEach(el => {
            el.classList.remove('active', 'border-warning', 'text-white', 'fw-bold');
            el.classList.add('border-transparent', 'text-white-50');
        });
        element.classList.remove('border-transparent', 'text-white-50');
        element.classList.add('active', 'border-warning', 'text-white', 'fw-bold');
    }
</script>

<style>
    .nav-link.active {
        background: transparent !important;
    }

    .hover-text-white:hover {
        color: #fff !important;
    }

    /* God Mode Animation */
    .god-mode-border {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 4px solid rgba(220, 53, 69, 0.6);
        pointer-events: none;
        z-index: 0;
        animation: pulse-border 2s infinite;
    }

    .god-mode-badge {
        position: fixed;
        top: 10px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.8rem;
        z-index: 9999;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.8);
    }

    @keyframes pulse-border {
        0% {
            border-color: rgba(220, 53, 69, 0.3);
        }

        50% {
            border-color: rgba(220, 53, 69, 0.8);
        }

        100% {
            border-color: rgba(220, 53, 69, 0.3);
        }
    }
</style>
{% endblock %}