{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Home - ERP System {{ version }}{% endblock %}

{% block content %}
<div class="apple-dashboard">

    <!-- Hero Section: Brand + Welcome -->
    <header class="hero-section">
        <div class="hero-content">
            <!-- Brand Identity -->
            <div class="brand-hero animate-fade-in">
                <div class="brand-icon-large">
                    <i class="fa-solid fa-cubes"></i>
                </div>
                <div class="brand-identity">
                    <h1 class="brand-title">
                        <span class="gradient-text">ERP</span>
                        <span class="light-text">System</span>
                    </h1>
                    <p class="brand-subtitle">Enterprise Resource Planning</p>
                </div>
            </div>

            <!-- Welcome Message -->
            <div class="welcome-block animate-fade-in delay-1">
                <div class="welcome-emoji" id="home-weather-icon">üå§Ô∏è</div>
                <div class="welcome-text">
                    <h2><span data-i18n="pages.welcome_back">Ê¨¢ËøéÂõûÊù•Ôºå</span><span class="highlight">{{ user.username }}</span></h2>
                    <p class="user-role"
                        style="color: {% if user.is_superuser %}#ffc107{% elif user.is_staff %}#0dcaf0{% else %}#adb5bd{% endif %} !important;">
                        {{ role }}</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <div class="content-grid">

        <!-- Left: Info Cards -->
        <div class="info-column">

            <!-- Version Card -->
            <div class="apple-card animate-fade-in delay-2">
                <div class="card-header">
                    <span class="card-label" data-i18n="pages.system_info">Á≥ªÁªü‰ø°ÊÅØ</span>
                </div>
                <div class="version-grid">
                    <div class="version-item">
                        <span class="version-label">Author</span>
                        <span class="version-value">Aaron</span>
                    </div>
                    <div class="version-divider"></div>
                    <div class="version-item">
                        <span class="version-label">Version</span>
                        <span class="version-value accent">{{ version }}</span>
                    </div>
                    <div class="version-divider"></div>
                    <div class="version-item">
                        <span class="version-label">Released</span>
                        <span class="version-value info">{{ release_date }}</span>
                    </div>
                </div>
            </div>

            <!-- Environment Card -->
            <div class="apple-card animate-fade-in delay-3">
                <div class="card-header">
                    <span class="card-label" data-i18n="pages.env_info">ÁéØÂ¢É‰ø°ÊÅØ</span>
                </div>
                <div class="env-list">
                    <div class="env-row">
                        <div class="env-icon"><i class="fa-solid fa-network-wired"></i></div>
                        <span class="env-label" data-i18n="pages.ip_address">IP Âú∞ÂùÄ</span>
                        <span class="env-value" id="home-ip">Loading...</span>
                    </div>
                    <div class="env-row">
                        <div class="env-icon"><i class="fa-solid fa-location-dot"></i></div>
                        <span class="env-label" data-i18n="pages.location">‰ΩçÁΩÆ</span>
                        <span class="env-value" id="home-location">Loading...</span>
                    </div>
                    <div class="env-row">
                        <div class="env-icon"><i class="fa-solid fa-cloud-sun"></i></div>
                        <span class="env-label" data-i18n="pages.weather">Â§©Ê∞î</span>
                        <span class="env-value" id="home-weather">Loading...</span>
                    </div>
                </div>
                <div class="greeting-banner">
                    <i class="fa-solid fa-sparkles"></i>
                    <span id="home-greeting" data-i18n="pages.getting_tip">Ê≠£Âú®Ëé∑Âèñ‰ªäÊó•Âª∫ËÆÆ...</span>
                </div>
            </div>

            <!-- Status Card -->
            <div class="apple-card status-card animate-fade-in delay-4">
                <div class="status-indicator online"></div>
                <div class="status-content">
                    <h4 data-i18n="pages.system_status">Á≥ªÁªüÁä∂ÊÄÅ</h4>
                    <p data-i18n="pages.all_services_ok">ÊâÄÊúâÊúçÂä°ËøêË°åÊ≠£Â∏∏</p>
                </div>
                <div class="status-details">
                    <span class="status-badge">Database <i class="fa-solid fa-check"></i></span>
                    <span class="status-badge">Cache <i class="fa-solid fa-check"></i></span>
                    <span class="status-badge">Workers <i class="fa-solid fa-check"></i></span>
                </div>
            </div>

            <!-- Help Notice -->
            <div class="help-notice animate-fade-in delay-5">
                <i class="fa-solid fa-lightbulb"></i>
                <span data-i18n="pages.help_notice">ËØ∑ÈÄöËøáÂ∑¶‰æßÂØºËà™Ê†èËÆøÈóÆÂÖ∑‰Ωì‰∏öÂä°Ê®°Âùó„ÄÇÂ¶ÇÈúÄÂçèÂä©ÔºåËØ∑ËÅîÁ≥ªAaron„ÄÇ</span>
            </div>

        </div>

        <!-- Right: Patch Notes -->
        <div class="notes-column">
            <div class="apple-card notes-card animate-fade-in delay-3">
                <div class="notes-header">
                    <div class="notes-title">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                        <span data-i18n="pages.changelog">Êõ¥Êñ∞Êó•Âøó</span>
                    </div>
                    <span class="current-version">{{ version }}</span>
                </div>
                <div class="notes-timeline">
                    {% for note in patch_notes reversed %}
                    <div class="timeline-entry">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-version">{{ note.version }}</span>
                                <span class="timeline-date">{{ note.date }}</span>
                            </div>
                            <div class="timeline-body">
                                {% for line in note.content %}
                                {% if line|first == '-' %}
                                <div class="change-item">
                                    <span class="change-dot"></span>
                                    <span>{{ line|slice:"1:" }}</span>
                                </div>
                                {% elif line|length > 0 %}
                                <div class="change-category">{{ line }}</div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-notes" data-i18n="pages.no_changelog">ÊöÇÊó†Êõ¥Êñ∞Êó•Âøó</div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    /* ========================================
       Apple-Style Dashboard - Clean & Minimal
       ======================================== */

    /* ========================================
       Apple-Style Dashboard - Full Width Layout
       ======================================== */

    .apple-dashboard {
        width: 100%;
        /* Full Width */
        margin: 0;
        padding: 0;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        /* Fixed width for notes, fluid for content */
        gap: 24px;
        align-items: start;
        /* Align top */
    }

    @media (max-width: 1200px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Strict Rectangular Alignment */
    .info-column {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
    }

    /* Make Version Card and Environment Card span full if needed, or keep grid */
    .info-column>.apple-card {
        height: 100%;
        /* Ensure equal height if in same row */
    }

    /* Fixed Height Changelog */
    .notes-card {
        height: 600px;
        /* Explicit fixed height */
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .notes-timeline {
        flex: 1;
        overflow-y: auto;
        padding-right: 4px;
        /* Space for scrollbar */
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fadeInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    .delay-1 {
        animation-delay: 0.1s;
    }

    .delay-2 {
        animation-delay: 0.2s;
    }

    .delay-3 {
        animation-delay: 0.3s;
    }

    .delay-4 {
        animation-delay: 0.4s;
    }

    .delay-5 {
        animation-delay: 0.5s;
    }

    /* === Hero Section === */
    .hero-section {
        padding: 40px 0 50px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 40px;
    }

    .hero-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 30px;
    }

    /* Brand */
    .brand-hero {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .brand-icon-large {
        width: 80px;
        height: 80px;
        background: linear-gradient(145deg, #5e5ce6, #bf5af2);
        border-radius: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow:
            0 20px 40px rgba(94, 92, 230, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .brand-icon-large i {
        font-size: 2.2rem;
        color: white;
    }

    .brand-identity {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .brand-title {
        margin: 0;
        display: flex;
        align-items: baseline;
        gap: 12px;
    }

    .gradient-text {
        font-size: 3.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #5e5ce6, #bf5af2, #ff375f);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -2px;
    }

    .light-text {
        font-size: 1.8rem;
        font-weight: 300;
        color: rgba(255, 255, 255, 0.6);
        letter-spacing: 3px;
        text-transform: uppercase;
    }

    .brand-subtitle {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.35);
        text-transform: uppercase;
        letter-spacing: 3px;
        margin: 0;
    }

    /* Welcome */
    .welcome-block {
        display: flex;
        align-items: center;
        gap: 16px;
        background: rgba(255, 255, 255, 0.03);
        padding: 20px 28px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .welcome-emoji {
        font-size: 2.5rem;
    }

    .welcome-text h2 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
    }

    .welcome-text h2 .highlight {
        color: #fff;
        font-weight: 600;
    }

    .user-role {
        margin: 4px 0 0;
        font-size: 0.85rem;
        color: #5e5ce6;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* === Content Grid === */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 30px;
    }

    @media (max-width: 1100px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    .info-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* === Apple Card === */
    .apple-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 24px;
        transition: all 0.3s ease;
    }

    .apple-card:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
    }

    .card-header {
        margin-bottom: 20px;
    }

    .card-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }

    /* Version Grid */
    .version-grid {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .version-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .version-label {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .version-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #fff;
    }

    .version-value.accent {
        color: #5e5ce6;
    }

    .version-value.info {
        color: #64d2ff;
    }

    .version-divider {
        width: 1px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
    }

    /* Environment List */
    .env-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 20px;
    }

    .env-row {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .env-icon {
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .env-icon i {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .env-label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.5);
        width: 70px;
    }

    .env-value {
        font-size: 0.9rem;
        color: #fff;
        font-weight: 500;
    }

    /* Greeting */
    .greeting-banner {
        background: linear-gradient(135deg, rgba(94, 92, 230, 0.15), rgba(191, 90, 242, 0.15));
        border-radius: 12px;
        padding: 14px 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .greeting-banner i {
        color: #bf5af2;
    }

    /* Status Card */
    .status-card {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .status-indicator {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-indicator.online {
        background: #30d158;
        box-shadow: 0 0 12px rgba(48, 209, 88, 0.5);
    }

    .status-content {
        flex: 1;
        min-width: 150px;
    }

    .status-content h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
    }

    .status-content p {
        margin: 4px 0 0;
        font-size: 0.8rem;
        color: #30d158;
    }

    .status-details {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .status-badge {
        background: rgba(48, 209, 88, 0.1);
        color: #30d158;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Help Notice */
    .help-notice {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .help-notice i {
        color: #ffd60a;
        font-size: 1rem;
    }

    /* === Notes Card === */
    .notes-card {
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 180px);
        padding: 0;
        overflow: hidden;
    }

    .notes-header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .notes-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
    }

    .notes-title i {
        color: #ff9f0a;
    }

    .current-version {
        background: rgba(94, 92, 230, 0.2);
        color: #5e5ce6;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        font-family: 'SF Mono', monospace;
    }

    .notes-timeline {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
    }

    .notes-timeline::-webkit-scrollbar {
        width: 6px;
    }

    .notes-timeline::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }

    .timeline-entry {
        display: flex;
        gap: 16px;
        padding-bottom: 24px;
        margin-bottom: 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .timeline-entry:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .timeline-marker {
        width: 10px;
        height: 10px;
        background: linear-gradient(135deg, #5e5ce6, #bf5af2);
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 6px;
    }

    .timeline-content {
        flex: 1;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .timeline-version {
        font-size: 1rem;
        font-weight: 600;
        color: #5e5ce6;
    }

    .timeline-date {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.4);
    }

    .timeline-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .change-category {
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 8px;
    }

    .change-category:first-child {
        margin-top: 0;
    }

    .change-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.55);
        line-height: 1.5;
    }

    .change-dot {
        width: 4px;
        height: 4px;
        background: rgba(94, 92, 230, 0.6);
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 7px;
    }

    .empty-notes {
        text-align: center;
        color: rgba(255, 255, 255, 0.3);
        padding: 40px;
    }

    /* === Responsive === */
    @media (max-width: 768px) {
        .hero-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .gradient-text {
            font-size: 2.5rem;
        }

        .light-text {
            font-size: 1.3rem;
        }

        .version-grid {
            flex-wrap: wrap;
        }

        .version-divider {
            display: none;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const CACHE_KEY = 'user_env_data_v2';

        function renderHomeEnv(data) {
            const ipEl = document.getElementById('home-ip');
            const locEl = document.getElementById('home-location');
            const weatherEl = document.getElementById('home-weather');
            const iconEl = document.getElementById('home-weather-icon');
            const greetEl = document.getElementById('home-greeting');

            if (ipEl) ipEl.innerText = data.ip || 'Unknown IP';

            let locationStr = data.city || 'Unknown City';
            if (data.country) {
                locationStr += `, ${data.country}`;
            }
            if (locEl) locEl.innerText = locationStr;

            if (weatherEl) weatherEl.innerText = data.weather || '-';
            if (iconEl) iconEl.innerText = data.weather_emoji || 'üå§Ô∏è';
            if (greetEl) greetEl.innerText = data.greeting || 'Welcome back.';
        }

        const cached = sessionStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                renderHomeEnv(JSON.parse(cached));
            } catch (e) { console.error("Cache Parse Error", e); }
        }

        fetch('/api/sys/user_env/')
            .then(res => res.json())
            .then(data => {
                renderHomeEnv(data);
                sessionStorage.setItem(CACHE_KEY, JSON.stringify(data));
            })
            .catch(err => {
                console.error("Home Env Fetch Error", err);
                const greetEl = document.getElementById('home-greeting');
                if (greetEl) greetEl.innerText = "Unable to load environment data.";
            });
    });
</script>
{% endblock %}