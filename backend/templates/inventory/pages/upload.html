{% extends "layouts/base.html" %}
{% load i18n %}
{% load security_tags %}

{% block title %}Manual Stocktake Upload - Inventory - Eaglestar ERP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/global-wizard.css">
<link rel="stylesheet" href="/static/css/apple-table.css">
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard/inventory/"
                            class="text-info text-decoration-none" data-i18n="nav.inventory">Inventory</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="inventory.upload">Manual Stocktake Upload</li>
                </ol>
            </nav>
            <p class="text-white-50 small mb-0 mt-1" data-i18n="ui.text_351">上传库存盘点 CSV 文件，校验后同步到盘存表。</p>
        </div>
        <div>
            <a href="/dashboard/inventory/" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="inventory.back_to_hub">返回Inventory</span>
            </a>
        </div>
    </div>

    <!-- Wizard Container -->
    <div class="glass-card p-4" id="inv-upload-wizard-container" data-testid="inv-upload-wizard">

        <!-- Wizard Header -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-boxes-stacked fa-2x text-success"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="inventory.upload_wizard_title">盘存数据处理向导</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_352">上传 → 校验 → 修正 → 查验 → 完成</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar Anchor -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

        <!-- ========================================== -->
        <!-- Step 1: Upload File -->
        <!-- ========================================== -->
        <div class="wizard-step-content active" id="step-upload" data-testid="step-upload">
            <!-- 操作说明卡片 -->
            <div class="card bg-dark bg-opacity-50 border-secondary border-opacity-25 mb-4"
                data-testid="ops-guide-card">
                <div class="card-header bg-transparent border-0 d-flex align-items-center py-2">
                    <i class="fas fa-info-circle text-info me-2 opacity-75"></i>
                    <span class="text-white-50 small fw-bold" data-i18n="common.operation_desc">操作说明</span>
                </div>
                <div class="card-body py-2">
                    <ul class="text-white-50 small mb-0 ps-3" style="line-height: 1.8;">
                        <li>CSV 文件需包含 <code class="text-info">SKU</code> 和 <code class="text-info">Quantity</code> 列
                        </li>
                        <li data-i18n="ui.text_354">系统将自动校验 SKU 有效性，无效 SKU 可在后续步骤修正</li>
                        <li data-i18n="ui.text_355">如选择的日期已有记录，继续操作将覆盖原有数据</li>
                        <li data-i18n="ui.text_356">最终入库需要密码验证</li>
                    </ul>
                </div>
            </div>

            <!-- Data Cutoff Date Notice -->
            <div class="d-flex align-items-center rounded-3 p-3 mb-4"
                style="background: rgba(25, 135, 84, 0.08); border: 1px solid rgba(25, 135, 84, 0.2);">
                <i class="fa-solid fa-calendar-check fa-lg text-success me-3 opacity-75"></i>
                <div class="small">
                    <span class="text-white-50" data-i18n="ui.text_357">盘存表最新记录至:</span>
                    <span class="text-success fw-bold ms-2" id="inv-latest-date" data-i18n="common.loading">加载中...</span>
                </div>
            </div>

            <form id="inv-upload-form">
                {% csrf_token %}
                <div class="row g-4 mb-4">
                    <!-- Upload Zone -->
                    <div class="col-md-8">
                        <div class="upload-zone p-4 text-center rounded-3" id="upload-dropzone"
                            data-testid="upload-component"
                            style="border: 2px dashed rgba(255,255,255,0.15); background: rgba(0,0,0,0.15); min-height: 160px; cursor: pointer; transition: all 0.2s;">
                            <i class="fa-solid fa-file-csv display-5 text-success opacity-75 mb-3"></i>
                            <p class="text-white mb-1" data-i18n="etl.drag_csv">拖拽 CSV 文件到此处，或点击选择</p>
                            <p class="text-muted small mb-3" data-i18n="etl.require_columns">需包含 SKU 和 Quantity 列</p>
                            <input type="file" name="inv_file" id="inv-file" class="d-none" accept=".csv">
                            <button type="button" class="btn btn-outline-success btn-sm px-4" id="btn-select-file">
                                <i class="fa-solid fa-folder-open me-2"></i><span data-i18n="etl.select_file">选择文件</span>
                            </button>
                        </div>
                        <!-- Selected File Preview -->
                        <div id="inv-file-display" class="mt-3 d-none">
                            <span class="badge bg-success bg-opacity-25 text-success py-2 px-3">
                                <i class="fa-solid fa-file me-1"></i>
                                <span id="inv-file-name"></span>
                                <button type="button" class="btn-close btn-close-white ms-2" id="btn-clear-file"
                                    style="font-size: 0.5rem;"></button>
                            </span>
                        </div>
                    </div>

                    <!-- Date Picker -->
                    <div class="col-md-4">
                        <label class="form-label text-white-50 small text-uppercase">
                            <i class="fa-solid fa-calendar me-1"></i><span data-i18n="etl.target_date">归属日期</span>
                        </label>
                        <input type="date" name="target_date" id="inv-target-date"
                            class="form-control bg-dark text-white border-secondary" required>
                        <div class="form-text text-muted small" data-i18n="etl.date_hint">选择该盘存数据对应的日期</div>

                        <!-- Date Exists Warning -->
                        <div id="date-exists-warning" class="mt-2 d-none">
                            <div class="rounded-2 py-2 px-3"
                                style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3);">
                                <i class="fa-solid fa-triangle-exclamation me-1 text-warning"></i>
                                <small class="text-warning" data-i18n="ui.text_361">该日期已存在记录，继续将覆盖</small>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <div id="step1-error" class="text-danger small text-center mb-3"></div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success rounded-pill px-4" id="btn-step1-next" disabled>
                        开始校验 <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 2: Validate -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-validate" data-testid="step-validate">
            <div id="validate-loading" class="text-center py-5">
                <div class="spinner-border text-success mb-3" role="status"></div>
                <p class="text-white-50 mb-0" data-i18n="ui.text_362">正在校验 CSV 文件...</p>
            </div>

            <div id="validate-result" class="d-none">
                <!-- 校验通过 -->
                <div id="validate-success" class="d-none">
                    <div class="d-flex align-items-center rounded-3 p-3 mb-4"
                        style="background: rgba(25, 135, 84, 0.08); border: 1px solid rgba(25, 135, 84, 0.25);">
                        <i class="fa-solid fa-check-circle text-success me-3"></i>
                        <div>
                            <span class="text-white" data-i18n="ui.text_218">校验通过</span>
                            <span class="badge bg-success ms-2" id="valid-row-count" data-i18n="ui.text_364">0 条有效数据</span>
                        </div>
                    </div>
                    <p class="text-white-50 small mb-2"><i class="fa-solid fa-table me-1"></i><span data-i18n="ui.icon_3148">数据预览:</span></p>
                    <div class="apple-table-responsive" style="max-height: 220px;">
                        <table class="apple-table apple-table-compact" id="preview-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>SKU</th>
                                    <th>Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="preview-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 校验失败 - 格式错误 -->
                <div id="validate-format-error" class="d-none">
                    <div class="d-flex align-items-start rounded-3 p-3 mb-4"
                        style="background: rgba(220, 53, 69, 0.08); border: 1px solid rgba(220, 53, 69, 0.25);">
                        <i class="fa-solid fa-times-circle text-danger me-3 mt-1"></i>
                        <div>
                            <span class="text-white fw-bold" data-i18n="ui.text_230">校验失败</span>
                            <p class="text-danger small mb-0 mt-1" id="format-error-message"></p>
                        </div>
                    </div>
                </div>

                <!-- 校验失败 - SKU 错误（显示未知 SKU 列表） -->
                <div id="validate-sku-error" class="d-none">
                    <div class="d-flex align-items-start rounded-3 p-3 mb-4"
                        style="background: rgba(255, 193, 7, 0.08); border: 1px solid rgba(255, 193, 7, 0.25);">
                        <i class="fa-solid fa-exclamation-triangle text-warning me-3 mt-1"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="text-white" data-i18n="ui.text_366">发现未识别 SKU</span>
                                    <span class="badge bg-warning text-dark ms-2" id="unknown-sku-count" data-i18n="ui.text_367">0 个</span>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                    id="btn-copy-unknown-skus" data-i18n-title="tooltip.t3498" title="复制SKU列表">
                                    <i class="fa-solid fa-copy me-1"></i><span data-i18n="ui.icon_3149">复制列表</span>
                                </button>
                            </div>
                            <p class="text-white-50 small mb-2 mt-2" data-i18n="ui.text_368">以下 SKU 不存在于系统库存档案，请在下一步修正或跳过：</p>
                            <div class="unknown-sku-list mt-2" id="unknown-sku-list"
                                style="max-height: 120px; overflow-y: auto;">
                                <!-- SKU list will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step2-back">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_prev">返回上一步</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success rounded-pill px-4" id="btn-step2-next" disabled>
                        下一步 <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 3: Fix SKU (Apple UI Style) -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-fix" data-testid="step-fix">
            <!-- Header with progress -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-wrench text-warning me-2"></i>
                    <span class="text-white" data-i18n="ui.text_369">SKU 修正</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-white-50 small">
                        已处理: <span class="text-success fw-bold" id="fix-done-count">0</span> / <span
                            id="fix-total-count">0</span>
                    </span>
                    <button type="button" class="btn btn-outline-warning btn-sm" id="btn-skip-all">
                        <i class="fa-solid fa-forward me-1"></i><span data-i18n="ui.icon_3151">全部跳过</span>
                    </button>
                </div>
            </div>

            <!-- Hint -->
            <div class="rounded-2 py-2 px-3 mb-4"
                style="background: rgba(253, 126, 20, 0.08); border: 1px solid rgba(253, 126, 20, 0.2);">
                <i class="fa-solid fa-lightbulb me-2 text-warning opacity-75"></i>
                <small class="text-white-50" data-i18n="ui.text_370">如需新增 SKU，请前往数据修改中心添加后再回来上传</small>
            </div>

            <!-- SKU Fix List (Apple Table Style) -->
            <div class="apple-table-responsive mb-4" style="max-height: 350px;">
                <table class="apple-table apple-table-compact" id="fix-sku-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 150px;" data-i18n="ui.text_2086">原 SKU</th>
                            <th data-i18n="js.recommend_match">推荐匹配</th>
                            <th style="width: 150px;" data-i18n="ui.text_2088">选择/输入</th>
                            <th style="width: 100px;" data-i18n="common.operation">操作</th>
                        </tr>
                    </thead>
                    <tbody id="fix-sku-tbody">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step3-back">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_prev">返回上一步</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success rounded-pill px-4" id="btn-step3-next">
                        应用修正并继续 <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 4: Final Review -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-review" data-testid="step-review">
            <div class="d-flex justify-content-between align-items-center rounded-3 p-3 mb-4"
                style="background: rgba(13, 202, 240, 0.06); border: 1px solid rgba(13, 202, 240, 0.2);">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-eye text-info me-3"></i>
                    <div>
                        <span class="text-white" data-i18n="ui.text_371">最终查验</span>
                        <span class="badge bg-info ms-2" id="review-row-count" data-i18n="ui.text_372">0 条数据</span>
                    </div>
                </div>
                <div class="text-muted small">
                    目标日期: <code class="text-info" id="review-target-date"></code>
                </div>
            </div>

            <p class="text-white-50 small mb-2"><i class="fa-solid fa-table me-1"></i><span data-i18n="ui.icon_3153">以下数据将被写入/更新:</span></p>
            <div class="apple-table-responsive mb-4" style="max-height: 250px;">
                <table class="apple-table apple-table-compact apple-table-striped" id="review-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>SKU</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="review-tbody"></tbody>
                </table>
            </div>

            <!-- Hidden form for sync -->
            <form id="inv-sync-form" class="d-none">
                {% csrf_token %}
                <input type="hidden" name="target_date" id="sync-target-date">
                <input type="hidden" name="session_key" id="sync-session-key">
                {% security_inputs 'btn_sync_inventory' %}
            </form>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step4-back">
                        <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_prev">返回上一步</span>
                    </button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success rounded-pill px-4" id="btn-confirm-sync"
                        data-testid="btn-confirm-sync" data-requires-global-modal="true"
                        data-action-key="btn_sync_inventory" data-action-display="{% trans 'Confirm Receiving' %}">
                        <i class="fas fa-database me-2"></i><span data-i18n="js.confirm_receiving">确认入库</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- Step 5: Done (Combined Syncing + Result) -->
        <!-- ========================================== -->
        <div class="wizard-step-content" id="step-done" data-testid="step-done">
            <!-- Syncing State -->
            <div id="done-syncing" class="text-center py-5">
                <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h5 class="text-white mb-2" data-i18n="ui.text_373">正在同步数据...</h5>
                <p class="text-white-50 small mb-0" data-i18n="ui.text_169">请勿关闭页面</p>
            </div>

            <!-- Result State -->
            <div id="done-result" class="d-none">
                <!-- Success Header -->
                <div class="text-center py-4">
                    <div id="done-icon">
                        <i class="fa-solid fa-check-circle display-3 text-success mb-3"></i>
                    </div>
                    <h4 class="text-white mb-2" id="done-title" data-i18n="ui.text_375">库存同步完成</h4>
                    <p class="text-white-50 mb-0" id="done-subtitle"></p>
                </div>

                <!-- Summary Card -->
                <div class="rounded-3 p-4 mb-4"
                    style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);">
                    <div class="row text-center g-3">
                        <div class="col-4">
                            <div class="text-success fw-bold fs-4" id="done-row-count">0</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2090">入库行数</div>
                        </div>
                        <div class="col-4">
                            <div class="text-info fw-bold fs-4" id="done-fixed-count">0</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2091">已修正 SKU</div>
                        </div>
                        <div class="col-4">
                            <div class="text-warning fw-bold fs-4" id="done-skipped-count">0</div>
                            <div class="text-white-50 small" data-i18n="ui.text_2092">已跳过 SKU</div>
                        </div>
                    </div>
                </div>

                <!-- Skipped SKU Details (Collapsible) -->
                <div id="done-skipped-section" class="d-none mb-4">
                    <button class="btn btn-link text-decoration-none text-white-50 p-0 mb-2" type="button"
                        data-bs-toggle="collapse" data-bs-target="#skipped-sku-collapse">
                        <i class="fa-solid fa-chevron-down me-1" id="skipped-chevron"></i>
                        <span data-i18n="ui.view_skipped_sku">查看跳过的 SKU 列表</span>
                    </button>
                    <div class="collapse" id="skipped-sku-collapse">
                        <div class="rounded-2 p-3"
                            style="background: rgba(255, 193, 7, 0.05); border: 1px solid rgba(255, 193, 7, 0.15);">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-white-50 small" data-i18n="ui.text_376">已跳过的 SKU:</span>
                                <button type="button" class="btn btn-outline-secondary btn-sm py-0"
                                    id="btn-copy-skipped-skus">
                                    <i class="fa-solid fa-copy me-1"></i><span data-i18n="common.copy">复制</span>
                                </button>
                            </div>
                            <div id="skipped-sku-list" class="font-monospace small"
                                style="max-height: 100px; overflow-y: auto; color: rgba(255,193,7,0.8);">
                                <!-- List populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wizard Actions -->
                <div class="wizard-actions">
                    <div class="wizard-actions-left"></div>
                    <div class="wizard-actions-right">
                        <button type="button" class="btn btn-outline-primary rounded-pill" id="btn-new-round">
                            <i class="fas fa-redo me-2"></i><span data-i18n="etl.start_new_sync">开始新同步</span>
                        </button>
                        <a href="/dashboard/inventory/" class="btn btn-primary rounded-pill px-4">
                            <i class="fas fa-home me-2"></i><span data-i18n="ui.icon_3145">返回Inventory</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ============================================================
        // State
        // ============================================================
        let wizardState = {
            sessionKey: null,
            targetDate: null,
            previewRows: [],
            skuCorrections: [],
            unknownSkus: [],
            allSkus: [],
            corrections: {},  // { badSku: newSku or 'SKIP' }
            hasSkuErrors: false,
            skippedSkus: []   // track skipped SKUs for done page
        };

        // ============================================================
        // Initialize GlobalWizard (5 steps now)
        // ============================================================
        const wizard = new GlobalWizard({
            containerId: 'inv-upload-wizard-container',
            steps: [
                { id: 'upload', label: (window.i18n?.t('common.upload') || 'Upload'), contentSelector: '#step-upload' },
                { id: 'validate', label: (window.i18n?.t('js.verify') || 'Verify'), contentSelector: '#step-validate' },
                { id: 'fix', label: (window.i18n?.t('js.correct') || 'Correct'), contentSelector: '#step-fix' },
                { id: 'review', label: (window.i18n?.t('js.inspect') || 'Inspect'), contentSelector: '#step-review' },
                { id: 'done', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#step-done' }
            ],
            onStepChange: function (from, to) {
                console.log('[InvUploadWizard] Step changed:', from, '->', to);
            },
            onRestart: function () {
                resetWizardState();
            }
        });

        // ============================================================
        // Load Latest Date on Init
        // ============================================================
        (function loadLatestDate() {
            fetch('/dashboard/inventory/stocktake/tab/inventory/', { headers: { 'X-Requested-With': 'fetch' } })
                .then(r => r.text())
                .then(html => {
                    const match = html.match(/盘存表最新记录至:\s*<span[^>]*>([^<]+)</);
                    if (match) {
                        document.getElementById('inv-latest-date').textContent = match[1].trim();
                    }
                })
                .catch(() => {
                    document.getElementById('inv-latest-date').textContent = (window.i18n?.t('js.load_failed') || 'Load Failed');
                });

            document.getElementById('inv-target-date').value = new Date().toISOString().split('T')[0];
            checkDateExists(document.getElementById('inv-target-date').value);
        })();

        // ============================================================
        // Step 1: Upload File
        // ============================================================
        const fileInput = document.getElementById('inv-file');
        const dropzone = document.getElementById('upload-dropzone');
        const fileDisplay = document.getElementById('inv-file-display');
        const fileName = document.getElementById('inv-file-name');
        const btnStep1Next = document.getElementById('btn-step1-next');
        const dateInput = document.getElementById('inv-target-date');

        function updateStep1NextButton() {
            const hasFile = fileInput.files.length > 0;
            const hasDate = dateInput.value.trim() !== '';
            btnStep1Next.disabled = !(hasFile && hasDate);
        }

        document.getElementById('btn-select-file').addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('click', (e) => {
            if (e.target === dropzone || e.target.classList.contains('fa-file-csv') || e.target.tagName === 'P') {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
                fileDisplay.classList.remove('d-none');
                dropzone.style.borderColor = 'rgba(25, 135, 84, 0.5)';
            } else {
                fileDisplay.classList.add('d-none');
                dropzone.style.borderColor = 'rgba(255,255,255,0.15)';
            }
            updateStep1NextButton();
        });

        document.getElementById('btn-clear-file').addEventListener('click', function (e) {
            e.stopPropagation();
            fileInput.value = '';
            fileDisplay.classList.add('d-none');
            dropzone.style.borderColor = 'rgba(255,255,255,0.15)';
            updateStep1NextButton();
        });

        // Drag and drop
        dropzone.addEventListener('dragover', function (e) {
            e.preventDefault();
            this.style.borderColor = 'rgba(25, 135, 84, 0.5)';
        });
        dropzone.addEventListener('dragleave', function () {
            if (fileInput.files.length === 0) {
                this.style.borderColor = 'rgba(255,255,255,0.15)';
            }
        });
        dropzone.addEventListener('drop', function (e) {
            e.preventDefault();
            const dt = new DataTransfer();
            Array.from(e.dataTransfer.files).forEach(f => {
                if (f.name.endsWith('.csv')) dt.items.add(f);
            });
            if (dt.files.length > 0) {
                fileInput.files = dt.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        dateInput.addEventListener('change', function () {
            checkDateExists(this.value);
            wizardState.targetDate = this.value;
            updateStep1NextButton();
        });

        function checkDateExists(dateValue) {
            const warningEl = document.getElementById('date-exists-warning');
            if (!dateValue) {
                warningEl.classList.add('d-none');
                return;
            }
            fetch(`/dashboard/inventory/stocktake/inv/check-date/?date=${encodeURIComponent(dateValue)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.exists) {
                        warningEl.classList.remove('d-none');
                    } else {
                        warningEl.classList.add('d-none');
                    }
                })
                .catch(() => warningEl.classList.add('d-none'));
        }

        btnStep1Next.addEventListener('click', function () {
            const errorEl = document.getElementById('step1-error');
            errorEl.textContent = '';
            if (fileInput.files.length === 0) {
                errorEl.textContent = (window.i18n?.t('js.select_csv') || 'Select CSV file');
                return;
            }
            if (!dateInput.value) {
                errorEl.textContent = (window.i18n?.t('js.select_attribution_date') || 'Select attribution date');
                return;
            }
            wizardState.targetDate = dateInput.value;
            wizard.goToStep('validate');
            runValidation();
        });

        // ============================================================
        // Step 2: Validate
        // ============================================================
        function runValidation() {
            const loadingEl = document.getElementById('validate-loading');
            const resultEl = document.getElementById('validate-result');
            const successEl = document.getElementById('validate-success');
            const formatErrorEl = document.getElementById('validate-format-error');
            const skuErrorEl = document.getElementById('validate-sku-error');
            const btnNext = document.getElementById('btn-step2-next');

            loadingEl.classList.remove('d-none');
            resultEl.classList.add('d-none');
            successEl.classList.add('d-none');
            formatErrorEl.classList.add('d-none');
            skuErrorEl.classList.add('d-none');
            btnNext.disabled = true;

            const formData = new FormData();
            formData.append('inv_file', fileInput.files[0]);
            formData.append('target_date', wizardState.targetDate);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('/dashboard/inventory/stocktake/inv/validate/', {
                method: 'POST',
                body: formData
            })
                .then(r => r.text())
                .then(html => {
                    loadingEl.classList.add('d-none');
                    resultEl.classList.remove('d-none');

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    const validCard = doc.querySelector('.border-success');
                    const skuErrorCard = doc.querySelector('.sku-error-container, .sku-correction-wizard');
                    const formatError = doc.querySelector('.border-danger .text-danger');

                    if (validCard) {
                        // Validation passed
                        successEl.classList.remove('d-none');
                        wizardState.hasSkuErrors = false;

                        const sessionKeyInput = doc.querySelector('input[name="session_key"]');
                        if (sessionKeyInput) wizardState.sessionKey = sessionKeyInput.value;

                        wizardState.previewRows = [];
                        const tbody = document.getElementById('preview-tbody');
                        tbody.innerHTML = '';

                        doc.querySelectorAll('tbody tr').forEach((row, idx) => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length >= 3) {
                                const sku = cells[1].textContent.trim();
                                const qty = cells[2].textContent.trim();
                                wizardState.previewRows.push({ SKU: sku, Quantity: qty });

                                const tr = document.createElement('tr');
                                const tdNum = document.createElement('td');
                                tdNum.className = 'text-muted';
                                tdNum.textContent = idx + 1;
                                const tdSku = document.createElement('td');
                                const codeEl = document.createElement('code');
                                codeEl.textContent = sku;
                                tdSku.appendChild(codeEl);
                                const tdQty = document.createElement('td');
                                tdQty.textContent = qty;
                                tr.appendChild(tdNum);
                                tr.appendChild(tdSku);
                                tr.appendChild(tdQty);
                                tbody.appendChild(tr);
                            }
                        });

                        document.getElementById('valid-row-count').textContent = wizardState.previewRows.length + (window.i18n?.t('js.valid_records_suffix') || ' valid records');
                        btnNext.disabled = false;
                        btnNext.innerHTML = '' + (window.i18n?.t('js.enter_final_check') || 'Enter Final Check') + ' <i class="fas fa-arrow-right ms-2"></i>';

                    } else if (skuErrorCard) {
                        // SKU validation failed - show unknown SKU list
                        skuErrorEl.classList.remove('d-none');
                        wizardState.hasSkuErrors = true;

                        const sessionKeyInput = doc.querySelector('input[name="session_key"]');
                        if (sessionKeyInput) wizardState.sessionKey = sessionKeyInput.value;

                        // Extract SKU corrections
                        wizardState.skuCorrections = [];
                        wizardState.unknownSkus = [];
                        const skuSteps = doc.querySelectorAll('.sku-correction-step');
                        skuSteps.forEach(step => {
                            const badSku = step.dataset.badSku;
                            wizardState.unknownSkus.push(badSku);
                            const suggestions = [];
                            step.querySelectorAll(`optgroup[label="${window.i18n?.t('js.recommend_match') || 'Recommended Match'}"] option`).forEach(opt => {
                                suggestions.push(opt.value);
                            });
                            wizardState.skuCorrections.push({ bad_sku: badSku, suggestions });
                        });

                        // Extract all SKUs
                        wizardState.allSkus = [];
                        doc.querySelectorAll(`optgroup[label="${window.i18n?.t('js.all_sku') || 'All SKU'}"] option`).forEach(opt => {
                            wizardState.allSkus.push(opt.value);
                        });

                        // Display unknown SKU list
                        const count = wizardState.unknownSkus.length;
                        document.getElementById('unknown-sku-count').textContent = count + (window.i18n?.t('js.count_suffix') || ' items');

                        const listContainer = document.getElementById('unknown-sku-list');
                        listContainer.innerHTML = '';
                        wizardState.unknownSkus.forEach(sku => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-warning bg-opacity-25 text-warning me-1 mb-1 font-monospace';
                            badge.textContent = sku;
                            listContainer.appendChild(badge);
                        });

                        btnNext.disabled = false;
                        btnNext.innerHTML = (window.i18n?.t('js.start_correction') || 'Start Correction') + ' <i class="fas fa-arrow-right ms-2"></i>';

                    } else if (formatError) {
                        // Format error
                        formatErrorEl.classList.remove('d-none');
                        document.getElementById('format-error-message').textContent = formatError.textContent;
                        btnNext.disabled = true;
                    } else {
                        formatErrorEl.classList.remove('d-none');
                        document.getElementById('format-error-message').textContent = (window.i18n?.t('js.validation_failed_check_format') || 'Validation failed, check file format');
                        btnNext.disabled = true;
                    }
                })
                .catch(error => {
                    loadingEl.classList.add('d-none');
                    resultEl.classList.remove('d-none');
                    formatErrorEl.classList.remove('d-none');
                    document.getElementById('format-error-message').textContent = (window.i18n?.t('js.network_error_retry') || 'Network error, please retry');
                    console.error('Validation error:', error);
                });
        }

        // Copy unknown SKUs
        document.getElementById('btn-copy-unknown-skus').addEventListener('click', function () {
            const text = wizardState.unknownSkus.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                createAndShowToast((window.i18n?.t('js.copied') || 'Copied ') + wizardState.unknownSkus.length + ' 个 SKU', 'success');
            });
        });

        document.getElementById('btn-step2-back').addEventListener('click', () => wizard.goToStep('upload'));

        document.getElementById('btn-step2-next').addEventListener('click', function () {
            if (wizardState.hasSkuErrors) {
                wizard.goToStep('fix');
                initFixStep();
            } else {
                wizard.goToStep('review');
                initReviewStep();
            }
        });

        // ============================================================
        // Step 3: Fix SKU (Apple Table Style)
        // ============================================================
        function initFixStep() {
            wizardState.corrections = {};
            renderFixTable();
        }

        function renderFixTable() {
            const tbody = document.getElementById('fix-sku-tbody');
            tbody.innerHTML = '';

            const total = wizardState.skuCorrections.length;
            document.getElementById('fix-total-count').textContent = total;
            updateFixProgress();

            wizardState.skuCorrections.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.dataset.badSku = item.bad_sku;
                tr.id = 'fix-row-' + idx;

                // #
                const tdNum = document.createElement('td');
                tdNum.className = 'text-muted';
                tdNum.textContent = idx + 1;
                tr.appendChild(tdNum);

                // 原 SKU
                const tdBadSku = document.createElement('td');
                const badCode = document.createElement('code');
                badCode.className = 'text-warning';
                badCode.textContent = item.bad_sku;
                tdBadSku.appendChild(badCode);
                tr.appendChild(tdBadSku);

                // 推荐匹配 (capsule buttons)
                const tdSuggestions = document.createElement('td');
                if (item.suggestions && item.suggestions.length > 0) {
                    item.suggestions.slice(0, 4).forEach(sug => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-info btn-sm me-1 mb-1 py-0 px-2';
                        btn.style.fontSize = '0.75rem';
                        btn.textContent = sug;
                        btn.onclick = function () {
                            selectFixForRow(idx, sug);
                        };
                        tdSuggestions.appendChild(btn);
                    });
                } else {
                    tdSuggestions.innerHTML = '<span class="text-muted small" data-i18n="ui.text_377">无推荐</span>';
                }
                tr.appendChild(tdSuggestions);

                // 选择/输入
                const tdSelect = document.createElement('td');
                const select = document.createElement('select');
                select.className = 'form-select form-select-sm bg-dark text-white border-secondary';
                select.id = 'fix-select-' + idx;
                select.innerHTML = '<option value="" data-i18n="option.o9755">选择...</option>';
                wizardState.allSkus.forEach(sku => {
                    const opt = document.createElement('option');
                    opt.value = sku;
                    opt.textContent = sku;
                    select.appendChild(opt);
                });
                select.onchange = function () {
                    if (this.value) {
                        selectFixForRow(idx, this.value);
                    }
                };
                tdSelect.appendChild(select);
                tr.appendChild(tdSelect);

                // 操作
                const tdActions = document.createElement('td');
                const btnSkip = document.createElement('button');
                btnSkip.type = 'button';
                btnSkip.className = 'btn btn-outline-secondary btn-sm py-0';
                btnSkip.innerHTML = '<i class="fa-solid fa-xmark"></i> ' + (window.i18n?.t('js.skip') || 'Skip');
                btnSkip.id = 'fix-skip-' + idx;
                btnSkip.onclick = function () {
                    skipFixForRow(idx);
                };
                tdActions.appendChild(btnSkip);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        function selectFixForRow(idx, newSku) {
            const item = wizardState.skuCorrections[idx];
            wizardState.corrections[item.bad_sku] = newSku;

            // Update UI
            const row = document.getElementById('fix-row-' + idx);
            row.classList.remove('row-invalid');
            row.style.background = 'rgba(25, 135, 84, 0.08)';

            const select = document.getElementById('fix-select-' + idx);
            select.value = newSku;

            const btnSkip = document.getElementById('fix-skip-' + idx);
            btnSkip.className = 'btn btn-outline-secondary btn-sm py-0';
            btnSkip.innerHTML = '<i class="fa-solid fa-xmark"></i> ' + (window.i18n?.t('js.skip') || 'Skip');

            updateFixProgress();
        }

        function skipFixForRow(idx) {
            const item = wizardState.skuCorrections[idx];
            wizardState.corrections[item.bad_sku] = 'SKIP';

            // Update UI
            const row = document.getElementById('fix-row-' + idx);
            row.classList.add('row-invalid');
            row.style.background = 'rgba(220, 53, 69, 0.06)';

            const select = document.getElementById('fix-select-' + idx);
            select.value = '';

            const btnSkip = document.getElementById('fix-skip-' + idx);
            btnSkip.className = 'btn btn-danger btn-sm py-0';
            btnSkip.innerHTML = '<i class="fa-solid fa-check"></i> ' + (window.i18n?.t('js.skipped') || 'Skipped');

            updateFixProgress();
        }

        function updateFixProgress() {
            const done = Object.keys(wizardState.corrections).length;
            document.getElementById('fix-done-count').textContent = done;
        }

        // Skip All
        document.getElementById('btn-skip-all').addEventListener('click', function () {
            wizardState.skuCorrections.forEach((item, idx) => {
                skipFixForRow(idx);
            });
        });

        document.getElementById('btn-step3-back').addEventListener('click', () => wizard.goToStep('validate'));

        document.getElementById('btn-step3-next').addEventListener('click', function () {
            // Check if all items have been handled
            const unhandled = wizardState.skuCorrections.filter(item => !wizardState.corrections[item.bad_sku]);
            if (unhandled.length > 0) {
                createAndShowToast((window.i18n?.t('js.remaining_prefix') || 'Remaining ') + unhandled.length + (window.i18n?.t('js.sku_remaining') || ' SKU remaining'), 'warning');
                return;
            }
            applyCorrections();
        });

        function applyCorrections() {
            const formData = new FormData();
            formData.append('session_key', wizardState.sessionKey);
            formData.append('target_date', wizardState.targetDate);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            // Track skipped SKUs
            wizardState.skippedSkus = [];
            for (const [badSku, newSku] of Object.entries(wizardState.corrections)) {
                formData.append('sku_correction_' + badSku, newSku);
                if (newSku === 'SKIP') {
                    wizardState.skippedSkus.push(badSku);
                }
            }

            fetch('/dashboard/inventory/stocktake/inv/apply-corrections/', {
                method: 'POST',
                body: formData
            })
                .then(r => r.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    const sessionKeyInput = doc.querySelector('input[name="session_key"]');
                    if (sessionKeyInput) wizardState.sessionKey = sessionKeyInput.value;

                    // Extract preview rows
                    wizardState.previewRows = [];
                    doc.querySelectorAll('tbody tr').forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            wizardState.previewRows.push({
                                SKU: cells[1].textContent.trim(),
                                Quantity: cells[2].textContent.trim()
                            });
                        }
                    });

                    wizard.goToStep('review');
                    initReviewStep();
                })
                .catch(error => {
                    createAndShowToast((window.i18n?.t('js.correction_failed_retry') || 'Correction failed, retry'), 'danger');
                    console.error('Apply corrections error:', error);
                });
        }

        // ============================================================
        // Step 4: Review
        // ============================================================
        function initReviewStep() {
            document.getElementById('review-row-count').textContent = wizardState.previewRows.length + (window.i18n?.t('js.records_suffix') || ' records');
            document.getElementById('review-target-date').textContent = wizardState.targetDate;
            document.getElementById('sync-target-date').value = wizardState.targetDate;
            document.getElementById('sync-session-key').value = wizardState.sessionKey;

            const tbody = document.getElementById('review-tbody');
            tbody.innerHTML = '';
            wizardState.previewRows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const tdNum = document.createElement('td');
                tdNum.className = 'text-muted';
                tdNum.textContent = idx + 1;
                const tdSku = document.createElement('td');
                const codeEl = document.createElement('code');
                codeEl.textContent = row.SKU;
                tdSku.appendChild(codeEl);
                const tdQty = document.createElement('td');
                tdQty.textContent = row.Quantity;
                tr.appendChild(tdNum);
                tr.appendChild(tdSku);
                tr.appendChild(tdQty);
                tbody.appendChild(tr);
            });
        }

        document.getElementById('btn-step4-back').addEventListener('click', function () {
            if (wizardState.hasSkuErrors) {
                wizard.goToStep('fix');
            } else {
                wizard.goToStep('validate');
            }
        });

        // Confirm Sync with GlobalModal
        document.getElementById('btn-confirm-sync').addEventListener('click', function () {
            requestPasswordVerify(
                'btn_sync_inventory',
                function (passwords) {
                    // Fill security inputs
                    for (const [slot, code] of Object.entries(passwords)) {
                        const input = document.querySelector(`input[name="sec_code_${slot}"]`);
                        if (input) input.value = code;
                    }
                    // Go to done step (shows loading first)
                    wizard.goToStep('done');
                    document.getElementById('done-syncing').classList.remove('d-none');
                    document.getElementById('done-result').classList.add('d-none');
                    executeSync();
                },
                document.getElementById('inv-sync-form'),
                (window.i18n?.t('js.confirm_receiving') || 'Confirm Receiving'),
                function () {
                    // Cancelled - stay on review step
                    console.log('Sync cancelled');
                }
            );
        });

        // ============================================================
        // Step 5: Done (Combined Syncing + Result)
        // ============================================================
        function executeSync() {
            const form = document.getElementById('inv-sync-form');
            const formData = new FormData(form);

            fetch('/dashboard/inventory/stocktake/inv/sync/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(r => r.text())
                .then(html => {
                    document.getElementById('done-syncing').classList.add('d-none');
                    document.getElementById('done-result').classList.remove('d-none');

                    // Extract text safely from backend response
                    const isError = html.includes('alert-danger') || html.includes((window.i18n?.t('js.security_verification_failed') || 'Security verification failed'));

                    if (isError) {
                        // Extract error message safely (textContent only)
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const alertEl = doc.querySelector('.alert-danger');
                        const errorText = alertEl ? alertEl.textContent.trim() : (window.i18n?.t('js.sync_failed_check_password') || 'Sync failed, check password or retry');

                        document.getElementById('done-icon').innerHTML = '<i class="fa-solid fa-times-circle display-3 text-danger mb-3"></i>';
                        document.getElementById('done-title').textContent = (window.i18n?.t('js.sync_failed') || 'Sync Failed');
                        document.getElementById('done-subtitle').textContent = errorText;
                        document.getElementById('done-row-count').textContent = '0';
                        document.getElementById('done-fixed-count').textContent = '0';
                        document.getElementById('done-skipped-count').textContent = '0';
                        document.getElementById('done-skipped-section').classList.add('d-none');
                    } else {
                        // Success
                        document.getElementById('done-icon').innerHTML = '<i class="fa-solid fa-check-circle display-3 text-success mb-3"></i>';
                        document.getElementById('done-title').textContent = (window.i18n?.t('js.inventory_sync_complete') || 'Inventory Sync Complete');
                        document.getElementById('done-subtitle').textContent = (window.i18n?.t('js.recorded') || 'Recorded ') + wizardState.targetDate + ' 的盘存数据';

                        document.getElementById('done-row-count').textContent = wizardState.previewRows.length;

                        const corrCount = Object.keys(wizardState.corrections).length;
                        const skipCount = wizardState.skippedSkus.length;
                        const fixedCount = corrCount - skipCount;

                        document.getElementById('done-fixed-count').textContent = fixedCount;
                        document.getElementById('done-skipped-count').textContent = skipCount;

                        // Show skipped SKU section if any
                        if (skipCount > 0) {
                            document.getElementById('done-skipped-section').classList.remove('d-none');
                            const listEl = document.getElementById('skipped-sku-list');
                            listEl.innerHTML = wizardState.skippedSkus.join(', ');
                        } else {
                            document.getElementById('done-skipped-section').classList.add('d-none');
                        }
                    }
                })
                .catch(error => {
                    document.getElementById('done-syncing').classList.add('d-none');
                    document.getElementById('done-result').classList.remove('d-none');
                    document.getElementById('done-icon').innerHTML = '<i class="fa-solid fa-times-circle display-3 text-danger mb-3"></i>';
                    document.getElementById('done-title').textContent = (window.i18n?.t('js.network_error') || 'Network Error');
                    document.getElementById('done-subtitle').textContent = (window.i18n?.t('js.check_network_retry') || 'Check network and retry');
                    console.error('Sync error:', error);
                });
        }

        // Copy skipped SKUs
        document.getElementById('btn-copy-skipped-skus').addEventListener('click', function () {
            const text = wizardState.skippedSkus.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                createAndShowToast((window.i18n?.t('js.copied') || 'Copied ') + wizardState.skippedSkus.length + ' 个 SKU', 'success');
            });
        });

        // Toggle chevron on collapse
        document.getElementById('skipped-sku-collapse').addEventListener('show.bs.collapse', function () {
            document.getElementById('skipped-chevron').classList.replace('fa-chevron-down', 'fa-chevron-up');
        });
        document.getElementById('skipped-sku-collapse').addEventListener('hide.bs.collapse', function () {
            document.getElementById('skipped-chevron').classList.replace('fa-chevron-up', 'fa-chevron-down');
        });

        document.getElementById('btn-new-round').addEventListener('click', function () {
            wizard.restart();
        });

        // ============================================================
        // Utils
        // ============================================================
        function resetWizardState() {
            wizardState = {
                sessionKey: null,
                targetDate: null,
                previewRows: [],
                skuCorrections: [],
                unknownSkus: [],
                allSkus: [],
                corrections: {},
                hasSkuErrors: false,
                skippedSkus: []
            };

            document.getElementById('inv-upload-form').reset();
            document.getElementById('inv-file-display').classList.add('d-none');
            document.getElementById('upload-dropzone').style.borderColor = 'rgba(255,255,255,0.15)';
            document.getElementById('step1-error').textContent = '';
            document.getElementById('btn-step1-next').disabled = true;
            document.getElementById('date-exists-warning').classList.add('d-none');

            document.getElementById('inv-target-date').value = new Date().toISOString().split('T')[0];
            checkDateExists(document.getElementById('inv-target-date').value);

            // Reset done step
            document.getElementById('done-syncing').classList.remove('d-none');
            document.getElementById('done-result').classList.add('d-none');
        }
    });
</script>

<style>
    /* Upload zone hover */
    .upload-zone:hover {
        border-color: rgba(25, 135, 84, 0.4) !important;
        background: rgba(25, 135, 84, 0.03) !important;
    }

    /* Fix table row states */
    #fix-sku-table tr.row-invalid {
        opacity: 0.6;
    }

    /* Unknown SKU list styling */
    .unknown-sku-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }
</style>
{% endblock %}