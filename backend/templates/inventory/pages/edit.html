{% extends "layouts/base.html" %}
{% load security_tags %}

{% block title %}Inventory Edit Wizard - Inventory - Eaglestar ERP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/global-wizard.css">
<link rel="stylesheet" href="/static/css/apple-table.css">
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard/inventory/" class="text-info text-decoration-none"
                            data-i18n="nav.inventory">Inventory</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="inventory.edit">
                        Inventory Edit Wizard</li>
                </ol>
            </nav>
            <p class="text-white-50 small mb-0 mt-1" data-i18n="ui.text_320">安全地修改或删除盘存数据</p>
        </div>
        <div>
            <a href="/dashboard/inventory/" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="inventory.back_to_hub">返回Inventory</span>
            </a>
        </div>
    </div>

    <!-- Wizard Container -->
    <div class="glass-card p-4" id="inv-edit-wizard-container" data-testid="inv-edit-wizard">

        <!-- Wizard Header -->
        <div class="wizard-header d-flex flex-column mb-4">
            <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-magic fa-2x text-info"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="inventory.edit">Inventory Edit Wizard</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_321">修改单品库存或删除整个盘存日期</p>
                </div>
            </div>
            <hr class="border-secondary border-opacity-25 my-4 w-100">
        </div>

        <!-- StepBar Anchor -->
        <div class="wizard-stepbar-anchor" data-wizard-stepbar-anchor="1"></div>

        <!-- 操作须知卡片 -->
        <div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4" data-testid="ops-guide-card">
            <div class="card-header bg-transparent border-0 d-flex align-items-center py-2">
                <i class="fas fa-info-circle text-info me-2 opacity-75"></i>
                <span class="text-white-50 small fw-bold" data-i18n="common.operation_notes">操作须知</span>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-md-6">
                        <p class="text-white small mb-2"><i class="fas fa-edit text-warning me-2"></i><strong
                                data-i18n="inventory.edit_single_title">更新单品库存</strong></p>
                        <ul class="text-white-50 small mb-0 ps-3" style="line-height: 1.8;">
                            <li data-i18n="ui.text_324">选择目标盘存日期和 SKU</li>
                            <li data-i18n="ui.text_325">输入新数量（必须为非负整数，且与原值不同）</li>
                            <li data-i18n="ui.text_326">最终确认页展示变更详情，需密码确认后<span data-i18n="ui.execute">执行</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <p class="text-white small mb-2"><i class="fas fa-trash-alt text-danger me-2"></i><strong
                                data-i18n="ui.text_327">删除盘存日期</strong></p>
                        <ul class="text-white-50 small mb-0 ps-3" style="line-height: 1.8;">
                            <li data-i18n="ui.text_328">选择要删除的盘存日期</li>
                            <li data-i18n="ui.text_329">该日期下所有 SKU 数据将被永久删除</li>
                            <li data-i18n="ui.text_330">操作不可恢复，请谨慎确认</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: 选择盘存日期 -->
        <div class="wizard-step-content active" id="step-date" data-testid="step-date">
            <div class="d-flex align-items-center mb-3">
                <i class="fa-solid fa-calendar text-info me-2"></i>
                <span class="text-white" data-i18n="ui.text_331">选择目标盘存日期</span>
            </div>
            <div class="rounded-3 p-4 mb-4"
                style="background: rgba(13, 202, 240, 0.05); border: 1px solid rgba(13, 202, 240, 0.15);">
                <label class="form-label text-white-50 small text-uppercase" data-i18n="ui.text_332">盘存日期</label>
                <select id="edit-date-select" class="form-select bg-dark text-white border-secondary">
                    {% for col in inv_columns %}
                    <option value="{{ col }}">{{ col }}</option>
                    {% empty %}
                    <option disabled data-i18n="option.o1699">无可用盘存日期</option>
                    {% endfor %}
                </select>
                <div class="form-text text-muted small mt-2" data-i18n="ui.text_2078">选择要修改或删除的盘存日期</div>
            </div>
            <div class="wizard-actions">
                <div class="wizard-actions-left"></div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-info rounded-pill px-4" id="btn-step1-next">下一步 <i
                            class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>

        <!-- Step 2: 选择操作 -->
        <div class="wizard-step-content" id="step-action" data-testid="step-action">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-hand-pointer text-info me-2"></i>
                    <span class="text-white" data-i18n="ui.text_333">选择操作类型</span>
                </div>
                <span class="badge bg-info bg-opacity-25 text-info" id="action-target-date-badge"></span>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="rounded-3 p-4 text-center action-card" id="action-modify"
                        style="background: rgba(255, 193, 7, 0.06); border: 2px solid rgba(255, 193, 7, 0.15); cursor: pointer;">
                        <i class="fas fa-edit fa-2x text-warning mb-3"></i>
                        <h6 class="text-white mb-1" data-i18n="inventory.edit_single_title">更新单品库存</h6>
                        <p class="small text-white-50 mb-0" data-i18n="ui.text_335">修正单个 SKU 的库存数值</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="rounded-3 p-4 text-center action-card" id="action-delete"
                        style="background: rgba(220, 53, 69, 0.06); border: 2px solid rgba(220, 53, 69, 0.15); cursor: pointer;">
                        <i class="fas fa-trash-alt fa-2x text-danger mb-3"></i>
                        <h6 class="text-danger mb-1" data-i18n="ui.text_327">删除盘存日期</h6>
                        <p class="small text-white-50 mb-0" data-i18n="ui.text_337">永久删除该日期的所有库存数据</p>
                    </div>
                </div>
            </div>
            <!-- Modify Form -->
            <div id="modify-form-area" class="d-none">
                <div class="rounded-3 p-4 mb-4"
                    style="background: rgba(255, 193, 7, 0.04); border: 1px solid rgba(255, 193, 7, 0.15);">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-white-50 small" data-i18n="ui.text_338">选择 SKU</label>
                            <select id="modify-sku-select" class="form-select bg-dark text-white border-secondary">
                                <option value="" data-i18n="option.o3343">请选择 SKU...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-white-50 small" data-i18n="ui.text_339">当前数值</label>
                            <div class="form-control bg-dark border-secondary text-info fw-bold"
                                id="modify-current-val">-</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-white-50 small" data-i18n="ui.text_340">新库存量</label>
                            <input type="number" id="modify-new-qty"
                                class="form-control bg-dark text-white border-secondary" min="0" step="1">
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Form -->
            <div id="delete-form-area" class="d-none">
                <div class="rounded-3 p-4 mb-4"
                    style="background: rgba(220, 53, 69, 0.06); border: 1px solid rgba(220, 53, 69, 0.2);">
                    <div class="d-flex align-items-start mb-3">
                        <i class="fa-solid fa-triangle-exclamation text-danger me-3 mt-1"></i>
                        <div>
                            <span class="text-danger fw-bold" data-i18n="ui.text_341">高危操作警告</span>
                            <p class="text-white-50 small mb-0 mt-1" data-i18n="desc.d165">您即将删除盘存日期 <code
                                    class="text-white" id="delete-target-col"></code>，这将永久移除该日期下所有 SKU 的库存数据。</p>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label text-white-50 small" data-i18n="ui.text_20">审计原因 (必填)</label>
                        <textarea id="delete-reason"
                            class="form-control bg-dark text-white border-secondary font-monospace" rows="2"
                            data-i18n-placeholder="form.placeholder.generic_3" placeholder="请说明删除原因"></textarea>
                    </div>
                </div>
            </div>
            <div id="step2-error" class="text-danger small text-center mb-3"></div>
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step2-back"><i
                            class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_prev">返回上一步</span></button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-info rounded-pill px-4" id="btn-step2-next" disabled>下一步 <i
                            class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>

        <!-- Step 3: 数据检验 (仅修改模式) -->
        <div class="wizard-step-content" id="step-validate" data-testid="step-validate">
            <div class="d-flex align-items-center mb-3">
                <i class="fa-solid fa-check-double text-warning me-2"></i>
                <span class="text-white" data-i18n="ui.text_343">数据检验</span>
            </div>
            <div id="validate-errors" class="d-none mb-4">
                <div class="rounded-3 p-3"
                    style="background: rgba(220, 53, 69, 0.08); border: 1px solid rgba(220, 53, 69, 0.2);">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fa-solid fa-times-circle text-danger me-2"></i>
                        <span class="text-danger fw-bold" data-i18n="ui.text_344">检验未通过</span>
                    </div>
                    <ul class="text-white-50 small mb-0 ps-3" id="validate-error-list"></ul>
                </div>
            </div>
            <div id="validate-success" class="d-none mb-4">
                <div class="rounded-3 p-3"
                    style="background: rgba(25, 135, 84, 0.08); border: 1px solid rgba(25, 135, 84, 0.2);">
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-check-circle text-success me-2"></i>
                        <span class="text-success" data-i18n="ui.text_268">检验通过</span>
                    </div>
                </div>
            </div>
            <p class="text-white-50 small mb-2"><i class="fa-solid fa-table me-1"></i><span
                    data-i18n="ui.icon_3140">变更预览:</span></p>
            <div class="apple-table-responsive mb-4" style="max-height: 200px;">
                <table class="apple-table apple-table-compact" id="validate-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th data-i18n="products.old_value">原值</th>
                            <th data-i18n="products.new_value">新值</th>
                            <th data-i18n="table.variance">差异</th>
                        </tr>
                    </thead>
                    <tbody id="validate-tbody"></tbody>
                </table>
            </div>
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step3-back"><i
                            class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_prev">返回上一步</span></button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success rounded-pill px-4" id="btn-step3-next" disabled>进入最终确认
                        <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>

        <!-- Step 4: 最终查验 -->
        <div class="wizard-step-content" id="step-review" data-testid="step-review">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-eye text-info me-2"></i>
                    <span class="text-white" data-i18n="js.final_confirm">最终确认</span>
                </div>
                <span class="badge" id="review-action-badge"></span>
            </div>
            <!-- Modify Review -->
            <div id="review-modify-area" class="d-none">
                <div class="rounded-3 p-4 mb-4"
                    style="background: rgba(255, 193, 7, 0.04); border: 1px solid rgba(255, 193, 7, 0.15);">
                    <p class="text-white-50 small mb-2" data-i18n="ui.text_347">即将<span
                            data-i18n="ui.execute">执行</span>以下修改:</p>
                    <div class="apple-table-responsive" style="max-height: 150px;">
                        <table class="apple-table apple-table-compact">
                            <thead>
                                <tr>
                                    <th data-i18n="ui.text_332">盘存日期</th>
                                    <th>SKU</th>
                                    <th data-i18n="products.old_value">原值</th>
                                    <th data-i18n="products.new_value">新值</th>
                                </tr>
                            </thead>
                            <tbody id="review-modify-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Delete Review -->
            <div id="review-delete-area" class="d-none">
                <div class="rounded-3 p-4 mb-4"
                    style="background: rgba(220, 53, 69, 0.06); border: 1px solid rgba(220, 53, 69, 0.2);">
                    <div class="d-flex align-items-start">
                        <i class="fa-solid fa-trash-alt text-danger me-3 fs-4"></i>
                        <div>
                            <p class="text-danger fw-bold mb-1" data-i18n="ui.text_348">即将永久删除以下盘存日期</p>
                            <p class="text-white mb-1"><span data-i18n="ui.text_2075">目标日期</span>: <code
                                    class="text-danger" id="review-delete-col"></code></p>
                            <p class="text-muted small mb-0"><span data-i18n="user_admin.delete_reason">删除原因</span>: <span
                                    id="review-delete-reason" class="text-white-50"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Hidden Forms -->
            <form id="modify-exec-form" class="d-none">
                {% csrf_token %}
                <input type="hidden" name="selected_date" id="exec-modify-date">
                <input type="hidden" name="sku" id="exec-modify-sku">
                <input type="hidden" name="new_qty" id="exec-modify-qty">
                {% security_inputs 'btn_update_single_inv' %}
            </form>
            <form id="delete-exec-form" class="d-none">
                {% csrf_token %}
                <input type="hidden" name="selected_date" id="exec-delete-date">
                <input type="hidden" name="reason" id="exec-delete-reason">
                {% security_inputs 'btn_drop_inv_col' %}
            </form>
            <div class="wizard-actions">
                <div class="wizard-actions-left">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step4-back"><i
                            class="fas fa-arrow-left me-2"></i><span data-i18n="common.back_prev">返回上一步</span></button>
                </div>
                <div class="wizard-actions-right">
                    <button type="button" class="btn btn-success rounded-pill px-4" id="btn-confirm-execute"
                        data-testid="btn-confirm-execute" data-requires-global-modal="true"><i
                            class="fas fa-check me-2"></i><span data-i18n="common.confirm">确认<span
                                data-i18n="ui.execute">执行</span></span></button>
                </div>
            </div>
        </div>

        <!-- Step 5: 完成 -->
        <div class="wizard-step-content" id="step-done" data-testid="step-done">
            <div id="done-loading" class="text-center py-5">
                <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h5 class="text-white mb-2" data-i18n="ui.text_349">正在<span data-i18n="ui.execute">执行</span>...</h5>
                <p class="text-white-50 small mb-0" data-i18n="ui.text_169">请勿关闭页面</p>
            </div>
            <div id="done-result" class="d-none">
                <div class="text-center py-4">
                    <div id="done-icon"></div>
                    <h4 class="text-white mb-2" id="done-title"></h4>
                    <p class="text-white-50 mb-0" id="done-subtitle"></p>
                </div>
                <div id="done-details" class="mb-4"></div>
                <div class="wizard-actions">
                    <div class="wizard-actions-left"></div>
                    <div class="wizard-actions-right">
                        <button type="button" class="btn btn-outline-primary rounded-pill" id="btn-new-round"><i
                                class="fas fa-redo me-2"></i><span data-i18n="ui.icon_3144">重新开始一轮</span></button>
                        <a href="/dashboard/inventory/" class="btn btn-primary rounded-pill px-4"><i
                                class="fas fa-home me-2"></i><span data-i18n="ui.icon_3145">返回Inventory</span></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // State
        let editState = {
            selectedDate: null,
            actionType: null,
            sku: null,
            currentVal: null,
            newVal: null,
            deleteReason: null,
            allSkus: []
        };

        // Initialize GlobalWizard
        const wizard = new GlobalWizard({
            containerId: 'inv-edit-wizard-container',
            steps: [
                { id: 'date', label: (window.i18n?.t('form.placeholder.generic_10') || 'Select Date'), contentSelector: '#step-date' },
                { id: 'action', label: (window.i18n?.t('js.select_operation') || 'Select Operation'), contentSelector: '#step-action' },
                { id: 'validate', label: (window.i18n?.t('js.data_check') || 'Data Check'), contentSelector: '#step-validate' },
                { id: 'review', label: (window.i18n?.t('js.final_confirm') || 'Final Confirm'), contentSelector: '#step-review' },
                { id: 'done', label: (window.i18n?.t('js.complete') || 'Complete'), type: 'done', contentSelector: '#step-done' }
            ],
            onStepChange: function (from, to) {
                if (to.id === 'date') {
                    refreshDateOptions();
                }
            },
            onRestart: function () {
                resetEditState();
                refreshDateOptions();
            }
        });

        // Refresh date options (问题2: 重新开始时刷新日期列表)
        function refreshDateOptions() {
            var select = document.getElementById('edit-date-select');
            var currentValue = select.value;

            fetch(window.location.href, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(function (r) { return r.text(); })
                .then(function (html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var newSelect = doc.getElementById('edit-date-select');
                    if (newSelect) {
                        select.innerHTML = newSelect.innerHTML;
                        if (currentValue && select.querySelector('option[value="' + currentValue + '"]')) {
                            select.value = currentValue;
                        }
                    }
                })
                .catch(function () {
                    // Silent fail - keep existing options
                });
        }

        // Step 1
        document.getElementById('btn-step1-next').addEventListener('click', function () {
            editState.selectedDate = document.getElementById('edit-date-select').value;
            if (!editState.selectedDate) return;
            document.getElementById('action-target-date-badge').textContent = editState.selectedDate;
            document.getElementById('delete-target-col').textContent = editState.selectedDate;
            wizard.goToStep('action');
            loadSkuList();
        });

        // Step 2 - Action selection
        var actionModify = document.getElementById('action-modify');
        var actionDelete = document.getElementById('action-delete');
        var modifyFormArea = document.getElementById('modify-form-area');
        var deleteFormArea = document.getElementById('delete-form-area');
        var btnStep2Next = document.getElementById('btn-step2-next');

        actionModify.addEventListener('click', function () {
            editState.actionType = 'MODIFY';
            actionModify.style.borderColor = 'rgba(255, 193, 7, 0.6)';
            actionModify.style.background = 'rgba(255, 193, 7, 0.12)';
            actionDelete.style.borderColor = 'rgba(220, 53, 69, 0.15)';
            actionDelete.style.background = 'rgba(220, 53, 69, 0.06)';
            modifyFormArea.classList.remove('d-none');
            deleteFormArea.classList.add('d-none');
            updateStep2NextButton();
        });

        actionDelete.addEventListener('click', function () {
            editState.actionType = 'DELETE';
            actionDelete.style.borderColor = 'rgba(220, 53, 69, 0.6)';
            actionDelete.style.background = 'rgba(220, 53, 69, 0.12)';
            actionModify.style.borderColor = 'rgba(255, 193, 7, 0.15)';
            actionModify.style.background = 'rgba(255, 193, 7, 0.06)';
            deleteFormArea.classList.remove('d-none');
            modifyFormArea.classList.add('d-none');
            updateStep2NextButton();
        });

        function loadSkuList() {
            var formData = new FormData();
            formData.append('selected_date', editState.selectedDate);
            formData.append('action_type', 'MODIFY');
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('/dashboard/inventory/stocktake/modify/data_change/wizard/step3/', {
                method: 'POST',
                body: formData
            })
                .then(function (r) { return r.text(); })
                .then(function (html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var select = document.getElementById('modify-sku-select');
                    select.innerHTML = '<option value="" data-i18n="option.o3343">请选择 SKU...</option>';
                    var sourceOptions = doc.querySelectorAll('select[name="sku"] option');
                    sourceOptions.forEach(function (opt) {
                        if (opt.value) {
                            var newOpt = document.createElement('option');
                            newOpt.value = opt.value;
                            newOpt.textContent = opt.textContent;
                            select.appendChild(newOpt);
                            editState.allSkus.push(opt.value);
                        }
                    });
                })
                .catch(function () {
                    // Silent fail
                });
        }

        document.getElementById('modify-sku-select').addEventListener('change', function () {
            editState.sku = this.value;
            if (!this.value) {
                document.getElementById('modify-current-val').textContent = '-';
                editState.currentVal = null;
                updateStep2NextButton();
                return;
            }
            var formData = new FormData();
            formData.append('selected_date', editState.selectedDate);
            formData.append('sku', this.value);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('/dashboard/inventory/stocktake/modify/data_change/api/get_sku_val/', {
                method: 'POST',
                body: formData
            })
                .then(function (r) { return r.text(); })
                .then(function (val) {
                    editState.currentVal = parseInt(val) || 0;
                    document.getElementById('modify-current-val').textContent = val;
                    updateStep2NextButton();
                });
        });

        document.getElementById('modify-new-qty').addEventListener('input', function () {
            editState.newVal = this.value;
            updateStep2NextButton();
        });

        document.getElementById('delete-reason').addEventListener('input', function () {
            editState.deleteReason = this.value.trim();
            updateStep2NextButton();
        });

        function updateStep2NextButton() {
            if (editState.actionType === 'MODIFY') {
                btnStep2Next.disabled = !(editState.sku && editState.newVal !== '' && editState.newVal !== null);
            } else if (editState.actionType === 'DELETE') {
                btnStep2Next.disabled = !editState.deleteReason;
            } else {
                btnStep2Next.disabled = true;
            }
        }

        document.getElementById('btn-step2-back').addEventListener('click', function () { wizard.goToStep('date'); });

        document.getElementById('btn-step2-next').addEventListener('click', function () {
            if (editState.actionType === 'MODIFY') {
                wizard.goToStep('validate');
                runValidation();
            } else if (editState.actionType === 'DELETE') {
                wizard.goToStep('review');
                initReviewStep();
            }
        });

        // Step 3: Validation
        function runValidation() {
            var errorsEl = document.getElementById('validate-errors');
            var errorListEl = document.getElementById('validate-error-list');
            var successEl = document.getElementById('validate-success');
            var btnNext = document.getElementById('btn-step3-next');
            var tbody = document.getElementById('validate-tbody');

            errorsEl.classList.add('d-none');
            successEl.classList.add('d-none');
            errorListEl.innerHTML = '';
            tbody.innerHTML = '';
            btnNext.disabled = true;

            var errors = [];
            var newVal = editState.newVal;
            var numVal = parseFloat(newVal);

            if (isNaN(numVal)) {
                errors.push((window.i18n?.t('js.new_value_must_be_number') || 'New value must be a number'));
            } else if (numVal < 0) {
                errors.push((window.i18n?.t('js.new_value_cannot_negative') || 'New value cannot be negative'));
            } else if (!Number.isInteger(numVal)) {
                errors.push((window.i18n?.t('js.new_value_must_be_integer') || 'New value must be integer'));
            }
            if (parseInt(newVal) === editState.currentVal) {
                errors.push((window.i18n?.t('js.new_value_same_no_change') || 'New value same, no change needed'));
            }

            var tr = document.createElement('tr');
            var diff = parseInt(newVal) - editState.currentVal;
            var diffStr = diff > 0 ? '+' + diff : '' + diff;
            var diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : 'text-muted');

            var tdSku = document.createElement('td');
            var codeSku = document.createElement('code');
            codeSku.textContent = editState.sku;
            tdSku.appendChild(codeSku);

            var tdOld = document.createElement('td');
            tdOld.textContent = editState.currentVal;

            var tdNew = document.createElement('td');
            tdNew.textContent = newVal;
            tdNew.className = errors.length > 0 ? 'text-danger fw-bold' : 'text-success';

            var tdDiff = document.createElement('td');
            tdDiff.textContent = errors.length > 0 ? '-' : diffStr;
            tdDiff.className = diffClass;

            tr.appendChild(tdSku);
            tr.appendChild(tdOld);
            tr.appendChild(tdNew);
            tr.appendChild(tdDiff);

            if (errors.length > 0) {
                tr.style.background = 'rgba(220, 53, 69, 0.08)';
            }
            tbody.appendChild(tr);

            if (errors.length > 0) {
                errorsEl.classList.remove('d-none');
                errors.forEach(function (e) {
                    var li = document.createElement('li');
                    li.textContent = e;
                    errorListEl.appendChild(li);
                });
            } else {
                successEl.classList.remove('d-none');
                btnNext.disabled = false;
            }
        }

        document.getElementById('btn-step3-back').addEventListener('click', function () { wizard.goToStep('action'); });
        document.getElementById('btn-step3-next').addEventListener('click', function () {
            wizard.goToStep('review');
            initReviewStep();
        });

        // Step 4: Review
        function initReviewStep() {
            var modifyArea = document.getElementById('review-modify-area');
            var deleteArea = document.getElementById('review-delete-area');
            var badge = document.getElementById('review-action-badge');
            var execBtn = document.getElementById('btn-confirm-execute');

            modifyArea.classList.add('d-none');
            deleteArea.classList.add('d-none');

            if (editState.actionType === 'MODIFY') {
                modifyArea.classList.remove('d-none');
                badge.className = 'badge bg-warning text-dark';
                badge.textContent = (window.i18n?.t('js.update_mode') || 'Update Mode');
                execBtn.setAttribute('data-action-key', 'btn_update_single_inv');

                var tbody = document.getElementById('review-modify-tbody');
                tbody.innerHTML = '';
                var tr = document.createElement('tr');

                var tdDate = document.createElement('td');
                var codeDate = document.createElement('code');
                codeDate.textContent = editState.selectedDate;
                tdDate.appendChild(codeDate);

                var tdSku = document.createElement('td');
                var codeSku = document.createElement('code');
                codeSku.textContent = editState.sku;
                tdSku.appendChild(codeSku);

                var tdOld = document.createElement('td');
                tdOld.textContent = editState.currentVal;

                var tdNew = document.createElement('td');
                tdNew.textContent = editState.newVal;
                tdNew.className = 'text-success fw-bold';

                tr.appendChild(tdDate);
                tr.appendChild(tdSku);
                tr.appendChild(tdOld);
                tr.appendChild(tdNew);
                tbody.appendChild(tr);

                document.getElementById('exec-modify-date').value = editState.selectedDate;
                document.getElementById('exec-modify-sku').value = editState.sku;
                document.getElementById('exec-modify-qty').value = editState.newVal;

            } else if (editState.actionType === 'DELETE') {
                deleteArea.classList.remove('d-none');
                badge.className = 'badge bg-danger';
                badge.textContent = (window.i18n?.t('js.delete_mode') || 'Delete Mode');
                execBtn.setAttribute('data-action-key', 'btn_drop_inv_col');

                document.getElementById('review-delete-col').textContent = editState.selectedDate;
                document.getElementById('review-delete-reason').textContent = editState.deleteReason;

                document.getElementById('exec-delete-date').value = editState.selectedDate;
                document.getElementById('exec-delete-reason').value = editState.deleteReason;
            }
        }

        document.getElementById('btn-step4-back').addEventListener('click', function () {
            if (editState.actionType === 'MODIFY') {
                wizard.goToStep('validate');
            } else {
                wizard.goToStep('action');
            }
        });

        // Confirm with GlobalModal
        document.getElementById('btn-confirm-execute').addEventListener('click', function () {
            var actionKey = this.getAttribute('data-action-key');
            var actionDisplay = editState.actionType === 'MODIFY' ? '确认更新' : (window.i18n?.t('js.confirm_delete') || 'Confirm Delete');

            requestPasswordVerify(
                actionKey,
                function (passwords) {
                    var formId = editState.actionType === 'MODIFY' ? 'modify-exec-form' : 'delete-exec-form';
                    var form = document.getElementById(formId);
                    for (var slot in passwords) {
                        var input = form.querySelector('input[name="sec_code_' + slot + '"]');
                        if (input) input.value = passwords[slot];
                    }
                    wizard.goToStep('done');
                    document.getElementById('done-loading').classList.remove('d-none');
                    document.getElementById('done-result').classList.add('d-none');
                    executeAction(form);
                },
                editState.actionType === 'MODIFY' ? document.getElementById('modify-exec-form') : document.getElementById('delete-exec-form'),
                actionDisplay,
                function () {
                    // Cancelled - stay on review step
                }
            );
        });

        // Step 5: Done
        function executeAction(form) {
            var formData = new FormData(form);
            var isModify = editState.actionType === 'MODIFY';
            var endpoint = isModify
                ? '/dashboard/inventory/stocktake/modify/data_change/execute/inventory/'
                : '/dashboard/inventory/stocktake/modify/data_change/execute/drop_col/';

            fetch(endpoint, { method: 'POST', body: formData })
                .then(function (r) { return r.text(); })
                .then(function (html) {
                    document.getElementById('done-loading').classList.add('d-none');
                    document.getElementById('done-result').classList.remove('d-none');

                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var alertEl = doc.querySelector('.alert');
                    var isSuccess = alertEl && alertEl.classList.contains('alert-success');

                    // 安全提取纯文本，移除敏感信息
                    var message = '';
                    if (alertEl) {
                        message = alertEl.textContent.trim();
                        // 脱敏：移除可能的敏感信息
                        message = message.replace(/\/[^\s]+\.(py|html|js)/gi, '');
                        message = message.replace(/Traceback.*/gi, '');
                        message = message.replace(/File\s+"[^"]+"/gi, '');
                    }

                    var iconEl = document.getElementById('done-icon');
                    var titleEl = document.getElementById('done-title');
                    var subtitleEl = document.getElementById('done-subtitle');
                    var detailsEl = document.getElementById('done-details');

                    if (isSuccess) {
                        iconEl.innerHTML = '<i class="fa-solid fa-check-circle display-3 text-success mb-3"></i>';
                        titleEl.textContent = isModify ? (window.i18n?.t('js.inventory_updated') || 'Inventory Updated') : (window.i18n?.t('js.stocktake_deleted') || 'Stocktake Date Deleted');
                        subtitleEl.textContent = isModify ? (window.i18n?.t('js.inventory_update_success') || 'Inventory update successful') : (window.i18n?.t('js.stocktake_delete_success') || 'Stocktake date deleted');

                        if (isModify) {
                            var detailDiv = document.createElement('div');
                            detailDiv.className = 'rounded-3 p-3';
                            detailDiv.style.cssText = 'background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);';

                            var detailTitle = document.createElement('p');
                            detailTitle.className = 'text-white-50 small mb-2';
                            detailTitle.textContent = (window.i18n?.t('js.change_details_colon') || 'Change Details:');

                            var detailContent = document.createElement('div');
                            detailContent.className = 'd-flex justify-content-between align-items-center text-white';

                            var skuCode = document.createElement('code');
                            skuCode.textContent = editState.sku;

                            var changeSpan = document.createElement('span');
                            changeSpan.innerHTML = editState.currentVal + ' → <span class="text-success fw-bold">' + editState.newVal + '</span>';

                            detailContent.appendChild(skuCode);
                            detailContent.appendChild(changeSpan);
                            detailDiv.appendChild(detailTitle);
                            detailDiv.appendChild(detailContent);

                            detailsEl.innerHTML = '';
                            detailsEl.appendChild(detailDiv);
                        } else {
                            var deleteDiv = document.createElement('div');
                            deleteDiv.className = 'rounded-3 p-3';
                            deleteDiv.style.cssText = 'background: rgba(220, 53, 69, 0.05); border: 1px solid rgba(220, 53, 69, 0.15); max-height: 40vh; overflow-y: auto;';

                            var deleteTitle = document.createElement('p');
                            deleteTitle.className = 'text-white-50 small mb-2';
                            deleteTitle.textContent = (window.i18n?.t('js.deleted_stocktake_colon') || 'Deleted Stocktake Date:');

                            var dateCode = document.createElement('code');
                            dateCode.className = 'text-danger';
                            dateCode.textContent = editState.selectedDate;

                            var reasonP = document.createElement('p');
                            reasonP.className = 'text-muted small mt-2 mb-0';
                            reasonP.textContent = (window.i18n?.t('js.delete_reason_colon') || 'Delete Reason: ') + editState.deleteReason;

                            deleteDiv.appendChild(deleteTitle);
                            deleteDiv.appendChild(dateCode);
                            deleteDiv.appendChild(reasonP);

                            detailsEl.innerHTML = '';
                            detailsEl.appendChild(deleteDiv);
                        }
                    } else {
                        iconEl.innerHTML = '<i class="fa-solid fa-times-circle display-3 text-danger mb-3"></i>';
                        titleEl.textContent = (window.i18n?.t('js.operation_failed') || 'Operation Failed');
                        // 脱敏后显示用户友好的错误消息
                        subtitleEl.textContent = message || (window.i18n?.t('js.operation_failed_retry') || 'Operation failed, retry later');
                        detailsEl.innerHTML = '';
                    }
                })
                .catch(function () {
                    document.getElementById('done-loading').classList.add('d-none');
                    document.getElementById('done-result').classList.remove('d-none');
                    document.getElementById('done-icon').innerHTML = '<i class="fa-solid fa-times-circle display-3 text-danger mb-3"></i>';
                    document.getElementById('done-title').textContent = (window.i18n?.t('js.network_error') || 'Network Error');
                    document.getElementById('done-subtitle').textContent = (window.i18n?.t('js.check_network_retry') || 'Check network and retry');
                    document.getElementById('done-details').innerHTML = '';
                });
        }

        document.getElementById('btn-new-round').addEventListener('click', function () {
            wizard.restart();
        });

        function resetEditState() {
            editState = { selectedDate: null, actionType: null, sku: null, currentVal: null, newVal: null, deleteReason: null, allSkus: [] };
            document.getElementById('action-modify').style.borderColor = 'rgba(255, 193, 7, 0.15)';
            document.getElementById('action-modify').style.background = 'rgba(255, 193, 7, 0.06)';
            document.getElementById('action-delete').style.borderColor = 'rgba(220, 53, 69, 0.15)';
            document.getElementById('action-delete').style.background = 'rgba(220, 53, 69, 0.06)';
            document.getElementById('modify-form-area').classList.add('d-none');
            document.getElementById('delete-form-area').classList.add('d-none');
            document.getElementById('modify-sku-select').innerHTML = '<option value="" data-i18n="option.o3343">请选择 SKU...</option>';
            document.getElementById('modify-current-val').textContent = '-';
            document.getElementById('modify-new-qty').value = '';
            document.getElementById('delete-reason').value = '';
            document.getElementById('btn-step2-next').disabled = true;
            document.getElementById('done-loading').classList.remove('d-none');
            document.getElementById('done-result').classList.add('d-none');
        }
    });
</script>
<style>
    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}