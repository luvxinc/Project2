<!-- log/tabs/error.html - 错误日志 Tab -->
{% load log_filters %}
<div class="py-3">
    <!-- 筛选栏 -->
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <div class="flex-grow-1">
            <input type="text" class="form-control bg-dark border-secondary text-white" id="error-search" 
                   data-i18n-placeholder="log.search_placeholder.error" placeholder="搜索错误信息、类型、路径..." value="{{ filter.q }}"
                   style="background: rgba(0,0,0,0.3) !important;">
        </div>
        <select class="form-select bg-dark border-secondary text-white" style="width: 140px; background: rgba(0,0,0,0.3) !important;" id="error-severity">
            <option value="" data-i18n="log.filter.all_severity">严重程度</option>
            <option value="CRITICAL" {% if filter.severity == 'CRITICAL' %}selected{% endif %} data-i18n="option.o3348">严重</option>
            <option value="HIGH" {% if filter.severity == 'HIGH' %}selected{% endif %} data-i18n="option.o2728">高</option>
            <option value="MEDIUM" {% if filter.severity == 'MEDIUM' %}selected{% endif %} data-i18n="option.o3184">中</option>
            <option value="LOW" {% if filter.severity == 'LOW' %}selected{% endif %} data-i18n="option.o9700">低</option>
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 120px; background: rgba(0,0,0,0.3) !important;" id="error-resolved">
            <option value="" data-i18n="common.status">状态</option>
            <option value="no" {% if filter.resolved == 'no' %}selected{% endif %} data-i18n="log.stats.unresolved">未解决</option>
            <option value="yes" {% if filter.resolved == 'yes' %}selected{% endif %} data-i18n="log.filter.resolved">已解决</option>
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 110px; background: rgba(0,0,0,0.3) !important;" id="error-days">
            <option value="1" {% if filter.days == 1 %}selected{% endif %} data-i18n="ui.icon_3122">今天</option>
            <option value="7" {% if filter.days == 7 %}selected{% endif %} data-i18n="option.o1826">7 天</option>
            <option value="30" {% if filter.days == 30 %}selected{% endif %} data-i18n="option.o5443">30 天</option>
            <option value="0" {% if filter.days == 0 %}selected{% endif %} data-i18n="ui.text_1280">全部</option>
        </select>
        <button class="btn btn-outline-info" onclick="filterErrors()">
            <i class="fas fa-search"></i>
        </button>
    </div>
    
    <!-- 统计 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-white-50">共 {{ total_count }} 条记录</small>
    </div>
    
    <!-- 错误列表 -->
    {% if logs %}
    <div class="log-table-container">
        <table class="log-table">
            <thead>
                <tr>
                    <th style="width: 140px;" data-i18n="log.table.time">时间</th>
                    <th style="width: 70px;" data-i18n="log.table.severity">严重性</th>
                    <th style="width: 140px;" data-i18n="log.table.type">类型</th>
                    <th data-i18n="log.table.message">错误信息</th>
                    <th style="width: 140px;" data-i18n="log.table.path">路径</th>
                    <th style="width: 70px;" data-i18n="log.table.user">用户</th>
                    <th style="width: 70px;" data-i18n="common.status">状态</th>
                    <th style="width: 50px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="{% if not log.is_resolved %}row-unresolved{% endif %}">
                    <td class="text-white-50" style="font-size: 11px;">{{ log.created_at|date:"m-d H:i:s" }}</td>
                    <td>
                        <span class="severity-badge severity-{{ log.severity|lower }}">{{ log.severity }}</span>
                    </td>
                    <td>
                        <code class="text-info" style="font-size: 11px;">{{ log.error_type|truncatechars:18 }}</code>
                    </td>
                    <td>
                        <div class="text-truncate text-white" style="max-width: 350px; font-size: 12px;" title="{{ log.error_message }}">
                            {{ log.error_message|truncatechars:50 }}
                        </div>
                    </td>
                    <td>
                        <small class="text-white-50" style="font-size: 11px;">{{ log.request_path|default:"-"|truncatechars:22 }}</small>
                    </td>
                    <td class="text-white-50" style="font-size: 11px;">{{ log.user|mask_user:god_mode|truncatechars:8 }}</td>
                    <td>
                        {% if log.is_resolved %}
                        <span class="status-badge status-resolved" data-i18n="log.filter.resolved">已解决</span>
                        {% else %}
                        <span class="status-badge status-pending" data-i18n="abnormal.status_pending">待处理</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-link text-info p-0" onclick="showErrorDetail({{ log.id }})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    {% if logs.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if logs.has_previous %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('error', 'page={{ logs.previous_page_number }}&q={{ filter.q }}&severity={{ filter.severity }}&resolved={{ filter.resolved }}&days={{ filter.days }}')" data-i18n="common.prev_page">上一页</button>
            </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link bg-dark border-secondary text-white-50">{{ logs.number }} / {{ logs.paginator.num_pages }}</span>
            </li>
            {% if logs.has_next %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('error', 'page={{ logs.next_page_number }}&q={{ filter.q }}&severity={{ filter.severity }}&resolved={{ filter.resolved }}&days={{ filter.days }}')" data-i18n="common.next_page">下一页</button>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="text-center text-white-50 py-5">
        <i class="fas fa-check-circle fa-2x mb-3" style="opacity: 0.5;"></i>
        <p class="mb-0" data-i18n="ui.text_1174">没有错误记录</p>
    </div>
    {% endif %}
</div>

<style>
/* 表格容器 */
.log-table-container {
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

.log-table {
    width: 100%;
    border-collapse: collapse;
}

/* 表头 */
.log-table thead {
    background: rgba(255, 255, 255, 0.03);
}

.log-table thead th {
    padding: 12px 10px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: rgba(255, 255, 255, 0.5);
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

/* 数据行 */
.log-table tbody tr {
    transition: background 0.15s;
}

.log-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

.log-table tbody tr.row-unresolved {
    background: rgba(255, 193, 7, 0.03);
}

.log-table tbody tr.row-unresolved:hover {
    background: rgba(255, 193, 7, 0.06);
}

.log-table tbody td {
    padding: 10px;
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

/* 严重性徽章 */
.severity-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 500;
}

.severity-critical {
    background: rgba(220, 38, 38, 0.15);
    color: #f87171;
    border: 1px solid rgba(220, 38, 38, 0.3);
}

.severity-high {
    background: rgba(234, 88, 12, 0.15);
    color: #fb923c;
    border: 1px solid rgba(234, 88, 12, 0.3);
}

.severity-medium {
    background: rgba(202, 138, 4, 0.15);
    color: #fbbf24;
    border: 1px solid rgba(202, 138, 4, 0.3);
}

.severity-low {
    background: rgba(22, 163, 74, 0.15);
    color: #4ade80;
    border: 1px solid rgba(22, 163, 74, 0.3);
}

/* 状态徽章 */
.status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 500;
}

.status-resolved {
    background: rgba(22, 163, 74, 0.15);
    color: #4ade80;
    border: 1px solid rgba(22, 163, 74, 0.25);
}

.status-pending {
    background: rgba(255, 193, 7, 0.1);
    color: #fbbf24;
    border: 1px solid rgba(255, 193, 7, 0.2);
}
</style>

<!-- 错误详情 Modal -->
<div class="modal fade" id="errorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" data-i18n="ui.text_272">错误详情</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="errorDetailContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-info"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filterErrors() {
    var q = document.getElementById('error-search').value;
    var severity = document.getElementById('error-severity').value;
    var resolved = document.getElementById('error-resolved').value;
    var days = document.getElementById('error-days').value;
    
    var params = new URLSearchParams({q: q, severity: severity, resolved: resolved, days: days});
    window.location.href = '/log/tab/error/?' + params.toString();
}

function showErrorDetail(id) {
    var modal = new bootstrap.Modal(document.getElementById('errorDetailModal'));
    var content = document.getElementById('errorDetailContent');
    
    content.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-info"></div></div>';
    modal.show();
    
    fetch('/log/api/error/' + id + '/')
        .then(function(res) { return res.json(); })
        .then(function(data) {
            content.innerHTML = 
                '<div class="row g-4">' +
                    '<div class="col-md-6">' +
                        '<h6 class="text-white-50 mb-3"><i class="fas fa-info-circle me-2"></i>基本信息</h6>' +
                        '<div class="p-3 rounded" style="background: rgba(0,0,0,0.2);">' +
                            '<table class="table table-sm table-borderless mb-0">' +
                                '<tr><td class="text-white-50" width="80" data-i18n="log.table.time">时间</td><td class="text-white">' + data.created_at + '</td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="log.table.user">用户</td><td class="text-white">' + (data.user || '-') + '</td></tr>' +
                                '<tr><td class="text-white-50">IP</td><td class="text-white">' + (data.ip || '-') + '</td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="log.table.path">路径</td><td><code class="text-info">' + (data.request_path || '-') + '</code></td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="log.table.method">方法</td><td class="text-white">' + (data.http_method || '-') + '</td></tr>' +
                            '</table>' +
                        '</div>' +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<h6 class="text-white-50 mb-3"><i class="fas fa-bug me-2"></i>错误信息</h6>' +
                        '<div class="p-3 rounded" style="background: rgba(0,0,0,0.2);">' +
                            '<table class="table table-sm table-borderless mb-0">' +
                                '<tr><td class="text-white-50" width="80" data-i18n="log.table.type">类型</td><td><code class="text-danger">' + data.error_type + '</code></td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="ui.text_2447">严重性</td><td><span class="severity-badge severity-' + data.severity.toLowerCase() + '">' + data.severity + '</span></td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="log.filter.all_category">分类</td><td class="text-white">' + (data.category || '-') + '</td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="purchase.file">文件</td><td><code class="text-info">' + (data.file_path || '-') + ':' + (data.line_number || '-') + '</code></td></tr>' +
                                '<tr><td class="text-white-50" data-i18n="ui.text_2450">函数</td><td><code class="text-info">' + (data.function_name || '-') + '</code></td></tr>' +
                            '</table>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<h6 class="text-white-50 mt-4 mb-3"><i class="fas fa-exclamation-circle me-2"></i>错误消息</h6>' +
                '<div class="p-3 rounded" style="background: rgba(220, 53, 69, 0.08); border: 1px solid rgba(220, 53, 69, 0.2);">' +
                    '<span class="text-white" style="word-break: break-all;">' + data.error_message + '</span>' +
                '</div>' +
                (data.traceback_full ? 
                    '<h6 class="text-white-50 mt-4 mb-3"><i class="fas fa-layer-group me-2"></i>完整堆栈</h6>' +
                    '<pre class="p-3 rounded mb-0" style="background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.7); max-height: 350px; overflow: auto; font-size: 11px;">' + data.traceback_full + '</pre>'
                : '') +
                (data.local_variables ? 
                    '<h6 class="text-white-50 mt-4 mb-3"><i class="fas fa-code me-2"></i>局部变量</h6>' +
                    '<pre class="p-3 rounded mb-0" style="background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.6); max-height: 180px; overflow: auto; font-size: 11px;">' + data.local_variables + '</pre>'
                : '');
        })
        .catch(function(err) {
            content.innerHTML = '<div class="p-3 rounded text-center" style="background: rgba(220, 53, 69, 0.1);"><span class="text-danger" data-i18n="ui.text_1176">加载失败: ' + err + '</span></div>';
        });
}

// 回车搜索
document.getElementById('error-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') filterErrors();
});
</script>