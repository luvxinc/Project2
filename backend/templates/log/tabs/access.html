<!-- log/tabs/access.html - 访问日志 Tab -->
{% load log_filters %}
<div class="py-3">
    <!-- 筛选栏 -->
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <div class="flex-grow-1">
            <input type="text" class="form-control bg-dark border-secondary text-white" id="access-search" 
                   data-i18n-placeholder="log.search_placeholder.access" placeholder="搜索路径、用户、IP..." value="{{ filter.q }}"
                   style="background: rgba(0,0,0,0.3) !important;">
        </div>
        <select class="form-select bg-dark border-secondary text-white" style="width: 120px; background: rgba(0,0,0,0.3) !important;" id="access-method">
            <option value="" data-i18n="log.filter.all_method">全部方法</option>
            <option value="GET" {% if filter.method == 'GET' %}selected{% endif %}>GET</option>
            <option value="POST" {% if filter.method == 'POST' %}selected{% endif %}>POST</option>
            <option value="PUT" {% if filter.method == 'PUT' %}selected{% endif %}>PUT</option>
            <option value="DELETE" {% if filter.method == 'DELETE' %}selected{% endif %}>DELETE</option>
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 130px; background: rgba(0,0,0,0.3) !important;" id="access-status">
            <option value="" data-i18n="log.filter.all_status">全部状态</option>
            <option value="error" {% if filter.status == 'error' %}selected{% endif %} data-i18n="option.o614">错误(4xx/5xx)</option>
            <option value="slow" {% if filter.status == 'slow' %}selected{% endif %} data-i18n="option.o9239">慢请求(>3s)</option>
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 110px; background: rgba(0,0,0,0.3) !important;" id="access-days">
            <option value="1" {% if filter.days == 1 %}selected{% endif %} data-i18n="ui.icon_3122">今天</option>
            <option value="3" {% if filter.days == 3 %}selected{% endif %} data-i18n="option.o5280">3 天</option>
            <option value="7" {% if filter.days == 7 %}selected{% endif %} data-i18n="option.o1826">7 天</option>
            <option value="0" {% if filter.days == 0 %}selected{% endif %} data-i18n="ui.text_1280">全部</option>
        </select>
        <button class="btn btn-outline-info" onclick="filterAccess()">
            <i class="fas fa-search"></i>
        </button>
    </div>
    
    <!-- 统计 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-white-50">共 {{ total_count }} 条记录</small>
    </div>
    
    <!-- 访问日志列表 -->
    {% if logs %}
    <div class="log-table-container">
        <table class="log-table">
            <thead>
                <tr>
                    <th style="width: 120px;" data-i18n="log.table.time">时间</th>
                    <th style="width: 60px;" data-i18n="log.table.method">方法</th>
                    <th data-i18n="log.table.path">路径</th>
                    <th style="width: 60px;" data-i18n="common.status">状态</th>
                    <th style="width: 70px;" data-i18n="log.table.duration">耗时</th>
                    <th style="width: 70px;" data-i18n="log.table.user">用户</th>
                    <th style="width: 100px;" data-i18n="log.table.ip">IP</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="{% if log.status_code >= 500 %}row-error{% elif log.status_code >= 400 %}row-warning{% endif %}">
                    <td class="text-white-50" style="font-size: 11px;">{{ log.created_at|date:"m-d H:i:s" }}</td>
                    <td>
                        <span class="method-badge method-{{ log.method|lower }}">{{ log.method }}</span>
                    </td>
                    <td>
                        <code class="text-info" style="font-size: 11px;" title="{{ log.path }}">{{ log.path|truncatechars:45 }}</code>
                        {% if log.query_string %}
                        <small class="text-white-50 d-block" style="font-size: 10px;" title="{{ log.query_string }}">?{{ log.query_string|truncatechars:35 }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-code-badge {% if log.status_code >= 500 %}status-5xx{% elif log.status_code >= 400 %}status-4xx{% elif log.status_code >= 300 %}status-3xx{% else %}status-2xx{% endif %}">
                            {{ log.status_code }}
                        </span>
                    </td>
                    <td>
                        <small class="{% if log.response_time_ms > 3000 %}text-warning{% elif log.response_time_ms > 1000 %}text-white-50{% else %}text-white-50{% endif %}" style="font-size: 11px;">
                            {{ log.response_time_ms }}ms
                        </small>
                    </td>
                    <td class="text-white-50" style="font-size: 11px;">{{ log.user|mask_user:god_mode|default:"-"|truncatechars:8 }}</td>
                    <td class="text-white-50" style="font-size: 11px;">{{ log.ip|mask_ip:god_mode|truncatechars:13 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    {% if logs.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if logs.has_previous %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('access', 'page={{ logs.previous_page_number }}&q={{ filter.q }}&method={{ filter.method }}&status={{ filter.status }}&days={{ filter.days }}')" data-i18n="common.prev_page">上一页</button>
            </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link bg-dark border-secondary text-white-50">{{ logs.number }} / {{ logs.paginator.num_pages }}</span>
            </li>
            {% if logs.has_next %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('access', 'page={{ logs.next_page_number }}&q={{ filter.q }}&method={{ filter.method }}&status={{ filter.status }}&days={{ filter.days }}')" data-i18n="common.next_page">下一页</button>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="text-center text-white-50 py-5">
        <i class="fas fa-globe fa-2x mb-3" style="opacity: 0.4;"></i>
        <p class="mb-0" data-i18n="ui.text_1141">没有访问记录</p>
    </div>
    {% endif %}
</div>

<style>
/* 表格容器 */
.log-table-container {
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

.log-table {
    width: 100%;
    border-collapse: collapse;
}

/* 表头 */
.log-table thead {
    background: rgba(255, 255, 255, 0.03);
}

.log-table thead th {
    padding: 12px 10px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: rgba(255, 255, 255, 0.5);
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

/* 数据行 */
.log-table tbody tr {
    transition: background 0.15s;
}

.log-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

.log-table tbody tr.row-warning {
    background: rgba(255, 193, 7, 0.03);
}

.log-table tbody tr.row-warning:hover {
    background: rgba(255, 193, 7, 0.06);
}

.log-table tbody tr.row-error {
    background: rgba(220, 53, 69, 0.03);
}

.log-table tbody tr.row-error:hover {
    background: rgba(220, 53, 69, 0.06);
}

.log-table tbody td {
    padding: 8px 10px;
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

/* HTTP 方法徽章 */
.method-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 600;
}

.method-get {
    background: rgba(13, 110, 253, 0.15);
    color: #60a5fa;
    border: 1px solid rgba(13, 110, 253, 0.3);
}

.method-post {
    background: rgba(22, 163, 74, 0.15);
    color: #4ade80;
    border: 1px solid rgba(22, 163, 74, 0.3);
}

.method-put {
    background: rgba(255, 193, 7, 0.12);
    color: #fbbf24;
    border: 1px solid rgba(255, 193, 7, 0.25);
}

.method-delete {
    background: rgba(220, 53, 69, 0.15);
    color: #f87171;
    border: 1px solid rgba(220, 53, 69, 0.3);
}

/* 状态码徽章 */
.status-code-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
}

.status-2xx {
    background: rgba(22, 163, 74, 0.15);
    color: #4ade80;
    border: 1px solid rgba(22, 163, 74, 0.25);
}

.status-3xx {
    background: rgba(13, 202, 240, 0.12);
    color: #67e8f9;
    border: 1px solid rgba(13, 202, 240, 0.25);
}

.status-4xx {
    background: rgba(255, 193, 7, 0.12);
    color: #fbbf24;
    border: 1px solid rgba(255, 193, 7, 0.25);
}

.status-5xx {
    background: rgba(220, 53, 69, 0.15);
    color: #f87171;
    border: 1px solid rgba(220, 53, 69, 0.3);
}
</style>

<script>
function filterAccess() {
    var q = document.getElementById('access-search').value;
    var method = document.getElementById('access-method').value;
    var status = document.getElementById('access-status').value;
    var days = document.getElementById('access-days').value;
    
    var params = new URLSearchParams({q: q, method: method, status: status, days: days});
    window.location.href = '/log/tab/access/?' + params.toString();
}

document.getElementById('access-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') filterAccess();
});
</script>