<!-- log/tabs/audit.html - 安全审计 Tab -->
{% load log_filters %}
<div class="py-3">
    <!-- 筛选栏 -->
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <div class="flex-grow-1">
            <input type="text" class="form-control bg-dark border-secondary text-white" id="audit-search" 
                   data-i18n-placeholder="log.search_placeholder.audit" placeholder="搜索用户、操作、目标..." value="{{ filter.q }}"
                   style="background: rgba(0,0,0,0.3) !important;">
        </div>
        <select class="form-select bg-dark border-secondary text-white" style="width: 150px; background: rgba(0,0,0,0.3) !important;" id="audit-category">
            <option value="" data-i18n="log.filter.all_category">分类</option>
            <option value="AUTH" {% if filter.category == 'AUTH' %}selected{% endif %} data-i18n="log.stats.auth_events">认证</option>
            <option value="AUTHZ" {% if filter.category == 'AUTHZ' %}selected{% endif %} data-i18n="option.o8283">授权</option>
            <option value="DATA" {% if filter.category == 'DATA' %}selected{% endif %} data-i18n="option.o8591">数据</option>
            <option value="CONFIG" {% if filter.category == 'CONFIG' %}selected{% endif %} data-i18n="option.o3914">配置</option>
            <option value="ADMIN" {% if filter.category == 'ADMIN' %}selected{% endif %} data-i18n="option.o1600">管理</option>
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 120px; background: rgba(0,0,0,0.3) !important;" id="audit-result">
            <option value="" data-i18n="log.table.result">结果</option>
            <option value="SUCCESS" {% if filter.result == 'SUCCESS' %}selected{% endif %} data-i18n="toast.success">成功</option>
            <option value="DENIED" {% if filter.result == 'DENIED' %}selected{% endif %} data-i18n="ui.text_1164">拒绝</option>
            <option value="FAILED" {% if filter.result == 'FAILED' %}selected{% endif %} data-i18n="toast.failed">失败</option>
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 110px; background: rgba(0,0,0,0.3) !important;" id="audit-days">
            <option value="1" {% if filter.days == 1 %}selected{% endif %} data-i18n="ui.icon_3122">今天</option>
            <option value="7" {% if filter.days == 7 %}selected{% endif %} data-i18n="option.o1826">7 天</option>
            <option value="30" {% if filter.days == 30 %}selected{% endif %} data-i18n="option.o5443">30 天</option>
            <option value="0" {% if filter.days == 0 %}selected{% endif %} data-i18n="ui.text_1280">全部</option>
        </select>
        <button class="btn btn-outline-info" onclick="filterAudit()">
            <i class="fas fa-search"></i>
        </button>
    </div>
    
    <!-- 统计 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-white-50">共 {{ total_count }} 条记录</small>
    </div>
    
    <!-- 审计列表 -->
    {% if logs %}
    <div class="log-table-container">
        <table class="log-table">
            <thead>
                <tr>
                    <th style="width: 130px;" data-i18n="log.table.time">时间</th>
                    <th style="width: 90px;" data-i18n="log.table.user">操作人</th>
                    <th style="width: 140px;" data-i18n="common.operation">动作</th>
                    <th style="width: 70px;" data-i18n="log.filter.all_category">分类</th>
                    <th data-i18n="log.table.target">目标</th>
                    <th style="width: 100px;" data-i18n="log.table.ip">IP</th>
                    <th style="width: 70px;" data-i18n="log.table.result">结果</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="{% if log.result == 'DENIED' %}row-denied{% elif log.result == 'FAILED' %}row-failed{% endif %}">
                    <td class="text-white-50" style="font-size: 11px;">{{ log.created_at|date:"m-d H:i:s" }}</td>
                    <td class="text-white" style="font-size: 12px;">{{ log.actor_username|mask_user:god_mode|truncatechars:10 }}</td>
                    <td>
                        <code class="text-info" style="font-size: 11px;">{{ log.action }}</code>
                    </td>
                    <td>
                        {% if log.action_category %}
                        <span class="category-badge">{{ log.action_category }}</span>
                        {% else %}
                        <span class="text-white-50">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="text-white-50 small" style="font-size: 11px;">{{ log.target_type|default:"" }}</span>
                        {% if log.target_id %}
                        <code class="text-white ms-1" style="font-size: 11px;">{{ log.target_id|truncatechars:18 }}</code>
                        {% endif %}
                        {% if log.target_name %}
                        <br><small class="text-white-50" style="font-size: 10px;">{{ log.target_name|truncatechars:28 }}</small>
                        {% endif %}
                    </td>
                    <td class="text-white-50" style="font-size: 11px;">{{ log.actor_ip|mask_ip:god_mode|default:"-" }}</td>
                    <td>
                        {% if log.result == 'SUCCESS' %}
                        <span class="result-badge result-success" data-i18n="toast.success">成功</span>
                        {% elif log.result == 'DENIED' %}
                        <span class="result-badge result-denied" data-i18n="ui.text_1164">拒绝</span>
                        {% else %}
                        <span class="result-badge result-failed" data-i18n="toast.failed">失败</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    {% if logs.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if logs.has_previous %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('audit', 'page={{ logs.previous_page_number }}&q={{ filter.q }}&category={{ filter.category }}&result={{ filter.result }}&days={{ filter.days }}')" data-i18n="common.prev_page">上一页</button>
            </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link bg-dark border-secondary text-white-50">{{ logs.number }} / {{ logs.paginator.num_pages }}</span>
            </li>
            {% if logs.has_next %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('audit', 'page={{ logs.next_page_number }}&q={{ filter.q }}&category={{ filter.category }}&result={{ filter.result }}&days={{ filter.days }}')" data-i18n="common.next_page">下一页</button>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="text-center text-white-50 py-5">
        <i class="fas fa-shield-halved fa-2x mb-3" style="opacity: 0.4;"></i>
        <p class="mb-0" data-i18n="ui.text_1168">没有审计记录</p>
    </div>
    {% endif %}
</div>

<style>
/* 表格容器 */
.log-table-container {
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

.log-table {
    width: 100%;
    border-collapse: collapse;
}

/* 表头 */
.log-table thead {
    background: rgba(255, 255, 255, 0.03);
}

.log-table thead th {
    padding: 12px 10px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: rgba(255, 255, 255, 0.5);
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

/* 数据行 */
.log-table tbody tr {
    transition: background 0.15s;
}

.log-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

.log-table tbody tr.row-denied {
    background: rgba(255, 193, 7, 0.03);
}

.log-table tbody tr.row-denied:hover {
    background: rgba(255, 193, 7, 0.06);
}

.log-table tbody tr.row-failed {
    background: rgba(220, 53, 69, 0.03);
}

.log-table tbody tr.row-failed:hover {
    background: rgba(220, 53, 69, 0.06);
}

.log-table tbody td {
    padding: 10px;
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

/* 分类徽章 */
.category-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* 结果徽章 */
.result-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 500;
}

.result-success {
    background: rgba(22, 163, 74, 0.15);
    color: #4ade80;
    border: 1px solid rgba(22, 163, 74, 0.25);
}

.result-denied {
    background: rgba(255, 193, 7, 0.1);
    color: #fbbf24;
    border: 1px solid rgba(255, 193, 7, 0.2);
}

.result-failed {
    background: rgba(220, 53, 69, 0.15);
    color: #f87171;
    border: 1px solid rgba(220, 53, 69, 0.25);
}
</style>

<script>
function filterAudit() {
    var q = document.getElementById('audit-search').value;
    var category = document.getElementById('audit-category').value;
    var result = document.getElementById('audit-result').value;
    var days = document.getElementById('audit-days').value;
    
    var params = new URLSearchParams({q: q, category: category, result: result, days: days});
    window.location.href = '/log/tab/audit/?' + params.toString();
}

document.getElementById('audit-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') filterAudit();
});
</script>