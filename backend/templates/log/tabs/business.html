<!-- log/tabs/business.html - 业务操作 Tab -->
{% load log_filters %}
<div class="py-3">
    <!-- 筛选栏 -->
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <div class="flex-grow-1">
            <input type="text" class="form-control bg-dark border-secondary text-white" id="biz-search" 
                   data-i18n-placeholder="log.search_placeholder.business" placeholder="搜索操作、目标..." value="{{ filter.q }}"
                   style="background: rgba(0,0,0,0.3) !important;">
        </div>
        <select class="form-select bg-dark border-secondary text-white" style="width: 130px; background: rgba(0,0,0,0.3) !important;" id="biz-module">
            <option value="" data-i18n="log.filter.all_module">全部模块</option>
            {% for m in module_options %}
            <option value="{{ m }}" {% if filter.module == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 120px; background: rgba(0,0,0,0.3) !important;" id="biz-user">
            <option value="" data-i18n="log.filter.all_user">全部用户</option>
            {% for u in user_options %}
            <option value="{{ u }}" {% if filter.user == u %}selected{% endif %}>{{ u }}</option>
            {% endfor %}
        </select>
        <select class="form-select bg-dark border-secondary text-white" style="width: 110px; background: rgba(0,0,0,0.3) !important;" id="biz-days">
            <option value="1" {% if filter.days == 1 %}selected{% endif %} data-i18n="ui.icon_3122">今天</option>
            <option value="7" {% if filter.days == 7 %}selected{% endif %} data-i18n="option.o1826">7 天</option>
            <option value="30" {% if filter.days == 30 %}selected{% endif %} data-i18n="option.o5443">30 天</option>
            <option value="0" {% if filter.days == 0 %}selected{% endif %} data-i18n="ui.text_1280">全部</option>
        </select>
        <button class="btn btn-outline-info" onclick="filterBusiness()">
            <i class="fas fa-search"></i>
        </button>
    </div>
    
    <!-- 统计 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-white-50">共 {{ total_count }} 条记录</small>
    </div>
    
    <!-- 业务日志列表 -->
    {% if logs %}
    <div class="log-table-container">
        <table class="log-table">
            <thead>
                <tr>
                    <th style="width: 130px;" data-i18n="log.table.time">时间</th>
                    <th style="width: 80px;" data-i18n="log.table.user">用户</th>
                    <th style="width: 80px;" data-i18n="log.table.module">模块</th>
                    <th style="width: 140px;" data-i18n="common.operation">动作</th>
                    <th data-i18n="log.table.description">摘要</th>
                    <th style="width: 70px;" data-i18n="log.table.duration">耗时</th>
                    <th style="width: 70px;" data-i18n="common.status">状态</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="{% if log.status == 'FAILED' %}row-failed{% endif %}">
                    <td class="text-white-50" style="font-size: 11px;">{{ log.created_at|date:"m-d H:i:s" }}</td>
                    <td class="text-white" style="font-size: 12px;">{{ log.user|mask_user:god_mode|truncatechars:8 }}</td>
                    <td>
                        <span class="module-badge">{{ log.module }}</span>
                    </td>
                    <td>
                        <code class="text-info" style="font-size: 11px;">{{ log.action }}</code>
                        {% if log.target_id %}
                        <br><small class="text-white-50" style="font-size: 10px;">{{ log.target_id|truncatechars:18 }}</small>
                        {% endif %}
                    </td>
                    <td class="text-white" style="font-size: 12px;" title="{{ log.summary }}">
                        {{ log.summary|truncatechars:45 }}
                    </td>
                    <td>
                        {% if log.duration_ms %}
                        <small class="{% if log.duration_ms > 3000 %}text-warning{% else %}text-white-50{% endif %}" style="font-size: 11px;">
                            {{ log.duration_ms }}ms
                        </small>
                        {% else %}
                        <small class="text-white-50">-</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.status == 'SUCCESS' %}
                        <span class="status-badge status-success" data-i18n="toast.success">成功</span>
                        {% else %}
                        <span class="status-badge status-failed" data-i18n="toast.failed">失败</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    {% if logs.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if logs.has_previous %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('business', 'page={{ logs.previous_page_number }}&q={{ filter.q }}&module={{ filter.module }}&user={{ filter.user }}&days={{ filter.days }}')" data-i18n="common.prev_page">上一页</button>
            </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link bg-dark border-secondary text-white-50">{{ logs.number }} / {{ logs.paginator.num_pages }}</span>
            </li>
            {% if logs.has_next %}
            <li class="page-item">
                <button class="page-link bg-dark border-secondary text-white" onclick="loadTabWithParams('business', 'page={{ logs.next_page_number }}&q={{ filter.q }}&module={{ filter.module }}&user={{ filter.user }}&days={{ filter.days }}')" data-i18n="common.next_page">下一页</button>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="text-center text-white-50 py-5">
        <i class="fas fa-clipboard-list fa-2x mb-3" style="opacity: 0.4;"></i>
        <p class="mb-0" data-i18n="ui.text_1155">没有业务操作记录</p>
    </div>
    {% endif %}
</div>

<style>
/* 表格容器 */
.log-table-container {
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.06);
}

.log-table {
    width: 100%;
    border-collapse: collapse;
}

/* 表头 */
.log-table thead {
    background: rgba(255, 255, 255, 0.03);
}

.log-table thead th {
    padding: 12px 10px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: rgba(255, 255, 255, 0.5);
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

/* 数据行 */
.log-table tbody tr {
    transition: background 0.15s;
}

.log-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

.log-table tbody tr.row-failed {
    background: rgba(220, 53, 69, 0.03);
}

.log-table tbody tr.row-failed:hover {
    background: rgba(220, 53, 69, 0.06);
}

.log-table tbody td {
    padding: 10px;
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

/* 模块徽章 */
.module-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 500;
    background: rgba(13, 202, 240, 0.12);
    color: #67e8f9;
    border: 1px solid rgba(13, 202, 240, 0.25);
}

/* 状态徽章 */
.status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 500;
}

.status-success {
    background: rgba(22, 163, 74, 0.15);
    color: #4ade80;
    border: 1px solid rgba(22, 163, 74, 0.25);
}

.status-failed {
    background: rgba(220, 53, 69, 0.15);
    color: #f87171;
    border: 1px solid rgba(220, 53, 69, 0.25);
}
</style>

<script>
function filterBusiness() {
    var q = document.getElementById('biz-search').value;
    var module = document.getElementById('biz-module').value;
    var user = document.getElementById('biz-user').value;
    var days = document.getElementById('biz-days').value;
    
    var params = new URLSearchParams({q: q, module: module, user: user, days: days});
    window.location.href = '/log/tab/business/?' + params.toString();
}

document.getElementById('biz-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') filterBusiness();
});
</script>