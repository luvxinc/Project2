{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}AI 智能助手 - Eaglestar ERP{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <!-- 左侧: 会话列表 -->
    <aside class="chat-sidebar">
        <div class="sidebar-header">
            <button class="btn btn-primary w-100" id="btn-new-chat"
                hx-post="{% url 'web_ui:ai_chat:api_create_session' %}" hx-target="#session-list" hx-swap="innerHTML"
                hx-on::after-request="refreshAfterNewSession(event)">
                <i class="fa-solid fa-plus me-2"></i>新对话
            </button>
        </div>
        <div class="session-list" id="session-list">
            {% include 'ai_chat/partials/session_list.html' %}
        </div>
        <div class="sidebar-footer">
            <div class="ai-status">
                {% if ai_available %}
                <span class="status-dot online"></span>
                <span class="text-success small">Gemini 已连接</span>
                {% else %}
                <span class="status-dot offline"></span>
                <span class="text-danger small">AI 服务不可用</span>
                {% endif %}
            </div>
        </div>
    </aside>

    <!-- 右侧: 聊天主区域 -->
    <main class="chat-main">
        <!-- 消息区域 -->
        <div class="message-container" id="message-container">
            {% include 'ai_chat/partials/message_list.html' %}
        </div>

        <!-- 输入区域 -->
        <div class="input-container">
            <form id="chat-form" onsubmit="sendMessage(event)">
                <input type="hidden" id="active-session-id" value="{{ active_session.id }}">
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="输入消息，按 Enter 发送..." rows="1"
                        onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
                    <button type="submit" class="btn-send" id="btn-send">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-hint">
                    <span class="text-muted small">按 Enter 发送，Shift+Enter 换行</span>
                </div>
            </form>
        </div>
    </main>
</div>

<style>
    /* =========================================
       AI Chat Container - ChatGPT Style Layout
       ========================================= */
    .ai-chat-container {
        display: flex;
        height: calc(100vh - 60px);
        margin: -30px;
        background: transparent;
    }

    /* 左侧边栏 */
    .chat-sidebar {
        width: 280px;
        min-width: 280px;
        background: rgba(18, 18, 23, 0.9);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .session-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .sidebar-footer {
        padding: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .ai-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.online {
        background: #22c55e;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
    }

    .status-dot.offline {
        background: #ef4444;
    }

    /* 会话项 */
    .session-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: rgba(255, 255, 255, 0.7);
    }

    .session-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .session-item.active {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
    }

    .session-item .session-icon {
        margin-right: 12px;
        opacity: 0.6;
    }

    .session-item .session-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.9rem;
    }

    .session-item .btn-delete {
        opacity: 0;
        transition: opacity 0.2s;
        padding: 4px 8px;
        border: none;
        background: transparent;
        color: #ef4444;
    }

    .session-item:hover .btn-delete {
        opacity: 1;
    }

    /* 右侧主区域 */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(25, 25, 30, 0.5);
    }

    /* 消息容器 */
    .message-container {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
    }

    /* 消息样式 */
    .message {
        display: flex;
        margin-bottom: 24px;
        gap: 16px;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }

    .message.assistant .message-avatar {
        background: linear-gradient(135deg, #10b981, #14b8a6);
    }

    .message-content {
        flex: 1;
        max-width: 800px;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .message-role {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .message.user .message-role {
        color: #60a5fa;
    }

    .message.assistant .message-role {
        color: #34d399;
    }

    .message-time {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.4);
    }

    .message-text {
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.7;
        font-size: 0.95rem;
    }

    .message-text p {
        margin-bottom: 12px;
    }

    .message-text p:last-child {
        margin-bottom: 0;
    }

    .message-text pre {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        overflow-x: auto;
        margin: 12px 0;
    }

    .message-text code {
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 0.85rem;
    }

    /* 输入区域 */
    .input-container {
        padding: 16px 24px 24px;
        background: linear-gradient(to top, rgba(18, 18, 23, 0.95), transparent);
    }

    .input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        background: rgba(40, 40, 50, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 16px;
        transition: border-color 0.2s;
    }

    .input-wrapper:focus-within {
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #message-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: white;
        font-size: 1rem;
        line-height: 1.5;
        resize: none;
        max-height: 200px;
    }

    #message-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .btn-send {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, opacity 0.2s;
    }

    .btn-send:hover {
        transform: scale(1.05);
    }

    .btn-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .input-hint {
        text-align: center;
        margin-top: 8px;
    }

    /* 加载动画 */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 12px 16px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* 空状态 */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: rgba(255, 255, 255, 0.5);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 24px;
        opacity: 0.3;
    }

    .empty-state h3 {
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.7);
    }

    /* 响应式 */
    @media (max-width: 768px) {
        .chat-sidebar {
            display: none;
        }

        .input-container {
            padding: 12px;
        }
    }
</style>

<script>
    // 发送消息
    async function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('message-input');
        const message = input.value.trim();
        const sessionId = document.getElementById('active-session-id').value;

        if (!message) return;

        // 禁用输入
        input.disabled = true;
        document.getElementById('btn-send').disabled = true;

        // 立即显示用户消息
        appendMessage('user', message);
        input.value = '';
        autoResize(input);

        // 显示加载动画
        showTypingIndicator();

        try {
            const response = await fetch('{% url "web_ui:ai_chat:api_send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    message: message
                })
            });

            // 移除加载动画
            hideTypingIndicator();

            if (!response.ok) {
                // HTTP 错误
                const errorText = await response.text();
                let errorMsg = '服务器错误';
                try {
                    const errorData = JSON.parse(errorText);
                    errorMsg = errorData.error || errorData.message || '请求失败';
                } catch (e) {
                    errorMsg = errorText || `HTTP ${response.status}`;
                }
                appendMessage('assistant', `⚠️ ${errorMsg}`, true);
            } else {
                const data = await response.json();
                if (data.success) {
                    appendMessage('assistant', data.response || '(空回复)');
                } else {
                    const errorMsg = data.error || data.message || '未知错误';
                    appendMessage('assistant', `⚠️ ${errorMsg}`, true);
                }
            }

            // 刷新会话列表 (标题可能已更新)
            htmx.ajax('GET', '{% url "web_ui:ai_chat:partial_sessions" %}', '#session-list');

        } catch (error) {
            hideTypingIndicator();
            console.error('Chat error:', error);
            appendMessage('assistant', `⚠️ 网络错误: ${error.message || '请检查网络连接'}`, true);
        }

        // 恢复输入
        input.disabled = false;
        document.getElementById('btn-send').disabled = false;
        input.focus();
    }

    // 追加消息到界面
    function appendMessage(role, content, isError = false) {
        const container = document.getElementById('message-container');
        const now = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

        const messageHtml = `
            <div class="message ${role}">
                <div class="message-avatar">
                    <i class="fa-solid ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-role">${role === 'user' ? '你' : 'AI 助手'}</span>
                        <span class="message-time">${now}</span>
                    </div>
                    <div class="message-text ${isError ? 'text-warning' : ''}">${formatMessage(content)}</div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', messageHtml);
        scrollToBottom();
    }

    // 格式化消息 (简单的 Markdown 转换)
    function formatMessage(text) {
        // 转义 HTML
        text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // 代码块
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

        // 行内代码
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

        // 粗体
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // 换行
        text = text.replace(/\n/g, '<br>');

        return text;
    }

    // 显示/隐藏加载动画
    function showTypingIndicator() {
        const container = document.getElementById('message-container');
        const html = `
            <div class="message assistant" id="typing-indicator">
                <div class="message-avatar">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    // 滚动到底部
    function scrollToBottom() {
        const container = document.getElementById('message-container');
        container.scrollTop = container.scrollHeight;
    }

    // 键盘处理
    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage(event);
        }
    }

    // 自动调整输入框高度
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    // 切换会话
    function switchSession(sessionId) {
        document.getElementById('active-session-id').value = sessionId;
        htmx.ajax('GET', `/ai-chat/partials/messages/${sessionId}/`, '#message-container');
        htmx.ajax('GET', '{% url "web_ui:ai_chat:partial_sessions" %}', '#session-list');
    }

    // 删除会话
    async function deleteSession(event, sessionId) {
        event.stopPropagation();

        if (!confirm('确定要删除这个对话吗？')) return;

        try {
            await fetch(`/ai-chat/api/sessions/${sessionId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });

            htmx.ajax('GET', '{% url "web_ui:ai_chat:partial_sessions" %}', '#session-list');

            // 如果删除的是当前会话，刷新消息
            if (document.getElementById('active-session-id').value === sessionId) {
                location.reload();
            }
        } catch (error) {
            alert('删除失败');
        }
    }

    // 新建会话后刷新
    function refreshAfterNewSession(event) {
        if (event.detail.successful) {
            try {
                const data = JSON.parse(event.detail.xhr.responseText);
                if (data.session_id) {
                    switchSession(data.session_id);
                }
            } catch (e) { }
        }
        htmx.ajax('GET', '{% url "web_ui:ai_chat:partial_sessions" %}', '#session-list');
    }

    // 页面加载后滚动到底部
    document.addEventListener('DOMContentLoaded', scrollToBottom);
</script>
{% endblock %}