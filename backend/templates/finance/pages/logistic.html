{% extends "layouts/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Logistics Finance - Finance - ERP System{% endblock %}

{% block content %}
<div class="fade-in" id="logistic-main-container">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'web_ui:finance:hub' %}"
                            class="text-info text-decoration-none" data-i18n="finance.title">Finance</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="finance.logistic">Logistics Finance</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'web_ui:finance:hub' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="finance.back_to_hub">返回Finance</span>
            </a>
        </div>
    </div>

    <!-- 订单列表视图 -->
    <div id="logistic-list-view">
        <div class="glass-card p-4 shadow-lg">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
                <div class="d-flex align-items-center">
                    <div class="bg-success bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                        <i class="fas fa-truck-loading fa-2x text-success"></i>
                    </div>
                    <div>
                        <h5 class="text-white mb-1" data-i18n="finance.logistic_page_title">Logistics Finance</h5>
                        <p class="text-white-50 small mb-0" data-i18n="ui.text_1243">管理物流费用，查看付款状态，进行批量付款操作。</p>
                    </div>
                </div>
                <button class="btn btn-outline-light btn-sm rounded-pill" onclick="loadLogisticTable()">
                    <i class="fas fa-sync-alt me-1"></i> <span data-i18n="common.refresh">刷新列表</span>
                </button>
            </div>

            <!-- 操作须知 -->
            <div class="alert alert-info mb-4" style="background: rgba(13, 202, 240, 0.1); border: 1px solid rgba(13, 202, 240, 0.3);">
                <div class="d-flex align-items-start">
                    <i class="fas fa-info-circle me-3 mt-1 text-info fa-lg"></i>
                    <div>
                        <strong class="text-info d-block mb-2" data-i18n="common.operation_notes">操作须知</strong>
                        <ul class="mb-0 ps-3 text-white-50 small">
                            <li class="mb-1"><strong class="text-white" data-i18n="finance.payment_status">付款状态</strong>：<span class="badge bg-success bg-opacity-25 text-success" data-i18n="ui.text_1245">已付款</span> 表示已完成付款，<span class="badge bg-warning bg-opacity-25 text-warning" data-i18n="ui.text_1246">未付款</span> 表示待付款</li>
                            <li class="mb-1"><strong class="text-white" data-i18n="finance.batch_payment">批量付款</strong>：<span data-i18n="instructions.desc_58">勾选未付款的物流单，点击右上角「批量付款」按钮进入付款向导</span></li>
                            <li class="mb-1"><strong class="text-white" data-i18n="ui.text_526">费用显示</strong>：<span data-i18n="instructions.desc_19">物流费用同时显示 RMB 和 USD 金额</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 筛选区域 -->
            <div class="d-flex gap-3 mb-4 align-items-end">
                <div>
                    <label class="form-label text-white-50 small mb-1">
                        <i class="fas fa-sort me-1"></i><span data-i18n="purchase.sort_by">排序方式</span>
                    </label>
                    <select class="form-select form-select-sm bg-dark border-secondary text-white" id="filter-sort"
                            style="width: 180px;" onchange="applyFilters()">
                        <option value="date_sent:desc" data-i18n="option.o9093">发货日期 (最新优先)</option>
                        <option value="date_sent:asc" data-i18n="option.o3909">发货日期 (最早优先)</option>
                        <option value="logistic_num:asc" data-i18n="option.o5107">物流单号 (升序)</option>
                        <option value="logistic_num:desc" data-i18n="option.o4329">物流单号 (降序)</option>
                    </select>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-success btn-sm rounded-pill" id="btn-batch-payment" disabled>
                        <i class="fas fa-money-check-alt me-1"></i><span data-i18n="ui.icon_3360">批量付款 (</span><span id="selected-count">0</span>)
                    </button>
                </div>
            </div>

            <!-- 未付款订单表格 -->
            <div class="mb-4">
                <h6 class="text-warning mb-3">
                    <i class="fas fa-clock me-2"></i><span data-i18n="ui.icon_3369">待付款物流单</span>
                    <span class="badge bg-warning bg-opacity-25 text-warning ms-2" id="unpaid-count">0</span>
                </h6>
                <div class="logistic-table-container">
                    <table class="logistic-table" id="unpaid-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all-unpaid" class="form-check-input">
                                </th>
                                <th data-i18n="table.logistics_no">物流单号</th>
                                <th data-i18n="purchase.shipping_date">发货日期</th>
                                <th data-i18n="js.eta_date">预计到达</th>
                                <th data-i18n="ui.text_2502">实际入库</th>
                                <th data-i18n="js.pallets">托盘数</th>
                                <th data-i18n="js.logistics_unit_price">物流单价</th>
                                <th data-i18n="table.settlement_rate">结算汇率</th>
                                <th data-i18n="ui.text_2506">物流重量</th>
                                <th data-i18n="ui.text_2169">物流费用</th>
                            </tr>
                        </thead>
                        <tbody id="unpaid-table-body">
                            <!-- JS动态加载 -->
                        </tbody>
                    </table>
                    <div id="unpaid-empty" class="text-center py-4" style="display: none;">
                        <i class="fas fa-check-circle fa-2x text-success opacity-50 mb-2"></i>
                        <p class="text-white-50 mb-0 small" data-i18n="finance.all_logistics_paid">全部物流单已完成付款</p>
                    </div>
                </div>
            </div>

            <!-- 已付款订单 - 九宫格展示 -->
            <div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-success mb-0">
                        <i class="fas fa-check-circle me-2"></i><span data-i18n="ui.icon_3370">已付款物流单</span>
                        <span class="badge bg-success bg-opacity-25 text-success ms-2" id="paid-count">0</span>
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                        <label class="text-white-50 small mb-0" data-i18n="ui.text_1249">年份:</label>
                        <select id="paid-year-filter" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: auto;">
                            <!-- JS动态填充年份选项 -->
                        </select>
                    </div>
                </div>
                <div id="paid-grid-container" class="paid-grid-container">
                    <!-- JS动态加载付款卡片 -->
                </div>
                <div id="paid-empty" class="text-center py-4" style="display: none;">
                    <i class="fas fa-inbox fa-2x text-white-50 opacity-50 mb-2"></i>
                    <p class="text-white-50 mb-0 small" data-i18n="finance.no_paid_records">暂无已付款记录</p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="logistic-loading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-info" role="status"></div>
                <p class="text-white-50 mt-3 mb-0" data-i18n="common.loading">正在加载数据...</p>
            </div>

            <!-- 统计信息 -->
            <div class="mt-3">
                <span class="text-white-50 small" id="logistic-count" data-i18n="ui.text_1250">共 0 条物流单</span>
            </div>
        </div>
    </div>

    <!-- 文件上传向导视图 (默认隐藏) -->
    <div id="payment-file-upload-view" style="display: none;">
        <div id="payment-file-upload-container"></div>
    </div>

    <!-- 文件查看器视图 (默认隐藏) -->
    <div id="payment-file-viewer-view" style="display: none;">
        <div id="payment-file-viewer-container"></div>
    </div>

    {% include "finance/pages/partials/payment_history_view.html" %}

    {% include "finance/pages/partials/payment_orders_view.html" %}

    <!-- 付款向导视图 (默认隐藏) -->
    <div id="payment-wizard-view" style="display: none;">
        <div class="glass-card p-4 shadow-lg">
            <!-- Header with back button -->
            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
                <div class="d-flex align-items-center">
                    <div class="bg-warning bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                        <i class="fas fa-money-check-alt fa-2x text-warning"></i>
                    </div>
                    <div>
                        <h5 class="text-white mb-1" data-i18n="finance.logistic_wizard_title">批量付款向导</h5>
                        <p class="text-white-50 small mb-0" data-i18n="ui.text_1251">确认结算汇率并完成物流费用付款。</p>
                    </div>
                </div>
                <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="closePaymentWizard()">
                    <i class="fas fa-times me-1"></i><span data-i18n="finance.cancel_payment">取消付款</span>
                </button>
            </div>
            
            <!-- Wizard Container -->
            <div id="payment-wizard-container" style="width: 100%;">
                <!-- Step Bar Anchor -->
                <div data-wizard-stepbar-anchor></div>
                
                <!-- Step 1: 付款说明 -->
                <div class="wizard-step-content" id="step-intro" style="width: 100%; display: block;">
                    {% include "finance/pages/partials/payment_step1_intro.html" %}
                </div>
                
                <!-- Step 2: 确认汇率 -->
                <div class="wizard-step-content" id="step-preview">
                    {% include "finance/pages/partials/payment_step2_preview.html" %}
                </div>
                
                <!-- Step 3: 确认费用 -->
                <div class="wizard-step-content" id="step-confirm">
                    {% include "finance/pages/partials/payment_step3_confirm.html" %}
                </div>
                
                <!-- Step 4: 付款完成 -->
                <div class="wizard-step-content" id="step-complete">
                    {% include "finance/pages/partials/payment_step4_complete.html" %}
                </div>
            </div>
        </div>
    </div>


</div>


<style>
    /* 向导容器 - 确保内容占满宽度 */
    #payment-wizard-container {
        width: 100%;
    }
    
    .wizard-step-content {
        width: 100%;
    }
    
    .wizard-step-content .row {
        width: 100%;
        margin: 0;
    }
    
    .wizard-step-content .col-12 {
        width: 100%;
        padding: 0;
    }

    /* 表格容器 */
    .logistic-table-container {
        border-radius: 16px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
        max-height: calc(100vh - 400px);
        overflow-y: auto;
    }

    .logistic-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    /* 表头 */
    .logistic-table thead {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .logistic-table thead th {
        padding: 14px 10px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        border-bottom: 2px solid rgba(25, 135, 84, 0.3);
        white-space: nowrap;
    }

    .logistic-table thead th.sortable {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .logistic-table thead th.sortable:hover {
        color: rgba(255, 255, 255, 0.95);
        background: rgba(255, 255, 255, 0.05);
    }

    /* 数据行 */
    .logistic-table tbody tr {
        background: rgba(25, 28, 35, 0.6);
        transition: all 0.2s ease;
    }

    .logistic-table tbody tr:hover {
        background: rgba(40, 45, 55, 0.8);
    }

    .logistic-table tbody tr.selected {
        background: rgba(25, 135, 84, 0.15);
    }

    .logistic-table tbody tr:not(:last-child) td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .logistic-table tbody td {
        padding: 12px 10px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        vertical-align: middle;
        line-height: 1.4;
    }

    /* 金额数值样式 - 与 deposit.html 完全一致 */
    .amount-primary {
        font-weight: 600; /* 对齐 deposit: 600 weight */
        color: #fff;
        /* font-size 继承 td 的 12px */
    }
    
    .amount-secondary {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
    }
    
    .amount-pending {
        font-weight: 600;
        color: #ffc107;
    }
    
    .amount-paid {
        font-weight: 600;
        color: #198754;
    }

    /* 物流单号加粗 */
    .logistic-table tbody td.cell-logistic-num {
        font-weight: 700;
        color: #fff;
        font-size: 12px;
    }

    /* 付款状态标签 */
    .payment-status-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .payment-status-tag.paid {
        background: rgba(25, 135, 84, 0.2);
        color: #198754;
        border: 1px solid rgba(25, 135, 84, 0.4);
    }

    .payment-status-tag.unpaid {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.4);
    }

    /* 已付款行不可选 */
    .logistic-table tbody tr.paid-row .row-checkbox {
        opacity: 0.3;
        cursor: not-allowed;
    }

    /* 子单行样式 */
    .logistic-table tbody tr.child-row {
        background: rgba(13, 110, 253, 0.05);
        border-left: 3px solid rgba(13, 202, 240, 0.4);
    }
    
    .logistic-table tbody tr.child-row:hover {
        background: rgba(13, 110, 253, 0.1);
    }
    
    .logistic-table tbody tr.child-row .cell-logistic-num {
        padding-left: 24px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .logistic-table tbody tr.child-row .row-checkbox {
        opacity: 0.3;
        cursor: not-allowed;
    }

    /* 付款批次卡片样式 */
    .paid-batch-card {
        background: rgba(25, 135, 84, 0.05);
        border: 1px solid rgba(25, 135, 84, 0.2);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .paid-batch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: rgba(25, 135, 84, 0.1);
        border-bottom: 1px solid rgba(25, 135, 84, 0.15);
    }
    
    .paid-batch-header .batch-date {
        font-weight: 600;
        color: #198754;
        font-size: 14px;
    }
    
    .paid-batch-header .batch-summary {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .paid-batch-card .batch-table {
        margin: 0;
        border-radius: 0;
    }
    
    .paid-batch-card .batch-table thead th {
        background: rgba(25, 135, 84, 0.08);
        padding: 8px 10px;
        font-size: 11px;
    }

    /* ===== 付款九宫格样式 ===== */
    .paid-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 16px;
        max-height: 500px;
        overflow-y: auto;
        padding: 4px;
        align-items: stretch;  /* 同一行卡片等高 */
    }
    
    .payment-card {
        background: linear-gradient(145deg, rgba(25, 135, 84, 0.1) 0%, rgba(25, 135, 84, 0.03) 100%);
        border: 1px solid rgba(25, 135, 84, 0.25);
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    
    .payment-card:hover {
        transform: translateY(-2px);
        border-color: rgba(25, 135, 84, 0.5);
        box-shadow: 0 8px 24px rgba(25, 135, 84, 0.15);
    }
    
    .payment-card-header {
        padding: 12px 16px;
        background: rgba(25, 135, 84, 0.15);
        border-bottom: 1px solid rgba(25, 135, 84, 0.2);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .payment-card-header .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .payment-card-header .pmt-no {
        font-weight: 700;
        color: #198754;
        font-size: 13px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }
    
    .payment-card-header .action-btns {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    
    .payment-card-header .action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(0, 0, 0, 0.2);
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 11px;
    }
    
    .payment-card-header .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .payment-card-header .action-btn.btn-view-file:hover {
        background: rgba(13, 110, 253, 0.3);
        border-color: rgba(13, 110, 253, 0.5);
        color: #0d6efd;
    }
    
    .payment-card-header .action-btn.btn-upload-file:hover {
        background: rgba(25, 135, 84, 0.3);
        border-color: rgba(25, 135, 84, 0.5);
        color: #198754;
    }
    
    .payment-card-header .action-btn.btn-view-order:hover {
        background: rgba(13, 202, 240, 0.3);
        border-color: rgba(13, 202, 240, 0.5);
        color: #0dcaf0;
    }
    

    
    .payment-card-header .action-btn.btn-history:hover {
        background: rgba(108, 117, 125, 0.3);
        border-color: rgba(108, 117, 125, 0.5);
        color: #6c757d;
    }
    
    .payment-card-header .action-btn.btn-delete:hover {
        background: rgba(220, 53, 69, 0.3);
        border-color: rgba(220, 53, 69, 0.5);
        color: #dc3545;
    }
    
    .payment-card-body {
        padding: 14px 16px;
        flex: 1;  /* 填充剩余空间，使卡片等高 */
        display: flex;
        flex-direction: column;
    }
    
    .payment-card-body .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .payment-card-body .info-row:last-child {
        margin-bottom: 0;
    }
    
    .payment-card-body .info-label {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .payment-card-body .info-value {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }
    
    .payment-card-body .logistic-hierarchy {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 12px;
        max-height: 120px;
        overflow-y: auto;
    }
    
    .payment-card-body .logistic-hierarchy .logistic-parent {
        font-size: 12px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        color: rgba(255, 255, 255, 0.9);
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .payment-card-body .logistic-hierarchy .logistic-parent:last-child {
        border-bottom: none;
    }
    
    .payment-card-body .logistic-hierarchy .logistic-child {
        font-size: 11px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        color: rgba(255, 255, 255, 0.5);
        padding: 3px 0 3px 20px;
        margin-left: 8px;
        border-left: 1px dashed rgba(108, 117, 125, 0.4);
    }
    
    .payment-card-body .amount-section {
        background: rgba(255, 193, 7, 0.08);
        border-radius: 10px;
        padding: 10px 12px;
        margin-top: auto;  /* 自动推到底部 */
    }
    
    .payment-card-body .amount-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    
    .payment-card-body .amount-row:last-child {
        margin-bottom: 0;
    }
    
    .payment-card-body .amount-usd {
        color: #0dcaf0;
        font-weight: 600;
    }
    
    .payment-card-body .amount-rmb {
        color: #ffc107;
        font-weight: 700;
    }
    
    .payment-card-body .rate-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(108, 117, 125, 0.3);
        color: rgba(255, 255, 255, 0.7);
    }

    /* ===== Payment Wizard Styles ===== */
    
    /* Instruction Card */
    .instruction-card {
        background: linear-gradient(145deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%);
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 16px;
        overflow: hidden;
        width: 100%;
    }
    
    .instruction-header {
        padding: 16px 20px;
        background: rgba(13, 110, 253, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .instruction-header i {
        font-size: 24px;
        color: #0d6efd;
    }
    
    .instruction-header h6 {
        margin: 0;
        color: #0d6efd;
        font-weight: 600;
    }
    
    .instruction-body {
        padding: 20px;
    }
    
    .instruction-body ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .instruction-body li {
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 10px;
        line-height: 1.6;
    }
    
    .instruction-body li:last-child {
        margin-bottom: 0;
    }

    /* Summary List */
    .summary-list-header {
        padding: 16px 20px;
        background: rgba(255, 193, 7, 0.1);
        border-bottom: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .summary-list-container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 20px;
        background: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }
    
    .summary-item:hover {
        background: rgba(255, 255, 255, 0.03);
    }
    
    .summary-item:last-child {
        border-bottom: none;
    }

    /* Detail Table */
    .detail-table-container {
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .detail-table-container table {
        margin-bottom: 0;
    }
    
    .detail-table-container thead th {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        padding: 14px 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .detail-table-container tbody td {
        padding: 14px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 13px;
    }
    
    .total-row td {
        background: rgba(255, 193, 7, 0.1);
        border-top: 2px solid rgba(255, 193, 7, 0.3);
    }

    /* Rate Input */
    .rate-input {
        width: 100px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 193, 7, 0.4);
        border-radius: 6px;
        color: #fff;
        font-size: 13px;
        text-align: center;
    }
    
    .rate-input:focus {
        outline: none;
        border-color: #ffc107;
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2);
    }

    /* Confirmation Card */
    .confirmation-card {
        background: linear-gradient(145deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.03) 100%);
        border: 1px solid rgba(255, 193, 7, 0.25);
        border-radius: 20px;
        padding: 40px 32px;
    }
    
    .confirmation-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 193, 7, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
    }
    
    .confirmation-icon i {
        font-size: 36px;
        color: #ffc107;
    }
    
    .confirmation-details {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .confirmation-details .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .confirmation-details .label {
        color: rgba(255, 255, 255, 0.6);
        font-size: 13px;
    }
    
    .confirmation-details .value {
        font-size: 15px;
        font-weight: 600;
        color: #fff;
    }

    /* Success Card */
    .success-card {
        background: linear-gradient(145deg, rgba(25, 135, 84, 0.1) 0%, rgba(25, 135, 84, 0.03) 100%);
        border: 1px solid rgba(25, 135, 84, 0.25);
        border-radius: 20px;
        padding: 48px 32px;
    }
    
    .success-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(25, 135, 84, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        animation: pulse-success 2s ease-in-out infinite;
    }
    
    .success-icon i {
        font-size: 48px;
        color: #198754;
    }
    
    @keyframes pulse-success {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .success-summary {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .success-summary-item {
        text-align: center;
    }
    
    .success-summary-item .label {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 4px;
    }
    
    .success-summary-item .value {
        font-size: 18px;
        font-weight: 700;
    }

    /* Alert Block */
    .alert-block {
        display: flex;
        gap: 16px;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 24px;
    }
    
    .alert-block.danger {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .alert-block .alert-icon {
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .alert-block.danger .alert-icon {
        background: rgba(220, 53, 69, 0.2);
    }
    
    .alert-block.danger .alert-icon i {
        color: #dc3545;
        font-size: 20px;
    }
    
    .alert-block .alert-content strong {
        color: #fff;
        display: block;
        margin-bottom: 4px;
    }
    
    .alert-block .alert-content p {
        color: rgba(255, 255, 255, 0.6);
    }
    
    /* Warning Alert Block */
    .alert-block.warning {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .alert-block.warning .alert-icon {
        background: rgba(255, 193, 7, 0.2);
    }
    
    .alert-block.warning .alert-icon i {
        color: #ffc107;
        font-size: 20px;
    }
    
    /* Summary Card */
    .summary-card {
        background: linear-gradient(145deg, rgba(255, 193, 7, 0.08) 0%, rgba(255, 193, 7, 0.02) 100%);
        border: 1px solid rgba(255, 193, 7, 0.2);
        border-radius: 16px;
        overflow: hidden;
        width: 100%;
    }
    
    .summary-header {
        padding: 16px 20px;
        background: rgba(255, 193, 7, 0.15);
        color: #ffc107;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .summary-body {
        padding: 0;
    }
    
    .summary-total {
        padding: 16px 20px;
        background: rgba(0, 0, 0, 0.3);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Check List */
    .check-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .check-list li {
        padding: 8px 0;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Lead Text */
    .lead-text {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
    }
    
    /* Total Display */
    .total-rmb {
        font-size: 1.25rem;
        font-weight: 700;
        color: #ffc107;
    }
    
    .total-usd {
        font-size: 1rem;
        font-weight: 600;
        color: #0dcaf0;
    }
    
    /* Success Summary Item */
    .success-summary .summary-item {
        text-align: center;
    }
    
    .success-summary .summary-item .label {
        display: block;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 4px;
    }
    
    .success-summary .summary-item .value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    /* 会计风格对齐容器 */
    .acct-box {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        min-width: 90px;
    }
    
    .acct-row {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        justify-content: flex-end;
    }
    
    .acct-amt {
        letter-spacing: -0.3px;
    }
</style>

<script>
    // 全局状态
    let logisticData = [];
    let selectedLogistics = new Set();
    let currentSortBy = 'date_sent';
    let currentSortOrder = 'desc';
    let currentPaymentFilter = '';

    document.addEventListener('DOMContentLoaded', function () {
        loadLogisticTable();
        bindEvents();
    });

    function bindEvents() {
        // 全选 checkbox (未付款表格)
        document.getElementById('select-all-unpaid').addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('#unpaid-table-body .row-checkbox:not(:disabled)').forEach(cb => {
                cb.checked = isChecked;
                const logisticNum = cb.dataset.logisticNum;
                if (isChecked) {
                    selectedLogistics.add(logisticNum);
                } else {
                    selectedLogistics.delete(logisticNum);
                }
            });
            updateSelectedCount();
        });

        // 批量付款按钮
        document.getElementById('btn-batch-payment').addEventListener('click', function() {
            if (selectedLogistics.size === 0) return;
            openPaymentWizard();
        });
    }

    // 渲染已付款卡片（支持年份筛选）
    function renderPaidCards(yearFilter) {
        const paidByPmtNo = window.paidByPmtNo || {};
        const gridContainer = document.getElementById('paid-grid-container');
        const paidCountEl = document.getElementById('paid-count');
        gridContainer.innerHTML = '';
        
        // 按 pmt_no 降序排列，并按年份筛选
        let sortedPmtNos = Object.keys(paidByPmtNo).sort((a, b) => b.localeCompare(a));
        
        if (yearFilter && yearFilter !== 'all') {
            sortedPmtNos = sortedPmtNos.filter(pmtNo => pmtNo.startsWith(yearFilter + '-'));
        }
        
        paidCountEl.textContent = sortedPmtNos.length;
        
        sortedPmtNos.forEach(pmtNo => {
            const { parents, children } = paidByPmtNo[pmtNo];
            
            // 只统计父订单的金额
            let batchTotalRmb = 0;
            let batchTotalUsd = 0;
            let batchExtraUsd = 0;
            let paymentRate = 7.0;
            let paymentMode = 'M'; // Default to Manual if unidentified
            
            const parentChildMap = {};
            
            parents.forEach((item, index) => {
                batchTotalRmb += item.total_price_rmb || 0;
                batchTotalUsd += item.total_price_usd || 0;
                batchExtraUsd += item.extra_paid_usd || 0;
                if (index === 0 && item.usd_rmb && item.usd_rmb > 0) {
                    paymentRate = item.usd_rmb;
                    // Use verified payment_mode from backend (A=Auto, M=Manual)
                    paymentMode = item.payment_mode || 'M';
                }
                parentChildMap[item.logistic_num] = [];
            });
            
            children.forEach(child => {
                const match = child.logistic_num.match(/^(.+)_delay_V\d+$/);
                if (match && parentChildMap[match[1]]) {
                    parentChildMap[match[1]].push(child.logistic_num);
                }
            });
            
            const totalCount = parents.length;
            
            const hierarchyHtml = parents.map(p => {
                const childList = parentChildMap[p.logistic_num] || [];
                let html = `<div class="logistic-parent"><i class="fas fa-truck text-success me-2"></i>${p.logistic_num}</div>`;
                if (childList.length > 0) {
                    html += childList.map(c => 
                        `<div class="logistic-child"><i class="fas fa-level-up-alt fa-rotate-90 text-secondary me-2"></i>${c}</div>`
                    ).join('');
                }
                return html;
            }).join('');
            
            const cardHtml = `
                <div class="payment-card" data-pmt-no="${pmtNo}">
                    <div class="payment-card-header">
                        <div class="header-top">
                            <span class="pmt-no"><i class="fas fa-receipt me-2"></i>${pmtNo}</span>
                            <div class="action-btns">
                                <button type="button" class="action-btn btn-view-file disabled" id="view-file-btn-${pmtNo}" 
                                        data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-data-i18n-title="tooltip.t4843" title="No Payment File" 
                                        onclick="viewPaymentFile('${pmtNo}')" disabled>
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="action-btn btn-upload-file" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-data-i18n-title="tooltip.t7820" title="Upload Payment File" onclick="uploadPaymentFile('${pmtNo}')">
                                    <i class="fas fa-upload"></i>
                                </button>
                                <button type="button" class="action-btn btn-view-order" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-data-i18n-title="tooltip.t2250" title="View Order Info" onclick="viewPaymentOrders('${pmtNo}')">
                                    <i class="fas fa-list"></i>
                                </button>

                                <button type="button" class="action-btn btn-history" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-data-i18n-title="tooltip.t6" title="History" onclick="viewPaymentHistory('${pmtNo}')">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button type="button" class="action-btn btn-delete" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-data-i18n-title="tooltip.t5709" title="Delete Payment" onclick="deletePayment('${pmtNo}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="payment-card-body">
                        <div class="info-row">
                            <span class="info-label" data-i18n="table.logistics_no">物流单号</span>
                            <span class="info-value" data-i18n="ui.text_1253">${totalCount} 单</span>
                        </div>
                        <div class="logistic-hierarchy">${hierarchyHtml}</div>

                        <!-- Adjusted grid columns: 1fr for Label, Fixed 110px for USD, Fixed 120px for RMB to ensure strict right-edge alignment -->
                        <div class="amount-section" style="display: grid; grid-template-columns: 1fr 110px 120px; row-gap: 8px; column-gap: 4px; align-items: center; font-size: 13px;">
                            
                            <!-- 运费 -->
                            <span class="info-label" style="font-size: 12px; color: rgba(255,255,255,0.5);" data-i18n="ui.text_1254">运费</span>
                            <span class="text-info text-end" style="font-size: 13px;">$${batchTotalUsd.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            <span class="text-warning text-end" style="font-size: 13px;">¥${batchTotalRmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            
                            <!-- 额外费用 -->
                            ${batchExtraUsd > 0 ? `
                            <span class="info-label" style="font-size: 12px; color: rgba(255,255,255,0.5);" data-i18n="table.extra_fees">额外费用</span>
                            <span class="text-info text-end" style="font-size: 13px;">$${batchExtraUsd.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            <span class="text-warning text-end" style="font-size: 13px;">¥${(batchExtraUsd * paymentRate).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            ` : ''}
                            
                            <!-- 分割线 (Full Width) -->
                            <div style="grid-column: 1 / -1; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 2px; margin-bottom: 2px;"></div>

                            <!-- 总费用 -->
                            <span class="info-label fw-bold" style="font-size: 12px; color: rgba(255,255,255,0.7);" data-i18n="ui.text_1256">总费用</span>
                            <span class="amount-usd text-end fw-bold" style="color: #0dcaf0; font-size: 13px;">$${(batchTotalUsd + batchExtraUsd).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            <span class="amount-rmb text-end fw-bold" style="color: #ffc107; font-size: 13px;">¥${(batchTotalRmb + batchExtraUsd * paymentRate).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                            
                            <!-- 结算汇率 -->
                            <span class="info-label" style="font-size: 12px; color: rgba(255,255,255,0.5);" data-i18n="table.settlement_rate">结算汇率</span>
                            <div class="text-end" style="grid-column: span 2; display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
                                <span class="text-white" style="font-size: 13px;">${paymentRate.toFixed(4)}</span>
                                <span class="badge border ${paymentMode === 'A' ? 'bg-info bg-opacity-10 text-info border-info border-opacity-25' : 'bg-light bg-opacity-10 text-light border-secondary border-opacity-25'}" style="font-size: 9px; padding: 2px 6px;" data-i18n="ui.text_1258">
                                    ${paymentMode === 'A' ? (window.i18n?.t('js.auto_fetch') || 'Auto Fetch') : (window.i18n?.t('js.manual_input') || 'Manual Input')}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            gridContainer.innerHTML += cardHtml;
        });
        
        // 初始化 tooltips
        document.querySelectorAll('#paid-grid-container [data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el);
        });
        
        // 检查文件状态
        updatePaymentFileButtons(sortedPmtNos);
    }

    function loadLogisticTable() {
        const unpaidTbody = document.getElementById('unpaid-table-body');
        const loading = document.getElementById('logistic-loading');
        const unpaidEmpty = document.getElementById('unpaid-empty');
        const paidEmpty = document.getElementById('paid-empty');
        const unpaidTable = document.getElementById('unpaid-table');
        const paidGridContainer = document.getElementById('paid-grid-container');
        const countEl = document.getElementById('logistic-count');

        unpaidTbody.innerHTML = '';
        paidGridContainer.innerHTML = '';
        loading.style.display = 'block';
        unpaidTable.style.display = 'none';
        unpaidEmpty.style.display = 'none';
        paidEmpty.style.display = 'none';

        let url = `{% url 'web_ui:finance:logistic_list_api' %}?sort_by=${currentSortBy}&sort_order=${currentSortOrder}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';

                if (!data.success) {
                    unpaidEmpty.innerHTML = `<i class="fas fa-exclamation-circle fa-2x text-danger opacity-50 mb-2"></i><p class="text-danger mb-0">${data.message}</p>`;
                    unpaidEmpty.style.display = 'block';
                    return;
                }

                logisticData = data.data || [];
                
                // 分离未付款和已付款
                const unpaidData = logisticData.filter(item => !item.is_paid);
                const paidData = logisticData.filter(item => item.is_paid);

                countEl.textContent = `共 ${logisticData.length} 条物流单`;
                document.getElementById('paid-count').textContent = paidData.length;
                document.getElementById('unpaid-count').textContent = unpaidData.length;

                function renderDualAmount(amountRmb, amountUsd) {
                    // Logistics always treats RMB as primary/base for display here, or we show both.
                    // To match deposit style: Primary Row (RMB), Secondary Row (USD)
                    
                    var rmbPart = 
                        '<div class="acct-row">' +
                            '<span class="badge bg-info" style="font-size:9px; width:32px;">RMB</span>' +
                            '<span class="amount-primary acct-amt">' + parseFloat(amountRmb).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span>' +
                        '</div>';
                        
                    var usdPart = 
                        '<div class="acct-row">' +
                            '<span class="badge bg-success" style="font-size:9px; width:32px;">USD</span>' +
                            '<span class="amount-secondary acct-amt">' + parseFloat(amountUsd).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span>' +
                        '</div>';
                        
                    return '<div class="acct-box">' + rmbPart + usdPart + '</div>';
                }

                function renderUnpaidRow(item, isChild = false, parentStatus = null) {
                    const indentClass = isChild ? 'child-row' : '';
                    const disabledAttr = isChild ? 'disabled' : '';
                    const checkedAttr = selectedLogistics.has(item.logistic_num) ? 'checked' : '';
                    const childIndicator = isChild ? '<i class="fas fa-level-up-alt fa-rotate-90 text-secondary me-2" style="font-size: 0.7rem;"></i>' : '';
                    const hasChildrenIcon = item.has_children ? '<i class="fas fa-sitemap text-info ms-2" style="font-size: 0.7rem;" data-i18n-title="tooltip.t6182" title="Contains Delayed"></i>' : '';
                    
                    const kgTag = '<span class="badge bg-secondary me-1" style="font-size:9px;">KG</span>';
                    const rmbTag = '<span class="badge bg-info me-1" style="font-size:9px;">RMB</span>';
                    
                    // 单价显示
                    let priceDisplay = rmbTag + '<span class="amount-primary">' + item.price_kg.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span>/kg';

                    // 总费显示 (使用 renderDualAmount)
                    let totalDisplay = renderDualAmount(item.total_price_rmb, item.total_price_usd);

                    // 重量显示
                    let weightDisplay = '<span class="amount-primary">' + item.total_weight.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span>' + kgTag;

                    return `
                        <tr class="${indentClass}" data-logistic-num="${item.logistic_num}" data-is-child="${isChild}" data-parent="${item.parent_num || ''}">
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox" 
                                       data-logistic-num="${item.logistic_num}"
                                       data-is-child="${isChild}"
                                       ${disabledAttr}
                                       ${checkedAttr}>
                            </td>
                            <td class="cell-logistic-num">
                                ${childIndicator}${item.logistic_num}${hasChildrenIcon}
                            </td>
                            <td>${item.date_sent}</td>
                            <td>
                                <div>${item.date_eta}</div>
                                ${item.eta_days !== null ? `<span class="badge bg-info bg-opacity-25 text-info mt-1" style="font-size: 9px;" data-i18n="ui.text_1259">${item.eta_days}天</span>` : ''}
                            </td>
                            <td>
                                <div>${item.receive_date}</div>
                                ${item.actual_days !== null ? `<span class="badge bg-success bg-opacity-25 text-success mt-1" style="font-size: 9px;" data-i18n="ui.text_1260">${item.actual_days}天</span>` : ''}
                            </td>
                            <td><span class="text-info fw-bold">${item.pallets}</span></td>
                            <td>
                                ${priceDisplay}
                            </td>
                            <td>
                                <div class="d-flex flex-column align-items-center">
                                    <span class="text-white fw-bold">${item.usd_rmb.toFixed(4)}</span>
                                    ${item.rate_mode ? `
                                        <span class="badge border ${item.rate_mode === 'A' ? 'bg-info bg-opacity-10 text-info border-info border-opacity-25' : 'bg-light bg-opacity-10 text-light border-secondary border-opacity-25'} mt-1" style="font-size: 9px; padding: 2px 6px;" data-i18n="ui.text_1261">
                                            ${item.rate_mode === 'A' ? (window.i18n?.t('js.auto_fetch') || 'Auto Fetch') : ((item.rate_mode === 'M' || item.rate_mode === 'MANUAL') ? (window.i18n?.t('js.manual_input') || 'Manual Input') : item.rate_mode)}
                                        </span>
                                    ` : ''}
                                </div>
                            </td>
                            <td>
                                ${weightDisplay}
                            </td>
                            <td>
                                ${totalDisplay}
                            </td>
                        </tr>
                    `;
                }
                
                // 渲染已付款行的HTML（无checkbox）
                function renderPaidRow(item, isChild = false) {
                    const indentClass = isChild ? 'child-row' : '';
                    const childIndicator = isChild ? '<i class="fas fa-level-up-alt fa-rotate-90 text-secondary me-2" style="font-size: 0.7rem;"></i>' : '';
                    const hasChildrenIcon = item.has_children ? '<i class="fas fa-sitemap text-info ms-2" style="font-size: 0.7rem;" data-i18n-title="tooltip.t6182" title="Contains Delayed"></i>' : '';
                    const rmbTag = '<span class="badge bg-info me-1" style="font-size:9px;">RMB</span>';
                    
                    // 单价
                    let priceDisplay = rmbTag + '<span class="amount-primary">' + item.price_kg.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span>/kg';
                    
                    // 总费 - Use Accounting Style (renderDualAmount)
                    let totalDisplay = renderDualAmount(item.total_price_rmb, item.total_price_usd);
                    
                    let weightDisplay = '<span class="amount-primary">' + item.total_weight.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span><span class="text-white-50 ms-1" style="font-size: 9px;">KG</span>';

                    // Exchange Rate Badge
                    var rateBadge = '';
                    if (item.rate_mode) {
                        var isAuto = item.rate_mode === 'A';
                        var badgeClass = isAuto ? 'bg-info bg-opacity-10 text-info border-info border-opacity-25' : 'bg-light bg-opacity-10 text-light border-secondary border-opacity-25';
                        var badgeText = (item.rate_mode === 'A') ? (window.i18n?.t('js.auto_fetch') || 'Auto Fetch') : ((item.rate_mode === 'M' || item.rate_mode === 'MANUAL') ? (window.i18n?.t('js.manual_input') || 'Manual Input') : item.rate_mode);
                        rateBadge = '<span class="badge border ' + badgeClass + ' mt-1" style="font-size: 9px; padding: 2px 6px;">' + badgeText + '</span>';
                    }

                    return `
                        <tr class="${indentClass}" data-logistic-num="${item.logistic_num}">
                            <td></td>
                            <td class="cell-logistic-num">
                                ${childIndicator}${item.logistic_num}${hasChildrenIcon}
                            </td>
                            <td>${item.date_sent}</td>
                            <td>${item.date_eta}</td>
                            <td>${item.receive_date}</td>
                            <td><span class="text-info fw-bold">${item.pallets}</span></td>
                            <td>
                                ${priceDisplay}
                            </td>
                            <td>
                                <div class="d-flex flex-column align-items-center">
                                    <span class="text-white fw-bold">${item.usd_rmb.toFixed(4)}</span>
                                    ${rateBadge}
                                </div>
                            </td>
                            <td>
                                ${weightDisplay}
                            </td>
                            <td>
                                ${totalDisplay}
                            </td>
                        </tr>
                    `;
                }
                
                // 渲染未付款表格
                if (unpaidData.length === 0) {
                    unpaidEmpty.style.display = 'block';
                } else {
                    unpaidTable.style.display = 'table';
                    unpaidData.forEach(item => {
                        unpaidTbody.innerHTML += renderUnpaidRow(item, false);
                        if (item.children && item.children.length > 0) {
                            item.children.forEach(child => {
                                child.parent_num = item.logistic_num;
                                unpaidTbody.innerHTML += renderUnpaidRow(child, true);
                            });
                        }
                    });
                }
                
                // 渲染已付款区域（按 pmt_no 分组为九宫格卡片）
                if (paidData.length === 0) {
                    paidEmpty.style.display = 'block';
                } else {
                    // 按 pmt_no 分组（仅处理父订单）
                    const paidByPmtNo = {};
                    paidData.forEach(item => {
                        const pno = item.pmt_no || item.payment_date || (window.i18n?.t('js.unknown') || 'Unknown');
                        if (!paidByPmtNo[pno]) {
                            paidByPmtNo[pno] = { parents: [], children: [] };
                        }
                        paidByPmtNo[pno].parents.push(item);
                        // 子单单独记录，仅用于显示物流单号
                        if (item.children && item.children.length > 0) {
                            item.children.forEach(child => {
                                paidByPmtNo[pno].children.push(child);
                            });
                        }
                    });
                    
                    // 提取年份列表（从 pmt_no 或 payment_date）
                    const years = new Set();
                    Object.keys(paidByPmtNo).forEach(pmtNo => {
                        // pmt_no 格式: YYYY-MM-DD_Sxx
                        const match = pmtNo.match(/^(\d{4})-/);
                        if (match) {
                            years.add(match[1]);
                        }
                    });
                    const sortedYears = Array.from(years).sort((a, b) => b - a);
                    
                    // 填充年份下拉框
                    const yearFilter = document.getElementById('paid-year-filter');
                    const currentYear = new Date().getFullYear().toString();
                    yearFilter.innerHTML = sortedYears.map(y => 
                        `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
                    ).join('') + '<option value="all" data-i18n="ui.text_1280">全部</option>';
                    
                    // 保存到全局供筛选使用
                    window.paidByPmtNo = paidByPmtNo;
                    
                    // 渲染卡片
                    renderPaidCards(yearFilter.value);
                    
                    // 绑定年份筛选事件
                    yearFilter.onchange = function() {
                        renderPaidCards(this.value);
                    };
                }
                

                // 绑定行点击事件（仅未付款表格）
                document.querySelectorAll('#unpaid-table-body tr:not(.child-row)').forEach(tr => {
                    tr.style.cursor = 'pointer';
                    tr.addEventListener('click', function(e) {
                        if (e.target.type === 'checkbox') return;
                        
                        const cb = this.querySelector('.row-checkbox');
                        if (!cb || cb.disabled) return;
                        
                        cb.checked = !cb.checked;
                        handleParentCheckboxChange(cb);
                    });
                });
                
                // 父单 checkbox 事件
                document.querySelectorAll('#unpaid-table-body .row-checkbox:not([data-is-child="true"])').forEach(cb => {
                    cb.addEventListener('change', function() {
                        handleParentCheckboxChange(this);
                    });
                });
                
                // 父单选中时联动选中所有子单
                function handleParentCheckboxChange(cb) {
                    const logisticNum = cb.dataset.logisticNum;
                    const parentRow = cb.closest('tr');
                    
                    if (cb.checked) {
                        selectedLogistics.add(logisticNum);
                        parentRow.classList.add('selected');
                        
                        // 联动选中所有子单
                        document.querySelectorAll(`#unpaid-table-body tr[data-parent="${logisticNum}"]`).forEach(childRow => {
                            const childCb = childRow.querySelector('.row-checkbox');
                            const childNum = childCb.dataset.logisticNum;
                            childCb.checked = true;
                            selectedLogistics.add(childNum);
                            childRow.classList.add('selected');
                        });
                    } else {
                        selectedLogistics.delete(logisticNum);
                        parentRow.classList.remove('selected');
                        
                        // 联动取消选中所有子单
                        document.querySelectorAll(`#unpaid-table-body tr[data-parent="${logisticNum}"]`).forEach(childRow => {
                            const childCb = childRow.querySelector('.row-checkbox');
                            const childNum = childCb.dataset.logisticNum;
                            childCb.checked = false;
                            selectedLogistics.delete(childNum);
                            childRow.classList.remove('selected');
                        });
                    }
                    updateSelectedCount();
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                unpaidEmpty.innerHTML = `<i class="fas fa-exclamation-circle fa-2x text-danger opacity-50 mb-2"></i><p class="text-danger mb-0">{% trans "加载失败" %}: ${err}</p>`;
                unpaidEmpty.style.display = 'block';
            });
    }

    function applyFilters() {
        const sortValue = document.getElementById('filter-sort').value;
        const [sortBy, sortOrder] = sortValue.split(':');
        currentSortBy = sortBy;
        currentSortOrder = sortOrder;
        loadLogisticTable();
    }

    function updateSelectedCount() {
        const count = selectedLogistics.size;
        document.getElementById('selected-count').textContent = count;
        document.getElementById('btn-batch-payment').disabled = count === 0;
    }

    function openPaymentWizard() {
        console.log('[LogisticPayment] selectedLogistics:', Array.from(selectedLogistics));
        console.log('[LogisticPayment] logisticData count:', logisticData.length);
        
        // 获取选中的物流单数据
        const selectedData = logisticData.filter(item => selectedLogistics.has(item.logistic_num));
        
        console.log('[LogisticPayment] selectedData count:', selectedData.length);
        
        if (selectedData.length === 0) {
            if (typeof createAndShowToast === 'function') {
                createAndShowToast('{% trans "请选择至少一条物流单" %}', 'warning');
            } else {
                alert('{% trans "请选择至少一条物流单" %}');
            }
            return;
        }
        
        // 先销毁旧的向导实例
        if (window.paymentWizard) {
            window.paymentWizard = null;
        }
        
        // 保存到全局变量供向导使用
        window.paymentItems = selectedData;
        window.extraFeeData = null;
        
        // 隐藏列表视图，显示向导视图
        document.getElementById('logistic-list-view').style.display = 'none';
        document.getElementById('payment-wizard-view').style.display = 'block';
        
        // 重置输入状态
        if (typeof resetWizardInputs === 'function') {
            resetWizardInputs();
        }
        
        // 初始化向导
        initPaymentWizard();
    }
    
    function closePaymentWizard() {
        // 隐藏向导视图，显示列表视图
        document.getElementById('payment-wizard-view').style.display = 'none';
        document.getElementById('logistic-list-view').style.display = 'block';
        
        // 清理状态
        window.paymentItems = [];
        window.paymentReceiptFile = null;
        
        // 销毁向导实例
        if (window.paymentWizard) {
            window.paymentWizard = null;
        }
        
        // 清除选中状态
        selectedLogistics.clear();
        updateSelectedCount();
        
        // 刷新列表
        loadLogisticTable();
    }
    
    function initPaymentWizard() {
        // 初始化 GlobalWizard
        window.paymentWizard = new GlobalWizard({
            containerId: 'payment-wizard-container',
            steps: [
                { id: 'intro', label: (window.i18n?.t('js.payment_notes') || 'Payment Notes'), contentSelector: '#step-intro' },
                { id: 'preview', label: (window.i18n?.t('js.confirm_rate') || 'Confirm Rate'), contentSelector: '#step-preview' },
                { id: 'confirm', label: (window.i18n?.t('js.confirm_fee') || 'Confirm Fee'), contentSelector: '#step-confirm' },
                { id: 'complete', label: (window.i18n?.t('js.payment_complete') || 'Payment Complete'), type: 'done', contentSelector: '#step-complete' }
            ],
            onStepChange: function(from, to) {
                console.log('[PaymentWizard] Step changed:', from, '->', to);
                
                // 回到 Step 0 时，清空后续步骤的所有输入和状态
                if (to === 0) {
                    resetWizardInputs();
                }
                
                // 根据步骤初始化内容
                if (to === 0 && typeof initStep1 === 'function') initStep1();
                if (to === 1 && typeof initStep2 === 'function') initStep2();
                if (to === 2 && typeof initStep3 === 'function') initStep3();
                if (to === 3 && typeof initStep4 === 'function') initStep4();
            },
            onBeforeNext: async function(currentStep) {
                // Step 3 -> Step 4: 执行付款
                if (currentStep.id === 'confirm') {
                    return await executePayment();
                }
                return true;
            },
            onComplete: function() {
                console.log('[PaymentWizard] Complete');
            },
            onRestart: function() {
                closePaymentWizard();
            }
        });
        
        // 绑定按钮事件
        bindWizardButtons();
        
        // 强制跳转到第一步（确保不会跳过）
        if (window.paymentWizard && typeof window.paymentWizard.goTo === 'function') {
            window.paymentWizard.goTo(0);
        }
        
        // 初始化第一步
        if (typeof initStep1 === 'function') initStep1();
    }
    
    // 重置向导所有输入状态（回到 Step 0 时调用）
    function resetWizardInputs() {
        console.log('[PaymentWizard] Resetting all wizard inputs');
        
        // 重置 Step 2 状态
        if (window.step2RateState) {
            window.step2RateState.usePaymentDateRate = false;
            window.step2RateState.paymentDate = '';
            window.step2RateState.settlementRate = 0;
            window.step2RateState.rateSource = 'original';
            window.step2RateState.originalRates = {};
        }
        
        // 重置付款日期开关
        const toggle = document.getElementById('use-payment-date-rate');
        if (toggle) toggle.checked = false;
        
        // 重置汇率显示
        const editableMode = document.getElementById('rate-editable-mode');
        const readonlyMode = document.getElementById('rate-readonly-mode');
        if (editableMode) editableMode.style.display = 'none';
        if (readonlyMode) readonlyMode.style.display = 'block';
        
        // 清空额外费用
        if (typeof hideExtraFeeSection === 'function') {
            hideExtraFeeSection();
        }
        
        // 清空全局额外费用数据
        window.extraFeeData = null;
        
        // 清空付款日期输入
        const paymentDateEl = document.getElementById('payment-date');
        if (paymentDateEl) paymentDateEl.value = '';
    }
    
    function bindWizardButtons() {
        // Step 1 按钮
        document.getElementById('btn-step1-next')?.addEventListener('click', () => window.paymentWizard.next());
        
        // Step 2 按钮
        document.getElementById('btn-step2-back')?.addEventListener('click', () => window.paymentWizard.back());
        document.getElementById('btn-step2-next')?.addEventListener('click', () => window.paymentWizard.next());
        
        // Step 3 按钮 (注意: next 按钮使用 onclick="confirmPaymentWithPassword()" 处理，不在这里绑定)
        document.getElementById('btn-step3-back')?.addEventListener('click', () => window.paymentWizard.back());
        // btn-step3-next 通过 onclick 调用 confirmPaymentWithPassword()，不需要在这里绑定
        
        // Step 4 按钮
        document.getElementById('btn-step4-done')?.addEventListener('click', () => {
            closePaymentWizard();
            loadLogisticTable();  // 刷新列表
        });
    }
    
    async function executePayment() {
        console.log('[PaymentWizard] Executing payment...');
        
        // TODO: 实际调用后端 API 完成付款
        // 目前为占位逻辑
        
        // 模拟成功
        console.log('[PaymentWizard] Payment completed (placeholder)');
        
        // 上传付款回执（如果有）
        if (typeof uploadPaymentReceipt === 'function') {
            await uploadPaymentReceipt();
        }
        
        return true;
    }
    
    // ========================================
    // 付款卡片操作按钮
    // ========================================
    
    /**
     * 异步检查付款文件状态并更新眼睛按钮
     */
    async function updatePaymentFileButtons(pmtNos) {
        for (const pmtNo of pmtNos) {
            try {
                const res = await fetch(`{% url 'web_ui:finance:check_payment_files' %}?pmt_no=${encodeURIComponent(pmtNo)}`);
                const data = await res.json();
                
                const btn = document.getElementById(`view-file-btn-${pmtNo}`);
                if (!btn) continue;
                
                if (data.success && data.data?.has_file) {
                    // 有文件，启用按钮
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.setAttribute('data-bs-title', (window.i18n?.t('js.view_payment_file') || 'View Payment File'));
                    
                    // 更新 tooltip
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (tooltip) {
                        tooltip.setContent({ '.tooltip-inner': (window.i18n?.t('js.view_payment_file') || 'View Payment File') });
                    }
                }
                // 无文件则保持默认禁用状态
            } catch (err) {
                console.error('[PaymentCard] Check file status error:', pmtNo, err);
            }
        }
    }
    
    function viewPaymentFile(pmtNo) {
        console.log('[PaymentCard] View file:', pmtNo);
        
        // 首先获取文件列表
        fetch(`{% url 'web_ui:finance:get_payment_files' %}?pmt_no=${encodeURIComponent(pmtNo)}`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    if (typeof createAndShowToast === 'function') {
                        createAndShowToast(data.message || '{% trans "获取文件列表失败" %}', 'error');
                    }
                    return;
                }
                
                const files = data.data?.files || [];
                
                if (files.length === 0) {
                    if (typeof createAndShowToast === 'function') {
                        createAndShowToast('{% trans "该付款批次暂无附件文件" %}', 'info');
                    }
                    return;
                }
                
                // 切换视图
                document.getElementById('logistic-list-view').style.display = 'none';
                document.getElementById('payment-file-viewer-view').style.display = 'block';
                
                // 初始化文件查看器
                if (typeof GlobalFileViewer !== 'undefined') {
                    new GlobalFileViewer({
                        containerId: 'payment-file-viewer-container',
                        title: '{% trans "付款文件查看" %}',
                        identifierLabel: '{% trans "付款号" %}',
                        identifierValue: pmtNo,
                        files: files,
                        currentFile: files[0]?.filename || '',
                        getFileUrl: (filename) => {
                            return `{% url 'web_ui:finance:serve_payment_file' %}?pmt_no=${encodeURIComponent(pmtNo)}&filename=${encodeURIComponent(filename)}`;
                        },
                        onUpload: () => {
                            // 切换到上传视图
                            document.getElementById('payment-file-viewer-view').style.display = 'none';
                            uploadPaymentFile(pmtNo);
                        },
                        onBack: () => {
                            document.getElementById('payment-file-viewer-view').style.display = 'none';
                            document.getElementById('logistic-list-view').style.display = 'block';
                        },
                        // 删除功能配置
                        deleteUrl: "{% url 'web_ui:finance:delete_payment_file' %}",
                        deletePayload: { pmt_no: pmtNo },
                        onDeleteSuccess: () => {
                            document.getElementById('payment-file-viewer-view').style.display = 'none';
                            document.getElementById('logistic-list-view').style.display = 'block';
                            loadLogisticTable();
                        },
                        requireDeletePassword: true,
                        deletePasswordActionKey: 'logistic_payment_file_delete'
                    });
                } else {
                    console.error('[PaymentCard] GlobalFileViewer not loaded');
                    if (typeof createAndShowToast === 'function') {
                        createAndShowToast('{% trans "文件查看器组件未加载，请刷新页面" %}', 'error');
                    }
                    document.getElementById('payment-file-viewer-view').style.display = 'none';
                    document.getElementById('logistic-list-view').style.display = 'block';
                }
            })
            .catch(err => {
                console.error('[PaymentCard] Error:', err);
                if (typeof createAndShowToast === 'function') {
                    createAndShowToast('{% trans "获取文件列表失败" %}', 'error');
                }
            });
    }
    
    function uploadPaymentFile(pmtNo) {
        console.log('[PaymentCard] Upload file:', pmtNo);
        
        // 切换视图
        document.getElementById('logistic-list-view').style.display = 'none';
        document.getElementById('payment-file-upload-view').style.display = 'block';
        
        // 初始化上传向导
        if (typeof GlobalFileUploadWizard !== 'undefined') {
            new GlobalFileUploadWizard({
                containerId: 'payment-file-upload-container',
                title: '{% trans "上传付款文件" %}',
                identifierLabel: '{% trans "付款号" %}',
                identifierValue: pmtNo,
                acceptedTypes: '.pdf,.jpg,.jpeg,.png,.gif,.heic,.heif,.xls,.xlsx,.doc,.docx,.csv,.zip,.rar',
                maxSizeMB: 50,
                checkExistingUrl: `{% url 'web_ui:finance:check_payment_files' %}?pmt_no=${encodeURIComponent(pmtNo)}`,
                uploadUrl: "{% url 'web_ui:finance:upload_payment_file' %}",
                uploadPayload: { pmt_no: pmtNo },
                requirePassword: true,
                passwordActionKey: 'logistic_payment_file_upload',
                onSuccess: () => {
                    document.getElementById('payment-file-upload-view').style.display = 'none';
                    document.getElementById('logistic-list-view').style.display = 'block';
                    loadLogisticTable();  // 刷新列表
                },
                onCancel: () => {
                    document.getElementById('payment-file-upload-view').style.display = 'none';
                    document.getElementById('logistic-list-view').style.display = 'block';
                }
            });
        } else {
            console.error('[PaymentCard] GlobalFileUploadWizard not loaded');
            if (typeof createAndShowToast === 'function') {
                createAndShowToast('{% trans "上传组件未加载，请刷新页面" %}', 'error');
            }
            document.getElementById('payment-file-upload-view').style.display = 'none';
            document.getElementById('logistic-list-view').style.display = 'block';
        }
    }
    
    function viewPaymentOrders(pmtNo) {
        console.log('[PaymentCard] View orders:', pmtNo);
        
        // 切换视图
        document.getElementById('logistic-list-view').style.display = 'none';
        document.getElementById('payment-orders-view').style.display = 'block';
        
        // 更新标题
        document.getElementById('orders-pmt-no-label').textContent = `付款号: ${pmtNo}`;
        
        const loading = document.getElementById('orders-loading');
        const content = document.getElementById('orders-content');
        const container = document.getElementById('orders-accordion-container');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        // 获取订单详情
        fetch(`{% url 'web_ui:finance:payment_orders' %}?pmt_no=${encodeURIComponent(pmtNo)}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-circle fa-3x text-danger opacity-50 mb-3"></i>
                            <p class="text-danger">${data.message || '{% trans "加载失败" %}'}</p>
                        </div>
                    `;
                    content.style.display = 'block';
                    return;
                }
                
                const orders = data.data?.orders || [];
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-white-50 opacity-50 mb-3"></i>
                            <p class="text-white-50">{% trans "暂无订单数据" %}</p>
                        </div>
                    `;
                    content.style.display = 'block';
                    return;
                }
                
                // 渲染订单折叠卡片
                let html = '';
                orders.forEach((order, index) => {
                    const collapseId = `order-collapse-${index}`;
                    const isFirst = index === 0;
                    
                    html += `
                        <div class="accordion-item bg-dark border-secondary mb-2">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${isFirst ? '' : 'collapsed'} bg-dark text-white" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                        aria-expanded="${isFirst}" aria-controls="${collapseId}">
                                    <div class="d-flex align-items-center w-100 me-3">
                                        <i class="fas fa-file-invoice me-3 text-primary"></i>
                                        <div class="flex-grow-1">
                                            <span class="fw-bold">${order.po_num}</span>
                                            <span class="badge bg-secondary ms-2">${order.supplier_code}</span>
                                        </div>
                                        <div class="text-end me-3">
                                            <span class="text-success">¥${order.total_rmb.toFixed(2)}</span>
                                            <span class="text-white-50 small ms-2">$${order.total_usd.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#orders-accordion-container">
                                <div class="accordion-body p-0">
                                    <!-- 订单基础信息 -->
                                    <div class="card bg-dark border-0 mb-0">
                                        <div class="card-header bg-primary bg-opacity-10 border-secondary">
                                            <i class="fas fa-info-circle me-2 text-primary"></i>
                                            <span class="text-white small">{% trans "订单基础信息" %}</span>
                                        </div>
                                        <div class="card-body p-3">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <div class="text-white-50 small mb-1">{% trans "订单号" %}</div>
                                                    <div class="text-white font-monospace">${order.po_num}</div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-white-50 small mb-1">{% trans "供应商" %}</div>
                                                    <div class="text-white fw-bold">${order.supplier_code}</div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-white-50 small mb-1">{% trans "订货日期" %}</div>
                                                    <div class="text-info">${order.order_date}</div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-white-50 small mb-1">{% trans "结算汇率" %}</div>
                                                    <div class="text-white">${order.exchange_rate ? order.exchange_rate.toFixed(4) : '-'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 订单明细 -->
                                    <div class="card bg-dark border-0">
                                        <div class="card-header bg-success bg-opacity-10 border-secondary">
                                            <i class="fas fa-list me-2 text-success"></i>
                                            <span class="text-white small">{% trans "订单明细" %}</span>
                                            <span class="badge bg-success ms-2">${order.items.length}</span>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-dark table-hover mb-0" style="font-size: 0.85rem;">
                                                    <thead>
                                                        <tr class="text-white-50">
                                                            <th>#</th>
                                                            <th>SKU</th>
                                                            <th class="text-center">{% trans "数量" %}</th>
                                                            <th class="text-center">{% trans "货币" %}</th>
                                                            <th class="text-end">{% trans "单价" %}</th>
                                                            <th class="text-end">{% trans "价值" %}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                    `;
                    
                    order.items.forEach((item, idx) => {
                        const currencyBadge = item.currency === 'USD' 
                            ? '<span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.7rem;">USD</span>'
                            : '<span class="badge bg-danger bg-opacity-25 text-danger" style="font-size: 0.7rem;">RMB</span>';
                        
                        html += `
                            <tr>
                                <td class="text-white-50">${idx + 1}</td>
                                <td class="font-monospace">${item.sku}</td>
                                <td class="text-center">${item.qty}</td>
                                <td class="text-center">${currencyBadge}</td>
                                <td class="text-end">${item.unit_price.toFixed(2)}</td>
                                <td class="text-end">
                                    <div class="d-flex flex-column align-items-end">
                                        <span class="text-success">¥${item.value_rmb.toFixed(2)}</span>
                                        <span class="text-info small">$${item.value_usd.toFixed(2)}</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                content.style.display = 'block';
            })
            .catch(err => {
                loading.style.display = 'none';
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger opacity-50 mb-3"></i>
                        <p class="text-danger">{% trans "网络错误" %}: ${err}</p>
                    </div>
                `;
                content.style.display = 'block';
            });
    }
    
    function closePaymentOrders() {
        document.getElementById('payment-orders-view').style.display = 'none';
        document.getElementById('logistic-list-view').style.display = 'block';
    }
    

    
    function viewPaymentHistory(pmtNo) {
        console.log('[PaymentCard] View history:', pmtNo);
        
        // 切换视图
        document.getElementById('logistic-list-view').style.display = 'none';
        document.getElementById('payment-history-view').style.display = 'block';
        
        // 更新标题
        document.getElementById('history-pmt-no-label').textContent = `付款号: ${pmtNo}`;
        
        const loading = document.getElementById('history-loading');
        const content = document.getElementById('history-content');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        
        // 获取历史记录
        fetch(`{% url 'web_ui:finance:payment_history' %}?pmt_no=${encodeURIComponent(pmtNo)}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (!data.success) {
                    document.getElementById('send-versions-container').innerHTML = `
                        <div class="empty-state"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><p>${data.message || '{% trans "加载失败" %}'}</p></div>
                    `;
                    document.getElementById('payment-versions-container').innerHTML = '';
                    content.style.display = 'flex';
                    return;
                }
                
                content.style.display = 'flex';
                renderSendVersions(data.data.send_versions || []);
                renderPaymentVersions(data.data.payment_versions || []);
            })
            .catch(err => {
                loading.style.display = 'none';
                document.getElementById('send-versions-container').innerHTML = `
                    <div class="empty-state"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>{% trans "网络错误" %}: ${err}</p></div>
                `;
                content.style.display = 'flex';
            });
    }
    
    // 渲染物流单信息修订记录 (in_send)
    function renderSendVersions(versions) {
        const container = document.getElementById('send-versions-container');
        document.getElementById('send-version-count').textContent = versions.length;
        
        if (!versions || versions.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox fa-2x mb-2"></i><p>{% trans "暂无物流单修订记录" %}</p></div>';
            return;
        }
        
        // 按物流单号分组
        const byLogistic = {};
        versions.forEach(v => {
            if (!byLogistic[v.logistic_num]) byLogistic[v.logistic_num] = [];
            byLogistic[v.logistic_num].push(v);
        });
        
        let html = '';
        Object.keys(byLogistic).forEach(logisticNum => {
            const records = byLogistic[logisticNum];
            
            html += `<div class="mb-3"><div class="text-white-50 small mb-2"><i class="fas fa-shipping-fast me-1"></i>${logisticNum}</div>`;
            
            records.forEach(v => {
                const headerClass = v.is_initial ? 'initial' : '';
                const badgeHtml = v.is_initial 
                    ? '<span class="badge bg-primary">{% trans "初始版本" %}</span>'
                    : '<span class="badge bg-warning text-dark">{% trans "汇率修订" %}</span>';
                
                html += `
                    <div class="version-card">
                        <div class="version-header ${headerClass}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="version-seq text-primary">${v.seq}</span>
                                ${badgeHtml}
                            </div>
                            <div class="version-meta">
                                <span><i class="fas fa-calendar"></i>${v.date_record || '-'}</span>
                                <span><i class="fas fa-user"></i>${v.by_user || '-'}</span>
                            </div>
                            ${v.note ? `<div class="text-white-50 small mt-2"><i class="fas fa-comment me-1"></i>${v.note}</div>` : ''}
                        </div>
                        <div class="version-body">
                `;
                
                if (v.is_initial) {
                    // 初始版本：显示完整信息表格
                    html += `
                        <table class="initial-card-table">
                            <tr><td data-i18n="purchase.shipping_date">发货日期</td><td>${v.data?.date_sent || '-'}</td></tr>
                            <tr><td data-i18n="js.pallets">托盘数</td><td>${v.data?.pallets || 0}</td></tr>
                            <tr><td data-i18n="ui.text_2510">重量(kg)</td><td>${v.data?.total_weight?.toFixed(2) || '0.00'}</td></tr>
                            <tr><td data-i18n="common.unit_price">单价</td><td><span class="badge bg-primary bg-opacity-25 text-primary me-1" style="font-size:0.6rem;">USD</span>${v.data?.price_kg?.toFixed(4) || '0.0000'}/kg</td></tr>
                            <tr><td data-i18n="ui.text_1254">运费</td><td><span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size:0.6rem;">RMB</span><span class="text-warning">${v.data?.total_price?.toFixed(2) || '0.00'}</span></td></tr>
                        </table>
                    `;
                } else if (v.changes && v.changes.length > 0) {
                    // 修订版本：显示变更对比
                    v.changes.forEach(c => {
                        html += `
                            <div class="change-item adjust">
                                <span class="text-white-50">${c.field}:</span>
                                <span class="change-old ms-2">${c.old}</span>
                                <span class="change-arrow"><i class="fas fa-arrow-right"></i></span>
                                <span class="change-new">${c.new}</span>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="text-white-50 small">{% trans "无变更" %}</div>';
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
        container.innerHTML = html;
    }
    
    // 渲染付款修订记录 (in_pmt_logistic)
    function renderPaymentVersions(versions) {
        const container = document.getElementById('payment-versions-container');
        document.getElementById('payment-version-count').textContent = versions.length;
        
        if (!versions || versions.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox fa-2x mb-2"></i><p>{% trans "暂无付款修订记录" %}</p></div>';
            return;
        }
        
        // 按物流单号分组
        const byLogistic = {};
        versions.forEach(v => {
            if (!byLogistic[v.logistic_num]) byLogistic[v.logistic_num] = [];
            byLogistic[v.logistic_num].push(v);
        });
        
        let html = '';
        Object.keys(byLogistic).forEach(logisticNum => {
            const records = byLogistic[logisticNum];
            
            html += `<div class="mb-3"><div class="text-white-50 small mb-2"><i class="fas fa-shipping-fast me-1"></i>${logisticNum}</div>`;
            
            records.forEach(v => {
                let headerClass = '';
                let badgeHtml = '';
                
                if (v.is_initial) {
                    headerClass = 'initial';
                    badgeHtml = '<span class="badge bg-primary">{% trans "原始付款" %}</span>';
                } else if (v.note && v.note.includes((window.i18n?.t('js.delete_payment') || 'Delete Payment'))) {
                    headerClass = 'delete-order';
                    badgeHtml = '<span class="badge bg-danger"><i class="fas fa-trash me-1"></i>{% trans "删除付款" %}</span>';
                } else if (v.note && v.note.includes((window.i18n?.t('js.edit_payment') || 'Edit Payment'))) {
                    badgeHtml = '<span class="badge bg-warning text-dark">{% trans "修改付款" %}</span>';
                } else {
                    badgeHtml = '<span class="badge bg-secondary">{% trans "修订" %}</span>';
                }
                
                html += `
                    <div class="version-card">
                        <div class="version-header ${headerClass}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="version-seq text-success">${v.seq}</span>
                                ${badgeHtml}
                            </div>
                            <div class="version-meta">
                                <span><i class="fas fa-calendar"></i>${v.date_record}</span>
                                <span><i class="fas fa-user"></i>${v.by_user || '-'}</span>
                            </div>
                            ${v.note ? `<div class="text-white-50 small mt-2"><i class="fas fa-comment me-1"></i>${v.note}</div>` : ''}
                        </div>
                        <div class="version-body">
                `;
                
                if (v.is_initial) {
                    // 初始版本：显示完整信息表格
                    const rate = v.usd_rmb || 7;
                    const logisticUsd = v.logistic_paid / rate;
                    const modeLabel = v.mode === 'A' ? '{% trans "自动" %}' : '{% trans "手动" %}';
                    const modeBadgeClass = v.mode === 'A' ? 'bg-success' : 'bg-warning text-dark';
                    
                    // 计算额外费用
                    let extraRmb = 0, extraUsd = 0;
                    if (v.extra_paid > 0) {
                        if (v.extra_currency === 'RMB') {
                            extraRmb = v.extra_paid;
                            extraUsd = v.extra_paid / rate;
                        } else {
                            extraUsd = v.extra_paid;
                            extraRmb = v.extra_paid * rate;
                        }
                    }
                    const totalRmb = v.logistic_paid + extraRmb;
                    const totalUsd = logisticUsd + extraUsd;
                    
                    html += `
                        <table class="initial-card-table">
                            <tr><td>{% trans "付款日期" %}</td><td>${v.payment_date || '-'}</td></tr>
                            <tr><td>{% trans "结算汇率" %}</td><td><span class="text-warning">${rate.toFixed(4)}</span> <span class="badge ${modeBadgeClass}" style="font-size:0.55rem;">${modeLabel}</span></td></tr>
                            <tr><td>{% trans "物流费" %}</td><td>
                                <span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size:0.6rem;">RMB</span><span class="text-success">${v.logistic_paid.toFixed(2)}</span>
                                <span class="badge bg-primary bg-opacity-25 text-primary ms-2 me-1" style="font-size:0.6rem;">USD</span><span class="text-info">${logisticUsd.toFixed(2)}</span>
                            </td></tr>
                            ${v.extra_paid > 0 ? `<tr><td>{% trans "附加费" %}${v.extra_note ? ' (' + v.extra_note + ')' : ''}</td><td>
                                <span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size:0.6rem;">RMB</span><span class="text-warning">${extraRmb.toFixed(2)}</span>
                                <span class="badge bg-primary bg-opacity-25 text-primary ms-2 me-1" style="font-size:0.6rem;">USD</span><span class="text-info">${extraUsd.toFixed(2)}</span>
                            </td></tr>` : ''}
                            <tr><td>{% trans "总费用" %}</td><td>
                                <span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size:0.6rem;">RMB</span><span class="text-success fw-bold">${totalRmb.toFixed(2)}</span>
                                <span class="badge bg-primary bg-opacity-25 text-primary ms-2 me-1" style="font-size:0.6rem;">USD</span><span class="text-info fw-bold">${totalUsd.toFixed(2)}</span>
                            </td></tr>
                        </table>
                    `;
                } else if (v.note && v.note.includes((window.i18n?.t('js.delete_payment') || 'Delete Payment'))) {
                    // 删除付款：特殊提示
                    html += '<div class="text-danger small"><i class="fas fa-exclamation-triangle me-1"></i>{% trans "付款已被删除，物流费归零" %}</div>';
                } else if (v.changes && v.changes.length > 0) {
                    // 修订版本：显示变更对比
                    v.changes.forEach(c => {
                        html += `
                            <div class="change-item adjust">
                                <span class="text-white-50">${c.field}:</span>
                                <span class="change-old ms-2">${c.old}</span>
                                <span class="change-arrow"><i class="fas fa-arrow-right"></i></span>
                                <span class="change-new">${c.new}</span>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="text-white-50 small">{% trans "无变更" %}</div>';
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        });
        
        container.innerHTML = html;
    }
    
    function closePaymentHistory() {
        document.getElementById('payment-history-view').style.display = 'none';
        document.getElementById('logistic-list-view').style.display = 'block';
    }
    
    function deletePayment(pmtNo) {
        console.log('[PaymentCard] Delete payment:', pmtNo);
        
        // Step 1: 显示确认对话框
        if (typeof GlobalModal === 'undefined' || !GlobalModal.showConfirm) {
            alert('{% trans "系统组件未加载，请刷新页面" %}');
            return;
        }
        
        GlobalModal.showConfirm({
            title: '{% trans "确认删除付款" %}',
            message: `<div class="text-center">
                <p class="mb-3">{% trans "您确定要删除付款记录吗？" %}</p>
                <p class="text-muted small mb-2">{% trans "付款号" %}: <strong class="text-danger">${pmtNo}</strong></p>
                <p class="text-warning small"><i class="fas fa-exclamation-triangle me-1"></i>{% trans "此操作将标记该批次付款为已删除" %}</p>
            </div>`,
            confirmText: '{% trans "确认删除" %}',
            confirmStyle: 'danger',
            onConfirm: () => {
                // Step 2: 密码验证
                // [Fix] 添加 350ms Closure Buffer，等待确认框关闭动画完成
                setTimeout(() => {
                    if (typeof requestPasswordVerify === 'function') {
                        requestPasswordVerify(
                            'logistic_payment_delete',
                            (passwords) => executeDeletePayment(pmtNo, passwords),
                            null,
                            '{% trans "删除付款" %}',
                            () => {
                                console.log('[PaymentCard] Password verification cancelled');
                            }
                        );
                    } else {
                        // 如果没有密码验证函数，直接执行（开发时）
                        executeDeletePayment(pmtNo, {});
                    }
                }, 350);
            }
        });
    }
    
    async function executeDeletePayment(pmtNo, passwords) {
        console.log('[PaymentCard] Executing delete for:', pmtNo);
        
        try {
            const requestBody = { pmt_no: pmtNo };
            
            // 添加密码到请求体
            if (passwords) {
                for (const [slot, code] of Object.entries(passwords)) {
                    requestBody[`sec_code_${slot}`] = code;
                }
            }
            
            const response = await fetch("{% url 'web_ui:finance:logistic_delete_payment' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(requestBody)
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (typeof createAndShowToast === 'function') {
                    createAndShowToast(result.message, 'success');
                }
                // 刷新列表
                loadLogisticTable();
            } else {
                if (typeof createAndShowToast === 'function') {
                    createAndShowToast(result.message || '{% trans "删除失败" %}', 'error');
                }
            }
        } catch (error) {
            console.error('[PaymentCard] Delete failed:', error);
            if (typeof createAndShowToast === 'function') {
                createAndShowToast('{% trans "删除失败" %}: ' + error.message, 'error');
            }
        }
    }

</script>
{% endblock %}