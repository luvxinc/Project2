<!-- 定金历史修订记录视图 (默认隐藏) -->
<div id="deposit-history-view" style="display: none;">
    <div class="glass-card p-4 shadow-lg">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
            <div class="d-flex align-items-center">
                <div class="bg-warning bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-history fa-2x text-warning"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_417">历史修订记录</h5>
                    <p class="text-white-50 small mb-0" id="deposit-history-pmt-label" data-i18n="ui.text_1321">付款单号: -</p>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="closeDepositHistory()">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
            </button>
        </div>

        <!-- Loading -->
        <div id="deposit-history-loading" class="text-center py-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="text-white-50 mt-3 mb-0" data-i18n="ui.text_707">正在加载历史记录...</p>
        </div>

        <!-- Content -->
        <div id="deposit-history-content" class="row g-4" style="display: none;">
            
            <!-- Left: Strategy Versions -->
            <div class="col-md-6 border-end border-secondary border-opacity-25">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-25 p-2 rounded-circle me-2">
                        <i class="fas fa-chess-knight text-primary"></i>
                    </div>
                    <h6 class="text-white mb-0" data-i18n="ui.text_708">策略修订记录</h6>
                    <span class="badge bg-secondary ms-2 rounded-pill" id="strategy-version-count">0</span>
                </div>
                <div class="history-timeline custom-scrollbar" style="max-height: 600px; overflow-y: auto;" id="strategy-versions-container">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- Right: Payment Versions -->
            <div class="col-md-6">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success bg-opacity-25 p-2 rounded-circle me-2">
                        <i class="fas fa-file-invoice-dollar text-success"></i>
                    </div>
                    <h6 class="text-white mb-0" data-i18n="ui.text_1554">定金支付记录</h6>
                    <span class="badge bg-secondary ms-2 rounded-pill" id="payment-version-count">0</span>
                </div>
                <div class="history-timeline custom-scrollbar" style="max-height: 600px; overflow-y: auto;" id="payment-versions-container">
                    <!-- JS Generated -->
                </div>
            </div>

        </div>
    </div>
</div>

<script>
/**
 * 查看定金历史记录
 * @param {string} pmtNo - 付款单号
 * @param {string} poNum - 订货单号 (Context)
 */
function viewDepositHistory(pmtNo, poNum) {
    console.log('[DepositHistory] View:', pmtNo, poNum);
    
    // Switch View
    // Try to find list view or hide whatever is visible
    const listView = document.getElementById('deposit-list-view');
    if (listView) listView.style.display = 'none';
    
    document.getElementById('deposit-history-view').style.display = 'block';
    
    // Update Header
    document.getElementById('deposit-history-pmt-label').innerHTML = `付款单号: <span class="font-monospace text-warning">${pmtNo}</span> <span class="mx-2">|</span> 订单: <span class="font-monospace text-info">${poNum}</span>`;
    
    const loading = document.getElementById('deposit-history-loading');
    const content = document.getElementById('deposit-history-content');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    
    // Fetch Data
    fetch(`/dashboard/finance/deposit/api/history/?pmt_no=${encodeURIComponent(pmtNo)}&po_num=${encodeURIComponent(poNum)}`)
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            content.style.display = 'flex';
            
            if (!data.success) {
                // Show Error in containers
                const errHtml = `<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.message || (window.i18n?.t('js.load_failed') || 'Load Failed')}</div>`;
                document.getElementById('strategy-versions-container').innerHTML = errHtml;
                document.getElementById('payment-versions-container').innerHTML = errHtml;
                return;
            }
            
            renderStrategyVersions(data.data.strategy_versions || []);
            renderDepositVersions(data.data.payment_versions || []);
        })
        .catch(err => {
            loading.style.display = 'none';
            content.style.display = 'flex';
            const errHtml = `<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>网络错误: ${err}</div>`;
            document.getElementById('strategy-versions-container').innerHTML = errHtml;
            document.getElementById('payment-versions-container').innerHTML = errHtml;
        });
}

function closeDepositHistory() {
    document.getElementById('deposit-history-view').style.display = 'none';
    // Restore List View
    const listView = document.getElementById('deposit-list-view');
    if (listView) listView.style.display = 'block';
}

function renderStrategyVersions(versions) {
    const container = document.getElementById('strategy-versions-container');
    document.getElementById('strategy-version-count').textContent = versions.length;
    
    if (versions.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-white-50"><i class="fas fa-inbox fa-2x mb-2 opacity-50"></i><p class="small mb-0" data-i18n="ui.text_1467">无策略修订记录</p></div>';
        return;
    }
    
    let html = '';
    versions.forEach(v => {
        const badgeHtml = v.is_initial 
            ? '<span class="badge bg-primary bg-opacity-50" data-i18n="ui.text_1468">初始策略</span>'
            : '<span class="badge bg-warning text-dark" data-i18n="ui.text_1469">策略修订</span>';
            
        html += `
            <div class="card bg-dark border-secondary border-opacity-50 mb-3 hover-shadow transition-all">
                <div class="card-header bg-black bg-opacity-25 border-bottom border-secondary border-opacity-25 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-primary font-monospace me-2">${v.seq || '-'}</span>
                            ${badgeHtml}
                        </div>
                        <small class="text-white-50"><i class="fas fa-clock me-1"></i>${v.date_record}</small>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2 text-white-50 small">
                        <i class="fas fa-user-circle me-1"></i> 操作人: <span class="text-white ms-1">${v.by_user}</span>
                    </div>
        `;
        
        if (v.is_initial) {
            html += `
                <div class="row g-2 small">
                    <div class="col-6">
                        <span class="text-white-50" data-i18n="ui.text_1470">结算货币:</span>
                        <span class="text-info ms-1">${v.data.cur_currency || '-'}</span>
                    </div>
                    <div class="col-6">
                        <span class="text-white-50" data-i18n="ui.text_1471">价格浮动:</span>
                        <span class="ms-1">${v.data.cur_float === 1 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-secondary py-1"></i>'}</span>
                        <span class="text-warning ms-1">${v.data.cur_ex_float}%</span>
                    </div>
                    <div class="col-6">
                        <span class="text-white-50" data-i18n="ui.text_1472">汇率浮动:</span>
                        <span class="ms-1">${v.data.cur_deposit === 1 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-secondary py-1"></i>'}</span>
                        <span class="text-warning ms-1">${v.data.cur_deposit_par}%</span>
                    </div>
                    <div class="col-6">
                        <span class="text-white-50" data-i18n="ui.text_1473">结算汇率:</span>
                        <span class="text-white ms-1 font-monospace">${v.data.cur_usd_rmb}</span>
                        <span class="badge ${v.data.cur_mode === 'A' ? 'bg-info' : 'bg-warning text-dark'} ms-1" style="font-size:0.55rem;" data-i18n="ui.text_1474">${v.data.cur_mode === 'A' ? (window.i18n?.t('js.auto') || 'Auto') : (window.i18n?.t('js.manual') || 'Manual')}</span>
                    </div>
                </div>
            `;
        } else if (v.changes.length > 0) {
            html += '<div class="d-flex flex-column gap-2">';
            v.changes.forEach(c => {
                 html += `
                    <div class="d-flex align-items-center text-small bg-black bg-opacity-25 p-2 rounded">
                        <span class="text-white-50 me-2" style="min-width: 80px;">${c.field}:</span>
                        <span class="text-white-50 text-decoration-line-through me-2">${c.old}</span>
                        <i class="fas fa-arrow-right text-success mx-2" style="font-size: 0.8rem;"></i>
                        <span class="text-warning fw-bold">${c.new}</span>
                    </div>
                `;
            });
            html += '</div>';
        } else {
            html += '<div class="text-white-50 fst-italic small" data-i18n="ui.text_2629">无实质变更</div>';
        }
        
        if (v.note) {
            html += `<div class="mt-2 pt-2 border-top border-secondary border-opacity-25 text-white-50 small"><i class="fas fa-quote-left me-1 opacity-50"></i>${v.note}</div>`;
        }
        
        html += `   </div>
            </div>`;
    });
    
    container.innerHTML = html;
}

function renderDepositVersions(versions) {
    const container = document.getElementById('payment-versions-container');
    document.getElementById('payment-version-count').textContent = versions.length;
    
    if (versions.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-white-50"><i class="fas fa-inbox fa-2x mb-2 opacity-50"></i><p class="small mb-0" data-i18n="ui.text_1563">无支付记录</p></div>';
        return;
    }
    
    let html = '';
    versions.forEach(v => {
        let badgeHtml = '';
        if (v.is_initial) badgeHtml = '<span class="badge bg-success bg-opacity-75" data-i18n="ui.text_1477">初始支付</span>';
        else if (v.note && v.note.includes((window.i18n?.t('js.delete') || 'Delete'))) badgeHtml = '<span class="badge bg-danger" data-i18n="common.deleted">已删除</span>';
        else badgeHtml = '<span class="badge bg-info text-dark" data-i18n="ui.text_1478">支付修订</span>';
        
        html += `
            <div class="card bg-dark border-secondary border-opacity-50 mb-3 hover-shadow transition-all">
                <div class="card-header bg-black bg-opacity-25 border-bottom border-secondary border-opacity-25 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-success font-monospace me-2">${v.seq || '-'}</span>
                            ${badgeHtml}
                        </div>
                        <small class="text-white-50"><i class="fas fa-clock me-1"></i>${v.date_record}</small>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2 text-white-50 small">
                        <i class="fas fa-user-circle me-1"></i> 操作人: <span class="text-white ms-1">${v.by_user}</span>
                    </div>
        `;
        
        if (v.is_initial) {
            // Display full details
            const d = v.data;
            html += `
                <table class="table table-dark table-sm table-borderless small mb-0">
                    <tr>
                        <td class="text-white-50" data-i18n="ui.text_2631">预付款抵扣:</td>
                        <td class="text-end"><span class="text-info">${d.dep_prepay_amount}</span> <span class="text-white-50" style="font-size:0.7em">${d.strategy_currency}</span></td>
                    </tr>
                    <tr>
                        <td class="text-white-50" data-i18n="ui.text_2632">定金支付:</td>
                        <td class="text-end"><span class="text-warning fw-bold">${d.dep_paid}</span> <span class="text-white-50" style="font-size:0.7em">${d.dep_cur}</span></td>
                    </tr>
                    <tr>
                        <td class="text-white-50" data-i18n="ui.text_2633">定金结算汇率:</td>
                        <td class="text-end text-white font-monospace">${d.dep_paid_cur}</td>
                    </tr>
                    <tr>
                        <td class="text-white-50" data-i18n="ui.text_2634">覆盖定金标准:</td>
                        <td class="text-end">${d.dep_override === 1 ? '<span class="text-danger" data-i18n="ui.text_1567">是</span>' : '<span class="text-white-50" data-i18n="ui.text_1568">否</span>'}</td>
                    </tr>
            `;
            
            if (d.extra_amount > 0) {
                 html += `
                    <tr>
                        <td class="text-white-50 pb-0" data-i18n="ui.text_2635">额外费用:</td>
                        <td class="text-end pb-0"><span class="text-warning">${d.extra_amount}</span> <span class="text-white-50" style="font-size:0.7em">${d.extra_cur}</span></td>
                    </tr>
                    <tr>
                        <td class="text-white-50 pt-0" colspan="2"><small class="fst-italic opacity-50">${d.extra_note}</small></td>
                    </tr>
                 `;
            }
            html += `</table>`;
            
        } else if (v.changes.length > 0) {
            html += '<div class="d-flex flex-column gap-2">';
            v.changes.forEach(c => {
                 html += `
                    <div class="d-flex align-items-center text-small bg-black bg-opacity-25 p-2 rounded">
                        <span class="text-white-50 me-2" style="min-width: 90px;">${c.field}:</span>
                        <span class="text-white-50 text-decoration-line-through me-2">${c.old}</span>
                        <i class="fas fa-arrow-right text-success mx-2" style="font-size: 0.8rem;"></i>
                        <span class="text-warning fw-bold">${c.new}</span>
                    </div>
                `;
            });
            html += '</div>';
        } else {
             html += '<div class="text-white-50 fst-italic small" data-i18n="ui.text_2629">无实质变更</div>';
        }
        
        if (v.note) {
            html += `<div class="mt-2 pt-2 border-top border-secondary border-opacity-25 text-white-50 small"><i class="fas fa-quote-left me-1 opacity-50"></i>${v.note}</div>`;
        }
        
        html += `   </div>
            </div>`;
    });
    
    container.innerHTML = html;
}
</script>