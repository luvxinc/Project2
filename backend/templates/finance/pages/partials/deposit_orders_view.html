<!-- 订单详情视图 (默认隐藏) -->
<div id="deposit-orders-view" style="display: none;">
    <div class="glass-card p-4 shadow-lg">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
            <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-boxes fa-2x text-info"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="finance.order_detail">订单详情</h5>
                    <p class="text-white-50 small mb-0" id="deposit-orders-pmt-label" data-i18n="ui.text_1321">付款单号: -</p>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="closeDepositOrdersView()">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
            </button>
        </div>

        <!-- 加载中 -->
        <div id="deposit-orders-loading" class="text-center py-5">
            <div class="spinner-border text-info" role="status"></div>
            <p class="text-white-50 mt-3 mb-0" data-i18n="purchase.loading_orders">正在加载订单数据...</p>
        </div>

        <!-- 订单内容 -->
        <div id="deposit-orders-content" style="display: none;">
            <div id="deposit-orders-container"></div>
        </div>
    </div>
</div>

<script>
/**
 * 查看付款批次关联的订单
 */
function viewDepositOrders(pmtNo) {
    // 切换视图
    document.getElementById('deposit-list-view').style.display = 'none';
    document.getElementById('deposit-orders-view').style.display = 'block';
    
    // 更新标题
    document.getElementById('deposit-orders-pmt-label').textContent = `付款单号: ${pmtNo}`;
    
    const loading = document.getElementById('deposit-orders-loading');
    const content = document.getElementById('deposit-orders-content');
    const container = document.getElementById('deposit-orders-container');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    
    // 获取订单详情
    fetch(`/dashboard/finance/deposit/api/orders/?pmt_no=${encodeURIComponent(pmtNo)}`)
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (!data.success) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-danger opacity-50 mb-3"></i>
                        <p class="text-danger" data-i18n="ui.text_710">${data.message || (window.i18n?.t('js.load_failed') || 'Load Failed')}</p>
                    </div>
                `;
                content.style.display = 'block';
                return;
            }
            
            const orders = data.data?.orders || [];
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-white-50 opacity-50 mb-3"></i>
                        <p class="text-white-50" data-i18n="finance.no_orders">暂无订单数据</p>
                    </div>
                `;
                content.style.display = 'block';
                return;
            }
            
            // 渲染订单卡片
            let html = '<div class="accordion" id="deposit-orders-accordion">';
            
            orders.forEach((order, index) => {
                const collapseId = `deposit-order-collapse-${index}`;
                const isFirst = index === 0;
                
                // 货币徽章
                const currencyBadge = order.currency === 'USD' 
                    ? '<span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.7rem;">USD</span>'
                    : '<span class="badge bg-danger bg-opacity-25 text-danger" style="font-size: 0.7rem;">RMB</span>';
                
                html += `
                    <div class="accordion-item bg-dark border-secondary mb-2">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'} bg-dark text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                    aria-expanded="${isFirst}" aria-controls="${collapseId}">
                                <div class="d-flex align-items-center w-100 me-3">
                                    <i class="fas fa-file-invoice me-3 text-info"></i>
                                    <div class="flex-grow-1">
                                        <span class="fw-bold">${order.po_num}</span>
                                        <span class="badge bg-secondary ms-2">${order.supplier_code}</span>
                                        ${currencyBadge}
                                    </div>
                                    <div class="text-end me-3">
                                        <span class="text-warning">¥${formatNumber(order.deposit_rmb)}</span>
                                        <span class="text-info small ms-2">$${formatNumber(order.deposit_usd)}</span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#deposit-orders-accordion">
                            <div class="accordion-body p-0">
                                <!-- 订单基础信息 -->
                                <div class="card bg-dark border-0 mb-0">
                                    <div class="card-header bg-info bg-opacity-10 border-secondary">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        <span class="text-white small" data-i18n="ui.text_632">订单基础信息</span>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2521">采购单号</div>
                                                <div class="text-white font-monospace">${order.po_num}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="common.supplier">供应商</div>
                                                <div class="text-white fw-bold">${order.supplier_code}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2195">订货日期</div>
                                                <div class="text-info">${order.po_date}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="table.settlement_rate">结算汇率</div>
                                                <div class="text-white">${order.exchange_rate ? order.exchange_rate.toFixed(4) : '-'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 定金付款信息 -->
                                <div class="card bg-dark border-0">
                                    <div class="card-header bg-warning bg-opacity-10 border-secondary">
                                        <i class="fas fa-coins me-2 text-warning"></i>
                                        <span class="text-white small" data-i18n="ui.text_1326">定金付款详情</span>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-3">
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="table.payment_date">付款日期</div>
                                                <div class="text-info">${order.payment_date}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="table.deposit_rate">定金比例</div>
                                                <div class="text-white">${order.deposit_percent}%</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2484">预付抵扣</div>
                                                <div class="text-success">¥${formatNumber(order.prepay_used_rmb || 0)}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="finance.this_payment">本次支付</div>
                                                <div class="text-warning">¥${formatNumber(order.actual_paid_rmb || 0)}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2529">付款总额(RMB)</div>
                                                <div class="text-warning fw-bold">¥${formatNumber(order.deposit_rmb)}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2530">付款总额(USD)</div>
                                                <div class="text-info fw-bold">$${formatNumber(order.deposit_usd)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 订单明细 -->
                                <div class="card bg-dark border-0 mt-2">
                                    <div class="card-header bg-success bg-opacity-10 border-secondary">
                                        <i class="fas fa-list me-2 text-success"></i>
                                        <span class="text-white small" data-i18n="ui.text_634">订单明细</span>
                                        <span class="badge bg-success ms-2">${order.items ? order.items.length : 0}</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-dark table-hover mb-0" style="font-size: 0.85rem;">
                                                <thead>
                                                    <tr class="text-white-50">
                                                        <th>#</th>
                                                        <th>SKU</th>
                                                        <th class="text-center" data-i18n="common.quantity">数量</th>
                                                        <th class="text-center" data-i18n="common.currency">货币</th>
                                                        <th class="text-end" data-i18n="common.unit_price">单价</th>
                                                        <th class="text-end" data-i18n="ui.text_2223">价值</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                `;
                                
                                if (order.items && order.items.length > 0) {
                                    order.items.forEach((item, idx) => {
                                        const currBadge = item.currency === 'USD' 
                                            ? '<span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.7rem;">USD</span>'
                                            : '<span class="badge bg-danger bg-opacity-25 text-danger" style="font-size: 0.7rem;">RMB</span>';
                                        
                                        html += `
                                            <tr>
                                                <td class="text-white-50">${idx + 1}</td>
                                                <td class="font-monospace">${item.sku}</td>
                                                <td class="text-center">${item.qty}</td>
                                                <td class="text-center">${currBadge}</td>
                                                <td class="text-end">${formatNumber(item.unit_price)}</td>
                                                <td class="text-end">
                                                    <div class="d-flex flex-column align-items-end">
                                                        <span class="text-success">¥${formatNumber(item.value_rmb)}</span>
                                                        <span class="text-info small">$${formatNumber(item.value_usd)}</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    });
                                } else {
                                    html += `<tr><td colspan="6" class="text-center text-white-50 py-3" data-i18n="ui.text_2535">无明细数据</td></tr>`;
                                }
                                
                                html += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            content.style.display = 'block';
        })
        .catch(err => {
            loading.style.display = 'none';
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger opacity-50 mb-3"></i>
                    <p class="text-danger" data-i18n="ui.text_490">网络错误: ${err}</p>
                </div>
            `;
            content.style.display = 'block';
        });
}

/**
 * 关闭订单视图
 */
function closeDepositOrdersView() {
    document.getElementById('deposit-orders-view').style.display = 'none';
    document.getElementById('deposit-list-view').style.display = 'block';
    
    // Auto-refresh list data when returning
    if (typeof loadDepositTable === 'function') {
        loadDepositTable();
    }
}
</script>