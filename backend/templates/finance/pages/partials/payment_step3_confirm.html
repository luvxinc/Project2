{% load i18n %}
<!-- Step 3: 确认费用 -->
<div class="row">
    <div class="col-12">
        <!-- 费用明细表 -->
        <div class="detail-table-container mb-4">
            <table class="table table-dark">
                <thead>
                    <tr>
                        <th class="text-center" data-i18n="table.logistics_no">物流单号</th>
                        <th class="text-center" data-i18n="purchase.shipping_date">发货日期</th>
                        <th class="text-center" data-i18n="ui.text_2515">物流重量 (KG)</th>
                        <th class="text-center" data-i18n="table.settlement_rate">结算汇率</th>
                        <th class="text-center" data-i18n="ui.text_2616">费用</th>
                    </tr>
                </thead>
                <tbody id="confirm-list-body">
                    <!-- JS动态填充 -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" class="text-end fw-bold" data-i18n="js.total_label">合计:</td>
                        <td class="text-end pe-3">
                            <div class="d-flex flex-column align-items-end">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-primary bg-opacity-25 text-primary me-2" style="font-size: 0.6rem; width: 30px;">USD</span>
                                    <span class="fw-bold text-info" style="min-width: 80px; text-align: right;" id="confirm-total-usd">$0.00</span>
                                </div>
                                <div class="d-flex align-items-center mt-1">
                                    <span class="badge bg-danger bg-opacity-25 text-danger me-2" style="font-size: 0.6rem; width: 30px;">RMB</span>
                                    <span class="fw-bold text-warning" style="min-width: 80px; text-align: right;" id="confirm-total-rmb">¥0.00</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- 额外费用/减免显示（若有） -->
        <div id="confirm-extra-fee-section" class="card bg-dark border-info border-opacity-50 mt-3" style="display: none;">
            <div class="card-header bg-info bg-opacity-10 border-info border-opacity-25 d-flex align-items-center" id="confirm-extra-header">
                <i class="fas fa-receipt text-info me-2" id="confirm-extra-icon"></i>
                <span class="text-info fw-bold" id="confirm-extra-title" data-i18n="table.extra_fees">额外费用</span>
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-0">
                    <thead>
                        <tr>
                            <th class="text-center" data-i18n="ui.icon_3381">费用内容</th>
                            <th class="text-center" data-i18n="ui.icon_3382">币种</th>
                            <th class="text-end pe-3" data-i18n="ui.icon_3383">金额</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center" id="confirm-extra-note">-</td>
                            <td class="text-center">
                                <span class="badge" id="confirm-extra-currency-badge">-</span>
                            </td>
                            <td class="text-end pe-3" id="confirm-extra-amount">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 总计汇总（当有额外费用时显示） -->
        <div id="confirm-total-summary-section" class="card bg-warning bg-opacity-10 border-warning border-opacity-50 mt-3" style="display: none;">
            <div class="card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span class="text-warning fw-bold"><i class="fas fa-calculator me-2"></i><span data-i18n="ui.icon_3384">本次付款总额</span></span>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex justify-content-end gap-4">
                            <div>
                                <span class="text-white-50 small">RMB</span>
                                <span class="text-warning fw-bold fs-5 ms-2" id="confirm-grand-total-rmb">¥0.00</span>
                            </div>
                            <div>
                                <span class="text-white-50 small">USD</span>
                                <span class="text-info fw-bold fs-5 ms-2" id="confirm-grand-total-usd">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 付款回执上传 -->
        <div class="card bg-dark border-secondary border-opacity-25 mb-4">
            <div class="card-header bg-secondary bg-opacity-10 border-0 d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-invoice me-2 text-warning"></i>
                    <span class="text-warning fw-bold" data-i18n="ui.text_1417">付款回执</span>
                </div>
                <span class="badge bg-secondary bg-opacity-50 text-white" data-i18n="common.optional">可选</span>
            </div>
            <div class="card-body">
                <p class="text-white-50 small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    可上传付款回执/银行转账凭证等文件。支持 PDF、图片、Excel、Word 格式，最大 10MB。
                </p>
                <!-- GlobalFileUpload 组件容器 -->
                <div id="payment-receipt-upload-container"></div>
            </div>
        </div>

        <!-- 警告栏 -->
        <div class="alert-block danger">
            <div class="alert-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="alert-content">
                <strong data-i18n="ui.text_1419">确认后将标记为已付款</strong>
                <p class="mb-0 mt-1 small" data-i18n="ui.text_1420">此操作会将选中的物流单状态更新为「已付款」，请确保信息无误。</p>
            </div>
        </div>
    </div>
</div>

<!-- Wizard Actions -->
<div class="wizard-actions mt-4">
    <div class="wizard-actions-left">
        <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step3-back">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.prev">上一步</span>
        </button>
    </div>
    <div class="wizard-actions-right">
        <button type="button" class="btn btn-warning rounded-pill px-4" id="btn-step3-next" onclick="confirmPaymentWithPassword()">
            <i class="fas fa-check me-2"></i><span data-i18n="ui.icon_3425">确认付款</span>
        </button>
    </div>
</div>

<script>
    // 付款回执上传器实例
    let paymentReceiptUploader = null;
    
    // Step 3 初始化
    function initStep3() {
        renderConfirmList();
        renderExtraFeeSection();
        initPaymentReceiptUpload();
    }
    
    // 渲染确认列表
    function renderConfirmList() {
        const tbody = document.getElementById('confirm-list-body');
        
        let totalRMB = 0;
        let totalUSD = 0;
        
        tbody.innerHTML = window.paymentItems.map((item, index) => {
            const rmb = item.total_price_rmb || 0;
            const rate = item.usd_rmb || 7.0;
            const usd = rmb / rate;
            
            totalRMB += rmb;
            totalUSD += usd;
            
            // 汇率来源标签
            const sourceTag = item._rateSource === 'auto' 
                ? '<span class="badge bg-success" style="font-size:0.55rem;" data-i18n="js.auto_fetch">自动获取</span>'
                : item._rateSource === 'manual'
                    ? '<span class="badge bg-warning text-dark" style="font-size:0.55rem;" data-i18n="ui.text_882">手动填写</span>'
                    : '<span class="badge bg-secondary" style="font-size:0.55rem;" data-i18n="ui.text_1316">订单原值</span>';
            
            return `
                <tr>
                    <td class="text-center font-monospace fw-bold text-white">${item.logistic_num}</td>
                    <td class="text-center">${item.date_sent}</td>
                    <td class="text-center">${item.total_weight ? item.total_weight.toFixed(2) : '-'}</td>
                    <td class="text-center">
                        <div class="d-flex flex-column align-items-center">
                            <span class="text-white fw-bold">${rate.toFixed(4)}</span>
                            ${sourceTag}
                        </div>
                    </td>
                    <td class="text-end pe-3">
                        <div class="d-flex flex-column align-items-end">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary bg-opacity-25 text-primary me-2" style="font-size: 0.6rem; width: 30px;">USD</span>
                                <span class="text-info" style="min-width: 80px; text-align: right;">$${usd.toFixed(2)}</span>
                            </div>
                            <div class="d-flex align-items-center mt-1">
                                <span class="badge bg-danger bg-opacity-25 text-danger me-2" style="font-size: 0.6rem; width: 30px;">RMB</span>
                                <span class="text-warning" style="min-width: 80px; text-align: right;">¥${rmb.toFixed(2)}</span>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('confirm-total-rmb').textContent = `¥${totalRMB.toFixed(2)}`;
        document.getElementById('confirm-total-usd').textContent = `$${totalUSD.toFixed(2)}`;
    }
    
    // 渲染额外费用区域
    function renderExtraFeeSection() {
        const extraSection = document.getElementById('confirm-extra-fee-section');
        const totalSection = document.getElementById('confirm-total-summary-section');
        
        // 检查是否有额外费用
        if (!window.extraFeeData || !window.extraFeeData.note || !window.extraFeeData.currency || window.extraFeeData.amount === undefined || window.extraFeeData.amount === 0) {
            extraSection.style.display = 'none';
            totalSection.style.display = 'none';
            return;
        }
        
        const { note, currency, amount, isDeduction } = window.extraFeeData;
        
        // 获取当前汇率
        const currentRate = window.paymentItems.length > 0 ? (window.paymentItems[0].usd_rmb || 7.0) : 7.0;
        
        // 计算双币金额
        let extraRMB = 0;
        let extraUSD = 0;
        if (currency === 'RMB') {
            extraRMB = amount;
            extraUSD = amount / currentRate;
        } else if (currency === 'USD') {
            extraUSD = amount;
            extraRMB = amount * currentRate;
        }
        
        // 根据正负更新标题和样式
        const header = document.getElementById('confirm-extra-header');
        const icon = document.getElementById('confirm-extra-icon');
        const title = document.getElementById('confirm-extra-title');
        const card = document.getElementById('confirm-extra-fee-section');
        
        if (isDeduction || amount < 0) {
            // 负数 = 额外减免
            card.className = 'card bg-dark border-success border-opacity-50 mt-3';
            header.className = 'card-header bg-success bg-opacity-10 border-success border-opacity-25 d-flex align-items-center';
            icon.className = 'fas fa-minus-circle text-success me-2';
            title.className = 'text-success fw-bold';
            title.textContent = window.i18n?.t('finance.extra_deduction') || '额外减免';
        } else {
            // 正数 = 额外费用
            card.className = 'card bg-dark border-info border-opacity-50 mt-3';
            header.className = 'card-header bg-info bg-opacity-10 border-info border-opacity-25 d-flex align-items-center';
            icon.className = 'fas fa-receipt text-info me-2';
            title.className = 'text-info fw-bold';
            title.textContent = window.i18n?.t('table.extra_fees') || '额外费用';
        }
        
        // 显示额外费用
        extraSection.style.display = 'block';
        totalSection.style.display = 'block';
        
        document.getElementById('confirm-extra-note').textContent = note;
        
        const currencyBadge = document.getElementById('confirm-extra-currency-badge');
        currencyBadge.textContent = currency;
        currencyBadge.className = currency === 'RMB' 
            ? 'badge bg-danger bg-opacity-25 text-danger' 
            : 'badge bg-primary bg-opacity-25 text-primary';
        
        // 双币显示，格式与物流单列表一致
        const absExtraRMB = Math.abs(extraRMB);
        const absExtraUSD = Math.abs(extraUSD);
        const sign = amount < 0 ? '-' : '';
        const amountClass = amount < 0 ? 'text-success' : 'text-info';
        const amountClassRMB = amount < 0 ? 'text-success' : 'text-warning';
        
        document.getElementById('confirm-extra-amount').innerHTML = `
            <div class="d-flex flex-column align-items-end">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary bg-opacity-25 text-primary me-2" style="font-size: 0.6rem; width: 30px;">USD</span>
                    <span class="${amountClass}" style="min-width: 80px; text-align: right;">${sign}$${absExtraUSD.toFixed(2)}</span>
                </div>
                <div class="d-flex align-items-center mt-1">
                    <span class="badge bg-danger bg-opacity-25 text-danger me-2" style="font-size: 0.6rem; width: 30px;">RMB</span>
                    <span class="${amountClassRMB}" style="min-width: 80px; text-align: right;">${sign}¥${absExtraRMB.toFixed(2)}</span>
                </div>
            </div>
        `;
        
        // 计算总计（正数加，负数减）
        let logisticsRMB = 0;
        let logisticsUSD = 0;
        window.paymentItems.forEach(item => {
            const rmb = item.total_price_rmb || 0;
            const rate = item.usd_rmb || 7.0;
            logisticsRMB += rmb;
            logisticsUSD += rmb / rate;
        });
        
        const grandTotalRMB = logisticsRMB + extraRMB;
        const grandTotalUSD = logisticsUSD + extraUSD;
        
        document.getElementById('confirm-grand-total-rmb').textContent = `¥${grandTotalRMB.toFixed(2)}`;
        document.getElementById('confirm-grand-total-usd').textContent = `$${grandTotalUSD.toFixed(2)}`;
    }
    
    // 初始化付款回执上传组件
    function initPaymentReceiptUpload() {
        if (typeof GlobalFileUpload !== 'undefined') {
            // 清理旧的实例（如果有）
            if (paymentReceiptUploader) {
                paymentReceiptUploader = null;
            }
            
            paymentReceiptUploader = new GlobalFileUpload({
                containerId: 'payment-receipt-upload-container',
                inputName: 'payment_receipt',
                title: (window.i18n?.t('js.upload_payment_receipt') || 'Upload Payment Receipt'),
                accept: '.pdf,.jpg,.jpeg,.png,.gif,.heic,.heif,.xls,.xlsx,.doc,.docx,.csv',
                maxSizeMB: 10,
                required: false,
                onFileSelect: (file) => {
                    console.log('[PaymentWizard] Receipt file selected:', file.name);
                    // 保存到全局状态，供 Step 4 完成后上传
                    window.paymentReceiptFile = file;
                },
                onFileRemove: () => {
                    console.log('[PaymentWizard] Receipt file removed');
                    window.paymentReceiptFile = null;
                },
                onError: (message) => {
                    console.error('[PaymentWizard] File upload error:', message);
                }
            });
            console.log('[PaymentWizard] Payment receipt uploader initialized');
        } else {
            console.warn('[PaymentWizard] GlobalFileUpload not available');
        }
    }
    
    // 上传付款回执（在 Step 4 完成后调用）
    // 文件保存路径: data/records/payment_logistic/YYYY/YYYYMMDD_payment_Ver01.{后缀}
    async function uploadPaymentReceipt() {
        const file = window.paymentReceiptFile;
        if (!file) return;  // 没有选择文件，跳过
        
        // 获取付款日期（从 Step 2 的状态中获取）
        const paymentDate = window.step2RateState ? window.step2RateState.paymentDate : '';
        if (!paymentDate) {
            console.warn('[PaymentWizard] Payment date not found, skip file upload');
            return;
        }
        
        console.log('[PaymentWizard] Uploading receipt for payment date:', paymentDate);
        
        // TODO: 待后续新增 API 路由时实现文件上传
        // 需要的参数: payment_date (YYYY-MM-DD), payment_receipt (file)
        console.log('[PaymentWizard] Receipt upload skipped - API not implemented');
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // ========================================
    // 密码验证与付款提交
    // ========================================
    
    // 确认付款（带密码验证）
    function confirmPaymentWithPassword() {
        console.log('[PaymentWizard] confirmPaymentWithPassword called');
        
        if (typeof requestPasswordVerify === 'function') {
            console.log('[PaymentWizard] Calling requestPasswordVerify...');
            requestPasswordVerify(
                'logistic_payment_confirm',
                (passwords) => {
                    console.log('[PaymentWizard] Password verified, passwords:', Object.keys(passwords));
                    submitPayment(passwords);
                },
                null,
                (window.i18n?.t('js.confirm_payment') || 'Confirm Payment'),
                () => {
                    console.log('[PaymentWizard] User cancelled');
                }
            );
        } else {
            console.log('[PaymentWizard] requestPasswordVerify not available');
            alert("{% trans '系统组件未加载，请刷新页面' %}");
        }
    }
    
    // 提交付款
    function submitPayment(passwords) {
        console.log('[PaymentWizard] submitPayment called');
        
        const btn = document.getElementById('btn-step3-next');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>处理中...';
        
        // 收集参数
        const logisticNums = window.paymentItems.map(item => item.logistic_num);
        const paymentDate = window.step2RateState ? window.step2RateState.paymentDate : '';
        const usePaymentDateRate = window.step2RateState ? window.step2RateState.usePaymentDateRate : false;
        const settlementRate = window.step2RateState ? window.step2RateState.settlementRate : 0;
        const rateSource = window.step2RateState ? window.step2RateState.rateSource : 'original';
        
        // 额外费用（支持正数=费用，负数=减免）
        let extraFee = null;
        if (window.extraFeeData && window.extraFeeData.note && window.extraFeeData.currency && window.extraFeeData.amount !== 0) {
            extraFee = {
                note: window.extraFeeData.note,
                currency: window.extraFeeData.currency,
                amount: window.extraFeeData.amount
            };
        }
        
        // 构建请求体
        const requestBody = {
            logistic_nums: logisticNums,
            payment_date: paymentDate,
            use_payment_date_rate: usePaymentDateRate,
            settlement_rate: settlementRate,
            rate_source: rateSource,
            extra_fee: extraFee
        };
        
        // 添加密码到请求体
        if (passwords) {
            for (const [slot, code] of Object.entries(passwords)) {
                requestBody[`sec_code_${slot}`] = code;
            }
        }
        console.log('[PaymentWizard] Request body keys:', Object.keys(requestBody));
        
        fetch("{% url 'web_ui:finance:logistic_submit_payment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestBody)
        })
        .then(r => r.json())
        .then(result => {
            console.log('[PaymentWizard] Response:', result);
            if (result.success) {
                // 上传回执文件（如果有）
                uploadPaymentReceipt();
                
                // 立即刷新列表数据（后台执行，不阻塞UI）
                if (typeof loadLogisticTable === 'function') {
                    loadLogisticTable();
                }
                
                // 进入 Step 4
                if (typeof window.paymentWizard !== 'undefined') {
                    window.paymentWizard.goToStep(3);
                }
                
                if (typeof createAndShowToast === 'function') {
                    createAndShowToast(result.message || (window.i18n?.t('js.payment_success') || 'Payment Success'), 'success');
                }
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                if (typeof createAndShowToast === 'function') {
                    createAndShowToast(result.message || (window.i18n?.t('js.payment_failed') || 'Payment Failed'), 'error');
                }
            }
        })
        .catch(err => {
            console.error('[PaymentWizard] Error:', err);
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (typeof createAndShowToast === 'function') {
                createAndShowToast("{% trans '网络错误: ' %}" + err, 'error');
            }
        });
    }
</script>