<!-- 预付款文件管理视图 (默认隐藏) -->
<!-- 使用 GlobalFileViewer 组件 -->
<div id="prepay-file-view" style="display: none;"></div>

<!-- 预付款文件上传向导容器 -->
<div id="prepay-file-upload-wizard-container" style="display: none;"></div>

<script>
// 当前文件视图实例
let prepayFileViewer = null;
let prepayFileUploadWizard = null;
let currentPrepayFileTranNum = null;
let currentPrepayFileSupplier = null;

/**
 * 关闭文件视图
 */
function closePrepayFileView() {
    document.getElementById('prepay-file-view').style.display = 'none';
    document.getElementById('prepay-file-upload-wizard-container').style.display = 'none';
    document.getElementById('prepay-list-view').style.display = 'flex';
    currentPrepayFileTranNum = null;
    currentPrepayFileSupplier = null;
    prepayFileViewer = null;
}

/**
 * 查看付款文件
 */
function viewPrepayFile(tranNum) {
    currentPrepayFileTranNum = tranNum;
    
    // 隐藏主视图
    document.getElementById('prepay-list-view').style.display = 'none';
    document.getElementById('prepay-file-upload-wizard-container').style.display = 'none';
    
    // 显示文件视图容器
    const viewContainer = document.getElementById('prepay-file-view');
    viewContainer.style.display = 'block';
    viewContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="text-white-50 mt-3" data-i18n="ui.text_1291">正在加载文件...</p></div>';
    
    // 获取文件信息
    fetch(`{% url 'web_ui:finance:prepay_file_info' %}?tran_num=${encodeURIComponent(tranNum)}`)
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                // 转换文件格式以兼容 GlobalFileViewer (name -> filename)
                const files = (result.data.files || []).map(f => ({
                    filename: f.name,
                    size: f.size,
                    modified: f.modified,
                    year: result.data.year
                }));
                showPrepayFileViewer(tranNum, files, result.data.supplier_code, result.data.year);
            } else {
                viewContainer.innerHTML = `<div class="glass-card p-4"><div class="text-center text-danger"><i class="fas fa-exclamation-circle fa-3x mb-3"></i><p data-i18n="ui.text_1292">${result.message || (window.i18n?.t('js.load_failed') || 'Load Failed')}</p><button class="btn btn-outline-secondary" onclick="closePrepayFileView()" data-i18n="common.back">返回</button></div></div>`;
            }
        })
        .catch(err => {
            viewContainer.innerHTML = `<div class="glass-card p-4"><div class="text-center text-danger"><i class="fas fa-exclamation-circle fa-3x mb-3"></i><p data-i18n="ui.text_490">网络错误: ${err}</p><button class="btn btn-outline-secondary" onclick="closePrepayFileView()" data-i18n="common.back">返回</button></div></div>`;
        });
}

/**
 * 显示文件查看器
 */
function showPrepayFileViewer(tranNum, files, supplierCode, year) {
    currentPrepayFileSupplier = supplierCode;
    
    // 使用 GlobalFileViewer 组件
    if (typeof GlobalFileViewer !== 'undefined') {
        prepayFileViewer = new GlobalFileViewer({
            containerId: 'prepay-file-view',
            title: (window.i18n?.t('js.view_payment_file') || 'View Payment File'),
            identifierLabel: (window.i18n?.t('js.transaction_no') || 'Transaction No'),
            identifierValue: tranNum,
            files: files,
            currentFile: files.length > 0 ? files[0].filename : null,
            getFileUrl: (fname, year) => `{% url 'web_ui:finance:prepay_serve_file' %}?tran_num=${encodeURIComponent(tranNum)}&filename=${encodeURIComponent(fname)}`,
            onUpload: () => uploadPrepayFile(tranNum),
            onBack: () => closePrepayFileView(),
            // 删除功能配置
            deleteUrl: '{% url "web_ui:finance:prepay_delete_file" %}',
            deletePayload: { tran_num: tranNum },
            onDeleteSuccess: () => viewPrepayFile(tranNum),  // 刷新文件列表
            // 启用密码验证
            requireDeletePassword: true,
            deletePasswordActionKey: 'btn_prepay_delete_file'
        });
    } else {
        document.getElementById('prepay-file-view').innerHTML = `
            <div class="glass-card p-4">
                <div class="text-center text-warning">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p data-i18n="ui.text_1298">文件查看组件未加载</p>
                    <button class="btn btn-outline-secondary" onclick="closePrepayFileView()" data-i18n="common.back">返回</button>
                </div>
            </div>
        `;
    }
}

/**
 * 上传付款文件（向导流程）
 */
function uploadPrepayFile(tranNum) {
    currentPrepayFileTranNum = tranNum;
    
    // 隐藏其他视图
    document.getElementById('prepay-list-view').style.display = 'none';
    document.getElementById('prepay-file-view').style.display = 'none';
    
    // 显示上传向导容器
    const wizardContainer = document.getElementById('prepay-file-upload-wizard-container');
    wizardContainer.style.display = 'block';
    
    // 使用 GlobalFileUploadWizard 或简化向导
    if (typeof GlobalFileUploadWizard !== 'undefined') {
        prepayFileUploadWizard = new GlobalFileUploadWizard({
            containerId: 'prepay-file-upload-wizard-container',
            title: (window.i18n?.t('js.upload_payment_file') || 'Upload Payment File'),
            identifierLabel: (window.i18n?.t('js.transaction_no') || 'Transaction No'),
            identifierValue: tranNum,
            uploadUrl: '{% url "web_ui:finance:prepay_upload_file" %}',
            uploadPayload: { tran_num: tranNum },
            accept: '.pdf,.jpg,.jpeg,.png,.gif,.heic,.heif,.xls,.xlsx,.doc,.docx,.csv,.zip,.rar',
            maxSizeMB: 50,
            onSuccess: () => {
                closePrepayFileUploadWizard();
                // 刷新交易列表
                if (window.selectedSupplierCode) {
                    loadTransactions(window.selectedSupplierCode);
                }
                if (typeof GlobalModal !== 'undefined') {
                    GlobalModal.showToast((window.i18n?.t('js.file_upload_success') || 'File Upload Success'), 'success');
                }
            },
            onCancel: () => closePrepayFileUploadWizard(),
            // 密码验证
            requirePassword: true,
            passwordActionKey: 'btn_prepay_upload_file'
        });
    } else {
        // 降级：使用简化的上传界面
        renderSimplePrepayUploadWizard(tranNum);
    }
}

/**
 * 关闭上传向导
 */
function closePrepayFileUploadWizard() {
    document.getElementById('prepay-file-upload-wizard-container').style.display = 'none';
    document.getElementById('prepay-list-view').style.display = 'flex';
    prepayFileUploadWizard = null;
    currentPrepayFileTranNum = null;
}

/**
 * 简化的上传向导（降级方案）
 */
function renderSimplePrepayUploadWizard(tranNum) {
    const container = document.getElementById('prepay-file-upload-wizard-container');
    container.innerHTML = `
        <div class="glass-card p-4 shadow-lg">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm rounded-pill me-3" onclick="closePrepayFileUploadWizard()">
                        <i class="fas fa-arrow-left me-2"></i>返回
                    </button>
                    <div>
                        <h5 class="text-white mb-0">
                            <i class="fas fa-upload text-info me-2"></i>上传付款文件
                        </h5>
                        <small class="text-white-50" data-i18n="ui.text_1508">流水号: ${tranNum}</small>
                    </div>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div id="prepay-simple-upload-container"></div>
            
            <!-- Actions -->
            <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top border-secondary border-opacity-25">
                <button class="btn btn-outline-secondary rounded-pill px-4" onclick="closePrepayFileUploadWizard()" data-i18n="common.cancel">
                    取消
                </button>
                <button class="btn btn-success rounded-pill px-4" id="btn-submit-prepay-file" onclick="submitPrepayFileUpload('${tranNum}')">
                    <i class="fas fa-upload me-2"></i>上传
                </button>
            </div>
        </div>
    `;
    
    // 初始化文件上传组件
    if (typeof GlobalFileUpload !== 'undefined') {
        window.prepaySimpleUploader = new GlobalFileUpload({
            containerId: 'prepay-simple-upload-container',
            inputName: 'prepay_file',
            title: (window.i18n?.t('js.upload_payment_file') || 'Upload Payment File'),
            accept: '.pdf,.jpg,.jpeg,.png,.gif,.heic,.heif,.xls,.xlsx,.doc,.docx,.csv,.zip,.rar',
            maxSizeMB: 50,
            required: true,
            onFileSelect: (file) => {
                console.log('[PrepayFileUpload] File selected:', file.name);
            }
        });
    }
}

/**
 * 提交文件上传
 */
function submitPrepayFileUpload(tranNum) {
    if (!window.prepaySimpleUploader) {
        if (typeof GlobalModal !== 'undefined') {
            GlobalModal.showToast((window.i18n?.t('js.upload_not_init') || 'Upload component not initialized'), 'error');
        }
        return;
    }
    
    const file = window.prepaySimpleUploader.getFile();
    if (!file) {
        if (typeof GlobalModal !== 'undefined') {
            GlobalModal.showToast((window.i18n?.t('js.select_file') || 'Select File'), 'warning');
        }
        return;
    }
    
    // 请求密码验证
    if (typeof requestPasswordVerify === 'function') {
        requestPasswordVerify(
            'btn_prepay_upload_file',
            (passwords) => {
                doSubmitPrepayFile(tranNum, file, passwords);
            },
            null,
            (window.i18n?.t('js.upload_file') || 'Upload File'),
            () => {
                console.log('[PrepayFileUpload] User cancelled');
            }
        );
    } else {
        doSubmitPrepayFile(tranNum, file, {});
    }
}

/**
 * 执行文件上传
 */
function doSubmitPrepayFile(tranNum, file, passwords) {
    const btn = document.getElementById('btn-submit-prepay-file');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>上传中...';
    
    const formData = new FormData();
    formData.append('tran_num', tranNum);
    formData.append('file', file);
    
    // 添加密码
    for (const [slot, code] of Object.entries(passwords)) {
        formData.append(`sec_code_${slot}`, code);
    }
    
    fetch('{% url "web_ui:finance:prepay_upload_file" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            closePrepayFileUploadWizard();
            // 刷新交易列表
            if (window.selectedSupplierCode) {
                loadTransactions(window.selectedSupplierCode);
            }
            if (typeof GlobalModal !== 'undefined') {
                GlobalModal.showToast(result.message || (window.i18n?.t('js.upload_success') || 'Upload Success'), 'success');
            }
        } else {
            btn.disabled = false;
            btn.innerHTML = originalText;
            if (typeof GlobalModal !== 'undefined') {
                GlobalModal.showToast(result.error || result.message || (window.i18n?.t('js.upload_failed') || 'Upload Failed'), 'error');
            }
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        if (typeof GlobalModal !== 'undefined') {
            GlobalModal.showToast((window.i18n?.t('js.network_error_colon') || 'Network Error: ') + err, 'error');
        }
    });
}

/**
 * 获取 CSRF Token
 */
function getCsrfToken() {
    const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
}

/**
 * 打开文件视图（兼容旧调用）
 */
function openPrepayFileView(tranNum, mode) {
    if (mode === 'upload') {
        uploadPrepayFile(tranNum);
    } else {
        viewPrepayFile(tranNum);
    }
}
</script>