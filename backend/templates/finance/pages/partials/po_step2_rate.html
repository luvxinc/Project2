<!-- Step 2: 确认汇率 (PO) -->
<div class="row">
    <div class="col-12">
        <!-- 操作须知 -->
        <div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4">
            <div class="card-header bg-info bg-opacity-10 border-0 d-flex align-items-center">
                <i class="fas fa-info-circle text-info me-2"></i>
                <span class="text-info fw-bold" data-i18n="common.operation_notes">操作须知</span>
            </div>
            <div class="card-body">
                <ul class="text-white-50 small mb-0 ps-3">
                    <li class="mb-2">
                        1. <strong data-i18n="ui.text_1330">汇率设定</strong>：<span data-i18n="instructions.desc_29">付款日期默认今天，汇率自动获取；若无法获取，请手动输入后点击「应用汇率」。</span>
                    </li>
                    <li class="mb-2">
                        2. <strong data-i18n="ui.text_2484">预付抵扣</strong>：<span data-i18n="instructions.desc_37">若供应商有预付款余额，开启「启用余额自动抵扣」可减少现金支出。</span>
                    </li>
                    <li class="mb-2">
                        3. <strong data-i18n="ui.text_1351">减免标记</strong>：<span data-i18n="instructions.desc_21">开启订单行的「减免」开关，表示本次付款后视为该订单货款结清（即使有剩余尾款）。</span>
                    </li>
                    <li class="mb-2">
                        4. <strong data-i18n="table.extra_fees">额外费用</strong>：<span data-i18n="instructions.desc_92">如有银行手续费等，点击「新增额外费用」录入，费用将平均分摊到各订单。</span>
                    </li>
                    <li>
                        5. <strong data-i18n="ui.text_1334">核对金额</strong>：<span data-i18n="instructions.desc_96">重点关注「本次支付」列的现金金额，确保与实际转账一致。</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Split Row: Modify Rate & Vendor Prepayment -->
        <div class="row g-4 mb-4">
            
            <!-- Left: Modify Rate -->
            <div class="col-md-6">
                <div class="card bg-dark border-warning border-opacity-50 h-100">
                    <div class="card-header bg-warning bg-opacity-10 border-warning border-opacity-25 d-flex align-items-center">
                        <i class="fas fa-edit text-warning me-2"></i>
                        <span class="text-warning fw-bold" data-i18n="ui.text_1309">修改汇率</span>
                    </div>
                    <div class="card-body">
                        <!-- Controls Row -->
                        <div class="row g-3">
                            <!-- Row 1: Payment Date -->
                            <div class="col-12 col-lg-6">
                                <label class="form-label text-white-50 small mb-2">
                                    <i class="fas fa-calendar-alt me-1"></i><span data-i18n="table.payment_date">付款日期</span>
                                </label>
                                <input type="date" class="form-control bg-dark border-secondary text-white" 
                                       id="payment-date" onchange="onPaymentDateChange()">
                            </div>
                            
                            <!-- Row 2: Toggle + Rate -->
                            <div class="col-12">
                                <div class="row g-3 align-items-end">
                                    <!-- Toggle -->
                                    <div class="col-7">
                                        <label class="form-label text-white-50 small mb-2">
                                            <i class="fas fa-lock me-1"></i><span data-i18n="ui.icon_3390">按付款日结算</span>
                                        </label>
                                        <div class="d-flex align-items-center" style="height: 38px;">
                                            <label class="ui-toggle ui-toggle-primary me-2">
                                                <input type="checkbox" id="use-payment-date-rate" checked disabled>
                                                <span class="ui-toggle-track"></span>
                                            </label>
                                            <span class="text-info small text-nowrap" id="toggle-label" data-i18n="ui.text_1355">付款日汇率（必选）</span>
                                        </div>
                                    </div>
                                    <!-- Rate -->
                                    <div class="col-5">
                                        <label class="form-label text-white-50 small mb-2">
                                            <i class="fas fa-dollar-sign me-1"></i><span data-i18n="table.settlement_rate">结算汇率</span>
                                        </label>
                                        <!-- Editable -->
                                        <div id="rate-editable-mode" style="display: none;">
                                            <div id="settlement-rate-container"></div>
                                        </div>
                                        <!-- Readonly -->
                                        <div id="rate-readonly-mode">
                                            <div class="d-flex align-items-center px-2 rounded bg-black bg-opacity-25" style="height: 38px;">
                                                <span class="text-white fw-bold text-truncate" id="readonly-rate-value">-</span>
                                                <span class="badge bg-secondary ms-1" style="font-size: 0.6rem;" data-i18n="log.god_mode.lock">锁定</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Button -->
                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-warning rounded-pill px-4" id="btn-save-rate"
                                    onclick="applyRateToList()" disabled>
                                <i class="fas fa-save me-2"></i><span data-i18n="ui.icon_3392">应用汇率</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Vendor Prepayment Options -->
            <div class="col-md-6">
                <div class="card bg-dark border-success border-opacity-50 h-100">
                    <div class="card-header bg-success bg-opacity-10 border-success border-opacity-25 d-flex align-items-center">
                        <i class="fas fa-wallet text-success me-2"></i>
                        <span class="text-success fw-bold" data-i18n="ui.text_1338">供货商预付款支付选项</span>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <!-- Supplier Info -->
                        <div class="d-flex align-items-center justify-content-between mb-3 px-1">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary bg-opacity-25 text-white-50 me-2" id="prepay-supplier-code">CODE</span>
                                <span class="text-white small fw-bold" id="prepay-supplier-name">Supplier Name</span>
                            </div>
                        </div>

                        <!-- Balance Info Block -->
                        <div class="bg-black bg-opacity-25 rounded p-3 mb-3 border border-secondary border-opacity-10">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white-50 small"><i class="fas fa-coins me-2"></i><span data-i18n="ui.icon_3393">可用余额</span></span>
                                <div class="text-end" id="balance-rows-container">
                                    <!-- USD Row -->
                                    <div class="d-flex align-items-center justify-content-end gap-2" id="balance-row-usd">
                                        <span class="badge bg-success text-white border border-success border-opacity-25 fw-normal">USD</span>
                                        <span class="text-white fw-bold" id="prepay-balance-usd">$0.00</span>
                                    </div>
                                    <!-- RMB Row -->
                                    <div class="d-flex align-items-center justify-content-end gap-2 mt-1" id="balance-row-rmb">
                                        <span class="badge bg-info text-white border border-info border-opacity-25 fw-normal">RMB</span>
                                        <span class="text-white fw-bold" id="prepay-balance-rmb">¥0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controls (Bottom Aligned) -->
                        <div class="d-flex align-items-center justify-content-end w-100 mt-auto">
                            <div class="d-flex align-items-center bg-black bg-opacity-25 px-3 py-2 rounded border border-secondary border-opacity-10">
                                <span class="text-white-50 small me-3">
                                    <i class="fas fa-toggle-on me-1"></i><span data-i18n="ui.icon_3394">启用余额自动抵扣</span>
                                </span>
                                <div class="d-flex align-items-center">
                                    <label class="ui-toggle ui-toggle-success me-2">
                                        <input type="checkbox" id="use-prepay-deduction" disabled onchange="renderPreviewList()">
                                        <span class="ui-toggle-track"></span>
                                    </label>
                                    <span class="text-white-50 small" id="prepay-toggle-label" style="min-width: 45px;" data-i18n="ui.text_1339">未使用</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<style>
    /* Step 2 Specific Styles (Reused from Step 1) */
    .step2-table-container {
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .step2-table thead th {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        padding: 14px 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .step2-table tbody td {
        padding: 14px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 13px;
        vertical-align: middle;
    }
    .acct-box {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        min-width: 90px;
    }
    .acct-row {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        justify-content: flex-end;
    }
    .acct-badge-usd {
        background-color: #198754; font-size: 9px; width: 32px; text-align: center; border-radius: 4px; padding: 1px 0;
    }
    .acct-badge-rmb {
        background-color: #0dcaf0; font-size: 9px; width: 32px; text-align: center; border-radius: 4px; padding: 1px 0;
    }
    .acct-amt { letter-spacing: -0.3px; }
    .acct-amt.primary { color: rgba(255, 255, 255, 0.9); }
    .acct-amt.secondary { color: rgba(255, 255, 255, 0.9); }
    .acct-amt.paid { color: #198754; }
    .acct-amt.pending { color: #ffc107; font-weight: bold; }
</style>

        <!-- 费用明细表 -->
        
        <!-- Summary Section (Moved Above Table) -->
        <!-- Summary Section (Restored Original Design, Moved Above Table) -->
        <div class="bg-black bg-opacity-25 p-4 border border-secondary border-opacity-25 rounded-3 mb-3">
            <div class="row row-cols-1 row-cols-md-6 g-3">
                <!-- 订单总金额 -->
                <div class="col border-end border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-2 text-center" data-i18n="table.total_amount">订单总金额</div>
                    <div class="d-flex justify-content-center">
                        <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-white fw-bold fs-5" id="step2-total-deposit-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-white-50 fw-bold" id="step2-total-deposit-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 已付金额 -->
                <div class="col border-end border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-2 text-center" data-i18n="ui.text_2554">已付金额</div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-success fw-bold fs-5" id="step2-total-paid-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-success text-opacity-75 fw-bold" id="step2-total-paid-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- NEW: Total Deduction -->
                <div class="col border-end border-secondary border-opacity-25">
                    <div class="text-success small mb-2 text-center" data-i18n="ui.text_2538">本次抵扣</div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-success fw-bold fs-5" id="step2-total-deduction-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-success fw-bold" id="step2-total-deduction-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Pending -->
                <div class="col border-end border-secondary border-opacity-25">
                     <div class="text-white-50 small mb-2 text-center" data-i18n="ui.text_2539">本次待付</div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-warning fw-bold fs-5" id="step2-total-pending-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-warning text-opacity-75 fw-bold" id="step2-total-pending-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- This Payment (Full Box) -->
                 <div class="col border-end border-secondary border-opacity-25 bg-info bg-opacity-10">
                    <div class="text-info small mb-2 text-center text-uppercase fw-bold" data-i18n="finance.this_payment">本次支付</div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-info fw-bold fs-4" id="step2-this-payment-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-info fw-bold fs-5" id="step2-this-payment-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 当前待付 -->
               <div class="col">
                    <div class="text-white-50 small mb-2 text-center" data-i18n="ui.text_2541">当前待付</div>
                   <div class="d-flex justify-content-center">
                        <div class="d-flex flex-column align-items-end gap-1">
                           <div class="d-flex align-items-center gap-2">
                               <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                               <span class="text-white fw-bold fs-5" id="step2-current-pending-usd">$0.00</span>
                           </div>
                           <div class="d-flex align-items-center gap-2">
                               <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                               <span class="text-white-50 fw-bold" id="step2-current-pending-rmb">¥0.00</span>
                           </div>
                       </div>
                   </div>
               </div>
            </div>
        </div>

        <div class="step2-table-container">
            <table class="table mb-0 step2-table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 9.1%;" data-i18n="table.order_no">订货单号</th>
                        <th class="text-center" style="width: 8.1%;" data-i18n="table.order_date">订单日期</th>
                        <th class="text-center" style="width: 7.1%;" data-i18n="ui.text_2544">订单结算货币</th>
                         <th class="text-center" style="width: 7.1%;" data-i18n="table.settlement_rate">结算汇率</th>
                        <th class="text-end pe-3" style="width: 8.1%;" data-i18n="table.total_amount">订单总金额</th>
                        <th class="text-end pe-3" style="width: 8.1%;" data-i18n="ui.text_2554">已付金额</th>
                        <th class="text-end pe-3 text-success" style="width: 8.1%;" data-i18n="ui.text_2538">本次抵扣</th>
                        <th class="text-end pe-3" style="width: 8.1%;" data-i18n="ui.text_2566">货款待付</th>
                        <th class="text-end pe-3 bg-info bg-opacity-10 text-info" style="width: 20.6%;" data-i18n="finance.this_payment">本次支付</th>

                        <th class="text-end pe-3 text-warning" style="width: 8.1%;" data-i18n="table.balance_remaining">尾款剩余</th>
                        <th class="text-center" style="width: 4.5%;" data-i18n="ui.text_1221">减免</th>
                    </tr>
                </thead>
                <tbody id="preview-list-body">
                    <!-- JS动态填充 -->
                </tbody>
            </table>
        </div>
        
        <!-- Summary Section (Removed from here, moved to top) -->
        
        <!-- 新增额外费用按钮 -->
        <div class="mt-3" id="add-extra-fee-btn-container">
            <button type="button" class="btn btn-outline-info btn-sm rounded-pill" id="btn-add-extra-fee" onclick="showExtraFeeSection()">
                <i class="fas fa-plus me-1"></i><span data-i18n="ui.icon_3379">新增额外费用</span>
            </button>
        </div>
        
        <!-- 额外费用框体（默认隐藏） -->
        <div class="bg-white bg-opacity-10 rounded-3 p-3 mt-3 border border-white border-opacity-10" id="extra-fee-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <span class="text-white fw-bold"><i class="fas fa-receipt text-info me-2"></i><span data-i18n="table.extra_fees">额外费用</span></span>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="hideExtraFeeSection()">
                    <i class="fas fa-trash-alt me-1"></i><span data-i18n="common.delete">删除</span>
                </button>
            </div>
            
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label text-white-50 small mb-1">
                        费用内容 <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fas fa-file-alt"></i></span>
                        <input type="text" class="form-control bg-dark border-secondary text-white" 
                               id="extra-fee-note" data-i18n-placeholder="form.placeholder.generic_22" placeholder="如：手续费等" 
                               oninput="validateExtraFee()">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-white-50 small mb-1">
                        结算币种 <span class="text-danger">*</span>
                    </label>
                    <div class="d-flex gap-2" id="extra-fee-currency-group">
                        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill text-white-50" id="btn-currency-rmb" onclick="setExtraFeeCurrency('RMB')" style="height: 38px;">RMB</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill text-white-50" id="btn-currency-usd" onclick="setExtraFeeCurrency('USD')" style="height: 38px;">USD</button>
                    </div>
                    <input type="hidden" id="extra-fee-currency" value="">
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white-50 small mb-1">
                        费用金额 <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fas fa-dollar-sign"></i></span>
                        <input type="number" class="form-control bg-dark border-secondary text-info fw-bold text-end font-monospace py-2" 
                               id="extra-fee-amount" placeholder="0.00" step="0.01" min="0.01"
                               style="font-size: 1.1em;"
                               oninput="validateExtraFee(); updateTotalSummary();">
                    </div>
                    <div class="text-white-50 small mt-1 text-end font-monospace" id="extra-fee-converted" style="font-size: 0.8em; min-height: 1.2em;"></div>
                </div>
            </div>
            <div id="extra-fee-error" class="text-danger small mt-2" style="display: none;"></div>
        </div>
        
        <!-- 总计汇总行（当有额外费用时显示） -->
        <div class="card bg-warning bg-opacity-10 border-warning border-opacity-50 mt-3" id="total-summary-section" style="display: none;">
            <div class="card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span class="text-warning fw-bold"><i class="fas fa-calculator me-2"></i><span data-i18n="ui.icon_3384">本次付款总额</span></span>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex justify-content-end gap-4">
                            <div>
                                <span class="text-white-50 small">RMB</span>
                                <span class="text-warning fw-bold fs-5 ms-2" id="grand-total-rmb">¥0.00</span>
                            </div>
                            <div>
                                <span class="text-white-50 small">USD</span>
                                <span class="text-info fw-bold fs-5 ms-2" id="grand-total-usd">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wizard Actions -->
<div class="wizard-actions mt-4">
    <div class="wizard-actions-left">
        <button type="button" class="btn btn-outline-secondary rounded-pill" id="btn-step2-back" onclick="if(window.paymentWizard) window.paymentWizard.back()">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="common.prev">上一步</span>
        </button>
    </div>
    <div class="wizard-actions-right">
        <button type="button" class="btn btn-success rounded-pill px-4" id="btn-step2-next">
            下一步 <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>
</div>

<script>
    // ========================================
    // Step 2: 确认汇率
    // ========================================
    
    // 汇率状态 (全局变量，供 Step 3/4 访问)
    window.step2RateState = {
        usePaymentDateRate: true,    // 必须按付款日结算（强制开启）
        paymentDate: '',             // 付款日期
        settlementRate: 0,           // 结算汇率
        rateSource: 'auto',          // 汇率来源: auto(自动获取), manual(手动填写)
        originalRates: {}            // 原始汇率 { po_num: rate }
    };
    
    // 结算汇率组件实例
    let settlementRateComponent = null;
    
    // Step 2 初始化
    function initStep2() {
        // Bind Buttons
        // Bind Buttons
        // Back Button handled via inline onclick
        /*
        const prevBtn = document.getElementById('btn-step2-back');
        if (prevBtn) {
            const newPrev = prevBtn.cloneNode(true);
            prevBtn.parentNode.replaceChild(newPrev, prevBtn);
            newPrev.addEventListener('click', () => {
                if(window.paymentWizard) window.paymentWizard.prev();
            });
        }
        */
        
        const nextBtn = document.getElementById('btn-step2-next');
        if (nextBtn) {
             const newNext = nextBtn.cloneNode(true);
             nextBtn.parentNode.replaceChild(newNext, nextBtn);
             newNext.addEventListener('click', () => {
                 if(window.paymentWizard) window.paymentWizard.next();
             });
        }

        // 设置默认付款日期为今天
        if (!window.step2RateState.paymentDate) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            window.step2RateState.paymentDate = today;
        } else {
             document.getElementById('payment-date').value = window.step2RateState.paymentDate;
        }
        
        // 保存原始汇率
        window.step2RateState.originalRates = {};
        window.paymentItems.forEach(item => {
            window.step2RateState.originalRates[item.po_num] = item.cur_usd_rmb || 7.0;
            // Initialize new fields for each item
            item._rateSource = 'auto'; // 默认自动获取（开关始终开启）

            item._coverStandard = false; // Whether to cover standard pending amount
            item.payment_mode = 'original'; // Default to original payment mode
            item.custom_amount = null; // For cash payment input
            item.custom_currency = null; // For cash payment input
        });
        
        // 渲染列表
        renderPreviewList();
        
        // 因为开关强制开启，自动显示汇率编辑器
        document.getElementById('rate-editable-mode').style.display = 'block';
        document.getElementById('rate-readonly-mode').style.display = 'none';
        initSettlementRateComponent();
        
        // 默认禁用保存按钮（直到获取到汇率）
        document.getElementById('btn-save-rate').disabled = true;
    }
    
    // 初始化结算汇率组件
    function initSettlementRateComponent() {
        if (settlementRateComponent) return;
        
        // API URL for rate fetching
        // Assuming web_ui:purchase:po_exchange_rate is available and suitable
        // If not, we might need a general finance valid rate URL.
        const apiUrl = '/dashboard/finance/hub/api/exchange_rate/'; // Fallback or explicit path if needed
        // But let's use the named URL if possible. For now, strict copy uses web_ui:purchase:po_exchange_rate
        
        settlementRateComponent = new GlobalExchangeRate({
            container: '#settlement-rate-container',
            inputId: 'settlement-rate',
            apiUrl: '{% url "web_ui:purchase:po_exchange_rate" %}', 
            dateInputSelector: '#payment-date',
            defaultRate: 7.25,
            showSourceTag: true,
            showStatusText: true,
            showFetchButton: true,
            placeholder: (window.i18n?.t('js.enter_rate') || 'Enter rate'),
            modalFallback: true,
            inputClass: 'form-control bg-dark border-warning text-white',
            onChange: (rate, source) => {
                const newRate = parseFloat(rate);
                window.step2RateState.settlementRate = newRate;
                window.step2RateState.rateSource = source === 'A' ? 'auto' : 'manual';
                
                // Update all items with new rate
                if (window.paymentItems && newRate > 0) {
                    window.paymentItems.forEach(item => {
                        item.cur_usd_rmb = newRate;
                        item._rateSource = window.step2RateState.rateSource;
                    });
                    renderPreviewList();
                }
                
                document.getElementById('btn-save-rate').disabled = !(newRate && newRate > 0);
            },
            onFetchSuccess: (rate) => {
                console.log('[POStep2] Rate fetched:', rate);
            },
            onFetchError: (error) => {
                console.warn('[POStep2] Rate fetch failed:', error);
            }
        });
    }
    
    function formatNumber(num) {
        return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // New renderRowAmount function
    const renderRowAmount2 = (val, valUsd, cur, cls = '') => {
        const v = parseFloat(val) || 0;
        const vUsd = parseFloat(valUsd) || 0;
        let html = `<div class="acct-box">`;
        const badgeColor = cur === 'USD' ? 'bg-success' : 'bg-info';
        // Primary Currency
        html += `<div class="acct-row">
                    <span class="badge ${badgeColor}" style="font-size:9px; width:32px;">${cur}</span>
                    <span class="acct-amt ${cls}">${formatNumber(v)}</span>
                 </div>`;
        // Secondary Currency
        if (cur !== 'USD') {
             html += `<div class="acct-row">
                        <span class="badge bg-success" style="font-size:9px; width:32px;">USD</span>
                        <span class="acct-amt secondary">${formatNumber(vUsd)}</span>
                      </div>`;
        }
        html += `</div>`;
        return html;
    };

    // 渲染预览列表
    function renderPreviewList() {
        const tbody = document.getElementById('preview-list-body');
        
        let totalDepositUSD = 0, totalDepositRMB = 0;
        let totalPaidUSD = 0, totalPaidRMB = 0;
        let totalDeductUSD = 0, totalDeductRMB = 0; // Allocation
        let totalPendingUSD = 0, totalPendingRMB = 0;
        let totalPaymentUSD = 0, totalPaymentRMB = 0;
        let totalCurrentPendingUSD = 0, totalCurrentPendingRMB = 0;

        // --- PRE-CALCULATION PASS: DEDUCTION ALLOCATION ---
        // Prioritize by PO Date Asc, PO Num Asc (Tail? Text sort works usually for standard POs)
        const usePrepay = document.getElementById('use-prepay-deduction')?.checked || false;
        
        // Reset allocation on all items
        window.paymentItems.forEach(i => i.allocated_deduction = 0);
        
        if (usePrepay && window.prepayState && window.prepayState.balanceBase > 0) {
            // Sort indices or copy
            // Create a sortable list of {index, date, code, needRMB}
            let queue = window.paymentItems.map((item, idx) => {
                 // Calculate Need in RMB (Base for pool)
                 const rate = item.cur_usd_rmb || 7.0;
                 const cur = item.cur_currency || 'RMB';
                 // 新逻辑：订单总金额 - 已付金额(定金+尾款)
                 const totalAmt = item.total_amount || 0;
                 const paidAmt = (item.deposit_paid || 0) + (item.po_paid || 0);
                 let needRmb = 0;
                 if (cur === 'RMB') needRmb = totalAmt - paidAmt;
                 else needRmb = (totalAmt - paidAmt) * rate;
                 return { idx: idx, date: item.po_date, code: item.po_num, needRmb: needRmb, item: item, rate: rate, cur: cur };
            });
            
            // Sort: Date asc, Code asc
            queue.sort((a, b) => {
                 if (a.date !== b.date) return a.date.localeCompare(b.date);
                 return a.code.localeCompare(b.code);
            });
            
            // Pool in RMB (Base)
            let poolRmb = 0;
            const balVal = window.prepayState.balanceBase || 0;
            const balCur = window.prepayState.currency || 'RMB';
             // Assuming Global Rate or Prepay Rate... 
             // We don't have a single rate for Prepay Balance if it's USD.
             // We typically normalize pool using *some* rate. 
             // For strictness, if Balance is USD and Item is RMB, we need rate.
             // We will use the *First PO's Rate* or a safe default if balance is not RMB.
             // Assume prepayState.currency is usually consistent with supplier strategy.
             // Let's use the first item's rate as proxy for 'current' exchange if needed.
             // Or better: Use the rate from the payment item we are paying to convert needed RMB back to Pool currency? 
             // No, Pool is fixed.
             // Let's Normalize Pool to RMB.
             let proxyRate = 7.0;
             if (window.paymentItems.length > 0) proxyRate = window.paymentItems[0].cur_usd_rmb || 7.0;
             
             if (balCur === 'RMB') poolRmb = balVal;
             else poolRmb = balVal * proxyRate;
            
            // Allocate
            for (let q of queue) {
                 if (poolRmb <= 0.001) break;
                 if (q.needRmb <= 0.001) continue;
                 
                 let allocRmb = Math.min(q.needRmb, poolRmb);
                 
                 // Store allocation in ITEM CURRENCY
                 if (q.cur === 'RMB') {
                     q.item.allocated_deduction = allocRmb;
                 } else {
                     q.item.allocated_deduction = allocRmb / q.rate;
                 }
                 
                 poolRmb -= allocRmb;
            }
        }
        // --------------------------------------------------

        window.paymentItems.forEach((item, index) => {
            const cur = item.cur_currency || 'RMB';
            const symbol = cur === 'RMB' ? '¥' : '$';
            // Use current active rate (modified or original)
            const rate = item.cur_usd_rmb || 7.0; 
            
            // 新逻辑：使用订单总金额和已付金额（定金+尾款）
            const total = item.total_amount || 0;
            const totalUsd = (cur === 'USD') ? total : total / rate;
            
            // 已付金额 = 已付定金 + 已付货款
            const paidAmount = (item.deposit_paid || 0) + (item.po_paid || 0);
            const paidAmountUsd = (cur === 'USD') ? paidAmount : paidAmount / rate;

            let pendingRmb = 0;
            let pendingUsd = 0;
            
            // 货款待付 = 订单总金额 - 已付金额
            let pendingBaseRmb = 0;
            let pendingBaseUsd = 0;
            
            if (cur === 'RMB') {
                pendingBaseRmb = total - paidAmount;
                pendingBaseUsd = pendingBaseRmb / rate;
            } else {
                 pendingBaseUsd = total - paidAmount;
                 pendingBaseRmb = pendingBaseUsd * rate;
            }
            
            // 2. Apply Prepayment Deduction (Prioritized)
            // Logic: We need to know who gets what.
            // Since we can't easily modify state in this map loop without a pre-calc pass,
            // we will do a Pre-Calc pass before this loop.
            // ... (See pre-calc block below)
            
            // Retrieve allocated deduction
            const deductAmt = item.allocated_deduction || 0; // In Item Currency
            const deductRmb = (cur==='RMB') ? deductAmt : deductAmt * rate;
            const deductUsd = (cur==='USD') ? deductAmt : deductAmt / rate;
            
            // 3. New Pending (After Deduction)
            // Reset checked variables (already declared above)
            pendingRmb = 0;
            pendingUsd = 0;
            
            if (cur === 'RMB') {
                pendingRmb = Math.max(0, pendingBaseRmb - deductAmt); // Deduct in RMB
                pendingUsd = pendingRmb / rate;
            } else {
                pendingUsd = Math.max(0, pendingBaseUsd - deductAmt); // Deduct in USD
                pendingRmb = pendingUsd * rate;
            }
            
            // Update item recalc
            item.recalc_pending_rmb = pendingRmb;
            item.recalc_pending_usd = pendingUsd;
            
            // 累加统计：订单总金额 和 已付金额
            if (cur === 'USD') {
                totalDepositUSD += total;  // 订单总金额
                totalDepositRMB += total * rate;
                totalPaidUSD += paidAmount;  // 已付金额(定金+货款)
                totalPaidRMB += paidAmount * rate;
            } else {
                totalDepositRMB += total;  // 订单总金额
                totalDepositUSD += total / rate;
                totalPaidRMB += paidAmount;  // 已付金额(定金+货款)
                totalPaidUSD += paidAmount / rate;
            }
            
            // Totals for Deduction
             totalDeductRMB += deductRmb; // Local var defined outside? No, need to define.
             totalDeductUSD += deductUsd;
            
            // Payment Logic (Cash + Prepay)
            let payAmountRmb = 0;
            let payAmountUsd = 0;
            let currPendingRmb = 0;
            let currPendingUsd = 0;

            // Calculate cash payment
            let cashPaymentRmb = 0;
            let cashPaymentUsd = 0;
            if (item.payment_mode === 'original') {
                cashPaymentRmb = pendingRmb;
                cashPaymentUsd = pendingUsd;
            } else if (item.payment_mode === 'custom') {
                const custAmt = parseFloat(item.custom_amount) || 0;
                const custCur = item.custom_currency || cur;
                if (custCur === 'RMB') {
                    cashPaymentRmb = custAmt;
                    cashPaymentUsd = custAmt / rate;
                } else {
                    cashPaymentUsd = custAmt;
                    cashPaymentRmb = custAmt * rate;
                }
            }

            // Total payment
            payAmountRmb = cashPaymentRmb;
            payAmountUsd = cashPaymentUsd;

            // Current pending after all payments
            currPendingRmb = pendingRmb - payAmountRmb;
            currPendingUsd = pendingUsd - payAmountUsd;
            // Removed 0 floor to allow negative "Current Pending" (Overpayment) to reflect in totals
            // if (currPendingRmb < 0) currPendingRmb = 0;
            // if (currPendingUsd < 0) currPendingUsd = 0;

            // Accumulate Payment & Remaining
            totalPaymentRMB += payAmountRmb;
            totalPaymentUSD += payAmountUsd;
            totalCurrentPendingRMB += currPendingRmb;
            totalCurrentPendingUSD += currPendingUsd;
            
            // Pending Total (Net) = Pending (After deduction)
            totalPendingRMB += pendingRmb;
            totalPendingUSD += pendingUsd;
        });
        
        // Pass Totals to State
        // Ensure totalDeductRMB is sum of all allocated_deduction normalized
        totalDeductRMB = window.paymentItems.reduce((acc, item) => {
             const amt = item.allocated_deduction || 0; 
             const rt = item.cur_usd_rmb || 7.0;
             const c = item.cur_currency || 'RMB';
             return acc + (c==='RMB' ? amt : amt * rt);
        }, 0);
        
        totalDeductUSD = totalDeductRMB / (window.paymentItems[0]?.cur_usd_rmb || 7.0); // Approx Global
        
        window.step2RateState.totals = {
             depRMB: totalDepositRMB,
             depUSD: totalDepositUSD,
             paidRMB: totalPaidRMB,
             paidUSD: totalPaidUSD,
             deductRMB: totalDeductRMB,
             deductUSD: totalDeductUSD,
             penRMB: totalPendingRMB, 
             penUSD: totalPendingUSD,
             payRMB: totalPaymentRMB,
             payUSD: totalPaymentUSD,
             currPenRMB: totalCurrentPendingRMB,
             currPenUSD: totalCurrentPendingUSD
        };
        
        tbody.innerHTML = window.paymentItems.map((item, index) => {
            const cur = item.cur_currency || 'RMB';
            const symbol = cur === 'RMB' ? '¥' : '$';
            const rate = item.cur_usd_rmb || 7.0; 
            
            // 订单总金额
            const totalAmount = item.total_amount || 0;
            const totalAmountUsd = (cur === 'USD') ? totalAmount : totalAmount / rate;
            
            // 已付金额 = 已付定金 + 已付货款
            const paidAmount = (item.deposit_paid || 0) + (item.po_paid || 0);
            const paidAmountUsd = (cur === 'USD') ? paidAmount : paidAmount / rate;
            
            // 货款待付 = 订单总金额 - 已付金额
            let pendingBaseRmb = 0;
            let pendingBaseUsd = 0;
            if (cur === 'RMB') {
                pendingBaseRmb = totalAmount - paidAmount;
                pendingBaseUsd = pendingBaseRmb / rate;
            } else {
                pendingBaseUsd = totalAmount - paidAmount;
                pendingBaseRmb = pendingBaseUsd * rate;
            }
            
            const deductAmt = item.allocated_deduction || 0;
            
            // Pending Net
            let pendingRmb = 0;
            let pendingUsd = 0;
            if (cur === 'RMB') {
                pendingRmb = Math.max(0, pendingBaseRmb - deductAmt);
                pendingUsd = pendingRmb / rate;
            } else {
                pendingUsd = Math.max(0, pendingBaseUsd - deductAmt);
                pendingRmb = pendingUsd * rate;
            }

            // Calculate cash payment for display
            let cashPaymentRmb = 0;
            let cashPaymentUsd = 0;
            
            // Auto Mode Logic: If Pending <= 0, Force 'original' (which means 0 payment / Completed)
            const isFullyCovered = (pendingRmb <= 0.01 && pendingUsd <= 0.01);
            if (isFullyCovered) {
                // If Item IS fully covered by deduction/paid, we FORCE Original Mode (Completed State)
                // And disable interaction (Handled in HTML generation)
                // We don't change state here to avoid loops, but we use this flag for rendering.
                // Actually, if we want to force logic:
                 if (item.payment_mode !== 'original') {
                     // item.payment_mode = 'original'; // Side effect? Safe in render? 
                     // Better to just treat it as 0 payment regardless.
                 }
                 // Payment is 0
                 cashPaymentRmb = 0;
                 cashPaymentUsd = 0;
            } else {
                 // Normal Logic
                if (item.payment_mode === 'original') {
                    cashPaymentRmb = pendingRmb;
                    cashPaymentUsd = pendingUsd;
                } else if (item.payment_mode === 'custom') {
                    const custAmt = parseFloat(item.custom_amount) || 0;
                    const custCur = item.custom_currency || cur;
                    if (custCur === 'RMB') {
                        cashPaymentRmb = custAmt;
                        cashPaymentUsd = custAmt / rate;
                    } else {
                        cashPaymentUsd = custAmt;
                        cashPaymentRmb = custAmt * rate;
                    }
                }
            }



            // Current pending after all payments
            let currPendingRmb = pendingRmb - cashPaymentRmb;
            let currPendingUsd = pendingUsd - cashPaymentUsd;
            // Removed: if (currPendingRmb < 0) check. We want to show negative pending if overpaid.
            // Also removed: if (currPendingUsd < 0) check.

            let sourceTag = '';
            if (item._rateSource === 'auto') {
                 sourceTag = '<span class="badge bg-success" style="font-size:0.55rem;" data-i18n="js.auto_fetch">自动获取</span>';
            } else if (item._rateSource === 'manual') {
                 sourceTag = '<span class="badge bg-warning text-dark" style="font-size:0.55rem;" data-i18n="ui.text_882">手动填写</span>';
            } else {
                 // Original Mode
                 const isAuto = (item.rate_source_code === 'AUTO');
                 const txt = isAuto ? '原始 (自动)' : (window.i18n?.t('js.original_manual') || 'Original (Manual)');
                 const color = isAuto ? 'bg-info bg-opacity-25 text-info' : 'bg-secondary bg-opacity-50 text-white-50'; 
                 sourceTag = `<span class="badge ${color} border border-opacity-25" style="font-size:0.55rem;">${txt}</span>`;
            }
            
            // Warning for overpayment
            let renderWarning = '';
            let rowClass = '';
            let warnStyle = '';
            const totalPaymentInSettleCur = (cur === 'RMB' ? cashPaymentRmb : cashPaymentUsd);
            const pendingInSettleCur = (cur === 'RMB' ? pendingRmb : pendingUsd);

            let isOverpayment = false;
            let isEqualPayment = false;

            if (totalPaymentInSettleCur > (pendingInSettleCur + 0.01)) {
                 isOverpayment = true;
            } else if (Math.abs(totalPaymentInSettleCur - pendingInSettleCur) < 0.01) {
                 isEqualPayment = true;
            }

            // 1. Row Highlight for Custom Mode
            if (item.payment_mode === 'custom') {
                warnStyle += "background-color: rgba(13, 202, 240, 0.05) !important;"; 
            }

            // Force Logic state
            if (isOverpayment) item._coverStandard = true;
            if (isEqualPayment) item._coverStandard = false;
            
            const isCover = item._coverStandard === true;

            // Determine if toggle is disabled
            // Disabled if Overpayment (Forced ON) OR Equal Payment (Forced OFF)
            const isToggleDisabled = (isOverpayment || isEqualPayment);

            return `
                <tr class="${rowClass}" style="${warnStyle}">
                    <td class="text-center font-monospace fw-bold text-white">${item.po_num}</td>
                    <td class="text-center">${item.po_date}</td>
                    
                    <!-- Settlement Currency -->
                    <td class="text-center">
                        <span class="badge ${cur==='RMB'?'bg-info':'bg-success'} text-white border border-opacity-25" style="width: 50px;">
                            ${cur}
                        </span>
                    </td>
                    
                    <!-- Rate -->
                    <td class="text-center">
                        <div class="d-flex flex-column align-items-center">
                            <span class="text-white fw-bold">${rate.toFixed(4)}</span>
                            ${sourceTag}
                        </div>
                    </td>

                    <!-- 订单总金额 -->
                    <td class="text-end pe-3">${renderRowAmount2(totalAmount, totalAmountUsd, cur)}</td>
                    
                    <!-- 已付金额 -->
                    <td class="text-end pe-3">${renderRowAmount2(paidAmount, paidAmountUsd, cur, 'text-success-emphasis')}</td>
                    
                    <!-- Deduction -->
                    <td class="text-end pe-3">
                        ${(Math.abs(deductAmt) > 0.001) ? renderRowAmount2((cur==='RMB' ? deductAmt : deductAmt*rate), (cur==='USD'?deductAmt : deductAmt/rate), cur, 'text-success text-opacity-75') : '<span class="text-white-50 small">-</span>'}
                    </td>
                    
                    <!-- Pending -->
                    <td class="text-end pe-3">${renderRowAmount2((cur==='RMB'?pendingRmb:pendingUsd), pendingUsd, cur, 'text-warning')}</td>

                    <!-- This Payment (Cash) -->

                    <!-- This Payment (Interactive) -->
                    <td class="text-end pe-3 bg-info bg-opacity-10 border-start border-info border-opacity-25">
                        <!-- Mode Switcher -->
                        <div class="d-flex justify-content-end mb-2">
                             <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button" class="btn ${item.payment_mode === 'original' ? 'btn-info text-dark fw-bold' : 'btn-outline-secondary text-white-50'}" 
                                        style="font-size: 0.75rem; padding: 0.2rem 0.5rem;"
                                        onclick="setPaymentMode(${index}, 'original')" data-i18n="ui.text_1342">原额</button>
                                <button type="button" class="btn ${item.payment_mode === 'custom' ? 'btn-info text-dark fw-bold' : 'btn-outline-secondary text-white-50'}" 
                                        style="font-size: 0.75rem; padding: 0.2rem 0.5rem;"
                                        onclick="setPaymentMode(${index}, 'custom')" data-i18n="ui.text_1343">自定义</button>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div style="height: 35px; width: 100%;">
                        ${ item.payment_mode === 'original' ? `
                            <!-- Original Mode: Show Pending Amount -->
                            <div class="d-flex flex-column align-items-end justify-content-center h-100 w-100">
                                <div class="d-flex align-items-center">
                                    <span class="badge ${cur==='RMB'?'bg-info':'bg-success'} me-1" style="font-size: 0.65rem; padding: 2px 4px;">${cur}</span>
                                    <span class="text-info fw-bold fs-6" style="letter-spacing: -0.3px;">
                                        ${formatNumber(cur==='RMB' ? pendingRmb : pendingUsd)}
                                    </span>
                                </div>
                                <div class="text-white-50 small" style="font-size: 0.65rem;">
                                    剩余待付全额 ${cur === 'RMB' ? `<span class="opacity-50 ms-1">≈ $${formatNumber(pendingUsd)}</span>` : ''}
                                </div>
                            </div>
                        ` : `
                            <!-- Custom Mode: Compact Layout (Row) -->
                             <div class="d-flex align-items-center justify-content-between h-100 w-100">
                                <!-- Input Controls (Left Side - 50% WIDTH) -->
                                <div class="input-group input-group-sm me-2" style="width: 65%;">
                                    <button type="button" class="btn ${item.custom_currency === 'RMB' ? 'btn-info text-white fw-bold' : 'btn-outline-secondary text-white-50'}" 
                                            style="font-size: 0.65rem; padding: 0.25rem 0.3rem;"
                                            onclick="setCustomCurrency(${index}, 'RMB')">RMB</button>
                                    <button type="button" class="btn ${item.custom_currency === 'USD' ? 'btn-success text-white fw-bold' : 'btn-outline-secondary text-white-50'}" 
                                            style="font-size: 0.65rem; padding: 0.25rem 0.3rem;"
                                            onclick="setCustomCurrency(${index}, 'USD')">USD</button>
                                    
                                    <input type="number" class="form-control bg-dark border-secondary text-end text-white fw-bold" 
                                        value="${item.custom_amount}"
                                        step="0.01"
                                        style="border-left: 0; letter-spacing: -0.3px;"
                                        id="pay-input-${index}"
                                        oninput="onCustomAmountInput(${index}, this.value)">
                                </div>
                                
                                <!-- Right Side Info (Warnings / Hints) - Remaining Space -->
                                <div class="d-flex flex-column align-items-end justify-content-center" style="flex: 1; min-width: 70px;">
                                     <!-- Top Line: Converted Amount with Badge (Matches Original Mode) -->
                                     <div id="cust-conv-${index}" class="d-flex align-items-center justify-content-end" style="height: 18px;">
                                        ${ (() => {
                                             const cRate = item.cur_usd_rmb || 7.0;
                                             const cAmt = parseFloat(item.custom_amount)||0;
                                             let cVal = 0;
                                             let cCur = '';
                                             if ((item.custom_currency || 'RMB') === 'RMB') { 
                                                 cVal = cAmt / cRate; 
                                                 cCur = 'USD'; 
                                             } else { 
                                                 cVal = cAmt * cRate; 
                                                 cCur = 'RMB'; 
                                             }
                                             const badgeColor = cCur === 'RMB' ? 'bg-info' : 'bg-success';
                                             return `<span class="badge ${badgeColor} me-1" style="font-size: 0.65rem; padding: 2px 4px;">${cCur}</span>
                                                     <span class="text-white-50 fw-bold" style="font-size: 0.9rem; letter-spacing: -0.3px;">${formatNumber(cVal)}</span>`;
                                        })() }
                                     </div>
                                     
                                     <!-- Bottom Line: Warning or Secondary Info -->
                                     <div id="cust-warn-${index}" class="text-end" style="font-size: 0.65rem; height: 14px; margin-top: 1px;">
                                        ${ isOverpayment ? 
                                            `<span class="text-danger fw-bold" data-i18n="ui.text_1344">⚠️ 超出待付金额</span>` : 
                                            `<span class="text-white-50 opacity-50" data-i18n="ui.text_1345">折算金额参考</span>` 
                                        }
                                     </div>
                                </div>
                             </div>
                        `}
                        </div>
                        

                    </td>
                    


                    <!-- 尾款剩余 -->
                    <td class="text-end pe-3 bg-white bg-opacity-10 border-start border-white border-opacity-10" id="cell-curr-pending-${index}">
                        ${renderRowAmount2(currPendingRmb, currPendingUsd, cur, 'text-warning')}
                    </td>
                    
                    <!-- 减免 (UI Toggle) -->
                    <td class="text-center align-middle">
                        <div class="d-flex justify-content-center">
                            <label class="ui-toggle ui-toggle-sm ui-toggle-success">
                                <input type="checkbox" id="cover-std-${index}" 
                                    ${isCover ? 'checked' : ''}
                                    ${isToggleDisabled ? 'disabled' : ''}
                                    onchange="toggleCoverStandard(${index}, this.checked)">
                                <span class="ui-toggle-track"></span>
                            </label>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        updatePreviewTotals(totalDepositRMB, totalDepositUSD, totalPaidRMB, totalPaidUSD, totalDeductRMB, totalDeductUSD, totalPendingRMB, totalPendingUSD, 
                            totalPaymentRMB, totalPaymentUSD, totalCurrentPendingRMB, totalCurrentPendingUSD);
    }
    
    // Removed getPaymentColumnHTML as its logic is now directly in renderPreviewList

    // Update合计 (Updated Signature)
    // Update合计 (Updated Signature)
    function updatePreviewTotals(depRMB, depUSD, paidRMB, paidUSD, deductRMB, deductUSD, penRMB, penUSD, payRMB, payUSD, currPenRMB, currPenUSD) {
        // Store base totals in window state (FULL OBJECT)
        window.step2RateState.totals = {
            depRMB, depUSD, paidRMB, paidUSD, deductRMB, deductUSD, penRMB, penUSD,
            payRMB, payUSD, currPenRMB, currPenUSD
        };
        
        document.getElementById('step2-total-deposit-rmb').textContent = formatNumber(depRMB);
        document.getElementById('step2-total-deposit-usd').textContent = formatNumber(depUSD);
        
        document.getElementById('step2-total-paid-rmb').textContent = formatNumber(paidRMB);
        document.getElementById('step2-total-paid-usd').textContent = formatNumber(paidUSD);
        
        document.getElementById('step2-total-deduction-rmb').textContent = formatNumber(deductRMB);
        document.getElementById('step2-total-deduction-usd').textContent = formatNumber(deductUSD);
        
        document.getElementById('step2-total-pending-rmb').textContent = formatNumber(penRMB);
        document.getElementById('step2-total-pending-usd').textContent = formatNumber(penUSD);
        
        document.getElementById('step2-this-payment-rmb').textContent = formatNumber(payRMB);
        document.getElementById('step2-this-payment-usd').textContent = formatNumber(payUSD);

        document.getElementById('step2-current-pending-rmb').textContent = formatNumber(currPenRMB);
        document.getElementById('step2-current-pending-usd').textContent = formatNumber(currPenUSD);
        
        // Trigger calculation of This Payment and Current Pending
        updateTotalSummary();
    }
    
    // Payment Logic Functions
    // These functions are largely replaced by direct input handling in the table cells.
    // Keeping them for now, but they might become obsolete or need refactoring.

    
    function updateCustomPayment(index, field, value) {
        const item = window.paymentItems[index];
        if (item) {
            if (field === 'currency') item.custom_currency = value;
            if (field === 'cover_standard') item._coverStandard = value; // Updated to _coverStandard
            // Re-render to update UI (switch state or currency style)
            renderPreviewList(); 
        }
    }

    // Dedicated input handler to avoid losing focus
    function onCustomAmountInput(index, value) {
        const item = window.paymentItems[index];
        if (!item) return;
        
        item.custom_amount = value;
        
        // 1. ALWAYS Update conversion text locally (Show the other currency)
        const rate = item.cur_usd_rmb || 7.0;
        const cur = item.custom_currency || item.cur_currency || 'RMB'; // Current input currency
        const baseCur = item.cur_currency || 'RMB';
        const amt = parseFloat(value) || 0;
        
        // Check Max Cap (Total Remaining Debts)
        // Max Cap = Total Amount - Paid - Deduction
        // We need this in Input Currency
        const totalBase = item.total_amount || 0;
        const paidBase = item.actual_paid || 0; // usually in item currency
        const deductBase = item.allocated_deduction || 0; // in item currency
        
        const remainingTotalBase = Math.max(0, totalBase - paidBase - deductBase);
        
        let maxCap = 0;
        if (cur === baseCur) {
            maxCap = remainingTotalBase;
        } else {
             if (baseCur === 'RMB') maxCap = remainingTotalBase / rate; 
             else maxCap = remainingTotalBase * rate; 
        }
        
        // Validation: Cannot exceed total order amount
        if (amt > (maxCap + 0.01)) {
             // Cap the value visually and logically
             const cappedVal = maxCap.toFixed(2);
             item.custom_amount = cappedVal;
             // Update input view if possible (needs ID ref)
             const inputEl = document.getElementById(`pay-input-${index}`);
             if (inputEl) {
                 inputEl.value = cappedVal;
                 // Flash warning?
                 if (typeof createAndShowToast === 'function') {
                     createAndShowToast(`支付金额不能超过订单待付总额 (${cur} ${formatNumber(maxCap)})`, 'warning');
                 }
                 // Reset amt for logic below
                 // amt = maxCap; // const cannot be reassigned, but we process flow with cappedVal logic implicitly by re-calling function?
                 // No, easier to just return or recursive call.
                 // Let's recursive call:
                 onCustomAmountInput(index, cappedVal);
                 return;
             }
        }
        
        // Show conversion: If RMB input -> Show USD; If USD input -> Show RMB
        let cVal = 0;
        let cCur = '';
        if (cur === 'RMB') {
             cVal = amt / rate; 
             cCur = 'USD';
        } else {
             cVal = amt * rate; 
             cCur = 'RMB';
        }
        
        const badgeColor = cCur === 'RMB' ? 'bg-info' : 'bg-success';
        const convHtml = `<span class="badge ${badgeColor} me-1" style="font-size: 0.65rem; padding: 2px 4px;">${cCur}</span>
                          <span class="text-white-50 fw-bold" style="font-size: 0.9rem; letter-spacing: -0.3px;">${formatNumber(cVal)}</span>`;
        
        const convEl = document.getElementById(`cust-conv-${index}`);
        if (convEl) convEl.innerHTML = convHtml;
        
        // 1.5 Update Cover Standard & Warning Logic
        const basePending = (baseCur === 'RMB' ? (item.recalc_pending_rmb||0) : (item.recalc_pending_usd||0));
        
        let customValPrimary = 0;
        if (cur === baseCur) {
             customValPrimary = amt;
        } else {
             if (baseCur === 'RMB') customValPrimary = amt * rate; 
             else customValPrimary = amt / rate; 
        }
        
        // Check Conditions
        let isOverPending = false;
        let isEqualPending = false;
        
        if (customValPrimary > (basePending + 0.01)) {
             isOverPending = true;
        } else if (Math.abs(customValPrimary - basePending) < 0.01) {
             isEqualPending = true;
        }

        const warnEl = document.getElementById(`cust-warn-${index}`);
        if (warnEl) {
            if (isOverPending) {
                warnEl.innerHTML = `<span class="text-danger fw-bold" data-i18n="ui.text_1344">⚠️ 超出待付金额</span>`;
            } else {
                warnEl.innerHTML = `<span class="text-white-50 opacity-50" data-i18n="ui.text_1345">折算金额参考</span>`;
            }
        }
        
        // Auto-Logic for Cover Standard
        const toggleEl = document.getElementById(`cover-std-${index}`);
        if (isOverPending) {
             // FORCE ON and DISABLE
             item._coverStandard = true;
             if (toggleEl) {
                 toggleEl.checked = true;
                 toggleEl.disabled = true;
             }
        } else if (isEqualPending) {
             // FORCE OFF and DISABLE
             item._coverStandard = false;
             if (toggleEl) {
                 toggleEl.checked = false;
                 toggleEl.disabled = true;
             }
        } else {
             // Less than pending (Partial) -> Enable Manual Interaction
             if (toggleEl) {
                 toggleEl.disabled = false;
                 // Maintain current state (sticky)
             }
        }

        // Update Current Pending Cell (Real-time)
        const cellEl = document.getElementById(`cell-curr-pending-${index}`);
        if (cellEl) {
             let payRmb = 0, payUsd = 0;
             const cAmt = parseFloat(item.custom_amount) || 0;
             const cCur = item.custom_currency || item.cur_currency || 'RMB'; // item.custom_currency is usually set
             
             if (cCur === 'RMB') {
                 payRmb = cAmt;
                 payUsd = cAmt / rate;
             } else {
                 payUsd = cAmt;
                 payRmb = cAmt * rate;
             }
             
             const newCurrPendingRmb = (item.recalc_pending_rmb || 0) - payRmb;
             const newCurrPendingUsd = (item.recalc_pending_usd || 0) - payUsd;
             
             cellEl.innerHTML = renderRowAmount2(newCurrPendingRmb, newCurrPendingUsd, baseCur, 'text-warning');
        }

        // Re-calc totals
        recalcAndShowTotals();
    }

    // --- New Payment Logic Handlers (Moved to Global Scope) ---

    function setPaymentMode(index, mode) {
        const item = window.paymentItems[index];
        if (!item) return;
        
        item.payment_mode = mode;
        
        if (mode === 'original') {
            // Logic handled in render loop
        } else if (mode === 'custom') {
            if (!item.custom_currency) item.custom_currency = item.cur_currency || 'RMB';
            if (item.custom_amount === null || item.custom_amount === undefined) {
                 const cur = item.custom_currency;
                 const rate = item.cur_usd_rmb || 7.0;
                 // Ensure we use the latest recalculated pending amount (Post-Deduction)
                 const pRmb = item.recalc_pending_rmb || 0;
                 const pUsd = item.recalc_pending_usd || 0;
                 item.custom_amount = (cur === 'RMB' ? pRmb : pUsd).toFixed(2);
            }
        }
        
        renderPreviewList();
    }

    function setCustomCurrency(index, currency) {
        const item = window.paymentItems[index];
        if (!item) return;
        item.custom_currency = currency;
        renderPreviewList();
    }


    
    // Helper to recalc totals without HTML thrashing
    function recalcAndShowTotals() {
        let totalPaymentUSD = 0, totalPaymentRMB = 0;
        let totalCurrentPendingUSD = 0, totalCurrentPendingRMB = 0;
        
        // We need to re-sum everything based on current paymentItems state
        window.paymentItems.forEach(item => {
            const cur = item.cur_currency || 'RMB';
            const rate = item.cur_usd_rmb || 7.0;
            
            // Base Pending
            const depAmount = item.deposit_amount || 0;
            const paid = item.actual_paid || 0;
            let pendingRmb = 0, pendingUsd = 0;
            
            // 2. Deduction
            const deductAmt = item.allocated_deduction || 0;

            if (cur === 'RMB') {
                pendingRmb = Math.max(0, (depAmount - paid) - deductAmt);
                pendingUsd = pendingRmb / rate;
            } else {
                pendingUsd = Math.max(0, (depAmount - paid) - deductAmt);
                pendingRmb = pendingUsd * rate;
            }
            
            // Payment Amount (Cash + Prepay)
            let cashPaymentRmb = 0;
            let cashPaymentUsd = 0;
            if (item.payment_mode === 'original') {
                cashPaymentRmb = pendingRmb;
                cashPaymentUsd = pendingUsd;
            } else if (item.payment_mode === 'custom') {
                const custAmt = parseFloat(item.custom_amount) || 0;
                const custCur = item.custom_currency || cur;
                if (custCur === 'RMB') {
                    cashPaymentRmb = custAmt;
                    cashPaymentUsd = custAmt / rate;
                } else {
                    cashPaymentUsd = custAmt;
                    cashPaymentRmb = custAmt * rate;
                }
            }


            const payAmountRmb = cashPaymentRmb;
            const payAmountUsd = cashPaymentUsd;

            let currPendingRmb = pendingRmb - payAmountRmb;
            let currPendingUsd = pendingUsd - payAmountUsd;
            // Removed 0 floor to ensure totals reflect overpayment
            // if (currPendingRmb < 0) currPendingRmb = 0;
            // if (currPendingUsd < 0) currPendingUsd = 0;
             
            totalPaymentRMB += payAmountRmb;
            totalPaymentUSD += payAmountUsd;
            totalCurrentPendingRMB += currPendingRmb;
            totalCurrentPendingUSD += currPendingUsd;
        });
        
        // Call updatePreviewTotals with recalculated values
        // Note: The first 6 args (Deposit/Paid/Pending totals) typically don't change on input, 
        // strictly speaking they only change on Rate change. 
        // But for simplicity we can read them from current state or re-sum them.
        // Let's rely on stored "totals" for the static parts to be safe? 
        // Actually, updatePreviewTotals updates the DOM for those too.
        
        if (window.step2RateState.totals) {
             const t = window.step2RateState.totals;
             // We pass current calculated Pay/CurrPen, but rely on stored values for the static bases (dep/paid/deduct/pen) 
             // which were saved by the initial renderPreviewList or updatePreviewTotals call.
             updatePreviewTotals(t.depRMB, t.depUSD, t.paidRMB, t.paidUSD, t.deductRMB, t.deductUSD, t.penRMB, t.penUSD, 
                                 totalPaymentRMB, totalPaymentUSD, totalCurrentPendingRMB, totalCurrentPendingUSD);
        }
    }
    
    function resetAllToOriginal() {
        window.paymentItems.forEach(item => {
            item.payment_mode = 'original';
            item.custom_amount = null;
            item.custom_currency = null;

            item._coverStandard = false;
        });
        renderPreviewList();
        if (typeof createAndShowToast === 'function') {
            createAndShowToast((window.i18n?.t('js.reset_to_original') || 'Reset all to original payment'), 'success');
        }
    }
    
    // 付款日期变更
    function onPaymentDateChange() {
        window.step2RateState.paymentDate = document.getElementById('payment-date').value;
        
        if (window.step2RateState.usePaymentDateRate && settlementRateComponent) {
            settlementRateComponent.reset();
            settlementRateComponent.fetchRate(window.step2RateState.paymentDate);
            document.getElementById('btn-save-rate').disabled = true;
        }
    }
    
    // 开关切换
    function onTogglePaymentDateRate() {
        const isOn = document.getElementById('use-payment-date-rate').checked;
        window.step2RateState.usePaymentDateRate = isOn;
        
        const editableMode = document.getElementById('rate-editable-mode');
        const readonlyMode = document.getElementById('rate-readonly-mode');
        const toggleLabel = document.getElementById('toggle-label');
        
        if (isOn) {
            editableMode.style.display = 'block';
            readonlyMode.style.display = 'none';
            toggleLabel.textContent = (window.i18n?.t('js.use_payment_date_rate') || 'Use Payment Date Rate');
            toggleLabel.className = 'text-warning small';
            document.getElementById('btn-save-rate').disabled = true;
            
            setTimeout(() => {
                initSettlementRateComponent();
                const currentDate = window.step2RateState.paymentDate;
                if (currentDate && settlementRateComponent) {
                    settlementRateComponent.fetchRate(currentDate);
                }
            }, 50);
        } else {
            editableMode.style.display = 'none';
            readonlyMode.style.display = 'block';
            toggleLabel.textContent = (window.i18n?.t('js.use_original_rate') || 'Use Original Rate');
            toggleLabel.className = 'text-white-50 small';
            
            // 恢复原始汇率
            window.paymentItems.forEach(item => {
                item.cur_usd_rmb = window.step2RateState.originalRates[item.po_num] || 7.0;
                item._rateSource = 'original';
            });
            renderPreviewList();
            document.getElementById('btn-save-rate').disabled = true;
        }
    }
    
    // 应用汇率到所有物流单
    function applyRateToList() {
        if (!window.step2RateState.usePaymentDateRate) return;
        
        const rate = window.step2RateState.settlementRate;
        if (!rate || rate <= 0) {
            if (typeof createAndShowToast === 'function') {
                createAndShowToast((window.i18n?.t('js.enter_valid_rate') || 'Enter valid rate first'), 'warning');
            }
            return;
        }
        
        // 保存原始金额，方便重算
        window.paymentItems.forEach(item => {
            if (typeof item.deposit_pending_rmb_original === 'undefined') item.deposit_pending_rmb_original = item.deposit_pending_rmb;
            if (typeof item.deposit_pending_usd_original === 'undefined') item.deposit_pending_usd_original = item.deposit_pending_usd;
            
            item.cur_usd_rmb = rate;
            item._rateSource = window.step2RateState.rateSource; // 'auto' or 'manual'
        });
        
        renderPreviewList();
        
        // Also update summary immediately
        updateTotalSummary(); // For extra fee if exists
        
        if (typeof createAndShowToast === 'function') {
            createAndShowToast((window.i18n?.t('js.all_rates_updated') || 'All rates updated'), 'success');
        }
    }
    
    // ========================================
    // 额外费用管理
    // ========================================
    
    let extraFeeState = {
        hasExtraFee: false,
        note: '',
        currency: '',
        amount: 0
    };
    
    function showExtraFeeSection() {
        document.getElementById('extra-fee-section').style.display = 'block';
        document.getElementById('add-extra-fee-btn-container').style.display = 'none';
        document.getElementById('total-summary-section').style.display = 'block';
        extraFeeState.hasExtraFee = true;
        updateTotalSummary();
    }
    
    function hideExtraFeeSection() {
        document.getElementById('extra-fee-section').style.display = 'none';
        document.getElementById('add-extra-fee-btn-container').style.display = 'block';
        document.getElementById('total-summary-section').style.display = 'none';
        
        document.getElementById('extra-fee-note').value = '';
        document.getElementById('extra-fee-currency').value = '';
        document.getElementById('extra-fee-amount').value = '';
        document.getElementById('extra-fee-error').style.display = 'none';
        
        extraFeeState = { hasExtraFee: false, note: '', currency: '', amount: 0 };
        window.extraFeeData = null;
    }
    
    function validateExtraFee() {
        const note = document.getElementById('extra-fee-note').value.trim();
        const currency = document.getElementById('extra-fee-currency').value;
        const amount = parseFloat(document.getElementById('extra-fee-amount').value);
        const errorEl = document.getElementById('extra-fee-error');
        
        let errors = [];
        if (!note) errors.push((window.i18n?.t('js.fee_content_required') || 'Fee content required'));
        if (!currency) errors.push((window.i18n?.t('js.select_supplier_currency') || 'Select currency'));
        if (!amount || amount <= 0) errors.push((window.i18n?.t('js.amount_must_positive') || 'Amount must be > 0'));
        if (amount && (amount * 100) % 1 !== 0) errors.push((window.i18n?.t('js.amount_max_2_decimals') || 'Amount max 2 decimals'));
        
        if (errors.length > 0) {
            errorEl.textContent = errors.join('；');
            errorEl.style.display = 'block';
            return false;
        }
        
        errorEl.style.display = 'none';
        extraFeeState.note = note;
        extraFeeState.currency = currency;
        extraFeeState.amount = amount;
        
        window.extraFeeData = {
            note: note,
            currency: currency,
            amount: amount
        };
        
        return true;
    }
    
    // 设置额外费用币种
    window.setExtraFeeCurrency = function(cur) {
        document.getElementById('extra-fee-currency').value = cur;
        
        // Update styling
        const btnRMB = document.getElementById('btn-currency-rmb');
        const btnUSD = document.getElementById('btn-currency-usd');
        
        if (btnRMB && btnUSD) {
            if (cur === 'RMB') {
                btnRMB.className = 'btn btn-info btn-sm flex-fill fw-bold text-white';
                btnUSD.className = 'btn btn-outline-secondary btn-sm flex-fill text-white-50';
            } else {
                btnUSD.className = 'btn btn-info btn-sm flex-fill fw-bold text-white';
                btnRMB.className = 'btn btn-outline-secondary btn-sm flex-fill text-white-50';
            }
        }
        
        if (typeof validateExtraFee === 'function') validateExtraFee();
        updateTotalSummary();
    };

    function updateTotalSummary() {
        if (!window.step2RateState || !window.step2RateState.totals) return;
        
        // 3. Totals Calculation Base (Gross Obligation)
        // Mapped from Totals
        // payRMB/payUSD is the CASH Payment allocated in the Table
        // penRMB/penUSD is Net Pending (After Deduction)
        // currPenRMB/currPenUSD is Current Pending
        // deductRMB/deductUSD is Deduction
        const { payRMB, payUSD, deductRMB, deductUSD, currPenRMB, currPenUSD, penRMB, penUSD } = window.step2RateState.totals;
        
        // Extra Fee Logic
        const exCurrency = document.getElementById('extra-fee-currency').value;
        const exAmount = parseFloat(document.getElementById('extra-fee-amount').value) || 0;
        const currentRate = window.paymentItems.length > 0 ? (window.paymentItems[0].cur_usd_rmb || 7.0) : 7.0;
        
        let extraRMB = 0;
        let extraUSD = 0;
        
        // Converted display logic for Extra Fee
        const convertedEl = document.getElementById('extra-fee-converted');
        if (convertedEl) convertedEl.textContent = '';
        
        if (exAmount > 0 && exCurrency) {
            if (exCurrency === 'RMB') {
                extraRMB = exAmount;
                extraUSD = exAmount / currentRate;
                if (convertedEl) convertedEl.textContent = `≈ $${formatNumber(extraUSD)} USD`;
            } else if (exCurrency === 'USD') {
                extraUSD = exAmount;
                extraRMB = exAmount * currentRate;
                if (convertedEl) convertedEl.textContent = `≈ ¥${formatNumber(extraRMB)} RMB`;
            }
        }

        // Grand Total Payment = Table Cash + Extra
        const totalCashRMB = (payRMB || 0) + extraRMB;
        const totalCashUSD = (payUSD || 0) + extraUSD; // Approx
        
        // Update Toggle Label State
        const usePrepay = document.getElementById('use-prepay-deduction')?.checked || false;
        const toggleLabel = document.getElementById('prepay-toggle-label');
        if (toggleLabel) {
             if (usePrepay) {
                  toggleLabel.textContent = (window.i18n?.t('js.enabled') || 'Enabled');
                  toggleLabel.classList.add('text-success');
                  toggleLabel.classList.remove('text-white-50');
             } else {
                  toggleLabel.textContent = (window.i18n?.t('js.not_used') || 'Not Used');
                  toggleLabel.classList.remove('text-success');
                  toggleLabel.classList.add('text-white-50');
             }
        }
        
        // 4. Update UI
        
        // Total Pending Box (Net Pending) - AFTER Deduction
        if(document.getElementById('step2-total-pending-rmb')) document.getElementById('step2-total-pending-rmb').textContent = formatNumber(penRMB || 0);
        if(document.getElementById('step2-total-pending-usd')) document.getElementById('step2-total-pending-usd').textContent = formatNumber(penUSD || 0);

        // Deduction Box (Direct mapping from totals)
        if(document.getElementById('step2-total-deduction-rmb')) document.getElementById('step2-total-deduction-rmb').textContent = formatNumber(deductRMB || 0);
        if(document.getElementById('step2-total-deduction-usd')) document.getElementById('step2-total-deduction-usd').textContent = formatNumber(deductUSD || 0);

        // This Payment Box (Cash + Extra)
        if(document.getElementById('step2-this-payment-rmb')) document.getElementById('step2-this-payment-rmb').textContent = formatNumber(totalCashRMB); 
        if(document.getElementById('step2-this-payment-usd')) document.getElementById('step2-this-payment-usd').textContent = formatNumber(totalCashUSD);
        
        // Current Pending Box (Final Remaining from Table totals)
        if(document.getElementById('step2-current-pending-rmb')) document.getElementById('step2-current-pending-rmb').textContent = formatNumber(currPenRMB || 0);
        if(document.getElementById('step2-current-pending-usd')) document.getElementById('step2-current-pending-usd').textContent = formatNumber(currPenUSD || 0);
        
        // Bottom Summary (Grand Total Cash Outflow) - Match 'This Payment'
        const grandTotalRMBEl = document.getElementById('grand-total-rmb');
        if (grandTotalRMBEl) grandTotalRMBEl.textContent = formatNumber(totalCashRMB); 
        
        const grandTotalUSDEl = document.getElementById('grand-total-usd');
        if (grandTotalUSDEl) grandTotalUSDEl.textContent = formatNumber(totalCashUSD);
        
        // Visibility of Bottom Summary
        const bottomSection = document.getElementById('total-summary-section');
        const extraSection = document.getElementById('extra-fee-section');
         if (extraSection && extraSection.style.display !== 'none') {
              if (bottomSection) bottomSection.style.display = 'block';
         } else {
              if (bottomSection) bottomSection.style.display = 'none';
         }
    }



    // ========================================
    // Vendor Prepayment Module
    // ========================================
    async function initVendorPrepayModule() {
        if (!window.paymentItems || window.paymentItems.length === 0) return;
        
        // Get supplier code from the first PO (assuming batch is per vendor)
        const firstPO = window.paymentItems[0].po_num;
        const supplierCode = firstPO.substring(0, 2);
        
        // Get Payment Date from UI
        const dateInput = document.getElementById('payment-date');
        const paymentDate = dateInput ? dateInput.value : '';
        
        try {
            let url = `/dashboard/finance/deposit/api/vendor_balance/?supplier_code=${supplierCode}`;
            if (paymentDate) {
                url += `&payment_date=${encodeURIComponent(paymentDate)}`;
            }
            
            console.log(`[Prepay] Fetching balance for ${supplierCode} on ${paymentDate}`);
            
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                const balance_base = data.balance_base; 
                const balance_usd = data.balance_usd;   
                const currency = data.currency;        
                const suppName = data.supplier_name;
                const suppCode = data.supplier_code;

                // 1. Populate Supplier Info
                const elCode = document.getElementById('prepay-supplier-code');
                const elName = document.getElementById('prepay-supplier-name');
                if (elCode) elCode.textContent = suppCode;
                if (elName) elName.textContent = suppName;
                
                // 2. Update Balance Display with Visual Hierarchy & Reordering
                const container = document.getElementById('balance-rows-container');
                const rmbRow = document.getElementById('balance-row-rmb');
                const usdRow = document.getElementById('balance-row-usd');
                const rmbVal = document.getElementById('prepay-balance-rmb');
                const usdVal = document.getElementById('prepay-balance-usd');
                const symbol = document.getElementById('prepay-currency-symbol');
                
                const fmt = (n) => n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Define classes for consistent tagging (Solid Style)
                const badgeRMB = ['bg-info', 'text-white', 'border', 'border-info', 'border-opacity-25'];
                const badgeUSD = ['bg-success', 'text-white', 'border', 'border-success', 'border-opacity-25'];
                const badgeBase = ['input-group-text', 'fw-normal', 'small']; // Base layout
                
                if (rmbVal && usdVal && rmbRow && usdRow) {
                    if (currency === 'RMB') {
                        // RMB is Primary
                        if (container) container.prepend(rmbRow);

                        // Content (No Symbols, Badge is the tag)
                        rmbVal.textContent = `${fmt(balance_base)}`;
                        usdVal.textContent = `≈ ${fmt(balance_usd)}`; 
                        
                        // Styles
                        rmbRow.classList.remove('opacity-50');
                        rmbRow.classList.add('opacity-100');
                        rmbVal.classList.add('fs-5'); 
                        rmbVal.classList.remove('fs-6');
                        
                        usdRow.classList.add('opacity-50'); 
                        usdRow.classList.remove('opacity-100');
                        usdVal.classList.add('fs-6'); 
                        usdVal.classList.remove('fs-5');
                        
                        // Input Tag Sync
                        if (symbol) {
                             symbol.textContent = 'RMB';
                             symbol.className = ''; // Reset
                             symbol.classList.add(...badgeBase, ...badgeRMB);
                        }

                    } else {
                        // USD is Primary
                        if (container) container.prepend(usdRow);
                        
                        // Content
                         usdVal.textContent = `${fmt(balance_base)}`; 
                         rmbVal.textContent = '-'; 
                         
                         // Styles
                         usdRow.classList.remove('opacity-50');
                         usdRow.classList.add('opacity-100');
                         usdVal.classList.add('fs-5');
                         usdVal.classList.remove('fs-6');
                         
                         rmbRow.classList.add('opacity-50');
                         rmbRow.classList.remove('opacity-100');
                         rmbVal.classList.add('fs-6');
                         rmbVal.classList.remove('fs-5');
                         
                         // Input Tag Sync
                         if (symbol) {
                             symbol.textContent = 'USD';
                             symbol.className = '';
                             symbol.classList.add(...badgeBase, ...badgeUSD);
                         }
                    }
                }
                
                // 3. Toggle Logic
                const hasBalance = balance_base > 0;
                const toggle = document.getElementById('use-prepay-deduction');
                const label = document.getElementById('prepay-toggle-label');
                
                if (toggle) {
                    toggle.disabled = !hasBalance;
                    if (!hasBalance) {
                        label.textContent = (window.i18n?.t('js.no_available_balance') || 'No Available Balance');
                        label.classList.add('text-danger');
                        if (toggle.checked) {
                             toggle.checked = false; 
                        }
                    } else {
                         label.textContent = (window.i18n?.t('js.not_used') || 'Not Used');
                         label.classList.remove('text-danger');
                    }
                }
                
                window.prepayState = {
                    hasBalance: hasBalance,
                    balanceBase: balance_base,
                    currency: currency,
                    supplierCode: supplierCode
                };
            }
        } catch (e) {
            console.error("[Prepay] Failed to fetch vendor balance", e);
        }
    }

    // ========================================
    // Lifecycle Integration
    // ========================================
    (function() {
        // Capture original hooks
        const _superInitStep2 = window.initStep2;
        
        // Define new Consolidated Hook
        window.initStep2 = function() {
            // 1. Call original logic (if any)
            if (typeof _superInitStep2 === 'function') _superInitStep2();
            
            // 2. Step 2 Specific UI Reset
            if (typeof hideExtraFeeSection === 'function') hideExtraFeeSection();
            
            // 3. Initialize Prepay Module
            console.log("[Deposit] Step 2 Active. Fetching Vendor Balance...");
            if (typeof initVendorPrepayModule === 'function') {
                initVendorPrepayModule();
            }
        };
        
        // Hook into Date Change for Live Updates
        // Wait briefly for DOM/Scripts to settle
        setTimeout(() => {
             const _superDate = window.onPaymentDateChange;
             window.onPaymentDateChange = function() {
                 // Call original date logic (Rate update)
                 if (typeof _superDate === 'function') _superDate();
                 
                 // Trigger Balance Refresh
                 console.log("[Deposit] Payment Date Changed. Refreshing Balance...");
                 initVendorPrepayModule();
             };
        }, 500);
        
        // Auto-Run Fallback (for direct loads)
        setTimeout(() => {
            if (window.paymentItems && window.paymentItems.length > 0) {
                 initVendorPrepayModule();
            }
        }, 300);
    })();
</script>