<!-- Step 1: 付款说明 (PO) -->
<style>
    /* Wizard Step 1 Specific Styles */
    .step1-table-container {
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .step1-table thead th {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        padding: 14px 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .step1-table tbody td {
        padding: 14px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 13px;
        vertical-align: middle;
    }

    /* Accounting Box Style */
    .acct-box {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        min-width: 90px;
    }
    .acct-row {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        justify-content: flex-end;
    }
    .acct-badge-usd {
        background-color: #198754; /* bg-success */
        font-size: 9px;
        width: 32px;
        text-align: center;
        border-radius: 4px;
        padding: 1px 0;
    }
    .acct-badge-rmb {
        background-color: #0dcaf0; /* bg-info */
        font-size: 9px;
        width: 32px;
        text-align: center;
        border-radius: 4px;
        padding: 1px 0;
    }
    .acct-amt {
        letter-spacing: -0.3px;
    }
    .acct-amt.primary { color: rgba(255, 255, 255, 0.9); }
    .acct-amt.secondary { color: rgba(255, 255, 255, 0.9); }
    .acct-amt.paid { color: #198754; } /* text-success */
    .acct-amt.pending { color: #ffc107; font-weight: bold; } /* text-warning */
</style>

<!-- 付款须知 -->
<div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4">
    <div class="card-header bg-info bg-opacity-10 border-0 d-flex align-items-center">
        <i class="fas fa-info-circle text-info me-2"></i>
        <span class="text-info fw-bold" data-i18n="ui.text_1400">付款须知</span>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="text-white-50 mb-3 small">
                    <p class="mb-1">1. <strong data-i18n="ui.text_1401">核对清单</strong>：<span data-i18n="instructions.desc_48">请确认订单号、已付金额及尾款剩余金额是否正确。</span></p>
                    <p class="mb-1">2. <strong data-i18n="finance.batch_payment">批量付款</strong>：<span data-i18n="instructions.desc_71">本次选中的所有订单将共享同一个付款单号 (PPMT_)。</span></p>
                    <p class="mb-0">3. <strong data-i18n="ui.text_1403">继续流程</strong>：<span data-i18n="instructions.desc_56">确认无误后，点击「下一步」设定汇率与抵扣选项。</span></p>
                </div>
                <div class="d-flex gap-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-white" data-i18n="table.balance_remaining">尾款剩余</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-white" data-i18n="js.settlement_currency">结算货币</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-white" data-i18n="ui.text_1578">订单汇率</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-warning bg-opacity-10 border border-warning border-opacity-25">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-triangle text-warning mt-1 me-2"></i>
                        <div>
                            <strong class="text-warning d-block mb-1" data-i18n="shipping.important_notice">重要提示</strong>
                            <p class="text-white-50 small mb-0">
                                本流程<span class="text-warning" data-i18n="ui.text_1580">仅处理货款</span>（非定金）。如需调整订单数据，请退出向导前往「订货单管理」修正。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 待付款清单 -->
<div class="card bg-dark border-secondary border-opacity-25 mb-4" id="summary-card">
    <div class="card-header bg-secondary bg-opacity-10 border-0 d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center">
            <i class="fas fa-list-check me-2 text-white-50"></i>
            <span class="text-white fw-bold" data-i18n="ui.text_1409">待付款订货单</span>
            <span class="badge bg-primary ms-3 rounded-pill" id="deposit-count-badge" data-i18n="ui.text_1410">0 单</span>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- 表格容器 -->
        <div class="step1-table-container">
            <table class="table mb-0 step1-table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 14%;" data-i18n="table.order_no">订货单号</th>
                        <th class="text-center" style="width: 9%;" data-i18n="table.order_date">订单日期</th>
                        <th class="text-center" style="width: 14%;" data-i18n="table.total_amount">订单总金额</th>
                        <th class="text-center" style="width: 11%;" data-i18n="ui.text_2475">订单日汇率</th>
                        <th class="text-center" style="width: 11%;" data-i18n="ui.text_2476">今日汇率</th>
                        <th class="text-center" style="width: 12%;" data-i18n="table.deposit_paid">已付定金</th>
                        <th class="text-center" style="width: 12%;" data-i18n="finance.paid_amount">已付货款</th>
                        <th class="text-center" style="width: 14%;" data-i18n="table.balance_remaining">尾款剩余</th>
                        <th class="text-center" style="width: 3%;"></th>
                    </tr>
                </thead>
                <tbody id="payment-list-body">
                    <!-- JS动态填充 -->
                </tbody>
            </table>
        </div>
        
        <!-- 合计栏 -->
        <div class="bg-black bg-opacity-25 p-4 border-top border-secondary border-opacity-25">
            <div class="row">
                <!-- 订单总金额 -->
                <div class="col-md-4 border-end border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-2 text-center" data-i18n="table.total_amount">订单总金额</div>
                    <div class="d-flex justify-content-center">
                        <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-white fw-bold fs-5" id="step1-total-amount-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-white-50 fw-bold" id="step1-total-amount-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 已付金额 (定金+尾款) -->
                <div class="col-md-4 border-end border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-2 text-center">已付金额 <span class="text-white-50 opacity-50" data-i18n="ui.text_1583">(定金+已付货款)</span></div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-success fw-bold fs-5" id="step1-paid-amount-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-success text-opacity-75 fw-bold" id="step1-paid-amount-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 尾款剩余 (本次待付) -->
                <div class="col-md-4">
                     <div class="text-warning small mb-2 text-center fw-bold">尾款剩余 <span class="text-warning opacity-75" data-i18n="ui.text_1584">(本次待付)</span></div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-warning fw-bold fs-4" id="step1-balance-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-warning text-opacity-75 fw-bold" id="step1-balance-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 空状态 -->
<div id="empty-state" class="text-center py-5" style="display: none;">
    <i class="fas fa-exclamation-circle fa-3x text-warning opacity-50 mb-3"></i>
    <p class="text-white-50 mb-3" data-i18n="ui.text_1411">未选择任何订货单</p>
    <button type="button" class="btn btn-outline-primary" onclick="closePOWizard()">
        <i class="fas fa-arrow-left me-1"></i><span data-i18n="ui.icon_3415">返回选择</span>
    </button>
</div>

<!-- 操作按钮 -->
<div class="wizard-actions mt-4">
    <div class="wizard-actions-left">
        <button type="button" class="btn btn-outline-secondary rounded-pill" onclick="closePOWizard()">
            <i class="fas fa-times me-2"></i><span data-i18n="finance.cancel_payment">取消付款</span>
        </button>
    </div>
    <div class="wizard-actions-right">
        <button type="button" class="btn btn-success rounded-pill px-5 shadow-lg" id="btn-step1-next">
            下一步 <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>
</div>

<script>
    // Step 1 初始化
    function initStep1() {
        // 绑定按钮事件
        const nextBtn = document.getElementById('btn-step1-next');
        if (nextBtn) {
            // 解绑旧事件以防重复
            const newBtn = nextBtn.cloneNode(true);
            nextBtn.parentNode.replaceChild(newBtn, nextBtn);
            
            newBtn.addEventListener('click', function() {
                if (window.paymentWizard) {
                    window.paymentWizard.next();
                }
            });
        }
        
        const tbody = document.getElementById('payment-list-body');
        
        if (!window.paymentItems || window.paymentItems.length === 0) {
            document.getElementById('summary-card').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            if (newBtn) newBtn.disabled = true;
            return;
        }

        
        document.getElementById('deposit-count-badge').textContent = `${window.paymentItems.length} 单`;
        
        // 统计汇总
        let totalAmountUSD = 0, totalAmountRMB = 0;
        let totalPaidUSD = 0, totalPaidRMB = 0;
        let totalBalanceUSD = 0, totalBalanceRMB = 0;
        
        // 渲染双币金额
        const renderDualAmount = (val, valUsd, cur, cls) => {
             const v = parseFloat(val) || 0;
             const vUsd = parseFloat(valUsd) || 0;
             
             let html = `<div class="acct-box">`;
             const badgeColor = cur === 'USD' ? 'bg-success' : 'bg-info';
             
             html += `<div class="acct-row">
                        <span class="badge ${badgeColor}" style="font-size:9px; width:32px;">${cur}</span>
                        <span class="acct-amt ${cls || ''}">${formatNumber(v)}</span>
                      </div>`;
                      
             if (cur !== 'USD') {
                 html += `<div class="acct-row">
                            <span class="badge bg-success" style="font-size:9px; width:32px;">USD</span>
                            <span class="acct-amt secondary">${formatNumber(vUsd)}</span>
                          </div>`;
             }
             
             html += `</div>`;
             return html;
        };

        tbody.innerHTML = window.paymentItems.map(item => {
            const cur = item.cur_currency || 'USD';
            const rate = item.cur_usd_rmb || 7.0;
            const todayRate = item.today_rate || rate;
            
            // 金额
            const total = item.total_amount || 0;
            const totalUsd = item.total_amount_usd || total;
            
            const depositPaid = item.deposit_paid || 0;
            const depositPaidUsd = item.deposit_paid_usd || depositPaid;
            
            const poPaid = item.po_paid || 0;
            const poPaidUsd = item.po_paid_usd || poPaid;
            
            const balance = item.balance_remaining || 0;
            const balanceUsd = item.balance_remaining_usd || balance;

            // 累加总计 (转换为USD统计)
            totalAmountUSD += totalUsd;
            totalPaidUSD += depositPaidUsd + poPaidUsd;
            totalBalanceUSD += balanceUsd;
            
            // RMB转换
            totalAmountRMB += (cur === 'USD') ? total * rate : total;
            totalPaidRMB += (cur === 'USD') ? (depositPaid + poPaid) * rate : (depositPaid + poPaid);
            totalBalanceRMB += (cur === 'USD') ? balance * rate : balance;
            
            // 订单日汇率标签
            const isAuto = (item.rate_source_code || 'AUTO') === 'AUTO';
            const sourceTag = isAuto ? (window.i18n?.t('js.auto') || 'Auto') : (window.i18n?.t('js.manual') || 'Manual');
            const sourceClass = isAuto ? 'bg-info bg-opacity-10 text-info border-info border-opacity-25' : 'bg-light bg-opacity-10 text-light border-secondary border-opacity-25';
            
            // 浮动约束标签
            let floatTag = '';
            if (cur === 'USD') {
                if (item.is_float_enabled) {
                    const threshold = item.float_threshold || 0;
                    floatTag = `<span class="badge bg-info bg-opacity-25 text-info border border-info border-opacity-25 ms-1" style="font-size: 9px; padding: 2px 5px;" data-i18n="ui.text_1586">浮动${threshold}%</span>`;
                } else {
                    floatTag = `<span class="badge bg-secondary bg-opacity-25 text-white-50 border border-secondary border-opacity-25 ms-1" style="font-size: 9px; padding: 2px 5px;" data-i18n="ui.text_1217">固定</span>`;
                }
            }
            
            // 今日汇率变化
            const rateDiff = ((todayRate - rate) / rate * 100);
            const rateDiffText = rateDiff >= 0 ? `+${rateDiff.toFixed(2)}%` : `${rateDiff.toFixed(2)}%`;
            const rateDiffClass = rateDiff > 0 ? 'text-danger' : (rateDiff < 0 ? 'text-success' : 'text-white-50');
            
            // 浮动触发标签
            let fluctuationTag = '';
            if (cur === 'USD' && item.is_float_enabled && item.fluctuation_triggered) {
                const pct = item.rate_fluctuation_pct || 0;
                const absPct = Math.abs(pct).toFixed(2);
                if (pct > 0) {
                    fluctuationTag = `<span class="badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-25 ms-2" style="font-size: 9px; padding: 3px 6px;" data-i18n="ui.text_1588">浮动+${absPct}%</span>`;
                } else {
                    fluctuationTag = `<span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25 ms-2" style="font-size: 9px; padding: 3px 6px;" data-i18n="ui.text_1589">浮动${pct.toFixed(2)}%</span>`;
                }
            }
            
            // 定金状态
            const depositStatus = item.deposit_status || 'not_required';
            let depositDisplay = '';
            if (depositStatus === 'not_required') {
                depositDisplay = `<span class="badge bg-secondary bg-opacity-25 text-white-50 border border-secondary border-opacity-25" style="font-size: 10px; padding: 3px 8px;" data-i18n="ui.text_1211">无需定金</span>`;
            } else if (depositStatus === 'unpaid') {
                depositDisplay = `<span class="badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-25" style="font-size: 10px; padding: 3px 8px;" data-i18n="ui.text_1212">尚未支付</span>`;
            } else {
                depositDisplay = `<div class="d-flex justify-content-center align-items-center gap-1">
                    ${renderDualAmount(depositPaid, depositPaidUsd, cur, 'paid')}
                    <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25 ms-1" style="font-size: 9px; padding: 2px 5px;" data-i18n="ui.text_1213">已支付</span>
                </div>`;
            }

            return `
                <tr>
                    <td class="text-center font-monospace fw-bold text-white">${item.po_num}</td>
                    <td class="text-center">${item.po_date || '-'}</td>
                    
                    <!-- 订单总金额 -->
                    <td class="text-center">
                        <div class="d-flex justify-content-center align-items-center gap-1">
                            ${renderDualAmount(total, totalUsd, cur)}
                            ${fluctuationTag}
                        </div>
                    </td>
                    
                    <!-- 订单日汇率 -->
                    <td class="text-center">
                        <div class="d-flex flex-column align-items-center">
                            <span class="text-white fw-bold">${rate.toFixed(4)}</span>
                            <div class="d-flex align-items-center mt-1">
                                <span class="badge border ${sourceClass}" style="font-size: 9px; padding: 2px 5px;">${sourceTag}</span>
                                ${floatTag}
                            </div>
                        </div>
                    </td>
                    
                    <!-- 今日汇率 -->
                    <td class="text-center">
                        <div class="d-flex flex-column align-items-center">
                            <span class="text-white fw-bold">${todayRate.toFixed(4)}</span>
                            <span class="badge border bg-secondary bg-opacity-10 ${rateDiffClass} border-secondary border-opacity-25 mt-1" style="font-size: 9px; padding: 2px 6px;">
                                ${rateDiffText}
                            </span>
                        </div>
                    </td>
                    
                    <!-- 已付定金 -->
                    <td class="text-center">${depositDisplay}</td>
                    
                    <!-- 已付货款 -->
                    <td class="text-center">${renderDualAmount(poPaid, poPaidUsd, cur, 'paid')}</td>
                    
                    <!-- 尾款剩余 -->
                    <td class="text-center">${renderDualAmount(balance, balanceUsd, cur, 'pending')}</td>
                    
                    <!-- 移除按钮 -->
                    <td class="text-center">
                        <button type="button" class="btn btn-link btn-sm text-danger p-0" onclick="removeFromWizard('${item.po_num}')" data-i18n-title="tooltip.t1108" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // 填充汇总
        document.getElementById('step1-total-amount-usd').textContent = formatNumber(totalAmountUSD);
        document.getElementById('step1-total-amount-rmb').textContent = formatNumber(totalAmountRMB);
        
        document.getElementById('step1-paid-amount-usd').textContent = formatNumber(totalPaidUSD);
        document.getElementById('step1-paid-amount-rmb').textContent = formatNumber(totalPaidRMB);
        
        document.getElementById('step1-balance-usd').textContent = formatNumber(totalBalanceUSD);
        document.getElementById('step1-balance-rmb').textContent = formatNumber(totalBalanceRMB);
        
        document.getElementById('btn-step1-next').disabled = false;
    }
    
    // 从向导中移除订单
    function removeFromWizard(poNum) {
        if (window.paymentItems) {
            window.paymentItems = window.paymentItems.filter(item => item.po_num !== poNum);
            initStep1();
        }
    }
    
    function formatNumber(num) {
        return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
</script>