<!-- PO Payment 订单详情视图 (默认隐藏) -->
<div id="po-payment-orders-view" style="display: none;">
    <div class="glass-card p-4 shadow-lg">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
            <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-file-invoice-dollar fa-2x text-success"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_1367">付款订单详情</h5>
                    <p class="text-white-50 small mb-0" id="po-payment-orders-pmt-label" data-i18n="ui.text_1321">付款单号: -</p>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="closePOPaymentOrdersView()">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
            </button>
        </div>

        <!-- 加载中 -->
        <div id="po-payment-orders-loading" class="text-center py-5">
            <div class="spinner-border text-success" role="status"></div>
            <p class="text-white-50 mt-3 mb-0" data-i18n="purchase.loading_orders">正在加载订单数据...</p>
        </div>

        <!-- 订单内容 -->
        <div id="po-payment-orders-content" style="display: none;">
            <div id="po-payment-orders-container"></div>
        </div>
    </div>
</div>

<script>
/**
 * 查看PO Payment批次关联的订单
 */
function viewPOOrders(pmtNo) {
    // 切换视图
    document.getElementById('po-list-view').style.display = 'none';
    document.getElementById('po-payment-orders-view').style.display = 'block';
    
    // 更新标题
    document.getElementById('po-payment-orders-pmt-label').textContent = `付款单号: ${pmtNo}`;
    
    const loading = document.getElementById('po-payment-orders-loading');
    const content = document.getElementById('po-payment-orders-content');
    const container = document.getElementById('po-payment-orders-container');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    
    // 获取订单详情 (使用 PO Payment API)
    fetch(`/dashboard/finance/po/api/orders/?pmt_no=${encodeURIComponent(pmtNo)}`)
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (!data.success) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-danger opacity-50 mb-3"></i>
                        <p class="text-danger" data-i18n="ui.text_710">${data.message || (window.i18n?.t('js.load_failed') || 'Load Failed')}</p>
                    </div>
                `;
                content.style.display = 'block';
                return;
            }
            
            const orders = data.data?.orders || [];
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-white-50 opacity-50 mb-3"></i>
                        <p class="text-white-50" data-i18n="finance.no_orders">暂无订单数据</p>
                    </div>
                `;
                content.style.display = 'block';
                return;
            }
            
            // 渲染订单卡片 (Accordion)
            let html = '<div class="accordion" id="po-payment-orders-accordion">';
            
            orders.forEach((order, index) => {
                const collapseId = `po-payment-order-collapse-${index}`;
                const isFirst = index === 0;
                
                // 货币徽章 - 与主页面统一风格
                const currencyBadge = order.currency === 'USD' 
                    ? '<span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.7rem;">USD</span>'
                    : '<span class="badge bg-danger bg-opacity-25 text-danger" style="font-size: 0.7rem;">RMB</span>';
                
                // 计算本次付款总额
                const totalPaymentRmb = (order.prepay_used_rmb || 0) + (order.cash_paid_rmb || 0) + (order.extra_fee_rmb || 0);
                
                html += `
                    <div class="accordion-item bg-dark border-secondary mb-2" style="border-radius: 12px; overflow: hidden;">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'} bg-dark text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                    aria-expanded="${isFirst}" aria-controls="${collapseId}">
                                <div class="d-flex align-items-center w-100 me-3">
                                    <i class="fas fa-file-invoice me-3 text-success"></i>
                                    <div class="flex-grow-1">
                                        <span class="fw-bold font-monospace text-info">${order.po_num}</span>
                                        <span class="badge bg-secondary ms-2">${order.supplier_code}</span>
                                        ${currencyBadge}
                                    </div>
                                    <div class="text-end me-3">
                                        <div class="d-flex flex-column align-items-end">
                                            <div>
                                                <span class="badge bg-danger bg-opacity-25 text-danger me-1" style="font-size: 0.6rem;">RMB</span>
                                                <span class="text-warning fw-bold">¥${formatNumber(totalPaymentRmb)}</span>
                                            </div>
                                            ${order.currency === 'USD' ? `
                                            <div style="margin-top: 2px;">
                                                <span class="badge bg-primary bg-opacity-25 text-primary me-1" style="font-size: 0.6rem;">USD</span>
                                                <span class="text-info small">$${formatNumber(order.total_usd || 0)}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" data-bs-parent="#po-payment-orders-accordion">
                            <div class="accordion-body p-0">
                                <!-- 订单基础信息 -->
                                <div class="card bg-dark border-0 mb-0">
                                    <div class="card-header bg-info bg-opacity-10 border-secondary">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        <span class="text-white small" data-i18n="ui.text_632">订单基础信息</span>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2521">采购单号</div>
                                                <div class="text-info font-monospace">${order.po_num}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="common.supplier">供应商</div>
                                                <div class="text-white fw-bold">${order.supplier_code}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2195">订货日期</div>
                                                <div class="text-white">${order.po_date || '-'}</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-white-50 small mb-1" data-i18n="table.settlement_rate">结算汇率</div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="text-white font-monospace">${order.exchange_rate ? order.exchange_rate.toFixed(4) : '-'}</span>
                                                    ${currencyBadge}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 货款付款信息 -->
                                <div class="card bg-dark border-0">
                                    <div class="card-header bg-warning bg-opacity-10 border-secondary">
                                        <i class="fas fa-coins me-2 text-warning"></i>
                                        <span class="text-white small" data-i18n="ui.text_1373">货款付款详情</span>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row g-3">
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="table.payment_date">付款日期</div>
                                                <div class="text-info">${order.payment_date || '-'}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2484">预付抵扣</div>
                                                <div class="${(order.prepay_used_rmb || 0) > 0 ? 'text-success fw-bold' : 'text-white-50'}">¥${formatNumber(order.prepay_used_rmb || 0)}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2576">现金支付</div>
                                                <div class="text-info fw-bold">¥${formatNumber(order.cash_paid_rmb || 0)}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="table.extra_fees">额外费用</div>
                                                <div class="${(order.extra_fee_rmb || 0) > 0 ? 'text-danger fw-bold' : 'text-white-50'}">¥${formatNumber(order.extra_fee_rmb || 0)}</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2578">付款总额</div>
                                                <div class="d-flex flex-column">
                                                    <span class="text-warning fw-bold">¥${formatNumber(totalPaymentRmb)}</span>
                                                    ${order.currency === 'USD' ? `<span class="text-info small">$${formatNumber(order.total_usd || 0)}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="text-white-50 small mb-1" data-i18n="ui.text_2579">订单货值</div>
                                                <div class="d-flex flex-column">
                                                    <span class="text-white">¥${formatNumber(order.total_rmb || 0)}</span>
                                                    ${order.currency === 'USD' ? `<span class="text-info small">$${formatNumber(order.total_usd || 0)}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 订单明细 -->
                                <div class="card bg-dark border-0 mt-2">
                                    <div class="card-header bg-success bg-opacity-10 border-secondary">
                                        <i class="fas fa-list me-2 text-success"></i>
                                        <span class="text-white small" data-i18n="ui.text_634">订单明细</span>
                                        <span class="badge bg-success ms-2">${order.items ? order.items.length : 0}</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-dark table-hover mb-0" style="font-size: 0.85rem;">
                                                <thead>
                                                    <tr class="text-white-50">
                                                        <th style="width: 40px;">#</th>
                                                        <th>SKU</th>
                                                        <th class="text-center" data-i18n="common.quantity">数量</th>
                                                        <th class="text-center" data-i18n="common.currency">货币</th>
                                                        <th class="text-end" data-i18n="common.unit_price">单价</th>
                                                        <th class="text-end" data-i18n="ui.icon_3383">金额</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                `;
                                
                if (order.items && order.items.length > 0) {
                    order.items.forEach((item, idx) => {
                        const itemCurrBadge = item.currency === 'USD' 
                            ? '<span class="badge bg-primary bg-opacity-25 text-primary" style="font-size: 0.7rem;">USD</span>'
                            : '<span class="badge bg-danger bg-opacity-25 text-danger" style="font-size: 0.7rem;">RMB</span>';
                        
                        html += `
                                                    <tr>
                                                        <td class="text-white-50">${idx + 1}</td>
                                                        <td class="font-monospace text-info">${item.sku}</td>
                                                        <td class="text-center">${item.qty}</td>
                                                        <td class="text-center">${itemCurrBadge}</td>
                                                        <td class="text-end">${formatNumber(item.unit_price)}</td>
                                                        <td class="text-end">
                                                            <div class="d-flex flex-column align-items-end">
                                                                <span class="text-warning">¥${formatNumber(item.value_rmb)}</span>
                                                                <span class="text-info small">$${formatNumber(item.value_usd)}</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                        `;
                    });
                } else {
                    html += `<tr><td colspan="6" class="text-center text-white-50 py-3" data-i18n="ui.text_2535">无明细数据</td></tr>`;
                }
                
                html += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            content.style.display = 'block';
        })
        .catch(err => {
            loading.style.display = 'none';
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger opacity-50 mb-3"></i>
                    <p class="text-danger" data-i18n="ui.text_490">网络错误: ${err}</p>
                </div>
            `;
            content.style.display = 'block';
        });
}

/**
 * 关闭PO Payment订单视图
 */
function closePOPaymentOrdersView() {
    document.getElementById('po-payment-orders-view').style.display = 'none';
    document.getElementById('po-list-view').style.display = 'block';
    
    // 刷新列表数据
    if (typeof loadPOTable === 'function') {
        loadPOTable();
    }
}
</script>