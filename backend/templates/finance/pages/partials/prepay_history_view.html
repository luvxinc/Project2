<!-- 预付款历史记录视图（三栏布局） -->
<div id="prepay-history-view" style="display: none;">
    <div class="glass-card p-4 shadow-lg">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
            <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-25 p-3 rounded-circle me-3">
                    <i class="fas fa-history fa-2x text-info"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="ui.text_1383">预付款历史修订</h5>
                    <p class="text-white-50 small mb-0" id="prepay-history-tran-num" data-i18n="ui.text_1384">流水号: -</p>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="closePrepayHistory()">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="common.back_list">返回列表</span>
            </button>
        </div>

        <!-- 加载中 -->
        <div id="prepay-history-loading" class="text-center py-5">
            <div class="spinner-border text-info" role="status"></div>
            <p class="text-white-50 mt-3 mb-0" data-i18n="ui.text_707">正在加载历史记录...</p>
        </div>

        <!-- 三栏布局 -->
        <div id="prepay-history-content" class="row g-3" style="display: none;">
            <!-- 左栏：厂商策略修改 -->
            <div class="col-md-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header border-secondary" style="background: rgba(111, 66, 193, 0.15);">
                        <i class="fas fa-building me-2" style="color: #6f42c1;"></i>
                        <span class="text-white fw-bold" data-i18n="ui.text_1386">厂商策略</span>
                        <span class="badge ms-2" style="background: #6f42c1;" id="prepay-strategy-count">0</span>
                    </div>
                    <div class="card-body p-0" style="max-height: 550px; overflow-y: auto;">
                        <div id="prepay-supplier-strategy-container" class="p-3"></div>
                    </div>
                </div>
            </div>

            <!-- 中栏：汇率/货币修改 -->
            <div class="col-md-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header bg-primary bg-opacity-10 border-secondary">
                        <i class="fas fa-exchange-alt me-2 text-primary"></i>
                        <span class="text-white fw-bold" data-i18n="ui.text_1387">汇率/货币</span>
                        <span class="badge bg-primary ms-2" id="prepay-rate-count">0</span>
                    </div>
                    <div class="card-body p-0" style="max-height: 550px; overflow-y: auto;">
                        <div id="prepay-history-rate-container" class="p-3"></div>
                    </div>
                </div>
            </div>

            <!-- 右栏：金额修订记录 -->
            <div class="col-md-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header bg-success bg-opacity-10 border-secondary">
                        <i class="fas fa-dollar-sign me-2 text-success"></i>
                        <span class="text-white fw-bold" data-i18n="ui.text_1388">金额修订</span>
                        <span class="badge bg-success ms-2" id="prepay-amount-count">0</span>
                    </div>
                    <div class="card-body p-0" style="max-height: 550px; overflow-y: auto;">
                        <div id="prepay-amount-container" class="p-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#prepay-history-view .version-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(108, 117, 125, 0.3);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    overflow: hidden;
}
#prepay-history-view .version-header {
    background: rgba(255, 255, 255, 0.05);
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid rgba(108, 117, 125, 0.2);
}
#prepay-history-view .version-header.initial {
    background: linear-gradient(90deg, rgba(13, 110, 253, 0.2), transparent);
    border-left: 3px solid #0d6efd;
}
#prepay-history-view .version-header.strategy {
    background: linear-gradient(90deg, rgba(111, 66, 193, 0.2), transparent);
    border-left: 3px solid #6f42c1;
}
#prepay-history-view .version-seq {
    font-family: 'SF Mono', monospace;
    font-weight: bold;
    font-size: 0.85rem;
}
#prepay-history-view .version-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
}
#prepay-history-view .version-meta i { margin-right: 0.25rem; }
#prepay-history-view .version-body { padding: 0.75rem; }
#prepay-history-view .change-item {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 0.4rem;
    margin-bottom: 0.4rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    font-size: 0.8rem;
    border-left: 3px solid #ffc107;
}
#prepay-history-view .change-old { color: #dc3545; text-decoration: line-through; }
#prepay-history-view .change-new { color: #198754; }
#prepay-history-view .usd-equivalent {
    width: 100%;
    margin-top: 0.3rem;
    padding-top: 0.3rem;
    border-top: 1px dashed rgba(108, 117, 125, 0.3);
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
}
#prepay-history-view .initial-card-table {
    width: 100%;
    font-size: 0.8rem;
}
#prepay-history-view .initial-card-table td {
    padding: 0.3rem 0;
    border-bottom: 1px solid rgba(108, 117, 125, 0.1);
}
#prepay-history-view .initial-card-table td:first-child {
    color: rgba(255, 255, 255, 0.5);
    width: 45%;
}
#prepay-history-view .initial-card-table td:last-child { color: #fff; }
#prepay-history-view .empty-state {
    text-align: center;
    padding: 1.5rem;
    color: rgba(255, 255, 255, 0.4);
}
</style>

<script>
function closePrepayHistory() {
    document.getElementById('prepay-history-view').style.display = 'none';
    document.getElementById('prepay-list-view').style.display = 'flex';
}

function loadPrepayHistory(tranNum) {
    var loading = document.getElementById('prepay-history-loading');
    var content = document.getElementById('prepay-history-content');
    
    document.getElementById('prepay-history-tran-num').textContent = (window.i18n?.t('js.txn_no_colon') || 'Txn No: ') + tranNum;
    loading.style.display = 'block';
    content.style.display = 'none';
    
    fetch('{% url "web_ui:finance:prepay_history" %}?tran_num=' + encodeURIComponent(tranNum))
        .then(function(res) { return res.json(); })
        .then(function(data) {
            loading.style.display = 'none';
            
            if (!data.success) {
                document.getElementById('prepay-supplier-strategy-container').innerHTML = 
                    '<div class="empty-state"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><p data-i18n="ui.text_1389">' + (data.error || (window.i18n?.t('js.load_failed') || 'Load Failed')) + '</p></div>';
                document.getElementById('prepay-history-rate-container').innerHTML = '';
                document.getElementById('prepay-amount-container').innerHTML = '';
                content.style.display = 'flex';
                return;
            }
            
            content.style.display = 'flex';
            renderSupplierStrategyVersions(data.data.supplier_strategy_versions || []);
            renderPrepayRateVersions(data.data.prepay_rate_versions || []);
            renderAmountVersions(data.data.amount_versions || []);
        })
        .catch(function(err) {
            loading.style.display = 'none';
            content.style.display = 'flex';
            document.getElementById('prepay-supplier-strategy-container').innerHTML = 
                '<div class="empty-state"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p data-i18n="toast.network_error">网络错误</p></div>';
        });
}

function renderSupplierStrategyVersions(versions) {
    var container = document.getElementById('prepay-supplier-strategy-container');
    document.getElementById('prepay-strategy-count').textContent = versions.length;
    
    if (!versions || versions.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox fa-2x mb-2"></i><p data-i18n="ui.text_712">暂无策略记录</p></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < versions.length; i++) {
        var v = versions[i];
        var headerClass = v.is_initial ? 'strategy' : '';
        var badgeHtml = v.is_initial 
            ? '<span class="badge" style="background:#6f42c1;" data-i18n="ui.text_1392">原始记录</span>'
            : '<span class="badge bg-secondary" data-i18n="ui.text_2436">变更</span>';
        
        html += '<div class="version-card">';
        html += '<div class="version-header ' + headerClass + '">';
        html += '<div class="d-flex justify-content-between align-items-center mb-1">';
        html += '<span class="version-seq" style="color:#6f42c1;">' + v.seq + '</span>';
        html += badgeHtml;
        html += '</div>';
        html += '<div class="version-meta">';
        html += '<span><i class="fas fa-calendar"></i>' + (v.date || '-') + '</span>';
        html += '<span><i class="fas fa-user"></i>' + (v.by || '-') + '</span>';
        html += '</div>';
        if (v.effective_date) {
            html += '<div class="text-white-50 small mt-1"><i class="fas fa-calendar-check me-1"></i>生效: ' + v.effective_date + '</div>';
        }
        if (v.note) {
            html += '<div class="text-white-50 small mt-1"><i class="fas fa-comment me-1"></i>' + v.note + '</div>';
        }
        html += '</div>';
        html += '<div class="version-body">';
        
        if (v.is_initial) {
            html += '<table class="initial-card-table">';
            html += '<tr><td data-i18n="ui.text_2593">厂商要求货币</td><td><span class="badge bg-info">' + (v.currency || '-') + '</span></td></tr>';
            html += '</table>';
        } else if (v.changes && v.changes.length > 0) {
            for (var j = 0; j < v.changes.length; j++) {
                var c = v.changes[j];
                html += '<div class="change-item">';
                html += '<span class="text-white-50">' + c.field + ':</span>';
                html += '<span class="badge bg-danger ms-2">' + c.old + '</span>';
                html += '<span class="mx-2"><i class="fas fa-arrow-right text-muted"></i></span>';
                html += '<span class="badge bg-success">' + c.new + '</span>';
                html += '</div>';
            }
        } else {
            html += '<div class="text-white-50 small" data-i18n="common.no_change">无变更</div>';
        }
        
        html += '</div></div>';
    }
    
    container.innerHTML = html;
}

function renderPrepayRateVersions(versions) {
    var container = document.getElementById('prepay-history-rate-container');
    document.getElementById('prepay-rate-count').textContent = versions ? versions.length : 0;
    
    if (!versions || versions.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox fa-2x mb-2"></i><p data-i18n="ui.text_1394">暂无记录</p></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < versions.length; i++) {
        var v = versions[i];
        var headerClass = v.is_initial ? 'initial' : '';
        var badgeHtml = v.is_initial 
            ? '<span class="badge bg-primary" data-i18n="ui.text_1392">原始记录</span>'
            : '<span class="badge bg-secondary" data-i18n="ui.text_714">修订</span>';
        
        html += '<div class="version-card">';
        html += '<div class="version-header ' + headerClass + '">';
        html += '<div class="d-flex justify-content-between align-items-center mb-1">';
        html += '<span class="version-seq text-info">' + (v.seq || '?') + '</span>';
        html += badgeHtml;
        html += '</div>';
        html += '<div class="version-meta">';
        html += '<span><i class="fas fa-calendar"></i>' + (v.date || '-') + '</span>';
        html += '<span><i class="fas fa-user"></i>' + (v.by || '-') + '</span>';
        html += '</div>';
        html += '</div>';
        html += '<div class="version-body">';
        
        if (v.is_initial) {
            var rateStr = '-';
            if (v.usd_rmb === 0 || v.usd_rmb) {
                rateStr = Number(v.usd_rmb).toFixed(4);
            }
            var currStr = v.tran_curr_use || '-';
            
            html += '<table class="initial-card-table">';
            html += '<tr><td data-i18n="rate.label">汇率 (USD/RMB)</td><td>' + rateStr + '</td></tr>';
            html += '<tr><td data-i18n="ui.text_2596">操作货币</td><td><span class="badge bg-info">' + currStr + '</span></td></tr>';
            html += '</table>';
        } else if (v.changes && v.changes.length > 0) {
            for (var j = 0; j < v.changes.length; j++) {
                var c = v.changes[j];
                html += '<div class="change-item">';
                html += '<span class="text-white-50">' + c.field + ':</span>';
                html += '<span class="badge bg-danger ms-2">' + c.old + '</span>';
                html += '<span class="mx-2"><i class="fas fa-arrow-right text-muted"></i></span>';
                html += '<span class="badge bg-success">' + c.new + '</span>';
                html += '</div>';
            }
        } else {
            html += '<div class="text-white-50 small" data-i18n="common.no_change">无变更</div>';
        }
        
        html += '</div></div>';
    }
    
    container.innerHTML = html;
}

function renderAmountVersions(versions) {
    var container = document.getElementById('prepay-amount-container');
    document.getElementById('prepay-amount-count').textContent = versions.length;
    
    if (!versions || versions.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox fa-2x mb-2"></i><p data-i18n="ui.text_1397">暂无金额记录</p></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < versions.length; i++) {
        var v = versions[i];
        var headerClass = v.is_initial ? 'initial' : '';
        var badgeHtml = v.is_initial 
            ? '<span class="badge bg-primary" data-i18n="ui.text_1392">原始记录</span>'
            : '<span class="badge bg-secondary" data-i18n="ui.text_714">修订</span>';
        
        if (v.tran_ops === 'delete') {
            headerClass = 'delete-order';
            badgeHtml = '<span class="badge bg-danger"><i class="fas fa-trash me-1"></i>删除</span>';
        } else if (v.tran_ops === 'restore') {
            headerClass = 'restore-order';
            badgeHtml = '<span class="badge bg-success"><i class="fas fa-undo me-1"></i>恢复</span>';
        }
        
        html += '<div class="version-card">';
        html += '<div class="version-header ' + headerClass + '">';
        html += '<div class="d-flex justify-content-between align-items-center mb-1">';
        html += '<span class="version-seq text-success">' + v.seq + '</span>';
        html += badgeHtml;
        html += '</div>';
        html += '<div class="version-meta">';
        html += '<span><i class="fas fa-calendar"></i>' + (v.date || '-') + '</span>';
        html += '<span><i class="fas fa-user"></i>' + (v.by || '-') + '</span>';
        html += '</div>';
        if (v.note) {
            html += '<div class="text-white-50 small mt-1"><i class="fas fa-comment me-1"></i>' + v.note + '</div>';
        }
        html += '</div>';
        html += '<div class="version-body">';
        
        if (v.is_initial) {
            html += '<table class="initial-card-table">';
            html += '<tr><td data-i18n="ui.text_2598">付款金额</td><td><span class="badge bg-info me-1">' + (v.currency || 'RMB') + '</span><span class="fw-bold text-success">' + formatPrepayNumber(v.amount) + '</span></td></tr>';
            if (v.currency === 'RMB' && v.usd_amount) {
                html += '<tr><td data-i18n="ui.text_2599">折算USD</td><td><span class="badge bg-warning text-dark me-1">USD</span><span class="text-warning">' + formatPrepayNumber(v.usd_amount) + '</span></td></tr>';
            }
            html += '</table>';
        } else if (v.tran_ops === 'delete') {
            html += '<div class="text-danger small"><i class="fas fa-exclamation-triangle me-1"></i>记录已删除</div>';
        } else if (v.tran_ops === 'restore') {
            html += '<div class="text-success small"><i class="fas fa-check-circle me-1"></i>记录已恢复</div>';
        } else if (v.changes && v.changes.length > 0) {
            for (var j = 0; j < v.changes.length; j++) {
                var c = v.changes[j];
                html += '<div class="change-item">';
                html += '<span class="text-white-50">' + c.field + ':</span>';
                html += '<span class="change-old ms-2">' + c.old + '</span>';
                html += '<span class="mx-2"><i class="fas fa-arrow-right text-muted"></i></span>';
                html += '<span class="change-new">' + c.new + '</span>';
                if (c.old_currency === 'RMB' || c.new_currency === 'RMB') {
                    html += '<div class="usd-equivalent">';
                    html += '<span class="badge bg-warning text-dark me-1" style="font-size:0.65rem;">USD</span>';
                    html += '<span class="text-decoration-line-through me-2">' + formatPrepayNumber(c.old_usd) + '</span>';
                    html += '<i class="fas fa-arrow-right text-muted mx-1"></i>';
                    html += '<span class="text-warning">' + formatPrepayNumber(c.new_usd) + '</span>';
                    html += '</div>';
                }
                html += '</div>';
            }
        } else {
            html += '<div class="text-white-50 small" data-i18n="common.no_change">无变更</div>';
        }
        
        html += '</div></div>';
    }
    
    container.innerHTML = html;
}

function formatPrepayNumber(num) {
    if (!num && num !== 0) return '-';
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}
</script>