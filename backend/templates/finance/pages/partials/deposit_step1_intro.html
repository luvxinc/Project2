<!-- Step 1: 付款说明 (Deposit) -->
<style>
    /* Wizard Step 1 Specific Styles */
    .step1-table-container {
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .step1-table thead th {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        padding: 14px 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .step1-table tbody td {
        padding: 14px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 13px;
        vertical-align: middle;
    }

    /* Accounting Box Style */
    .acct-box {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        min-width: 90px;
    }
    .acct-row {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        justify-content: flex-end;
    }
    .acct-badge-usd {
        background-color: #198754; /* bg-success */
        font-size: 9px;
        width: 32px;
        text-align: center;
        border-radius: 4px;
        padding: 1px 0;
    }
    .acct-badge-rmb {
        background-color: #0dcaf0; /* bg-info */
        font-size: 9px;
        width: 32px;
        text-align: center;
        border-radius: 4px;
        padding: 1px 0;
    }
    .acct-amt {
        letter-spacing: -0.3px;
    }
    .acct-amt.primary { color: rgba(255, 255, 255, 0.9); }
    .acct-amt.secondary { color: rgba(255, 255, 255, 0.9); }
    .acct-amt.paid { color: #198754; } /* text-success */
    .acct-amt.pending { color: #ffc107; font-weight: bold; } /* text-warning */
</style>

<!-- 付款须知 -->
<div class="card bg-dark bg-opacity-50 border-info border-opacity-25 mb-4">
    <div class="card-header bg-info bg-opacity-10 border-0 d-flex align-items-center">
        <i class="fas fa-info-circle text-info me-2"></i>
        <span class="text-info fw-bold" data-i18n="ui.text_1400">付款须知</span>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="text-white-50 mb-3 small">
                    <p class="mb-1">1. <strong data-i18n="ui.text_1401">核对清单</strong>：<span data-i18n="instructions.desc_65">请确认定金比例、定金费用及已付金额是否正确。</span></p>
                    <p class="mb-1">2. <strong data-i18n="finance.batch_payment">批量付款</strong>：<span data-i18n="instructions.desc_31">本次选中的所有订单将共享同一个付款单号 (DPMT_)。</span></p>
                    <p class="mb-0">3. <strong data-i18n="ui.text_1403">继续流程</strong>：<span data-i18n="instructions.desc_56">确认无误后，点击「下一步」设定汇率与抵扣选项。</span></p>
                </div>
                <div class="d-flex gap-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-white" data-i18n="ui.text_1404">定金待付金额</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-white" data-i18n="table.deposit_rate">定金比例</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-white" data-i18n="table.settlement_rate">结算汇率</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 rounded bg-warning bg-opacity-10 border border-warning border-opacity-25">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-triangle text-warning mt-1 me-2"></i>
                        <div>
                            <strong class="text-warning d-block mb-1" data-i18n="shipping.important_notice">重要提示</strong>
                            <p class="text-white-50 small mb-0">
                                本流程<span class="text-warning" data-i18n="ui.text_1408">仅处理定金</span>（非货款尾款）。如需调整订单数据，请退出向导前往「订货单管理」修正。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 待付款清单 -->
<div class="card bg-dark border-secondary border-opacity-25 mb-4" id="summary-card">
    <div class="card-header bg-secondary bg-opacity-10 border-0 d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center">
            <i class="fas fa-list-check me-2 text-white-50"></i>
            <span class="text-white fw-bold" data-i18n="ui.text_1409">待付款订货单</span>
            <span class="badge bg-primary ms-3 rounded-pill" id="deposit-count-badge" data-i18n="ui.text_1410">0 单</span>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- 表格容器 -->
        <div class="step1-table-container">
            <table class="table mb-0 step1-table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 14%;" data-i18n="table.order_no">订货单号</th>
                        <th class="text-center" style="width: 10%;" data-i18n="table.order_date">订单日期</th>
                        <th class="text-end pe-3" style="width: 14%;" data-i18n="table.total_amount">订单总金额</th>
                        <th class="text-center" style="width: 10%;" data-i18n="table.settlement_rate">结算汇率</th>
                        <th class="text-center" style="width: 8%;" data-i18n="table.deposit_rate">定金比例</th>
                        <th class="text-end pe-3" style="width: 14%;" data-i18n="table.deposit_amount">定金费用</th>
                        <th class="text-end pe-3" style="width: 12%;" data-i18n="table.deposit_paid">已付定金</th>
                        <th class="text-end pe-3" style="width: 14%;" data-i18n="table.deposit_due">定金待付</th>
                        <th class="text-center" style="width: 4%;"></th>
                    </tr>
                </thead>
                <tbody id="payment-list-body">
                    <!-- JS动态填充 -->
                </tbody>
            </table>
        </div>
        
        <!-- 合计栏 (保持UI一致的双币展示) -->
        <div class="bg-black bg-opacity-25 p-4 border-top border-secondary border-opacity-25">
            <div class="row">
                <!-- 定金合计 -->
                <div class="col-md-4 border-end border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-2 text-center" data-i18n="ui.text_2536">定金合计</div>
                    <div class="d-flex justify-content-center">
                        <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-white fw-bold fs-5" id="total-deposit-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-white-50 fw-bold" id="total-deposit-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 已付定金 -->
                <div class="col-md-4 border-end border-secondary border-opacity-25">
                    <div class="text-white-50 small mb-2 text-center" data-i18n="table.deposit_paid">已付定金</div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-success fw-bold fs-5" id="total-paid-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-success text-opacity-75 fw-bold" id="total-paid-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 本次待付 -->
                <div class="col-md-4">
                     <div class="text-warning small mb-2 text-center fw-bold" data-i18n="ui.text_2539">本次待付</div>
                    <div class="d-flex justify-content-center">
                         <div class="d-flex flex-column align-items-end gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-success" style="font-size: 0.7rem; width: 36px;">USD</span>
                                <span class="text-warning fw-bold fs-4" id="total-pending-usd">$0.00</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-info" style="font-size: 0.7rem; width: 36px;">RMB</span>
                                <span class="text-warning text-opacity-75 fw-bold" id="total-pending-rmb">¥0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 空状态 -->
<div id="empty-state" class="text-center py-5" style="display: none;">
    <i class="fas fa-exclamation-circle fa-3x text-warning opacity-50 mb-3"></i>
    <p class="text-white-50 mb-3" data-i18n="ui.text_1411">未选择任何订货单</p>
    <button type="button" class="btn btn-outline-primary" onclick="closeDepositWizard()">
        <i class="fas fa-arrow-left me-1"></i><span data-i18n="ui.icon_3415">返回选择</span>
    </button>
</div>

<!-- 操作按钮 -->
<div class="wizard-actions mt-4">
    <div class="wizard-actions-left">
        <button type="button" class="btn btn-outline-secondary rounded-pill" onclick="closeDepositWizard()">
            <i class="fas fa-times me-2"></i><span data-i18n="finance.cancel_payment">取消付款</span>
        </button>
    </div>
    <div class="wizard-actions-right">
        <button type="button" class="btn btn-success rounded-pill px-5 shadow-lg" id="btn-step1-next">
            下一步 <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>
</div>

<script>
    // Step 1 初始化
    function initStep1() {
        // 绑定按钮事件
        const nextBtn = document.getElementById('btn-step1-next');
        if (nextBtn) {
            // 解绑旧事件以防重复
            const newBtn = nextBtn.cloneNode(true);
            nextBtn.parentNode.replaceChild(newBtn, nextBtn);
            
            newBtn.addEventListener('click', function() {
                if (window.paymentWizard) {
                    window.paymentWizard.next();
                }
            });
        }
        
        const tbody = document.getElementById('payment-list-body');
        
        if (!window.paymentItems || window.paymentItems.length === 0) {
            document.getElementById('summary-card').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            if (newBtn) newBtn.disabled = true;
            return;
        }

        
        document.getElementById('deposit-count-badge').textContent = `${window.paymentItems.length} 单`;
        
        let totalDepositUSD = 0, totalDepositRMB = 0;
        let totalPaidUSD = 0, totalPaidRMB = 0;
        let totalPendingUSD = 0, totalPendingRMB = 0;
        
        // 渲染单行金额的辅助函数 (Accounting Style)
        const renderRowAmount = (val, valUsd, cur, cls) => {
             const v = parseFloat(val) || 0;
             const vUsd = parseFloat(valUsd) || 0;
             
             let html = `<div class="acct-box">`;
             
             // 如果是 USD:
             // Row 1: USD Badge + Amount
             // If RMB:
             // Row 1: RMB Badge + Amount
             // Row 2: USD Badge + Amount
             
             const badgeColor = cur === 'USD' ? 'bg-success' : 'bg-info';
             
             html += `<div class="acct-row">
                        <span class="badge ${badgeColor}" style="font-size:9px; width:32px;">${cur}</span>
                        <span class="acct-amt ${cls || ''}">${formatNumber(v)}</span>
                      </div>`;
                      
             // Secondary Row (如果主货币是RMB，显示折算的USD)
             if (cur !== 'USD') {
                 html += `<div class="acct-row">
                            <span class="badge bg-success" style="font-size:9px; width:32px;">USD</span>
                            <span class="acct-amt secondary">${formatNumber(vUsd)}</span>
                          </div>`;
             }
             
             html += `</div>`;
             return html;
        };

        tbody.innerHTML = window.paymentItems.map(item => {
            const cur = item.cur_currency || 'RMB';
            const rate = item.cur_usd_rmb || 7.0;
            
            // Amounts
            const total = item.total_amount || 0;
            const totalUsd = item.total_amount_usd || (cur === 'USD' ? total : total / rate);
            
            const depAmount = item.deposit_amount || 0;
            const depAmountUsd = item.deposit_amount_usd || (cur === 'USD' ? depAmount : depAmount / rate);
            
            const paid = item.actual_paid || 0;
            const paidUsd = item.actual_paid_usd || (cur === 'USD' ? paid : paid / rate);
            
            const pending = item.deposit_pending || 0;
            const pendingUsd = item.deposit_pending_usd || (cur === 'USD' ? pending : pending / rate);
            
            const balance = item.balance_remaining || 0;
            const balanceUsd = item.balance_remaining_usd || (cur === 'USD' ? balance : balance / rate);

            // 累加总计 (所有金额都折算成 RMB 和 USD 两个池子)
            if (cur === 'USD') {
                totalDepositUSD += depAmount;
                totalDepositRMB += depAmount * rate;
                
                totalPaidUSD += paid;
                totalPaidRMB += paid * rate;
                
                totalPendingUSD += pending;
                totalPendingRMB += pending * rate;
            } else {
                totalDepositRMB += depAmount;
                totalDepositUSD += depAmount / rate;
                
                totalPaidRMB += paid;
                totalPaidUSD += paid / rate;
                
                totalPendingRMB += pending;
                totalPendingUSD += pending / rate;
            }
            
            // Rate Badge
            const isAuto = (item.rate_source_code || 'AUTO') === 'AUTO';
            const rateBadgeClass = isAuto ? 'bg-info bg-opacity-10 text-info border-info border-opacity-25' : 'bg-light bg-opacity-10 text-light border-secondary border-opacity-25';
            const rateBadgeText = isAuto ? (window.i18n?.t('js.auto_fetch') || 'Auto Fetch') : (window.i18n?.t('js.manual_input') || 'Manual Input');

            return `
                <tr>
                    <td class="text-center font-monospace fw-bold text-white">${item.po_num}</td>
                    <td class="text-center">${item.po_date || '-'}</td>
                    
                    <!-- 订单总金额 -->
                    <td class="text-end pe-3">${renderRowAmount(total, totalUsd, cur)}</td>
                    
                    <!-- 结算汇率 -->
                    <td class="text-center">
                        <div class="d-flex flex-column align-items-center">
                            <span class="text-white fw-bold">${rate.toFixed(4)}</span>
                            <span class="badge border ${rateBadgeClass} mt-1" style="font-size: 9px; padding: 2px 6px;">
                                ${rateBadgeText}
                            </span>
                        </div>
                    </td>
                    
                    <td class="text-center">${item.deposit_par}%</td>
                    
                    <!-- 定金费用 -->
                    <td class="text-end pe-3">${renderRowAmount(depAmount, depAmountUsd, cur)}</td>
                    
                    <!-- 已付定金 -->
                    <td class="text-end pe-3">${renderRowAmount(paid, paidUsd, cur, 'paid')}</td>
                    
                    <!-- 定金待付 -->
                    <td class="text-end pe-3">${renderRowAmount(pending, pendingUsd, cur, 'pending')}</td>
                    
                    <!-- 移除按钮 -->
                    <td class="text-center">
                        <button type="button" class="btn btn-link btn-sm text-danger p-0" onclick="removeFromWizard('${item.po_num}')" data-i18n-title="tooltip.t1108" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Fill Summary
        document.getElementById('total-deposit-usd').textContent = formatNumber(totalDepositUSD);
        document.getElementById('total-deposit-rmb').textContent = formatNumber(totalDepositRMB);
        
        document.getElementById('total-paid-usd').textContent = formatNumber(totalPaidUSD);
        document.getElementById('total-paid-rmb').textContent = formatNumber(totalPaidRMB);
        
        document.getElementById('total-pending-usd').textContent = formatNumber(totalPendingUSD);
        document.getElementById('total-pending-rmb').textContent = formatNumber(totalPendingRMB);
        
        document.getElementById('btn-step1-next').disabled = false;
    }
    
    // 从向导中移除订单
    function removeFromWizard(poNum) {
        if (window.paymentItems) {
            window.paymentItems = window.paymentItems.filter(item => item.po_num !== poNum);
            initStep1();
        }
    }
    
    function formatNumber(num) {
        return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
</script>