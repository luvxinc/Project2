<!-- Step 4: 付款完成 -->
<div class="row">
    <div class="col-12">
        <div class="success-card text-center">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h4 class="text-success mb-2" data-i18n="ui.text_1443">付款完成</h4>
            <p class="text-white-50 mb-4"><span data-i18n="desc.d092">已成功标记</span> <span class="text-white fw-bold"
                    id="success-count">0</span> <span data-i18n="desc.d094">单物流单为已付款状态</span></p>

            <!-- 费用汇总卡片 -->
            <div class="success-summary-cards">
                <div class="summary-card">
                    <div class="summary-card-header">
                        <i class="fas fa-truck text-info"></i>
                        <span data-i18n="ui.text_2169">物流费用</span>
                    </div>
                    <div class="summary-card-body">
                        <div class="amount-row">
                            <span class="currency-badge usd">USD</span>
                            <span class="amount text-info" id="success-logistics-usd">$0.00</span>
                        </div>
                        <div class="amount-row">
                            <span class="currency-badge rmb">RMB</span>
                            <span class="amount text-warning" id="success-logistics-rmb">¥0.00</span>
                        </div>
                    </div>
                </div>

                <div class="summary-card" id="success-extra-card" style="display: none;">
                    <div class="summary-card-header" id="success-extra-header">
                        <i class="fas fa-receipt text-info" id="success-extra-icon"></i>
                        <span id="success-extra-title" data-i18n="table.extra_fees">额外费用</span>
                    </div>
                    <div class="summary-card-body">
                        <div class="amount-row">
                            <span class="currency-badge usd">USD</span>
                            <span class="amount" id="success-extra-usd">$0.00</span>
                        </div>
                        <div class="amount-row">
                            <span class="currency-badge rmb">RMB</span>
                            <span class="amount" id="success-extra-rmb">¥0.00</span>
                        </div>
                    </div>
                </div>

                <div class="summary-card total">
                    <div class="summary-card-header">
                        <i class="fas fa-calculator text-warning"></i>
                        <span data-i18n="ui.text_2578">付款总额</span>
                    </div>
                    <div class="summary-card-body">
                        <div class="amount-row">
                            <span class="currency-badge usd">USD</span>
                            <span class="amount text-info fs-5 fw-bold" id="success-total-usd">$0.00</span>
                        </div>
                        <div class="amount-row">
                            <span class="currency-badge rmb">RMB</span>
                            <span class="amount text-warning fs-5 fw-bold" id="success-total-rmb">¥0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 付款信息 -->
            <div class="success-info mt-4">
                <div class="info-item">
                    <i class="fas fa-calendar-check text-white-50"></i>
                    <span class="text-white-50" data-i18n="table.payment_date">付款日期</span>
                    <span class="text-white fw-bold" id="success-payment-date">-</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-user text-white-50"></i>
                    <span class="text-white-50" data-i18n="common.operator">操作人</span>
                    <span class="text-white fw-bold" id="success-operator">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wizard Actions -->
<div class="wizard-actions mt-4">
    <div class="wizard-actions-left"></div>
    <div class="wizard-actions-right">
        <button type="button" class="btn btn-success rounded-pill px-4" id="btn-step4-done"
            onclick="closePaymentWizard()">
            <i class="fas fa-check me-2"></i><span data-i18n="ui.icon_3427">返回Logistics Finance</span>
        </button>
    </div>
</div>

<style>
    .success-card {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.08), rgba(0, 0, 0, 0.3));
        border: 1px solid rgba(25, 135, 84, 0.25);
        border-radius: 16px;
        padding: 2.5rem 2rem;
    }

    .success-icon {
        width: 70px;
        height: 70px;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.25), rgba(25, 135, 84, 0.1));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: successPulse 2s infinite;
    }

    .success-icon i {
        font-size: 2rem;
        color: #198754;
    }

    @keyframes successPulse {

        0%,
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.4);
        }

        50% {
            transform: scale(1.03);
            box-shadow: 0 0 20px 5px rgba(25, 135, 84, 0.2);
        }
    }

    .success-summary-cards {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        max-width: 600px;
        margin: 0 auto;
    }

    .summary-card {
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(108, 117, 125, 0.25);
        border-radius: 12px;
        min-width: 160px;
        flex: 1;
        max-width: 180px;
    }

    .summary-card.total {
        border-color: rgba(255, 193, 7, 0.35);
        background: rgba(255, 193, 7, 0.08);
    }

    .summary-card-header {
        padding: 0.6rem 0.8rem;
        border-bottom: 1px solid rgba(108, 117, 125, 0.15);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .summary-card-header i {
        font-size: 0.75rem;
    }

    .summary-card-body {
        padding: 0.8rem;
    }

    .amount-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.4rem;
    }

    .amount-row:last-child {
        margin-bottom: 0;
    }

    .currency-badge {
        font-size: 0.6rem;
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        font-weight: 600;
    }

    .currency-badge.usd {
        background: rgba(13, 110, 253, 0.2);
        color: #0dcaf0;
    }

    .currency-badge.rmb {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .amount {
        font-family: 'SF Mono', monospace;
        font-size: 0.95rem;
    }

    .success-info {
        display: flex;
        justify-content: center;
        gap: 3rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(108, 117, 125, 0.15);
    }

    .info-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .info-item i {
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .info-item span:first-of-type {
        font-size: 0.75rem;
    }
</style>

<script>
    // Step 4 初始化
    function initStep4() {
        // 获取汇率
        const currentRate = window.paymentItems && window.paymentItems.length > 0
            ? (window.paymentItems[0].usd_rmb || 7.0) : 7.0;

        // 计算物流费用
        let logisticsRMB = 0;
        let logisticsUSD = 0;
        if (window.paymentItems) {
            window.paymentItems.forEach(item => {
                const rmb = item.total_price_rmb || 0;
                const rate = item.usd_rmb || 7.0;
                logisticsRMB += rmb;
                logisticsUSD += rmb / rate;
            });
        }

        // 计算额外费用/减免
        let extraRMB = 0;
        let extraUSD = 0;
        // 支持正数（额外费用）和负数（额外减免）
        const hasExtraFee = window.extraFeeData && window.extraFeeData.note &&
            window.extraFeeData.currency && window.extraFeeData.amount !== undefined && window.extraFeeData.amount !== 0;

        if (hasExtraFee) {
            const { currency, amount, isDeduction } = window.extraFeeData;
            if (currency === 'RMB') {
                extraRMB = amount;
                extraUSD = amount / currentRate;
            } else if (currency === 'USD') {
                extraUSD = amount;
                extraRMB = amount * currentRate;
            }
            
            // 更新额外费用卡片样式
            const extraCard = document.getElementById('success-extra-card');
            const extraHeader = document.getElementById('success-extra-header');
            const extraIcon = document.getElementById('success-extra-icon');
            const extraTitle = document.getElementById('success-extra-title');
            const extraUSDEl = document.getElementById('success-extra-usd');
            const extraRMBEl = document.getElementById('success-extra-rmb');
            
            extraCard.style.display = 'block';
            
            // 根据正负更新样式
            const absExtraRMB = Math.abs(extraRMB);
            const absExtraUSD = Math.abs(extraUSD);
            const sign = amount < 0 ? '-' : '';
            
            if (isDeduction || amount < 0) {
                // 负数 = 额外减免
                extraIcon.className = 'fas fa-minus-circle text-success';
                extraTitle.className = 'text-success';
                extraTitle.textContent = window.i18n?.t('finance.extra_deduction') || '额外减免';
                extraUSDEl.className = 'amount text-success';
                extraRMBEl.className = 'amount text-success';
            } else {
                // 正数 = 额外费用
                extraIcon.className = 'fas fa-receipt text-info';
                extraTitle.className = 'text-info';
                extraTitle.textContent = window.i18n?.t('table.extra_fees') || '额外费用';
                extraUSDEl.className = 'amount text-info';
                extraRMBEl.className = 'amount text-warning';
            }
            
            extraRMBEl.textContent = `${sign}¥${absExtraRMB.toFixed(2)}`;
            extraUSDEl.textContent = `${sign}$${absExtraUSD.toFixed(2)}`;
        } else {
            document.getElementById('success-extra-card').style.display = 'none';
        }

        // 计算总计（正数加，负数减）
        const totalRMB = logisticsRMB + extraRMB;
        const totalUSD = logisticsUSD + extraUSD;

        // 更新显示
        document.getElementById('success-count').textContent = window.paymentItems ? window.paymentItems.length : 0;
        document.getElementById('success-logistics-rmb').textContent = `¥${logisticsRMB.toFixed(2)}`;
        document.getElementById('success-logistics-usd').textContent = `$${logisticsUSD.toFixed(2)}`;

        document.getElementById('success-total-rmb').textContent = `¥${totalRMB.toFixed(2)}`;
        document.getElementById('success-total-usd').textContent = `$${totalUSD.toFixed(2)}`;

        // 付款日期
        const paymentDate = window.step2RateState ? window.step2RateState.paymentDate : '-';
        document.getElementById('success-payment-date').textContent = paymentDate || '-';

        // 操作人
        const operatorEl = document.querySelector('[data-current-user]');
        const operator = operatorEl ? operatorEl.dataset.currentUser : (window.i18n?.t('js.current_user') || 'Current User');
        document.getElementById('success-operator').textContent = operator || (window.i18n?.t('js.current_user') || 'Current User');
    }

    // closePaymentWizard 已在 logistic.html 中定义
    // 此处不再重复定义，避免遮蔽主文件版本导致状态刷新问题
</script>