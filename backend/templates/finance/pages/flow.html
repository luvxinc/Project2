{% extends "layouts/base.html" %}
{% load i18n %}

{% block title %}Order-Send-Receive Preview - Finance - ERP System{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- 页面Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard/finance/" class="text-info text-decoration-none" data-i18n="finance.title">Finance</a></li>
                    <li class="breadcrumb-item text-white active" aria-current="page" data-i18n="finance.flow">Order-Send-Receive Preview</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="/dashboard/finance/" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i><span data-i18n="finance.back_to_hub">返回Finance</span>
            </a>
        </div>
    </div>

    <!-- 数据表格区 -->
    <div class="glass-card p-4 shadow-lg">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
            <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-25 rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                    <i class="fas fa-stream fa-2x text-info"></i>
                </div>
                <div>
                    <h5 class="text-white mb-1" data-i18n="finance.flow_page_title">Order-Send-Receive Preview</h5>
                    <p class="text-white-50 small mb-0" data-i18n="ui.text_1227">订单全生命周期概览 - 定金、货款、物流费用及成本汇总</p>
                </div>
            </div>
            <button class="btn btn-outline-light btn-sm rounded-pill" onclick="loadFlowData()">
                <i class="fas fa-sync-alt me-1"></i><span data-i18n="common.refresh">刷新列表</span>
            </button>
        </div>

        <!-- 操作须知 -->
        <div class="alert alert-info mb-4" style="background: rgba(13, 202, 240, 0.1); border: 1px solid rgba(13, 202, 240, 0.3);">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-3 mt-1 text-info fa-lg"></i>
                <div>
                    <strong class="text-info d-block mb-2" data-i18n="finance.page_description">页面说明</strong>
                    <ul class="mb-0 ps-3 text-white-50 small">
                        <li class="mb-1"><strong class="text-white" data-i18n="finance.order_total_cost">订单总成本</strong> = 实际支付金额 + 额外费用 + 物流摊销</li>
                        <li class="mb-1"><strong class="text-white" data-i18n="finance.logistics_allocation">物流摊销</strong>：<span data-i18n="instructions.desc_60">按订单重量占物流单总重量的比例分摊</span></li>
                        <li class="mb-1"><strong class="text-white" data-i18n="table.extra_fees">额外费用</strong>：<span data-i18n="instructions.desc_54">物流/定金/货款三类额外费用汇总（按订单数摊销）</span></li>
                        <li class="mb-1"><strong class="text-white" data-i18n="ui.text_1231">展开详情</strong>：<span data-i18n="instructions.desc_55">点击行首箭头可查看物流单明细</span></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="flow-loading" class="text-center py-5">
            <div class="spinner-border text-info" role="status"></div>
            <p class="text-white-50 mt-3 mb-0" data-i18n="common.loading">正在加载数据...</p>
        </div>

        <!-- 空状态 -->
        <div id="flow-empty" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-white-50 mb-3"></i>
            <p class="text-white-50 mb-0" data-i18n="finance.no_orders">暂无订单数据</p>
        </div>

        <!-- 表格容器 -->
        <div id="flow-table-container" style="display: none;">
            <div class="flow-table-container">
                <table class="flow-table" id="flow-table">
                    <thead>
                        <tr>
                            <th style="width: 10%;" data-i18n="purchase.order_num">订单号</th>
                            <th style="width: 6%;" data-i18n="table.order_date">订单日期</th>
                            <th style="width: 9%;" data-i18n="table.total_amount">订单总金额</th>
                            <th style="width: 10%;" data-i18n="finance.deposit_status">定金状态</th>
                            <th style="width: 8%;" data-i18n="finance.paid_amount">已付货款</th>
                            <th style="width: 8%;" data-i18n="finance.balance_remaining">货款剩余</th>
                            <th style="width: 7%;" data-i18n="finance.actual_payment">实际支付</th>
                            <th style="width: 6%;" data-i18n="table.extra_fees">额外费用</th>
                            <th style="width: 10%;" data-i18n="finance.send_no">发货单号</th>
                            <th style="width: 7%;" data-i18n="finance.logistics_allocation">物流摊销</th>
                            <th style="width: 8%;" data-i18n="finance.order_total_cost">订单总成本</th>
                            <th style="width: 10%;" data-i18n="finance.payment_status">付款状态</th>
                            <th style="width: 2%;"></th>
                        </tr>
                    </thead>
                    <tbody id="flow-table-body">
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <span class="text-white-50 small" id="flow-footer-count" data-i18n="ui.text_566">共 0 条订单</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* 表格容器 - 复用 PO 模块风格 */
    .flow-table-container {
        border-radius: 16px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
        max-height: calc(100vh - 400px);
        overflow-y: auto;
    }

    .flow-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1300px;
    }

    /* 表头 */
    .flow-table thead {
        background: linear-gradient(180deg, rgba(60, 65, 80, 0.95) 0%, rgba(45, 50, 60, 0.95) 100%);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .flow-table thead th {
        padding: 14px 8px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        border-bottom: 2px solid rgba(13, 202, 240, 0.3);
        white-space: nowrap;
    }

    /* 数据行 */
    .flow-table tbody tr.main-row {
        background: rgba(25, 28, 35, 0.6);
        transition: all 0.2s ease;
    }

    .flow-table tbody tr.main-row:hover {
        background: rgba(40, 45, 55, 0.8);
    }

    .flow-table tbody tr.main-row.expanded {
        background: rgba(13, 202, 240, 0.1);
    }

    .flow-table tbody tr:not(:last-child) td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .flow-table tbody td {
        padding: 10px 8px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
        text-align: center;
        vertical-align: middle;
    }

    /* 订单号加粗 */
    .flow-table tbody td.cell-po-num {
        font-weight: 700;
        color: #0dcaf0;
        font-size: 11px;
        text-align: left;
        padding-left: 12px;
    }

    /* 订单总成本高亮 */
    .flow-table tbody td.cell-highlight {
        background: rgba(25, 135, 84, 0.15);
    }

    /* 货款剩余高亮 */
    .flow-table tbody td.cell-highlight-warning {
        background: rgba(255, 193, 7, 0.12);
    }

    /* 展开按钮 */
    .expand-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        padding: 4px 8px;
        transition: all 0.2s;
    }

    .expand-btn:hover {
        color: #0dcaf0;
    }

    .expand-btn.expanded {
        color: #0dcaf0;
    }

    .expand-btn.expanded i {
        transform: rotate(180deg);
    }

    /* 展开行 */
    .detail-row {
        display: none;
    }

    .detail-row.show {
        display: table-row;
    }

    .detail-row td {
        padding: 0 !important;
        background: rgba(0, 0, 0, 0.4);
    }

    .detail-content {
        padding: 20px;
    }

    /* 金额样式 */
    .acct-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .acct-row {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .acct-amt {
        font-size: 12px;
    }

    .amount-primary {
        font-weight: 600;
        color: #fff;
    }

    .amount-secondary {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
    }

    .amount-pending {
        color: #ffc107;
        font-weight: 600;
    }

    .amount-paid {
        color: #198754;
        font-weight: 600;
    }

    .amount-cost {
        color: #20c997;
        font-weight: 700;
    }

    /* 物流单号标签 */
    .logistics-tag {
        display: inline-block;
        background: rgba(13, 202, 240, 0.15);
        border: 1px solid rgba(13, 202, 240, 0.25);
        color: #0dcaf0;
        font-size: 10px;
        padding: 2px 5px;
        border-radius: 4px;
        margin: 1px;
    }

    /* 付款状态图标 */
    .payment-status-icons {
        display: flex;
        justify-content: center;
        gap: 8px;
        font-size: 11px;
    }

    .status-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .status-item .label {
        font-size: 9px;
        color: rgba(255, 255, 255, 0.5);
    }

    /* 详情卡片 */
    .detail-card {
        background: rgba(30, 32, 40, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }

    .detail-card:last-child {
        margin-bottom: 0;
    }

    /* 详情块 - 物流SKU表格 */
    .detail-block {
        background: rgba(30, 32, 40, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 12px;
    }

    .detail-block-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 8px;
    }

    .detail-block table {
        margin-bottom: 0 !important;
    }

    .detail-block table thead th {
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        font-weight: 500;
    }

    .detail-block table tbody td {
        border-color: rgba(255, 255, 255, 0.05);
        vertical-align: middle;
    }
</style>

<script>
var flowData = [];

document.addEventListener('DOMContentLoaded', function() {
    loadFlowData();
});

function loadFlowData() {
    document.getElementById('flow-loading').style.display = 'block';
    document.getElementById('flow-empty').style.display = 'none';
    document.getElementById('flow-table-container').style.display = 'none';

    fetch('/dashboard/finance/flow/api/list/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('flow-loading').style.display = 'none';
            
            if (!data.success) {
                showToast(data.message || '{% trans "加载失败" %}', 'danger');
                return;
            }

            flowData = data.data || [];
            
            if (flowData.length === 0) {
                document.getElementById('flow-empty').style.display = 'block';
                return;
            }

            renderFlowTable();
            document.getElementById('flow-table-container').style.display = 'block';
            document.getElementById('flow-footer-count').textContent = (window.i18n?.t('js.total_prefix') || 'Total ') + flowData.length + ' 条订单';
        })
        .catch(error => {
            document.getElementById('flow-loading').style.display = 'none';
            console.error('Load error:', error);
            showToast('{% trans "加载数据失败" %}', 'danger');
        });
}

function renderFlowTable() {
    var tbody = document.getElementById('flow-table-body');
    var html = '';

    flowData.forEach(function(order, idx) {
        html += renderOrderRow(order, idx);
        html += renderDetailRow(order, idx);
    });

    tbody.innerHTML = html;
    bindExpandEvents();
}

// 格式化双货币金额 (主货币 + USD折算) - 参照定金状态列范本
function renderDualAmount(amount, currency, usdRate, customClass) {
    var cls = customClass || 'amount-primary';
    // 使用定金状态列的布局: d-flex flex-column align-items-start gap-1
    var html = '<div class="d-flex flex-column align-items-start gap-1">';
    
    // 主货币行: d-flex align-items-center gap-1
    var curBadge = currency === 'USD' ? 
        '<span class="badge bg-success" style="font-size:9px; width:28px;">USD</span>' : 
        '<span class="badge bg-info" style="font-size:9px; width:28px;">' + currency + '</span>';
    html += '<div class="d-flex align-items-center gap-1">' + curBadge + '<span style="font-size:11px;" class="' + cls + '">' + formatNumber(amount) + '</span></div>';
    
    // 如果不是 USD，显示折算
    if (currency !== 'USD' && usdRate > 0) {
        var usdAmount = amount / usdRate;
        html += '<div class="d-flex align-items-center gap-1"><span class="badge bg-success" style="font-size:9px; width:28px;">USD</span><span style="font-size:10px;" class="amount-secondary">' + formatNumber(usdAmount) + '</span></div>';
    }
    
    html += '</div>';
    return html;
}

// 格式化 USD 金额 - 参照定金状态列范本
function renderUSDAmount(amount, customClass) {
    var cls = customClass || 'amount-primary';
    // 单行: d-flex align-items-center gap-1
    return '<div class="d-flex align-items-center gap-1">' +
        '<span class="badge bg-success" style="font-size:9px; width:28px;">USD</span>' +
        '<span style="font-size:11px;" class="' + cls + '">' + formatNumber(amount) + '</span>' +
    '</div>';
}

function renderOrderRow(order, idx) {
    // 定金状态
    var depositDisplay = '';
    if (order.deposit_status === 'not_required') {
        depositDisplay = '<span class="badge bg-secondary bg-opacity-25 text-white-50" style="font-size:10px;" data-i18n="ui.text_1233">无定金需求</span>';
    } else {
        // 显示定金金额 (按订单结算货币)
        var depAmount = order.total_amount * (order.deposit_par / 100);
        
        // 定金状态 badge (已减免视为已付清)
        var depStatus = order.deposit_status;
        var depStatusText = order.deposit_status_text;
        if (depStatus === 'override') {
            depStatus = 'paid';
            depStatusText = (window.i18n?.t('js.fully_paid') || 'Fully Paid');
        }
        
        var depStatusClass = depStatus === 'paid' ? 'bg-success text-success' : 
                            (depStatus === 'partial' ? 'bg-warning text-warning' : 'bg-danger text-danger');
        
        // 左侧: 双币种 (最多2行)
        var leftHtml = '<div class="d-flex flex-column align-items-start gap-1">';
        // 主货币行
        var curBadge = order.cur_currency === 'USD' ? 
            '<span class="badge bg-success" style="font-size:9px; width:28px;">USD</span>' : 
            '<span class="badge bg-info" style="font-size:9px; width:28px;">' + order.cur_currency + '</span>';
        leftHtml += '<div class="d-flex align-items-center gap-1">' + curBadge + '<span style="font-size:11px;" class="amount-primary">' + formatNumber(depAmount) + '</span></div>';
        // 如果不是 USD，显示 USD 折算
        if (order.cur_currency !== 'USD' && order.cur_usd_rmb > 0) {
            var usdAmount = depAmount / order.cur_usd_rmb;
            leftHtml += '<div class="d-flex align-items-center gap-1"><span class="badge bg-success" style="font-size:9px; width:28px;">USD</span><span style="font-size:10px;" class="amount-secondary">' + formatNumber(usdAmount) + '</span></div>';
        }
        leftHtml += '</div>';
        
        // 右侧: 状态 TAG
        var rightHtml = '<span class="badge ' + depStatusClass + ' bg-opacity-25" style="font-size:9px;">' + depStatusText + '</span>';
        
        // 水平布局: 左侧金额 + 右侧状态
        depositDisplay = '<div class="d-flex align-items-center justify-content-center gap-2">' +
            leftHtml + rightHtml +
        '</div>';
    }

    // 物流单号标签
    var logisticsDisplay = '';
    if (order.logistics_list && order.logistics_list.length > 0) {
        order.logistics_list.forEach(function(log) {
            logisticsDisplay += '<span class="logistics-tag">' + log + '</span>';
        });
    } else {
        logisticsDisplay = '<span class="text-white-50">-</span>';
    }

    // 付款状态图标
    // 定金: 已付=绿勾, 部分=黄感叹号, 未付=红叉
    var depIcon = (order.deposit_status === 'paid' || order.deposit_status === 'override' || order.deposit_status === 'not_required') ? 
        '<i class="fas fa-check-circle text-success"></i>' : 
        (order.deposit_status === 'partial' ? '<i class="fas fa-exclamation-circle text-warning"></i>' : '<i class="fas fa-times-circle text-danger"></i>');
    
    // 货款: 已付完=绿勾, 部分=黄感叹号, 未付=红叉
    var pmtIcon = (order.balance_remaining_usd <= 0) ? 
        '<i class="fas fa-check-circle text-success"></i>' : 
        (order.pmt_paid_usd > 0 ? '<i class="fas fa-exclamation-circle text-warning"></i>' : '<i class="fas fa-times-circle text-danger"></i>');
    
    // 物流: 无物流=红叉+未付TAG, 在路上=黄车, 已到达=绿车 + 费用TAG
    var logIcon = '';
    if (order.logistics_status === 'none') {
        // 无发货: 红叉 + 未付TAG
        logIcon = '<span class="d-flex align-items-center gap-1">' +
            '<i class="fas fa-times-circle text-danger"></i>' +
            '<span class="badge bg-danger" style="font-size:8px;" data-i18n="ui.text_1234">未付</span>' +
        '</span>';
    } else {
        // 卡车颜色: 在路上=黄色, 已到达=绿色
        var truckColor = order.logistics_status === 'arrived' ? 'text-success' : 'text-warning';
        
        // 物流费用TAG
        var payTagClass = '';
        var payTagText = '';
        if (order.logistics_payment_status === 'paid') {
            payTagClass = 'bg-success';
            payTagText = (window.i18n?.t('js.paid') || 'Paid');
        } else if (order.logistics_payment_status === 'partial') {
            payTagClass = 'bg-warning';
            payTagText = (window.i18n?.t('js.partial') || 'Partial');
        } else {
            payTagClass = 'bg-danger';
            payTagText = (window.i18n?.t('js.unpaid') || 'Unpaid');
        }
        // 用 d-flex 包裹，让车和TAG在同一行
        logIcon = '<span class="d-flex align-items-center gap-1">' +
            '<i class="fas fa-truck ' + truckColor + '"></i>' +
            '<span class="badge ' + payTagClass + '" style="font-size:8px;">' + payTagText + '</span>' +
        '</span>';
    }
    
    var paymentStatusDisplay = '<div class="payment-status-icons">' +
        '<div class="status-item"><span class="label" data-i18n="ui.text_1235">定金</span>' + depIcon + '</div>' +
        '<div class="status-item"><span class="label" data-i18n="ui.text_1236">货款</span>' + pmtIcon + '</div>' +
        '<div class="status-item"><span class="label" data-i18n="ui.text_1237">物流</span>' + logIcon + '</div>' +
    '</div>';

    // 货币TAG
    var curTag = order.cur_currency === 'USD' ? 
        '<span class="badge bg-success ms-1" style="font-size:9px;">USD</span>' : 
        '<span class="badge bg-info ms-1" style="font-size:9px;">' + order.cur_currency + '</span>';

    // 浮动规则TAG (有设置时显示，触发绿色，未触发灰色)
    var floatTag = '';
    if (order.cur_ex_float > 0) {
        var floatText = (window.i18n?.t('js.floating') || 'Floating') + order.cur_ex_float + '%';
        if (order.fluctuation_triggered) {
            floatTag = '<span class="badge bg-success bg-opacity-25 text-success" style="font-size:9px;">' + floatText + '</span>';
        } else {
            floatTag = '<span class="badge bg-secondary bg-opacity-50" style="font-size:9px;">' + floatText + '</span>';
        }
    }

    // 订单总金额显示（金额+TAG水平排列）
    var totalAmountDisplay = '<div class="d-flex align-items-center justify-content-end gap-2">' +
        renderDualAmount(order.total_amount, order.cur_currency, order.cur_usd_rmb) +
        floatTag +
    '</div>';

    return '<tr class="main-row" data-idx="' + idx + '" style="cursor:pointer;">' +
        '<td class="cell-po-num">' + order.po_num + curTag + '</td>' +
        '<td class="text-white-50" style="font-size:11px;">' + order.po_date + '</td>' +
        '<td>' + totalAmountDisplay + '</td>' +
        '<td>' + depositDisplay + '</td>' +
        '<td>' + renderDualAmount(order.pmt_paid, order.cur_currency, order.cur_usd_rmb) + '</td>' +
        '<td class="cell-highlight-warning">' + renderDualAmount(order.balance_remaining, order.cur_currency, order.cur_usd_rmb, order.balance_remaining > 0 ? 'amount-pending' : 'amount-paid') + '</td>' +
        '<td>' + renderDualAmount(order.actual_paid, order.cur_currency, order.cur_usd_rmb, 'amount-paid') + '</td>' +
        '<td>' + renderDualAmount(order.total_extra, order.cur_currency, order.cur_usd_rmb) + '</td>' +
        '<td>' + logisticsDisplay + '</td>' +
        '<td>' + renderDualAmount(order.logistics_apportioned, order.logistics_currency, order.logistics_usd_rmb) + '</td>' +
        '<td class="cell-highlight">' + renderDualAmount(order.total_cost, order.cur_currency, order.cur_usd_rmb, 'amount-cost') + '</td>' +
        '<td>' + paymentStatusDisplay + '</td>' +
        '<td><button class="expand-btn" data-idx="' + idx + '"><i class="fas fa-chevron-down"></i></button></td>' +
    '</tr>';
}

function renderDetailRow(order, idx) {
    return '<tr class="detail-row" data-detail-idx="' + idx + '">' +
        '<td colspan="13">' +
            '<div class="detail-content" id="detail-content-' + idx + '">' +
                '<div class="text-center text-white-50 py-3">' +
                    '<i class="fas fa-spinner fa-spin me-2"></i>加载物流单详情...' +
                '</div>' +
            '</div>' +
        '</td>' +
    '</tr>';
}

function bindExpandEvents() {
    // 切换展开/收起的函数
    function toggleExpand(idx) {
        var detailRow = document.querySelector('tr[data-detail-idx="' + idx + '"]');
        var mainRow = document.querySelector('tr.main-row[data-idx="' + idx + '"]');
        var btn = mainRow.querySelector('.expand-btn');
        
        if (detailRow.classList.contains('show')) {
            detailRow.classList.remove('show');
            mainRow.classList.remove('expanded');
            btn.classList.remove('expanded');
        } else {
            detailRow.classList.add('show');
            mainRow.classList.add('expanded');
            btn.classList.add('expanded');
            loadDetailData(idx);
        }
    }
    
    // 按钮点击
    document.querySelectorAll('.expand-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleExpand(this.dataset.idx);
        });
    });
    
    // 整行点击
    document.querySelectorAll('.main-row').forEach(function(row) {
        row.addEventListener('click', function() {
            toggleExpand(this.dataset.idx);
        });
    });
}

function loadDetailData(idx) {
    var order = flowData[idx];
    var container = document.getElementById('detail-content-' + idx);
    
    if (container.dataset.loaded === 'true') {
        return;
    }

    fetch('/dashboard/finance/flow/api/detail/?po_num=' + encodeURIComponent(order.po_num))
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                container.innerHTML = '<div class="text-danger" data-i18n="ui.text_2490">加载失败: ' + data.message + '</div>';
                return;
            }

            container.innerHTML = renderDetailContent(data.data, data.meta, order);
            container.dataset.loaded = 'true';
        })
        .catch(error => {
            container.innerHTML = '<div class="text-danger" data-i18n="ui.text_2491">加载失败</div>';
        });
}

function renderDetailContent(details, meta, parentOrder) {
    if (!details || details.length === 0) {
        return '<div class="text-white-50 text-center py-3"><i class="fas fa-box-open me-2"></i>暂无物流单详情</div>';
    }

    var html = '';
    
    // 使用父表的订单总成本（确保一致性）
    var orderTotalUSD = parentOrder.total_cost_usd || 0;
    var orderTotalRMB = parentOrder.total_cost || (orderTotalUSD * (parentOrder.cur_usd_rmb || 7.0));
    
    // 显示订单总计标题
    html += '<div class="d-flex align-items-center justify-content-between mb-3 p-3" style="background:rgba(25,135,84,0.15); border-radius:8px; border:1px solid rgba(25,135,84,0.3);">' +
        '<div class="d-flex align-items-center">' +
            '<i class="fas fa-calculator text-success me-2"></i>' +
            '<span class="text-white fw-bold" data-i18n="ui.text_1238">订单总计</span>' +
            '<span class="text-white-50 ms-2" style="font-size:11px;" data-i18n="ui.text_1239">(' + details.length + '个物流块)</span>' +
        '</div>' +
        '<div class="d-flex align-items-center gap-3">' +
            '<div class="text-end">' +
                '<div class="text-success fw-bold" style="font-size:15px;">' +
                    '<span class="badge bg-success me-1" style="font-size:10px;">USD</span>$' + formatNumber(orderTotalUSD) +
                '</div>' +
                '<div class="text-white-50" style="font-size:12px;">' +
                    '<span class="badge bg-info me-1" style="font-size:9px;">RMB</span>¥' + formatNumber(orderTotalRMB) +
                '</div>' +
            '</div>' +
        '</div>' +
    '</div>';
    
    details.forEach(function(detail) {
        var isNotShipped = detail.logistic_num === 'NOT_SHIPPED';
        var isUSD = detail.currency === 'USD';
        var curSymbol = isUSD ? '$' : '¥';
        
        var paidBadge = detail.is_paid ? 
            '<span class="badge bg-success bg-opacity-25 text-success ms-2" data-i18n="ui.text_1240">已付</span>' : 
            '<span class="badge bg-danger bg-opacity-25 text-danger ms-2" data-i18n="ui.text_1241">待付</span>';

        // 标题区域
        var headerIcon = isNotShipped ? 
            '<i class="fas fa-box text-warning me-2"></i>' :
            '<i class="fas fa-truck text-info me-2"></i>';
        var headerText = isNotShipped ?
            '<span class="text-warning fw-bold" data-i18n="ui.text_1242">尚未发货</span>' :
            '<span class="text-info fw-bold">' + detail.logistic_num + '</span>' + paidBadge;
        var logFeeDisplay = isNotShipped ? '' :
            '<div class="text-white-50 small">' +
                '物流费: <span class="text-warning">¥' + formatNumber(detail.log_price_rmb) + '</span> / ' +
                '<span class="text-success">$' + formatNumber(detail.log_price_usd) + '</span>' +
            '</div>';

        // 计算物流单下的总价汇总
        var logTotalUSD = 0;
        detail.skus.forEach(function(sku) {
            logTotalUSD += sku.total_usd || 0;
        });
        var logTotalRMB = logTotalUSD * (detail.usd_rmb || 7.0);

        html += '<div class="detail-block mb-3">' +
            '<div class="detail-block-header d-flex align-items-center justify-content-between mb-3 pb-2" style="border-bottom:1px solid rgba(255,255,255,0.1);">' +
                '<div class="d-flex align-items-center">' +
                    headerIcon + headerText +
                '</div>' +
                logFeeDisplay +
            '</div>' +
            '<table class="table table-sm table-dark mb-0" style="font-size:12px;">' +
                '<colgroup>' +
                    '<col style="width:25%">' +   // SKU
                    '<col style="width:13%">' +   // 理论单价
                    '<col style="width:13%">' +   // 实际单价
                    '<col style="width:12%">' +   // 费用摊销
                    '<col style="width:13%">' +   // 入库单价
                    '<col style="width:8%">' +    // 数量
                    '<col style="width:16%">' +   // 总价
                '</colgroup>' +
                '<thead>' +
                    '<tr style="border-bottom:1px solid rgba(255,255,255,0.15);">' +
                        '<th class="text-white-50 py-2">SKU</th>' +
                        '<th class="text-white-50 text-end py-2" data-i18n="ui.text_2492">理论单价</th>' +
                        '<th class="text-white-50 text-end py-2" data-i18n="ui.text_2493">实际单价</th>' +
                        '<th class="text-white-50 text-end py-2" data-i18n="ui.text_2494">费用摊销</th>' +
                        '<th class="text-white-50 text-end py-2" data-i18n="ui.text_2495">入库单价</th>' +
                        '<th class="text-white-50 text-end py-2" data-i18n="common.quantity">数量</th>' +
                        '<th class="text-white-50 text-end py-2" data-i18n="ui.text_2219">总价</th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody>';
        
        detail.skus.forEach(function(sku) {
            // 理论单价 - 使用货币符号
            var priceDisplay = isUSD ? 
                '<span class="text-white">$' + formatPrice(sku.price_usd) + '</span>' :
                '<div>' +
                    '<div class="text-white">' + curSymbol + formatPrice(sku.price_original) + '</div>' +
                    '<div class="text-white-50" style="font-size:10px;">$' + formatPrice(sku.price_usd) + '</div>' +
                '</div>';
            
            // 实际单价
            var actualDisplay = isUSD ?
                '<span class="text-white">$' + formatPrice(sku.actual_price_usd) + '</span>' :
                '<div>' +
                    '<div class="text-white">' + curSymbol + formatPrice(sku.actual_price) + '</div>' +
                    '<div class="text-white-50" style="font-size:10px;">$' + formatPrice(sku.actual_price_usd) + '</div>' +
                '</div>';
            
            // 费用摊销
            var feeDisplay = isUSD ?
                '<span class="text-warning">$' + formatPrice(sku.fee_apportioned_usd) + '</span>' :
                '<div>' +
                    '<div class="text-warning">' + curSymbol + formatPrice(sku.fee_apportioned) + '</div>' +
                    '<div class="text-white-50" style="font-size:10px;">$' + formatPrice(sku.fee_apportioned_usd) + '</div>' +
                '</div>';
            
            // 入库单价
            var landedDisplay = isUSD ?
                '<span class="text-info fw-bold">$' + formatPrice(sku.landed_price_usd) + '</span>' :
                '<div>' +
                    '<div class="text-info fw-bold">' + curSymbol + formatPrice(sku.landed_price) + '</div>' +
                    '<div class="text-white-50" style="font-size:10px;">$' + formatPrice(sku.landed_price_usd) + '</div>' +
                '</div>';
            
            html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">' +
                '<td class="text-white py-2">' + sku.sku + '</td>' +
                '<td class="text-end py-2">' + priceDisplay + '</td>' +
                '<td class="text-end py-2">' + actualDisplay + '</td>' +
                '<td class="text-end py-2">' + feeDisplay + '</td>' +
                '<td class="text-end py-2">' + landedDisplay + '</td>' +
                '<td class="text-end text-white py-2">' + sku.qty + '</td>' +
                '<td class="text-end text-success fw-bold py-2">$' + formatNumber(sku.total_usd) + '</td>' +
            '</tr>';
        });
        
        // 物流单汇总行
        html += '</tbody>' +
            '<tfoot>' +
                '<tr style="border-top:2px solid rgba(255,255,255,0.2);">' +
                    '<td colspan="6" class="text-end text-white-50 py-2 pe-3" style="font-size:12px;" data-i18n="ui.text_2498">物流单合计</td>' +
                    '<td class="text-end py-2">' +
                        '<div class="d-flex flex-column align-items-end">' +
                            '<span class="text-success fw-bold" style="font-size:13px;">' +
                                '<span class="badge bg-success me-1" style="font-size:9px;">USD</span>$' + formatNumber(logTotalUSD) +
                            '</span>' +
                            '<span class="text-white-50" style="font-size:11px;">' +
                                '<span class="badge bg-info me-1" style="font-size:8px;">RMB</span>¥' + formatNumber(logTotalRMB) +
                            '</span>' +
                        '</div>' +
                    '</td>' +
                '</tr>' +
            '</tfoot>' +
        '</table></div>';
    });
    
    return html;
}

function formatPrice(num) {
    if (num === null || num === undefined) return '-';
    // 保留5位小数，但去除尾部的0
    var str = parseFloat(num).toFixed(5);
    return str.replace(/\.?0+$/, '');
}

function formatNumber(num) {
    if (num === null || num === undefined) return '-';
    return parseFloat(num).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function showToast(message, type) {
    if (typeof createAndShowToast === 'function') {
        createAndShowToast(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}