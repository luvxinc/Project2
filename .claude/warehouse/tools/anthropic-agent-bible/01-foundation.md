---
name: foundation
sources:
  - "#1 Building Effective Agents — 2024-12-19"
  - "#2 Building Agents with the Claude Agent SDK — 2025-09-29"
---

# L1 基础架构 — Agent 设计模式与 SDK

---

## 核心区分: Workflows vs Agents

| 类型 | 定义 | 适用场景 |
|------|------|---------|
| **Workflows** | LLM 和工具通过预定义代码路径编排 | 任务分解固定, 追求可预测性 |
| **Agents** | LLM 动态指导自己的流程和工具使用 | 开放式问题, 步骤数不可预测 |

**决策原则**: 从最简方案开始, 复杂度只在可度量改善时增加。很多场景下, 优化单次 LLM 调用 + 检索 + Few-shot 就够了。

---

## 5 种 Workflow 模式

### 1. Prompt Chaining (提示链)
任务分解为顺序步骤, 每步 LLM 调用处理前一步输出, 中间有程序化门控检查。
- 用例: 先写营销文案 → 翻译; 先写大纲 → 检查 → 写文档

### 2. Routing (路由)
输入分类 → 导向专门的后续任务。实现关注点分离。
- 用例: 客服查询分流 (一般/退款/技术); 简单→便宜模型, 复杂→强模型

### 3. Parallelization (并行化)
两种变体: **Sectioning** (独立子任务并行) + **Voting** (同任务多次运行取多数)。
- 关键: 复杂任务每个关注点由单独 LLM 调用处理, 效果更好。

### 4. Orchestrator-Workers (编排-执行)
中央 LLM 动态分解任务, 委派给 Worker LLM, 综合结果。
- 与并行化区别: 子任务不是预定义的, 而是根据输入动态确定。
- 用例: 多文件代码修改; 多源信息搜索。

### 5. Evaluator-Optimizer (评估-优化)
一个 LLM 生成, 另一个评估并反馈, 循环迭代。
- 前提: 评估标准清晰 + 迭代改进可度量。

---

## Agent 核心循环

```
Agent = LLM + 工具 + 环境反馈, 在循环中运行
收集上下文 → 行动 → 验证 → 重复
```

**关键**: Agent 必须在每一步从环境获取"地面真相"(工具返回值/代码执行结果)来评估进展。

---

## ACI (Agent-Computer Interface) 设计

> "投入多少精力设计 HCI, 就该投入同样多精力设计 ACI。"

| 原则 | 做法 |
|------|------|
| **换位思考** | 站在模型角度 — 仅凭描述和参数, 使用方式是否显而易见? |
| **示例优先** | 包含用法示例, 边界情况, 输入格式要求 |
| **防错设计 (Poka-yoke)** | 让参数设计难以犯错 (如: 绝对路径 > 相对路径) |
| **测试驱动** | 在 Workbench 大量测试模型如何使用你的工具 |
| **格式友好** | 避免需要计数/转义的格式; 保持接近模型训练数据中的自然格式 |

**SWE-bench 经验**: "工具优化时间 > 整体 prompt 优化时间"。将相对路径改为绝对路径后, 模型使用零错误。

---

## Agent SDK 架构

### 四步循环
1. **Context Gathering** — 搜索 + 文件系统 + 子代理 + Compaction
2. **Action Execution** — 工具 + Bash + 代码生成 + MCP
3. **Work Verification** — 规则反馈 + 视觉反馈 + LLM-as-Judge
4. **Repeat** — 直到任务完成或需要升级

### 验证三层
| 层级 | 方式 | 示例 |
|------|------|------|
| 规则反馈 | Lint, 约束检查 | 邮件格式验证 |
| 视觉反馈 | 截图, 渲染 | UI 布局检查 |
| LLM-as-Judge | 二次模型评估 | 语气/质量判断 |

### 代码作为输出
代码是精确、可组合、可复用的输出方式 — 优于让 LLM 直接产出复杂结构化数据。

---

## 反模式清单

| 反模式 | 问题 | 正确做法 |
|--------|------|---------|
| 过度工程 | 不必要的复杂度 | 最简方案开始 |
| 框架过度依赖 | 抽象层遮蔽 prompt, 难调试 | 先用 API 直接调用 |
| 不测试工具 | 模型系统性误用 | Workbench 大量测试 |
| 相对路径 | Agent 移动目录后出错 | 强制绝对路径 |
| 复杂格式 | 需要计数/转义 | 自然格式, 减少开销 |

---

*与我们框架的对应:*
- Prompt Chaining → build.md Express Path
- Routing → /start 分诊路由
- Orchestrator-Workers → /team 蜂群模式
- Evaluator-Optimizer → CTO Review + QA Audit 双环
- ACI 设计 → rules/ 层工具描述规范
