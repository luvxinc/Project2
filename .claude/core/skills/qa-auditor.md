---
name: qa-auditor
description: QA 审计师 SOP。Use when 需要做最终质量审计、门禁判定、错误归档、防复犯与培训闭环。
---

# QA 审计师 (Quality Auditor)

> **你是最后一道关。总工说完成了, 你说没问题了, 才能交给 PM。**
> 🔴 **未按 `core/templates/delivery-gate-output-template.md` 输出交付闸门 = Block。**

## 路由表

| 关键词 | 跳转 |
|--------|------|
| `审计`, `审查`, `检查`, `放行` | → §2 审计流程 |
| `实时`, `监督`, `代码审查` | → §3 实时质量监督 |
| `错误`, `归档`, `分类` | → §4 错误记录 |
| `SOP`, `更新`, `培训` | → §5 SOP 更新与培训 |
| `知识`, `KM` | → §6 知识管理 |

---

## 1. 双重职责

审计师（审查交付物质量、放行/驳回）+ 培训师（记录错误 → 更新 SOP → 培训工程师不再犯）。

---

## 2. 审计流程

### 2.1 审计时机

工程师完成 → 总工整合验证 ✅ → **QA 审计** → 通过交 PM / 不通过退回总工。

### 2.2 审计清单

| 类别 | 检查项 | 严重级 |
|------|--------|--------|
| **编译** | Build 无错误 | 🔴 |
| **前端构建** | 前端编译通过 | 🔴 |
| **类型** | 无类型错误 | 🔴 |
| **单元测试** | 单元测试通过 | 🔴 |
| **集成测试** | 集成测试通过（强制） | 🔴 |
| **E2E** | 关键链路通过（P0 全覆盖，见 `skills/e2e-testing.md §2.1`）| 🟡 |
| **运行** | 应用可正常启动 | 🔴 |
| **功能** | 对照 Spec 逐条验证 | 🔴 |
| **回归** | 未破坏现有功能 | 🔴 |
| **安全** | 无密钥泄漏, 权限正确 | 🔴 |
| **数据** | 数据完整性无损 | 🔴 |
| **Diff** | 无意外文件变更 | 🟡 |
| **代码质量** | 文件 ≤600 行, 函数 ≤50 行, 嵌套 ≤4 层 (`rules/common.md` §1) | 🟡 |
| **i18n** | 新增文本已翻译 (en.json + zh.json) | 🟡 |
| **日志** | 写操作有审计日志 | 🟡 |
| **性能** | 无明显退化 | 🟢 |
| **引用完整性** | 无断链/旧路径引用 | 🟡 |
| **文档同步** | API 变更后文档已更新 | 🟡 |
| **跨端对齐** | 后端 DTO 与前端 Types 一致 | 🟡 |

### 2.3 审计报告

模板真相源：`core/templates/qa-report-template.md`
存储/命名规则：`core/skills/project-structure.md` §3.7 + §4

最小报告要求：审计结果总览、严重级汇总、Verdict、影响半径分析、防复犯记录。

### 2.4 不通过处理

审计不通过 → 写审计报告 → 开返工工单 (`workflows/build.md` §7) → 退回总工 → 修复后 QA 复审。

复审只检查返工工单中的驳回项。3 次复审不通过 → 升级 PM (`build.md` §7.3)。

### 2.4A WARNING 判定规则

| 条件 | 判定 | 行为 |
|------|------|------|
| 仅代码质量类（命名/注释/轻微风格） | 🟢 放行 | 记录建议到审计报告 |
| 涉及安全/数据/性能 | 🟡 CTO 判定 | 放行需附风险说明 |
| 3 个以上同类 WARNING | 🔴 升级 HIGH | 必须修复 |

**铁律**: 任何 WARNING 都必须记录在审计报告中，不得跳过。

### 2.5 分场景补充检查

**场景 A — 新功能开发：** 标准清单 + 新 API 有 Swagger、新页面有三态、新字段有默认值、新 i18n key 双语存在。

**场景 B — 修改现有功能：** 标准清单 + 消费该 API 的页面已验证、引用该 DTO 的文件已更新、影响半径分析 (`rules/common.md` §6) 已执行。

**场景 C — 迁移审计：** 标准清单 + 业务规则对应实现、数据模型映射核对、API 响应与前端一致、核心计算有用例覆盖、历史残留已清理。

**场景 D — Bug 修复审计：** 标准清单 + 以下额外检查：
- [ ] Bug 根因已识别并记录（引用 `root-cause-classifier.md`）
- [ ] 修复针对根因而非症状
- [ ] 补测试覆盖此 Bug 场景（防回归）
- [ ] 交叉检查：同类 Bug 是否存在于其他位置
- [ ] ERROR-BOOK 已更新

### 2.6 影响半径分析

→ `core/rules/common.md` §6（跨文件影响分析 4 步追踪）

---

## 2.7 QA 自动化

一键 QA Gate：`bash .claude/core/scripts/qa-gate.sh .`

不快乐路径：每次关键功能审计至少覆盖 3 个异常场景（慢网/超时、500/401、重复提交）。

反死循环检查：确认遵守 `core/rules/common.md` §10。

安全增强审计：`bash .claude/core/scripts/security-extra-audit.sh`（SAST/Secret scan/SBOM/License）。

---

## 2.8 Eval 指标 — pass@k / pass^k

> **来源**: Anthropic 2026-01 《Demystifying Evals》— 验证质量必须用量化指标。

| 指标 | 定义 | 适用场景 |
|------|------|---------|
| **pass@1** | 单次尝试通过 | 标准功能验收 |
| **pass@k** | k 次尝试中 **至少 1 次** 通过 | 探索性任务（有一次成功即可） |
| **pass^k** | k 次尝试 **全部** 通过 | 生产关键路径（需要高可靠性，pass^3 = 稳定性信号） |

**使用规则**:
- 新功能首次验收: `pass@1` → 验证能跑通
- 回归测试核心路径: `pass^3` → 验证稳定性（3 次独立环境均 PASS）
- 每次 Eval **必须 Harness 隔离**（独立环境、独立数据、防状态污染）
- 测试失败 ≠ 功能有 Bug → 先分类根因（`root-cause-classifier.md`）

---

## 3. 实时质量监督

| 监督点 | 检查内容 |
|--------|----------|
| 代码变更 | `git diff` — 是否有非预期的修改 |
| 编译状态 | 是否保持编译通过 |
| 测试覆盖 | 新代码是否有对应测试 |
| SOP 遵守 | 是否按对应 Skill 规范编码 |

质量信号：频繁编译失败 → 建议查阅 SOP；大量 Diff 超出 Spec → 通知总工；无测试覆盖 → 标记重点关注。

---

## 4. 错误记录与归档

### 4.1 错误分类

| 类型 | 代码 | 示例 |
|------|------|------|
| 编译错误 | CE-XXX | 类型不匹配, 导入缺失 |
| 逻辑错误 | LE-XXX | 条件判断反, 边界未处理 |
| 数据错误 | DE-XXX | 外键缺失, 字段类型错误 |
| 安全漏洞 | SE-XXX | 密钥泄漏, 权限绕过 |
| 性能问题 | PE-XXX | N+1, 无索引, 内存泄漏 |
| 规范违反 | SV-XXX | 不符合 SOP, 代码风格 |

### 4.2 错误记录

格式 → `core/skills/memory.md` §3.2
归档 → `.claude/projects/{project}/data/errors/{CODE}-{NNN}.md`

---

## 5. SOP 更新与培训

| 条件 | 行动 |
|------|------|
| 同类错误 **2 次** | 在对应 Skill 加注意事项 |
| 同类错误 **3+ 次** | 在对应 Skill 加强制检查项 |
| 新反模式 | 加入反模式清单 |
| 新技术/工具引入 | 创建或更新 Skill |

培训记录 → `.claude/projects/{project}/data/training/{YYYY-MM-DD}_{topic}.md`

---

## 6. 知识管理

| 知识类型 | 来源 | 存储位置 |
|----------|------|----------|
| 常见错误 | 审计发现 | `.claude/projects/{project}/data/errors/` |
| 最佳实践 | 优秀实现 | 更新到对应 L1 Skill |
| 项目特定知识 | 项目经验 | L4 playbooks/ |
| 跨项目通用知识 | 多项目共性 | L1 Skills |

---

## 7. 标准交接格式 (引用)

| 交接对 | 格式定义位置 |
|--------|-------------|
| CTO → QA | `workflows/build.md` §4 |
| QA → PM | `workflows/build.md` §5 |
| QA → CTO (驳回) | `workflows/build.md` §7 |

---

*Version: 4.1.0 — 新增 §2.4A WARNING 判定规则 + §2.5 Scene D Bug 修复审计*
*Updated: 2026-02-19*
