# é”€å”®æ¿å— - æŠ¥è¡¨ç”Ÿæˆå™¨ è§£æé€»è¾‘

> æ–‡æ¡£ç‰ˆæœ¬: V1.0  
> æœ€åæ›´æ–°: 2026-01-12  
> å¯¹åº”ä»£ç : `backend/apps/reports/views.py`, `backend/core/services/finance/`, `backend/core/services/`

---

## ä¸€ã€æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é”€å”®æ¿å— (Sales Module)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  äº¤æ˜“æ•°æ®ä¸Šä¼     â”‚  â”‚   æŠ¥è¡¨ç”Ÿæˆå™¨     â”‚  â”‚    æŠ¥è¡¨ä¸­å¿ƒ      â”‚           â”‚
â”‚  â”‚  (ETL Wizard)    â”‚  â”‚ (Report Builder) â”‚  â”‚ (Report Center)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                â”‚                      â–²                     â”‚
â”‚                                â–¼                      â”‚                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                    â”‚        9 ä¸ªåˆ†æå™¨ (Analyzer Pipeline)      â”‚             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.1 å…¥å£å±‚çº§

| å±‚çº§ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **URL è·¯ç”±** | `backend/apps/sales/urls.py` | é”€å”®æ¿å—æ€»è·¯ç”±ï¼ŒæŒ‚è½½ `reports` å­åº”ç”¨ |
| **é¡µé¢æ¸²æŸ“** | `backend/apps/sales/views.py` | Hub é¡µé¢ä¸å­é¡µé¢å…¥å£ |
| **ä¸šåŠ¡é€»è¾‘** | `backend/apps/reports/views.py` | æŠ¥è¡¨ç”Ÿæˆä¸ç®¡ç†æ ¸å¿ƒè§†å›¾ |
| **æ¨¡æ¿å±‚** | `backend/templates/sales/pages/report_builder.html` | å‰ç«¯ UI |

### 1.2 æœåŠ¡å±‚ä¾èµ–

```python
# æ ¸å¿ƒæœåŠ¡å¯¼å…¥ (backend/apps/reports/views.py L22-31)
from core.services.report_manager import ReportFileManager
from core.services.finance.sales import SalesQtyAnalyzer
from core.services.finance.profit_sku import SkuProfitAnalyzer
from core.services.finance.profit_listing import ListingProfitAnalyzer
from core.services.finance.profit_combo import ComboProfitAnalyzer
from core.services.crm import CustomerAnalyzer
from core.services.logistics import ShippingAnalyzer
from core.services.inventory_snapshot import InventorySnapshot
from core.services.prediction import PredictionService
from core.services.ordering import OrderingService
```

---

## äºŒã€å…¥å£è§†å›¾é€»è¾‘

### 2.1 `start_generation(request)` - æŠ¥è¡¨ç”Ÿæˆä¸»å…¥å£

**æ–‡ä»¶**: `backend/apps/reports/views.py` L192-305

**è°ƒç”¨é“¾è·¯**:
```
HTMX POST /dashboard/sales/reports/generator/start/
    â†“
start_generation(request)
    â†“
SecurityPolicyManager.verify_action_request(request, 'btn_generate_report')
    â†“
è§£ææ—¥æœŸå‚æ•° (start_date, end_date)
    â†“
ReportFileManager().clear_all_reports()  # æ¸…ç©ºæ—§æŠ¥è¡¨
    â†“
for (name, AnalyzerClass) in 9ä¸ªåˆ†æå™¨:
    AnalyzerClass(start_date, end_date, suffix).run()
    â†“
è¿”å›ç”Ÿæˆç»“æœ (æˆåŠŸ/å¤±è´¥æ•°é‡)
```

**æ ¸å¿ƒä»£ç é€»è¾‘**:

```python
# [ä»»åŠ¡åˆ—è¡¨] 9ä¸ªåˆ†æå™¨ (L240-250)
analyzers = [
    ("ğŸ“¦ SKU é”€é‡ç»Ÿè®¡", SalesQtyAnalyzer),
    ("ğŸ’° SKU åˆ©æ¶¦ä¸è¯Šæ–­", SkuProfitAnalyzer),
    ("ğŸ”— Listing è¡¨ç°åˆ†æ", ListingProfitAnalyzer),
    ("ğŸ Combo ç­–ç•¥åˆ†æ", ComboProfitAnalyzer),
    ("ğŸ‘¥ å®¢æˆ·ç”»åƒä¸é£é™©", CustomerAnalyzer),
    ("ğŸšš ç‰©æµæ•ˆç›Šè¯Šæ–­", ShippingAnalyzer),
    ("ğŸ¦ åº“å­˜èµ„äº§å¿«ç…§", InventorySnapshot),
    ("ğŸ¤– AI é”€é‡é¢„æµ‹", PredictionService),
    ("ğŸ›’ æ™ºèƒ½è¡¥è´§è®¡ç®—", OrderingService),
]

# æ‰§è¡Œé¡ºåº: ä¾æ¬¡åŒæ­¥æ‰§è¡Œ (L256-262)
for name, AnalyzerClass in analyzers:
    try:
        analyzer = AnalyzerClass(start_date, end_date, suffix)
        analyzer.run()
        success_count += 1
    except Exception as e:
        errors.append(f"{name}: {str(e)}")
```

---

## ä¸‰ã€åˆ†æå™¨åŸºç±»æ¶æ„

### 3.1 ç»§æ‰¿å±‚æ¬¡

```
DataProcessingService
        â†“
ProfitAnalyzerBase  (backend/core/services/finance/base.py)
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SalesQtyAnalyzer    â”‚ SkuProfitAnalyzer   â”‚ ListingProfitAnalyzer â”‚
â”‚ ComboProfitAnalyzer â”‚ CustomerAnalyzer    â”‚ ShippingAnalyzer      â”‚
â”‚ InventorySnapshot   â”‚ PredictionService   â”‚ OrderingService       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 `ProfitAnalyzerBase` æ ¸å¿ƒèƒ½åŠ›

**æ–‡ä»¶**: `backend/core/services/finance/base.py`

#### åˆå§‹åŒ–å‚æ•°
```python
def __init__(self, start_date: date, end_date: date, file_suffix: str = ""):
    self.start_date = start_date      # åˆ†æèµ·å§‹æ—¥æœŸ
    self.end_date = end_date          # åˆ†æç»“æŸæ—¥æœŸ
    self.etl_repo = ETLRepository()   # äº¤æ˜“æ•°æ®ä»“åº“
    self.inv_repo = InventoryRepository()  # åº“å­˜æ•°æ®ä»“åº“
    self.sku_cost_map = {}            # SKU â†’ æˆæœ¬æ˜ å°„
    self.df_cur = pd.DataFrame()      # æœ¬æœŸæ•°æ®
    self.df_prev = pd.DataFrame()     # ä¸ŠæœŸæ•°æ® (ç”¨äºç¯æ¯”)
```

#### è´¹ç”¨åˆ—å®šä¹‰ (L29-43)
```python
FEE_COLUMNS = [
    "Shipping and handling", "Refund Shipping and handling",
    "Seller collected tax", "eBay collected tax",
    "Refund Seller collected tax", "Refund eBay collected tax",
    "Final Value Fee - fixed", "Final Value Fee - variable",
    "Regulatory operating fee", "International fee",
    "Charity donation", "Deposit processing fee",
    "Refund Final Value Fee - fixed", "Refund Final Value Fee - variable",
    "Refund Regulatory operating fee", "Refund International fee",
    "Refund Charity donation", "Refund Deposit processing fee",
    'Very high "item not as described" fee', 
    'Refund Very high "item not as described" fee',
    "Below standard performance fee", "Refund Below standard performance fee",
    "Payments dispute fee", "Promoted Listings fee", "Refund Promoted Listings fee",
    "Shipping label-Earning data", "Shipping label-Return"
]
```

#### `_load_basics()` - æ•°æ®åŠ è½½ (L92-112)
```python
def _load_basics(self):
    # 1. åŠ è½½ SKU æˆæœ¬è¡¨
    df_cogs = self.inv_repo.get_all_cogs()
    self.sku_cost_map = {SKU.upper(): Cog for SKU, Cog in df_cogs}
    
    # 2. åŠ è½½æœ¬æœŸæ•°æ®
    self.df_cur = self._clean_data(
        self.etl_repo.get_transactions_by_date(self.start_date, self.end_date)
    )
    
    # 3. åŠ è½½ä¸ŠæœŸæ•°æ® (è‡ªåŠ¨è®¡ç®—ç­‰é•¿æ—¶é—´çª—å£)
    delta = end_date - start_date
    prev_end = start_date - 1day
    prev_start = prev_end - delta
    self.df_prev = self._clean_data(
        self.etl_repo.get_transactions_by_date(prev_start, prev_end)
    )
```

#### `_calculate_net_profit()` - å‡€åˆ©æ¶¦è®¡ç®— (L120-155)
```python
def _calculate_net_profit(self, metrics: dict) -> dict:
    R = settings.LOSS_RATES  # {'RETURN': 0.3, 'REQUEST': 0.5, 'CASE': 0.6, 'DISPUTE': 1.0}
    
    for k, m in metrics.items():
        # å‡€é”€é‡ = æ€»é”€é‡ - å–æ¶ˆ - é€€è´§Ã—è€—æŸç‡
        m["net_qty"] = (
            m["total_qty"]
            - m.get("cancel_qty", 0)
            - m.get("return_qty", 0) * R['RETURN']
            - m.get("request_qty", 0) * R['REQUEST']
            - m.get("claim_qty", 0) * R['CASE']
            - m.get("dispute_qty", 0) * R['DISPUTE']
        )
        
        # å‡€æ”¶å…¥ = æ€»æ”¶å…¥ + å„ç±»é€€æ¬¾ (é€€æ¬¾ä¸ºè´Ÿå€¼)
        m["net_rev"] = (
            m["total_rev"] + m.get("cancel_rev", 0) + m.get("return_rev", 0) +
            m.get("request_rev", 0) + m.get("claim_rev", 0) + m.get("dispute_rev", 0)
        )
        
        # è®¡ç®—å„é¡¹è´¹ç”¨å‡€å€¼
        m["net_shipping"] = m.get("Shipping and handling", 0) + m.get("Refund Shipping and handling", 0)
        m["net_platform_fee"] = sum(v for field, v in m.items() if field in PLATFORM_FEE_GROUP)
        m["net_ad_fee"] = m.get("Promoted Listings fee", 0) + m.get("Refund Promoted Listings fee", 0)
        # ...å…¶ä»–è´¹ç”¨
        
        # æœ€ç»ˆåˆ©æ¶¦
        m["profit"] = (
            m["net_rev"] + m["cog_value"] + m["net_shipping"] +
            m["net_platform_fee"] + m["net_high_return_fee"] + m["net_low_rating_fee"] +
            m["net_third_party_fee"] + m["net_ad_fee"] + m["net_postage_cost"] + m["net_return_postage"]
        )
```

---

## å››ã€9 å¤§åˆ†æå™¨è¯¦è§£

### 4.1 SalesQtyAnalyzer - SKU é”€é‡ç»Ÿè®¡

**æ–‡ä»¶**: `backend/core/services/finance/sales.py`

**è¾“å‡ºæ–‡ä»¶**: `SKU_Sold_{suffix}.csv`

**æ ¸å¿ƒé€»è¾‘**:
```python
def _process_row(self, row, stats_dict):
    raw_seller = row.get("seller")      # åº—é“ºå½’å±: esparts88 / espartsplus
    action = row.get("action").upper()  # è®¢å•åŠ¨ä½œ: SA/CA/RE/CR/CC/PD
    quantity_val = int(row.get("quantity", 0))
    
    # è§£æ SKU åˆ—è¡¨ (Clean Log çš„ sku1..qty1 ç»“æ„)
    for i in range(1, 11):
        sku_val = row.get(f"sku{i}")
        q = int(row.get(f"qty{i}", 0))
        if sku_val: sku_list.append((sku_val.upper(), q))
    
    # ç‰¹æ®Š SKU è§„åˆ™: æŸäº› SKU ä¼šé™„èµ  NU1C8SKT7
    if any(sku in ["NU1C8E51C", "NU1C8E51K"] for sku, _ in sku_list):
        sku_list.append(("NU1C8SKT7", 2))
    
    # æŒ‰åº—é“ºåˆ†ç»„ç»Ÿè®¡
    for prefix in ["88", "plus", "total"]:
        for sku, qtyp in sku_list:
            total_qty = quantity_val * qtyp
            stats_dict[sku][f"{prefix}_Sold"] += total_qty
            
            # æ ¹æ® action ç´¯åŠ å¯¹åº”æŒ‡æ ‡
            action_map = {
                "CA": "Canceled", "RE": "Returned", 
                "CC": "Cased", "CR": "Request", "PD": "Dispute"
            }
            if action in action_map:
                stats_dict[sku][f"{prefix}_{action_map[action]}"] += total_qty
```

**è¾“å‡ºè¡¨ç»“æ„**:
| åˆ—å | è¯´æ˜ |
|------|------|
| SKU | SKU ç¼–ç  |
| 88_Sold / plus_Sold / total_Sold | å„åº—é“ºé”€é‡ |
| 88_Canceled / plus_Canceled / total_Canceled | å–æ¶ˆæ•°é‡ |
| 88_Returned / plus_Returned / total_Returned | é€€è´§æ•°é‡ |
| 88_Cased / plus_Cased / total_Cased | å®¢æˆ·æŠ•è¯‰ (å¹³å°å¼ºåˆ¶é€€æ¬¾) |
| 88_Request / plus_Request / total_Request | å®¢æˆ·ç”³è¯·é€€è´§ (å¹³å°ä»‹å…¥) |
| 88_Dispute / plus_Dispute / total_Dispute | é“¶è¡ŒæŠ•è¯‰ |
| 88_Net / plus_Net / total_Net | å‡€é”€é‡ (æ‰£é™¤è€—æŸ) |

---

### 4.2 SkuProfitAnalyzer - SKU åˆ©æ¶¦è¯Šæ–­

**æ–‡ä»¶**: `backend/core/services/finance/profit_sku.py`

**è¾“å‡ºæ–‡ä»¶**: `Profit_Analysis_SKU_{suffix}.csv`

**æ ¸å¿ƒé€»è¾‘ - æˆæœ¬åˆ†æ‘Š**:
```python
def _aggregate(self, df: pd.DataFrame) -> dict:
    for row in records:
        qty_sets = int(row.get("quantity", 0))
        action = row.get("action").upper()
        revenue = float(row.get("revenue", 0))
        refund = float(row.get("Refund", 0))
        
        # 1. è§£æå½“å‰è¡Œæ‰€æœ‰ SKU åŠå…¶è´§å€¼
        current_sku_units = {}  # {SKU: æ•°é‡}
        current_sku_value = {}  # {SKU: è´§å€¼}
        order_total_cost_val = 0.0
        
        for i in range(1, 11):
            sku = row.get(f"sku{i}").upper()
            per_qty = float(row.get(f"qty{i}", 0))
            units = per_qty * qty_sets
            unit_cost = self.sku_cost_map.get(sku, 0.0)
            val = units * unit_cost  # è´§å€¼ = æ•°é‡ Ã— æˆæœ¬
            
            current_sku_units[sku] = units
            current_sku_value[sku] = val
            order_total_cost_val += val
        
        # 2. æŒ‰è´§å€¼æƒé‡åˆ†æ‘Šæ”¶å…¥å’Œè´¹ç”¨
        for sku, units in current_sku_units.items():
            weight = current_sku_value[sku] / order_total_cost_val  # åˆ†æ‘Šæƒé‡
            
            metrics[sku]["total_qty"] += units
            metrics[sku]["total_rev"] += revenue * weight
            
            if action == "CA":
                metrics[sku]["cancel_qty"] += units
                metrics[sku]["cancel_rev"] += refund * weight
            # ... å…¶ä»– action ç±»ä¼¼å¤„ç†
            
            # æˆæœ¬ç›´æ¥è®¡ç®— (ä¸åˆ†æ‘Š)
            metrics[sku]["cog_value"] += -(unit_cost * units)
            
            # è´¹ç”¨æŒ‰æƒé‡åˆ†æ‘Š
            self._accumulate_fees(row, metrics, sku, weight=weight)
```

**è¾“å‡ºè¡¨ç»“æ„**:
- **A1_æ•°é‡è¡¨**: SKU, æ€»é”€é‡, å–æ¶ˆæ•°, é€€è´§æ•°(æ— å¹³å°ä»‹å…¥), é€€è´§æ•°(å¹³å°ä»‹å…¥), é€€è´§æ•°(å¹³å°å¼ºåˆ¶), å¼ºåˆ¶é€€è´§(ä»…é€€æ¬¾), å‡€é”€å”®
- **A2_æ•°é‡å æ¯”è¡¨**: å„æŒ‡æ ‡å æ€»é”€é‡çš„ç™¾åˆ†æ¯”
- **A3_æ•°é‡ç»“æ„ç¯æ¯”è¡¨**: ä¸ä¸ŠæœŸç›¸æ¯”çš„å˜åŒ–ç‡
- **B1_é‡‘é¢è¡¨**: SKU, æ€»é”€å”®é¢, å„ç±»é€€æ¬¾é¢, æˆæœ¬, å„ç±»è´¹ç”¨, ç›ˆäº
- **B2_é‡‘é¢å æ¯”è¡¨**: å„æŒ‡æ ‡å æ€»é”€å”®é¢çš„ç™¾åˆ†æ¯”
- **B3_è´¹ç”¨ç»“æ„ç¯æ¯”è¡¨**: ä¸ä¸ŠæœŸç›¸æ¯”çš„å˜åŒ–ç‡
- **C1_æ™ºèƒ½è¯Šæ–­è¡¨**: AI è¯Šæ–­æ ‡ç­¾ (ç”± SkuDiagnostician ç”Ÿæˆ)

---

### 4.3 ListingProfitAnalyzer - Listing è¡¨ç°åˆ†æ

**æ–‡ä»¶**: `backend/core/services/finance/profit_listing.py`

**è¾“å‡ºæ–‡ä»¶**: `Profit_Analysis_Listing_{suffix}.csv`

**èšåˆç»´åº¦**: Item ID (eBay Listing ç¼–å·)

**æ ¸å¿ƒå·®å¼‚**:
- æŒ‰ `item id` è€Œé SKU èšåˆ
- æ— éœ€åˆ†æ‘Š (1 ä¸ª Listing å¯¹åº”å®Œæ•´è®¢å•)
- è®°å½• `item title` ä½œä¸ºé™„åŠ ä¿¡æ¯

---

### 4.4 ComboProfitAnalyzer - Combo ç­–ç•¥åˆ†æ

**æ–‡ä»¶**: `backend/core/services/finance/profit_combo.py`

**è¾“å‡ºæ–‡ä»¶**: `Profit_Analysis_Combo_{suffix}.csv`

**èšåˆç»´åº¦**: Full SKU (å®Œæ•´ SKU ç»„åˆå­—ç¬¦ä¸²)

**ç”¨é€”**: è¯„ä¼°æ‰“åŒ…é”€å”®ç­–ç•¥çš„åˆ©æ¶¦è¡¨ç°ï¼Œè¯†åˆ«é«˜åˆ©æ¶¦/ä½åˆ©æ¶¦ç»„åˆã€‚

---

### 4.5 CustomerAnalyzer - å®¢æˆ·ç”»åƒä¸é£é™©

**æ–‡ä»¶**: `backend/core/services/crm.py`

**è¾“å‡ºæ–‡ä»¶**: `Analysis_Customer_RFM_{suffix}.csv`

**æ•°æ®èŒƒå›´**: è¿‡å» 365 å¤© (è€Œéç”¨æˆ·é€‰æ‹©çš„æ—¶é—´æ®µ)

**æ ¸å¿ƒé€»è¾‘ - RFM æ¨¡å‹è®¡ç®—**:
```python
def _calculate_rfm_1y(self, df_full: pd.DataFrame) -> pd.DataFrame:
    # èšåˆç»´åº¦: buyer username
    rfm = df_full.groupby("buyer username").agg({
        "order number": "nunique",     # Frequency (è®¢å•æ•°)
        "revenue": "sum",              # Gross Monetary (æ€»æ¶ˆè´¹)
        "Refund": "sum",               # é€€æ¬¾æ€»é¢
        "order date": "max",           # æœ€è¿‘è´­ä¹°æ—¥æœŸ
        "is_bad": "sum",               # é—®é¢˜è®¢å•æ•°
        "is_dispute": "sum"            # çº çº·è®¢å•æ•°
    })
    
    # è®¡ç®—é«˜é˜¶æŒ‡æ ‡
    rfm["Net_Monetary"] = rfm["Gross_Monetary"] + rfm["Refund"]  # å‡€æ¶ˆè´¹
    rfm["Recency"] = (analysis_end_dt - rfm["LastDate"]).dt.days  # æœ€è¿‘è´­ä¹°å¤©æ•°
    rfm["AOV"] = rfm["Net_Monetary"] / rfm["Frequency"]          # å®¢å•ä»·
    rfm["ReturnRate"] = rfm["BadCount"] / rfm["Total_Lines"]     # é€€è´§ç‡
```

**è¯Šæ–­å™¨**: `CustomerDiagnostician` - åŸºäº RFM è¿›è¡Œå®¢æˆ·åˆ†å±‚

---

### 4.6 ShippingAnalyzer - ç‰©æµæ•ˆç›Šè¯Šæ–­

**æ–‡ä»¶**: `backend/core/services/logistics.py`

**è¾“å‡ºæ–‡ä»¶**: `Analysis_Shipping_{suffix}.csv`

**åˆ†æç»´åº¦**:
1. æœ¬æœŸ vs ä¸ŠæœŸç‰©æµè´¹ç”¨å¯¹æ¯”
2. æŒ‰ Carrier åˆ†ç»„ç»Ÿè®¡
3. ç‰©æµæˆæœ¬å æ¯”åˆ†æ
4. é€€è´§ç‰©æµè´¹ç”¨åˆ†æ

---

### 4.7 InventorySnapshot - åº“å­˜èµ„äº§å¿«ç…§

**æ–‡ä»¶**: `backend/core/services/inventory_snapshot.py`

**è¾“å‡ºæ–‡ä»¶**: `Inventory_Asset_Snapshot_{suffix}.csv`

**æ ¸å¿ƒé€»è¾‘**:
```python
def run(self):
    # 1. è·å–æœ€æ–°åº“å­˜é‡
    df_inv = self.repo.get_inventory_latest()  # [SKU, Quantity]
    
    # 2. è·å–æˆæœ¬æ•°æ®
    df_cogs = self.repo.get_all_cogs()  # [SKU, Cog, Category]
    
    # 3. åˆå¹¶è®¡ç®—èµ„äº§ä»·å€¼
    df_merge = pd.merge(df_inv, df_cogs[['SKU', 'Cog', 'Category']], on='SKU', how='left')
    df_merge['Asset_Value'] = df_merge['Quantity'] * df_merge['Cog']
    
    # 4. æŒ‰èµ„äº§ä»·å€¼é™åºæ’åˆ—
    df_merge = df_merge.sort_values('Asset_Value', ascending=False)
```

**è¾“å‡ºè¡¨ç»“æ„**:
| SKU | Category | Quantity | Cog | Asset_Value |
|-----|----------|----------|-----|-------------|
| SKU001 | Auto | 500 | 12.50 | 6250.00 |

---

### 4.8 PredictionService - AI é”€é‡é¢„æµ‹

**æ–‡ä»¶**: `backend/core/services/prediction.py`

**è¾“å‡ºæ–‡ä»¶**: `Estimated_Monthly_SKU.csv`

**é¢„æµ‹æ¨¡å‹ (é”¦æ ‡èµ›æœºåˆ¶)**:
1. XGBoostForecaster
2. SarimaForecaster  
3. HoltWintersForecaster
4. ETSForecaster
5. CrostonForecaster
6. WeightedCycleForecaster

**æ ¸å¿ƒé€»è¾‘**:
```python
def run(self):
    # 1. èšåˆè¿‡å» 24 ä¸ªæœˆçš„æœˆåº¦é”€é‡
    df_matrix = self._aggregate_monthly_sales()
    
    # 2. å¯¹æ¯ä¸ª SKU è¿è¡Œæ‰€æœ‰æ¨¡å‹
    for sku, row in df_matrix.iterrows():
        series = row
        
        # æ–°å“è§„åˆ™ (å†å² < 6 ä¸ªæœˆ, ä½¿ç”¨åŠ æƒå‘¨æœŸæ³•)
        if valid_len < 6:
            best_val = WeightedCycleForecaster.fit_predict(series)
            best_algo = "NewProduct_Rule"
        else:
            # è¿è¡Œæ‰€æœ‰æ¨¡å‹å¹¶è¯„ä¼°
            preds = {m.name: m.fit_predict(series) for m in self.models}
            scores = self._evaluate_models(series)  # WMAPE è¯„ä¼°
            
            # é€‰æ‹©æœ€ä½³æ¨¡å‹
            best_algo = max(self.models, key=lambda m: scores.get(m.name, 0)).name
            best_val = preds.get(best_algo, 0.0)
```

**æ¨¡å‹è¯„ä¼° (WMAPE)**:
```python
def _evaluate_models(self, series: pd.Series, horizon: int = 3) -> Dict[str, float]:
    # å›æµ‹æœ€è¿‘ 3 ä¸ªæœˆ, è®¡ç®—åŠ æƒå¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®
    wmape = sum_error / sum_actual
    accuracy = max(0, 1.0 - wmape) * 100
```

---

### 4.9 OrderingService - æ™ºèƒ½è¡¥è´§è®¡ç®—

**æ–‡ä»¶**: `backend/core/services/ordering.py`

**è¾“å‡ºæ–‡ä»¶**: `Smart_Ordering_Plan_{suffix}.csv`

**ä¾èµ–**: `Estimated_Monthly_SKU.csv` (PredictionService çš„è¾“å‡º)

**æ ¸å¿ƒé€»è¾‘**:
```python
def run(self):
    # 1. åŠ è½½æ•°æ®æº
    df_pred = pd.read_csv("Estimated_Monthly_SKU.csv")  # é¢„æµ‹æœˆæ¶ˆè€—
    df_inv = self.sku_repo.get_inventory_latest()        # å½“å‰åº“å­˜
    df_cogs = self.sku_repo.get_all_cogs()               # æˆæœ¬æ•°æ®
    
    # 2. ABC åˆ†çº§ (åŸºäºé¢„ä¼°é”€å”®é¢)
    df_main["é¢„ä¼°é”€å”®é¢"] = df_main["é¢„æµ‹æœˆæ¶ˆè€—"] * df_main["Cog"]
    # A ç±»: ç´¯è®¡å æ¯” â‰¤ 80%, æœåŠ¡æ°´å¹³ 98%
    # B ç±»: ç´¯è®¡å æ¯” â‰¤ 95%, æœåŠ¡æ°´å¹³ 95%
    # C ç±»: å…¶ä»–, æœåŠ¡æ°´å¹³ 90%
    
    # 3. è¡¥è´§è®¡ç®—
    for each SKU:
        # å®‰å…¨åº“å­˜ = Z Ã— âˆšLead Ã— æ³¢åŠ¨ç‡ (è‡³å°‘ min_safety Ã— forecast)
        safety_stock = max(z_score * sqrt(lead_time) * volatility, min_safety * forecast)
        
        # ç›®æ ‡åº“å­˜ = Lead Ã— é¢„æµ‹ + å®‰å…¨åº“å­˜
        target_stock = (lead_time * forecast) + safety_stock
        
        # ç¼ºå£ = ç›®æ ‡ - å½“å‰åº“å­˜
        gap = target_stock - current_inv
        
        # å»ºè®®è®¢è´§ = å‘ä¸Šå–æ•´åˆ° MOQ
        if gap > 0 and forecast * 6 >= MOQ:
            suggest_qty = ceil(gap / MOQ) * MOQ
```

**å‚æ•°é…ç½®**:
```python
Z_SCORES = {0.98: 2.05, 0.95: 1.65, 0.90: 1.28}  # æœåŠ¡æ°´å¹³å¯¹åº”çš„ Z å€¼
LEAD_MONTH = settings.LEAD_MONTH   # ä¾›åº”é“¾å‘¨æœŸ (æœˆ)
MIN_SAFETY_MONTH = settings.MIN_SAFETY_MONTH  # æœ€å°å®‰å…¨åº“å­˜ (æœˆ)
```

---

## äº”ã€æ–‡ä»¶ç®¡ç†æœºåˆ¶

### 5.1 ReportFileManager

**æ–‡ä»¶**: `backend/core/services/report_manager.py`

**ç”¨æˆ·éš”ç¦»**:
```python
class ReportFileManager:
    def __init__(self):
        user = get_current_user()
        sub_dir = self._sanitize_username(user)  # æ¸…æ´—ç”¨æˆ·å
        self.output_dir = settings.OUTPUT_DIR / sub_dir  # output/{username}/
```

**å®‰å…¨æœºåˆ¶**:
- ç”¨æˆ·åæ¸…æ´—: åªä¿ç•™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
- æ–‡ä»¶åéªŒè¯: ç¦æ­¢ `..` å’Œè·¯å¾„åˆ†éš”ç¬¦
- åªå…è®¸ `.csv` æ–‡ä»¶

**æ ¸å¿ƒæ–¹æ³•**:
```python
get_generated_files() -> List[str]  # è·å–æ‰€æœ‰ CSV æ–‡ä»¶å
get_file_path(filename) -> Path     # è·å–ç»å¯¹è·¯å¾„
clear_all_reports() -> None         # æ¸…ç©ºè¾“å‡ºç›®å½•
create_zip_archive() -> bytes       # æ‰“åŒ…ä¸º ZIP
```

---

## å…­ã€æƒé™ä¸å®‰å…¨

### 6.1 æƒé™æ£€æŸ¥

```python
# æŠ¥è¡¨ç”Ÿæˆæƒé™
check_perm(request.user, 'module.sales.reports.generate')

# æŠ¥è¡¨ä¸­å¿ƒæƒé™  
check_perm(request.user, 'module.sales.reports.center')
```

### 6.2 å®‰å…¨åŠ¨ä½œéªŒè¯

```python
# L201: ç”ŸæˆæŠ¥è¡¨éœ€è¦å®‰å…¨éªŒè¯
is_valid, error_msg = SecurityPolicyManager.verify_action_request(
    request, 
    'btn_generate_report'
)
```

---

## ä¸ƒã€æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  eBay CSV ä¸Šä¼    â”‚
â”‚  (ETL Wizard)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data_Clean_Log â”‚ â† äº¤æ˜“æ•°æ®å­˜å‚¨è¡¨
â”‚ (etl_data_log)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TransactionRepo â”‚ â†â”€â”€ â”‚   InventoryRepo  â”‚
â”‚ (äº¤æ˜“æ•°æ®è¯»å–)   â”‚     â”‚  (åº“å­˜/æˆæœ¬è¯»å–)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ProfitAnalyzerBase  â”‚
         â”‚  (æ•°æ®åŠ è½½ + è´¹ç”¨è®¡ç®—)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚
    â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”€é‡åˆ†æ â”‚  â”‚  åˆ©æ¶¦åˆ†æ    â”‚  â”‚  å®¢æˆ·åˆ†æ    â”‚
â”‚ (Sales) â”‚  â”‚ (SKU/List.) â”‚  â”‚  (CRM RFM)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ReportFileManager   â”‚
         â”‚  (ç”¨æˆ·éš”ç¦»å­˜å‚¨)        â”‚
         â”‚  output/{username}/   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€è¾“å‡ºæ–‡ä»¶æ¸…å•

| åºå· | åˆ†æå™¨ | è¾“å‡ºæ–‡ä»¶å | è¯´æ˜ |
|------|--------|-----------|------|
| 1 | SalesQtyAnalyzer | `SKU_Sold_{suffix}.csv` | SKU é”€é‡ç»Ÿè®¡ |
| 2 | SkuProfitAnalyzer | `Profit_Analysis_SKU_{suffix}.csv` | SKU åˆ©æ¶¦è¯Šæ–­ (å« 6 è¡¨ + è¯Šæ–­) |
| 3 | ListingProfitAnalyzer | `Profit_Analysis_Listing_{suffix}.csv` | Listing è¡¨ç°åˆ†æ |
| 4 | ComboProfitAnalyzer | `Profit_Analysis_Combo_{suffix}.csv` | Combo ç­–ç•¥åˆ†æ |
| 5 | CustomerAnalyzer | `Analysis_Customer_RFM_{suffix}.csv` | å®¢æˆ·ç”»åƒ RFM åˆ†æ |
| 6 | ShippingAnalyzer | `Analysis_Shipping_{suffix}.csv` | ç‰©æµæ•ˆç›Šè¯Šæ–­ |
| 7 | InventorySnapshot | `Inventory_Asset_Snapshot_{suffix}.csv` | åº“å­˜èµ„äº§å¿«ç…§ |
| 8 | PredictionService | `Estimated_Monthly_SKU.csv` | AI é”€é‡é¢„æµ‹ (æ— åç¼€) |
| 9 | OrderingService | `Smart_Ordering_Plan_{suffix}.csv` | æ™ºèƒ½è¡¥è´§è®¡åˆ’ |

**åç¼€æ ¼å¼**: `{YYYYMMDD}_{YYYYMMDD}` (å¦‚ `20260101_20260131`)

---

## ä¹ã€é…ç½®å‚æ•°

### 9.1 è€—æŸç‡é…ç½® (`settings.LOSS_RATES`)

| ç±»å‹ | Action Code | é»˜è®¤è€—æŸç‡ | è¯´æ˜ |
|------|-------------|-----------|------|
| RETURN | RE | 30% | å®¢æˆ·ç”³è¯·é€€è´§,æ— å¹³å°ä»‹å…¥ |
| REQUEST | CR | 50% | å®¢æˆ·ç”³è¯·é€€è´§,å¹³å°ä»‹å…¥ |
| CASE | CC | 60% | å®¢æˆ·æŠ•è¯‰,å¹³å°å¼ºåˆ¶é€€æ¬¾ |
| DISPUTE | PD | 100% | é“¶è¡ŒæŠ•è¯‰,å…¨é¢é€€æ¬¾ |

### 9.2 è¡¥è´§å‚æ•°

| å‚æ•° | é…ç½®é”® | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| ä¾›åº”é“¾å‘¨æœŸ | `LEAD_MONTH` | 2.0 | ä»ä¸‹å•åˆ°åˆ°è´§çš„æœˆæ•° |
| æœ€å°å®‰å…¨åº“å­˜ | `MIN_SAFETY_MONTH` | 1.5 | æœ€ä½å®‰å…¨åº“å­˜æœˆæ•° |

---

## åã€è¯Šæ–­å™¨ (Diagnostician)

å„åˆ†æå™¨è°ƒç”¨å¯¹åº”çš„è¯Šæ–­å™¨ç”Ÿæˆ AI æ™ºèƒ½è¯Šæ–­æ ‡ç­¾:

| åˆ†æå™¨ | è¯Šæ–­å™¨ | æ–‡ä»¶è·¯å¾„ |
|--------|--------|----------|
| SkuProfitAnalyzer | SkuDiagnostician | `core/services/diagnostics/sku.py` |
| ListingProfitAnalyzer | ListingDiagnostician | `core/services/diagnostics/listing.py` |
| ComboProfitAnalyzer | ComboDiagnostician | `core/services/diagnostics/combo.py` |
| CustomerAnalyzer | CustomerDiagnostician | `core/services/diagnostics/crm.py` |
| ShippingAnalyzer | LogisticsDiagnostician | `core/services/diagnostics/logistics.py` |

è¯Šæ–­å™¨æ¥å£:
```python
class Diagnostician:
    def diagnose(self) -> pd.DataFrame:
        """æ‰§è¡Œè¯Šæ–­ï¼Œè¿”å›å¸¦æ ‡ç­¾çš„ DataFrame"""
        pass
    
    def get_tag_definitions(self) -> List[str]:
        """è¿”å›æ ‡ç­¾è¯´æ˜åˆ—è¡¨ (å†™å…¥ CSV æœ«å°¾ä½œä¸º footer)"""
        pass
```

---

**æ–‡æ¡£ç»“æŸ**
