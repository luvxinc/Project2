# 交易数据上传 (ETL) - 解析逻辑

> 文档版本: V1.0  
> 最后更新: 2026-01-12  
> 对应代码: `backend/apps/etl/views.py`, `backend/core/services/etl/`

---

## 一、架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     交易数据上传 (ETL Module)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                   Transaction Wizard (5 阶段)                         │  │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐ │  │
│  │  │ Upload  │ → │  Parse  │ → │  Clean  │ → │Transform│ → │ Confirm │ │  │
│  │  │ 上传文件 │   │ 解析数据 │   │ SKU修正 │   │  预览   │   │  入库   │ │  │
│  │  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                   Inventory Wizard (3 阶段)                           │  │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐                             │  │
│  │  │ Upload  │ → │Validate │ → │  Sync   │                             │  │
│  │  │ 上传文件 │   │ 校验SKU │   │  入库   │                             │  │
│  │  └─────────┘   └─────────┘   └─────────┘                             │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.1 目录结构

```
backend/apps/etl/
├── views.py          # 视图层 (Wizard 控制器)
├── urls.py           # 路由配置

backend/core/services/etl/
├── ingest.py         # 数据摄入服务 (CSV → Raw Table)
├── parser.py         # 数据解析器 (Custom Label → SKU 拆分)
├── transformer.py    # 数据转换器 (Raw → Clean Log)
└── repository.py     # 数据仓库 (SQL 查询封装)

backend/templates/etl/
├── hub.html          # Hub 页面
├── tab_transaction.html  # Transaction Wizard 模板
├── tab_inventory.html    # Inventory Wizard 模板
└── partials/         # HTMX 片段
```

---

## 二、Transaction Wizard 详解

### 2.1 流程概览

```
用户上传 CSV 文件
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 1: Upload (etl_upload)                                  │
│  ├── 文件类型识别 (Transaction / Earning)                      │
│  ├── 元数据提取 (Seller, 日期范围)                             │
│  ├── 一致性校验 (店铺一致/日期一致/非未来日期)                  │
│  ├── 创建预备份 (Rollback Point)                               │
│  └── 执行摄入 (IngestService.run_ingest_pipeline)              │
└────────────────────────────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 2: Parse (etl_parse)                                    │
│  ├── 解析 Custom Label 字段                                    │
│  ├── 正则匹配提取 SKU + Quantity                               │
│  ├── 自动修复已知映射 (Data_Fix_Map)                           │
│  └── 返回待处理项数量                                          │
└────────────────────────────────────────────────────────────────┘
        ↓ (如果有待处理项)
┌────────────────────────────────────────────────────────────────┐
│  Stage 3: Clean (etl_fix_sku) - 循环执行直到清空              │
│  ├── 显示待处理项 (Order Number, Custom Label, Bad SKU)       │
│  ├── 模糊匹配建议 (get_fuzzy_suggestions)                      │
│  ├── 用户选择/输入正确 SKU                                     │
│  └── 应用修复 (apply_fix_transactional)                        │
└────────────────────────────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 4: Transform (etl_transform) - 预览页面                 │
│  ├── 显示解析统计 (自动修复数 / 人工修复数)                    │
│  ├── 显示数据库状态 (入库前记录数 / 日期范围)                  │
│  └── 等待用户确认                                              │
└────────────────────────────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 5: Confirm (etl_confirm) - 需要密码验证                 │
│  ├── 安全验证 (SecurityPolicyManager)                          │
│  ├── 创建转换前备份                                            │
│  ├── 执行转换 (TransactionTransformer.run)                     │
│  ├── 去重 + 追加入库 (Data_Clean_Log)                          │
│  └── 返回统计结果                                              │
└────────────────────────────────────────────────────────────────┘
```

---

### 2.2 Stage 1: Upload (文件上传与摄入)

**文件**: `backend/apps/etl/views.py` L225-383

**核心逻辑**:

#### 2.2.1 文件类型识别
```python
for f in files:
    head = f.read(2048).decode('utf-8', errors='ignore').lower()
    f.seek(0)
    if "transaction report" in head:
        trans_files.append(f)
    elif "order earnings report" in head:
        earn_files.append(f)
```

#### 2.2.2 元数据提取 `_extract_stats()`
```python
def _extract_stats(file_obj):
    """从 CSV 头部提取 Seller、Start Date、End Date"""
    for _, row in df.iterrows():
        first_col = str(row.iloc[0]).strip().lower()
        second_col = str(row.iloc[1]).strip()
        
        # 提取 Seller
        if 'seller' in first_col or 'shop' in first_col:
            sellers.add(second_col)
        
        # 提取日期范围
        if first_col == 'start date':
            min_dt = dateutil_parser.parse(second_col, fuzzy=True).date()
        if first_col == 'end date':
            max_dt = dateutil_parser.parse(second_col, fuzzy=True).date()
```

#### 2.2.3 一致性校验
```python
# 1. 必须同时存在 Transaction 与 Earning
if not trans_files or not earn_files:
    return error("缺少文件")

# 2. 店铺一致性
if trans_sellers != earn_sellers:
    return error("店铺不匹配")

# 3. 日期区间一致性
if trans_min != earn_min or trans_max != earn_max:
    return error("时间区间不一致")

# 4. 最新日期不能是今天或未来
if trans_max >= today:
    return error("日期不能是未来")
```

#### 2.2.4 数据摄入 `IngestService`

**文件**: `backend/core/services/etl/ingest.py`

```python
class IngestService:
    def run_ingest_pipeline(self, transaction_files, earning_files):
        # 1. 清空临时表
        self.repo.truncate_raw_tables()
        
        # 2. 处理 Transaction 文件 → Data_Transaction 表
        self._process_files(transaction_files, "Data_Transaction", "Order number")
        
        # 3. 处理 Earning 文件 → Data_Order_Earning 表
        self._process_files(earning_files, "Data_Order_Earning", "Order number")
    
    def _process_files(self, files, table_name, key_col):
        for file_obj in files:
            # 探测 Seller 和 Header 行
            seller, skiprows = self._detect_metadata(file_obj, key_col)
            
            # 读取 CSV
            df = pd.read_csv(file_obj, skiprows=skiprows, dtype=str)
            
            # [关键] 全局去空格
            df = df.apply(lambda x: x.str.strip() if x.dtype == "object" else x)
            
            # 注入 Seller 元数据
            df["Seller"] = seller
            
            # 写入数据库 (replace 模式)
            df.to_sql(table_name, engine, if_exists='replace', index=False)
```

**数据流向**:
```
eBay Transaction CSV  →  Data_Transaction 表
eBay Earning CSV      →  Data_Order_Earning 表
```

---

### 2.3 Stage 2: Parse (解析 Custom Label)

**文件**: `backend/core/services/etl/parser.py`

**核心流程**:
```python
class TransactionParser:
    def run(self):
        # 1. 读取 Data_Transaction 表
        df = self.db.read_df("SELECT * FROM Data_Transaction")
        
        # 2. 初始化解析列 (P_SKU1..P_SKU10, P_Quantity1..P_Quantity10)
        df = self._init_columns(df)
        
        # 3. Stage 1: 向量化正则匹配
        df = self._apply_regex_patterns(df)
        
        # 4. Stage 2: 迭代处理复杂行
        df = self._process_complex_rows(df)
        
        # 5. Stage 3: 校验与自动修复
        df = self._validate_and_autofix(df)
        
        # 6. 写回数据库
        df.to_sql("Data_Transaction", engine, if_exists='replace')
```

#### 2.3.1 正则匹配模式
```python
def _apply_regex_patterns(self, df):
    """
    Custom Label 格式示例:
    - "SKU001*2"           → SKU=SKU001, Qty=2
    - "SKU001*2+SKU002*1"  → 多个 SKU
    - "SKU001"             → SKU=SKU001, Qty=1
    """
    # 单个 SKU 模式
    pattern = r'^([A-Z0-9]+)\*?(\d*)$'
    
    # 多个 SKU 模式
    multi_pattern = r'([A-Z0-9]+)\*(\d+)'
```

#### 2.3.2 自动修复逻辑
```python
def _validate_and_autofix(self, df):
    """校验 SKU 有效性，应用已知修复映射"""
    # 加载修复映射表 (Data_Fix_Map)
    fix_map = self._build_fast_fix_map()
    
    for bad_sku in invalid_skus:
        if bad_sku in fix_map:
            # 自动修复
            new_sku = fix_map[bad_sku]
            auto_fixed.append({'old': bad_sku, 'new': new_sku})
        else:
            # 加入待处理队列
            pending_count += 1
```

**修复映射表结构 (Data_Fix_Map)**:
| Bad_SKU | Fix_SKU | Created_At |
|---------|---------|------------|
| SKUXY001 | SKU001 | 2026-01-01 |

---

### 2.4 Stage 3: Clean (人工 SKU 修正)

**文件**: `backend/apps/etl/views.py` L515-614

**核心逻辑**:
```python
def etl_fix_sku(request):
    # 1. 获取用户提交的修正
    order_id = request.POST.get('order_id')
    old_sku = request.POST.get('old_sku')
    new_sku = request.POST.get('new_sku').strip().upper()
    
    # 2. 校验新 SKU 是否有效 (存在于 Data_COGS)
    if not correction_svc.is_valid_sku(new_sku):
        return error("SKU 无效")
    
    # 3. 应用修复 (事务性更新)
    success = correction_svc.apply_fix_transactional(
        order_id, slot_idx, label, old_sku, old_qty, new_sku, new_qty
    )
    
    # 4. 记录修复日志
    fix_log.append({
        'order': order_id, 
        'old': old_sku, 
        'new': new_sku, 
        'type': 'manual'
    })
    
    # 5. 获取下一个待处理项
    next_item = correction_svc.get_next_pending_issue()
```

**模糊匹配建议**:
```python
def get_fuzzy_suggestions(bad_sku):
    """基于 Levenshtein 距离的模糊匹配"""
    from difflib import get_close_matches
    all_skus = [...]  # 从 Data_COGS 获取所有有效 SKU
    return get_close_matches(bad_sku, all_skus, n=5, cutoff=0.4)
```

---

### 2.5 Stage 4-5: Transform & Confirm (转换入库)

**文件**: `backend/core/services/etl/transformer.py`

**核心流程**:
```python
class TransactionTransformer:
    def run(self):
        # 1. 读取 Transaction (已解析) 和 Earning 表
        df_trans = self.db.read_df("SELECT * FROM Data_Transaction")
        df_earn = self.db.read_df("SELECT * FROM Data_Order_Earning")
        
        # 2. 关联两表 (基于 Order Number)
        df = pd.merge(df_trans, df_earn, on='Order number', how='left')
        
        # 3. 计算业务字段
        df = self._calculate_action(df)      # 订单动作 (SA/CA/RE/CR/CC/PD)
        df = self._calculate_seller(df)      # 店铺归属
        df = self._prorate_fees(df)          # 费用分摊
        
        # 4. 日期归一化
        df['order date'] = df['Order creation date'].apply(self._normalize_date)
        
        # 5. 去重 (基于 Order Number + SKU)
        existing = self.db.read_df("SELECT `order number` FROM Data_Clean_Log")
        df_new = df[~df['Order number'].isin(existing['order number'])]
        
        # 6. 追加入库
        df_new.to_sql("Data_Clean_Log", engine, if_exists='append')
        
        return {
            'data_count': len(df),
            'dedup_count': len(df) - len(df_new),
            'actual_upload': len(df_new)
        }
```

#### 2.5.1 Action 计算逻辑
```python
def _calculate_action(self, df):
    """
    根据 Type 和 Status 字段推断订单动作
    
    Action Codes:
    - SA: Sale (销售)
    - CA: Cancel (取消)
    - RE: Return (退货,无平台介入)
    - CR: Request (退货,平台介入)
    - CC: Case (客户投诉,平台强制退款)
    - PD: Dispute (银行投诉)
    """
    conditions = [
        (df['Type'] == 'Refund') & (df['Status'] == 'Cancelled'),  # CA
        (df['Type'] == 'Refund') & (df['Reason'].str.contains('return')),  # RE
        # ... 其他条件
    ]
    choices = ['CA', 'RE', 'CR', 'CC', 'PD']
    df['action'] = np.select(conditions, choices, default='SA')
```

#### 2.5.2 日期归一化
```python
def _normalize_date(self, date_val):
    """
    支持多种日期格式:
    - 'Jun 30, 2025'
    - '2025-06-30'
    - '30-Jun-25'
    → 输出: '2025-06-30'
    """
    from dateutil import parser
    return parser.parse(str(date_val)).strftime('%Y-%m-%d')
```

---

## 三、Inventory Wizard 详解

### 3.1 流程概览

```
用户上传库存盘点 CSV
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 1: Validate (inv_validate)                              │
│  ├── 读取 CSV (SKU, Quantity 列)                               │
│  ├── 校验 SKU 是否存在于 Data_COGS                             │
│  ├── 如果有未知 SKU，提供模糊匹配修正界面                      │
│  └── 校验通过后，保存 DataFrame 到 Session                     │
└────────────────────────────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 2: Apply Corrections (可选)                             │
│  ├── 用户选择正确的 SKU 替换                                   │
│  └── 重新校验                                                  │
└────────────────────────────────────────────────────────────────┘
        ↓
┌────────────────────────────────────────────────────────────────┐
│  Stage 3: Sync (inv_sync) - 需要密码验证                       │
│  ├── 检查目标日期列是否已存在                                  │
│  ├── 如果存在，提示用户确认覆盖                                │
│  ├── 安全验证 (SecurityPolicyManager)                          │
│  ├── 创建备份                                                  │
│  └── 同步到 Data_Inventory 表 (新增日期列)                     │
└────────────────────────────────────────────────────────────────┘
```

### 3.2 库存表结构

**Data_Inventory 表**:
| SKU | 2026-01-01 | 2026-01-15 | 2026-02-01 |
|-----|------------|------------|------------|
| SKU001 | 100 | 95 | 120 |
| SKU002 | 50 | 45 | 60 |

- 每次盘点新增一列（日期作为列名）
- 列名格式: `YYYY-MM-DD`

---

## 四、数据库表结构

### 4.1 临时表 (Raw)

| 表名 | 说明 | 生命周期 |
|------|------|----------|
| Data_Transaction | eBay Transaction CSV 原始数据 | 每次上传时 replace |
| Data_Order_Earning | eBay Earning CSV 原始数据 | 每次上传时 replace |

### 4.2 业务表

| 表名 | 说明 | 写入方式 |
|------|------|----------|
| Data_Clean_Log | 清洗后的交易数据 (核心) | 去重追加 (append) |
| Data_Fix_Map | SKU 修复映射表 | 增量追加 |
| Data_Inventory | 库存盘点快照 | 新增日期列 |
| Data_COGS | 产品成本表 (主数据) | 手动维护 |

---

## 五、安全机制

### 5.1 权限控制

```python
# Tab 级别权限
_check_tab_permission(user, 'trans')  # module.etl.trans
_check_tab_permission(user, 'inv')    # module.etl.inv
```

### 5.2 安全动作验证

| 动作 | Action Key | 说明 |
|------|-----------|------|
| SKU 修正 | `btn_commit_sku_fix` | 提交 SKU 映射修复 |
| 转换入库 | `btn_run_transform` | 确认数据入库 (需密码) |
| 库存同步 | `btn_sync_inventory` | 确认库存入库 (需密码) |

### 5.3 回滚机制

```python
# 摄入前备份
db_service.create_backup(
    tag="ETL_Pre_Ingest",
    is_rollback=True,
    tables=RollbackConfigManager.get_all_rollback_tables(),
    code="S01"
)

# 转换前备份
db_service.create_backup(
    tag="ETL_Pre_Transform",
    code="S01"
)

# 库存同步前备份
db_service.create_backup(
    tag="ETL_Pre_InvSync",
    code="I01"
)
```

---

## 六、数据流图

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                            Transaction Wizard                                 │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐     ┌─────────────────┐                                │
│  │ Transaction.csv │     │  Earning.csv    │                                │
│  └────────┬────────┘     └────────┬────────┘                                │
│           │                       │                                          │
│           └───────────┬───────────┘                                          │
│                       ▼                                                      │
│           ┌───────────────────────┐                                          │
│           │    IngestService      │                                          │
│           │  (文件解析 + 清洗)     │                                          │
│           └───────────┬───────────┘                                          │
│                       │                                                      │
│           ┌───────────┴───────────┐                                          │
│           ▼                       ▼                                          │
│   ┌───────────────┐       ┌───────────────┐                                  │
│   │Data_Transaction│      │Data_Order_Earning│                               │
│   │   (Raw)       │       │   (Raw)       │                                  │
│   └───────┬───────┘       └───────┬───────┘                                  │
│           │                       │                                          │
│           └───────────┬───────────┘                                          │
│                       ▼                                                      │
│           ┌───────────────────────┐                                          │
│           │  TransactionParser    │                                          │
│           │  (Custom Label 解析)   │                                          │
│           └───────────┬───────────┘                                          │
│                       │                                                      │
│                       ▼                                                      │
│           ┌───────────────────────┐       ┌───────────────┐                  │
│           │  CorrectionService    │ ← → │  Data_Fix_Map │                  │
│           │  (SKU 校验 + 修复)     │       │  (修复映射表)  │                  │
│           └───────────┬───────────┘       └───────────────┘                  │
│                       │                                                      │
│                       ▼                                                      │
│           ┌───────────────────────┐       ┌───────────────┐                  │
│           │TransactionTransformer │ ← → │  Data_COGS    │                  │
│           │  (业务计算 + 转换)     │       │  (产品成本)    │                  │
│           └───────────┬───────────┘       └───────────────┘                  │
│                       │                                                      │
│                       ▼                                                      │
│           ┌───────────────────────┐                                          │
│           │   Data_Clean_Log      │  ← 核心业务表                            │
│           │   (清洗后交易数据)     │                                          │
│           └───────────────────────┘                                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、Session 状态管理

### 7.1 Transaction Wizard Session Keys

| Key | 说明 | 生命周期 |
|-----|------|----------|
| `etl_stage` | 当前阶段 (upload/parse/clean/transform/done) | 流程结束时清除 |
| `etl_pending_count` | 待处理 SKU 数量 | clean 阶段使用 |
| `etl_upload_result` | 上传结果消息 | parse 阶段使用 |
| `etl_parse_stats` | 解析统计 (error_count, auto_fixed, manual_fixed, fix_log) | transform/confirm |
| `etl_db_stats_before` | 入库前数据库状态 | confirm 阶段使用 |

### 7.2 Inventory Wizard Session Keys

| Key | 说明 |
|-----|------|
| `inv_stage` | 当前阶段 (upload/validate/sync) |
| `inv_df_{session_key}` | 已验证的 DataFrame (JSON 格式) |
| `inv_errors_{session_key}` | 校验错误列表 |
| `inv_target_date_{session_key}` | 目标日期 |

---

## 八、错误处理

### 8.1 常见错误场景

| 错误 | 原因 | 处理方式 |
|------|------|----------|
| 缺少文件 | 未同时上传 Transaction + Earning | 返回 validation error |
| 店铺不匹配 | 两个文件来自不同店铺 | 返回 validation error |
| 日期在未来 | 文件包含今天或未来的日期 | 返回 validation error |
| SKU 无效 | SKU 不在 Data_COGS 表中 | 进入 clean 阶段 |
| 日期列已存在 | 库存盘点日期已入库 | 提示覆盖确认 |

### 8.2 审计日志

```python
audit_logger.info(
    f"ETL文件上传: {len(files)} 个文件",
    extra={
        "user": request.user.username,
        "func": "ETL:Upload",
        "action": "UPLOAD_FILE",
        "details": f"Files: {', '.join(filenames)}"
    }
)
```

---

## 九、性能优化

### 9.1 批量处理

```python
# 使用 chunksize 分批写入
df.to_sql(
    table_name,
    engine,
    if_exists='replace',
    index=False,
    chunksize=2000,  # 每批 2000 条
    dtype=dtype_map
)
```

### 9.2 内存级快速修复

```python
def _build_fast_fix_map(self):
    """将修复映射加载到内存，避免重复查询数据库"""
    df = self.db.read_df("SELECT Bad_SKU, Fix_SKU FROM Data_Fix_Map")
    return dict(zip(df['Bad_SKU'].str.upper(), df['Fix_SKU'].str.upper()))
```

---

## 十、URL 路由表

| 路由 | 视图函数 | 说明 |
|------|----------|------|
| `/dashboard/sales/transactions/` | `etl_hub` | Hub 页面 |
| `/dashboard/sales/transactions/tab/transaction/` | `tab_transaction` | Transaction Tab |
| `/dashboard/sales/transactions/tab/inventory/` | `tab_inventory` | Inventory Tab |
| `/dashboard/sales/transactions/upload/` | `etl_upload` | 文件上传 |
| `/dashboard/sales/transactions/parse/` | `etl_parse` | 解析 |
| `/dashboard/sales/transactions/fix-sku/` | `etl_fix_sku` | SKU 修正 |
| `/dashboard/sales/transactions/transform/` | `etl_transform` | 预览 |
| `/dashboard/sales/transactions/confirm/` | `etl_confirm` | 确认入库 |
| `/dashboard/sales/transactions/cancel/` | `etl_cancel` | 取消流程 |
| `/dashboard/sales/transactions/inv/validate/` | `inv_validate` | 库存校验 |
| `/dashboard/sales/transactions/inv/sync/` | `inv_sync` | 库存同步 |

---

**文档结束**
