# 定金支付管理 - 业务逻辑文档

> 最后更新: 2026-01-10  
> 路径: `/dashboard/finance/deposit/`  
> 付款单号格式: `DPMT_YYYYMMDD_N##`

---

## 1. 核心概念

定金支付管理模块用于管理订货单的**定金支付**。一个订单的完整支付流程为：

```
订单总金额 = 定金 + 尾款
定金金额 = 订单总金额 × 定金比例 (cur_deposit_par%)
```

其中：
- **定金** 由本「定金付款管理」模块处理 (`DPMT_` 系列)
- **尾款** 由「订单付款管理」模块处理 (`PPMT_` 系列)

### 与订单付款的区别

| 特性 | 定金付款 (DPMT) | 订单付款 (PPMT) |
|------|----------------|-----------------|
| 支付时机 | 订单确认后立即 | 收货后/约定时间 |
| 金额基础 | 订单总金额 × 定金比例 | 订单总金额 - 已付定金 |
| 前置条件 | 无 | 定金已付清 (如需) |
| 汇率浮动 | 不适用 | 可能触发 |

---

## 2. 付款单号规范

### 2.1 格式定义

```
DPMT_YYYYMMDD_N##
│    │        │
│    │        └── 当日序号 (N01, N02, ...)
│    └─────────── 付款日期
└──────────────── Deposit Payment 前缀 (区别于订单付款的 PPMT_)
```

### 2.2 生成规则

1. **批量共享**: 同一批次提交的所有订单共享同一个 `pmt_no`
2. **当日唯一**: 以当天日期查询 `in_pmt_deposit` 表中 `pmt_no LIKE 'DPMT_YYYYMMDD_N%'` 的数量，+1 生成新序号
3. **不可变**: 一旦生成，付款单号不可修改

### 2.3 文件目录结构

```
/data/records/finance/deposit/
└── {YYYY}/                      # 年份目录
    └── {pmt_no}/                # 付款单号目录
        ├── {pmt_no}_V01.pdf     # 付款回执 V01
        ├── {pmt_no}_V02.jpg     # 付款回执 V02
        └── ...
```

---

## 3. 数据源与计算逻辑

### 3.1 定金金额

#### 数据来源
- **订单明细**: `in_po_final` 表
- **订单策略**: `in_po_strategy` 表 (取 `seq` 最大的行为最新版本)

#### 计算公式
```
订单总金额 = SUM(po_quantity × po_price) for all SKUs in po_num
定金金额 = 订单总金额 × cur_deposit_par%
```

#### 是否需要定金
查询 `in_po_strategy` 表 (最新seq):

| 条件 | 是否需要定金 |
|------|-------------|
| `cur_deposit = 0` | ❌ 不需要 |
| `cur_deposit = 1` AND `cur_deposit_par = 0` | ❌ 不需要 |
| `cur_deposit = 1` AND `cur_deposit_par > 0` | ✅ 需要 |

---

### 3.2 已付定金

#### 数据来源
- `in_pmt_deposit_final` 表 (定金付款终态表)

#### 计算公式
```
已付定金 = SUM(dep_paid + dep_prepay_amount) 
           FROM in_pmt_deposit_final 
           WHERE po_num = ?
```

#### 字段说明

| 字段 | 说明 |
|------|------|
| `dep_paid` | 现金支付金额 |
| `dep_prepay_amount` | 预付款抵扣金额 |
| `dep_cur` | 结算货币 (RMB/USD) |
| `dep_paid_cur` | 结算汇率 |
| `dep_cur_mode` | 汇率获取方式 (A=自动/M=手动) |

---

### 3.3 定金待付

#### 计算公式
```
定金待付 = 定金金额 - 已付定金
```

> 当定金待付 ≤ 0 或 dep_override = 1 时，视为定金已付清

---

### 3.4 预付款抵扣

当供应商有预付款余额时，可用于抵扣定金:

#### 数据来源
- `in_pmt_prepay_final` 表 (供应商预付款终态表)

#### 抵扣流程
1. 查询供应商当前可用余额
2. 用户选择是否启用抵扣
3. 抵扣金额 = MIN(可用余额, 定金待付)
4. 实际现金 = 定金待付 - 抵扣金额

#### 预付款记录
当使用预付款抵扣时，系统自动在 `in_pmt_prepay` 表中插入一条 `out` 类型记录:

```sql
INSERT INTO in_pmt_prepay (
    tran_type = 'out',
    tran_note = 'Deposit_{pmt_no}_原始支付单',
    tran_amount = {抵扣金额}
)
```

---

## 4. 定金支付状态判断

### 判断逻辑
一个订单被视为**定金已付清**的条件 (满足其一即可):

1. **定金待付 ≤ 0**  
   所有应付定金已全部支付

2. **存在 dep_override = 1**  
   在 `in_pmt_deposit_final` 中该订单有 `dep_override = 1` 的记录  
   (厂商减免定金、不再追缴差值等特殊情况)

### 状态定义

| 状态 | 条件 | 显示 |
|------|------|------|
| 待付款 | 定金待付 > 0 且无override | 🟡 黄色 |
| 已付清 | 定金待付 ≤ 0 或 dep_override=1 | 🟢 绿色 |

---

## 5. 数据库表结构

### in_pmt_deposit (定金支付明细表 - Mutation Log)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | INT | 自增主键 |
| `pmt_no` | VARCHAR(30) | 付款单号, 格式: `DPMT_YYYYMMDD_N##` |
| `po_num` | VARCHAR(20) | 对应订单号 |
| `dep_date` | DATE | 支付日期 (YYYY-MM-DD) |
| `dep_cur` | VARCHAR(10) | 结算货币 (RMB/USD) |
| `dep_paid_cur` | DECIMAL(10,4) | 结算汇率 |
| `dep_cur_mode` | CHAR(1) | 汇率获取方式 (A=自动/M=手动) |
| `dep_paid` | DECIMAL(15,2) | 现金支付金额 |
| `dep_prepay_amount` | DECIMAL(15,2) | 预付款抵扣金额 |
| `dep_override` | TINYINT(1) | 强制视为完成 (0/1) |
| `extra_note` | VARCHAR(200) | 额外费用备注 |
| `extra_amount` | DECIMAL(15,2) | 额外费用金额 |
| `extra_cur` | VARCHAR(10) | 额外费用货币 |
| `ops` | VARCHAR(10) | 操作类型 (new/adjust/delete) |
| `seq` | VARCHAR(10) | 版本号 D## |
| `by` | VARCHAR(50) | 操作用户 |
| `note` | TEXT | 操作备注 |
| `created_at` | TIMESTAMP | 创建时间 |

### in_pmt_deposit_final (定金支付终态表 - Resolution Snapshot)

由触发器从 `in_pmt_deposit` 同步:
- `ops = 'new'` → REPLACE INTO (插入或更新)
- `ops = 'adjust'` → REPLACE INTO
- `ops = 'delete'` → DELETE

主键: `po_num` (每个订单只有一条定金记录)

---

## 6. 付款向导流程

### Step 1: 订单确认
- 显示待付款订单清单
- 核对订单号、定金比例、定金金额
- 支持移除不需要付款的订单
- **约束**: 同一批次只能选择同一供应商的订单

### Step 2: 汇率与抵扣设置
- 选择使用订单日汇率或付款日汇率
- 开启/关闭预付款余额抵扣
- 录入额外费用（如银行手续费）
- 为特定订单设置 Override 标记（定金减免）

### Step 3: 最终确认
- 核对本次抵扣金额与现金支付金额
- 上传付款回执（可选）
- 密码验证后提交

### Step 4: 完成
- 显示生成的付款单号 `DPMT_YYYYMMDD_N##`
- 自动刷新主列表

---

## 7. 删除逻辑

### 删除定金付款记录

当需要删除一笔定金付款时:

1. **验证权限**: 需密码验证 (`deposit_payment_delete`)
2. **查找记录**: 获取 `pmt_no` 下所有 `po_num`
3. **逻辑删除**: 为每个 `po_num` 插入 `ops='delete'` 的新记录
4. **预付款恢复**: 如果该记录使用了预付款抵扣，自动恢复余额

#### 预付款恢复逻辑

```sql
-- 查找原 out 记录
SELECT * FROM in_pmt_prepay 
WHERE tran_note LIKE 'Deposit_{pmt_no}%'

-- 插入 in 记录恢复余额
INSERT INTO in_pmt_prepay (
    tran_type = 'in',
    tran_note = '删除定金付款_{原tran_note}',
    tran_amount = {原抵扣金额}
)
```

---

## 8. 安全与权限

| 操作 | Action Key | 安全级别 |
|------|-----------|---------|
| 提交付款 | `deposit_payment_submit` | L0 (密码验证) |
| 删除付款 | `deposit_payment_delete` | L0 (密码验证) |
| 上传回执 | `deposit_receipt_upload` | L0 (密码验证) |
| 删除回执 | `deposit_receipt_delete` | L0 (密码验证) |

---

## 9. 页面结构

### 主页面 (deposit-list-view)

#### 待付款区域
- 按供应商分组显示
- 支持多选并批量付款
- **约束**: 只能选择同一供应商的订单

#### 已付款区域
- 按年份筛选 (下拉框)
- 表格形式展示
- 点击可查看关联订单和文件

### 子视图

| 视图 | 功能 |
|------|------|
| deposit-wizard-view | 4步付款向导 |
| deposit-file-view | 付款回执查看/上传 |
| deposit-orders-view | 关联订单详情 |

### 自动刷新

从以下视图返回主列表时自动刷新:
- `closeDepositWizard()` - 向导关闭
- `closeDepositFileView()` - 文件视图关闭
- `closeDepositFileUploadWizard()` - 上传向导关闭
- `closeDepositOrdersView()` - 订单详情关闭

---

## 10. 与订单付款模块的关系

| 项目 | 定金付款管理 | 订单付款管理 |
|------|-------------|-------------|
| 路径 | /finance/deposit/ | /finance/po/ |
| 终态表 | in_pmt_deposit_final | in_pmt_po_final |
| 付款单号前缀 | **DPMT_** | **PPMT_** |
| 版本号前缀 | D## | P## |
| 适用订单 | cur_deposit=1 的订单 | 所有订单 |
| 前置条件 | 无 | 定金已支付 (如需) |
| 金额基础 | 订单总金额 × cur_deposit_par% | 订单总金额 - 已付定金 |
| Override 含义 | 定金减免 | 尾款减免 |
| 汇率浮动 | 不适用 | 可能触发 |

---

## 11. 业务流程图

```
┌─────────────────────────────────────────────────────────────┐
│                      订单创建                                │
│  in_po_final (SKU明细) + in_po_strategy (订单策略)           │
│  cur_deposit=1, cur_deposit_par=30%                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│               定金支付 (本模块)                              │
│                                                             │
│  输入: 订单 + 供应商预付款余额                               │
│  输出: in_pmt_deposit_final 记录                            │
│        in_pmt_prepay 抵扣记录 (如有)                        │
│  付款单号: DPMT_YYYYMMDD_N##                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      尾款支付                                │
│                   订单付款管理模块                           │
│                   付款单号: PPMT_YYYYMMDD_N##                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│               订单完成 (尾款剩余≤0 或 override)              │
└─────────────────────────────────────────────────────────────┘
```

---

## 12. 注意事项

1. **供应商约束**: 同一批次付款只能选择同一供应商的订单
2. **汇率选择**: 默认使用订单日汇率，可切换为付款日汇率
3. **预付款货币**: 抵扣金额始终按供应商结算货币记录
4. **Override**: 定金减免标记，适用于供应商优惠等特殊情况
5. **批量付款**: 同一批次订单共享一个付款单号，便于追溯
6. **自动刷新**: 从子视图返回主列表时自动刷新数据
7. **文件版本**: 同一付款单号可上传多个回执文件，自动递增版本号 (V01, V02...)
8. **删除恢复**: 删除付款记录时，已使用的预付款余额会自动恢复
