# 订收发流程 - 业务逻辑文档

> 最后更新: 2026-01-10  
> 适用模块: 采购板块、财务板块

---

## 1. 概述

本文档描述采购订单从创建到支付完成的完整生命周期，以及各流程阶段与财务付款的关系。

### 核心表结构

| 表名 | 类型 | 作用 |
|------|------|------|
| `in_po_final` | 终态表 | 订单明细（订货数量） |
| `in_send_final` | 终态表 | 发货明细（发货数量） |
| `in_receive_final` | 终态表 | 收货明细（实际入库数量） |
| `in_diff_final` | 终态表 | 收发差异（差异数量） |

---

## 2. 主键与关联规则

### 2.1 订单内货物标识

每个订单 (`po_num`) 内的货物由 **(po_sku, po_price)** 二元组唯一标识：

```
大局观: po_num 定义一个订单
细节观: (po_num, po_sku, po_price) 定义订单内的一项货物
```

### 2.2 各表主键

| 表名 | 主键/唯一标识 |
|------|--------------|
| `in_po_final` | `(po_num, po_sku, po_price)` |
| `in_send_final` | `(sent_logistic_num, po_num, po_sku, po_price)` |
| `in_receive_final` | `(logistic_num, po_num, po_sku, po_price)` |
| `in_diff_final` | `(logistic_num, po_num, po_sku)` |

---

## 3. 流程阶段

### 3.1 订单创建 (in_po_final)

订单在采购模块创建后，写入 `in_po_final` 表：

```sql
-- 关键字段
po_num          -- 订单号 (格式: XXYYYYMMDDS##)
po_sku          -- SKU编码
po_price        -- 单价
po_quantity     -- 订货数量
```

**财务意义**：
- 订单创建时，**定金费用** 即确定
- 定金 = 订单总金额 × 定金比例
- 此时可以进行定金支付（不依赖发货状态）

---

### 3.2 发货 (in_send_final)

供应商发货后，写入 `in_send_final` 表：

```sql
-- 关键字段
sent_logistic_num   -- 物流单号
po_num              -- 订单号
po_sku              -- SKU编码
po_price            -- 单价
sent_quantity       -- 发货数量
sent_date           -- 发货日期
```

**业务规则**：
- 同一订单可以分多次发货（多个物流单）
- `sent_quantity` 可能小于 `po_quantity`（部分发货）
- 只有 `sent_quantity > 0` 的记录才写入 `in_send_final`

**财务意义**：
- 发货时产生物流费用
- 物流费用在 `in_send` 表头记录

---

### 3.3 收货/入库 (in_receive_final)

货物到达仓库入库后，写入 `in_receive_final` 表：

```sql
-- 关键字段
logistic_num        -- 物流单号
po_num              -- 订单号
po_sku              -- SKU编码
po_price            -- 单价
sent_quantity       -- 发货数量（从 in_send_final 获取）
receive_quantity    -- 实际收货数量
receive_date        -- 入库日期
```

**业务规则**：
- `receive_quantity` 可能与 `sent_quantity` 不同
- 收货多于发货：可能是供应商多发、计数误差
- 收货少于发货：可能是运输损耗、漏发

---

### 3.4 差异记录 (in_diff_final)

当收货数量与发货数量不一致时，写入差异表：

```sql
-- 关键字段
logistic_num        -- 物流单号
po_num              -- 订单号
po_sku              -- SKU编码
sent_quantity       -- 发货数量
receive_quantity    -- 收货数量
diff_quantity       -- 差异数量 = sent_quantity - receive_quantity
```

**差异处理规则**：
- `diff_quantity > 0`: 少收（收货 < 发货）
- `diff_quantity < 0`: 多收（收货 > 发货）
- `diff_quantity = 0`: 差异已解决

**重要**：
- 差异解决后，`diff_quantity` 更新为 0，**保留记录**
- **不删除** `in_diff_final` 中的记录

---

## 4. 流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        订单创建                                     │
│                    in_po_final 写入                                 │
│                                                                     │
│  po_num + (po_sku, po_price) → po_quantity                         │
│                                                                     │
│  💰 此时可支付定金                                                  │
└─────────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────┐
│                          发货                                       │
│                    in_send_final 写入                               │
│                                                                     │
│  logistic_num + po_num + (po_sku, po_price) → sent_quantity        │
│                                                                     │
│  🚚 产生物流费用                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         收货/入库                                   │
│                   in_receive_final 写入                             │
│                                                                     │
│  logistic_num + po_num + (po_sku, po_price) → receive_quantity     │
│                                                                     │
│  ⚠️ 若 sent_quantity ≠ receive_quantity → 产生差异                 │
└─────────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────────┐
│                       差异处理（如有）                              │
│                    in_diff_final 写入/更新                          │
│                                                                     │
│  diff_quantity = sent_quantity - receive_quantity                  │
│                                                                     │
│  ❌ diff_quantity ≠ 0 时禁止支付尾款                               │
│  ✅ diff_quantity = 0 时可支付尾款                                 │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. 财务付款规则

### 5.1 定金付款

| 条件 | 是否可支付 |
|------|-----------|
| 订单已创建 (in_po_final 存在) | ✅ 可以 |
| 尚未发货 | ✅ 可以 |
| 存在差异 | ✅ 可以（差异不影响定金） |

**定金与发货状态无关**

---

### 5.2 尾款/订单付款

| 条件 | 是否可支付 |
|------|-----------|
| 订单已创建 | ✅ 可以 |
| 无未解决差异 (`diff_quantity = 0` 或无记录) | ✅ 可以 |
| 存在未解决差异 (`diff_quantity ≠ 0`) | ❌ **禁止** |

**关键约束**：
- 若 `in_diff_final` 中该 `po_num` 存在 `diff_quantity ≠ 0` 的记录
- 该订单 **不能进行尾款/订单付款**
- 必须先在异常处理模块解决差异

---

### 5.3 物流付款

物流费用独立于订单付款流程：
- 物流单创建时即产生费用
- 在物流财务管理模块支付
- 与订单差异状态无关

---

## 6. 订单状态判定

### 6.1 从付款角度的状态

```javascript
function getOrderPaymentStatus(po_num) {
    // 检查是否有未解决差异
    const hasDiff = existsInTable('in_diff_final', {
        po_num: po_num,
        diff_quantity: '!= 0'
    });
    
    if (hasDiff) {
        return 'blocked';  // 有差异，禁止付款
    }
    
    return 'payable';  // 可以付款
}
```

### 6.2 UI 显示建议

| 订单状态 | 说明 | 颜色 | 可否付款 |
|---------|------|------|---------|
| 正常 | 无差异或差异已解决 | 🟢 绿色 | ✅ |
| 有差异 | 存在未解决差异 | 🔴 红色 | ❌ |

---

## 7. 数量流转示例

假设订单 `PO2026010101` 订购 SKU `ABC-001`，单价 10.00，数量 100：

### 场景A：完美流程

```
in_po_final:      po_quantity = 100
in_send_final:    sent_quantity = 100
in_receive_final: receive_quantity = 100
in_diff_final:    (无记录)

→ 可正常支付
```

### 场景B：部分短缺

```
in_po_final:      po_quantity = 100
in_send_final:    sent_quantity = 100
in_receive_final: receive_quantity = 95
in_diff_final:    diff_quantity = 5 (少收5件)

→ ❌ 禁止支付，需先处理差异
```

### 场景C：差异已解决

```
in_po_final:      po_quantity = 100
in_send_final:    sent_quantity = 100
in_receive_final: receive_quantity = 95
in_diff_final:    diff_quantity = 0 (差异已处理为补发/折让)

→ ✅ 可以支付
```

---

## 8. 表字段参考

### in_po_final

| 字段 | 类型 | 说明 |
|------|------|------|
| `po_num` | VARCHAR | 订单号 |
| `po_sku` | VARCHAR | SKU编码 |
| `po_price` | DECIMAL | 单价 |
| `po_quantity` | INT | 订货数量 |
| `supplier_code` | VARCHAR | 供应商代码 |
| `po_date` | DATE | 订单日期 |

### in_send_final

| 字段 | 类型 | 说明 |
|------|------|------|
| `sent_logistic_num` | VARCHAR | 物流单号 |
| `po_num` | VARCHAR | 订单号 |
| `po_sku` | VARCHAR | SKU编码 |
| `po_price` | DECIMAL | 单价 |
| `sent_quantity` | INT | 发货数量 |
| `sent_date` | DATE | 发货日期 |

### in_receive_final

| 字段 | 类型 | 说明 |
|------|------|------|
| `logistic_num` | VARCHAR | 物流单号 |
| `po_num` | VARCHAR | 订单号 |
| `po_sku` | VARCHAR | SKU编码 |
| `po_price` | DECIMAL | 单价 |
| `sent_quantity` | INT | 发货数量 |
| `receive_quantity` | INT | 收货数量 |
| `receive_date` | DATE | 入库日期 |

### in_diff_final

| 字段 | 类型 | 说明 |
|------|------|------|
| `logistic_num` | VARCHAR | 物流单号 |
| `po_num` | VARCHAR | 订单号 |
| `po_sku` | VARCHAR | SKU编码 |
| `sent_quantity` | INT | 发货数量 |
| `receive_quantity` | INT | 收货数量 |
| `diff_quantity` | INT | 差异数量 (= sent - receive) |
| `status` | VARCHAR | 状态 (历史字段，可忽略) |

---

## 9. 注意事项

1. **差异记录保留**: `in_diff_final` 中的记录在差异解决后 `diff_quantity` 设为 0，**不删除**
2. **大局观 vs 细节观**: 付款约束基于 `po_num` 级别（大局观），但实际数据按 `(po_sku, po_price)` 粒度记录（细节观）
3. **付款不绑定发货**: 定金和尾款的支付不强制要求先发货，但差异会阻止尾款支付
4. **物流费独立**: 物流费用是独立于订单付款的另一条支付线
5. **status 字段**: `in_diff` / `in_diff_final` 中的 `status` 字段是历史设计，当前业务中可忽略，以 `diff_quantity` 判断差异状态
