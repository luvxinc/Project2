# 订单支付管理 - 业务逻辑文档

> 最后更新: 2026-01-10  
> 路径: `/dashboard/finance/po/`  
> 付款单号格式: `PPMT_YYYYMMDD_N##`

---

## 1. 核心概念

订单支付管理模块用于管理订货单的**尾款支付**。一个订单的完整支付流程为：

```
订单总金额 = 定金 + 尾款
```

其中：
- **定金** 由「定金付款管理」模块处理 (`DPMT_` 系列)
- **尾款** 由本「订单付款管理」模块处理 (`PPMT_` 系列)

---

## 2. 付款单号规范

### 2.1 格式定义

```
PPMT_YYYYMMDD_N##
│    │        │
│    │        └── 当日序号 (N01, N02, ...)
│    └─────────── 付款日期
└──────────────── PO Payment 前缀 (区别于定金的 DPMT_)
```

### 2.2 生成规则

1. **批量共享**: 同一批次提交的所有订单共享同一个 `pmt_no`
2. **当日唯一**: 以当天日期查询 `in_pmt_po` 表中 `pmt_no LIKE 'PPMT_YYYYMMDD_N%'` 的数量，+1 生成新序号
3. **不可变**: 一旦生成，付款单号不可修改

### 2.3 文件目录结构

```
/data/records/finance/po/
└── {YYYY}/                    # 年份目录
    └── {pmt_no}/              # 付款单号目录
        ├── {pmt_no}_V01.pdf   # 付款回执 V01
        ├── {pmt_no}_V02.jpg   # 付款回执 V02
        └── ...
```

---

## 3. 数据源与计算逻辑

### 3.1 订单总金额

#### 数据来源
- **明细**: `in_po_final` 表
- **策略**: `in_po_strategy` 表 (取 `seq` 最大的行为最新版本)

#### 计算公式
```
订单总金额 = SUM(po_quantity × po_price) for all SKUs in po_num
```

#### 货币与汇率处理

| 字段 | 来源表 | 说明 |
|------|--------|------|
| `cur_currency` | in_po_strategy | 结算货币 (RMB/USD) |
| `cur_usd_rmb` | in_po_strategy | 订单日汇率 |
| `cur_mode` | in_po_strategy | 汇率获取方式 (A=自动/M=手动) |
| `cur_float` | in_po_strategy | 汇率浮动开关 (0=关/1=开) |
| `cur_ex_float` | in_po_strategy | 汇率浮动阈值 (百分比) |

#### 场景分析

**场景A: 结算货币 = RMB**
- 汇率浮动对支付金额**无影响**
- 厂商始终收到固定的RMB金额
- 订单总金额为**静态值**

**场景B: 结算货币 = USD，汇率浮动关闭 (cur_float=0)**
- 按订单日价格支付，不受汇率波动影响
- 订单总金额为**静态值**

**场景C: 结算货币 = USD，汇率浮动开启 (cur_float=1)**
- 当结算日汇率与订单日汇率偏差 > `cur_ex_float` 阈值时：
  - USD价格跟随汇率变化同比例浮动
  - 目的：抵消汇率大幅波动带来的损益
- 订单总金额为**动态值**

```
示例：
- 原USD价格: 100
- 汇率浮动阈值: 2%
- 订单日汇率: 7.0000
- 结算日汇率: 7.2100 (+3%)

由于 3% > 2% (阈值)，USD价格调整为:
新USD价格 = 100 × (1 + 3%) = 103

实际支付RMB = 103 × 7.2100 = 742.63
```

---

### 3.2 已付定金

#### 数据来源
- `in_pmt_deposit_final` 表 (定金付款终态表)

#### 是否需要定金
查询 `in_po_strategy` 表 (最新seq):

| 条件 | 是否需要定金 |
|------|-------------|
| `cur_deposit = 0` | ❌ 不需要 |
| `cur_deposit = 1` AND `cur_deposit_par = 0` | ❌ 不需要 |
| `cur_deposit = 1` AND `cur_deposit_par > 0` | ✅ 需要 |

#### 定金支付状态
- **正常支付**: 实际支付 >= 定金要求
- **不足量支付**: `dep_override = 1`，厂商同意按不足量视为完成
- **超额支付**: 自动标记为定金已支付完毕

#### 计算公式
```
已付定金 = SUM(dep_paid + dep_prepay_amount) 
           FROM in_pmt_deposit_final 
           WHERE po_num = ?
```
> 需按结算货币换算

---

### 3.3 已付货款

#### 数据来源
- `in_pmt_po_final` 表 (订单付款终态表)

#### 计算公式
```
已付货款 = SUM(pmt_cash_amount + pmt_prepay_amount) 
           FROM in_pmt_po_final 
           WHERE po_num = ?
```

#### 货币换算规则

| 字段 | 说明 |
|------|------|
| `pmt_currency` | 本次支付的货币类型 |
| `pmt_cash_amount` | 现金支付金额 (按pmt_currency) |
| `pmt_fe_rate` | 本次支付的结算汇率 |
| `pmt_fe_mode` | 汇率获取方式 (A/M) |
| `pmt_prepay_amount` | 预付款抵扣金额 (按厂商结算货币) |

**换算逻辑:**
1. 预付款抵扣 (`pmt_prepay_amount`) 已按厂商结算货币记录，直接累加
2. 现金支付 (`pmt_cash_amount`):
   - 若 `pmt_currency` = 厂商结算货币 → 直接累加
   - 若 `pmt_currency` ≠ 厂商结算货币 → 按 `pmt_fe_rate` 换算后累加

---

### 3.4 汇率浮动对尾款的影响

#### 触发条件
仅当同时满足以下条件时，汇率浮动才影响尾款计算：
1. `cur_currency = 'USD'` (结算货币为美元)
2. `cur_float = 1` (汇率浮动开关已开启)
3. `|浮动百分比| > cur_ex_float` (浮动超过阈值)

#### 计算公式

```
浮动百分比 = (今日汇率 - 订单日汇率) / 订单日汇率 × 100%

判断: |浮动百分比| > cur_ex_float ?
  - 否 → 调整系数 = 1 (无调整)
  - 是 → 调整系数 = 1 + 浮动百分比
```

#### 核心规则：浮动仅影响除定金外的未付款项

```
调整后尾款 = (原订单总金额 - 已付定金) × 调整系数 - 已付货款
```

**为什么定金不受影响？**
- 定金在订货时就需支付，按当时汇率结算
- 汇率浮动发生在后续付款期间，定金已锁定

#### 示例

| 项目 | 值 |
|------|-----|
| 原订单总金额 | $1,000 |
| 已付定金 | $300 |
| 已付货款 | $200 |
| 订单日汇率 | 7.0000 |
| 今日汇率 | 7.2100 |
| 浮动阈值 | 2% |

**计算过程：**
```
浮动百分比 = (7.2100 - 7.0000) / 7.0000 × 100% = +3%
|3%| > 2% → 触发浮动调整
调整系数 = 1 + 3% = 1.03

未调整尾款 = 1000 - 300 - 200 = $500
调整后尾款 = (1000 - 300) × 1.03 - 200 = 700 × 1.03 - 200 = 721 - 200 = $521
```

**结果：** 因汇率上涨3%，需多支付 $21

---

### 3.5 尾款剩余

#### 基础计算公式 (无浮动)
```
尾款剩余 = 订单总金额 - 已付定金 - 已付货款
```

#### 含浮动调整的公式 (当触发浮动时)
```
尾款剩余 = (订单总金额 - 已付定金) × 调整系数 - 已付货款
```

> 所有金额均已换算为厂商结算货币

---

## 4. 订单支付状态判断

### 判断逻辑
一个订单被视为**支付完成**的条件 (满足其一即可):

1. **尾款剩余 ≤ 0**  
   所有应付款项已全部支付

2. **存在 pmt_override = 1**  
   在 `in_pmt_po_final` 中该订单有 `pmt_override = 1` 的记录  
   (厂商减免、不再追缴差值等特殊情况)

### 状态定义

| 状态 | 条件 | 显示 |
|------|------|------|
| 待付款 | 尾款剩余 > 0 且无override | 🟡 黄色 |
| 部分付款 | 已付货款 > 0 但尾款剩余 > 0 | 🔵 蓝色 |
| 已完成 | 尾款剩余 ≤ 0 或 pmt_override=1 | 🟢 绿色 |

### 4.5 订单状态与差异阻止

待付清单中每个订单会显示其**订单状态**，用于告知用户当前货物单在采购流程中的情况。

#### 订单状态判定

从 `in_diff_final` 表查询该订单是否存在未解决差异：

```sql
SELECT COUNT(*) as diff_count 
FROM in_diff_final 
WHERE po_num = ? AND diff_quantity != 0
```

| 条件 | 订单状态 | 可否付款 |
|------|---------|---------|
| `diff_count = 0` | 🟢 正常 | ✅ 可选择 |
| `diff_count > 0` | 🔴 有差异 | ❌ 禁止选择 |

#### 差异阻止规则

当订单存在未解决差异时：
1. 订单行显示为灰色（`opacity: 0.7`）
2. 点击时弹出 **GlobalModal** 警告
3. 无法被选中进行批量付款
4. 全选按钮自动跳过该订单

**警告内容**：
> 订单 {po_num} 存在未解决的收发差异  
> 请先在**采购板块 → 入库异常处理**中解决差异问题后再进行付款

---

## 5. 数据库表结构

### in_pmt_po (订单付款明细表 - Mutation Log)

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | INT | 自增主键 |
| `pmt_no` | VARCHAR(30) | 付款单号, 格式: `PPMT_YYYYMMDD_N##` |
| `po_num` | VARCHAR(20) | 对应订单号 |
| `pmt_date` | DATE | 付款日期 (YYYY-MM-DD) |
| `pmt_currency` | VARCHAR(10) | 付款货币 (RMB/USD) |
| `pmt_cash_amount` | DECIMAL(15,2) | 现金支付金额 |
| `pmt_fe_rate` | DECIMAL(10,4) | 结算汇率 |
| `pmt_fe_mode` | CHAR(1) | 汇率获取方式 (A=自动/M=手动) |
| `pmt_prepay_amount` | DECIMAL(15,2) | 预付款抵扣金额 |
| `pmt_override` | TINYINT(1) | 强制视为完成 (0/1) |
| `extra_note` | VARCHAR(200) | 额外费用备注 |
| `extra_amount` | DECIMAL(15,2) | 额外费用金额 |
| `extra_currency` | VARCHAR(10) | 额外费用货币 |
| `ops` | VARCHAR(10) | 操作类型 (new/adjust/delete) |
| `seq` | VARCHAR(10) | 版本号 P## |
| `by` | VARCHAR(50) | 操作用户 |
| `note` | TEXT | 操作备注 |
| `created_at` | TIMESTAMP | 创建时间 |

### in_pmt_po_final (订单付款终态表 - Resolution Snapshot)

由触发器从 `in_pmt_po` 同步:
- `ops = 'new'` → REPLACE INTO (插入或更新)
- `ops = 'adjust'` → REPLACE INTO
- `ops = 'delete'` → DELETE

主键: `(pmt_no, po_num)` 复合唯一索引

---

## 6. 付款向导流程

### Step 1: 订单确认
- 显示待付款订单清单
- 核对订单号、金额、汇率
- 支持移除不需要付款的订单

### Step 2: 汇率与抵扣设置
- 选择使用订单日汇率或付款日汇率
- 开启/关闭预付款余额抵扣
- 录入额外费用（如银行手续费）
- 为特定订单设置 Override 标记

### Step 3: 最终确认
- 核对本次抵扣金额与现金支付金额
- 上传付款回执（可选）
- 密码验证后提交

### Step 4: 完成
- 显示生成的付款单号 `PPMT_YYYYMMDD_N##`
- 自动刷新主列表

---

## 7. 安全与权限

| 操作 | Action Key | 安全级别 |
|------|-----------|---------|
| 提交付款 | `po_payment_submit` | L0 (密码验证) |
| 删除付款 | `po_payment_delete` | L0 (密码验证) |
| 上传回执 | `po_receipt_upload` | L0 (密码验证) |
| 删除回执 | `po_receipt_delete` | L0 (密码验证) |

---

## 8. 与定金模块的关系

| 项目 | 定金付款管理 | 订单付款管理 |
|------|-------------|-------------|
| 路径 | /finance/deposit/ | /finance/po/ |
| 终态表 | in_pmt_deposit_final | in_pmt_po_final |
| 付款单号前缀 | **DPMT_** | **PPMT_** |
| 适用订单 | cur_deposit=1 的订单 | 所有订单 |
| 前置条件 | 无 | 定金已支付 (如需) |
| 金额基础 | 订单总金额 × cur_deposit_par% | 订单总金额 - 已付定金 |
| Override 含义 | 定金减免 | 尾款减免 |

---

## 9. 注意事项

1. **汇率一致性**: 所有金额计算均需换算为厂商结算货币
2. **版本控制**: 策略表取 `seq` 最大行，即最新版本
3. **浮动阈值**: USD结算且开启浮动时，超过阈值订单金额会动态调整
4. **抵扣货币**: 预付款抵扣金额始终按厂商结算货币记录
5. **Override**: 是供应商给予的减免/优惠，标记后视为订单完成
6. **批量付款**: 同一批次订单共享一个付款单号，便于追溯
7. **自动刷新**: 从子视图返回主列表时自动刷新数据
