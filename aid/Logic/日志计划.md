# 企业级日志系统设计规划

> **Purpose**: 此文件定义 MGMT ERP 的企业级全量日志系统架构设计
> **AI Attention**: 实现日志功能时，必须严格遵循本文档的架构和规范
> **Version**: V2.0 已实施
> **Last Updated**: 2026-01-11
> **Status**: ✅ 已实施（Phase 1-4 完成）

---

## 一、设计目标

### 核心原则

```
1. 完整性 - 任何操作都不能逃脱记录
2. 自动化 - 日志记录不依赖业务代码
3. 零维护 - 日志生命周期自动管理
4. 可追溯 - 任何问题 3 分钟内定位根因
```

### 具体目标

| 目标 | 描述 |
|------|------|
| **全量捕获** | 错误、访问、业务操作、安全审计全覆盖 |
| **自动记录** | Middleware + Signals，业务代码零侵入 |
| **结构化存储** | 数据库表存储，支持复杂查询和统计 |
| **智能过滤** | 过滤噪音，只记录有价值的信息 |
| **开发模式** | 开发日志隔离，发布前一键清理 |
| **自动清理** | 按保留策略自动清理过期日志 |

---

## 二、四表架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      MGMT 日志系统四表架构                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────────┐                                               │
│   │  1. log_error   │  ❌ 错误日志                                   │
│   │    (全量记录)   │  • 所有异常，无过滤                            │
│   │                 │  • 完整堆栈、请求上下文、局部变量              │
│   │                 │  • 保留周期: 永久                              │
│   └─────────────────┘                                               │
│                                                                      │
│   ┌─────────────────┐                                               │
│   │  2. log_audit   │  🔒 安全审计                                   │
│   │   (全量记录)    │  • 登录/权限/删除/敏感操作                     │
│   │                 │  • 变更前后状态完整记录                        │
│   │                 │  • 保留周期: 永久                              │
│   └─────────────────┘                                               │
│                                                                      │
│   ┌─────────────────┐                                               │
│   │ 3. log_business │  📋 业务操作                                   │
│   │  (有价值操作)   │  • 创建/修改/删除/提交                         │
│   │                 │  • 过滤: 查看、列表、刷新                       │
│   │                 │  • 保留周期: 90 天                             │
│   └─────────────────┘                                               │
│                                                                      │
│   ┌─────────────────┐                                               │
│   │  4. log_access  │  🌐 访问日志                                   │
│   │  (精简记录)     │  • 只记录: 写操作、错误响应、登录              │
│   │                 │  • 过滤: 静态资源、成功 GET、轮询              │
│   │                 │  • 保留周期: 30 天                             │
│   └─────────────────┘                                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、表结构设计

### 3.1 log_error - 错误日志

**用途**: 记录所有系统异常，支持问题追溯和定位

**触发方式**: 全自动（GlobalExceptionMiddleware）

```sql
CREATE TABLE log_error (
    id                  BIGINT PRIMARY KEY AUTO_INCREMENT,
    created_at          DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    
    -- 链路追踪
    trace_id            VARCHAR(36) NOT NULL,
    
    -- 身份信息
    user                VARCHAR(64) DEFAULT 'System',
    ip                  VARCHAR(45),
    user_agent          VARCHAR(512),
    session_id          VARCHAR(64),
    
    -- 请求上下文
    http_method         VARCHAR(8),
    request_path        VARCHAR(512),
    query_params        TEXT,
    request_body        LONGTEXT,
    request_headers     TEXT,
    content_type        VARCHAR(128),
    
    -- 错误信息
    error_type          VARCHAR(256) NOT NULL,
    error_message       TEXT NOT NULL,
    error_code          VARCHAR(32),
    
    -- 完整堆栈
    traceback_full      LONGTEXT,
    
    -- 位置信息
    file_path           VARCHAR(512),
    function_name       VARCHAR(128),
    line_number         INT,
    module_name         VARCHAR(128),
    
    -- 上下文变量
    local_variables     LONGTEXT,
    
    -- 分类
    severity            ENUM('CRITICAL','HIGH','MEDIUM','LOW') DEFAULT 'HIGH',
    category            VARCHAR(64),
    
    -- 管理字段
    is_resolved         BOOLEAN DEFAULT FALSE,
    resolved_by         VARCHAR(64),
    resolved_at         DATETIME,
    resolution_note     TEXT,
    
    -- 开发模式标记
    dev_mode            BOOLEAN DEFAULT FALSE,
    
    -- 聚合
    error_hash          VARCHAR(64),
    
    INDEX idx_trace (trace_id),
    INDEX idx_time (created_at),
    INDEX idx_severity (severity, is_resolved),
    INDEX idx_path (request_path),
    INDEX idx_dev (dev_mode)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.2 log_audit - 安全审计

**用途**: 记录敏感操作，满足合规要求

**触发方式**: 自动（Django Signals）+ 装饰器

**审计范围**:

| 必须审计 | 动作 |
|---------|------|
| 认证 | 登录成功/失败、登出、密码修改 |
| 授权 | 权限变更、角色分配 |
| 用户管理 | 用户创建/删除/锁定 |
| 数据删除 | 任何 DELETE 操作 |
| 批量操作 | 批量导出、数据清理 |
| 系统配置 | 安全策略变更 |

```sql
CREATE TABLE log_audit (
    id                  BIGINT PRIMARY KEY AUTO_INCREMENT,
    created_at          DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    
    -- 链路追踪
    trace_id            VARCHAR(36) NOT NULL,
    event_id            VARCHAR(16),
    
    -- 操作人
    actor_id            INT,
    actor_username      VARCHAR(64) NOT NULL,
    actor_role          VARCHAR(32),
    actor_ip            VARCHAR(45),
    
    -- 操作详情
    action              VARCHAR(64) NOT NULL,
    action_category     ENUM('AUTH','AUTHZ','DATA','CONFIG','ADMIN'),
    
    -- 操作目标
    target_type         VARCHAR(64),
    target_id           VARCHAR(128),
    target_name         VARCHAR(256),
    
    -- 变更详情
    before_state        JSON,
    after_state         JSON,
    change_summary      VARCHAR(512),
    
    -- 结果
    result              ENUM('SUCCESS','DENIED','FAILED') NOT NULL,
    deny_reason         VARCHAR(256),
    fail_reason         VARCHAR(256),
    
    -- 风险标记
    risk_level          ENUM('CRITICAL','HIGH','MEDIUM','LOW') DEFAULT 'MEDIUM',
    
    -- 合规字段
    log_type            ENUM('REGULAR','PERMANENT') DEFAULT 'REGULAR',
    
    -- 开发模式
    dev_mode            BOOLEAN DEFAULT FALSE,
    
    INDEX idx_trace (trace_id),
    INDEX idx_time (created_at),
    INDEX idx_actor (actor_username, created_at),
    INDEX idx_action (action),
    INDEX idx_dev (dev_mode)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.3 log_business - 业务操作

**用途**: 记录有价值的业务操作

**触发方式**: 自动（Django Signals）+ 装饰器

**记录范围**:

| 记录 ✅ | 不记录 ❌ |
|--------|----------|
| 创建订单 | 查看订单 |
| 修改订单 | 列表查询 |
| 删除订单 | 筛选操作 |
| 上传文件 | 下载预览 |
| 确认入库 | 刷新页面 |
| 付款提交 | 切换 Tab |
| 状态变更 | 自动保存草稿 |

```sql
CREATE TABLE log_business (
    id                  BIGINT PRIMARY KEY AUTO_INCREMENT,
    created_at          DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    
    -- 链路追踪
    trace_id            VARCHAR(36) NOT NULL,
    event_id            VARCHAR(16),
    
    -- 操作人
    user                VARCHAR(64) NOT NULL,
    ip                  VARCHAR(45),
    
    -- 业务上下文
    module              VARCHAR(32) NOT NULL,
    page_path           VARCHAR(256),
    
    -- 操作详情
    action              VARCHAR(64) NOT NULL,
    target_type         VARCHAR(64),
    target_id           VARCHAR(128),
    
    -- 内容
    summary             VARCHAR(256) NOT NULL,
    details             JSON,
    
    -- 状态
    status              ENUM('SUCCESS','FAILED') NOT NULL,
    duration_ms         INT,
    
    -- 开发模式
    dev_mode            BOOLEAN DEFAULT FALSE,
    
    INDEX idx_trace (trace_id),
    INDEX idx_time (created_at),
    INDEX idx_user (user, created_at),
    INDEX idx_module (module, action),
    INDEX idx_dev (dev_mode)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.4 log_access - 访问日志

**用途**: 记录 HTTP 请求（精简版）

**触发方式**: 全自动（AccessLogMiddleware）

**记录规则**:

| 记录 ✅ | 不记录 ❌ |
|--------|----------|
| POST/PUT/DELETE | GET 成功请求 |
| 4xx/5xx 响应 | 静态资源 |
| 登录相关 | 健康检查 |
| 慢请求 (>3s) | 轮询接口 |

```sql
CREATE TABLE log_access (
    id                  BIGINT PRIMARY KEY AUTO_INCREMENT,
    created_at          DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    
    -- 链路追踪
    trace_id            VARCHAR(36) NOT NULL,
    
    -- 身份
    user                VARCHAR(64),
    ip                  VARCHAR(45) NOT NULL,
    user_agent          VARCHAR(512),
    
    -- 请求
    method              VARCHAR(8) NOT NULL,
    path                VARCHAR(512) NOT NULL,
    query_string        VARCHAR(1024),
    request_size        INT,
    
    -- 响应
    status_code         INT NOT NULL,
    response_size       INT,
    response_time_ms    INT NOT NULL,
    
    -- 开发模式
    dev_mode            BOOLEAN DEFAULT FALSE,
    
    INDEX idx_time (created_at),
    INDEX idx_path (path),
    INDEX idx_status (status_code),
    INDEX idx_slow (response_time_ms),
    INDEX idx_dev (dev_mode)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 四、自动化机制

### 4.1 自动记录（零侵入）

```
┌─────────────────────────────────────────────────────────────────────┐
│                        请求生命周期自动日志                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   HTTP Request                                                       │
│        │                                                             │
│        ▼                                                             │
│   ┌────────────────────────────────────────────────────────────┐    │
│   │  AccessLogMiddleware                                        │    │
│   │  • 记录请求开始                                             │    │
│   │  • 生成 trace_id                                            │    │
│   └────────────────────────────────────────────────────────────┘    │
│        │                                                             │
│        ▼                                                             │
│   ┌────────────────────────────────────────────────────────────┐    │
│   │  GlobalExceptionMiddleware                                  │    │
│   │  • 捕获所有未处理异常                                       │    │
│   │  • 自动写入 log_error                                       │    │
│   └────────────────────────────────────────────────────────────┘    │
│        │                                                             │
│        ▼                                                             │
│   ┌─────────────────┐   ┌─────────────────┐                         │
│   │   View 层        │──▶│   Service 层    │                         │
│   │                  │   │                 │                         │
│   │  Django Signals  │   │  Django Signals │                         │
│   │  自动记录 CRUD   │   │  自动记录 CRUD  │                         │
│   └─────────────────┘   └─────────────────┘                         │
│        │                                                             │
│        ▼                                                             │
│   ┌────────────────────────────────────────────────────────────┐    │
│   │  AccessLogMiddleware (响应阶段)                             │    │
│   │  • 计算响应时间                                             │    │
│   │  • 过滤后写入 log_access                                    │    │
│   └────────────────────────────────────────────────────────────┘    │
│        │                                                             │
│        ▼                                                             │
│   HTTP Response                                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 自动捕获范围

| 日志类型 | 自动化程度 | 实现方式 |
|---------|-----------|---------|
| log_error | 100% | GlobalExceptionMiddleware |
| log_access | 100% | AccessLogMiddleware |
| log_audit (登录) | 100% | Django auth signals |
| log_audit (删除) | 100% | post_delete signal |
| log_audit (敏感操作) | 装饰器 | @audit_action 装饰器 |
| log_business (CRUD) | 100% | post_save/post_delete signals |
| log_business (复杂) | 装饰器 | @log_action 装饰器 |

### 4.3 开发模式

**配置**:
```python
# settings.py
LOG_DEV_MODE = os.getenv('LOG_DEV_MODE', 'false').lower() == 'true'
```

**工作流**:
```bash
# 开发阶段
export LOG_DEV_MODE=true
# → 所有日志标记 dev_mode=true

# 发布前清理
python manage.py clear_dev_logs --confirm
# → 删除所有 dev_mode=true 的日志

# 正式上线
export LOG_DEV_MODE=false
# → 后续日志 dev_mode=false（永久保留）
```

### 4.4 自动维护

**定时任务**:
```bash
# 每天凌晨 3 点执行
0 3 * * * python manage.py log_maintenance
```

**维护内容**:
| 操作 | 周期 | 说明 |
|------|------|------|
| 清理 log_access | 每天 | 删除 30 天前 |
| 清理 log_business | 每天 | 删除 90 天前 |
| 归档 log_error | 每月 | 1 年后移至归档表 |
| 归档 log_audit | 每月 | 1 年后移至归档表 |

---

## 五、空间估算

### 日志量预估

| 日志表 | 每日条数 | 每条大小 | 每日空间 |
|-------|---------|---------|---------|
| log_error | ~20 | ~2 KB | ~40 KB |
| log_audit | ~100 | ~500 B | ~50 KB |
| log_business | ~300 | ~500 B | ~150 KB |
| log_access | ~500 | ~300 B | ~150 KB |
| **总计** | ~920 | - | **~400 KB** |

### 年度空间

| 周期 | 累计空间 |
|------|---------|
| 1 年 | ~200 MB |
| 3 年 | ~500 MB |
| 5 年 | ~800 MB |

---

## 六、实施计划

### Phase 1: 基础架构 ✅ COMPLETED (2026-01-11)
- [x] 创建 4 个日志表
- [x] 实现 GlobalExceptionMiddleware
- [x] 实现 AccessLogMiddleware
- [x] 实现 LogService 服务层

### Phase 2: 自动记录 ✅ COMPLETED (2026-01-11)
- [x] 配置 Django Signals 自动捕获
- [x] 实现 @audit_action 装饰器
- [x] 实现 @log_action 装饰器
- [x] 实现 dev_mode 标记机制

### Phase 3: 维护机制 ✅ COMPLETED (2026-01-11)
- [x] 实现 log_maintenance 命令
- [x] 实现 clear_dev_logs 命令
- [ ] 配置定时任务（需生产部署时配置）

### Phase 4: 迁移与清理 ✅ COMPLETED (2026-01-11)
- [x] 删除旧日志文件 (app.log/audit.log/error.log)
- [x] 删除旧日志系统代码 (替换为兼容层)
- [ ] 更新日志查看 UI (后续迭代)

---

## 七、涉及文件清单

### 新增文件

| 路径 | 用途 |
|------|------|
| `backend/apps/log/__init__.py` | 日志 App |
| `backend/apps/log/models.py` | 4 个日志 Model |
| `backend/apps/log/services.py` | 日志服务层 |
| `backend/apps/log/signals.py` | Django 信号处理 |
| `backend/apps/log/decorators.py` | 装饰器 |
| `backend/core/middleware/exception.py` | 异常捕获中间件 |
| `backend/core/middleware/access.py` | 访问日志中间件 |
| `backend/apps/log/management/commands/log_maintenance.py` | 维护命令 |
| `backend/apps/log/management/commands/clear_dev_logs.py` | 清理命令 |

### 修改文件

| 路径 | 修改内容 |
|------|---------|
| `backend/common/settings.py` | 添加 LOG_DEV_MODE 配置 |
| `backend/django_config/settings.py` | 注册中间件 |

### 废弃文件

| 路径 | 说明 |
|------|------|
| `backend/core/sys/logger.py` | 旧日志系统（保留兼容） |
| `backend/apps/audit/core/*.py` | 旧审计系统（保留兼容） |

---

## 八、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| V1.0 | 2025-12 | 三文件架构 (app.log/audit.log/error.log) |
| V2.0 | 2026-01-11 | 设计全新四表数据库架构 |
