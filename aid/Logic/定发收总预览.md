# 定发收总预览 - 业务逻辑文档

> 最后更新: 2026-01-10  
> 路径: `/dashboard/finance/flow/`

---

## 1. 功能概述

**定发收总预览** 提供订单全生命周期的汇总视图，整合了：
- 订单金额与策略
- 定金支付状态
- 货款支付状态
- 物流费用摊销
- 额外费用汇总
- 发货/收货状态

### 核心价值
一站式查看订单的完整成本结构，包括货款、物流摊销和各类额外费用。

---

## 2. 数据源

| 数据项 | 来源表 | 关联字段 |
|--------|--------|----------|
| 订单信息 | `in_po_final` | `po_num` |
| 策略信息 | `in_po_strategy` | `po_num`, `seq` (取最大) |
| 定金支付 | `in_pmt_deposit_final` | `po_num` |
| 货款支付 | `in_pmt_po_final` | `po_num` |
| 发货明细 | `in_send_final` | `po_num`, `sent_logistic_num` |
| 物流信息 | `in_send` | `logistic_num`, `seq` (取最大) |
| 物流付款 | `in_pmt_logistic_final` | `logistic_num` |
| 收货信息 | `in_receive_final` | `po_num`, `logistic_num` |
| 差异信息 | `in_diff_final` | `po_num` |
| SKU重量 | `Data_COGS` | `SKU`, `Weight` |

---

## 3. 列字段说明

### 3.1 订单号
- 来源: `in_po_final.po_num`

### 3.2 订单总金额
- 计算: `SUM(po_quantity × po_price)` from `in_po_final`
- 货币: 来自 `in_po_strategy.cur_currency`
- 显示: 主显示 USD，若原货币非 USD 则下方显示原货币

### 3.3 定金状态
- 若 `cur_deposit = 0` 或 `cur_deposit_par = 0`: 显示 "无定金需求"
- 若需定金:
  - 显示应付定金金额 (`订单总金额 × 定金比例`)
  - 显示支付状态: 待付款 / 部分付款 / 已付清 / 已减免

### 3.4 已付货款
- 来源: `in_pmt_po_final`
- 计算: `SUM(pmt_cash_amount + pmt_prepay_amount)`
- 需按汇率转换为 USD

### 3.5 货款剩余
```
货款剩余 = 订单总金额(USD) - 已付定金(USD) - 已付货款(USD)
```

### 3.6 订单实际支付金额
```
实际支付 = 已付定金 + 已付货款
```

### 3.7 额外费用
汇总三类额外费用:
1. **定金额外费用**: `in_pmt_deposit_final.extra_amount`
2. **货款额外费用**: `in_pmt_po_final.extra_amount`
3. **物流额外费用**: `in_pmt_logistic_final.extra_paid`

**摊销规则**: 
- 物流额外费用按该物流单下的订单数量平均分摊
- 定金/货款额外费用直接归属订单

### 3.8 发货单号
- 来源: `in_send_final.sent_logistic_num`
- 一个订单可能对应多个物流单
- 每个物流单号用独立的 TAG 展示

### 3.9 订单物流重量
**计算步骤**:
1. 从 `in_send_final` 获取该订单的发货明细 (`po_num`, `po_sku`, `sent_quantity`)
2. 从 `Data_COGS` 获取 SKU 重量 (`Weight`, 单位: 克)
3. 计算: `Σ(sent_quantity × Weight) / 1000` (转换为 KG)

### 3.10 订单物流摊销
**按重量比例摊销物流费**:
```
每个物流单的摊销 = 物流单总价(USD) × (订单在该物流单的重量 / 物流单总重量)
订单物流摊销 = Σ(各物流单的摊销)
```

其中:
- 物流单总价: `in_send.total_price` (RMB) → 转 USD
- 物流单总重: `in_send.total_weight` (KG)
- 订单在物流单的重量: 由 SKU 发货数量和 SKU 重量计算得出

### 3.11 订单总成本
```
订单总成本 = 订单实际支付金额 + 额外费用 + 订单物流摊销
```

### 3.12 订单状态
| 条件 | 状态 |
|------|------|
| 无发货记录 | 待发货 |
| 部分物流单已收货 | 部分收货 |
| 全部物流单已收货，无差异 | 已收货 |
| 全部物流单已收货，有差异 | 已收货(有差异) |
| 有发货记录但无收货记录 | 已发货 |

### 3.13 付款状态
分三部分展示:
- **定金**: ✅ (已付/无需) / 🟡 (部分) / ❌ (未付)
- **货款**: ✅ (已付清) / 🟡 (部分) / ❌ (未付)
- **物流**: ✅ (全部已付) / ❌ (有未付)

---

## 4. 展开详情

点击展开按钮后，显示该订单在每个物流单中的详情:

| 字段 | 说明 |
|------|------|
| 物流单号 | `logistic_num` |
| 发货日期 | `in_send.date_sent` |
| 预计到达 | `in_send.date_eta` |
| 物流单总重 | `in_send.total_weight` (KG) |
| 物流单总价 | `in_send.total_price` → USD |
| 订单重量 | 该订单在此物流单的 SKU 重量汇总 |
| 重量占比 | 订单重量 / 物流单总重 × 100% |
| 摊销费用 | 物流单总价 × 重量占比 |
| 收货状态 | 是否有 `in_receive_final` 记录 |
| 付款状态 | `in_pmt_logistic_final` 是否已付 |

---

## 5. 货币处理规则

### 5.1 显示规范
- **主货币**: 全部以 USD 为主显示
- **附加显示**: 若原货币非 USD，在下方显示原货币金额
- **货币标签**: 所有金额必须带货币 TAG (USD 绿色, RMB 蓝色)

### 5.2 汇率转换
- 使用订单策略中的 `cur_usd_rmb` 汇率
- 物流费用使用 `in_send.usd_rmb` 汇率

---

## 6. API 接口

### 6.1 列表接口
```
GET /dashboard/finance/flow/api/list/
Response: {
    success: boolean,
    data: [OrderFlowItem],
    count: number
}
```

### 6.2 详情接口
```
GET /dashboard/finance/flow/api/detail/?po_num={po_num}
Response: {
    success: boolean,
    data: [LogisticsDetail],
    count: number
}
```

---

## 7. 注意事项

1. **重量单位**: `Data_COGS.Weight` 是克 (g)，`in_send.total_weight` 是千克 (KG)
2. **额外费用摊销**: 物流额外费用按订单数量分摊，不按重量
3. **差异状态**: 来自 `in_diff_final`，`diff_quantity ≠ 0` 表示有未解决差异
4. **性能考虑**: 该页面涉及多表联查，大数据量时可能需要分页优化
