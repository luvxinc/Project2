# 模块日志审计报告

> **审计日期**: 2026-01-12
> **审计范围**: 全平台业务模块异常/错误捕捉进入 log_error 表的完整性
> **系统版本**: V7.0 企业级审计日志系统
> **审计状态**: ✅ 全部模块已审计

---

## 一、日志基础设施状态

### 1.1 核心组件部署状态

| 组件 | 状态 | 位置 | 说明 |
|------|------|------|------|
| **GlobalExceptionMiddleware** | ✅ 已注册 | `django_config/settings.py:90` | 自动捕获穿透View层的异常 |
| **AccessLogMiddleware** | ✅ 已注册 | `django_config/settings.py:87` | 自动记录HTTP访问日志 |
| **LogErrorService** | ✅ 已部署 | `apps/log/services.py` | 错误日志写入服务 |
| **LogAuditService** | ✅ 已部署 | `apps/log/services.py` | 安全审计日志服务 |
| **LogBusinessService** | ✅ 已部署 | `apps/log/services.py` | 业务操作日志服务 |
| **Django Signals** | ✅ 已配置 | `apps/log/signals.py` | 认证事件+模型变更自动审计 |
| **兼容层** | ✅ 已部署 | `core/sys/logger.py` | NullLoggerAdapter (旧API兼容) |

### 1.2 数据库4表架构

| 表名 | 用途 | 触发方式 | 保留周期 |
|------|------|---------|---------|
| `log_error` | 系统异常/错误 | 全自动 (中间件) + 手动调用 | 永久 |
| `log_audit` | 安全敏感操作 | 自动 (Signal) + 装饰器 | 永久 |
| `log_business` | 业务操作追踪 | 自动 (Signal) + 装饰器 | 90天 |
| `log_access` | HTTP请求日志 | 全自动 (中间件) | 30天 |

---

## 二、异常捕获机制分析

### 2.1 中间件级别 (全自动)

**GlobalExceptionMiddleware 工作原理**:
```
请求 → View 处理 → 异常抛出 → GlobalExceptionMiddleware 捕获
                              ↓
                    LogErrorService.create_from_exception()
                              ↓
                    写入 log_error 表 + 返回友好响应
```

**覆盖范围**: 
- ✅ 所有穿透到中间件层的未处理异常
- ❌ 被View内部try-except捕获并返回JsonResponse的异常

### 2.2 业务模块级别

**典型代码模式**:
```python
except Exception as e:
    logger.exception("操作失败")  # 只打印到控制台
    return JsonResponse({'success': False, 'message': ...}, status=500)
```

**问题**: 异常被捕获后直接返回，**不会触发GlobalExceptionMiddleware**，导致:
- ❌ 不会写入 log_error 数据库表
- ❌ 错误仪表盘无法看到这类异常
- ⚠️ 只能通过服务器控制台日志追踪

---

## 三、异常捕获完整性分析

### 3.1 视图函数分类

经统计，业务视图函数分为两类：

| 类型 | 定义 | 异常处理方式 | 入库状态 | 需要修复 |
|------|------|-------------|---------|---------|
| **穿透型** | 无 try-except 的简单视图 | 异常穿透到 GlobalExceptionMiddleware | ✅ 自动入库 | 否 |
| **内捕型** | 有 try-except 的复杂视图 | 异常被捕获后返回 JsonResponse | ❌ 不入库 | **是** |

### 3.2 穿透型视图清单（✅ 已自动覆盖，无需修复）

以下视图函数**没有** try-except，异常会自动被中间件捕获并写入 `log_error`：

| 模块 | 函数 | 功能 |
|------|------|------|
| Purchase | `purchase_hub` | Hub页面渲染 |
| Purchase | `po_add_page` | 新建PO页面 |
| Purchase | `po_mgmt_page` | PO管理页面 |
| Purchase | `send_add_page` | 新建发货单页面 |
| Purchase | `send_mgmt_page` | 发货单管理页面 |
| Purchase | `receive_page` | 收货页面 |
| Purchase | `receive_mgmt_page` | 收货管理页面 |
| Purchase | `abnormal_page` | 异常处理页面 |
| Purchase | `supplier_add_page` | 供应商新增页面 |
| Purchase | `supplier_strategy_page` | 供应商策略页面 |
| Purchase | `check_supplier_code_exists` | 供应商代码校验 |
| Purchase | `supplier_list_api` | 供应商列表 |
| Finance | `deposit_page` | 定金管理页面 |
| Finance | `prepay_page` | 预付款页面 |
| Finance | `logistic_page` | 物流结算页面 |
| Finance | `po_page` | PO付款页面 |
| Finance | `flow_page` | 流水页面 |
| Finance | `check_payment_files_api` | 付款文件检查 |
| Finance | `get_payment_files_api` | 获取付款文件 |
| Inventory | `shelf_page` | 货架管理页面 |
| Inventory | `dynamic_inv_page` | 动态库存页面 |

> **穿透型视图总数**: 约 **21 个**，异常会自动写入 `log_error`。

### 3.3 内捕型视图统计（❌ 需要修复）

| 模块 | 视图函数总数 | 穿透型 | 内捕型 | 内捕占比 | 待修复数 |
|------|-------------|--------|--------|---------|---------|
| Purchase | 99 | 21 | 78 | 79% | 78 |
| Finance | 61 | 3 | 58 | 95% | 58 |
| Core Services | 45 | 0 | 45 | 100% | 45 |
| User Admin | 17 | 0 | 17 | 100% | 17 |
| ETL | 15 | 0 | 15 | 100% | 15 |
| Audit (Legacy) | 8 | 0 | 8 | 100% | 8 |
| Inventory | 6 | 2 | 6 | 75% | 6 |
| Products | 5 | 0 | 5 | 100% | 5 |
| Reports | 4 | 0 | 4 | 100% | 4 |
| Others | 5 | 0 | 5 | - | 5 |
| **总计** | **265** | **26** | **241** | **91%** | **241** |

---

## 四、分模块审计详情

### 4.1 Purchase 模块 (采购) - 78 处内捕异常

| 子模块 | 文件 | 内捕数 | 修复状态 |
|--------|------|--------|---------|
| PO创建 - 验证 | `po_create/validation.py` | 2 | 🔴 待修复 |
| PO创建 - 模板 | `po_create/template.py` | 5 | 🔴 待修复 |
| PO创建 - 查询 | `po_create/query.py` | 3 | 🔴 待修复 |
| PO创建 - 提交 | `po_create/submit.py` | 1 | 🔴 待修复 |
| 供应商管理 | `supplier.py` | 3 | 🔴 待修复 |
| 发货单创建 | `send_create/*.py` | 8 | 🔴 待修复 |
| 发货单管理 | `send_mgmt/*.py` | 24 | 🔴 待修复 |
| 收货管理 | `receive_mgmt/*.py` | 20 | 🔴 待修复 |
| PO管理 | `po_mgmt/*.py` | 12 | 🔴 待修复 |

### 4.2 Finance 模块 (财务) - 58 处内捕异常

| 子模块 | 文件 | 内捕数 | 修复状态 |
|--------|------|--------|---------|
| 物流结算 | `logistic.py` | 2 | 🔴 待修复 |
| 物流结算API | `flow/api.py` | 3 | 🔴 待修复 |
| 定金管理 | `deposit/api.py` | 8 | 🔴 待修复 |
| 供应商预付 | `prepay/api.py` | 13 | 🔴 待修复 |
| PO付款 | `po/api.py` | 18 | 🔴 待修复 |
| 付款提交 | `payment/submit.py` | 4 | 🔴 待修复 |
| 付款历史 | `payment/history.py` | 2 | 🔴 待修复 |
| 付款文件 | `payment/file_ops.py` | 3 | 🔴 待修复 |
| Hub入口 | `views/__init__.py` | 1 | 🔴 待修复 |

### 4.3 Core Services (核心服务层) - 45 处内捕异常

| 子模块 | 文件 | 内捕数 | 修复状态 |
|--------|------|--------|---------|
| 数据管理 | `data_manager.py` | 7 | 🔴 待修复 |
| 数据库服务 | `database_service.py` | 7 | 🔴 待修复 |
| 库存服务 | `inventory/*.py` | 5 | 🔴 待修复 |
| ETL服务 | `etl/*.py` | 5 | 🔴 待修复 |
| 修正服务 | `correction.py` | 4 | 🔴 待修复 |
| 认证服务 | `auth/service.py` | 3 | 🔴 待修复 |
| 安全策略 | `security/policy_manager.py` | 3 | 🔴 待修复 |
| 其他服务 | 多个文件 | 11 | 🔴 待修复 |

### 4.4 其他模块汇总

| 模块 | 内捕数 | 修复状态 |
|------|--------|---------|
| User Admin | 17 | 🔴 待修复 |
| ETL | 15 | 🔴 待修复 |
| Audit (Legacy) | 8 | 🔴 待修复 |
| Inventory | 6 | 🔴 待修复 |
| Products | 5 | 🔴 待修复 |
| Reports | 4 | 🔴 待修复 |
| DB Admin | 1 | 🔴 待修复 |
| Sys Config | 1 | 🔴 待修复 |
| Visuals | 1 | 🔴 待修复 |

### 4.5 无需修复的模块

| 模块 | 原因 |
|------|------|
| Sales | 无异常处理代码 |
| Locking | 无异常处理代码 |
| Ordering | 无异常处理代码 |
| Log | 特殊设计，日志失败静默处理 |

---

## 五、自动覆盖场景 (无需修改)

以下场景由 V7.0 系统自动处理：

| 场景 | 触发机制 | 写入目标 |
|------|---------|---------|
| 用户登录成功 | `user_logged_in` Signal | `log_audit` |
| 用户登录失败 | `user_login_failed` Signal | `log_audit` |
| 用户登出 | `user_logged_out` Signal | `log_audit` |
| 模型删除 (审计应用) | `post_delete` Signal | `log_audit` |
| 模型保存 (业务模型) | `post_save` Signal | `log_business` |
| HTTP 写操作请求 | AccessLogMiddleware | `log_access` |
| 穿透异常 | GlobalExceptionMiddleware | `log_error` |

---

## 六、修复方案

### 6.1 标准修复模式

在每个 `except Exception` 块中添加 `LogErrorService` 调用:

```python
from apps.log.services import LogErrorService

try:
    # 业务逻辑
except Exception as e:
    # 新增: 写入 log_error 数据库表
    LogErrorService.create_from_exception(request, e, severity='HIGH')
    
    # 保持原有返回
    logger.exception("操作失败")
    return JsonResponse({'success': False, 'message': str(e)}, status=500)
```

### 6.2 装饰器方案（推荐批量修复）

创建统一装饰器，自动处理异常入库：

```python
# core/decorators/error_logging.py
from functools import wraps
from apps.log.services import LogErrorService
from django.http import JsonResponse

def log_api_errors(view_func):
    """API视图异常自动入库装饰器"""
    @wraps(view_func)
    def wrapper(request, *args, **kwargs):
        try:
            return view_func(request, *args, **kwargs)
        except Exception as e:
            LogErrorService.create_from_exception(request, e, severity='HIGH')
            return JsonResponse({
                'success': False, 
                'message': f'服务器错误: {str(e)}'
            }, status=500)
    return wrapper
```

使用方式：
```python
from core.decorators.error_logging import log_api_errors

@login_required
@log_api_errors  # 添加装饰器
def my_api_view(request):
    # 业务逻辑（无需 try-except）
    pass
```

---

## 七、修复计划

### 7.1 修复优先级

| 优先级 | 模块 | 待修复数 | 预计工时 | 理由 |
|--------|------|---------|---------|------|
| **P0** | Finance | 58 | 4h | 涉及资金操作，异常追踪最关键 |
| **P0** | Purchase | 78 | 6h | 供应链核心，异常影响大 |
| **P0** | Core Services | 45 | 3h | 底层服务，影响所有上层模块 |
| **P1** | User Admin | 17 | 1.5h | 权限变更需审计 |
| **P1** | ETL | 15 | 1h | 数据导入异常需追踪 |
| **P2** | Audit (Legacy) | 8 | 0.5h | 遗留系统兼容层 |
| **P2** | Inventory | 6 | 0.5h | 库存准确性依赖 |
| **P2** | Products | 5 | 0.5h | 产品档案维护 |
| **P3** | Reports | 4 | 0.5h | 只读模块 |
| **P3** | Others | 5 | 0.5h | DB Admin, Sys Config, Visuals |

**总计**: 241 处待修复，预计工时 ~18h

### 7.2 修复实施计划

| 阶段 | 内容 | 状态 |
|------|------|------|
| Phase 0 | 创建 `@log_api_errors` 装饰器 | 🔴 待开始 |
| Phase 1 | P0模块修复 (Finance + Purchase + Core) | 🔴 待开始 |
| Phase 2 | P1模块修复 (User Admin + ETL) | 🔴 待开始 |
| Phase 3 | P2/P3模块修复 (其余模块) | 🔴 待开始 |
| Phase 4 | 验证测试 + 二次审计 | 🔴 待开始 |

### 7.3 修复状态跟踪表

| 模块 | 文件数 | 待修复 | 已修复 | 完成率 | 状态 |
|------|--------|--------|--------|-------|------|
| Finance | 9 | 58 | 0 | 0% | 🔴 未开始 |
| Purchase | 21 | 78 | 0 | 0% | 🔴 未开始 |
| Core Services | 19 | 45 | 0 | 0% | 🔴 未开始 |
| User Admin | 6 | 17 | 0 | 0% | 🔴 未开始 |
| ETL | 1 | 15 | 0 | 0% | 🔴 未开始 |
| Audit (Legacy) | 5 | 8 | 0 | 0% | 🔴 未开始 |
| Inventory | 2 | 6 | 0 | 0% | 🔴 未开始 |
| Products | 3 | 5 | 0 | 0% | 🔴 未开始 |
| Reports | 1 | 4 | 0 | 0% | 🔴 未开始 |
| Others | 4 | 5 | 0 | 0% | 🔴 未开始 |
| **总计** | **71** | **241** | **0** | **0%** | 🔴 |

### 7.4 修复记录

| 日期 | 模块 | 文件 | 修复内容 | 执行人 |
|------|------|------|---------|-------|
| - | - | - | 待开始 | - |

---

## 八、验证方法

### 8.1 手动验证

1. 触发一个业务异常（如传入无效数据）
2. 检查 `log_error` 表是否有新记录:
```sql
SELECT * FROM log_error ORDER BY created_at DESC LIMIT 10;
```

### 8.2 自动化验证脚本

```python
# aid/audit/verify_error_logging.py
"""
验证脚本：检查业务异常是否正确写入 log_error
"""
import requests
from datetime import datetime

def test_error_logging():
    # 1. 记录当前 log_error 计数
    before_count = get_error_count()
    
    # 2. 发送会触发异常的请求
    response = requests.post('/api/test/trigger_error')
    
    # 3. 检查 log_error 计数是否增加
    after_count = get_error_count()
    
    assert after_count > before_count, "异常未写入 log_error!"
    print("✅ 验证通过: 异常已正确写入 log_error")
```

---

## 九、待办事项

- [ ] 创建统一修复装饰器 `core/decorators/error_logging.py`
- [ ] P0: 修复 Finance 模块 - 58处
- [ ] P0: 修复 Purchase 模块 - 78处
- [ ] P0: 修复 Core Services - 45处
- [ ] P1: 修复 User Admin 模块 - 17处
- [ ] P1: 修复 ETL 模块 - 15处
- [ ] P2: 修复 Audit Legacy 模块 - 8处
- [ ] P2: 修复 Inventory 模块 - 6处
- [ ] P2: 修复 Products 模块 - 5处
- [ ] P3: 修复 Reports 模块 - 4处
- [ ] P3: 修复其他模块 - 5处
- [ ] 创建自动化验证脚本
- [ ] 二次审计确认修复完成
- [ ] 更新 `aid/flow/日志.md` 到 V7.0

---

## 十、总结

### 审计结论

| 指标 | 数值 |
|------|------|
| 审计模块总数 | 27 |
| 视图函数总数 | 265 |
| 穿透型（自动入库）| 26 (10%) |
| 内捕型（待修复）| 241 (91%) |
| 预计修复工时 | ~18h |

### 核心发现

1. **V7.0 基础设施完备**: 中间件、服务、4表架构全部就位
2. **穿透型视图已覆盖**: 约26个简单视图的异常会自动入库
3. **内捕型视图缺口大**: 约241处异常被内部捕获后不入库
4. **修复方案明确**: 使用装饰器或手动添加 `LogErrorService` 调用

---

> **下次审计**: 修复完成后进行二次审计
> **维护者**: AI Agent
> **最后更新**: 2026-01-12
