# 审计日志系统开发指南

> **最后更新**: 2026-01-03
> **维护者**: AI Agent
> **系统版本**: Unified Logging System V6.0

---

## 一、系统概述

审计日志系统是 MGMT ERP 的核心可追溯性组件，负责记录所有业务操作、数据变更和系统异常。该系统基于 **三表分层架构**，确保日志的完整性、可查询性和合规性。

### 核心设计原则

1. **三表分离**: 业务日志 / 底层审计 / 系统故障，互不干扰
2. **上下文自动注入**: 用户、IP、TraceID 自动传递到深层调用
3. **标准化字段**: 统一的 ISO 日志格式，便于解析和查询
4. **日志级别语义**: INFO=成功, WARNING=敏感操作, ERROR=系统异常

---

## 二、三表架构

### 2.1 日志文件对照表

| 日志类型 | 文件路径 | Logger 名称 | 获取方式 | 用途 |
|----------|----------|-------------|----------|------|
| **业务操作日志** | `logs/app.log` | `db.audit` | `get_audit_logger()` | 记录用户业务操作 |
| **底层数据审计** | `logs/audit.log` | `db.audit` | `get_audit_logger()` | 记录 SQL 执行、快照等 |
| **系统故障监控** | `logs/error.log` | `sys.error` | `get_error_logger()` | 记录系统异常、错误堆栈 |

> **注意**: `app.log` 和 `audit.log` 使用同一个 Logger (`db.audit`)，区别在于 `app.log` 有额外的噪音过滤器。

### 2.2 日志级别使用规范

| 级别 | 方法 | 使用场景 | 进入文件 |
|------|------|----------|----------|
| `INFO` | `audit_logger.info()` | 常规成功操作（创建、修改、查询） | `app.log`, `audit.log` |
| `WARNING` | `audit_logger.warning()` | 敏感操作（删除、权限变更、安全拒绝） | `app.log`, `audit.log` |
| `ERROR` | `error_logger.error()` | 系统异常、代码错误 | `error.log` |

---

## 三、快速入门（新模块接入）

### 3.1 导入 Logger

```python
# 方式1: 模块级导入（推荐，适用于整个文件）
from core.sys.logger import get_audit_logger
audit_logger = get_audit_logger()

# 方式2: 函数内导入（适用于可选日志）
def my_action(request):
    from core.sys.logger import get_audit_logger
    audit_logger = get_audit_logger()
```

### 3.2 记录成功操作

```python
audit_logger.info(f"新建采购订单: {po_num}", extra={
    "action": "CREATE_PO",           # 动作标识（大写下划线）
    "target": po_num,                # 操作对象
    "func": "Purchase:POCreate",     # 模块:功能
    "details": f"Items: {len(items)}" # 附加信息（可选）
})
```

### 3.3 记录敏感操作（WARNING）

```python
audit_logger.warning(f"删除采购订单: {po_num}", extra={
    "action": "DELETE_PO",
    "target": po_num,
    "func": "Purchase:PODelete",
    "log_type": "Regular"  # 或 "Permanent" 表示永久保留
})
```

### 3.4 记录失败/拒绝操作

```python
audit_logger.warning("权限保存拒绝 - admin越权", extra={
    "action": "UPDATE_PERMS",
    "target": target_username,
    "status": "Failed(Permission)",     # 失败状态
    "root_cause": "Role Escalation Attempt"  # 失败原因
})
```

### 3.5 记录系统错误

```python
from core.sys.logger import get_error_logger
error_logger = get_error_logger()

try:
    # 业务逻辑
except Exception as e:
    error_logger.error(f"订单创建失败: {str(e)}", extra={
        "error_path": __file__,
        "error_func": "submit_po_api",
        "root_cause": str(e)
    })
```

---

## 四、extra 参数详解

### 4.1 必填字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `action` | str | 动作标识（大写+下划线） | `CREATE_PO`, `DELETE_USER`, `UPLOAD_FILE` |
| `target` | str | 操作对象（ID/用户名/文件名） | `XX20260101-S01`, `alice`, `contract.pdf` |

### 4.2 可选字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `func` | str | 模块:功能标识 | `Purchase:POCreate`, `UserAdmin:Delete` |
| `status` | str | 操作状态（见下表） | `Success`, `Failed(Permission)` |
| `root_cause` | str | 失败原因（仅失败时填写） | `Role Escalation Attempt` |
| `details` | str | 附加信息/变更详情 | `Items: 5, Total: ¥10000` |
| `note` | str | 备注 | `操作员备注...` |
| `log_type` | str | 留存级别 | `Regular`（常规轮替）, `Permanent`（永久保留） |
| `snapshot_id` | str | 回滚快照ID | `REF_20260103_123456` |
| `sql` | str | 执行的SQL（底层审计） | `UPDATE in_po SET...` |

### 4.3 status 状态枚举

```python
class LogStatus:
    SUCCESS = "Success"
    FAIL_PERM = "Failed(Permission)"  # 无权限
    FAIL_DATA = "Failed(Data)"        # 数据校验不通过
    FAIL_SYS = "Failed(System)"       # 系统/代码异常
    FAIL_UI = "Failed(UI)"            # 前端交互异常
    FAIL_OTHER = "Failed(Other)"      # 其他原因
```

### 4.4 log_type 留存级别

```python
class LogType:
    PERMANENT = "Permanent"  # 永久保留（删库、清空日志、核心配置变更）
    REGULAR = "Regular"      # 常规轮替
```

---

## 五、上下文自动注入

### 5.1 AuditContextManager

系统通过 `AuditContextManager` 自动注入请求上下文到日志：

```python
from apps.audit.core.context import AuditContextManager
```

**自动注入的字段**:

| 字段 | 来源 | 说明 |
|------|------|------|
| `user` | `request.user.username` | 当前登录用户 |
| `ip` | `request.META` | 客户端 IP |
| `reference` (TraceID) | `uuid.uuid4()` | 请求唯一标识 |
| `page` | `page_stack` | 页面层级路径 |
| `event_id` | 手动设置 | 事件聚合ID |

### 5.2 设置页面层级

在视图函数开头设置页面层级，用于日志中生成可读的操作路径：

```python
from apps.audit.core.context import AuditContextManager

def my_view(request):
    # 设置页面层级: "采购板块 -> 订单管理 -> 删除订单"
    AuditContextManager.set_page_hierarchy(["采购板块", "订单管理", "删除订单"])
    
    # 后续的日志会自动带上 page 字段
    audit_logger.warning("删除订单", extra={...})
```

### 5.3 设置事件ID（聚合同一业务操作的多条日志）

```python
import uuid

def complex_operation(request):
    # 生成事件ID（同一业务操作的多条日志共用）
    event_id = str(uuid.uuid4())[:8]
    AuditContextManager.set_event_id(event_id)
    
    # 这些日志会共享同一个 event_id
    audit_logger.info("步骤1: 验证数据", extra={...})
    audit_logger.info("步骤2: 写入数据库", extra={...})
    audit_logger.info("步骤3: 发送通知", extra={...})
    
    # 操作完成后清除
    AuditContextManager.clear_event_id()
```

---

## 六、完整示例

### 6.1 创建操作（成功）

```python
from core.sys.logger import get_audit_logger
from apps.audit.core.context import AuditContextManager

audit_logger = get_audit_logger()

@login_required
def create_po_api(request):
    AuditContextManager.set_page_hierarchy(["采购板块", "新建订单", "提交"])
    
    try:
        # 业务逻辑...
        po_num = "XX20260103-S01"
        
        # 记录成功
        audit_logger.info(f"新建采购订单: {po_num}", extra={
            "action": "CREATE_PO",
            "target": po_num,
            "func": "Purchase:POCreate",
            "details": f"供应商={supplier_code}, 商品数={len(items)}"
        })
        
        return JsonResponse({'success': True})
        
    except Exception as e:
        # 记录失败
        audit_logger.error(f"创建订单失败: {str(e)}", extra={
            "action": "CREATE_PO",
            "target": "N/A",
            "status": "Failed(System)",
            "root_cause": str(e)
        })
        return JsonResponse({'success': False}, status=500)
```

### 6.2 删除操作（敏感）

```python
@login_required
def delete_po_api(request):
    AuditContextManager.set_page_hierarchy(["采购板块", "订单管理", "删除"])
    
    # 权限检查...
    
    # 执行删除...
    
    # 记录敏感操作（使用 WARNING）
    audit_logger.warning(f"删除采购订单: {po_num}", extra={
        "action": "DELETE_PO",
        "target": po_num,
        "func": "Purchase:PODelete",
        "note": f"操作原因: {delete_reason}",
        "log_type": "Regular"  # 如果是永久删除，使用 "Permanent"
    })
```

### 6.3 权限拒绝操作

```python
def update_permissions(request, target_username):
    # 检查权限穿透
    if forbidden_perms:
        audit_logger.warning("权限保存拒绝 - admin越权", extra={
            "action": "UPDATE_PERMS",
            "target": target_username,
            "status": "Failed(Permission)",
            "root_cause": "Role Escalation Attempt",
            "note": f"尝试授予: {list(forbidden_perms)[:5]}"
        })
        return HttpResponse(status=403)
```

---

## 七、日志格式规范

### 7.1 app.log / audit.log 格式

```
{时间} | {TraceID} | {EventID} | {用户}/{IP} | {页面路径} | {动作} | {目标} | {状态} | {失败原因} | {消息} | {留存级别} | {备注} | Level={级别} | Module={模块} | Func={功能}
```

**示例**:
```
2026-01-03 15:30:45 | abc12345 | evt001 | alice/192.168.1.1 | 采购板块 -> 订单管理 -> 删除 | DELETE_PO | XX20260103-S01 | Success | - | 删除采购订单: XX20260103-S01 | Regular | - | Level=WARNING | Module=delete | Func=Purchase:PODelete
```

### 7.2 error.log 格式

```
{时间} | {TraceID} | {EventID} | {用户}/{IP} | System | ERROR | Failed | System Error | {错误消息} | Regular | - | Loc={文件}:{函数}
```

**示例**:
```
2026-01-03 15:35:22 | xyz78901 | - | alice/192.168.1.1 | System | ERROR | Failed | System Error | 订单创建失败: Connection timeout | Regular | - | Loc=apps/purchase/views/submit.py:create_po_api
```

---

## 八、action 命名规范

### 8.1 命名格式

```
{动词}_{对象}
```

- 动词: 大写，表示操作类型
- 对象: 大写，表示操作目标

### 8.2 常用动词

| 动词 | 含义 | 使用场景 |
|------|------|----------|
| `CREATE` | 创建 | 新建订单、新增用户 |
| `UPDATE` | 更新 | 修改数据 |
| `DELETE` | 删除 | 软删除、硬删除 |
| `RESTORE` | 恢复 | 撤销删除 |
| `UPLOAD` | 上传 | 文件上传 |
| `DOWNLOAD` | 下载 | 文件下载 |
| `APPROVE` | 审批 | 审批通过 |
| `REJECT` | 拒绝 | 审批拒绝 |
| `LOCK` | 锁定 | 账户锁定 |
| `UNLOCK` | 解锁 | 账户解锁 |
| `RESET` | 重置 | 密码重置 |
| `CHANGE` | 变更 | 角色变更 |
| `CHECK` | 检查 | 权限检查、验证 |
| `SYNC` | 同步 | 数据同步 |
| `PURGE` | 清洗 | 日志清洗、数据清理 |

### 8.3 已有 action 示例

| action | 模块 | 说明 |
|--------|------|------|
| `CREATE_PO` | 采购 | 新建采购订单 |
| `DELETE_PO` | 采购 | 删除采购订单 |
| `RESTORE_PO` | 采购 | 恢复采购订单 |
| `CREATE_SEND` | 采购 | 新建发货单 |
| `DELETE_SEND` | 采购 | 删除发货单 |
| `RESTORE_SEND` | 采购 | 恢复发货单 |
| `CONFIRM_RECEIVE` | 采购 | 入库确认 |
| `CREATE_USER` | 用户管理 | 创建用户 |
| `DELETE_USER` | 用户管理 | 删除用户 |
| `RESET_PWD` | 用户管理 | 重置密码 |
| `UPDATE_PERMS` | 用户管理 | 更新权限 |
| `CHANGE_ROLE` | 用户管理 | 职级变更 |
| `LOCK_TOGGLE` | 用户管理 | 锁定/解锁用户 |
| `UPDATE_POLICY` | 用户管理 | 更新安全策略 |
| `RESTORE_DB` | 数据库 | 恢复数据库 |
| `PURGE_LOGS` | 审计 | 日志清洗 |

---

## 九、涉及的所有文件

### 核心文件

| 文件路径 | 作用 |
|----------|------|
| `core/sys/logger.py` | Logger 初始化、Filter、Formatter |
| `apps/audit/core/context.py` | 审计上下文管理器 |
| `apps/audit/core/dto.py` | 日志 DTO 定义（LogStatus, LogType, LogEntry） |

### 日志输出

| 文件路径 | 作用 |
|----------|------|
| `logs/app.log` | 业务操作日志（带噪音过滤） |
| `logs/audit.log` | 底层数据审计日志 |
| `logs/error.log` | 系统故障日志 |

---

## 十、常见问题

### Q1: 日志没有写入文件

**检查点**:
1. `logs/` 目录是否存在且可写
2. Logger 是否正确获取（使用 `get_audit_logger()` 而非直接 `logging.getLogger()`）

### Q2: user 显示为 "System"

**原因**: 请求上下文未初始化

**解决**: 确保在 Middleware 中正确初始化了 `AuditContextManager.init_context()`

### Q3: page 字段显示 "系统后台"

**原因**: 未调用 `AuditContextManager.set_page_hierarchy()`

**解决**: 在视图函数开头设置页面层级

### Q4: 日志被 BusinessLogFilter 过滤

**原因**: `user="System"` 的非 ERROR 日志会被过滤

**解决**: 确保请求上下文正确注入了真实用户名

---

## 十一、新模块接入 Checklist

- [ ] 导入 `get_audit_logger()` 
- [ ] 在视图函数开头调用 `AuditContextManager.set_page_hierarchy([...])`
- [ ] 成功操作使用 `audit_logger.info()` + `action` + `target`
- [ ] 敏感操作使用 `audit_logger.warning()` + `action` + `target`
- [ ] 失败操作添加 `status` 和 `root_cause`
- [ ] 系统异常使用 `get_error_logger().error()`
- [ ] action 命名遵循 `{动词}_{对象}` 格式
- [ ] 永久保留的日志设置 `log_type="Permanent"`

---

## 十二、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| V6.0 | 2025-12 | 对接 AuditContextManager，注入 ISO 字段 |
| V5.0 | 2025-11 | 三表分离架构 |
| V4.0 | 2025-10 | BusinessLogFilter 噪音过滤 |
| V3.0 | 2025-09 | 标准化日志格式 |
