# MGMT ERP 数据库连接方式

> **最后更新**: 2026-01-04
> **维护者**: AI Agent

---

## 一、技术栈

| 组件 | 技术 |
|------|------|
| 数据库 | MySQL 8.0 |
| ORM | SQLAlchemy (连接池) |
| 数据框架 | Pandas (read_sql) |
| Django | 仅用于 Auth/Session，不用 ORM 操作业务表 |

---

## 二、核心连接类

**文件位置**: `backend/core/components/db/client.py`

**关键类**: `DBClient`

### 主要方法

```python
from core.components.db.client import DBClient

# 读取数据 (返回 DataFrame)
df = DBClient.read_df("SELECT * FROM table WHERE id = :id", {"id": 123})

# 执行写操作 (INSERT/UPDATE/DELETE)
success = DBClient.execute_stmt("UPDATE table SET col = :val WHERE id = :id", {"val": "x", "id": 1})

# 事务操作
with DBClient.atomic_transaction() as conn:
    conn.execute(text("INSERT INTO ..."), {...})
    conn.execute(text("UPDATE ..."), {...})
```

---

## 三、独立脚本连接数据库

### 方法一：使用 Django Shell（推荐）

```bash
cd backend
python3 manage.py shell
```

然后在交互式环境中：
```python
from core.components.db.client import DBClient

df = DBClient.read_df("SELECT * FROM in_payment_logistic LIMIT 5")
print(df)
```

### 方法二：独立脚本

**必须放在 `backend/` 目录下，并正确设置路径：**

```python
#!/usr/bin/env python3
# File: backend/scripts/my_script.py

import sys
import os

# 关键：添加 backend 的父目录到 path
backend_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.dirname(backend_dir))
sys.path.insert(0, backend_dir)

# 设置 Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'common.settings')

import django
django.setup()

# 现在可以使用 DBClient
from core.components.db.client import DBClient

df = DBClient.read_df("SELECT * FROM xxx")
print(df)
```

### 方法三：使用 runscript 管理命令

如果有 `django-extensions` 安装：

```bash
cd backend
python3 manage.py runscript my_script
```

脚本放在 `backend/scripts/my_script.py`，需要一个 `run()` 函数。

---

## 四、配置文件

**数据库连接字符串位置**: `backend/common/settings/settings.py`

```python
SQLALCHEMY_URL = "mysql+pymysql://user:password@host:port/database?charset=utf8mb4"
```

---

## 五、参数绑定语法

**使用命名参数**（冒号语法）：

```python
# 正确
DBClient.read_df("SELECT * FROM table WHERE id = :id", {"id": 123})

# 错误（不要用 %s）
DBClient.read_df("SELECT * FROM table WHERE id = %s", (123,))
```

---

## 六、常见问题

### 1. ModuleNotFoundError: No module named 'backend'

**原因**: 路径未正确设置
**解决**: 确保脚本位于 `backend/scripts/` 并使用上述模板

### 2. 脚本无法连接数据库

**原因**: Django 未初始化
**解决**: 确保调用了 `django.setup()`

---

## 七、快速验证脚本

可用于验证数据库连接的一次性脚本（在 Django Shell 中运行）：

```python
from core.components.db.client import DBClient

# 检查表是否存在
df = DBClient.read_df("SHOW TABLES LIKE 'in_payment%'")
print(df)

# 查看表结构
df = DBClient.read_df("DESCRIBE in_payment_logistic")
print(df)
```
