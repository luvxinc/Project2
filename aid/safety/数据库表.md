# MGMT ERP 数据库表结构审计文档

> **最后更新**: 2026-01-04
> **维护者**: AI Agent
> **范围**: 业务逻辑表（排除 Django 系统表、用户认证表）

---

## 一、概述

MGMT ERP 系统采用 **双表架构设计**（History + Final），核心理念：

| 表类型 | 命名规范 | 用途 | 示例 |
|--------|----------|------|------|
| **历史表** | `in_xxx` | 存储所有操作版本，支持审计追溯 | `in_po`（采购订单历史） |
| **最终态表** | `in_xxx_final` | 仅存储当前有效状态，支持快速查询 | `in_po_final`（采购订单当前态） |

**数据写入规则**：
1. 每次写入操作同时更新 History 和 Final 表
2. History 表通过 `seq` 字段标识版本（如 `L01`, `L02`, `V01`）
3. Final 表始终只保留最新状态（通过 UPDATE/DELETE 实现）
4. 删除操作在 Final 表删除数据，在 History 表写入 `action='adjust'` 记录

---

## 二、表分类概览

### 2.1 采购进货模块 (Purchase)

| 表名 | 类型 | 描述 | 主要关联 |
|------|------|------|----------|
| `in_supplier` | Master | 供应商主表 | - |
| `in_supplier_strategy` | Config | 供应商策略配置 | FK → `in_supplier` |
| `in_po` | History | 采购订单历史 | FK → `in_supplier` |
| `in_po_final` | Final | 采购订单当前态 | - |
| `in_po_strategy` | Config | 订单策略（货币/定金） | FK → `in_po` |
| `in_send` | History | 发货单历史（物流信息） | - |
| `in_send_list` | History | 发货明细历史（货物） | FK → `in_send` |
| `in_send_final` | Final | 发货明细当前态 | - |
| `in_receive` | History | 入库记录历史 | FK → `in_send` |
| `in_receive_final` | Final | 入库记录当前态 | - |
| `in_diff` | History | 入库差异历史 | FK → `in_receive` |
| `in_diff_final` | Final | 入库差异当前态 | - |

### 2.2 财务模块 (Finance)

| 表名 | 类型 | 描述 | 主要关联 |
|------|------|------|----------|
| `in_payment_logistic` | History | 物流付款记录 | FK → `in_send` |

### 2.3 库存模块 (Inventory)

| 表名 | 类型 | 描述 | 主要关联 |
|------|------|------|----------|
| `Data_Inventory` | Master | 盘存快照表（动态列） | - |
| `in_dynamic_tran` | History | 动态库存流水 | - |
| `in_dynamic_fifo_layers` | Calc | FIFO 库存层 | FK → `in_dynamic_tran` |
| `in_dynamic_fifo_alloc` | Calc | FIFO 分摊明细 | FK → `in_dynamic_tran`, `in_dynamic_fifo_layers` |
| `in_mgmt_barcode` | Master | 仓库码管理（库位定位） | - |

### 2.4 产品模块 (Products)

| 表名 | 类型 | 描述 | 主要关联 |
|------|------|------|----------|
| `Data_COGS` | Master | 产品成本信息 | - |

### 2.5 销售/ETL 模块

| 表名 | 类型 | 描述 | 主要关联 |
|------|------|------|----------|
| `Data_Transaction` | Staging | eBay 交易临时表 | - |
| `Data_Order_Earning` | Staging | eBay 收益临时表 | - |
| `Data_Clean_Log` | Master | 清洗后的交易明细 | FK → `Data_COGS` |

---

## 三、表结构详解

### 3.1 供应商表 (`in_supplier`)

**用途**: 存储供应商基础信息

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `supplier_code` | VARCHAR(2) | UNIQUE, NOT NULL | 供应商代号（2字母） |
| `supplier_name` | VARCHAR(100) | NOT NULL | 供应商名称 |
| `created_at` | DATETIME | DEFAULT NOW | 创建时间 |
| `updated_at` | DATETIME | ON UPDATE NOW | 更新时间 |

**业务规则**:
- `supplier_code` 必须是2个字母，全局唯一
- 用于生成订单号前缀（如 `XX20260103-S01`）

**关联代码**:
- `apps/purchase/models.py` - Django ORM 模型
- `apps/purchase/views/supplier.py` - CRUD API

---

### 3.2 供应商策略表 (`in_supplier_strategy`)

**用途**: 存储供应商的交易策略配置（多版本）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `supplier_code` | VARCHAR(2) | FK → `in_supplier` | 供应商代号 |
| `category` | CHAR(1) | NOT NULL | 类别: E=汽配, A=亚马逊 |
| `currency` | VARCHAR(3) | NOT NULL | 货币: RMB/USD |
| `float_currency` | TINYINT(1) | DEFAULT 0 | 是否启用汇率浮动 |
| `float_threshold` | FLOAT | DEFAULT 0 | 浮动阈值 (0-10%) |
| `depository` | TINYINT(1) | DEFAULT 0 | 是否需要定金 |
| `deposit_par` | FLOAT | DEFAULT 0 | 定金比例 (0-100%) |
| `status` | TINYINT(1) | DEFAULT 1 | 状态: 1=合作, 0=停用 |
| `effective_date` | DATE | NOT NULL | 生效日期 |
| `note` | TEXT | | 备注 |
| `contract_file` | VARCHAR(500) | | 合同文件路径 |
| `created_at` | DATETIME | | 创建时间 |
| `updated_at` | DATETIME | | 更新时间 |

**业务规则**:
- 同一供应商可有多条策略，按 `effective_date` 区分
- 创建订单时自动继承供应商最新策略

---

### 3.3 采购订单历史表 (`in_po`)

**用途**: 存储采购订单所有版本（每行一个 SKU）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `update_date` | DATE | NOT NULL | 操作日期 |
| `supplier_code` | VARCHAR(2) | NOT NULL | 供应商代号 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号（如 `XX20260103-S01`） |
| `po_sku` | VARCHAR(100) | | SKU |
| `po_quantity` | INT | DEFAULT 0 | 订货数量 |
| `po_price` | DECIMAL(10,4) | DEFAULT 0 | 单价 |
| `currency` | VARCHAR(3) | DEFAULT 'RMB' | 货币 |
| `usd_rmb` | DECIMAL(10,4) | DEFAULT 7.0 | 汇率 |
| `by` | VARCHAR(50) | | 操作人 |
| `action` | VARCHAR(20) | | 操作类型: new/adjust/add/delete |
| `note` | VARCHAR(500) | | 备注（删除订单_xxx） |
| `seq` | VARCHAR(10) | | 版本号: L01, L02... |

**业务规则**:
- `po_num` 格式: `{supplier_code}{YYYYMMDD}-S{seq:02d}`
- `action='new'` + `seq='L01'` 表示原始订单
- `action='adjust'` + `po_sku=''` + `note='删除订单_xxx'` 表示整单删除
- `action='adjust'` + `po_quantity=0` 表示单品删除
- `action='add'` 表示恢复或新增商品

**查询示例**:
```sql
-- 获取订单最新状态（需按seq计算合并）
SELECT po_num, po_sku, po_quantity, seq
FROM in_po WHERE po_num = 'XX20260103-S01'
ORDER BY CAST(SUBSTRING(seq, 2) AS UNSIGNED) DESC
```

---

### 3.4 采购订单当前态表 (`in_po_final`)

**用途**: 存储采购订单当前有效状态（每行一个 SKU）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `po_date` | DATE | NOT NULL | 订单日期（从 po_num 提取） |
| `po_update_date` | DATE | NOT NULL | 最后更新日期 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `po_sku` | VARCHAR(100) | NOT NULL | SKU |
| `po_quantity` | INT | DEFAULT 0 | 当前订货量 |
| `po_price` | DECIMAL(10,4) | DEFAULT 0 | 单价 |
| `po_note` | VARCHAR(500) | | 备注 |
| `po_seq` | VARCHAR(10) | | 当前版本号 |
| `po_by` | VARCHAR(50) | | 操作人 |

**业务规则**:
- 订单删除时直接 DELETE 对应行
- 订货量调整时直接 UPDATE
- 查询发货可用量：`in_po_final.po_quantity - SUM(in_send_final.sent_quantity)`

**唯一键**: `(po_num, po_sku, po_price)` 组合唯一

---

### 3.5 订单策略表 (`in_po_strategy`)

**用途**: 存储每个订单的交易策略（货币、定金、汇率）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `date` | DATE | NOT NULL | 策略日期 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `cur_currency` | VARCHAR(3) | | 当前货币 |
| `cur_float` | TINYINT(1) | DEFAULT 0 | 汇率浮动开关 |
| `cur_ex_float` | DECIMAL(10,4) | | 浮动阈值 |
| `cur_deposit` | TINYINT(1) | DEFAULT 0 | 定金开关 |
| `cur_deposit_par` | DECIMAL(10,4) | | 定金比例 |
| `cur_usd_rmb` | DECIMAL(10,4) | | 汇率 |
| `note` | VARCHAR(500) | | 备注 |
| `by` | VARCHAR(50) | | 操作人 |
| `seq` | VARCHAR(10) | | 版本号: V01, V02... |

**业务规则**:
- 创建订单时自动从 `in_supplier_strategy` 复制
- 每次策略修改生成新版本（V01→V02）
- 发货/付款时使用最新版本策略

---

### 3.6 发货单历史表 (`in_send`)

**用途**: 存储发货单物流参数（托盘、费用、ETA）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `date_record` | DATE | NOT NULL | 记录日期 |
| `date_sent` | DATE | NOT NULL | 发货日期 |
| `date_eta` | DATE | | 预计到达日期 |
| `logistic_num` | VARCHAR(50) | NOT NULL | 物流单号 |
| `pallets` | INT | DEFAULT 0 | 托盘数 |
| `total_price` | DECIMAL(12,2) | DEFAULT 0 | 物流费用(RMB) |
| `usd_rmb` | DECIMAL(10,4) | DEFAULT 7.0 | 汇率 |
| `note` | VARCHAR(500) | | 备注 |
| `by` | VARCHAR(50) | | 操作人 |
| `seq` | VARCHAR(10) | | 版本号: L01, L02... |

**唯一键**: `(logistic_num, seq)` 组合唯一

---

### 3.7 发货明细历史表 (`in_send_list`)

**用途**: 存储发货单货物明细所有版本

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `date` | DATE | NOT NULL | 操作日期 |
| `logistic_num` | VARCHAR(50) | NOT NULL | 物流单号 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `sku` | VARCHAR(100) | NOT NULL | SKU |
| `price` | DECIMAL(10,4) | | 单价 |
| `quantity` | INT | DEFAULT 0 | 发货数量 |
| `action` | VARCHAR(20) | | 操作类型: new/adjust |
| `note` | VARCHAR(500) | | 备注 |
| `by` | VARCHAR(50) | | 操作人 |
| `seq` | VARCHAR(10) | | 版本号: L01, L02... |
| `po_change` | CHAR(1) | DEFAULT 'N' | 是否同步修改订单: Y/N |

**业务规则**:
- `po_change='Y'` 表示发货时同步调整了 `in_po` 订货量
- 删除发货单时，若 `po_change='Y'` 需恢复订货量

---

### 3.8 发货明细当前态表 (`in_send_final`)

**用途**: 存储发货单当前有效货物

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `sent_date` | DATE | | 发货日期 |
| `sent_update_date` | DATE | | 更新日期 |
| `sent_logistic_num` | VARCHAR(50) | NOT NULL | 物流单号 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `po_sku` | VARCHAR(100) | NOT NULL | SKU |
| `sent_quantity` | INT | DEFAULT 0 | 发货数量 |
| `po_price` | DECIMAL(10,4) | | 单价 |
| `sent_note` | VARCHAR(500) | | 备注 |
| `sent_seq` | VARCHAR(10) | | 版本号 |
| `sent_by` | VARCHAR(50) | | 操作人 |

**唯一键**: `(sent_logistic_num, po_num, po_sku, po_price)` 组合唯一

**关键查询**:
```sql
-- 计算订单发货状态
SELECT p.po_quantity - COALESCE(SUM(s.sent_quantity), 0) as remaining
FROM in_po_final p
LEFT JOIN in_send_final s ON p.po_num = s.po_num AND p.po_sku = s.po_sku AND p.po_price = s.po_price
WHERE p.po_num = 'XX20260103-S01'
GROUP BY p.po_num, p.po_sku, p.po_price
```

---

### 3.9 入库记录历史表 (`in_receive`)

**用途**: 存储入库记录所有版本

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `sent_date` | DATE | | 发货日期 |
| `eta_date_final` | DATE | | 预计到达日期 |
| `receive_date` | DATE | NOT NULL | 实际入库日期 |
| `update_date` | DATE | | 更新日期 |
| `logistic_num` | VARCHAR(50) | NOT NULL | 物流单号 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `po_sku` | VARCHAR(100) | NOT NULL | SKU |
| `sent_quantity` | INT | DEFAULT 0 | 发货数量 |
| `receive_quantity` | INT | DEFAULT 0 | 入库数量 |
| `po_price` | DECIMAL(10,4) | | 单价 |
| `action` | VARCHAR(20) | | 操作类型: new/adjust |
| `note` | VARCHAR(500) | | 备注 |
| `seq` | VARCHAR(10) | | 版本号: V01, V02... |
| `by` | VARCHAR(50) | | 操作人 |

**业务规则**:
- `sent_quantity != receive_quantity` 时自动生成差异记录
- 按 `(logistic_num, po_num, po_sku, po_price)` 分配入库数量

---

### 3.10 入库记录当前态表 (`in_receive_final`)

**用途**: 存储当前入库状态

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `eta_date_final` | DATE | | 预计到达日期 |
| `receive_date` | DATE | NOT NULL | 入库日期 |
| `update_date` | DATE | | 更新日期 |
| `logistic_num` | VARCHAR(50) | NOT NULL | 物流单号 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `po_sku` | VARCHAR(100) | NOT NULL | SKU |
| `sent_quantity` | INT | DEFAULT 0 | 发货数量 |
| `receive_quantity` | INT | DEFAULT 0 | 入库数量 |
| `po_price` | DECIMAL(10,4) | | 单价 |
| `note` | VARCHAR(500) | | 备注 |
| `seq` | VARCHAR(10) | | 版本号 |
| `by` | VARCHAR(50) | | 操作人 |

**入库状态计算逻辑**:
```python
if not receive_data:
    return '货物在途中'
elif all(sent_qty == receive_qty):
    return '全部已入库'
elif has_unresolved_diff:
    return '入库有差异:未解决'
else:
    return '入库有差异:已解决'
```

---

### 3.11 入库差异历史表 (`in_diff`)

**用途**: 存储入库差异记录

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `record_num` | VARCHAR(100) | | 记录号: `{logistic_num}_{receive_date}` |
| `logistic_num` | VARCHAR(50) | NOT NULL | 物流单号 |
| `po_num` | VARCHAR(50) | NOT NULL | 订单号 |
| `receive_date` | DATE | NOT NULL | 入库日期 |
| `po_sku` | VARCHAR(100) | NOT NULL | SKU |
| `po_quantity` | INT | DEFAULT 0 | 订货量 |
| `sent_quantity` | INT | DEFAULT 0 | 发货量 |
| `receive_quantity` | INT | DEFAULT 0 | 入库量 |
| `diff_quantity` | INT | DEFAULT 0 | 差异量（发货-入库） |
| `status` | VARCHAR(20) | DEFAULT 'pending' | 状态: pending/resolved |
| `action` | VARCHAR(20) | | 操作类型 |
| `note` | VARCHAR(500) | | 备注 |
| `seq` | VARCHAR(10) | | 版本号: D01, D02... |
| `by` | VARCHAR(50) | | 操作人 |

---

### 3.12 入库差异当前态表 (`in_diff_final`)

**用途**: 存储当前未解决/已解决的差异

字段同 `in_diff`（去掉 `action` 字段）

**异常处理页面**: `apps/purchase/views/abnormal.py` 读取此表

---

### 3.13 物流付款记录表 (`in_payment_logistic`)

**用途**: 存储物流费用付款记录（版本化追溯）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 主键 |
| `date_record` | DATE | NOT NULL | 记录日期 |
| `date_sent` | DATE | NOT NULL | 物流单发货日期 |
| `logistic_num` | VARCHAR(50) | NOT NULL, INDEX | 物流单号 |
| `logistic_paid` | DECIMAL(12,2) | DEFAULT 0 | 物流费用 |
| `extra_paid` | DECIMAL(12,2) | DEFAULT 0 | 额外费用 |
| `extra_currency` | VARCHAR(10) | DEFAULT '' | 额外费用币种 |
| `extra_note` | VARCHAR(500) | DEFAULT '' | 额外费用说明 |
| `payment_date` | DATE | NOT NULL, INDEX | 付款日期 |
| `note` | VARCHAR(200) | DEFAULT '' | 操作备注（如"原始付款记录"、"删除付款"） |
| `seq` | VARCHAR(10) | DEFAULT 'V01' | 版本号 |
| `by_user` | VARCHAR(50) | DEFAULT '' | 操作用户 |
| `pmt_no` | VARCHAR(100) | DEFAULT '', INDEX | 付款序列号（格式: `{payment_date}_S##`） |

**业务规则**:
- `pmt_no` 格式: `{YYYY-MM-DD}_S{seq:02d}`，按付款日期分组批量付款
- `seq` 版本号 V01→V02→... 按物流单号递增
- 删除操作不物理删除，而是写入 `logistic_paid=0` + `note='删除付款_...'` 的新版本
- 同一 `pmt_no` 可关联多个 `logistic_num`（批量付款）

**关联代码**: `apps/finance/views/payment/submit.py`, `apps/finance/views/payment/edit.py`

---

### 3.14 产品成本表 (`Data_COGS`)

**用途**: 存储 SKU 成本信息（产品主数据）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `SKU` | VARCHAR(100) | UNIQUE, NOT NULL | 产品 SKU |
| `Cog` | DECIMAL(10,4) | | 成本单价 |
| ... | ... | | 其他产品属性 |

**业务规则**:
- SKU 全局唯一，是整个系统的核心主数据
- ETL SKU 校验、发货 SKU 验证均依赖此表
- 新增产品通过 "产品模块 → 新增产品" 功能写入

---

### 3.15 盘存快照表 (`Data_Inventory`)

**用途**: 存储按日期列的库存快照

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `SKU` | VARCHAR(100) | NOT NULL | 产品 SKU |
| `{YYYY-MM-DD}` | INT | | 该日期的库存数量 |

**特殊结构**:
- 列名动态增长（每次盘存新增一列）
- 最后一列即为最新盘存日期
- 查询最新库存：`SELECT SKU, \`{latest_col}\` FROM Data_Inventory`

**关联代码**: `apps/etl/views.py` → `inv_sync` (同步盘存数据)

---

### 3.16 动态库存流水表 (`in_dynamic_tran`)

**用途**: 记录库存进出流水（FIFO 基础）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `record_id` | BIGINT | PK, AUTO_INCREMENT | 流水ID |
| `date_record` | DATETIME | NOT NULL | 记录时间 |
| `po_num` | VARCHAR(100) | | PO单号 |
| `sku` | VARCHAR(100) | NOT NULL | SKU |
| `price` | DECIMAL(10,4) | DEFAULT 0 | 成本/售价 |
| `quantity` | INT | DEFAULT 0 | 数量 |
| `action` | ENUM('in','out') | NOT NULL | 进库/出库 |
| `type` | VARCHAR(50) | DEFAULT 'inv' | 用途: sale/inv/return/adjust |
| `note` | TEXT | | 备注 |
| `created_at` | DATETIME | DEFAULT NOW | 插入时间 |

**索引**: `idx_sku`, `idx_date_record`, `idx_action_type`, `idx_po_num`

---

### 3.17 FIFO 库存层表 (`in_dynamic_fifo_layers`)

**用途**: 按入库批次维护库存层

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `layer_id` | BIGINT | PK, AUTO_INCREMENT | 层ID |
| `sku` | VARCHAR(100) | NOT NULL | SKU |
| `in_record_id` | BIGINT | FK → `in_dynamic_tran` | 来源入库流水 |
| `in_date` | DATETIME | NOT NULL | 入库时间 |
| `po_num` | VARCHAR(100) | | 来源订单号 |
| `unit_cost` | DECIMAL(10,4) | NOT NULL | 成本单价 |
| `qty_in` | INT | NOT NULL | 初始入库数量 |
| `qty_remaining` | INT | NOT NULL | 剩余可用数量 |
| `created_at` | DATETIME | DEFAULT NOW | 创建时间 |
| `closed_at` | DATETIME | | 关闭时间（qty_remaining=0） |

---

### 3.18 FIFO 分摊记录表 (`in_dynamic_fifo_alloc`)

**用途**: 记录出库对各入库层的消耗明细

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `alloc_id` | BIGINT | PK, AUTO_INCREMENT | 分摊ID |
| `out_record_id` | BIGINT | FK → `in_dynamic_tran` | 出库流水ID |
| `sku` | VARCHAR(100) | NOT NULL | SKU |
| `out_date` | DATETIME | NOT NULL | 出库时间 |
| `layer_id` | BIGINT | FK → `in_dynamic_fifo_layers` | 消耗层ID |
| `qty_alloc` | INT | NOT NULL | 从该层扣除的数量 |
| `unit_cost` | DECIMAL(10,4) | NOT NULL | 该层成本单价 |
| `cost_alloc` | DECIMAL(12,4) | NOT NULL | 分摊成本（qty * unit_cost） |
| `created_at` | DATETIME | DEFAULT NOW | 创建时间 |

---

### 3.19 交易临时表 (`Data_Transaction`)

**用途**: eBay 交易报表上传临时存储

**业务规则**:
- ETL 上传后写入此表
- 解析完成后清空（TRUNCATE）
- 仅在 ETL 流程中使用

---

### 3.20 收益临时表 (`Data_Order_Earning`)

**用途**: eBay 收益报表上传临时存储

**业务规则**: 同 `Data_Transaction`

---

### 3.21 清洗后交易表 (`Data_Clean_Log`)

**用途**: 存储清洗后的交易明细（最终数据）

**特点**:
- 第一列为 `order date`
- 包含解析后的 SKU、数量、销售额等
- 支持报表和分析查询

---

### 3.22 仓库码管理表 (`in_mgmt_barcode`)

**用途**: 存储仓库库位结构定义（货架定位码）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `wh_num` | VARCHAR(20) | PK, INDEX | 仓库号 |
| `aisle` | VARCHAR(10) | PK | 货架排号 (L/R等) |
| `bay` | INT | PK | 货架跨号 (1,2,3...) |
| `level` | VARCHAR(10) | PK | 货架层号 (G=底层/M=中层/T=顶层) |
| `bin` | VARCHAR(10) | PK | 库位号 (L/R等) |
| `slot` | VARCHAR(10) | PK | 格位号 (L/R等) |
| `created_at` | DATETIME | DEFAULT NOW | 创建时间 |
| `updated_at` | DATETIME | ON UPDATE NOW | 更新时间 |

**主键**: `(wh_num, aisle, bay, level, bin, slot)` 组合主键

**业务规则**:
- 库位码层级: 仓库 → 排 → 跨 → 层 → 位 → 格
- 字符串字段 (aisle/bin/slot) 保留扩展性，当前使用 L/R
- 静态主数据，无版本追溯

**关联代码**: `scripts/create_in_mgmt_barcode.py`

---

## 四、表关系图

```
                       in_supplier
                            │
                            ▼
                   in_supplier_strategy
                            │
                            ▼
    ┌────────────────── in_po ◄─────────────────────────────┐
    │                       │                                │
    │                       ▼                                │
    │                   in_po_final ─────────┐               │
    │                       │                │               │
    │                       ▼                ▼               │
    │            ┌─────► in_po_strategy   in_send_list ◄────┘
    │            │                            │
    │            │                            ▼
    │         in_send ◄───────────────► in_send_final
    │            │                            │
    │            │                            ▼
    │            ▼                      ┌─ in_receive_final
    │     in_payment_logistic           │       │
    │                                   │       ▼
    │                          in_receive ◄─ in_diff_final
    │                              │           │
    │                              ▼           ▼
    │                          in_diff ────────┘
    │
    │  ┌─────────────────────────────────────────────────────┐
    │  │                    库存模块                          │
    │  │                                                      │
    │  │  Data_COGS ──► Data_Inventory                       │
    │  │      │                                               │
    │  │      ▼                                               │
    │  │  in_dynamic_tran ──► in_dynamic_fifo_layers         │
    │  │                              │                       │
    │  │                              ▼                       │
    │  │                    in_dynamic_fifo_alloc             │
    │  └─────────────────────────────────────────────────────┘
    │
    │  ┌─────────────────────────────────────────────────────┐
    │  │                    ETL 模块                          │
    │  │                                                      │
    │  │  Data_Transaction ──► (解析) ──► Data_Clean_Log     │
    │  │  Data_Order_Earning ──►                              │
    │  └─────────────────────────────────────────────────────┘
```

---

## 五、数据完整性规则

### 5.1 级联删除规则

| 源表 | 触发操作 | 影响表 |
|------|----------|--------|
| 删除订单 (`in_po`) | 软删除 | `in_po_final` DELETE |
| 删除发货单 (`in_send`) | 软删除 | `in_send_final` DELETE, `in_po_final` RESTORE |
| 删除入库 (`in_receive`) | 软删除 | `in_receive_final` DELETE, `in_diff_final` DELETE |

### 5.2 数据同步规则

| 操作 | History 表 | Final 表 |
|------|-----------|----------|
| 创建 | INSERT | INSERT |
| 修改 | INSERT (new seq) | UPDATE |
| 删除 | INSERT (delete marker) | DELETE |
| 恢复 | INSERT (restore marker) | INSERT |

### 5.3 事务保护

**必须使用事务的场景**:
```python
with DBClient.atomic_transaction():
    # 1. 写入 History 表
    DBClient.execute_stmt("INSERT INTO in_po ...")
    # 2. 更新 Final 表
    DBClient.execute_stmt("UPDATE in_po_final ...")
```

---

## 六、回滚配置

**配置文件**: `backend/data/rollback_config.json`

**可回滚表**:
- `Data_COGS`
- `Data_Inventory`
- `Data_Clean_Log`
- `in_supplier`
- `in_supplier_strategy`

**注意**: 采购流程表 (`in_po*`, `in_send*`, `in_receive*`) 通过业务逻辑的"恢复"功能实现撤销，不通过回滚机制。

---

## 七、常见查询模式

### 7.1 查询订单最新状态

```sql
-- 方式1: 直接查询 Final 表
SELECT * FROM in_po_final WHERE po_num = 'XX20260103-S01';

-- 方式2: 从 History 表计算（复杂场景）
-- 见 po_mgmt/list.py 中的 check_order_deleted 函数
```

### 7.2 查询发货可用量

```sql
SELECT 
    pf.po_num, pf.po_sku, pf.po_quantity,
    COALESCE(SUM(sf.sent_quantity), 0) as sent,
    pf.po_quantity - COALESCE(SUM(sf.sent_quantity), 0) as available
FROM in_po_final pf
LEFT JOIN in_send_final sf 
    ON pf.po_num = sf.po_num 
    AND pf.po_sku = sf.po_sku 
    AND ABS(pf.po_price - sf.po_price) < 0.001
WHERE pf.po_num = 'XX20260103-S01'
GROUP BY pf.po_num, pf.po_sku, pf.po_price, pf.po_quantity
```

### 7.3 查询入库状态

```sql
SELECT 
    sf.sent_logistic_num,
    sf.po_sku,
    sf.sent_quantity,
    COALESCE(rf.receive_quantity, 0) as received,
    sf.sent_quantity - COALESCE(rf.receive_quantity, 0) as diff
FROM in_send_final sf
LEFT JOIN in_receive_final rf 
    ON sf.sent_logistic_num = rf.logistic_num
    AND sf.po_num = rf.po_num
    AND sf.po_sku = rf.po_sku
WHERE sf.sent_logistic_num = 'xxxxxx'
```

---

## 八、涉及的关键代码文件

| 文件路径 | 涉及表 |
|----------|--------|
| `apps/purchase/views/po_create/submit.py` | `in_po`, `in_po_final`, `in_po_strategy` |
| `apps/purchase/views/po_mgmt/list.py` | `in_po`, `in_po_final`, `in_po_strategy` |
| `apps/purchase/views/po_mgmt/delete.py` | `in_po`, `in_po_final` |
| `apps/purchase/views/send_create/submit.py` | `in_send`, `in_send_list`, `in_send_final`, `in_po`, `in_po_final` |
| `apps/purchase/views/send_mgmt/list.py` | `in_send`, `in_send_list`, `in_send_final`, `in_po_strategy` |
| `apps/purchase/views/send_mgmt/delete.py` | `in_send_list`, `in_send_final`, `in_po`, `in_po_final` |
| `apps/purchase/views/receive/submit.py` | `in_receive`, `in_receive_final`, `in_diff`, `in_diff_final` |
| `apps/purchase/views/receive_mgmt/list.py` | `in_receive`, `in_receive_final`, `in_send_final`, `in_diff` |
| `apps/purchase/views/abnormal.py` | `in_diff_final` |
| `apps/finance/views/payment/submit.py` | `in_send`, `in_payment_logistic` |
| `apps/finance/views/payment/edit.py` | `in_payment_logistic` |
| `apps/finance/views/payment/history.py` | `in_send`, `in_payment_logistic` |
| `apps/etl/views.py` | `Data_Transaction`, `Data_Order_Earning`, `Data_Clean_Log`, `Data_Inventory` |
| `apps/products/actions.py` | `Data_COGS`, `Data_Inventory` |
| `scripts/create_in_dynamic_tables.sql` | `in_dynamic_tran`, `in_dynamic_fifo_layers`, `in_dynamic_fifo_alloc` |

---

## 九、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| V1.0 | 2026-01-03 | 初始创建，覆盖全部业务逻辑表 |
| V1.1 | 2026-01-04 | 更新 `in_payment_logistic` 表结构：新增 `extra_currency`、`note`、`pmt_no` 字段 |
| V1.2 | 2026-01-04 | 新增 `in_mgmt_barcode` 仓库码管理表 |
