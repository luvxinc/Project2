# 模块权限配置系统架构文档

> **Purpose**: 此文件定义了基于 **Permission Tree** 和 **Whitelist** 的访问控制系统。它解释了如何定义新权限、权限的层级结构（Module-Submodule-Tab）以及 `User_Permission` 表的作用。
> **AI Attention**: 添加新页面或功能时，**必须** 在此系统注册相应的 Permission Key，并更新 `modules.json` 和 `inventory.py`（白名单）。
> **Constraints**: `HARD` - 新功能必须纳入权限体系。
> **Related Files**: 
> - `aid/safety/密码策略.md`: 权限是访问的前提，密码是执行的保障。



> **最后更新**: 2026-01-09
> **维护者**: AI Agent
> **系统版本**: Permission Management V3.0

---

## 一、系统概述

模块权限配置系统是 MGMT ERP 的核心访问控制组件，用于管理不同用户对系统各功能模块的访问权限。该系统实现了基于 **权限树（Permission Tree）** 的细粒度权限控制，支持模块级到功能级的分层授权。

### 核心设计原则

1. **层级继承（Hierarchical Inheritance）**: 拥有子权限自动推断父权限
2. **白名单校验（Whitelist Validation）**: 只允许保存预定义的合法权限节点
3. **权限穿透（Permission Transitivity）**: Admin 只能授予自己拥有的权限
4. **职级隔离（Role Hierarchy）**: 高职级用户可管理低职级用户的权限

---

## 二、权限标识命名规范

### 权限 Key 格式

```
module.<板块>.<子模块>.<标签>
```

### 层级结构示例

```
module.sales                           # 销售板块（模块级）
├── module.sales.transactions          # 交易数据（子模块级）
│   └── module.sales.transactions.upload  # 交易数据上传（Tab级）
├── module.sales.reports               # 报表中心（子模块级）
│   ├── module.sales.reports.generate     # 报表生成器（Tab级）
│   └── module.sales.reports.center       # 报表中心（Tab级）
└── module.sales.visuals               # 数据可视化（子模块级）
    └── module.sales.visuals.dashboard    # 数据交互可视化（Tab级）
```

### 特殊权限标识

| 权限 Key | 说明 |
|----------|------|
| `public` | 公开访问，无需权限检查 |
| `admin_only` | 仅管理员可见（不在权限树中展示） |

---

## 三、权限白名单 (WHITELIST_PERMISSIONS)

**位置**: `backend/core/services/security/inventory.py`

**作用**: 定义所有合法的可分配权限节点，后端保存时强制校验

```python
WHITELIST_PERMISSIONS = {
    # 销售板块 - 4个tab
    "module.sales.transactions.upload",      # 交易数据上传
    "module.sales.reports.generate",         # 报表生成器
    "module.sales.reports.center",           # 报表中心
    "module.sales.visuals.dashboard",        # 数据交互可视化
    
    # 采购板块 - 9个tab
    "module.purchase.supplier.add",          # 新增供应商
    "module.purchase.supplier.strategy",     # 策略管理
    "module.purchase.po.add",                # 新建采购订单
    "module.purchase.po.mgmt",               # 订单管理
    "module.purchase.send.add",              # 新建发货单
    "module.purchase.send.mgmt",             # 发货单管理
    "module.purchase.receive",               # 货物入库
    "module.purchase.receive.mgmt",          # 入库管理
    "module.purchase.abnormal.manage",       # 入库异常处理
    
    # 财务板块 - 5个tab
    "module.finance.flow.view",              # 定发收总预览
    "module.finance.logistic.manage",        # 物流财务管理
    "module.finance.prepay.manage",          # 厂商预付款管理
    "module.finance.deposit.manage",         # 定金付款管理
    "module.finance.po.manage",              # 订单付款管理
    
    # 库存板块 - 4个tab
    "module.inventory.stocktake.upload",     # 手动上传盘存
    "module.inventory.stocktake.modify",     # 库存修改向导
    "module.inventory.dynamic.view",         # 动态库存管理
    "module.inventory.shelf.manage",         # 仓库货架码管理
    
    # 产品板块 - 3个tab
    "module.products.catalog.cogs",          # 产品数据维护
    "module.products.catalog.create",        # 新增产品
    "module.products.barcode.generate",      # 外包装条形码
    
    # 数据库运维 - 5个tab
    "module.db_admin.backup.create",         # 数据备份
    "module.db_admin.backup.restore",        # 数据恢复
    "module.db_admin.backup.manage",         # 备份管理
    "module.db_admin.cleanup.delete",        # 数据清洗
    "module.db_admin.rollback_restore.restore", # 数据修改找回
    
    # 用户权限管理 - 2个submodule
    "module.user_admin.users",               # 用户列表
    "module.user_admin.register",            # 注册新用户
    
    # 安全审计日志 - 3个tab
    "module.audit.logs.business",            # 业务操作日志
    "module.audit.logs.infra",               # 全景数据审计
    "module.audit.logs.system",              # 系统故障监控
}
```

> **重要**: 任何不在白名单中的权限 Key 在保存时会被拒绝，防止权限注入攻击。

---

## 四、核心配置文件

### 4.1 模块导航配置 (modules.json)

**位置**: `backend/common/modules.json`

**作用**: 定义系统导航结构，包含每个节点的权限标识

**结构示例**:
```json
{
  "key": "sales",
  "name": "销售板块",
  "permission": "module.sales",
  "submodules": [
    {
      "key": "transactions",
      "name": "交易数据",
      "permission": "module.sales.transactions",
      "tabs": [
        {
          "key": "upload",
          "name": "交易数据上传",
          "permission": "module.sales.transactions.upload"
        }
      ]
    }
  ]
}
```

### 4.2 动作注册表 (action_registry.json)

**位置**: `backend/common/action_registry.json`

**作用**: 定义每个 Tab 下的具体操作（Actions），用于密码策略配置

**关系**: 权限树中的 Tab 节点与动作注册表中的 Actions 关联

---

## 五、数据库存储

### 5.1 权限表 (User_Permission)

**表名**: `User_Permission`

**结构**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `username` | VARCHAR | 用户名（外键） |
| `permission_key` | VARCHAR | 权限标识（如 `module.sales.transactions.upload`） |
| `allowed` | TINYINT | 是否允许（1=允许，0=禁止） |

**示例数据**:
```
username | permission_key                    | allowed
---------|-----------------------------------|--------
alice    | module.sales.transactions.upload  | 1
alice    | module.sales.reports.generate     | 1
bob      | module.db_admin.backup.create     | 1
```

---

## 六、后端核心组件

### 6.1 SecurityInventory

**位置**: `backend/core/services/security/inventory.py`

**职责**:
- 构建权限树（从 modules.json 和 action_registry.json）
- 提供权限白名单校验
- 过滤非法权限节点

**核心方法**:

```python
# 获取完整权限树（用于 UI 渲染）
tree = SecurityInventory.get_full_permission_tree()
# 返回: [
#   {"key": "module.sales", "name": "销售板块", "children": [...]},
#   ...
# ]

# 权限白名单常量
SecurityInventory.WHITELIST_PERMISSIONS
```

### 6.2 AuthService 权限方法

**位置**: `backend/core/services/auth/service.py`

**核心方法**:

```python
# 获取用户权限（带父权限推断）
perms = AuthService.get_permissions('alice')
# 返回: {
#   "module.sales.transactions.upload": True,
#   "module.sales.transactions": True,      # 自动推断
#   "module.sales": True                    # 自动推断
# }

# 获取原始权限（不推断，用于 UI 渲染）
raw_perms = AuthService.get_raw_permissions('alice')
# 返回: {
#   "module.sales.transactions.upload": True
# }

# 保存用户权限
AuthService.set_permissions('alice', selected_perms_list)
# 使用事务：先删除所有现有权限，再批量插入新权限
```

**父权限推断逻辑**:
```python
# 如果用户有 "module.db_admin.backup.create"
# 自动推断拥有:
#   - "module.db_admin.backup"
#   - "module.db_admin"
# 用于视图层的权限检查
```

### 6.3 权限更新 API

**URL**: `/dashboard/admin/actions/update_permissions/<username>/`

**位置**: `backend/apps/user_admin/views/actions.py` → `user_update_permissions()`

**权限**: 需要 `can_manage_perms` 职能开关

**验证流程**:

```
1. 密码策略验证 (SecurityPolicyManager) ➜ btn_update_perms
2. 职能开关检查 (CapabilityManager) ➜ can_manage_perms
3. 职级检查 (RoleManager) ➜ 确保操作者职级高于目标用户
4. 白名单校验 ➜ 拒绝任何非 WHITELIST_PERMISSIONS 的权限
5. 权限穿透校验 ➜ Admin 不能授予自己没有的权限
6. 保存权限 ➜ AuthService.set_permissions()
```

---

## 七、前端核心组件

### 7.1 权限面板模板

**位置**: `backend/templates/user_admin/components/permissions/permissions_panel.html`

**功能**:
- 显示目标用户信息（用户名、角色）
- 渲染权限树（可折叠的手风琴结构）
- 模块级开关控制子权限的批量选择
- 灰色禁用显示操作者无权配置的节点

### 7.2 权限树渲染逻辑

**模块级 checkbox**: 控制所有子权限的批量勾选

```javascript
function toggleChildren(parentCheckbox, groupId) {
    const container = document.getElementById(groupId);
    const isChecked = parentCheckbox.checked;
    const childCheckboxes = container.querySelectorAll('input[type="checkbox"]:not(:disabled)');
    childCheckboxes.forEach(cb => cb.checked = isChecked);
}
```

**子级变化反向同步父级**:
```javascript
function syncParentState(parentId, groupId) {
    const parentCheckbox = document.getElementById(parentId);
    const activeChildren = container.querySelectorAll('input[type="checkbox"]:not(:disabled)');
    const allChecked = Array.from(activeChildren).every(cb => cb.checked);
    parentCheckbox.checked = allChecked;
}
```

### 7.3 权限保存流程

```javascript
function initPermSave() {
    // 1. 检测是否需要安全验证
    const requiredCodes = detectRequiredSecurityCodes();
    
    // 2. 如果需要，显示密码验证弹窗
    if (requiredCodes.length > 0) {
        GlobalModal.showPassword({
            requiredCodes: requiredCodes,
            onSubmit: (passwords) => {
                // 3. 填充隐藏的安全码输入框
                fillSecurityInputs(passwords);
                // 4. 提交表单
                htmx.trigger('#permForm', 'submit');
            }
        });
    } else {
        htmx.trigger('#permForm', 'submit');
    }
}
```

---

## 八、完整数据流

### 8.1 打开权限配置面板

```
┌─────────────────────────────────────────────────────────────────┐
│  用户列表页面：点击"板块管理"按钮                                │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  GET /dashboard/admin/panel/permissions/<username>/             │
│  → user_permission_form() 视图                                  │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. SecurityInventory.get_full_permission_tree()                │
│     → 构建完整权限树                                            │
│  2. AuthService.get_raw_permissions(target_username)            │
│     → 获取目标用户已有权限                                      │
│  3. AuthService.get_permissions(actor_username)                 │
│     → 获取操作者权限（用于判断哪些节点可操作）                  │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  渲染 permissions_panel.html                                    │
│  → 遍历权限树，渲染 checkbox                                    │
│  → 已授权的权限自动勾选                                         │
│  → 操作者无权限的节点置灰禁用                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 保存权限配置

```
┌─────────────────────────────────────────────────────────────────┐
│  用户点击"保存权限配置"按钮                                     │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  initPermSave() → 弹出密码验证（如果需要）                      │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  POST /dashboard/admin/actions/update_permissions/<username>/   │
│  body: { perms: ["module.sales.transactions.upload", ...],      │
│          sec_code_user: "password" }                            │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  后端验证链:                                                    │
│  1. SecurityPolicyManager.verify_action_request('btn_update_perms') │
│  2. _check_admin_capability('can_manage_perms')                 │
│  3. _check_hierarchy(actor, target)                             │
│  4. 白名单校验: perms ⊆ WHITELIST_PERMISSIONS                   │
│  5. 穿透校验: perms ⊆ actor_permissions (非超管)                │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  AuthService.set_permissions(target_username, perms)            │
│  → 事务内: DELETE + INSERT 批量操作                             │
└───────────────────────┬─────────────────────────────────────────┘
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  返回成功响应 + HX-Trigger: showToast                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 九、角色与权限关系

### 9.1 角色层级

| 角色 | 权限特点 |
|------|----------|
| **Super Admin** | 拥有所有权限，可配置任意用户的权限 |
| **Admin** | 只能配置自己拥有的权限给 User |
| **User** | 不能配置他人权限，仅能使用被授权的功能 |

### 9.2 权限继承规则

```
Super Admin
    ↓ 可配置
Admin (Alice)
    ↓ 只能授予自己拥有的权限
User (Bob)
```

**示例**:
- Alice (Admin) 拥有 `module.sales.transactions.upload` 和 `module.sales.reports.generate`
- Alice 配置 Bob 时，只能勾选这两个权限
- 其他权限节点对 Alice 显示为灰色禁用状态

---

## 十、涉及的所有文件

### 后端文件

| 文件路径 | 作用 |
|----------|------|
| `core/services/security/inventory.py` | 权限资产盘点服务、白名单定义 |
| `core/services/auth/service.py` | 权限 CRUD 操作 |
| `common/modules.json` | 模块导航配置（权限树数据源） |
| `apps/user_admin/views/tabs.py` | 权限面板视图 |
| `apps/user_admin/views/actions.py` | 权限更新 API |
| `apps/user_admin/urls.py` | 权限相关路由 |

### 前端文件

| 文件路径 | 作用 |
|----------|------|
| `templates/user_admin/components/permissions/permissions_panel.html` | 权限配置面板 |
| `templates/user_admin/components/headers/header_permissions.html` | 权限面板头部 |
| `templates/user_admin/components/users/user_list_panel.html` | 用户列表（入口） |

### 数据库

| 表名 | 作用 |
|------|------|
| `User_Permission` | 存储用户权限映射 |
| `User_Account` | 用户账户信息（含 is_admin 字段判断角色） |

---

## 十一、安全机制汇总

| 机制 | 说明 | 实现位置 |
|------|------|----------|
| **白名单校验** | 只允许保存预定义权限节点 | `inventory.py` → `WHITELIST_PERMISSIONS` |
| **权限穿透** | Admin 不能授予自己没有的权限 | `actions.py` → `forbidden_perms` 检查 |
| **职级隔离** | 高职级才能管理低职级 | `actions.py` → `_check_hierarchy()` |
| **职能开关** | Super Admin 可关闭 Admin 的权限管理能力 | `admin_capabilities.json` → `can_manage_perms` |
| **密码验证** | 保存前需要密码确认 | `SecurityPolicyManager` → `btn_update_perms` |
| **审计日志** | 所有权限变更被记录 | `audit_logger.info()` |

---

## 十二、常见问题排查

### Q1: 权限保存失败 "包含未知权限项"

**原因**: 提交的权限 Key 不在 `WHITELIST_PERMISSIONS` 中

**解决**:
1. 检查 `modules.json` 中的 `permission` 字段是否正确
2. 确认 `WHITELIST_PERMISSIONS` 包含所有合法节点

### Q2: Admin 无法勾选某些权限节点

**原因**: 该 Admin 自己没有这些权限

**解决**:
1. 由 Super Admin 先给 Admin 授予相应权限
2. 或使用 Super Admin 账户直接配置

### Q3: 权限保存后用户仍无法访问

**检查点**:
1. 确认 `User_Permission` 表中记录已写入
2. 确认视图层正确调用 `AuthService.get_permissions()`
3. 确认导航渲染使用了权限检查

### Q4: 权限树中缺少某些模块

**原因**: 模块可能被标记为 `admin_only` 或 `public`

**解决**: 这是设计行为，这些模块不在普通权限配置范围内

---

## 十三、扩展新模块权限的标准流程

### 添加新模块到权限树

1. **更新 modules.json**:
```json
{
  "key": "new_module",
  "name": "新模块",
  "permission": "module.new_module",
  "submodules": [
    {
      "key": "feature",
      "name": "功能子模块",
      "permission": "module.new_module.feature",
      "tabs": [
        {
          "key": "action",
          "name": "操作标签",
          "permission": "module.new_module.feature.action"
        }
      ]
    }
  ]
}
```

2. **更新白名单** (`inventory.py`):
```python
WHITELIST_PERMISSIONS = {
    # ... existing ...
    "module.new_module.feature.action",  # 新增
}
```

3. **在视图中添加权限检查**:
```python
perms = AuthService.get_permissions(request.user.username)
if 'module.new_module.feature.action' not in perms:
    return HttpResponse("Permission Denied", status=403)
```

---

## 十四、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| V3.0 | 2026-01 | 三层结构（Module→Submodule→Tab）、白名单机制 |
| V2.0 | 2025-11 | 父权限推断、权限穿透校验 |
| V1.0 | 2025-09 | 基础权限树、CRUD 功能 |
