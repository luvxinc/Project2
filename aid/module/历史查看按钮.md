# 历史修订记录查看按钮与视图功能 (History Revision Viewer)

> **Purpose**: 本文档作为「历史修订记录查看」功能的标准工程参考。详细解析如何通过按钮交互展示多维度的版本变更历史，包括策略变更（Header Revisions）与明细变更（Line Item Revisions），以及如何实现横向对比视图。
> **Scope**: 适用于任何需要展示实体历史变更、版本对比、审计轨迹的业务模块（如 Inventory Adjustments, Price Lists）。

---

## 1. 功能概述

此功能通过一个 **"历史记录" (History / Revision Log)** 按钮触发，解决以下核心问题：
1.  **多维度审计**: 同时展示 Document Header (Master) 和 Document Lines (Detail) 的变更。
2.  **横向时间轴**: 使用横向排列的时间轴布局，直观展示版本演进 (`V01` -> `V02` -> ...)。
3.  **增量对比 (Diff)**: 自动计算并高亮显示版本间的差异（如价格变动、数量调整、新增/删除行）。
4.  **操作可追溯**: 记录 Who, When, Why (Note)。

---

## 2. 前端实现逻辑 (Visual & Interaction)

### 2.1 触发入口 (The Trigger)

在列表页的操作列或详情页的顶部放置按钮。

```html
<!-- 示例: 订单管理列表页 actions 列 -->
<button class="action-btn history" onclick="viewHistory('{{ po.po_num }}')"
        data-bs-toggle="tooltip" title="查看修订历史">
    <i class="fas fa-history"></i>
</button>
```

### 2.2 视图容器设计 (The Container)

不同于简单的 Modal，历史记录通常需要**整页覆盖**或**大型抽屉 (Drawer)** 以容纳横向时间轴。
推荐模式：**SPA 风格切换** (隐藏 List View，显示 History View)。

### 2.3 核心渲染逻辑 (`viewHistory`)

参考代码: `backend/static/js/po_mgmt.js` (或内嵌于 `po_mgmt.html` 中的 JS)

**A. API 数据获取**:
```javascript
fetch(`/api/history?id=${id}`)
    .then(r => r.json())
    .then(data => {
        renderTimeline(data.strategy_versions, data.detail_versions);
    });
```

**B. 横向时间轴渲染 (Horizontal Timeline)**:
每一个版本（Version Column）应包含：
*   **Header**: 版本号 (`V01`), 日期, 操作人。
*   **Metadata Changes**: 策略变更（如 汇率: 7.0 -> 7.1）。
*   **Line Items**: 当时版本的快照，或仅显示变更项。

**C. 差异高亮 (Diff Visualization)**:
*   **Changed**: 黄色背景，显示 Old -> New。
*   **Added**: 绿色背景 / `+` 标记。
*   **Deleted**: 红色背景 / 删除线。

```javascript
// 伪代码: 渲染变更
function renderChanges(changes) {
    return changes.map(c => `
        <div class="diff-item">
            <span class="field-label">${c.field}:</span>
            <span class="old-val">${c.old}</span>
            <i class="fas fa-arrow-right"></i>
            <span class="new-val">${c.new}</span>
        </div>
    `).join('');
}
```

---

## 3. 后端实现逻辑 (Backend Handling)

**文件参考**: `backend/apps/purchase/views/po_mgmt/history.py`

### 3.1 数据模型 (Persistence Model)

必须理解系统的**"追加模式" (Append-Only / Mutation Log)** 设计：
*   **每次修改**都会插入一条新记录 (`INSERT`)，而不是 `UPDATE` 原记录。
*   **Header 表**: `in_po_strategy` (字段: `seq` 如 `V01`, `V02`)
*   **Line 表**: `in_po` (字段: `seq` 如 `L01`, `L02`。注意：Line Item 通常共享一个版本号或有独立的 Mutation Log)

### 3.2 API 逻辑 (`get_po_history_api`)

1.  **策略层 (Strategy Layer)**:
    *   查询 `in_po_strategy` where `po_num = X` order by `seq`.
    *   **Python Diff**: 遍历列表，对比 `current vs previous`，生成 `changes` 列表 (e.g., `{'field': '汇率', 'old': 7.0, 'new': 7.1}`)。

2.  **明细层 (Detail Layer)**:
    *   查询 `in_po` (Mutation Log) where `po_num = X` order by `seq`.
    *   **Reconstruction**: 由于明细表通常是"快照"或"增量"，需要根据业务逻辑还原每个版本的状态。
    *   **Action Interpretation**: 解析 `action` 字段 (`new`, `add`, `adjust`, `delete`)。
        *   `adjust`: 对比 Same SKU 的前后数量/价格。
        *   `add`: 标记为新增。
        *   `delete`: 标记为删除。

3.  **标准化响应格式**:
    ```json
    {
        "success": true,
        "data": {
            "entity_id": "PO123",
            "strategy_versions": [
                { "seq": "V01", "date": "...", "changes": [] },
                { "seq": "V02", "date": "...", "changes": [{ "field": "汇率", "old": "7.0", "new": "7.2" }] }
            ],
            "detail_versions": [
                { 
                    "seq": "L01", 
                    "action": "new", 
                    "items": [...] 
                },
                { 
                    "seq": "L02", 
                    "action": "adjust", 
                    "changes": [
                        { "sku": "A001", "type": "adjust", "fields": [...] }
                    ] 
                }
            ]
        }
    }
    ```

### 3.3 扩展性设计 (Extensibility)

为了达到"复用于多个明细表"的要求：

1.  **注册制 Diff 引擎**: 后端可以设计一个通用的 `DiffEngine(current_dict, prev_dict, fields_to_watch)`，传入要监控的字段列表即可自动生成变更报告。
2.  **多表聚合**: 如果一个主实体关联多个子表（e.g., 订单关联 `in_po` (Items) 和 `in_logistic` (Shipping)），API 应分别查询并聚合，前端分 Section 展示。

---

## 4. 复用指南 (Reusability Guide)

在其他模块（如 "产品价格审计"）复用此功能：

1.  **必须有历史表**: 确保你的业务实体遵循 Mutation Log 设计（有 `seq`, `created_at`, `action` 字段）。如果没有，必须先改造数据库模型。
2.  **后端适配**:
    *   复制 `history.py`。
    *   修改 SQL 查询目标表。
    *   定义 `field_labels` 映射（列名 -> 中文显示名）。
3.  **前端适配**:
    *   复用 `timeline.css` (Glassmorphism 样式)。
    *   调用通用的 `renderHorizontalTimeline(data)` 函数（如果已封装为组件），或复制渲染逻辑并调整字段显示。
4.  **权限控制**: 确保 API 使用了正确的 `check_perm` 权限点。

---

## 5. UI/UX 规范 (Design Standards)

*   **视觉风格**: Glassmorphism (深色半透明背景), Neon Accents (高亮关键变更)。
*   **滚动**: 水平滚动 (Horizontal Scroll) 用于查看更多版本。
*   **空状态**: 如果没有修订历史（只有 V01），显示 "无修订记录" 或仅显示初始版本。
*   **Tooltip**: 鼠标悬停在变更值上时，显示原始值详情。
