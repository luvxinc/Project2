# 上传文件查看 (GlobalFileViewer) 工程参考

> **Purpose**: 本文档作为系统标准组件 `GlobalFileViewer` 及其配套上传流程的工程实现参考。以「采购订单-账单文件查看」功能为蓝本，解析前后端核心逻辑、存储规范及安全集成方式，供 AI Agent 在其他模块复用此功能时参考。

**相关文档引用**:
- [文件存储规范](../system/文件存储规范.md): 详细的目录结构与命名规则
- [密码策略](../safety/密码策略.md): 敏感操作（上传/删除）的安全校验流程
- [模块权限](../module/模块权限.md): 权限检查逻辑

---

## 1. 核心架构概述

该功能由三部分组成：
1.  **前端查看器 (`GlobalFileViewer`)**: 统一的文件预览、版本切换、下载与删除入口。
2.  **前端上传向导 (`Wizard`)**: 标准化的 3 步上传流程（选择 -> 确认 -> 完成），支持文件存在性检查与版本自增。
3.  **后端 API**: 提供文件元数据查询、文件流传输、上传处理（含版本控制）及删除接口。

---

## 2. 后端实现逻辑

参考文件: `backend/apps/purchase/views/po_mgmt/invoice.py`

### 2.1 文件存储命名规范

所有文件必须遵循确定性的存储路径和命名规则，严禁使用随机文件名。

*   **存储根路径**: `data/records/{module}/{entity}/{YYYY}/{sub_dir}/`
*   **命名格式**: `{identifier}_{type}_V{version}.{ext}`
*   **版本控制**: 使用 `_V##` (两位数字) 后缀，如 `_V01`, `_V02`。

**采购订单示例**:
```python
# 路径: data/records/purchase/po/2026/XX/
# 文件: PO2601001_invoice_V01.pdf
year = '20' + po_num[2:4]  # 从单号解析年份
supplier_code = po_num[:2] # 从单号解析供应商
```

### 2.2 核心 API 接口定义

#### A. 获取文件信息 (`get_invoice_info_api`)
*   **Input**: `identifier` (e.g., `po_num`)
*   **Logic**:
    1.  计算目标目录路径。
    2.  Glob 匹配所有版本文件 `*_{type}_V*`。
    3.  返回文件列表（按文件名降序排列，最新版本在前）。
*   **Output**: 
    ```json
    {
        "success": true,
        "data": {
            "has_file": true,
            "latest_file": "PO...V02.pdf",
            "files": [
                {"filename": "PO...V02.pdf", "size": 1024, "modified": ...},
                {"filename": "PO...V01.pdf", "size": 1024, "modified": ...}
            ]
        }
    }
    ```

#### B. 文件流服务 (`serve_invoice_file_api`)
*   **Input**: `identifier`, `filename`
*   **Logic**:
    1.  **安全检查**: 验证 `filename` 是否以 `identifier` 开头（防止路径遍历）。
    2.  **MIME 处理**: 针对特殊格式（.heic, .xlsx等）设置正确的 Content-Type。
    3.  **Headers**: 设置 `X-Frame-Options: SAMEORIGIN` 允许在 iframe 中预览。
*   **Output**: `FileResponse` (Binary Stream)

#### C. 文件上传 (`upload_po_invoice_api`)
*   **Input**: `Multipart/Form-Data` (File + Metadata)
*   **Logic**:
    1.  **权限检查**: 验证用户是否有写入权限。
    2.  **版本计算**: 扫描目录下现有文件，解析最大版本号，新版本 = Max + 1。
    3.  **原子写入**: 直接写入新版本文件（不覆盖旧文件）。
    4.  **安全日志**: 记录上传操作日志。

#### D. 文件删除 (`delete_po_invoice_api`)
*   **Input**: `JSON` { identifier, filename }
*   **Logic**:
    1.  **权限检查**: 必须验证写入权限。
    2.  **安全检查**: 验证文件名匹配。
    3.  **物理删除**: `path.unlink()`。

---

## 3. 前端组件实现

参考文件: 
- `backend/static/js/global_file_viewer.js` (核心组件库)
- `backend/templates/purchase/pages/po_mgmt.html` (调用示例)

### 3.1 查看器组件 (`GlobalFileViewer`)

用于展示文件详情、预览图/PDF、历史版本切换。

**初始化示例**:
```javascript
const viewer = new GlobalFileViewer({
    containerId: 'file-view-container',
    title: '账单文件查看',
    identifierLabel: '订单号',
    identifierValue: poNum,
    files: fileList,          // 从 API 获取的文件列表
    currentFile: latestFile,  // 当前显示的文件名
    
    // URL 生成回调
    getFileUrl: (fname, year) => `/api/serve?file=${fname}`,
    
    // 动作回调
    onUpload: () => openUploadWizard(poNum),
    onBack: () => returnToList(),
    
    // 删除配置 (集成安全验证)
    deleteUrl: '/api/delete/',
    deletePayload: { po_num: poNum },
    requireDeletePassword: true,
    deletePasswordActionKey: 'btn_po_delete_invoice'
});
```

**关键特性**:
*   **预览支持**: 自动识别 Image/PDF 并渲染；不支持的格式显示下载按钮。
*   **版本控制**: 顶部下拉框可切换查看历史版本。
*   **安全删除**: 集成 `requestPasswordVerify`，操作前弹出密码框。

### 3.2 上传向导 (`Wizard Pattern`)

采用标准的 **3-Step Wizard** 模式：

1.  **Step 1: 选择文件**
    *   使用 `GlobalFileUpload` 组件（Dropzone）。
    *   前端校验文件类型与大小。

2.  **Step 2: 确认信息**
    *   展示文件名、大小、**目标版本号**。
    *   **版本预测**: 调用 API 检查是否存在旧文件，若存在则提示"将生成新版本 VerXX"。
    *   **安全验证**: 点击确认时触发 `requestPasswordVerify` (如需)。

3.  **Step 3: 上传结果**
    *   展示成功/失败状态。
    *   提供"返回列表"按钮，触发刷新回调。

---

## 4. 关键集成点 (Integration Checklist)

在复用此功能时，请确保检查以下点：

1.  [ ] **URL 配置**: `urls.py` 中必须注册上述 4 个标准 API。
2.  [ ] **目录权限**: 确保 `settings.DATA_DIR` 下的目标目录已自动创建 (`mkdir(parents=True)`)。
3.  [ ] **密码策略**: 在 `action_registry.json` 中注册对应的 Action Key (如上传/删除)。
4.  [ ] **CSRF**: 前端 Fetch 请求必须携带 `X-CSRFToken`。
5.  [ ] **MIME Types**: 确保后端 `serve` 接口处理了非标准 MIME 类型（如 `.heic`）。

## 5. 常见问题 (Troubleshooting)

*   **HEIC 图片不显示**: 浏览器不支持原生 HEIC。解决方案：后端需转换为 JPEG 或前端提示下载。当前策略是后端透传，前端 `GlobalFileViewer` 会尝试用 `img` 标签显示（Chrome/Edge 已部分支持），或回退到下载。
*   **Iframe Refused**: 必须在后端 Response Header 设置 `X-Frame-Options: SAMEORIGIN`，否则 PDF 预览会被浏览器拦截。
*   **路径遍历漏洞**: 后端必须严格校验 `filename.startswith(id)`，防止通过 `../../` 访问系统文件。
