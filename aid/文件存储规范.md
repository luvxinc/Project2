# 文件存储规范 v1.1

> **生效日期**: 2026-01-04
> **适用范围**: 所有业务模块的文件上传/下载功能
> **主目录**: `{PROJECT_ROOT}/data/records/`

---

## 一、目录结构总览

```
data/records/
├── purchase/                    # 采购板块
│   ├── po/                      # 订单管理（厂商账单）
│   │   └── {YYYY}/              # 按年份分组
│   │       └── {supplier_code}/ # 按供应商代码分组
│   │           └── {文件}
│   ├── send/                    # 发货单管理（物流账单）
│   │   └── {YYYY}/              # 按年份分组
│   │       └── {文件}
│   └── receive/                 # 入库管理（入库凭证）
│       └── {YYYY}/              # 按年份分组
│           └── {文件}
│
└── finance/                     # 财务板块
    ├── logistic/                # 物流付款凭证
    │   └── {YYYY}/              # 按年份分组
    │       └── {pmt_no}/        # 按付款批次号分组
    │           └── {文件}
    │
    └── po/                      # [预留] PO付款（采购订单付款）
        └── {YYYY}/              # 按年份分组
            └── {pmt_no}/        # 按付款批次号分组
                └── {文件}
```

---

## 二、命名规范

### 2.1 通用规则

| 要素 | 格式 | 示例 |
|------|------|------|
| 年份 (YYYY) | 4位数字 | `2026` |
| 日期 (YYYYMMDD) | 8位数字，**无连字符** | `20260104` |
| 版本号 | `_V##` (2位数字) | `_V01`, `_V02` |
| 扩展名 | 小写 | `.pdf`, `.jpg`, `.xlsx` |

### 2.2 各模块文件命名

#### 📦 订单管理 (PO) - 厂商账单

| 项目 | 规范 |
|------|------|
| **目录** | `data/records/purchase/po/{YYYY}/{supplier_code}/` |
| **文件名** | `{po_num}_invoice_V##.{ext}` |
| **示例** | `data/records/purchase/po/2026/XX/XX20260104S01_invoice_V01.pdf` |

**说明**:
- `YYYY`: 订单年份（从 `po_num` 中的日期部分解析，如 `XX20260104S01` → 2026）
- `supplier_code`: 订单号前两位（如 `XX`）
- `po_num`: 完整订单号（**去除连字符**，如 `XX20260104S01`）

---

#### 🚚 发货单管理 (Send) - 物流账单

| 项目 | 规范 |
|------|------|
| **目录** | `data/records/purchase/send/{YYYY}/` |
| **文件名** | `{logistic_num}_invoice_V##.{ext}` |
| **示例** | `data/records/purchase/send/2026/L260104001_invoice_V01.pdf` |

**说明**:
- `YYYY`: 发货年份（从 `date_sent` 或 `logistic_num` 解析）
- `logistic_num`: 物流单号

---

#### 📥 入库管理 (Receive) - 入库凭证

| 项目 | 规范 |
|------|------|
| **目录** | `data/records/purchase/receive/{YYYY}/` |
| **文件名** | `{receive_date}_{logistic_num}_V##.{ext}` |
| **示例** | `data/records/purchase/receive/2026/20260104_L260104001_V01.pdf` |

**说明**:
- `YYYY`: 入库年份
- `receive_date`: 入库日期 (YYYYMMDD，无连字符)
- `logistic_num`: 物流单号

---

#### 💰 物流付款 (Logistic Payment) - 付款凭证

| 项目 | 规范 |
|------|------|
| **目录** | `data/records/finance/logistic/{YYYY}/{pmt_no}/` |
| **文件名** | `{pmt_no}_V##.{ext}` |
| **示例** | `data/records/finance/logistic/2026/20260104_S01/20260104_S01_V01.pdf` |

**说明**:
- `YYYY`: 付款年份
- `pmt_no`: 付款批次号（格式 `YYYYMMDD_S##`，**无连字符**）
- 每个付款批次独立目录，便于管理多个凭证文件

---

#### 🧾 [预留] PO付款 (PO Payment) - 采购订单付款凭证

| 项目 | 规范 |
|------|------|
| **目录** | `data/records/finance/po/{YYYY}/{pmt_no}/` |
| **文件名** | `{pmt_no}_V##.{ext}` |
| **示例** | `data/records/finance/po/2026/20260104_P01/20260104_P01_V01.pdf` |

**说明**:
- `YYYY`: 付款年份
- `pmt_no`: 付款批次号（格式 `YYYYMMDD_P##`，P 表示 PO Payment）

---

## 三、版本控制规则

1. **首次上传**: 版本号为 `V01`
2. **后续上传**: 自动递增 (`V02`, `V03`...)
3. **版本检测**: 扫描目录中已有文件，取最大版本号 + 1
4. **保留历史**: 不覆盖旧版本，所有版本均保留

---

## 四、配置常量

```python
# backend/common/settings.py

from pathlib import Path

# 文件存储根目录
RECORDS_DIR = BASE_DIR.parent / 'data' / 'records'

# 各模块子目录
PO_INVOICE_DIR = RECORDS_DIR / 'purchase' / 'po'
SEND_INVOICE_DIR = RECORDS_DIR / 'purchase' / 'send'
RECEIVE_FILE_DIR = RECORDS_DIR / 'purchase' / 'receive'
LOGISTIC_PAYMENT_DIR = RECORDS_DIR / 'finance' / 'logistic'
PO_PAYMENT_DIR = RECORDS_DIR / 'finance' / 'po'  # [预留]

# 支持的文件扩展名
ALLOWED_FILE_EXTENSIONS = [
    '.pdf', '.jpg', '.jpeg', '.png', '.gif', 
    '.heic', '.heif', '.xls', '.xlsx', 
    '.doc', '.docx', '.csv', '.zip', '.rar'
]

# 最大文件大小 (50MB)
MAX_UPLOAD_SIZE_MB = 50
```

---

## 五、安全约束

1. **路径遍历防护**: 文件名不允许包含 `..` 或 `/`
2. **白名单扩展名**: 仅允许上述列表中的扩展名
3. **文件名校验**: 必须以预期前缀开头
4. **最大文件大小**: 50MB

---

## 六、迁移记录

| 日期 | 操作 |
|------|------|
| 2026-01-04 | 初始迁移：将旧目录文件迁移至 `data/records/` |

### 已迁移文件清单

```
data/records/purchase/po/2025/XX/XX20251227S01_invoice_V01.pdf
data/records/purchase/po/2026/XX/XX20260102S01_invoice_V01.png
data/records/purchase/po/2026/XX/XX20260105S01_invoice_V01.pdf
data/records/purchase/send/2026/TEST1_invoice_V01.pdf
data/records/purchase/receive/2026/20260131_TEST1_V01.pdf
```

### 已删除的旧目录

- `data/po_invoices/`
- `data/logistic/`
- `data/receiving/`
- `storage/finance/`
