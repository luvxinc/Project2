# 数据目录结构规范 v2.0

> **Purpose**: 标准化项目数据目录结构，统一 `data/` 为唯一数据根目录
> **AI Attention**: 处理文件存储功能时，**必须** 严格遵守此规范
> **Constraints**: `HARD` - 目录结构不可随意更改
> **Last Updated**: 2026-01-11

---

## 一、核心原则

1. **单一数据根目录**: 所有持久化数据统一存放在 `data/` 目录下
2. **按用途分层**: 第一层按数据用途分类（业务记录、系统备份、用户导出等）
3. **按时间分组**: 第二层按年份或日期分组，便于归档和清理
4. **版本化存储**: 文件不覆盖，采用版本号递增

---

## 二、目录结构总览

```
data/
├── records/              # 业务记录文件（已有规范）
│   ├── purchase/         # 采购模块附件
│   └── finance/          # 财务模块附件
│
├── exports/              # 用户导出文件（原 backups/user_exports）
│   ├── reports/          # 报表导出 (CSV/Excel)
│   │   └── {username}/   # 按用户分组
│   └── db/               # 数据库导出
│
├── backups/              # 系统备份（自动生成）
│   ├── db/               # 数据库备份快照
│   ├── rollback/         # 回滚点快照
│   └── logs/             # 日志归档
│
├── cache/                # 临时缓存（可清理）
│   └── restore/          # 恢复操作临时文件
│
├── barcodes/             # 条码图片
│   └── {username}/       # 按用户分组
│
├── templates_csv/        # CSV 模板文件
│
├── archive/              # 历史归档
│
├── knowledge_base/       # 知识库
│
└── chat_history/         # 聊天历史
```

---

## 三、目录迁移映射

| 原路径 | 新路径 | 说明 |
|-------|-------|------|
| `backups/user_exports/` | `data/exports/` | 用户导出文件 |
| `backups/db/` | `data/backups/db/` | 数据库备份 |
| `backups/rollback/` | `data/backups/rollback/` | 回滚快照 |
| `backups/log_archives/` | `data/backups/logs/` | 日志归档 |
| `backups/Archived_CSVs/` | `data/archive/csv/` | 历史CSV归档 |
| `backups/full_snapshots/` | `data/backups/snapshots/` | 完整快照 |
| `backups/in_pos/` | `data/archive/pos/` | POS历史数据 |
| `backups/prompts/` | `data/archive/prompts/` | 提示词归档 |
| `output/` | `data/exports/reports/` | 报表输出 |

---

## 四、Settings.py 配置

```python
# backend/common/settings.py

# ===========================================
# 数据目录定义 (Data Directory Definitions)
# ===========================================

# 主数据根目录
DATA_DIR = BASE_DIR / "data"

# --- 业务记录 (已有) ---
RECORDS_DIR = DATA_DIR / "records"

# --- 用户导出 (新增) ---
EXPORTS_DIR = DATA_DIR / "exports"
REPORTS_EXPORT_DIR = EXPORTS_DIR / "reports"    # 报表导出
DB_EXPORT_DIR = EXPORTS_DIR / "db"              # 数据库导出

# --- 系统备份 (调整) ---
BACKUPS_DIR = DATA_DIR / "backups"
DB_BACKUP_DIR = BACKUPS_DIR / "db"              # 数据库备份
ROLLBACK_DIR = BACKUPS_DIR / "rollback"         # 回滚快照
LOG_ARCHIVE_DIR = BACKUPS_DIR / "logs"          # 日志归档
SNAPSHOT_DIR = BACKUPS_DIR / "snapshots"        # 完整快照

# --- 缓存 (可清理) ---
CACHE_DIR = DATA_DIR / "cache"
RESTORE_TEMP_DIR = CACHE_DIR / "restore"        # 恢复临时

# --- 其他 ---
BARCODE_DIR = DATA_DIR / "barcodes"
TEMPLATE_CSV_DIR = DATA_DIR / "templates_csv"
ARCHIVE_DIR = DATA_DIR / "archive"
KNOWLEDGE_BASE_DIR = DATA_DIR / "knowledge_base"
CHAT_HISTORY_DIR = DATA_DIR / "chat_history"

# --- 兼容别名 (Deprecated) ---
BACKUP_DIR = EXPORTS_DIR          # 旧代码兼容
USER_EXPORT_DIR = EXPORTS_DIR     # 旧代码兼容
OUTPUT_DIR = REPORTS_EXPORT_DIR   # 旧代码兼容
```

---

## 五、迁移步骤

### 5.1 创建新目录结构

```bash
mkdir -p data/exports/reports data/exports/db
mkdir -p data/backups/db data/backups/rollback data/backups/logs data/backups/snapshots
mkdir -p data/cache/restore
mkdir -p data/archive/csv data/archive/pos data/archive/prompts
```

### 5.2 迁移数据

```bash
# 用户导出
mv backups/user_exports/* data/exports/ 2>/dev/null

# 数据库备份
mv backups/db/* data/backups/db/ 2>/dev/null

# 回滚快照
mv backups/rollback/* data/backups/rollback/ 2>/dev/null

# 日志归档
mv backups/log_archives/* data/backups/logs/ 2>/dev/null

# 完整快照
mv backups/full_snapshots/* data/backups/snapshots/ 2>/dev/null

# 归档数据
mv backups/Archived_CSVs/* data/archive/csv/ 2>/dev/null
mv backups/in_pos/* data/archive/pos/ 2>/dev/null
mv backups/prompts/* data/archive/prompts/ 2>/dev/null

# 报表输出
mv output/* data/exports/reports/ 2>/dev/null

# 清理旧目录
rm -rf backups output
```

---

## 六、代码更新清单

需要更新以下文件中的路径常量引用：

1. `backend/common/settings.py` - 主配置
2. `backend/apps/audit/utils.py` - 审计工具
3. `backend/apps/audit/core/archiver.py` - 日志归档
4. `backend/apps/audit/core/snapshot.py` - 快照管理
5. `backend/apps/user_admin/core/utils.py` - 用户管理工具
6. `backend/core/services/database_service.py` - 数据库服务
7. `backend/core/services/report_manager.py` - 报表管理
8. `backend/core/services/data_processing.py` - 数据处理
9. `backend/core/services/logistics.py` - 物流服务

---

## 七、清理规则

| 目录 | 保留策略 | 说明 |
|------|---------|------|
| `data/cache/` | 随时可清理 | 临时文件 |
| `data/backups/db/` | 保留最近 10 个 | 数据库快照 |
| `data/backups/rollback/` | 保留最近 20 个 | 回滚点 |
| `data/backups/logs/` | 保留 30 天 | 日志归档 |
| `data/exports/reports/` | 保留 90 天 | 报表导出 |
| `data/records/` | 永久保留 | 业务凭证 |

---

## 八、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-01-04 | 初版：records 目录规范 |
| v1.1 | 2026-01-09 | 添加预付款、定金付款目录 |
| v2.0 | 2026-01-11 | 统一数据目录结构，合并 backups/output 到 data/ |
