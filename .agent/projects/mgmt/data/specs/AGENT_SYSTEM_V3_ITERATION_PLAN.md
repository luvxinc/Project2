# Agent System V3 迭代计划 (V2 — 用户反馈后修订)

> **修订时间**: 2026-02-12 14:57 PST
> **修订原因**: V1 计划太乐观。V2→V3 迁移实测暴露: QA 太弱 / 协作遗漏 / SOP 不够详细 / 工具箱无索引

---

## 零、用户反馈 (核心痛点)

| # | 痛点 | 用户原话 | 根因 |
|---|------|---------|------|
| 🔴 **P1** | SOP 太弱 | "所有职务职责, 说明, 流程, SOP 都太弱了" | L1 管理层 SOP 只有流程框架, 缺少**具体执行细节** |
| 🔴 **P2** | QA 太弱 | "QA 和测试环节非常弱, 很多内容没有被发现" | 审计清单不够细, 缺少**具体验证命令和脚本** |
| 🔴 **P3** | 协作遗漏 | "各部门协作太差, 遗漏太多内容没有做好修改" | 交接清单缺少**强制验证项**, 无跨文件影响分析 |
| 🔴 **P4** | 工具箱无索引 | "技能需要目录索引, 按需加载, 按长度切片" | 工具箱文件是索引卡, 缺少**详细内容切片** |

---

## 一、迭代方向 (不再"保持")

### V1 计划的错误
V1 将 PM/CTO/QA/Collaboration 全标 "✅ 保持"。
**实际证据反驳**: V2→V3 迁移中数据遗漏、未删旧引用、前后端不同步、QA 未发现问题。

### V2 计划的原则
1. **每个 SOP 都升级** — 从"概念正确"到"可执行"
2. **切片 + 索引** — 大文件拆分, 小文件补充细节, 统一索引
3. **强制验证门** — 每个角色完成后有**具体命令**验证
4. **交叉检查** — 任何修改必须触发**影响分析清单**

---

## 二、工具箱改造 (P4)

### 2.1 问题: 工具箱索引卡太薄

当前 7 个工具文件 (1.7-2.7KB) 只是索引卡，缺少可操作的详细内容。

### 2.2 解决方案: 切片 + 目录索引

```
warehouse/
├── README.md                        # 总索引 ✅ 已有
└── tools/
    ├── everything-claude-code/      # 🆕 从 .md → 文件夹
    │   ├── INDEX.md                 # 目录索引 (路由表 + 切片说明)
    │   ├── 01-architecture.md       # ECC 架构模式
    │   ├── 02-agents.md             # 12 Agent 详细参考
    │   ├── 03-verification.md       # 验证循环详解
    │   └── 04-rules-hooks.md        # Rules + Hooks 设计
    │
    ├── ui-ux-pro-max/               # 🆕 从 .md → 文件夹
    │   ├── INDEX.md                 # 目录索引
    │   ├── 01-styles.md             # 67 风格详细清单 (含示例)
    │   ├── 02-palettes.md           # 96 配色方案详表 (含 HEX)
    │   ├── 03-typography.md         # 57 字体配对 (含 Google Fonts 链接)
    │   ├── 04-ux-rules.md           # 99 UX 准则 (含反模式)
    │   └── 05-pre-delivery.md       # 交付前自检 + 断点清单
    │
    ├── anthropic-skills/            # 🆕 从 .md → 文件夹
    │   ├── INDEX.md                 # 目录索引
    │   ├── 01-spec.md               # Agent Skills 官方规范全文
    │   └── 02-examples.md           # 核心示例技能详解
    │
    ├── knowledge-work-plugins/      # 🆕 从 .md → 文件夹
    │   ├── INDEX.md                 # 目录索引
    │   ├── 01-plugin-arch.md        # 插件架构详解 (plugin.json + .mcp.json)
    │   ├── 02-productivity.md       # productivity 插件详解 (参考落地)
    │   └── 03-domain-catalog.md     # 其余 10 插件速查
    │
    ├── claude-mem/                  # 🆕 从 .md → 文件夹
    │   ├── INDEX.md                 # 目录索引
    │   ├── 01-architecture.md       # 5 Hooks + SQLite + Chroma 详解
    │   └── 02-mcp-tools.md          # 5 MCP 工具详细用法 + 示例
    │
    ├── skill-seekers/               # 🆕 从 .md → 文件夹
    │   ├── INDEX.md                 # 目录索引
    │   ├── 01-commands.md           # 完整命令参考
    │   └── 02-c3-modules.md         # C3.x AI 增强模块详解
    │
    └── animejs.md                   # ✅ 保持 (已有 9.4KB 完整 API)
```

### 2.3 INDEX.md 模板

```markdown
---
name: {tool-name}
description: {一行描述}
source: {GitHub URL}
---

# {工具名}

## 切片目录

| 文件 | 内容 | 大小 | 何时加载 |
|------|------|------|---------|
| `01-xxx.md` | ... | ~XKB | 需要 xxx 时 |
| `02-yyy.md` | ... | ~YKB | 需要 yyy 时 |

## 快速参考 (不需要读切片即可用的信息)
...
```

---

## 三、L1 管理层 SOP 强化 (P1)

### 3.1 CTO 强化方向

当前 `chief-engineer.md` (5.9KB) 问题:
- ❌ 只有流程框架, 缺少**执行细节**
- ❌ 整合验证清单只有 7 项通用条目, 没有**具体命令**
- ❌ 没有**影响分析 SOP** (修改了 A, 还要检查 B/C/D)
- ❌ 没有**代码走查 SOP** (CTO 亲自审代码的标准)

**补充内容**:

```markdown
## §N CTO 整合验证 — 具体操作

### N.1 编译+类型验证
// 后端
./gradlew build --no-daemon 2>&1 | tail -20
// 确认: BUILD SUCCESSFUL

// 前端
cd apps/web && pnpm build 2>&1 | tail -30
// 确认: ✓ Compiled successfully

### N.2 跨文件影响分析 (🔴 核心 — 协作遗漏根源)
对于每个被修改的文件:
1. grep 全局搜索所有 import/引用该文件的位置
2. 检查 DTO/接口变更是否同步到 消费方
3. 检查路由变更是否同步到 前端 API Client
4. 检查数据库字段变更是否同步到 所有 Entity/DTO/前端类型

命令模板:
  grep -r "OldClassName" --include="*.kt" --include="*.tsx" --include="*.ts" .
  grep -r "旧路径" --include="*.tsx" .
  git diff --name-only HEAD~1 | head -50  # 查看所有变更文件

### N.3 接口一致性验证
对于每个 API 变更:
1. 后端 Controller → DTO 类型对齐
2. 前端 API Client → 调用路径对齐
3. 前端组件 → 使用的 DTO 字段对齐
4. i18n → 新增 key 已翻译

### N.4 数据完整性
1. Flyway 迁移脚本是否有对应的回滚脚本
2. 新字段是否有默认值 (避免 NOT NULL 崩溃)
3. 外键关系是否正确

### N.5 退回时的精确描述
退回不能只说"有问题", 必须:
- 列出具体文件和行号
- 说明预期行为 vs 实际行为
- 附带重现步骤 (如有)
```

### 3.2 PM 强化方向

当前 `project-manager.md` (6.8KB) 问题:
- ❌ 缺少**交付物完整性中的跨文件检查**
- ❌ 缺少**用户确认后的回归确认** (用户说 OK 后, 还要验证没弄坏别的)

**补充内容**:

```markdown
## §N PM 交付验收 — 升级版

### N.1 交付物完整性清单
PM 在收到 QA 通过的交付物后, 必须:
[ ] 原始需求中列的每一条都实现了
[ ] 启动应用 → 手动走一遍核心路径
[ ] 切换语言 → 新增文本有翻译
[ ] 切换主题 → 新增 UI 主题正确
[ ] 检查相关页面 → 未被破坏 (回归)

### N.2 用户确认后回归检查
用户说"好了"之后, PM 还要:
[ ] 运行 构建命令 确认无新错误
[ ] 快速抽查 2-3 个不相关页面
[ ] 确认 git 状态干净 (无遗留的 uncommitted 文件)
```

### 3.3 QA 审计师强化 (P2 — 核心)

当前 `qa-auditor.md` (9.4KB) 问题:
- ❌ 审计清单是通用条目, 没有**具体验证命令**
- ❌ 没有**分场景模板** (新模块 vs 修改 vs 迁移)
- ❌ 没有**深度回归** — 只检查新功能，不检查**关联功能**
- ❌ 没有**跨层验证** — 后端改了但没验前端是否同步

**补充内容**:

```markdown
## §N QA 深度审计 — 强化版

### N.1 分场景审计模板

#### 场景 A: 新功能开发
标准审计清单 (原有 14 项) + 以下:
[ ] 新 API 有 Swagger 文档
[ ] 新前端页面有 Loading/Error/Empty 三态
[ ] 新数据库字段有默认值 or 允许 NULL
[ ] 新 i18n key 在所有语言文件中存在

#### 场景 B: 修改现有功能
标准审计清单 + 以下:
[ ] 所有消费该 API 的前端页面已验证
[ ] 所有引用该 DTO 的文件已更新
[ ] 所有相关测试已更新
[ ] **影响半径分析**: grep 旧接口名, 确认零残留

#### 场景 C: V2→V3 迁移
标准审计清单 + 以下:
[ ] V2 Controller 的每个端点在 V3 有对应实现
[ ] V2 前端调用路径全部更新为 V3 路径
[ ] V2 DTO 字段与 V3 DTO 字段 1:1 对齐
[ ] V2 业务逻辑 (条件判断/计算/状态流转) 100% 复制到 V3
[ ] V2 中间件/Guard 功能在 V3 Security 中有对应
[ ] **删除检查**: 确认 V2 旧文件/旧路由已删除, 无残留

### N.2 具体验证命令

| 检查项 | 命令 | 通过标准 |
|--------|------|---------|
| 编译 | `./gradlew build --no-daemon` | BUILD SUCCESSFUL |
| 前端构建 | `pnpm build` | ✓ Compiled |
| 类型检查 | `pnpm tsc --noEmit` | 零错误 |
| 旧引用残留 | `grep -r "旧模块名" --include="*.kt" --include="*.ts" .` | 零匹配 |
| API 一致性 | `curl localhost:8080/api/v1/{endpoint}` | 200 + 正确响应 |
| 数据库一致性 | `SELECT * FROM {table} LIMIT 5;` | 字段符合预期 |

### N.3 影响半径分析 (🔴 必做 — 解决协作遗漏根源)

对每个被修改的文件, QA 必须执行:

1. **向下追踪** (谁消费了我?)
   grep -r "import.*{FileName}" --include="*.kt" --include="*.tsx" .

2. **向上追踪** (我依赖了谁?)
   查看该文件的 import 列表 → 这些依赖是否也变了?

3. **横向追踪** (平级文件是否同步?)
   同目录下的其他文件是否需要对应修改?

4. **前后端追踪** (API 两端是否对齐?)
   后端 Controller 变了 → 前端 API Client 呢?
   前端需要新字段 → 后端 DTO 出了吗?
```

### 3.4 协作 SOP 强化 (P3)

当前 `collaboration.md` (4.9KB) 问题:
- ❌ 交接只有记录格式, 没有**强制验证项**
- ❌ 没有**变更传播检查** — A 改了, B 不知道
- ❌ 没有**完成后通知机制**

**补充内容**:

```markdown
## §N 变更传播协议 (🔴 新增 — 协作遗漏根源解决)

### N.1 变更影响矩阵

当以下文件被修改时, **必须**通知对应工程师:

| 变更源 | 影响方 | 必须同步的内容 |
|--------|--------|---------------|
| DB Schema (Migration) | 后端 Entity | 字段名/类型/约束 |
| 后端 Entity | 后端 DTO | 字段映射 |
| 后端 DTO | 前端 API Client | 类型定义 |
| 前端 API Client | 前端组件 | Props/调用方式 |
| API 路径 | 前端 + 后端 + Nginx | URL 同步 |
| 权限矩阵 | 后端 Security + 前端 Guard | 权限码 |
| i18n Key | 所有语言文件 | 翻译 |

### N.2 完成后传播检查 (每个工程师必做)

工程师在完成自己的部分后:
1. 列出本次修改的所有文件
2. 对照影响矩阵, 检查是否有下游影响
3. 如有影响 → 通知 CTO 安排下游工程师同步
4. 如无影响 → 在交接记录中明确标注 "无下游影响"

### N.3 CTO 协调检查点

CTO 在收到工程师交付后, 必须:
[ ] 检查影响矩阵 → 所有下游是否已安排同步
[ ] 如果有链式影响 (A→B→C), 确认**全链路**都安排了
[ ] 在任务分配单中标注: "已安排 X/Y/Z 同步"
```

---

## 四、执行路线

### Phase 1: 工具箱升级 + 索引系统 (P4)
**预计**: 当前会话内
**内容**:
- [x] 创建 7 个工具的 INDEX.md + 切片结构
- [x] 从 GitHub 抓取详细内容填充切片
- [x] 更新 warehouse/README.md 全局索引

### Phase 2: L1 管理层 SOP 全面强化 (P1+P2+P3)
**预计**: 当前或下一会话
**内容**:
- [ ] CTO SOP: +代码走查 +影响分析 +具体验证命令
- [ ] PM SOP: +交付完整性中跨文件检查 +回归确认
- [ ] QA SOP: +分场景审计模板 +具体命令 +影响半径分析
- [ ] Collaboration SOP: +变更传播协议 +影响矩阵 +传播检查

### Phase 3: Rules 层 + 自检机制 (原 V1 计划)
**预计**: 后续会话
**内容**:
- [ ] 创建 `core/rules/` 目录
- [ ] 工程师自检 SOP (backend.md + frontend.md)
- [ ] 反模式清单
- [ ] agent-mastery.md 精简

---

## 五、预期成果

| 指标 | 修订前 | 修订后目标 |
|------|--------|-----------|
| CTO 验证深度 | 7 条通用条目 | 20+ 条含具体命令 |
| QA 审计覆盖 | 14 项通用 | 14 项通用 + 分场景模板 (3 种) |
| 协作遗漏 | 无检查机制 | 影响矩阵 + 传播检查 + CTO 协调检查点 |
| 交接验证 | 4 项确认 | 4 项确认 + 强制影响分析 |
| 工具箱详细度 | 1.7-2.7KB 索引卡 | 切片目录 + 详细切片文件 |
| 工程完整性 | 靠记忆 | 靠清单 + 命令 + 矩阵 |
