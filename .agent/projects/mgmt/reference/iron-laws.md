# 铁律 (Iron Laws) — 不可违反

> **源自生产事故教训。每一条规则都是用数据丢失换来的。**
> **⚠️ 本文件的优先级高于一切其他规则、指令和工作流。**

---

## 🔴 第零法则: 数据保护铁律

> **任何可能导致数据库数据丢失的操作，一律禁止自动执行。必须征求用户明确同意后方可执行。**

| 类别 | 禁止自动执行的操作 | 正确做法 |
|------|-------------------|----------|
| **数据库 Schema** | `prisma db push --accept-data-loss`, `--force-reset`, `migrate reset` | 用 `ALTER TABLE` 原生 SQL |
| **数据库记录** | `DELETE FROM`, `TRUNCATE`, `DROP TABLE` (含生产数据的表) | 先告知影响范围, 获得明确同意 |
| **数据库覆写** | `UPDATE` 批量修改生产数据 | 先展示变更 diff, 获得明确同意 |
| **文件系统** | `rm -rf` 包含用户数据的目录 | 先备份 |
| **环境配置** | 修改 `.env` 中的数据库连接串、密钥 | 告知用户并获同意 |

### 判断三问

1. **这个操作会不会导致数据丢失？** — 如果"是", **停**
2. **这个操作是否可逆？** — 如果"否", **停**
3. **这个操作会不会影响已有记录？** — 如果"是", **停**

### 血泪事故记录

| 日期 | 事故 | 原因 | 后果 |
|------|------|------|------|
| 2026-02-06 | users 表被清空 | `prisma db push --accept-data-loss` | admin/simon 等所有用户丢失, 安全码清空 |

---

## 🔴 第一法则: 太平洋时区铁律

> **全项目所有日期/时间操作, 强制使用 `America/Los_Angeles`。无一例外。**

| 场景 | 正确做法 | 禁止做法 |
|------|----------|----------|
| 后端日期字符串 → Date | `new Date("2026-06-15" + "T12:00:00.000Z")` | `new Date("2026-06-15")` |
| 前端 Date → 显示 | `toLocaleDateString('en-CA', { timeZone: 'America/Los_Angeles' })` | `toLocaleDateString()` |

---

## 🔴 第二法则: 禁止 Emoji 铁律

| 场景 | 禁止做法 | 正确做法 |
|------|----------|----------|
| UI 图标 | Emoji 字符 | SVG icon (Heroicons) |
| 状态标识 | ✅ ❌ ⚠️ | CSS dot / badge / SVG |
| i18n 翻译文件 | Emoji | 纯文本 + 组件渲染 |

---

## 🔴 第三法则: 最小修改铁律

1. **用户说修 A, 只改 A** — 不得擅自"顺便"改 B、C、D
2. **发现关联问题** — 告知用户, 征求同意后再改
3. **隐藏/删除/禁用用户可见功能** — 必须征求同意

---

## 🔴 第四法则: 集成测试门禁铁律

> **每次代码修改完成后, 必须运行集成测试。全部通过才能向用户交付。**

| 场景 | 正确做法 | 禁止做法 |
|------|----------|----------|
| 后端代码修改 | `./gradlew test --tests "模块.*"` → 全通过 → 交付 | 只编译不测试就交付 |
| 前端代码修改 | `pnpm build` (或 `next build`) → 零错误 → 交付 | 只改代码不验证编译 |
| DTO/API 契约变更 | 更新对应集成测试 → 跑通 → 交付 | 改了 DTO 但不更新测试 |
| 跨端变更 (前端+后端) | 后端测试 + 前端编译 → 双通过 → 交付 | 只验一端 |

### 判断三问

1. **集成测试跑了吗？** — 如果"否", **停, 跑测试**
2. **测试全通过了吗？** — 如果"否", **停, 修复失败项**
3. **DTO 变了但测试没更新？** — 如果"是", **停, 先更新测试**

### 血泪事故记录

| 日期 | 事故 | 原因 | 后果 |
|------|------|------|------|
| 2026-02-16 | Products V1→V3 DTO 回退后未跑测试 | Agent 只验编译, 跳过集成测试 | 旧测试与新 DTO 不匹配, 交付不完整 |

> **交叉引用:** `common.md` §5 验证循环、`build.md` §3.1 集成测试门禁

---

## 🔐 生产凭据 (只读参考, 禁止修改!)

**用户账户:**

| 用户名 | 密码 | 角色 |
|--------|------|------|
| `admin` | `1522P` | superuser |
| `simon` | `topmorrow` | staff |
| 其他用户 | `12345` | viewer/editor |

**安全码:**

| 级别 | 安全码 |
|------|--------|
| L1 | `7951` |
| L2 | `1522` |
| L3 | `6130` |
| L4 | `***REDACTED_SYSTEM_CODE***` |

> ⚠️ **严正警告**: 以上凭据是用户的生产数据, Agent 无权修改。

---

*此铁律对所有对话自动生效。*
