# V3 è¿ç§»è®¡åˆ’ â€” V2 â†’ V3 åˆ†é˜¶æ®µæ‰§è¡Œè·¯çº¿

> **V2 åˆ° V3 çš„è¿ç§»æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹ã€‚æœ¬æ–‡æ¡£å®šä¹‰åˆ†é˜¶æ®µæ‰§è¡Œè·¯å¾„ã€‚**
> **æ ¸å¿ƒåŸåˆ™: ä¸šåŠ¡é›¶ä¸­æ–­, å‰ç«¯æ— æ„ŸçŸ¥, æ•°æ®é›¶ä¸¢å¤±ã€‚**
> **V1 æ·±åº¦åˆ†æ**: `reference/v1-deep-dive.md` (30+ MySQL è¡¨å…¨æ™¯, V1â†’V3 è¿ç§»æ—¶å¿…è¯»)

---

## 1. è¿ç§»åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å¥‘çº¦é©±åŠ¨** | å‰åç«¯é€šè¿‡ OpenAPI 3.0 å¥‘çº¦è§£è€¦ â€” åç«¯æ¢äº†, å‰ç«¯æ— æ„Ÿ |
| **å¹¶è¡Œè¿è¡Œ** | V2 NestJS å’Œ V3 Spring Boot å¯ä»¥å¹¶è¡Œè¿è¡Œä¸€æ®µæ—¶é—´ |
| **æ¨¡å—é€ä¸ªè¿ç§»** | ä¸åšå¤§çˆ†ç‚¸å¼è¿ç§», ä¸€ä¸ªæ¨¡å—ä¸€ä¸ªæ¨¡å—åˆ‡ |
| **æ•°æ®åº“å…±ç”¨** | V2 å’Œ V3 å…±ç”¨åŒä¸€ä¸ª PostgreSQL, Prisma schema è¿ç§»åˆ° Flyway |
| **ç°åº¦åˆ‡æ¢** | API Gateway åšæµé‡åˆ‡æ¢ â€” å…ˆåˆ‡ 10% â†’ 50% â†’ 100% |
| **å›æ»šèƒ½åŠ›** | æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥å›æ»šåˆ° V2 |

---

## 2. è¿ç§»äº”é˜¶æ®µ

```
Phase 0                Phase 1              Phase 2              Phase 3              Phase 4
åŸºç¡€è®¾æ–½å‡†å¤‡            æ ¸å¿ƒåç«¯è¿ç§»          æ•°æ®å±‚æ‰©å±•            è¾…åŠ©æ¨¡å—è¿ç§»          V2 é€€å½¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€
[2-3 å‘¨]               [4-6 å‘¨]             [3-4 å‘¨]             [4-6 å‘¨]             [2 å‘¨]

Docker Compose         Auth + Users         Kafka é›†æˆ           Purchase             åœæ‰ NestJS
Kotlin é¡¹ç›®éª¨æ¶        Products             OpenSearch           Sales                åˆ é™¤ V2 ä»£ç 
Flyway åˆå§‹åŒ–          VMA (æ ¸å¿ƒ)           ClickHouse           Inventory            æ¸…ç† Prisma
CI/CD åŸºç¡€             Logs (å®¡è®¡)          Redis å¢å¼º           Finance              æ›´æ–°æ–‡æ¡£
                       OpenAPI å¥‘çº¦                              DB Admin
                       API Gateway                               æ‰¹å¤„ç† (Batch)
```

---

## 3. Phase 0 â€” åŸºç¡€è®¾æ–½å‡†å¤‡ (2-3 å‘¨)

### ç›®æ ‡: æ­å»º V3 é¡¹ç›®éª¨æ¶, ä¸å½±å“ V2 è¿è¡Œ

| ä»»åŠ¡ | è¯¦æƒ… | äº¤ä»˜ç‰© |
|------|------|--------|
| 1. åˆ›å»º Kotlin + Spring Boot é¡¹ç›® | `apps/api-v3/` ç›®å½•, Gradle æ„å»º | å¯å¯åŠ¨çš„ Spring Boot åº”ç”¨ |
| 2. é…ç½® Flyway | ä» Prisma schema å¯¼å‡º SQL, ä½œä¸º V1 åŸºçº¿ | `V1__baseline.sql` |
| 3. é…ç½® Spring Security | JWT éªŒè¯ (å…¼å®¹ V2 Token æ ¼å¼) | å¯ä»¥éªŒè¯ V2 å‘å‡ºçš„ Token |
| 4. é…ç½® OpenAPI springdoc | è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ | `openapi.json` |
| 5. docker-compose æœ¬åœ°ç¯å¢ƒ | PG + Redis + Kafka + OpenSearch | ä¸€é”®å¯åŠ¨ |
| 6. CI ç®¡é“ | GitHub Actions â€” build + test | è‡ªåŠ¨åŒ–æ„å»º |
| 7. ArchUnit æµ‹è¯• | DDD åˆ†å±‚çº¦æŸéªŒè¯ | æ¶æ„çœ‹é—¨ç‹— |

### å…³é”®å†³ç­–

```
Prisma Schema â†’ Flyway åŸºçº¿çš„æ–¹å¼:

1. ä½¿ç”¨ prisma db pull è·å–å½“å‰ PG schema
2. å¯¼å‡ºä¸º raw SQL (pg_dump --schema-only)
3. ä½œä¸º Flyway V1__baseline.sql
4. è®¾ç½® Flyway baselineOnMigrate=true
5. åç»­æ‰€æœ‰ DDL å˜æ›´èµ° Flyway V2, V3...
```

---

## 4. Phase 1 â€” æ ¸å¿ƒåç«¯è¿ç§» (4-6 å‘¨)

### ç›®æ ‡: å°†æ ¸å¿ƒæ¨¡å—ä» NestJS è¿ç§»åˆ° Spring Boot

### è¿ç§»é¡ºåº

| é¡ºåº | æ¨¡å— | åŸå›  | å¤æ‚åº¦ |
|------|------|------|--------|
| 1 | **Auth** | åŸºç¡€ä¾èµ–, æ‰€æœ‰æ¨¡å—éœ€è¦è®¤è¯ | â˜…â˜…â˜† |
| 2 | **Users** | Auth ä¾èµ– Users, RBAC æ ¸å¿ƒ | â˜…â˜…â˜… |
| 3 | **Logs** | å®¡è®¡ç³»ç»Ÿ, æ‰€æœ‰æ¨¡å—çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ | â˜…â˜…â˜† |
| 4 | **Products** | æ ¸å¿ƒä¸šåŠ¡å®ä½“, ç›¸å¯¹ç‹¬ç«‹ | â˜…â˜…â˜… |
| 5 | **VMA** | æ ¸å¿ƒä¸šåŠ¡æ¨¡å— (å‘˜å·¥/åŸ¹è®­/åº“å­˜) | â˜…â˜…â˜…â˜… |

### æ¯ä¸ªæ¨¡å—çš„è¿ç§»æ­¥éª¤

```
1. åˆ†æ V2 NestJS Service/Controller/DTO
    â†“
2. åˆ›å»º V3 Domain Model (Kotlin data class)
    â†“
3. åˆ›å»º V3 JPA Entity + Repository
    â†“
4. åˆ›å»º V3 UseCase + DTO
    â†“
5. åˆ›å»º V3 Controller (ä¿æŒç›¸åŒ URL è·¯å¾„)
    â†“
6. å†™æµ‹è¯• (å•å…ƒ + é›†æˆ)
    â†“
7. éªŒè¯ OpenAPI Spec ä¸ V2 ä¸€è‡´
    â†“
8. API Gateway æµé‡åˆ‡æ¢ (V2 â†’ V3)
    â†“
9. ç›‘æ§ 48 å°æ—¶æ— å¼‚å¸¸ â†’ ç¡®è®¤åˆ‡æ¢
```

### API Gateway æµé‡åˆ‡æ¢

```
Phase 1 åˆæœŸ:
  /api/v1/* â†’ V2 NestJS (100%)

Phase 1 ä¸­æœŸ (Auth/Users è¿ç§»å®Œæˆå):
  /api/v1/auth/*     â†’ V3 Spring Boot (100%)
  /api/v1/users/*    â†’ V3 Spring Boot (100%)
  /api/v1/*          â†’ V2 NestJS (å‰©ä½™)

Phase 1 å®Œæˆ:
  /api/v1/auth/*     â†’ V3
  /api/v1/users/*    â†’ V3
  /api/v1/products/* â†’ V3
  /api/v1/vma/*      â†’ V3
  /api/v1/logs/*     â†’ V3
  å…¶ä½™               â†’ V2
```

---

## 5. Phase 2 â€” æ•°æ®å±‚æ‰©å±• (3-4 å‘¨)

### ç›®æ ‡: å¼•å…¥ Kafka + OpenSearch + ClickHouse

| ä»»åŠ¡ | è¯¦æƒ… |
|------|------|
| Kafka éƒ¨ç½² | docker-compose (dev) + K8s (prod) |
| Kafka Topic åˆ›å»º | erp.inventory.events, erp.purchase.events, ... |
| OpenSearch éƒ¨ç½² | æœ¬åœ°å¼€å‘ + ç”Ÿäº§æ‰˜ç®¡ |
| ç´¢å¼•åŒæ­¥ | PG â†’ Kafka â†’ OpenSearch (products, orders) |
| ClickHouse éƒ¨ç½² | æœ¬åœ°å¼€å‘ + ç”Ÿäº§ |
| OLAP åŒæ­¥ | PG â†’ Kafka â†’ ClickHouse (sales, inventory) |
| æœç´¢ API | V3 æ¨¡å—æ¥å…¥ OpenSearch å…¨æ–‡æœç´¢ |
| æŠ¥è¡¨ API | V3 æ¨¡å—æ¥å…¥ ClickHouse èšåˆæŸ¥è¯¢ |

---

## 6. Phase 3 â€” è¾…åŠ©æ¨¡å—è¿ç§» (4-6 å‘¨)

### ç›®æ ‡: è¿ç§»å‰©ä½™ä¸šåŠ¡æ¨¡å—

| é¡ºåº | æ¨¡å— | å¤æ‚åº¦ |
|------|------|--------|
| 1 | **Purchase** (ä¾›åº”å•†/PO/å‘è´§/æ”¶è´§) | â˜…â˜…â˜…â˜…â˜… |
| 2 | **Sales** (äº¤æ˜“/ETL/FIFO) | â˜…â˜…â˜…â˜…â˜… |
| 3 | **Inventory** (FIFO å±‚/åº“å­˜åŠ¨æ€) | â˜…â˜…â˜…â˜… |
| 4 | **Finance** (ä»˜æ¬¾/é¢„ä»˜/å¯¹è´¦) | â˜…â˜…â˜…â˜… |
| 5 | **DB Admin** (å¤‡ä»½/æ¸…ç†) | â˜…â˜…â˜† |

### Spring Batch é›†æˆ (ç™¾ä¸‡çº§ ETL)

```
V2 çš„ Sales ETL (è‡ªç ”, CSV é€è¡Œå¤„ç†)
    â†“ è¿ç§»åˆ°
V3 çš„ Spring Batch (ç™¾ä¸‡è¡Œ chunk-based å¤„ç†)
    - ItemReader: FlatFileItemReader (CSV)
    - ItemProcessor: FIFO æˆæœ¬è®¡ç®—
    - ItemWriter: JPA batch insert + Kafka event
    - è¿›åº¦: Prometheus metric å®æ—¶æŠ¥å‘Š
```

---

## 7. Phase 4 â€” V2 é€€å½¹ (2 å‘¨)

### ç›®æ ‡: å®‰å…¨åœæ‰ V2 NestJS

| æ­¥éª¤ | è¯¦æƒ… | å›æ»šç‚¹ |
|------|------|--------|
| 1 | API Gateway 100% æµé‡åˆ‡åˆ° V3 | å¯åˆ‡å› V2 |
| 2 | ç›‘æ§ 7 å¤©æ— å¼‚å¸¸ | å¯åˆ‡å› V2 |
| 3 | åœæ­¢ V2 NestJS è¿›ç¨‹ | ä¿ç•™å®¹å™¨, å¯é‡å¯ |
| 4 | ç­‰å¾… 14 å¤©å†·å´æœŸ | å¯é‡å¯ V2 |
| 5 | åˆ é™¤ V2 ä»£ç  (`apps/api/`) | âŒ ä¸å¯é€† |
| 6 | åˆ é™¤ Prisma schema | âŒ ä¸å¯é€† (Flyway å·²æ¥ç®¡) |
| 7 | æ›´æ–°æ–‡æ¡£å’Œ agent skills | â€” |

---

## 8. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| API å¥‘çº¦ä¸ä¸€è‡´ | å‰ç«¯å´©æºƒ | Contract Testing (æ¯æ¬¡ CI è‡ªåŠ¨éªŒè¯) |
| æ•°æ®åº“ schema ä¸å…¼å®¹ | æ•°æ®ä¸¢å¤± | Flyway è¿ç§» + å¤‡ä»½éªŒè¯ |
| æ€§èƒ½å›é€€ | ç”¨æˆ·ä½“éªŒ | å‹åŠ›æµ‹è¯• + ç°åº¦å‘å¸ƒ |
| Token æ ¼å¼ä¸å…¼å®¹ | ç”¨æˆ·æ‰çº¿ | V3 å…¼å®¹ V2 Token æ ¼å¼ |
| å›¢é˜Ÿå­¦ä¹ æˆæœ¬ | å¼€å‘é€Ÿåº¦ | Kotlin è¯­æ³•ä¸ TypeScript ç›¸ä¼¼, å­¦ä¹ æ›²çº¿ä½ |
| Kafka æ•°æ®ä¸¢å¤± | äº‹ä»¶é—æ¼ | At-least-once + å¹‚ç­‰ Consumer |

---

## 9. æ—¶é—´çº¿æ€»è§ˆ

```
        Phase 0          Phase 1          Phase 2          Phase 3          Phase 4
      åŸºç¡€è®¾æ–½å‡†å¤‡       æ ¸å¿ƒåç«¯è¿ç§»       æ•°æ®å±‚æ‰©å±•        è¾…åŠ©æ¨¡å—è¿ç§»       V2 é€€å½¹
    â”œâ”€â”€â”€â”€ 2-3 å‘¨ â”€â”€â”€â”€â”¼â”€â”€â”€â”€ 4-6 å‘¨ â”€â”€â”€â”€â”¼â”€â”€â”€â”€ 3-4 å‘¨ â”€â”€â”€â”€â”¼â”€â”€â”€â”€ 4-6 å‘¨ â”€â”€â”€â”€â”¼â”€â”€ 2 å‘¨ â”€â”€â”¤
    â”‚                â”‚                â”‚                â”‚                â”‚          â”‚
    â”‚ Spring Boot    â”‚ Auth â†’ Users   â”‚ Kafka          â”‚ Purchase       â”‚ åœ V2    â”‚
    â”‚ Flyway         â”‚ Products       â”‚ OpenSearch     â”‚ Sales          â”‚ åˆ ä»£ç    â”‚
    â”‚ CI/CD          â”‚ VMA            â”‚ ClickHouse     â”‚ Inventory      â”‚ æ›´æ–‡æ¡£   â”‚
    â”‚ Docker         â”‚ Logs           â”‚ æŠ¥è¡¨/æœç´¢ API  â”‚ Finance        â”‚          â”‚
    â”‚                â”‚ API Gateway    â”‚                â”‚ Batch ETL      â”‚          â”‚
    â”‚                â”‚                â”‚                â”‚                â”‚          â”‚
    â–¼                â–¼                â–¼                â–¼                â–¼          â–¼
   æ€»è®¡: çº¦ 15-21 å‘¨ (4-5 ä¸ªæœˆ)
```

---

## 10. å‰ç«¯è¿ç§»æ¸…å• (æœ€å°å˜æ›´)

ç”±äºå‰åç«¯é€šè¿‡ OpenAPI è§£è€¦, å‰ç«¯å˜æ›´æå°:

| å˜æ›´ | è¯´æ˜ | å½±å“ |
|------|------|------|
| API Client é‡ç”Ÿæˆ | åç«¯ OpenAPI spec æ›´æ–° â†’ é‡æ–°ç”Ÿæˆ TS Client | è‡ªåŠ¨åŒ– |
| ç¯å¢ƒå˜é‡ | API URL å¯èƒ½å˜ (å¦‚æœç”¨ Gateway åˆ™æ— æ„Ÿ) | é…ç½®æ–‡ä»¶ |
| é”™è¯¯ç  | V3 é”™è¯¯ç æ ¼å¼ä¸ V2 ä¿æŒä¸€è‡´ | æ—  |
| ç™»å½•æµç¨‹ | å¦‚æœä¸Š OIDC SSO, éœ€è¦æ”¹ç™»å½•é¡µ | ä¸€ä¸ªé¡µé¢ |
| AG Grid å¼•å…¥ | æŠ¥è¡¨é¡µé¢é€æ­¥ä½¿ç”¨ AG Grid | æ¸è¿›å¼ |
| ECharts å¼•å…¥ | Dashboard å›¾è¡¨ | æ¸è¿›å¼ |

> **å‰ç«¯è¿ç§»æœ€å¤§çš„å˜æ›´å°±æ˜¯ç™»å½•é¡µ (å¦‚æœä¸Š OIDC)ã€‚å…¶ä½™å‡ ä¹æ— æ„Ÿã€‚**

---

## 8. å…³é”®è¿ç§»çº¦æŸ (ç”Ÿäº§è¡€æ³ªæ•™è®­)

> **æ¥æº: V2 ç”Ÿäº§ç³»ç»Ÿå®æˆ˜ä¸­å‘ç°çš„é™·é˜±, è¿ç§»åˆ° V3 æ—¶åŠ¡å¿…ä¸¥æ ¼éµå¾ªã€‚**

### 8.1 FIFO åŸå­æ€§çº¦æŸ

| çº¦æŸ ID | æè¿° | ä¸¥é‡æ€§ |
|---------|------|--------|
| **FIFO-001** | æµæ°´åˆ›å»ºå’Œåˆ†é…å†™å…¥å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆ | ğŸ”´ Critical |
| **FIFO-002** | FIFO åˆ†é…å¼‚å¸¸å¿…é¡»æŠ›å‡ºï¼Œç¦æ­¢é™é»˜è¿”å›ç©ºç»“æœ | ğŸ”´ Critical |
| **FIFO-003** | `fifo_transactions` ä¸ `fifo_allocations` å¿…é¡»åŒæ­¥å®¡è®¡ | ğŸ”´ Critical |
| **FIFO-004** | `INIT-*` / `INT-*` å±‚çº§ç¦æ­¢è¢«æ¸…ç†é€»è¾‘åˆ é™¤ | ğŸ”´ Critical |

### 8.2 å¹‚ç­‰æ€§é™·é˜±

```
âš ï¸ è‹¥ç¬¬ä¸€éåŒæ­¥æ—¶åˆ†é…å¤±è´¥ (äº§ç”Ÿäº†æµæ°´ä½†æ²¡äº§ç”Ÿ Allocation),
ç”±äºæµæ°´å·²å­˜åœ¨, åç»­é‡è·‘æ—¶ä¼šè¢«è·³è¿‡, å¯¼è‡´è¯¥è®¢å•æ°¸ä¹…æœªåˆ†é…æˆæœ¬ã€‚
âœ… æ£€æŸ¥æ—¶å¿…é¡»åŒæ—¶éªŒè¯ fifo_allocations æ˜¯å¦å­˜åœ¨å¯¹åº”è®°å½•ã€‚
```

### 8.3 åº“å­˜æ¢å¤ç¼ºå£

```
âš ï¸ åˆ é™¤é”€å”®è®°å½•å’Œåˆ†é…å, è‹¥æœªæ¢å¤ INIT å±‚çš„ qty_remaining,
åç»­ ETL ä¼šå› æ‰¾ä¸åˆ° "å¯ç”¨ä½™é¢" è€Œåˆ†é…å¤±è´¥ã€‚
âœ… é‡ç½®æ—¶å¿…é¡»æ‰§è¡Œ: UPDATE fifo_layers SET qty_remaining = qty_in WHERE source_type = 'INIT'
```

### 8.4 æ•°æ®éªŒè¯åŸºå‡†

è¿ç§»åå¿…é¡»éªŒè¯:

| æ ¡éªŒé¡¹ | é¢„æœŸå€¼ |
|--------|--------|
| INIT å±‚çº§æ•° | 244 |
| FIFO åˆ†é…éç©º | > 0 |
| é‡‡è´­å±‚ 100% æœ‰è½åœ°ä»·è®°å½• | 100% |
| æµæ°´ä¸åˆ†é…æ•°é‡ä¸€è‡´ | åŒ¹é… |

### 8.5 æˆæœ¬æŸ¥è¯¢ä¼˜å…ˆçº§

```kotlin
// V3 ä¸­å¿…é¡»éµå¾ªæ­¤ä¼˜å…ˆçº§:
val cost = landedPrice ?: fifoLayer.unitCost
// 1. æœ€é«˜ä¼˜å…ˆ: landed_prices è¡¨çš„å®æ—¶è´¢åŠ¡æˆæœ¬
// 2. å›é€€ä¼˜å…ˆ: fifo_layers.unit_cost (å…¥åº“åˆå§‹æˆæœ¬)
```

### 8.6 ä»£ç é”å®š (STRICT LOCK)

ä»¥ä¸‹ V1/V2 é€»è¾‘å·²é”å®š, è¿ç§»åˆ° V3 æ—¶å¿…é¡» 1:1 å¤åˆ¶:

| æ¨¡å— | åŸå§‹æ–‡ä»¶ | é£é™© |
|------|----------|------|
| FIFO æ‰£å‡ | `sales_sync.py` | ğŸ”´ è´¢åŠ¡æ ¸å¿ƒ |
| ETL è½¬æ¢ | `transformer.py` | ğŸ”´ æ•°æ®å®Œæ•´æ€§ |
| è½åœ°ä»·è®¡ç®— | `calculate_landed_prices` | ğŸ”´ æˆæœ¬è®¡ç®— |

---

## Appendix A: V1 Django â†’ V3 è¿ç§»ç»†èŠ‚

> **æ ¸å¿ƒåŸåˆ™**: V1 Django æŒç»­è¿è¡Œ, é€æ¨¡å—åˆ‡åˆ° V3, æ•°æ®ä» MySQL è¿ç§»åˆ° PGã€‚
> **V1 æ·±åº¦åˆ†æ**: `reference/v1-deep-dive.md`

### A.1 V1 æ¨¡å—æ¸…å• (`backend/apps/`)

| æ¨¡å— | æ–‡ä»¶æ•° | æ ¸å¿ƒåŠŸèƒ½ | ä¼˜å…ˆçº§ |
|------|--------|----------|--------|
| **purchase** | 64 | ä¾›åº”å•†ç®¡ç†, PO åˆ›å»º/è·Ÿè¸ª/æ”¶è´§, å‘è´§ç®¡ç† | P1 |
| **finance** | 21 | ä»˜æ¬¾ç®¡ç†, é¢„ä»˜æ¬¾, æ±‡ç‡å¤„ç† | P1 |
| **inventory** | 8 | FIFO å±‚ç®¡ç†, åº“å­˜åŠ¨æ€, ä½åº“å­˜å‘Šè­¦ | P1 |
| **sales** | 3 | é”€å”®äº¤æ˜“æŸ¥è¯¢ (è½»é‡) | P2 |
| **etl** | 8 | eBay è®¢å• ETL (49KB views.py), FIFO æˆæœ¬åˆ†é… | P2 |
| **ebay** | 8 | eBay API é›†æˆ (OAuth, è®¢å•æŸ¥è¯¢) | P2 |
| **reports** | 8 | æŠ¥è¡¨ç”Ÿæˆ | P3 |
| **db_admin** | 3 | æ•°æ®åº“å¤‡ä»½, è¡¨æ¸…ç† | P3 |
| **audit** | 23 | å®¡è®¡æ—¥å¿— | è·³è¿‡(V2å·²æœ‰) |
| **products** | 6 | äº§å“ç®¡ç† | è·³è¿‡(V2å·²æœ‰) |
| **user_admin** | 12 | ç”¨æˆ·ç®¡ç† | è·³è¿‡(V2å·²æœ‰) |

### A.2 å…³é”®è¿ç§»é™·é˜± (MySQL â†’ PG)

| V1 å­—æ®µ | Django ç±»å‹ | é™·é˜± | V3 PG ç±»å‹ |
|---------|------------|------|------------|
| `deposit_par` | `FloatField` | **ç²¾åº¦ä¸¢å¤±**! | `DECIMAL(5,2)` |
| `float_threshold` | `FloatField` | **ç²¾åº¦ä¸¢å¤±** | `DECIMAL(5,2)` |
| `category` | `CharField(1)` | å•å­—æ¯ä¸å¯è¯» | `VARCHAR(20)` + CHECK |
| `contract_file` | `FileField` | æ–‡ä»¶è·¯å¾„åœ¨ MySQL | MinIO/S3 |
| `status` | `BooleanField` | True/False è¯­ä¹‰æ¨¡ç³Š | `VARCHAR(20)` ACTIVE/INACTIVE |

### A.3 æ•°æ®è¿ç§»æ­¥éª¤

```
1. mysqldump â†’ v1_data.sql
2. Python ç±»å‹è½¬æ¢è„šæœ¬ (Float â†’ Decimal, å•å­—æ¯ â†’ å¯è¯» enum)
3. å¯¼å…¥ PG (Flyway + COPY)
4. é€æ¡æ ¡éªŒå€¼ (diff < 0.01)
```

### A.4 ç¦æ­¢äº‹é¡¹

- âŒ ç¦æ­¢ä¸€æ¬¡æ€§è¿ç§»æ‰€æœ‰æ¨¡å—
- âŒ ç¦æ­¢ç›´æ¥ç”¨ MySQL FLOAT å†™å…¥ PG DECIMAL (å¿…é¡» str â†’ Decimal)
- âŒ ç¦æ­¢åœ¨æ•°æ®éªŒè¯é€šè¿‡å‰å…³åœ V1 æ¨¡å—
- âŒ ç¦æ­¢åˆ é™¤ V1 Django ä»£ç  (å†·å´æœŸç»“æŸå‰)

---

## Appendix B: V2 NestJS â†’ V3 è¿ç§»ç»†èŠ‚

> **æ ¸å¿ƒåŸåˆ™**: V2 NestJS æŒç»­è¿è¡Œ, é€æ¨¡å—åˆ‡æ¢, å‰ç«¯é›¶æ„ŸçŸ¥ã€‚

### B.1 V2 åç«¯æ¨¡å— (`apps/api/src/modules/`)

| V2 æ¨¡å— | æ ¸å¿ƒåŠŸèƒ½ | å¤æ‚åº¦ | V3 è¿ç§»çŠ¶æ€ |
|---------|----------|--------|------------|
| **auth** | JWT, bcrypt, L0-L4 å®‰å…¨ç  | â˜…â˜…â˜…â˜…â˜… | âœ… å·²è¿ç§» |
| **users** | CRUD, è§’è‰², æƒé™(JSONB) | â˜…â˜…â˜… | âœ… å·²è¿ç§» |
| **roles** | è§’è‰² CRUD, æƒé™æ¨¡æ¿ | â˜…â˜… | âœ… å·²è¿ç§» |
| **products** | SKU, COGS, BarcodeService | â˜…â˜…â˜… | âœ… å·²è¿ç§» |
| **logs** | 4 è¡¨æ—¥å¿—, å¼‚æ­¥å†™å…¥, AlertService | â˜…â˜…â˜…â˜… | âœ… å·²è¿ç§» |
| **vma** | 5 å­æ¨¡å— (å‘˜å·¥/åŸ¹è®­/åº“å­˜/ä¸´åºŠ/ç«™ç‚¹) | â˜…â˜…â˜…â˜…â˜… | âœ… å·²è¿ç§» |

### B.2 å®‰å…¨å±‚è¿ç§»å¯¹ç…§

| V2 NestJS | V3 Spring Boot |
|-----------|----------------|
| `@UseGuards(JwtAuthGuard)` | `SecurityFilterChain` å…¨å±€ JWT |
| `@UseGuards(RolesGuard)` + `@Roles('admin')` | `@PreAuthorize("hasRole('ADMIN')")` |
| `@RequireSecurityLevel('L2')` | `@SecurityLevel(level="L2")` AOP |
| `@UseGuards(PermissionsGuard)` | `@PreAuthorize("hasAuthority(...)")` |
| SecurityPolicyService (L0-L4) | SecurityLevelAspect + SessionService |

### B.3 Token å…¼å®¹

V3 Spring Security JWT Decoder å¿…é¡»èƒ½éªŒè¯ V2 å‘å‡ºçš„ Token:
- ç›¸åŒçš„ `JWT_SECRET`
- ç›¸åŒçš„ claims è§£ææ–¹å¼
- è¿ç§»æœŸåŒå‘å…¼å®¹

### B.4 ç¦æ­¢äº‹é¡¹

- âŒ ç¦æ­¢åˆ é™¤ V2 ä»£ç , ç›´åˆ° V3 éªŒè¯é€šè¿‡ + 14 å¤©å†·å´
- âŒ ç¦æ­¢ä¿®æ”¹ç°æœ‰ PG è¡¨ç»“æ„ (Flyway æ–°å¢å¯ä»¥, åˆ æ”¹ä¸è¡Œ)
- âŒ ç¦æ­¢åœ¨ V3 ä¸­ä½¿ç”¨ä¸åŒçš„ JWT Secret
- âŒ ç¦æ­¢åœ¨ V3 ä¸­ä½¿ç”¨ä¸åŒçš„ API è·¯å¾„å‰ç¼€

---

*Version: 4.0.0 â€” åˆå¹¶ migration-v1.md + migration-v2.md*
*Updated: 2026-02-16*
