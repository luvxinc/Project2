---
name: root-cause-classifier
description: 根因分类协议。出错时优先执行根因分类，禁止未诊断就直接改代码。
---

# 根因分类协议（Root Cause Classifier）

> **核心原则: 出错时，先诊断根因，再决定行动。改代码是最后手段。**
> **何时加载**: 编译失败 / 测试不通过 / 结果不符预期 / Agent 犯错被指出后。

---

## 决策树

```
出错 / 结果不符预期
        │
        ▼
Step 1: 错误类型初判（选一）
  ├─ 编译/类型/语法错误         → 类型 A: 代码逻辑
  ├─ 运行时异常 (500/NPE/panic) → 类型 B: 状态/数据
  ├─ 测试失败                   → 类型 C: 测试/数据准备
  ├─ 工具/脚本报错              → 类型 D: 工具链
  ├─ 无报错但结果不对           → 类型 E: 需求理解偏差
  └─ 环境问题（服务未启/权限）   → 类型 F: 环境
        │
        ▼
Step 2: 根因确认（对应类型的诊断 SOP）
        │
        ▼
Step 3: 行动（诊断完成后才改代码）
```

---

## Step 2: 各类型诊断 SOP

### 类型 A — 代码逻辑

```
1. 读完整错误栈（不要只看第一行）
2. 用 Grep/Read 定位出错的具体行
3. 理解为什么出错（逻辑错误/API 误用/类型不匹配）
4. 修复最小范围的代码
5. 重跑验证循环从失败阶段开始
```

### 类型 B — 状态/数据

```
1. 检查数据库/缓存状态（数据是否符合预期）
2. 检查外部依赖是否正常（API/服务是否可达）
3. 确认测试数据是否正确初始化
4. 确认事务边界是否正确
5. 修复状态问题，而非绕过它
```

### 类型 C — 测试/数据准备

```
1. 区分：是实现有 bug，还是测试数据准备错误？
2. 确认测试场景是否覆盖了这个 case
3. 补测试用例，而不是修改实现来让测试通过
4. 检查 test fixture / mock 是否正确
```

### 类型 D — 工具链

```
1. 确认工具版本（是否兼容）
2. 确认工具配置（config 文件是否正确）
3. 查 ERROR-BOOK：是否有已知工具陷阱
4. 修改工具配置，不改业务代码
5. 更新 ERROR-BOOK（如发现新工具陷阱）
```

### 类型 E — 需求理解偏差

```
1. 停止修改代码
2. 返回 PM → 说明当前理解 vs 实际预期的差距
3. 更新 Spec（§1 现状 / §2 目标）
4. 用户确认后，按新 Spec 执行
5. 此类错误来源于 Phase 3 CONFIRM 不充分
```

### 类型 F — 环境

```
1. 运行环境预检（skills/environment-check.md）
2. 确认服务是否运行（{service_check_cmd}）
3. 确认网络/权限/依赖是否就绪
4. 修复环境后，重新尝试任务
5. 如环境问题无法自动修复 → 向用户报告需要手动干预
```

---

## Step 3: 禁止行为

| 禁止 | 原因 |
|------|------|
| 未完成 Step 1-2 就写代码 | 症状治疗，不解决根因 |
| 未验证根因假设就提交修复 | 可能引入新 bug |
| 重试同一命令超过 3 次 | 3 次仍失败说明根因未找到 |
| 静默绕过错误（catch 空，注释掉测试） | 隐藏 bug |
| 改测试来让测试通过（而不是修实现） | 测试失去意义 |

---

## 根因分类报告格式

当需要向用户报告时，使用以下格式：

```
⚠️ 根因分类报告

错误类型: [A/B/C/D/E/F]
错误描述: {具体错误信息}
根因假设: {我认为问题出在...}
已排查: {排查了什么，结论是什么}
行动建议: {建议的下一步}
需要用户: {需要用户提供什么信息/操作}
```

---

*Version: 1.0.0 — B2 Harness Engineering 组件*
*Created: 2026-02-19*
