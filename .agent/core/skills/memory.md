---
name: memory
description: 记忆管理 SOP。Use when 需要任务追踪、验收保护、错题本沉淀、上下文约束与会话收敛。
---

# 记忆管理 (Memory Management)

> **根据下方路由表跳到需要的 section，不要全部阅读。**

## 路由表

| 关键词 | 跳转 |
|--------|------|
| `进度`, `tracker`, `追踪` | → §1 任务追踪器 |
| `验收`, `保护`, `清理` | → §2 验收后协议 |
| `错题`, `错误`, `复犯`, `交叉检查` | → §3 错题本 |
| `项目记忆`, `复用`, `风格`, `口径`, `规范` | → §3.6 项目复用记忆 |
| `用户提示`, `纠正`, `理解错误` | → §3.5 用户提示强制记录 |
| `规划`, `大任务`, `3个文件` | → §4 大任务规划 |
| `上下文`, `按需加载` | → §5 上下文加载纪律 |

---

## §1 任务追踪器

> **每个任务从 DRAFT 到 CLOSED 都有一个追踪文件跟随，验收后删除。**

### 1.1 生命周期

PM 创建 Spec → 同时创建追踪器 → 全流程更新每个状态 → 用户验收 → 执行 §2 协议 → 删除追踪器。

追踪器路径：`.agent/projects/{project}/data/progress/TRACKER-{task-id}.md`
命名规则：`project-structure.md` §3.5.1 + §4.3

追踪器格式 → `core/templates/tracker-template.md`

### 1.2 更新规则

| 时机 | 谁写 | 写什么 |
|------|------|--------|
| Spec 创建时 | PM | 初始化追踪器 |
| 任务分配后 | CTO | 工单分配列表 |
| 每完成一个工单 | 工程师 | 进度日志 + 变更文件 |
| 每次状态转换 | 当前负责人 | 更新"当前状态" |
| 发生返工 | CTO | 记录错误 + 引用错题本 |
| 用户验收 | PM | 执行验收后协议 (§2) |

### 1.3 追踪器 vs 检查点

| 追踪器 | 检查点 |
|--------|--------|
| 贯穿任务全生命周期 | 仅在跨会话时使用 |
| 验收后删除 | 恢复后可删除 |
| 记录进度 + 决策 + 错误 | 只记录恢复所需的最小信息 |

---

## §2 验收后协议

> **触发词：** "确认" / "通过" / "验收" / "OK" / "可以" / "好了" / "上线"

验收后执行顺序：

1. **Spec 标记 CLOSED** — 在 Spec §9 写入：状态=CLOSED、时间、用户确认原话
2. **验收内容保护** — 将产出文件路径追加到 `.agent/projects/{project}/data/progress/ACCEPTED.md`
3. **删除追踪器** — `rm .agent/projects/{project}/data/progress/TRACKER-{task-id}.md`
4. **删除检查点** — `rm .agent/projects/{project}/data/checkpoints/{相关检查点}.md`
5. **审计报告处理** — 所有问题已关闭则删除，否则保留（规则见 `project-structure.md` §3.7）

ACCEPTED.md 格式 → `core/templates/accepted-template.md`

### 2.1 保护机制

修改文件前：读 ACCEPTED.md → 检查目标文件是否已验收 → 已验收则告知 PM 并获用户许可后才可修改。

---

## §3 错题本 (Error Book)

> **同样的错误不允许犯第二次。**

### §3A 双账本原则

- `ERROR-BOOK`：只记错误、防复犯、交叉检查结果
- `PROJECT-MEMORY`：只记可复用需求（UIUX 风格/数据口径/长期规则）
- 两类禁止混写；冲突时优先回用户确认

### 3.1 错题本位置

```
.agent/projects/{project}/data/errors/ERROR-BOOK.md
```

### 3.2 错题本格式

格式模板 → `core/templates/error-book-entry-template.md`

核心字段：触发关键词、错误描述、正确做法、首次/次数、影响范围、交叉检查结论。

### 3.3 写入规则

| 时机 | 谁写 |
|------|------|
| QA 审计驳回时 | QA |
| CTO Review 驳回时 | CTO |
| 用户反馈 Bug 时 | PM |
| 工程师自测发现时 | 工程师 |
| 🔴 用户纠正/提示时 | PM（详见 §3.5） |

### 3.4 使用规则 (强制)

每次任务开始（ASSIGNED 后）：
1. 读错题本关键词索引
2. 匹配当前任务关键词
3. 命中 → 读条目并遵守；未命中 → 继续
4. 🔴 检查 `data/training/` 是否有相关经验教训

每次错误修复后：写入错题本 → 更新关键词索引 → 执行交叉检查 §3.5

### 3.4A 自动匹配协议（任务 ASSIGNED 后）

1. 提取当前任务关键词：模块名 + 技术栈 + 操作类型
2. grep 匹配 `ERROR-BOOK.md` 关键词索引
3. 命中 → 读取条目 → 在 CTO 工单"注意事项"标注 `⚠️ ERR-XXX 警告`
4. 未命中 → 继续

> Express Path 也必须执行此匹配（精简版：只匹配，不写工单注释）

### 3.5 用户提示强制记录 (🔴 铁律)

> **用户的每一句纠正都是真金白银的经验，浪费 = 失败。**

| 用户行为 | 类型 | 必须做 |
|---------|------|--------|
| "这里有 bug" / "写错了" | **A** Bug | 错题本 + 立即修复 |
| "不是这个意思" | **B** 理解错误 | 错题本 + Spec 更新 |
| "你应该先做X再做Y" / "流程不对" | **C** 流程 | `training/` + SOP 更新 |
| "以后都要这样做" / "记住这个规则" | **D** 规范 | 错题本 + 规范文件更新 |

**🔴 铁律：用户提示后，Agent 必须在下次响应中确认已记录到哪个文件。**

### 3.5A 交叉检查协议

发现错误后：
1. **抽象模式** — "在 {类型} 中做了 {操作} 导致 {后果}"
2. **搜索同类** — grep 搜索同类代码，逐一检查
3. **批量修复 + 记录** — 一次性修复所有同类，错题本记录"发现 N 处，已全部修复"

### 3.6 项目复用记忆

存储：`.agent/projects/{project}/data/progress/PROJECT-MEMORY.md`

记录范围（仅正向复用）：UI/UX 风格偏好、数据口径/字段语义、业务规则、集成协议约定。

禁止写入：Bug/返工/失败教训（→ ERROR-BOOK）、一次性临时进展（→ TRACKER）。

执行规则：新任务先读 PROJECT-MEMORY → 冲突时先确认 → 任务结束增量写回。

### 3.7 去重与加权

入库前做"关键词 + 指纹"匹配（模块/场景/后果）：
- **命中已有条目** → `count+1, weight+1`，更新 `last_seen`，**禁止新增重复**
- **未命中** → 创建新条目，`count=1, weight=1`
- **排序** → 按 `weight` 降序（优先检索与预警）

最小字段：`id`、`keywords`、`fingerprint`、`count`、`weight`、`last_seen`

---

## §4 大任务规划 (强制)

> **修改 ≥ 3 个文件的任务，必须先做规划。**

| 规模 | 文件数 | 规划类型 |
|------|--------|----------|
| Small | 1-2 | 直接执行 |
| Medium | 3-5 | 简化规划 |
| Large | 6-15 | 完整规划 + 分阶段 |
| X-Large | 15+ | 完整规划 + 分会话 |

规划模板 → `core/templates/execution-plan-template.md`

执行纪律：计划写好后向用户确认 → 按步骤顺序执行 → 每 Phase 完成后验证 → 验证不通过则停 → 计划变更告知用户。

---

## §5 上下文加载纪律

> **按需加载，不重复读取。只加载当前阶段所需，完成后不再引用。**

| 操作 | 规则 |
|------|------|
| 读代码文件 | 先读 outline，再读具体函数，不要全读 |
| 读 SOP | 先读路由表，再读命中 section |
| 读工具库 | 先读 INDEX，再读具体切片 |
| 读 Spec | 全读（Spec 是真相源） |
| 读追踪器 | 全读（追踪器 <50 行） |
| 读错题本 | 先读关键词索引，命中才读条目 |

分阶段加载：需求阶段只加载 PM SOP → 分配阶段只加载 CTO SOP + 域索引 → 执行阶段只加载命中的工程师 SOP → 审核阶段只加载 QA SOP → 交付阶段只加载 PM 交付 section。

---

*Version: 2.0.0 — Phase 1 瘦身 (模板外迁 + 伪概念删除 + 压缩)*
*Updated: 2026-02-19*
