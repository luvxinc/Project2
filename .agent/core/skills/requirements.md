---
name: requirements
description: 需求获取与执行向导 — Wizard 式 5 阶段流程: 采集→分析→确认→执行→验证。全程记录, 不猜测, 100% 理解后才动手。
---

# 需求获取与执行向导 (Requirements Wizard)

> **核心原则: 不理解 = 不动手。猜测 = 失败。**
> **本 Skill 是 PM 的数据采集工具, 在 `/main_build` §0 强制调用。**
> **PM 负责领悟+沟通, Wizard 负责采集+文档化+验证。二者配合, 不互替。**

---

## Wizard 全流程

```
用户提出需求 (prompt)
       │
       ▼
┌─── Phase 1: GATHER ────────────────────┐
│  自动采集: 代码 + KI + 菜谱 + 历史      │
└────────────────────────────────────────┘
       │
       ▼
┌─── Phase 2: SPEC ──────────────────────┐
│  输出 spec 文档: 现状/目标/范围/步骤     │
└────────────────────────────────────────┘
       │
       ▼
┌─── Phase 3: CONFIRM ───────────────────┐
│  用户审批: 确认/修改/补充                │
│  ❓ 不确定的必须问, 禁止猜测             │
└────────────────────────────────────────┘
       │  用户说 "确认" / "开始"
       ▼
┌─── Phase 4: HANDOFF TO CTO ────────────┐
│  PM 交需求文档给 CTO → CTO 分配 →       │
│  工程师按 SOP 执行, 每步记录进度          │
└────────────────────────────────────────┘
       │
       ▼
┌─── Phase 5: VERIFY ────────────────────┐
│  CTO 整合验证 → QA 审计 → PM 检查       │
│  更新 spec 状态为 ✅                    │
└────────────────────────────────────────┘
```

---

## Phase 1: GATHER (自动采集)

Agent 收到用户 prompt 后, 必须先执行以下采集, 不允许跳过:

### 1.1 采集清单

| 搜索目标 | 工具 | 目的 |
|----------|------|------|
| **相关代码** | `grep_search` + `find_by_name` | 找到现有实现 |
| **相关 Schema** | `grep_search` 搜 `.prisma` / `.sql` | 理解数据结构 |
| **相关 KI** | 检查 KI summaries | 是否有历史实现/已知陷阱 |
| **相关菜谱** | 检查 `projects/{project}/recipes/` | 是否有项目级烹饪指南 |
| **相关路线图** | 检查 `projects/{project}/roadmap.md` | 当前阶段是否匹配 |
| **相关 i18n** | 搜索翻译文件 | 是否有现有翻译键 |
| **依赖分析** | `view_file_outline` + import 链 | 改动会影响谁 |

### 1.2 采集输出格式

```markdown
## 📋 采集报告

### 找到的相关文件
- `path/to/file.ts` — 现有实现 (XX 行)
- `path/to/schema.prisma` — 数据模型
- ...

### 找到的 KI
- KI: "xxx" — 相关度: 高/中/低

### 找到的菜谱
- `recipes/vma.md` §4 — 直接相关

### 依赖链
- 改 A → 影响 B, C
- 改 Schema → 需要迁移
```

---

## Phase 2: SPEC (输出规格文档)

基于采集结果, 自动生成 spec 文档:

### 2.1 Spec 模板

```markdown
# 📐 Spec: {任务名称}

> 生成时间: YYYY-MM-DD HH:MM
> 来源 prompt: "{用户原始请求}"

## 1. 现状 (As-Is)
- 当前实现是什么样的
- 当前数据模型
- 当前行为

## 2. 目标 (To-Be)
- 改完后应该是什么样
- 目标数据模型
- 目标行为

## 3. 影响范围
| 层级 | 受影响文件 | 改动类型 |
|------|-----------|----------|
| Schema | `xxx.prisma` | 修改 |
| Backend | `xxx.service.ts` | 修改 |
| Frontend | `xxx/page.tsx` | 新增 |
| i18n | `vma/en.json` | 新增键 |

## 4. 执行步骤
- [ ] Step 1: ...
- [ ] Step 2: ...
- [ ] Step 3: ...

## 5. 风险与陷阱
| 风险 | 影响 | 缓解 |
|------|------|------|
| ... | ... | ... |

## 6. ❓ 待确认项 (需要用户回答)
1. ❓ ...
2. ❓ ...

## 7. 执行记录 (Phase 4 时填写)
| 步骤 | 状态 | 时间 | 备注 |
|------|------|------|------|
| Step 1 | ⬜ | — | — |
| Step 2 | ⬜ | — | — |
```

### 2.2 Spec 存储位置

```
projects/{project}/data/specs/YYYY-MM-DD_{task-name}.md
```

### 2.3 铁律

| 规则 | 说明 |
|------|------|
| **禁止空待确认** | 如果一切都 100% 确定, 仍然写 "无待确认项" 表示已检查 |
| **禁止猜测** | 任何 ≤ 80% 确定的内容必须标 ❓ 来问用户 |
| **禁止跳过** | 即使是"简单"任务也必须出 spec (可以精简, 不能跳过) |

---

## Phase 3: CONFIRM (用户确认)

### 3.1 确认交互

Agent 输出 spec 后, 必须明确问:

```
以上是我对这个需求的理解。

待确认项:
1. ❓ ...
2. ❓ ...

请确认:
- 理解正确? → 我开始执行
- 需要修改? → 告诉我哪里不对
- 需要补充? → 告诉我遗漏了什么
```

### 3.2 确认铁律

| 规则 | 说明 |
|------|------|
| **必须等用户回复** | 输出 spec 后等待, 不允许自行开始 |
| **用户说"确认"才执行** | 任何形式的确认: "确认" / "开始" / "OK" / "没问题" |
| **用户修改后重出 spec** | 如果用户修改了需求, 更新 spec 再次确认 |

---

## Phase 4: HANDOFF TO CTO → EXECUTE

### 4.0 交接 (PM → CTO)

PM 完成 CONFIRM 后, 将 Spec 文档交给 CTO:
```
PM 交 Spec → CTO 分析 → CTO 分解 → CTO 分配给对应工程师
参考: core/skills/chief-engineer.md §3 分配矩阵
```

### 4.1 执行纪律 (工程师遵守)

| 规则 | 说明 |
|------|------|
| **按步骤执行** | 严格按 spec §4 的步骤顺序 |
| **记录进度** | 每完成一步, 更新 spec §7 的状态 (⬜→✅) |
| **遇到意外停下** | 如果实际与 spec 不符, 停下来报告 CTO |
| **不超范围** | 只做 spec 里写的, 不"顺手"改其他东西 |

### 4.2 进度记录

```markdown
## 7. 执行记录
| 步骤 | 状态 | 时间 | 备注 |
|------|------|------|------|
| Step 1: 修改 Schema | ✅ | 12:15 | 新增 EmployeeDuty 中间表 |
| Step 2: 修改 Service | ✅ | 12:25 | 支持多岗位 CRUD |
| Step 3: 修改前端 | 🔄 | — | 进行中 |
| Step 4: 更新 i18n | ⬜ | — | — |
```

---

## Phase 5: VERIFY (三级验证)

### 5.1 CTO 整合验证
参考: `chief-engineer.md` §5 验证清单

### 5.2 QA 审计
参考: `qa-auditor.md` §2 审计清单

### 5.3 技术验证 (同时进行)

```
1. Build:    编译通过
2. Types:    类型安全
3. Lint:     代码风格
4. Tests:    测试覆盖
5. Security: 无密钥泄漏
6. Diff:     无意外变更
```

### 5.2 Spec 收尾

```markdown
## 8. 验证结果
Build:     ✅ PASS
Types:     ✅ PASS
Tests:     ✅ 12/12 passed
Diff:      3 files changed

## 9. 完成状态
✅ 任务完成 — YYYY-MM-DD HH:MM
```

---

## 简化模式 (小任务)

如果任务明显简单 (修复 typo, 改一行配置), 可以用简化版:

```markdown
# 📐 Quick Spec: {任务}
- 现状: ...
- 目标: ...
- 影响: 1 个文件
- 待确认: 无
- → 确认后执行
```

**判断标准**: 影响 ≤ 3 个文件 且 无数据模型变更 → 可用简化版

---

*Version: 1.0.0 — Generic Core*
