---
name: e2e-testing
description: E2E 测试工程师 SOP（端到端测试策略 + 场景覆盖 + CI/CD 集成）。Use when 需要设计或执行 E2E 测试、关键链路验证、用户旅程测试、跨层集成验证。
---

# E2E 测试规范 — 端到端测试策略与执行

> **你是 E2E 测试工程师。职责：设计关键用户旅程测试场景、确保跨层链路（前端 → API → 数据库）完整可测。**
> **技术栈**: 见 `CONTEXT.md §3 E2E 测试框架`，不同项目选用对应工具实现。

## 路由表

| 关键词 | 跳转 |
|--------|------|
| `策略`, `总览`, `分层` | → §1 测试分层策略 |
| `场景`, `用户旅程`, `关键链路` | → §2 E2E 测试场景设计 |
| `工具`, `框架`, `配置` | → §3 工具选型与配置 |
| `数据`, `fixtures`, `隔离` | → §4 测试数据管理 |
| `CI`, `流水线`, `集成` | → §5 CI/CD 集成 |
| `报告`, `失败`, `排查` | → §6 结果报告与失败处理 |

---

## §1 测试分层策略

### 1.1 金字塔原则

```
        ╱ E2E ╲          少量（关键链路）
      ╱─────────╲
    ╱ Integration ╲       中量（API + 数据库）
  ╱─────────────────╲
╱     Unit Tests      ╲   大量（业务逻辑）
```

**E2E 测试定位**：
- 覆盖 **关键用户旅程**（而非所有功能）
- 验证 **跨层集成正确性**（UI → API → DB 完整流程）
- 不替代单元测试和集成测试

### 1.2 覆盖优先级

| 优先级 | 场景类型 | 典型示例 |
|--------|---------|---------|
| 🔴 P0 | 核心业务流 | 登录/注销、创建主实体、结算/提交 |
| 🟡 P1 | 高频用户操作 | 搜索/过滤、状态变更、关键 CRUD |
| 🟢 P2 | 边界场景 | 权限拒绝、错误恢复、空状态 |

> 最小覆盖要求：**P0 全覆盖 + P1 主流程覆盖 ≥ 80%**

---

## §2 E2E 测试场景设计

### 2.1 用户旅程拆解（从 Spec 提取）

```
1. 读 Spec §4 功能需求 → 提取用户能执行的"旅程"
2. 每条旅程：起点（前提状态）→ 操作序列 → 终态断言
3. 标注优先级（P0/P1/P2）和覆盖的 Spec 验收标准编号
```

**旅程模板**：
```
旅程名: {用户操作描述}
前提: 用户已{前置状态}，系统处于{初始状态}
步骤:
  1. {用户操作} → 期望: {UI 反馈}
  2. {用户操作} → 期望: {UI 反馈}
  ...
终态断言:
  - UI: {页面状态}
  - API: {接口响应}
  - DB: {数据变更}（需要时）
```

### 2.2 关键链路验证清单

| 链路类型 | 验证要点 |
|---------|---------|
| 认证链路 | 登录成功 / 无效凭据 / Token 过期 / 注销 |
| 创建链路 | 表单提交 → API 写入 → 列表刷新 |
| 删除链路 | 确认弹窗 → API 删除 → 列表移除 |
| 权限链路 | 无权限 → 403 → 友好提示（无数据泄漏） |
| 错误恢复 | 网络错误 → 提示 → 可重试 |

---

## §3 工具选型与配置

> 具体工具版本见 `CONTEXT.md §3 E2E 测试框架`

### 3.1 工具选型参考

| 场景 | 工具选项 | 选型依据 |
|------|---------|---------|
| Web 浏览器自动化 | Playwright / Cypress / Selenium | CONTEXT.md §3 |
| API 链路测试 | REST Assured / Supertest / httpx | CONTEXT.md §3 |
| Mobile E2E | Appium / Detox | CONTEXT.md §3 |
| 性能回归 | k6 / Locust（结合 E2E）| CONTEXT.md §3 |

### 3.2 配置原则

```
✅ 测试文件与业务代码分离（e2e/ 或 tests/e2e/ 目录）
✅ 配置文件从环境变量读取（不硬编码 URL/凭据）
✅ 超时配置合理（网络操作 > UI 操作）
✅ 截图/录像只在失败时保存（减少 CI 存储）
❌ 禁止在测试文件中硬编码测试账号密码
❌ 禁止测试之间共享状态（每个 test 独立）
```

### 3.3 项目级配置参考

> 见 `CONTEXT.md §5 工具命令速查` → e2e 命令
> 见 `{project}/reference/impl-patterns-*.md` → E2E 具体框架配置代码

---

## §4 测试数据管理

### 4.1 隔离策略（参照 Anthropic 2026-01 Harness 隔离要求）

```
每次 E2E 测试运行必须:
  ✅ 独立测试账号（专用 E2E 用户，不用生产账号）
  ✅ 独立测试数据（测试前 seed，测试后 teardown）
  ✅ 不依赖其他测试的数据状态（test isolation）
  ✅ 并发安全（并行测试不互相污染数据）
  ❌ 禁止跨 test 共享可写状态
```

### 4.2 Fixtures 管理

```
setup:
  - 创建测试专用账号（有明确前缀如 e2e-test-）
  - seed 必要的基础数据（产品/分类等）
  - 清理上轮遗留数据

teardown:
  - 删除本轮创建的测试数据
  - 保留 seed 数据（供下次复用）
  - 失败时：保留现场快照（截图 + 日志）后再 teardown
```

### 4.3 环境依赖

| 依赖 | 处理策略 |
|------|---------|
| 外部 API | 使用 Mock Server（避免依赖外部服务稳定性） |
| 邮件/短信 | 使用测试专用收件箱（如 Mailhog/Mailtrap） |
| 支付 | 使用 Sandbox 模式 |
| 文件上传 | 使用专用测试 Bucket（隔离于生产）|

---

## §5 CI/CD 集成

### 5.1 触发时机

| 触发事件 | E2E 范围 | 说明 |
|---------|---------|------|
| PR 到主分支 | P0 套件（快速，≤10 分钟）| 阻塞合并 |
| 合并到主分支 | P0 + P1 完整套件 | 异步，失败报警 |
| 发布前 | 全套件（P0+P1+P2）| 阻塞发布 |
| 定时（每日）| 全套件 | 稳定性监控 |

### 5.2 CI 配置要点

```
# 参考 CONTEXT.md §5 {e2e_cmd}
阶段顺序:
  1. 启动服务（等待 health check 通过）
  2. 运行数据库迁移（seed 测试数据）
  3. 执行 E2E 套件
  4. 收集报告 + 失败截图
  5. Teardown（无论成功失败）

关键配置:
  - 并行度: 参考 CONTEXT.md §5（避免数据竞争）
  - 重试次数: pass@k = 1（单次通过），失败才重试 1 次（区分偶发 vs 系统性）
  - 超时: 全套件 ≤ 15 分钟（快速反馈）
```

### 5.3 Eval 指标（参照 Anthropic 2026-01）

| 场景 | 指标 | 标准 |
|------|------|------|
| 新功能验收 | pass@1 | 首次通过 = 功能可用 |
| 发布前确认 | pass^3 | 3 次独立运行全通过 = 稳定性信号 |
| 回归监控 | pass@1 daily | 每日运行，失败立即报警 |

---

## §6 结果报告与失败处理

### 6.1 失败分类（配合根因分类器）

```
E2E 失败时，先根因分类（见 root-cause-classifier.md）：

类型 A: 代码逻辑 — 业务功能 Bug（需修复代码）
类型 B: 状态/数据 — 测试数据问题（需修复 fixtures）
类型 C: 测试覆盖 — 测试本身写错（需修复测试代码）
类型 D: 工具链 — 框架/环境问题（需修复配置）
类型 E: 需求偏差 — 需求理解问题（需返回 PM 澄清）
```

### 6.2 失败报告要素

| 要素 | 说明 |
|------|------|
| 失败截图/录像 | 标注失败步骤（工具自动收集）|
| 失败步骤描述 | 哪一步操作，期望 vs 实际 |
| 环境信息 | 浏览器版本、服务版本 |
| 可重现性 | 是否稳定复现（是=代码 Bug，否=偶发=环境问题）|
| 根因分类 | A/B/C/D/E（见上方分类）|

### 6.3 flaky 测试处理

```
判定标准: 同一代码，3 次运行中 1 次失败 = flaky
处理:
  - 立即隔离（加 skip 标记，不拖累 CI）
  - 根因分析（数据竞争 / 时序问题 / 外部依赖）
  - 修复后解隔离，验证 pass^5 后恢复
  - 记入 ERROR-BOOK（防复犯）
```

---

*Version: 1.0.0 — 新建 2026-02-19（P2 补全）*
