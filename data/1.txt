data/P-valve.xlsx 这个是我们的库存表
列C到列L为我们需要用到的数据

我们先不需要从中复制数据 但是我们需要先根据这个结构去建立
P-Valve Inventory和Delivery的流水表
这个表格的作用是用于记录产品进出明细

Date: 格式YYYY-MM-DD 用于记录流水发生日期
Action: Rec_CN/Rec_Case/Out_Case/Out_CN 用于记录进出库
Batch#: 用于记录产品批次号
Type: P-Valve/Delivery System 用于记录产品类型
Venus Medtech Spec#: 用户记录产品型号
Serial No.: 用于记录产品序列号
Qty: 用于记录发生流水的产品数量
Exp. Date: 用于记录产品过期日期
Inspection: Accept/Reject 用于记录产品入库检验结果
Notes: 用于记录备注信息
Case ID: 用于记录产品Cinlical Trial的Case号
Operator: 用于记录操作员信息
Location: 用于记录产品存储位置
Status: 用于记录产品状态(Product/Demo/WIP/Returned/Used)


P-valve Inventory 页面 和Delivery System 页面
+add item 修改为 Receive from China
新增按钮 Return to China
新增按钮 Move to DEMO


这个表格仅用于 记录产品进出库信息 不在前端直接显示
P-Valve Inventory 页面 和Delivery System 页面
仅显示当前的库存信息(可用库存)
我们首先需要把这两个页面和二为1作为一个Inventory页面

左侧P-Valve Inventory 页面 
显示信息为
Spec#: 
Available Qty: 这个是以spec#汇总的表内所有type为P-Valve的数量 (注意要Rec_CN+Rec_Case-Out_Case-Out_CN), 不含Status为Demo的数量
WIP Qty: 这个是以spec#汇总的表内所有type为P-Valve的数量status为WIP的数量
Approach Exp. Date: 这个是以spec#汇总的表内所有type为P-Valve的数量(注意要Rec_CN+Rec_Case-Out_Case-Out_CN)且过期日期<=30天的数量
Expired Qty: 这个是以spec#汇总的表内所有type为P-Valve的数量(注意要Rec_CN+Rec_Case-Out_Case-Out_CN)且过期的数量

右侧和Delivery System 页面
Spec#
Available Qty: 这个是以spec#汇总的表内所有type为Delivery System的数量 (注意要Rec_CN+Rec_Case-Out_Case-Out_CN), 不含Status为Demo的数量
WIP Qty: 这个是以spec#汇总的表内所有type为Delivery System的数量status为WIP的数量
Approach Exp. Date: 这个是以spec#汇总的表内所有type为Delivery System的数量(注意要Rec_CN+Rec_Case-Out_Case-Out_CN)且过期日期<=30天的数量
Expired Qty: 这个是以spec#汇总的表内所有type为Delivery System的数量(注意要Rec_CN+Rec_Case-Out_Case-Out_CN)且过期的数量


你帮我核对一下核算的逻辑
1. 首先我们从中国进货和退货都是Action都是Rec_CN和Out_CN, 一个产品被退回中国之后也就不能再用, 但是要记录
2. 我们产品出库去做clinical trail都是Action为Out_Case, 此时我们出库的产品会有很多个, 但是Case只会用掉一部分,多余的部分会回库, 这个回库的Action为Rec_Case
3. WIP代表当前出库去做clinical trail的产品, 但是还尚未回来的产品, 暂时不清楚是否用掉
4. 一个产品会因为各种原因被移动到Demo 就相当于不再作为产品使用
5. 我需要统计 当前可用产品Available Qty, 当前出库未回库产品WIP Qty, 当前临期产品Approach Exp. Date, 当前过期产品Expired Qty, 这些都不包含Demo的产品
你看是否理解这些逻辑, 帮我看看这个设计有何地方有漏洞或者统计问题




现在需要设计一receive from China这个按钮
用户点开该按钮后会弹出一个modal

该modal顶上是基本信息填写
用户需要录入
Batch#: 只能填写数字
PO No.:这个可为空
Date Shipped: YYYY-MM-DD 格式 (可以点击选择日期)
Date/Time Received: YYYY-MM-DD HH:MM PST格式 (可以点击选择日期, 时间)
Operator: 用户填写操作人

Modal下面是产品信息填写, 是一个表格, 如果行数不够可以点击增加行数
用户需要录入字段如何
Product Type: P-Valve/Delivery System (下拉选择)
Product Model: 根据上面的选择,自动给用户下拉菜单选择, 也可以根据用户在 Product Serial No.中输入的数字自动匹配(仅可为P-valve) 例如前5位为28P30, 则自动匹配为P28-30
Product Serial No.: 用户填写
Quantity Received: 如果用户选P-Valve, 自动为1, 不可修改, 若是Delivery System, 用户填写数字不能为0和负数
Product Condition: Accept/Reject (下拉选择)
Conditional Notes: 用户选择, 下拉菜单为多选, 提示用户选择下面哪些不符合, 可多选,也可都不选
Quantity received matches quantity shipped, 
Packaging is in good condition and not damaged,
Sealing sticker is undamaged and remains hinged,
No strain or waterlogging,
No labels are missing or torn,
Printing is clear and no information missing,
No additional external labels,
Products are still within the expiration date,
Temperature displayed as “OK” and is not triggered
Comments: 用户填写
Result: Accept/Reject (下拉选择)
Inspection By: 用户填写


当用户录入数据完成后, 每一行就是一个产品的receiving, 需要读取模版apps/web/src/app/(dashboard)/vma/data/receiving-inspection.pdf
每有一行就需要写一个pdf
根据用户的录入填写
Manufacturer/Vendor后面输入框必须写入Venus Medtech (Hangzhou)
PO No.后面的输入框写入用户录入的PO No.若用户没有录入则为空
Manufacturer Lot #录入用户录入的Product Serial No.
Product Identification录入用户Product Model
Date Shipped 录入用户录入的Date Shipped
Date/Time Received录入用户录入的Date/Time Received 格式YYYY-MM-DD HH:MM PST
Quantity Received录入用户录入的Quantity Received 
Received By录入用户录入的Operator

==以下内容后面的所在行后面的Result列的checkbox, 需要根据用户在Conditional Notes中选择, 若用户该行有选择, 则该行的Result列Fail的checkbox打钩, 否则则打钩PASS
Quantity received matches quantity shipped, 
Packaging is in good condition and not damaged,
Sealing sticker is undamaged and remains hinged,
No strain or waterlogging,
No labels are missing or torn,
Printing is clear and no information missing,
No additional external labels,
Products are still within the expiration date,
Temperature displayed as “OK” and is not triggered

Comments写入用户录入的Comments
Inspection Conclusion后面的Check box根据用户在Result中选择 Accept/Reject去check相关的checkbox
Inspection By写入用户录入的Inspection By
Date Inspected写入用户录入的Date/Time Received 格式YYYY-MM-DD


每行都是一个这个文件 在用户点击确认后要提供用户下载 你可以合并成一个PDF


此外还需要上传之前用来记录库存的数据库表

你需要参考库存流水表的明细 结合我说的内容 去筛选上传内容 先指定计划
我们先制定计划并了解需求 先不做代码 等所有内容都充分理解后再开始写代码


好了 我希望点击库存管理 里每一行 会和 培训管理-培训管理的列表一样 横向展开一个明细表
这个表会展示该产品的流水明细
分别为 Available, WIP, Near Exp, Expired, Returned to CN 5个板块

每个板块都是一个表格, 表头为
Batch #, Spec #, Rec. Date, Serial No., Quantity, Operator
P-valve每个产品为一行, Delivery System每个相同产品Spec#+Serial No.为一行
(所以库存表中的primary key为Spec #+Serial No.)


Available表为可用数量且不过期的产品
WIP表当前出库未回库数量
Near Exp表为过期日期<=30天的产品
Expired表为过期产品
Returned to CN表为退回中国的产品

你看看能否理解我的需求我们先讨论 确认理解再写代码

P-Valve版面pill新增一个页面在产品管理后面叫做Site Management

该页面也就是一个列表展示
数据需要新的数据库表格管理(Site ID是primary key)
左侧有新增Site的按钮 
显示的字段为

Site ID, Site Name, Address, City, State, Zip Code, Country

Site ID为 ### 但是为字符串形式, 允许例如001出现

点击site列表中的site可以进行编辑内容 这是一个modal

点击新增按钮也会出现一个modal, 要求录入上述表格信息 点击确认后写入数据库 (注意ID不可重复)



现在做Clinical Cases的页面
这个需要一个新的数据库表格进行管理 并且要和之前的库存流水去联动 具体参考之前说过的内容
这个表中是以Case ID为primary key
数据表中需要记录拿走的产品明细(Spec #, Serial No., Quantity,Exp Date, Batch # 等等信息,不过你可以通过primary key的链接去查到)

该页面会显示的列表为
Case ID, Site ID, Date, Status

其中Case ID为 Site ID-Patient ID组成例如 UVP-001-003 前面加入UVP,其他数字都是3位
Status为一个状态栏, 显示该Case是已经结束, 当Case建立的时候 status为In Progress, 当Case结束后成为Completed


如果用户点add new Case
则会弹出一个modal
该modal需要用户录入新case的信息
其中上半部分需要填入
Site ID: 为下拉选项 从Site Management里列出
选择后后续的信息会自动填入
Patient ID: 用户录入 3位数字
Case Date: YYYY-MM-DD 格式 (可以点击选择日期)


下半部分是列表 分为左右两侧
左侧为P-valve requested: 用户选择, 下拉菜单为多选
其中每行只能选择一种产品,多的需要新增行
每行中用户会选择Spec#, 和 数量
然后系统会自动读取 Inventory的该类产品, 首先从临期产品(Near Exp)中读取, 如果不够再从Available中读取
规则为优先选取最快要过期的产品, 但是判定过期日期不是今天, 而是Case Date
然后把选中的产写入列表中, 用户也可以点击手动修改

右侧为Delivery System requested: 用户选择, 下拉菜单为多选
根据用户上面选择的p-valve种类会动态规律满足的Delivery System种类, 这个要去读产品管理表获取关系
也是一样每行只有一个产品, 但是以多数量

注意两个表中我们都只考虑 Spec#, Serial No., Exp Date, Quantity

当用户提交的时候, 需要写入数据库, 并且要从Inventory中做对应的修改, 记住此时并不是用掉了, 要等日后回库才是消耗 此处是WIP
同时需要读取下列模版
apps/web/src/app/(dashboard)/vma/data/PackingList_UVP.docx
然后把信息写入这个模版中, 生成一个PDF提供下载
具体写入规则如下
1. Ship To: 这个框体中写入用户选择的Site的地址信息, 格式要按照前面Ship From的格式
也就是第一行是Site Name, 第二行是Address Line 1, 第三行是Address Line 2, 第四行是City, State, Zip Code, 第五行是Country
这些数据需要去读取Site Management获取
2. Your Reference Box: 
这个框体中 Your Reference 后面要写入 Case ID
PO e-Mail Date: MMM  ____, YYYY 这里的MMM和YYYY需要根据Case Date来写入 MMM是Month, YYYY是Year

3. Note: All were carried to Hospital on MMM ____, YYYY. Used items #  _    and #  _    on the day, and rest were carried back to Venus Medtech of America after the case.
这里的 MMM和YYYY需要根据Case Date来写入 MMM是Month, YYYY是Year

4. 表格中需要写入选取的产品信息
Item列是一个自增的数字, 从1开始每写入一行数据就要+1
Modal and Specefication列为产品的型号 对应我们之前选取的Spec#,
Serial Number/Lot Number列为对应该产品的Serial No.
Expiry Date列为对应该产品的Exp Date, 但是日期格式要修正为 YYYY MMM DD
Return列不写入
Device Name列为产品名字, 若是P-Valve则为Transcatheter Pulmonary Valve, 若是Delivery System则为Delivery System



注意写入的时候每个产品必须写一行
尤其是Delivery System, 即使是同一种Spec# 同Serial No.也要分开写
每一行就只能对应一个产品
写入的顺序是先写入我们选择的P-Valve, 写完了P-Valve再写Delivery System
如果遇到行数不够的, 可以在表格的最后一行下面新增行继续写, 直到写完, 所以一定要注意这个问题, 应该能自动换行后到新增页的吧
表格中的字体size, font type, 居中都要统一, 且自动换行,你可以参考表格第一行(除开表头)的格式去做


当用户点击某个case的时候, 会展开(按照Inventory展开的动画一样方式)一个明细
展示拿走的产品明细 Spec #, Serial No., Quantity,Exp Date, Batch # 等等信息 
进一步点会弹出modal修改单项信息, 但是要特别注意,只能修改用什么产品, 数量 不得修改产品信息 也可以删除
但是注意 如果该CASE status是Complete的时候不得修改



所以填充逻辑
SiteName: 写入医院名称也就是我们的Site Name
SiteAddress1: 写入地址第一行
SiteAddress2: 写入地址第二行
SiteState: 写入City, State, Zip Code 组合
SiteCountry: 写入Country
注意以上内容在没有地址第二行的时候, SiteAddress2可以不写入, 但是SiteState, SiteCountry往上顺移一行
我们目前的Site Management的Address 只有一行, 所以我们需要去修改逻辑 让其支持两行, 同时前后逻辑都得改

Reference写入我们的Case ID
emailDate写入Case Date, 但是需要写入 MMM _____ , YYYY 格式 这里必须严格按照我说的去写



其余产品表格内容你能看到如何写




好了 在点开的Case明细页(也就是动画切入的那个页面)
右上角Download PDF按钮右侧新增一个按钮 Return for Completion
点击后 用相同的动画 切入一个新表格 (点击外侧可以取消回到原页面)
该表格展示字段为
和明细页的一样的内容, 但是不要ACTION列 修改为2列
Return:
Return Status:
Return列为一个Togggle开关, 苹果风格, 默认关闭, 打开表示回库
Return Status: 为下拉菜单, 只有Return打开的时候才显示, 默认为All ok 其他和Conditional notes一样 

左下角有一个 Confirm conpletion,点击后会弹出modal要求用户确认
用户确认后 则表示该Case已经完成
此时该Case的status变为Complete, 并且不能再进行修改
且需要根据用户选择使用/回库的状态, 从Inventory中做对应的修改, 你知道逻辑, 该CASE对应的WIP就应该为0

当再次点击查看CASE明细的时候Edit info按钮和action列会消失, 但是会新增一个按钮, Reverse Completion
点击后会弹出modal 要求用户确认, 确认后会取消这个CASE的完成状态 重新变成未完成, 并且edit info和action列会重新出现
同时reset之前complete对于inventory的修改


我们先设计 理解 后 再写代码 不着急

现在我们做 Inventory里的Move to Demo
用户点击后会出现一个modal
用户可以添加产品, P-valve是每行一个, Delivery System可以输入多个
点击确认后 被选中的产品会被移动到Demo 不在Inventory中被通缉
每个产品移动过去的都需要填写Note, 这里自动填写为Manual Move to Demo, 注意这个理由日后要用 要和其他理由相关理由能够参与汇总
添加产品必须都是下拉菜单 用户选择, 需要显示相关信息
顶部的需要填写的Move Date, Operator
下面起始为一行, 需要就可以点新增行
但该用户录入选择Spec#,后会自动根据其数据得到serial no.
剩余数据根据上面两个自动获取
Batch #,Type,Spec #,	Rec. Date,	Serial No.,	Exp. Date,	Quantity