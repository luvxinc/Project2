// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// User & Auth Models
// ================================

model User {
  id           String     @id @default(uuid())
  username     String     @unique
  email        String     @unique
  passwordHash String     @map("password_hash")
  displayName  String?    @map("display_name")
  status       UserStatus @default(ACTIVE)

  // JSON fields
  roles       String[] @default(["viewer"])
  permissions Json     @default("{}")
  settings    Json     @default("{\"language\": \"en\", \"timezone\": \"UTC\"}")

  // Timestamps
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  createdByTokens RefreshToken[]
  auditLogs       AuditLog[]

  @@map("users")
}

enum UserStatus {
  ACTIVE
  DISABLED
  LOCKED
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model SecurityCode {
  id        String   @id @default(uuid())
  level     String // L1, L2, L3, L4
  codeHash  String   @map("code_hash")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([level, isActive])
  @@map("security_codes")
}

// ================================
// Alert & Archive Models (Enterprise Observability)
// ================================

/// 告警历史记录 - 持久化系统告警
model AlertHistory {
  id String @id @default(uuid())

  rule      String // 告警规则名
  severity  AlertSeverity // 严重程度
  message   String // 告警消息
  value     Float // 触发时的值
  threshold Float // 阈值

  acknowledged   Boolean   @default(false) // 是否已确认
  acknowledgedAt DateTime? @map("acknowledged_at")
  acknowledgedBy String?   @map("acknowledged_by")

  resolvedAt DateTime? @map("resolved_at") // 自动解除时间

  createdAt DateTime @default(now()) @map("created_at")

  @@index([rule])
  @@index([severity])
  @@index([acknowledged])
  @@index([createdAt])
  @@map("alert_history")
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

/// 日志归档记录 - 追踪归档任务
model LogArchive {
  id String @id @default(uuid())

  logType     String   @map("log_type") // access, business, error, audit
  archiveDate DateTime @map("archive_date") // 归档的日期范围
  recordCount Int      @map("record_count") // 归档的记录数

  filePath String? @map("file_path") // 归档文件路径
  fileSize Int?    @map("file_size") // 文件大小 (bytes)

  status       ArchiveStatus @default(COMPLETED)
  errorMessage String?       @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([logType])
  @@index([archiveDate])
  @@index([status])
  @@map("log_archives")
}

enum ArchiveStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ================================
// Audit & Logging Models (V2 Enhanced)
// ================================

/// 审计日志 - 敏感操作完整记录 (企业级合规)
model AuditLog {
  id      String  @id @default(uuid())
  traceId String? @map("trace_id") // 关联追踪ID

  // ========== 操作人 ==========
  userId    String? @map("user_id")
  user      User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  username  String? // 冗余存储，防止用户删除后丢失
  sessionId String? @map("session_id")
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // ========== 操作信息 ==========
  module     String // 模块: users, security, finance
  action     String // 动作: UPDATE_PERMISSIONS, DELETE_USER
  entityType String? @map("entity_type") // 实体类型
  entityId   String? @map("entity_id") // 实体ID

  // ========== 变更详情 ==========
  oldValue Json? @map("old_value") // 变更前值 (脱敏后)
  newValue Json? @map("new_value") // 变更后值 (脱敏后)
  details  Json? // 附加详情

  // ========== 结果与风险 ==========
  result    AuditResult @default(SUCCESS) // 操作结果
  riskLevel RiskLevel   @default(LOW) // 风险等级

  createdAt DateTime @default(now()) @map("created_at")

  @@index([traceId])
  @@index([userId])
  @@index([module])
  @@index([action])
  @@index([riskLevel])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditResult {
  SUCCESS // 成功执行
  DENIED // 被拒绝 (权限不足)
  FAILED // 失败 (执行错误)
}

enum RiskLevel {
  CRITICAL // 极高风险: 删除数据, 权限变更
  HIGH // 高风险: 用户管理, 配置变更
  MEDIUM // 中风险: 数据修改
  LOW // 低风险: 查询操作
}

// ================================
// Product Models (Placeholder)
// ================================

model Product {
  id          String        @id @default(uuid())
  sku         String        @unique
  name        String?
  category    String?
  subcategory String?       // 子类目
  type        String?       // 产品类型
  cost        Decimal       @default(0) @db.Decimal(10, 2) // 基础成本
  freight     Decimal       @default(0) @db.Decimal(10, 2) // 运费
  cogs        Decimal       @default(0) @db.Decimal(10, 2) // 计算值 = cost + freight
  weight      Int           @default(0) // 重量 (克)
  upc         String?
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  deletedAt   DateTime?     @map("deleted_at")

  @@map("products")
}


enum ProductStatus {
  ACTIVE
  INACTIVE
}

// ================================
// Role & Permission Boundary Models
// ================================

/// 职能角色定义 - 支持 superadmin 动态管理
model Role {
  id          String  @id @default(uuid())
  name        String  @unique // 角色标识: viewer, editor, staff, admin, superuser
  displayName String  @map("display_name") // 显示名称: 访客, 编辑, 员工, 管理员, 超级管理员
  level       Int     @unique // 层级: 1, 2, 3, 4, 5 (数值越高权限越大)
  description String?
  isSystem    Boolean @default(false) @map("is_system") // 系统角色不可删除
  isActive    Boolean @default(true) @map("is_active")
  color       String? // UI 显示颜色

  // 边界配置 Relations
  boundaries RolePermissionBoundary[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

/// 职能权限边界配置 - 定义每个职能可以授予的权限范围
model RolePermissionBoundary {
  id     String @id @default(uuid())
  roleId String @map("role_id")
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  /// 权限边界类型
  /// - ALLOWED: 此角色可以拥有/授予的权限
  /// - DENIED: 此角色明确禁止的权限
  /// - INHERITED: 继承自更低级别角色
  boundaryType BoundaryType @default(ALLOWED) @map("boundary_type")

  /// 权限 key，如 'module.sales.transactions.upload'
  permissionKey String @map("permission_key")

  /// 授权说明
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([roleId, permissionKey])
  @@index([roleId])
  @@index([permissionKey])
  @@map("role_permission_boundaries")
}

enum BoundaryType {
  ALLOWED // 允许
  DENIED // 禁止
  INHERITED // 继承自低级别角色
}

// ================================
// Extended Logging Models (V2 Enhanced)
// ================================

/// 错误日志 - 系统异常完整记录 (企业级)
model ErrorLog {
  id String @id @default(uuid())

  // ========== 基础标识 ==========
  traceId String? @map("trace_id") // 分布式追踪ID

  // ========== 错误核心 ==========
  errorType    String  @map("error_type") // Error类型: TypeError, ValidationError
  errorCode    String? @map("error_code") // 业务错误码: ERR_USER_001
  errorMessage String  @map("error_message") // 错误消息
  stackTrace   String? @map("stack_trace") @db.Text // 完整堆栈
  rootCause    String? @map("root_cause") // 根因分析

  // ========== 请求上下文 ==========
  requestMethod  String? @map("request_method") // GET/POST/PUT/DELETE
  requestPath    String? @map("request_path") // /api/users/123
  requestQuery   Json?   @map("request_query") // {page: 1, limit: 10}
  requestBody    Json?   @map("request_body") // 脱敏后的请求体
  requestHeaders Json?   @map("request_headers") // 关键headers (脱敏)

  // ========== 用户上下文 ==========
  userId    String?  @map("user_id")
  username  String?
  userRoles String[] @default([])
  sessionId String?  @map("session_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  // ========== 系统环境 ==========
  hostname      String? // 服务器主机名
  appVersion    String? @map("app_version") // 应用版本
  nodeEnv       String? @map("node_env") // development/production
  systemContext Json?   @map("system_context") // 内存/CPU快照

  // ========== 业务上下文 ==========
  module          String? // 业务模块: users, sales
  operation       String? // 操作名: createUser
  entityType      String? @map("entity_type") // 实体类型: User, Order
  entityId        String? @map("entity_id") // 实体ID
  businessContext Json?   @map("business_context") // 业务相关数据

  // ========== 诊断分类 ==========
  severity    ErrorSeverity @default(MEDIUM)
  category    ErrorCategory @default(UNKNOWN)
  errorHash   String?       @map("error_hash") // 错误指纹 (MD5)
  occurrences Int           @default(1) // 重复次数
  firstSeenAt DateTime?     @map("first_seen_at") // 首次出现
  lastSeenAt  DateTime?     @map("last_seen_at") // 最后出现

  // ========== 问题追踪 ==========
  isResolved Boolean   @default(false) @map("is_resolved")
  resolvedAt DateTime? @map("resolved_at")
  resolvedBy String?   @map("resolved_by")
  resolution String?   @db.Text // 解决方案描述

  // ========== 环境标识 ==========
  devMode Boolean @default(false) @map("dev_mode")

  createdAt DateTime @default(now()) @map("created_at")

  // ========== 索引 ==========
  @@index([traceId])
  @@index([errorHash])
  @@index([severity])
  @@index([category])
  @@index([module])
  @@index([isResolved])
  @@index([createdAt])
  @@index([devMode])
  // 复合索引 (性能优化)
  @@index([module, createdAt])
  @@index([severity, createdAt])
  @@index([isResolved, severity])
  @@index([devMode, createdAt])
  @@map("error_logs")
}

enum ErrorSeverity {
  CRITICAL // 系统崩溃级别
  HIGH // 功能不可用
  MEDIUM // 功能受限
  LOW // 轻微问题
}

enum ErrorCategory {
  DATABASE // 数据库错误
  NETWORK // 网络错误
  VALIDATION // 验证错误
  AUTH // 认证授权错误
  BUSINESS // 业务逻辑错误
  EXTERNAL_API // 外部API错误
  SYSTEM // 系统错误
  UNKNOWN // 未分类
}

/// 业务操作日志 - 业务行为追踪
model BusinessLog {
  id      String  @id @default(uuid())
  traceId String? @map("trace_id")

  // 操作人
  userId    String? @map("user_id")
  username  String?
  ipAddress String? @map("ip_address")

  // 业务信息
  module  String // sales, purchase, inventory, etc.
  action  String // CREATE_PO, UPDATE_SUPPLIER, etc.
  summary String?
  details Json? // 详细数据 (仅 BusinessLog 有此字段)

  // 目标实体
  entityType String? @map("entity_type")
  entityId   String? @map("entity_id")

  // 状态
  status LogStatus @default(SUCCESS)

  // 环境
  devMode Boolean @default(false) @map("dev_mode")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([traceId])
  @@index([userId])
  @@index([module])
  @@index([action])
  @@index([createdAt])
  @@index([devMode])
  @@map("business_logs")
}

enum LogStatus {
  SUCCESS
  FAILED
  PENDING
}

/// 访问日志 - HTTP 请求记录
model AccessLog {
  id      String  @id @default(uuid())
  traceId String? @map("trace_id")

  // 请求信息
  userId    String? @map("user_id")
  username  String?
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // HTTP 信息
  method      String
  path        String
  queryParams String? @map("query_params")
  statusCode  Int     @map("status_code")

  // 性能
  responseTime Int? @map("response_time") // 毫秒
  responseSize Int? @map("response_size") // 字节

  // 环境
  devMode Boolean @default(false) @map("dev_mode")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([traceId])
  @@index([userId])
  @@index([path])
  @@index([statusCode])
  @@index([createdAt])
  @@index([devMode])
  @@map("access_logs")
}

// 扩展 AuditLog 的枚举
enum AuditAction {
  // Auth Actions
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGE

  // User Admin Actions
  CREATE_USER
  UPDATE_USER
  DELETE_USER
  LOCK_USER
  UNLOCK_USER
  CHANGE_ROLE
  UPDATE_PERMISSIONS

  // Security Actions
  GOD_MODE_UNLOCK
  GOD_MODE_LOCK
  DEV_MODE_TOGGLE
  CLEAR_DEV_LOGS
  SECURITY_CODE_VERIFY

  // Config Actions
  UPDATE_CONFIG
  UPDATE_BOUNDARIES
}

enum ActionCategory {
  AUTH // 认证
  AUTHZ // 授权
  DATA // 数据操作
  CONFIG // 配置变更
  ADMIN // 管理操作
  SECURITY // 安全操作
}
