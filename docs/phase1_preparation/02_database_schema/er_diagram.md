# ER 图 (Entity-Relationship Diagram)

## 核心实体关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               PRODUCT DOMAIN                                 │
│                                                                             │
│  ┌──────────────┐                                                           │
│  │   products   │                                                           │
│  │──────────────│                                                           │
│  │ id           │                                                           │
│  │ sku (unique) │◄─────────────────────────────────────────────┐           │
│  │ name         │                                               │           │
│  │ category     │                                               │           │
│  │ cogs         │                                               │           │
│  └──────────────┘                                               │           │
└─────────────────────────────────────────────────────────────────│───────────┘
                                                                  │
┌─────────────────────────────────────────────────────────────────│───────────┐
│                             PURCHASE DOMAIN                      │           │
│                                                                  │           │
│  ┌──────────────┐       ┌──────────────────┐       ┌────────────┴─────┐    │
│  │  suppliers   │       │ purchase_orders  │       │ po_items         │    │
│  │──────────────│       │──────────────────│       │──────────────────│    │
│  │ id           │◄──────│ supplier_id      │       │ po_id            │────┤
│  │ code         │       │ po_number        │◄──────│ sku              │────┤
│  │ name         │       │ status           │       │ quantity         │    │
│  └──────────────┘       │ total_amount     │       │ unit_price       │    │
│         │               └──────────────────┘       └──────────────────┘    │
│         │                        │                                          │
│         │               ┌────────┴────────┐                                │
│         │               │                 │                                │
│         ▼               ▼                 ▼                                │
│  ┌──────────────────┐ ┌───────────────┐ ┌───────────────┐                  │
│  │ supplier_strategy│ │  shipments    │ │  receipts     │                  │
│  │──────────────────│ │───────────────│ │───────────────│                  │
│  │ supplier_id      │ │ po_id         │ │ shipment_id   │                  │
│  │ sku              │ │ status        │ │ status        │                  │
│  │ unit_price       │ │ ship_date     │ │ receive_date  │                  │
│  │ exchange_rate    │ └───────────────┘ └───────────────┘                  │
│  └──────────────────┘                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            INVENTORY DOMAIN                                  │
│                                                                             │
│  ┌──────────────────────┐       ┌──────────────────────┐                   │
│  │ inventory_snapshots  │       │    fifo_layers       │                   │
│  │──────────────────────│       │──────────────────────│                   │
│  │ sku                  │───────│ sku                  │                   │
│  │ snapshot_date        │       │ layer_type           │                   │
│  │ quantity             │       │ layer_date           │                   │
│  └──────────────────────┘       │ initial_qty          │                   │
│                                 │ remaining_qty        │                   │
│                                 │ unit_cost            │                   │
│                                 │ source_ref           │                   │
│                                 └──────────────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              SALES DOMAIN                                    │
│                                                                             │
│  ┌──────────────────────┐       ┌──────────────────────┐                   │
│  │    transactions      │       │   clean_logs         │                   │
│  │──────────────────────│       │──────────────────────│                   │
│  │ order_id             │◄──────│ order_id             │                   │
│  │ sku                  │       │ sku                  │                   │
│  │ order_date           │       │ record_type          │                   │
│  │ quantity             │       │ raw_data             │                   │
│  │ revenue              │       └──────────────────────┘                   │
│  │ platform             │                                                   │
│  └──────────────────────┘                                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                             FINANCE DOMAIN                                   │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │ deposit_payments │  │ logistic_payments│  │  po_payments     │          │
│  │──────────────────│  │──────────────────│  │──────────────────│          │
│  │ po_id            │  │ shipment_id      │  │ po_id            │          │
│  │ amount           │  │ amount           │  │ amount           │          │
│  │ payment_date     │  │ payment_date     │  │ payment_date     │          │
│  │ receipt_path     │  │ receipt_path     │  │ receipt_path     │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              AUTH DOMAIN                                     │
│                                                                             │
│  ┌──────────────┐       ┌──────────────────┐       ┌──────────────────┐    │
│  │    users     │       │      roles       │       │   permissions    │    │
│  │──────────────│       │──────────────────│       │──────────────────│    │
│  │ id           │       │ id               │       │ id               │    │
│  │ username     │───────│ name             │───────│ key              │    │
│  │ password_hash│       │ description      │       │ name             │    │
│  │ email        │       └──────────────────┘       │ module           │    │
│  │ is_active    │                                  └──────────────────┘    │
│  └──────────────┘                                                          │
│                                                                             │
│  ┌──────────────────┐       ┌──────────────────┐                           │
│  │   user_roles     │       │  role_permissions │                          │
│  │──────────────────│       │──────────────────│                           │
│  │ user_id          │       │ role_id          │                           │
│  │ role_id          │       │ permission_id    │                           │
│  └──────────────────┘       └──────────────────┘                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              AUDIT DOMAIN                                    │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │   audit_logs     │  │  business_logs   │  │   error_logs     │          │
│  │──────────────────│  │──────────────────│  │──────────────────│          │
│  │ user_id          │  │ user_id          │  │ user_id          │          │
│  │ action           │  │ action           │  │ error_type       │          │
│  │ target           │  │ message          │  │ stack_trace      │          │
│  │ old_value        │  │ details          │  │ request_path     │          │
│  │ new_value        │  │ created_at       │  │ created_at       │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 关系说明

| 关系 | 类型 | 说明 |
|------|------|------|
| suppliers → purchase_orders | 1:N | 一个供应商多个 PO |
| purchase_orders → po_items | 1:N | 一个 PO 多个商品 |
| purchase_orders → shipments | 1:N | 一个 PO 多次发货 |
| shipments → receipts | 1:N | 一次发货多次收货 |
| products → fifo_layers | 1:N | 一个 SKU 多个 FIFO 层 |
| users → roles | N:M | 多对多 |
| roles → permissions | N:M | 多对多 |

---

*Last Updated: 2026-02-04*
