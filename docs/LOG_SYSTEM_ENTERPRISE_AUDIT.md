# MGMT ERP æ—¥å¿—ç³»ç»Ÿ - ä¼ä¸šçº§æ·±åº¦å®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2026-02-06  
**å®¡è®¡èŒƒå›´**: å‰ç«¯ + åç«¯å®Œæ•´æ—¥å¿—ç³»ç»Ÿ  
**å®¡è®¡å¸ˆ**: AI Assistant  

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

| ç»´åº¦ | çŠ¶æ€ | è¯„åˆ† |
|------|------|------|
| **æ¶æ„è®¾è®¡** | âœ… ä¼˜ç§€ | 9/10 |
| **å®‰å…¨æ€§** | âœ… ä¼ä¸šçº§ | 9/10 |
| **æ•°æ®å®Œæ•´æ€§** | âœ… å®Œæ•´ | 9/10 |
| **éšç§ä¿æŠ¤** | âœ… God Mode è„±æ• | 9/10 |
| **æ€§èƒ½** | âœ… æ‰¹é‡å†™å…¥ | 8/10 |
| **å¯è§‚æµ‹æ€§** | âœ… å‘Šè­¦ç³»ç»Ÿ | 8/10 |
| **å‰ç«¯ä½“éªŒ** | âœ… Apple é£æ ¼ | 9/10 |
| **i18n** | âœ… å®Œæ•´å¤šè¯­è¨€ | 8/10 |

**æ€»ä½“è¯„ä»·**: ä¼ä¸šçº§ç”Ÿäº§å°±ç»ª âœ…

---

## 1ï¸âƒ£ ç³»ç»Ÿæ¶æ„

### 1.1 å››è¡¨æ—¥å¿—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MGMT ERP æ—¥å¿—ç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ErrorLog    â”‚  â”‚  AuditLog    â”‚  â”‚ BusinessLog  â”‚           â”‚
â”‚  â”‚  (é”™è¯¯æ—¥å¿—)   â”‚  â”‚  (å®¡è®¡æ—¥å¿—)   â”‚  â”‚  (ä¸šåŠ¡æ—¥å¿—)   â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ severity   â”‚  â”‚ â€¢ userId     â”‚  â”‚ â€¢ module     â”‚           â”‚
â”‚  â”‚ â€¢ category   â”‚  â”‚ â€¢ module     â”‚  â”‚ â€¢ action     â”‚           â”‚
â”‚  â”‚ â€¢ stackTrace â”‚  â”‚ â€¢ action     â”‚  â”‚ â€¢ summary    â”‚           â”‚
â”‚  â”‚ â€¢ errorHash  â”‚  â”‚ â€¢ riskLevel  â”‚  â”‚ â€¢ details    â”‚           â”‚
â”‚  â”‚ â€¢ occurrencesâ”‚  â”‚ â€¢ oldValue   â”‚  â”‚ â€¢ entityType â”‚           â”‚
â”‚  â”‚ â€¢ isResolved â”‚  â”‚ â€¢ newValue   â”‚  â”‚ â€¢ status     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  AccessLog   â”‚  â”‚ AlertHistory â”‚  â”‚ArchiveRecord â”‚           â”‚
â”‚  â”‚  (è®¿é—®æ—¥å¿—)   â”‚  â”‚  (å‘Šè­¦å†å²)   â”‚  â”‚  (å½’æ¡£è®°å½•)   â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ method     â”‚  â”‚ â€¢ rule       â”‚  â”‚ â€¢ logType    â”‚           â”‚
â”‚  â”‚ â€¢ path       â”‚  â”‚ â€¢ severity   â”‚  â”‚ â€¢ archiveDateâ”‚           â”‚
â”‚  â”‚ â€¢ statusCode â”‚  â”‚ â€¢ message    â”‚  â”‚ â€¢ recordCountâ”‚           â”‚
â”‚  â”‚ â€¢ responseTimeâ”‚ â”‚ â€¢ threshold  â”‚  â”‚ â€¢ archivePathâ”‚           â”‚
â”‚  â”‚ â€¢ devMode    â”‚  â”‚ â€¢ acknowledgedâ”‚ â”‚ â€¢ status     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åç«¯æœåŠ¡åˆ†å±‚

| æœåŠ¡ | èŒè´£ | æ–‡ä»¶ |
|------|------|------|
| **LogsController** | API ç«¯ç‚¹ã€æƒé™éªŒè¯ã€God Mode æ§åˆ¶ | `logs.controller.ts` (487 è¡Œ) |
| **LogsService** | æ—¥å¿—æŸ¥è¯¢ã€ç»Ÿè®¡ã€ç»´æŠ¤æ“ä½œ | `logs.service.ts` (414 è¡Œ) |
| **LogWriterService** | æ—¥å¿—å†™å…¥ï¼ˆFire-and-Forget, æ‰¹é‡ç¼“å†²ï¼‰| `log-writer.service.ts` (632 è¡Œ) |
| **GodModeService** | æ•æ„Ÿä¿¡æ¯è„±æ• & ä¼šè¯ç®¡ç† | `god-mode.service.ts` (282 è¡Œ) |
| **LogAlertService** | å‘Šè­¦è§„åˆ™è¯„ä¼°ã€è§¦å‘ã€æŒä¹…åŒ– | `log-alert.service.ts` (408 è¡Œ) |
| **LogExportService** | æ—¥å¿—å¯¼å‡ºï¼ˆJSON/CSVï¼‰ | `log-export.service.ts` (204 è¡Œ) |

---

## 2ï¸âƒ£ ç”¨æˆ· & IP è®°å½•å®¡è®¡

### âœ… å®¡è®¡ç»“è®ºï¼šæ‰€æœ‰æ—¥å¿—ç±»å‹å‡è®°å½•ç”¨æˆ·å’Œ IP

| æ—¥å¿—ç±»å‹ | userId | username | ipAddress | sessionId | userAgent | userRoles |
|----------|:------:|:--------:|:---------:|:---------:|:---------:|:---------:|
| **AuditLog** | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| **ErrorLog** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **BusinessLog** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| **AccessLog** | âœ… | âœ… | âœ… | âŒ | âœ… | âŒ |

### æ•°æ®æ¥æº

```typescript
// LogWriterService æ¥æ”¶çš„ RequestContext
interface RequestContext {
  traceId: string;
  method: string;
  path: string;
  userId?: string;          // âœ… æ¥è‡ª JWT
  username?: string;        // âœ… æ¥è‡ª JWT
  userRoles?: string[];     // âœ… æ¥è‡ª JWT
  sessionId?: string;       // âœ… æ¥è‡ª JWT
  ipAddress?: string;       // âœ… æ¥è‡ªè¯·æ±‚ Header
  userAgent?: string;       // âœ… æ¥è‡ªè¯·æ±‚ Header
}
```

---

## 3ï¸âƒ£ God Mode æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

### 3.1 è„±æ•æœºåˆ¶

| è„±æ•ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|----------|------|------|
| **IP è„±æ•** | `192.168.1.100` â†’ `192.168.*.*` | ä¿ç•™ç½‘æ®µï¼Œéšè—ä¸»æœº |
| **ç”¨æˆ·åè„±æ•** | `admin` â†’ `a***` | ä»…æ˜¾ç¤ºé¦–å­—æ¯ |
| **è·¯å¾„è„±æ•** | `/Users/aaron/app` â†’ `/[HOME]/app` | éšè—ç”¨æˆ·ç›®å½• |
| **ä¸¥æ ¼è„±æ•** | `requestBody` â†’ `[LOCKED - éœ€è¦è§£é”æŸ¥çœ‹]` | å®Œå…¨éšè— |
| **JSON è„±æ•** | `details` â†’ `[JSON - éœ€è¦è§£é”æŸ¥çœ‹]` | å®Œå…¨éšè— |

### 3.2 God Mode ä¼šè¯ç®¡ç†

```typescript
// GodModeService
SESSION_DURATION_MS = 30 * 60 * 1000;  // 30 åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ

interface GodModeSession {
  enabled: boolean;
  unlockedAt: Date;
  unlockedBy: string;      // è®°å½•è§£é”è€…
  expiresAt: Date;
}
```

### 3.3 å®‰å…¨éªŒè¯

- **è§£é”**: éœ€è¦ `L3` å®‰å…¨ç éªŒè¯
- **å®¡è®¡**: æ‰€æœ‰è§£é”/é”å®šæ“ä½œè®°å½•åˆ° AuditLog
- **ä¼šè¯éš”ç¦»**: æŒ‰ userId ç‹¬ç«‹ç®¡ç†

---

## 4ï¸âƒ£ å®‰å…¨æ§åˆ¶å®¡è®¡

### 4.1 API ç«¯ç‚¹æƒé™çŸ©é˜µ

| ç«¯ç‚¹ | æ–¹æ³• | æƒé™è¦æ±‚ | å®‰å…¨ç  |
|------|------|----------|--------|
| `/logs/overview` | GET | ç™»å½• | - |
| `/logs/errors` | GET | ç™»å½• | - |
| `/logs/audits` | GET | ç™»å½• | - |
| `/logs/business` | GET | ç™»å½• | - |
| `/logs/access` | GET | ç™»å½• | - |
| `/logs/mode/god/unlock` | POST | ç™»å½• | **L3** |
| `/logs/mode/god/lock` | POST | ç™»å½• | - |
| `/logs/maintenance/stats` | GET | **Superuser/Admin** | - |
| `/logs/maintenance/clear-dev` | POST | **Superuser/Admin** | **L4** |
| `/logs/maintenance/execute` | POST | **Superuser/Admin** | **L4** |
| `/logs/export/:type` | GET | ç™»å½• | - |

### 4.2 Superadmin éªŒè¯

```typescript
// logs.controller.ts:445-460
private requireSuperadmin(req: AuthenticatedRequest): void {
  const { roles } = req.user;
  
  // ç›´æ¥æ£€æŸ¥ roles æ•°ç»„
  const isSuperadmin = Array.isArray(roles) && 
    (roles.includes('superuser') || roles.includes('admin'));
  
  if (!isSuperadmin) {
    throw new ForbiddenException({
      code: 'SUPERADMIN_REQUIRED',
      message: 'æ­¤æ“ä½œä»…é™ç®¡ç†å‘˜æ‰§è¡Œ',
    });
  }
}
```

### 4.3 æ•æ„Ÿæ•°æ®è„±æ•

```typescript
// log-writer.service.ts:61-67
private readonly SENSITIVE_FIELDS = [
  'password', 'passwd', 'pwd',
  'token', 'authorization', 'secret', 
  'apiKey', 'api_key', 'accessToken', 'refreshToken',
  'creditCard', 'cardNumber', 'cvv',
  'ssn', 'socialSecurity',
];
```

---

## 5ï¸âƒ£ å‘Šè­¦ç³»ç»Ÿå®¡è®¡

### 5.1 é»˜è®¤å‘Šè­¦è§„åˆ™

| è§„åˆ™åç§° | ç±»å‹ | é˜ˆå€¼ | çª—å£ | ä¸¥é‡çº§åˆ« |
|----------|------|------|------|----------|
| `high_error_rate` | é”™è¯¯ç‡ | 5% | 5åˆ†é’Ÿ | CRITICAL |
| `critical_errors` | ä¸¥é‡é”™è¯¯ | 1ä¸ª | 5åˆ†é’Ÿ | CRITICAL |
| `high_latency` | P99å»¶è¿Ÿ | 2000ms | 5åˆ†é’Ÿ | WARNING |
| `auth_failures` | è®¤è¯å¤±è´¥ | 10æ¬¡ | 5åˆ†é’Ÿ | WARNING |

### 5.2 å‘Šè­¦æŒä¹…åŒ–

```typescript
// å‘Šè­¦å†™å…¥ AlertHistory è¡¨ (æŒä¹…åŒ–)
await this.prisma.alertHistory.create({
  data: {
    rule: rule.name,
    severity: rule.severity,
    message,
    value,
    threshold: rule.threshold,
    acknowledged: false,
  }
});
```

### 5.3 å‘Šè­¦ç”Ÿå‘½å‘¨æœŸ

```
è§¦å‘ â†’ æŒä¹…åŒ– â†’ æ´»è·ƒå‘Šè­¦ç¼“å­˜ â†’ ç¡®è®¤/è‡ªåŠ¨è§£é™¤ â†’ resolvedAt
```

---

## 6ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–å®¡è®¡

### 6.1 Fire-and-Forget å¼‚æ­¥å†™å…¥

```typescript
// logError/logAudit/logBusiness éƒ½ä½¿ç”¨å¼‚æ­¥æ¨¡å¼
logError(params): void {
  this.writeErrorLog(params).catch(err => {
    this.logger.error('Failed to write error log (async)', err);
  });
}
```

### 6.2 AccessLog æ‰¹é‡ç¼“å†²

```typescript
private readonly BATCH_SIZE = 100;           // æ‰¹é‡å¤§å°
private readonly FLUSH_INTERVAL = 1000;      // åˆ·æ–°é—´éš” (ms)

// å®šæ—¶æ‰¹é‡å†™å…¥
this.flushTimer = setInterval(async () => {
  if (this.accessLogBuffer.length > 0) {
    await this.flushAccessLogs();
  }
}, this.FLUSH_INTERVAL);
```

### 6.3 é”™è¯¯èšåˆ

```typescript
// ç›¸åŒé”™è¯¯è‡ªåŠ¨èšåˆï¼Œå¢åŠ  occurrences è€Œéåˆ›å»ºæ–°è®°å½•
const existing = await this.prisma.errorLog.findFirst({
  where: { errorHash, isResolved: false },
});

if (existing) {
  await this.prisma.errorLog.update({
    where: { id: existing.id },
    data: {
      occurrences: { increment: 1 },
      lastSeenAt: new Date(),
    },
  });
}
```

---

## 7ï¸âƒ£ å‰ç«¯ç»„ä»¶å®¡è®¡

### 7.1 ç»„ä»¶æ¸…å•

| ç»„ä»¶ | èŒè´£ | ä»£ç è¡Œæ•° |
|------|------|----------|
| `LogsHubPage` | æ—¥å¿—æ¨¡å—é¦–é¡µï¼ˆApple é£æ ¼ï¼‰ | 309 è¡Œ |
| `LogTable` | é€šç”¨æ—¥å¿—è¡¨æ ¼ | 9569 å­—èŠ‚ |
| `LogDetailModal` | æ—¥å¿—è¯¦æƒ…å¼¹çª— | 21563 å­—èŠ‚ |
| `GodModePanel` | God Mode æ§åˆ¶é¢æ¿ | 9459 å­—èŠ‚ |
| `ExportButton` | å¯¼å‡ºæŒ‰é’® | 3684 å­—èŠ‚ |
| `AlertBanner` | å‘Šè­¦æ¨ªå¹… | 5083 å­—èŠ‚ |
| `LogTypeSelector` | æ—¥å¿—ç±»å‹é€‰æ‹©å™¨ | 5685 å­—èŠ‚ |
| `LogModuleNav` | æ¨¡å—å¯¼èˆª | 6704 å­—èŠ‚ |
| `tableColumns` | åˆ—å®šä¹‰é…ç½® | 5157 å­—èŠ‚ |

### 7.2 API å®¢æˆ·ç«¯

```typescript
// apps/web/src/lib/api/logs.ts
export const logsApi = {
  getOverview,
  getHealth,
  getErrors,
  getAudits,
  getBusiness,
  getAccess,
  resolveError,
  getActiveAlerts,
  acknowledgeAlert,
  exportLogs,
  getMaintenanceStats,
  clearDevLogs,
  getGodModeStatus,
  unlockGodMode,
  lockGodMode,
};
```

### 7.3 è®¤è¯å¤„ç†

```typescript
function getAuthHeaders(): HeadersInit {
  const token = typeof window !== 'undefined' 
    ? localStorage.getItem('accessToken') 
    : null;
  return {
    'Content-Type': 'application/json',
    ...(token ? { Authorization: `Bearer ${token}` } : {}),
  };
}
```

---

## 8ï¸âƒ£ ç»´æŠ¤åŠŸèƒ½å®¡è®¡

### 8.1 ç»´æŠ¤æ“ä½œ

| æ“ä½œ | ç«¯ç‚¹ | æƒé™ | çŠ¶æ€ |
|------|------|------|------|
| æ¸…ç†å¼€å‘æ—¥å¿— | `POST /maintenance/clear-dev` | Superuser + L4 | âœ… å·²å®ç° |
| åˆ‡æ¢å¼€å‘æ¨¡å¼ | `POST /maintenance/execute` | Superuser + L4 | âš ï¸ éœ€é‡å¯æœåŠ¡ |
| å½’æ¡£æ—¥å¿— | `POST /maintenance/execute` | Superuser + L4 | ğŸš§ å°šæœªå®ç° |
| å¯¼å‡ºæ—¥å¿— | `GET /export/:type` | ç™»å½• | âœ… å·²å®ç° |

### 8.2 å¼€å‘/ç”Ÿäº§æ¨¡å¼åˆ†ç¦»

```typescript
// æ‰€æœ‰å¯åˆ†ç¦»çš„æ—¥å¿—è¡¨éƒ½æœ‰ devMode å­—æ®µ
model BusinessLog {
  devMode     Boolean  @default(false) @map("dev_mode")
}

model AccessLog {
  devMode     Boolean  @default(false) @map("dev_mode")
}
```

---

## 9ï¸âƒ£ å‘ç°çš„é—®é¢˜ & å»ºè®®

### ğŸ”´ P1 é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

| # | é—®é¢˜ | å½±å“ | çŠ¶æ€ |
|---|------|------|------|
| 1 | IP åœ°å€åœ¨æŸäº› logAudit è°ƒç”¨ä¸­ä¸ºç©ºå­—ç¬¦ä¸² | å®¡è®¡è¿½æº¯å›°éš¾ | âœ… **å·²ä¿®å¤** |

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ  extractClientIp è¾…åŠ©æ–¹æ³•
private extractClientIp(req: AuthenticatedRequest): string {
  const forwarded = req.headers['x-forwarded-for'];
  if (typeof forwarded === 'string') {
    return forwarded.split(',')[0].trim();
  }
  if (Array.isArray(forwarded)) {
    return forwarded[0];
  }
  const realIp = req.headers['x-real-ip'];
  if (typeof realIp === 'string') {
    return realIp;
  }
  return req.ip || req.socket?.remoteAddress || 'unknown';
}

// æ‰€æœ‰ logAudit è°ƒç”¨ç°åœ¨ä½¿ç”¨:
ipAddress: this.extractClientIp(req),
```

### ğŸŸ¡ P2 é—®é¢˜ï¼ˆå»ºè®®ä¼˜åŒ–ï¼‰

| # | é—®é¢˜ | å½±å“ | çŠ¶æ€ |
|---|------|------|------|
| 1 | BusinessLog ç¼ºå°‘ userId å…³è” | æ— æ³•å…³è”ç”¨æˆ·è¡¨ | âœ… **å·²ä¿®å¤** |
| 2 | AccessLog ç¼ºå°‘ userId å…³è” | æ— æ³•å…³è”ç”¨æˆ·è¡¨ | âœ… **å·²ä¿®å¤** |
| 3 | ç¼ºå°‘æ—¥å¿—å½’æ¡£å®ç° | æ—¥å¿—è¡¨ä¼šæŒç»­å¢é•¿ | âœ… **å·²å®ç°** |
| 4 | å¯¼å‡ºæ—¶æœªè„±æ• | æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ² | âœ… **å·²ä¿®å¤** |

**P2-1 & P2-2 ä¿®å¤æ–¹æ¡ˆ**:
```prisma
// schema.prisma - BusinessLog/AccessLog æ·»åŠ  userId å­—æ®µ
model BusinessLog {
  userId      String?  @map("user_id")  // âœ… æ–°å¢
  username    String?
  ipAddress   String?  @map("ip_address")
  // ...
  @@index([userId])  // âœ… æ–°å¢ç´¢å¼•
}

model AccessLog {
  userId        String?  @map("user_id")  // âœ… æ–°å¢
  username      String?
  ipAddress     String?  @map("ip_address")
  // ...
  @@index([userId])  // âœ… æ–°å¢ç´¢å¼•
}
```

**P2-4 ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// log-export.service.ts - å¯¼å‡ºæ—¶å¼ºåˆ¶è„±æ•
async exportLogs(options: ExportOptions): Promise<ExportResult> {
  const { godMode = false } = options;  // é»˜è®¤ä¸è§£é”
  
  // è·å–åŸå§‹æ•°æ®
  const rawData = await this.fetchLogs(logType, query, limit);
  
  // åº”ç”¨è„±æ•å¤„ç† (å¯¼å‡ºæ—¶é»˜è®¤å¼ºåˆ¶è„±æ•)
  const data = rawData.map(record => 
    this.godModeService.maskLogRecord(record, godMode, {
      strictFields: ['stackTrace', 'requestBody', 'responseBody', 'localVariables', 'details'],
      jsonFields: ['requestQuery', 'requestHeaders', 'businessContext', 'systemContext'],
    })
  );
  
  // æ–‡ä»¶åæ ‡è¯†è„±æ•çŠ¶æ€
  const maskedSuffix = godMode ? '' : '_masked';
  const filename = `${logType}_logs${maskedSuffix}_${timestamp}.${format}`;
}
```

**P2-3 å½’æ¡£åŠŸèƒ½å®ç°**:
```typescript
// log-archive.service.ts - å®Œæ•´çš„å½’æ¡£æœåŠ¡
@Injectable()
export class LogArchiveService {
  // ä¿ç•™ç­–ç•¥ (å¤©)
  RETENTION_POLICIES = {
    error: 365,    // é”™è¯¯æ—¥å¿—ä¿ç•™1å¹´
    audit: 730,    // å®¡è®¡æ—¥å¿—ä¿ç•™2å¹´ (åˆè§„è¦æ±‚)
    business: 90,  // ä¸šåŠ¡æ—¥å¿—ä¿ç•™90å¤©
    access: 30,    // è®¿é—®æ—¥å¿—ä¿ç•™30å¤©
  };

  // æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å½’æ¡£
  @Cron(CronExpression.EVERY_DAY_AT_2AM)
  async runScheduledArchive() { ... }

  // å†™å…¥ JSON å½’æ¡£æ–‡ä»¶
  writeArchiveFile(archiveDir, logType, logs) { ... }

  // æ‰‹åŠ¨è§¦å‘å½’æ¡£ (éœ€è¦ L4)
  async manualArchive(): Promise<ArchiveResult> { ... }
}

// API ç«¯ç‚¹:
// GET  /logs/archive/stats    - è·å–å½’æ¡£ç»Ÿè®¡
// GET  /logs/archive/history  - è·å–å½’æ¡£å†å²
// POST /logs/archive/execute  - æ‰‹åŠ¨è§¦å‘å½’æ¡£ (L4)
```

### ğŸŸ¢ P3 é—®é¢˜ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

| # | é—®é¢˜ | å»ºè®® |
|---|------|------|
| 1 | é”™è¯¯è¶‹åŠ¿ä½¿ç”¨ N+1 æŸ¥è¯¢ | æ”¹ç”¨èšåˆæŸ¥è¯¢ |
| 2 | å‘Šè­¦è§„åˆ™ç¡¬ç¼–ç  | æ”¹ä¸ºæ•°æ®åº“é…ç½® |

---

## ğŸ”Ÿ å®¡è®¡ç»“è®º

### âœ… ç¬¦åˆä¼ä¸šçº§æ ‡å‡†

1. **å››è¡¨åˆ†ç¦»æ¶æ„** - èŒè´£æ¸…æ™°ï¼Œæ‰©å±•æ€§å¥½
2. **å®Œæ•´ç”¨æˆ·è¿½è¸ª** - æ‰€æœ‰æ—¥å¿—è®°å½• username + ipAddress
3. **God Mode è„±æ•** - L3 éªŒè¯ + 30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
4. **å¼‚æ­¥å†™å…¥** - Fire-and-Forget ä¸é˜»å¡ä¸šåŠ¡
5. **æ‰¹é‡ç¼“å†²** - AccessLog æ‰¹é‡å†™å…¥æå‡æ€§èƒ½
6. **é”™è¯¯èšåˆ** - ç›¸åŒé”™è¯¯åˆå¹¶ï¼Œé¿å…æ—¥å¿—çˆ†ç‚¸
7. **å‘Šè­¦æŒä¹…åŒ–** - å‘Šè­¦å†å²æŒä¹…å­˜å‚¨
8. **ç»´æŠ¤åŠŸèƒ½** - å¼€å‘/ç”Ÿäº§æ—¥å¿—åˆ†ç¦»æ¸…ç†
9. **å¯¼å‡ºæ”¯æŒ** - JSON/CSV æ ¼å¼å¯¼å‡º

### ğŸ“Š ä»£ç è´¨é‡è¯„ä¼°

| æŒ‡æ ‡ | è¯„ä¼° |
|------|------|
| ç±»å‹å®‰å…¨ | âœ… å®Œæ•´ TypeScript |
| é”™è¯¯å¤„ç† | âœ… é™çº§å†™å…¥ stdout |
| ä»£ç æ³¨é‡Š | âœ… å…³é”®æ–¹æ³•æœ‰æ³¨é‡Š |
| æ¨¡å—åŒ– | âœ… æœåŠ¡èŒè´£åˆ†ç¦» |
| æµ‹è¯•è¦†ç›– | âš ï¸ æœªå®¡è®¡æµ‹è¯•æ–‡ä»¶ |

---

## ğŸ“ é™„å½•ï¼šå…³é”®ä»£ç è·¯å¾„

### åç«¯
- `apps/api/src/modules/logs/logs.controller.ts`
- `apps/api/src/modules/logs/logs.service.ts`
- `apps/api/src/modules/logs/god-mode.service.ts`
- `apps/api/src/modules/logs/log-alert.service.ts`
- `apps/api/src/modules/logs/log-export.service.ts`
- `apps/api/src/common/logging/log-writer.service.ts`

### å‰ç«¯
- `apps/web/src/app/(dashboard)/logs/page.tsx`
- `apps/web/src/app/(dashboard)/logs/maintenance/page.tsx`
- `apps/web/src/app/(dashboard)/logs/components/*.tsx`
- `apps/web/src/lib/api/logs.ts`

### æ•°æ®åº“
- `prisma/schema.prisma` (AuditLog, ErrorLog, BusinessLog, AccessLog, AlertHistory, ArchiveRecord)

---

**å®¡è®¡å®Œæˆ** âœ…
